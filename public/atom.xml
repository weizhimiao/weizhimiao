<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>行云流水</title>
  <subtitle>却也碎碎念念</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://weizhimiao.github.io/"/>
  <updated>2016-09-29T04:47:11.000Z</updated>
  <id>https://weizhimiao.github.io/</id>
  
  <author>
    <name>zhimiao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>memcache高速缓存工作原理及应用</title>
    <link href="https://weizhimiao.github.io/2016/09/29/memcache%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86%E5%8F%8A%E5%BA%94%E7%94%A8%E5%B0%8F%E7%BB%93/"/>
    <id>https://weizhimiao.github.io/2016/09/29/memcache高速缓存的工作原理及应用小结/</id>
    <published>2016-09-29T10:30:00.000Z</published>
    <updated>2016-09-29T04:47:11.000Z</updated>
    
    <content type="html"><![CDATA[<p>Memcached,是高性能的分布式内存缓存服务器，主要功能就是通过缓存数据库的查询，减少对数据库的访问次数，来提高动态web应用的速度和可扩展性。</p>
<p>memcached 是以守护程序方法运行于一个或多个服务器中，随时接受客户端的连接操作，客户端可以由各种语言编写，目前一致的客户端api包括 Perl / PHP / Python / Java / C# / C 等等。客户端在与 memcached 服务建立连接之后，接下来的事情就是存取对象了， 每个被存取的对象都有一个唯一的标识符 key，存取操作均通过这个 key进行，保存到 memcached 中的对象实际上是放置内存中的，并不是保存在平时的 cache 文件中的，这也是为什么 memcached 能够如此高效快速的原因。</p>
<p>注意，这些对象并不是持久的， 服务停止之后， 里边的数据就会丢失。</p>
<p><img src="http://n.sinaimg.cn/games/3ece443e/20160929/MemcacheYingYongMoXing.png?1" alt="Memcached应用模型"></p>
<a id="more"></a>
<h2 id="Memcached的安装"><a href="#Memcached的安装" class="headerlink" title="Memcached的安装"></a>Memcached的安装</h2><h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>libevent</p>
<blockquote>
<p>Libevent 是一个用C语言编写的、轻量级的开源高性能网络库。<br>主要有以下几个亮点：事件驱动（ event-driven），高性能;轻量级，专注于网络，不如 ACE 那么臃肿庞大；源代码相当精炼、易读；跨平台，支持 Windows、 Linux、 BSD 和 Mac Os；支持多种 I/O 多路复用技术， epoll、 poll、 dev/poll、 select 和 kqueue 等；支持 I/O，定时器和信号等事件；注册事件优先级。<br>Libevent 已经被广泛的应用，作为底层的网络库；比如 memcached、 Vomit、 Nylon、 Netchat等等。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tar -vxf libevent-2.0.22-stable.tar</div><div class="line">cd libevent-2.0.22-stable</div><div class="line">./configure --prefix=/usr/local/libevent</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cd memcached-1.4.31</div><div class="line"> ./configure --prefix=/usr/local/memcached --with-libevent=/usr/local/libevent</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>查看是否已经安装成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/memcached/</div><div class="line">ll</div><div class="line">drwxr-xr-x 2 root root 4096 9月  28 10:56 bin</div><div class="line">drwxr-xr-x 3 root root 4096 9月  28 10:56 include</div><div class="line">drwxr-xr-x 3 root root 4096 9月  28 10:56 share</div></pre></td></tr></table></figure></p>
<h2 id="Memcached管理"><a href="#Memcached管理" class="headerlink" title="Memcached管理"></a>Memcached管理</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动Memcached服务器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div></pre></td></tr></table></figure></p>
<p>查看是否启动成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ps aux | grep memcache</div><div class="line">root     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:00 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class="line">root     24436  0.0  0.0 112664   984 pts/0    D+   11:00   0:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>
<p>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">netstat -tlun | grep 11211</div><div class="line">tcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN</div><div class="line">tcp6       0      0 :::11211                :::*                    LISTEN</div><div class="line">udp        0      0 0.0.0.0:11211           0.0.0.0:*</div><div class="line">udp6       0      0 :::11211                :::*</div></pre></td></tr></table></figure></p>
<p>设置开机自启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211&quot; &gt;&gt; /etc/rc.d/rc.local</div></pre></td></tr></table></figure></p>
<p>Memcached启动选项及说明</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>-p <num></num></td>
<td>Memcached监听的TCP端口，要保证该端口号未被占用</td>
</tr>
<tr>
<td>-U <num></num></td>
<td>指定监听UDP的端口，默认11211，0表示关闭</td>
</tr>
<tr>
<td>-s <file></file></td>
<td>指定Memcached用于监听的UNIX socket文件</td>
</tr>
<tr>
<td>-A</td>
<td>enable ascii “shutdown” command</td>
</tr>
<tr>
<td>-a <mask></mask></td>
<td>设置-s选项指定的UNIX socket文件的权限(默认权限: 0700)</td>
</tr>
<tr>
<td>-l <addr></addr></td>
<td>监听的服务器IP地址，如果有多个地址的话，使用逗号分隔，格式可以为“IP地址:端口号”，例如：-l 指定192.168.0.184:19830,192.168.0.195:13542；端口号也可以通过-p选项指定</td>
</tr>
<tr>
<td>-d</td>
<td>指定memcached进程作为一个守护进程启动</td>
</tr>
<tr>
<td>-r</td>
<td>设置产生core文件大小</td>
</tr>
<tr>
<td>-u <username></username></td>
<td>运行memcached的用户 (only when run as root)</td>
</tr>
<tr>
<td>-m <num></num></td>
<td>指定分配给memcached使用的内存，单位是MB(默认: 64 MB)</td>
</tr>
<tr>
<td>-M</td>
<td>当内存使用超出配置值时，禁止自动清除缓存中的数据项，此时Memcached不可用，直到内存被释放</td>
</tr>
<tr>
<td>-c <num></num></td>
<td>设置最大运行的并发连接数，默认是1024</td>
</tr>
<tr>
<td>-k</td>
<td>设置锁定所有分页的内存，对于大缓存应用场景，谨慎使用该选项</td>
</tr>
<tr>
<td>-v</td>
<td>输出警告和错误信息</td>
</tr>
<tr>
<td>-vv</td>
<td>打印信息比-v更详细：不仅输出警告和错误信息，也输出客户端请求和响应信息</td>
</tr>
<tr>
<td>-vvv</td>
<td>extremely verbose (also print internal state transitions)</td>
</tr>
<tr>
<td>-h</td>
<td>显示Memcached版本和摘要信息</td>
</tr>
<tr>
<td>-i</td>
<td>打印libevent和Memcached的licenses信息</td>
</tr>
<tr>
<td>-V</td>
<td>输出Memcached版本号</td>
</tr>
<tr>
<td>-P <file></file></td>
<td>保存memcached进程的pid文件，（与 -d 一起搭配使用）</td>
</tr>
<tr>
<td>-f <factor></factor></td>
<td>用于计算缓存数据项的内存块大小的乘数因子，默认是1.25</td>
</tr>
<tr>
<td>-n <bytes></bytes></td>
<td>为缓存数据项的key、value、flag设置最小分配字节数，默认是48</td>
</tr>
<tr>
<td>-L</td>
<td>尝试使用大内存分页（pages）</td>
</tr>
<tr>
<td>-D <char></char></td>
<td>用于统计报告中Key前缀和ID之间的分隔符，默认是冒号“:”  </td>
</tr>
<tr>
<td>-t <num></num></td>
<td>指定用来处理请求的线程数，默认为4</td>
</tr>
<tr>
<td>-R</td>
<td>为避免客户端饿死（starvation），对连续达到的客户端请求数设置一个限额，如果超过该设置，会选择另一个连接来处理请求，默认为20</td>
</tr>
<tr>
<td>-C</td>
<td>禁用CAS</td>
</tr>
<tr>
<td>-b <num></num></td>
<td>Set the backlog queue limit (default: 1024)</td>
</tr>
<tr>
<td>-B</td>
<td>指定使用的协议，默认行为是自动协商（autonegotiate），可能使用的选项有auto、ascii、binary。</td>
</tr>
<tr>
<td>-I</td>
<td>Override the size of each slab page. Adjusts max item size(default: 1mb, min: 1k, max: 128m)</td>
</tr>
<tr>
<td>-F</td>
<td>禁用flush_all命令</td>
</tr>
<tr>
<td>-o</td>
<td>指定逗号分隔的选项，一般用于用于扩展或实验性质的选项</td>
</tr>
</tbody>
</table>
<h3 id="通过telnet连接使用Memcache"><a href="#通过telnet连接使用Memcache" class="headerlink" title="通过telnet连接使用Memcache"></a>通过telnet连接使用Memcache</h3><p>连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">telnet 127.0.0.1 11211</div></pre></td></tr></table></figure></p>
<p>命令格式：<command name=""> <key> <flags> <exptime> <bytes>\r\n <data block="">\r\n</data></bytes></exptime></flags></key></p>
<blockquote>
<p><command name=""> 可以是”set”, “add”, “replace”</p>
<p><key> 客户端需要保存数据的key。</key></p>
<p><flags> 是一个16位的无符号的整数(以十进制的方式表示)。</flags></p>
<p><exptime> 过期的时间。<br>最后客户端需要加上”\r\n”作为”命令头”的结束标志。即回车</exptime></p>
</blockquote>
<p>示例：</p>
<p>保存一个数据（保存一个『cache_key1=&gt;12345』的键值对到memcached 60s）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">set cache_key1 0 60 5</div><div class="line">12345</div><div class="line">STORED</div></pre></td></tr></table></figure></p>
<p>获取刚保存的值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">get cache_key1</div><div class="line">VALUE cache_key1 0 5</div><div class="line">12345</div><div class="line">END</div></pre></td></tr></table></figure></p>
<p>其他命令：</p>
<table>
<thead>
<tr>
<th>Command</th>
<th>Description</th>
<th>Example</th>
</tr>
</thead>
<tbody>
<tr>
<td>get</td>
<td>获取值</td>
<td>get mykey</td>
</tr>
<tr>
<td>set</td>
<td>设置值（可以存在可以不存在）</td>
<td>set mykey 0 60 5</td>
</tr>
<tr>
<td>add</td>
<td>添加新值</td>
<td>add newkey 0 60 5</td>
</tr>
<tr>
<td>replace</td>
<td>替换值（必须已存在）</td>
<td>replace key 0 60 5</td>
</tr>
<tr>
<td>append</td>
<td>在原有值之后添加数据</td>
<td>append key 0 60 15</td>
</tr>
<tr>
<td>prepend</td>
<td>在原有值之前添加数据</td>
<td>prepend key 0 60 15</td>
</tr>
<tr>
<td>incr</td>
<td>Increments numerical key value by given number</td>
<td>incr mykey 2</td>
</tr>
<tr>
<td>decr</td>
<td>Decrements numerical key value by given number</td>
<td>decr mykey 5</td>
</tr>
<tr>
<td>delete</td>
<td>删除一条数据</td>
<td>delete mykey</td>
</tr>
<tr>
<td>flush_all</td>
<td>清除所有数据</td>
<td>flush_all</td>
</tr>
<tr>
<td></td>
<td>清除900秒之内的数据</td>
<td>flush_all 900</td>
</tr>
<tr>
<td>stats</td>
<td>查看所有状态</td>
<td>stats</td>
</tr>
<tr>
<td></td>
<td>Prints memory statistics</td>
<td>stats slabs</td>
</tr>
<tr>
<td></td>
<td>Prints memory statistics</td>
<td>stats malloc</td>
</tr>
<tr>
<td></td>
<td>Print higher level allocation statistics</td>
<td>stats items</td>
</tr>
<tr>
<td></td>
<td></td>
<td>stats detail</td>
</tr>
<tr>
<td></td>
<td>已使用大小</td>
<td>stats sizes</td>
</tr>
<tr>
<td></td>
<td>重置状态</td>
<td>stats reset</td>
</tr>
<tr>
<td>version</td>
<td>查看版本</td>
<td>version</td>
</tr>
<tr>
<td>verbosity</td>
<td>Increases log level</td>
<td>verbosity</td>
</tr>
<tr>
<td>quit</td>
<td>退出telnet连接</td>
<td>quit</td>
</tr>
</tbody>
</table>
<h3 id="通过客户端（PHP）连接和使用Memcached"><a href="#通过客户端（PHP）连接和使用Memcached" class="headerlink" title="通过客户端（PHP）连接和使用Memcached"></a>通过客户端（PHP）连接和使用Memcached</h3><p>php扩展Memcached安装</p>
<p>依赖</p>
<blockquote>
<p>libmemcached, 是一个 memcached 的库，客户端库，C 和 C++ 语言实现的客户端库，具有低内存占用率、线程安全、并提供对memcached功能的全面支持。它还采用 多种命令行工具： memcat ， memflush ， memrm ， memstat ，并memslap （负载代）。程序库一直在设计，让不同的散列方法对密钥，分割的钥匙，并使用统一的散列分配。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://launchpadlibrarian.net/165454254/libmemcached-1.0.18.tar.gz</div><div class="line">tar -zxvf libmemcached-1.0.18.tar.gz</div><div class="line">cd libmemcached-1.0.18</div><div class="line">./configure --prefix=/usr/local/libmemcached</div><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<p>安装扩展<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">tar -xvf memcached-2.2.0.tar</div><div class="line">cd memcached-2.2.0</div><div class="line">/usr/local/php56/bin/phpize</div><div class="line">./configure --with-php-config=/usr/local/php56/bin/php-config --with-libmemcached-dir=/usr/local/libmemcached  --enable-memcached --disable-memcached-sasl</div><div class="line">make &amp;&amp; make install</div><div class="line">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div></pre></td></tr></table></figure></p>
<p>查看是否安装成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class="line">ll</div><div class="line">-rwxr-xr-x 1 root root  380475 9月  28 22:25 memcached.so</div><div class="line">-rwxr-xr-x 1 root root  756714 9月  26 17:32 mysqli.so</div><div class="line">-rwxr-xr-x 1 root root 1333912 9月  24 23:31 opcache.a</div><div class="line">-rwxr-xr-x 1 root root  618435 9月  24 23:31 opcache.so</div></pre></td></tr></table></figure></p>
<p>修改配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/php56/lib/php.ini</div><div class="line">extension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/memcached.so</div></pre></td></tr></table></figure></p>
<p>重启php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>
<p>查看是否已经加载成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/php56/bin/php -m</div><div class="line">或通过phpinfo();查看</div></pre></td></tr></table></figure></p>
<p>测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi memcache_test.php</div></pre></td></tr></table></figure></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">        $mc = <span class="keyword">new</span> Memcached();</div><div class="line">        var_dump($mc);</div><div class="line">        $mc-&gt;addServer(<span class="string">'127.0.0.1'</span>, <span class="number">11211</span>);</div><div class="line">        $mc-&gt;set(<span class="string">'cache_key'</span>,<span class="string">'mem_value'</span>,<span class="number">30</span>);</div><div class="line">        $val = $mc-&gt;get(<span class="string">'cache_key'</span>);</div><div class="line">        var_dump($val);</div><div class="line">        var_dump($mc-&gt;delete(<span class="string">'cache_key'</span>));</div><div class="line">        $mc-&gt;quit();</div></pre></td></tr></table></figure>
<p>访问结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">object(Memcached)#1 (0) &#123; &#125; string(9) &quot;mem_value&quot; bool(true)</div></pre></td></tr></table></figure></p>
<p>php关于memcached 的两种扩展memcache 和 memcached 介绍</p>
<ol>
<li><p>目前大多数php环境里使用的都是不带d的memcache版本，这个版本出的比较早，是一个原生版本，完全在php框架内开发的。与之对应的带d的memcached是建立在libmemcached的基础上，所以相对来说，memcached版本的功能更全一些。</p>
<blockquote>
<p><a href="http://cn2.php.net/manual/en/book.memcache.php" target="_blank" rel="external">memcache:</a></p>
<p><a href="http://cn2.php.net/manual/en/book.memcached.php" target="_blank" rel="external">memcached:</a></p>
</blockquote>
</li>
<li><p>Memcache是原生实现的，支持OO和非OO两套接口并存。而memcached是使用libmemcached，只支持OO接口。</p>
</li>
<li>memcached有了一个统一的setOption()来设置设置，而不用在操作的时候设置了。Memcached实现了更多的memcached协议。</li>
<li>memcached支持Binary Protocol，而memcache不支持。这意味着memcached会有更高的性能。不过memcached目前还不支持长连接。</li>
<li>另外一点也是大家比较关心的，就是所使用的算法。“一致性hash算法”是当添加或删除存储节点时，对存储在memcached上的数据影响较小的一种算法。在php的两个扩展库中，都可以使用该算法，只是设置方法有所不同。</li>
</ol>
<ul>
<li>Memcache</li>
</ul>
<p>修改php.ini添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[Memcache]</div><div class="line">Memcache.allow_failover = 1</div><div class="line">Memcache.hash_strategy =consistent</div><div class="line">Memcache.hash_function =crc32</div></pre></td></tr></table></figure></p>
<p>或在php中使用ini_set方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ini_set(‘memcache.hash_strategy&apos;,&apos;standard&apos;);</div><div class="line">ini_set(‘memcache.hash_function&apos;,&apos;crc32&apos;);</div></pre></td></tr></table></figure></p>
<ul>
<li>Memcached</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$mem = new memcached();</div><div class="line">$mem-&gt;setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);</div><div class="line">$mem-&gt;setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);</div></pre></td></tr></table></figure>
<h2 id="Memcached监控"><a href="#Memcached监控" class="headerlink" title="Memcached监控"></a>Memcached监控</h2><h3 id="利用phpmemcache-php图形监控工具"><a href="#利用phpmemcache-php图形监控工具" class="headerlink" title="利用phpmemcache.php图形监控工具"></a>利用phpmemcache.php图形监控工具</h3><p>下载 phpmemcache.php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">wget http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.php</div></pre></td></tr></table></figure></p>
<p>将phpmemcache.php放入web目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mv phpmemcache.php /usr/local/nginx/html</div></pre></td></tr></table></figure></p>
<p>修改phpmemcache.php中配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">define(&apos;ADMIN_USERNAME&apos;,&apos;xxxx&apos;);    // 用户名修改，在访问 phpmemcache.php 需要进行认证</div><div class="line">define(&apos;ADMIN_PASSWORD&apos;,&apos;xxxx&apos;);    // 密码</div><div class="line">define(&apos;DATE_FORMAT&apos;,&apos;Y/m/d H:i:s&apos;);</div><div class="line">define(&apos;GRAPH_SIZE&apos;,200);</div><div class="line">define(&apos;MAX_ITEM_DUMP&apos;,50);</div><div class="line"></div><div class="line">$MEMCACHE_SERVERS[] = &apos;127.0.0.1:11211&apos;; // 加入需要监控的memcached服务器</div><div class="line">//$MEMCACHE_SERVERS[] = &apos;192.168.200.104:11212&apos;; // add more as an array</div></pre></td></tr></table></figure></p>
<p>浏览器访问<br><img src="http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.png?1" alt="phpmemcache浏览器访问效果"></p>
<h4 id="利用Stats命令查看"><a href="#利用Stats命令查看" class="headerlink" title="利用Stats命令查看"></a>利用Stats命令查看</h4><p>利用stats命令可以查看当前memcached的各种状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line">telnet 127.0.0.1 11211</div><div class="line">Trying 127.0.0.1...</div><div class="line">Connected to 127.0.0.1.</div><div class="line">Escape character is &apos;^]&apos;.</div><div class="line">stats</div><div class="line">STAT pid 24732</div><div class="line">STAT uptime 66597</div><div class="line">STAT time 1475115983</div><div class="line">STAT version 1.4.31</div><div class="line">STAT libevent 2.0.22-stable</div><div class="line">STAT pointer_size 64</div><div class="line">STAT rusage_user 6.194421</div><div class="line">STAT rusage_system 2.419890</div><div class="line">STAT curr_connections 10</div><div class="line">STAT total_connections 16</div><div class="line">STAT connection_structures 11</div><div class="line">STAT reserved_fds 20</div><div class="line">STAT cmd_get 5</div><div class="line">STAT cmd_set 8</div><div class="line">STAT cmd_flush 0</div><div class="line">STAT cmd_touch 0</div><div class="line">STAT get_hits 4</div><div class="line">STAT get_misses 1</div><div class="line">STAT get_expired 0</div><div class="line">STAT get_flushed 0</div><div class="line">STAT delete_misses 0</div><div class="line">STAT delete_hits 2</div><div class="line">STAT incr_misses 0</div><div class="line">STAT incr_hits 0</div><div class="line">STAT decr_misses 0</div><div class="line">STAT decr_hits 0</div><div class="line">STAT cas_misses 0</div><div class="line">STAT cas_hits 0</div><div class="line">STAT cas_badval 0</div><div class="line">STAT touch_hits 0</div><div class="line">STAT touch_misses 0</div><div class="line">STAT auth_cmds 0</div><div class="line">STAT auth_errors 0</div><div class="line">STAT bytes_read 3850</div><div class="line">STAT bytes_written 293</div><div class="line">STAT limit_maxbytes 134217728</div><div class="line">STAT accepting_conns 1</div><div class="line">STAT listen_disabled_num 0</div><div class="line">STAT time_in_listen_disabled_us 0</div><div class="line">STAT threads 4</div><div class="line">STAT conn_yields 0</div><div class="line">STAT hash_power_level 16</div><div class="line">STAT hash_bytes 524288</div><div class="line">STAT hash_is_expanding 0</div><div class="line">STAT malloc_fails 0</div><div class="line">STAT log_worker_dropped 0</div><div class="line">STAT log_worker_written 0</div><div class="line">STAT log_watcher_skipped 0</div><div class="line">STAT log_watcher_sent 0</div><div class="line">STAT bytes 0</div><div class="line">STAT curr_items 0</div><div class="line">STAT total_items 6</div><div class="line">STAT expired_unfetched 0</div><div class="line">STAT evicted_unfetched 0</div><div class="line">STAT evictions 0</div><div class="line">STAT reclaimed 2</div><div class="line">STAT crawler_reclaimed 0</div><div class="line">STAT crawler_items_checked 0</div><div class="line">STAT lrutail_reflocked 0</div><div class="line">END</div></pre></td></tr></table></figure></p>
<p>Stats详解</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pid</td>
<td>memcache服务器的进程ID</td>
</tr>
<tr>
<td>uptime</td>
<td>服务器已经运行的秒数</td>
</tr>
<tr>
<td>time</td>
<td>服务器当前的unix时间戳</td>
</tr>
<tr>
<td>version</td>
<td>memcache版本</td>
</tr>
<tr>
<td>pointer_size</td>
<td>当前操作系统的指针大小（32位系统一般是32bit）</td>
</tr>
<tr>
<td>rusage_user</td>
<td>进程的累计用户时间</td>
</tr>
<tr>
<td>rusage_system</td>
<td>进程的累计系统时间</td>
</tr>
<tr>
<td>curr_items</td>
<td>服务器当前存储的items数量</td>
</tr>
<tr>
<td>total_items</td>
<td>从服务器启动以后存储的items总数量</td>
</tr>
<tr>
<td>bytes</td>
<td>当前服务器存储items占用的字节数</td>
</tr>
<tr>
<td>curr_connections</td>
<td>当前打开着的连接数</td>
</tr>
<tr>
<td>total_connections</td>
<td>从服务器启动以后曾经打开过的连接数</td>
</tr>
<tr>
<td>connection_structures</td>
<td>服务器分配的连接构造数</td>
</tr>
<tr>
<td>cmd_get</td>
<td>get命令（获取）总请求次数</td>
</tr>
<tr>
<td>cmd_set</td>
<td>set命令（保存）总请求次数</td>
</tr>
<tr>
<td>get_hits</td>
<td>总命中次数</td>
</tr>
<tr>
<td>get_misses</td>
<td>总未命中次数</td>
</tr>
<tr>
<td>evictions</td>
<td>为获取空闲内存而删除的items数（分配给memcache的空间用满后需要删除旧的items来得到空间分配给新的items）</td>
</tr>
<tr>
<td>bytes_read</td>
<td>总读取字节数（请求字节数）</td>
</tr>
<tr>
<td>bytes_written</td>
<td>总发送字节数（结果字节数）</td>
</tr>
<tr>
<td>limit_maxbytes</td>
<td>分配给memcache的内存大小（字节）</td>
</tr>
<tr>
<td>threads</td>
<td>当前线程数</td>
</tr>
</tbody>
</table>
<h3 id="利用各种监控软件查看（例如：nagios监控memcache的插件）"><a href="#利用各种监控软件查看（例如：nagios监控memcache的插件）" class="headerlink" title="利用各种监控软件查看（例如：nagios监控memcache的插件）"></a>利用各种监控软件查看（例如：nagios监控memcache的插件）</h3><blockquote>
<p>只以命中率大于和小于为例两种状态。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim check_memcache</div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/sh</span></div><div class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> <span class="_">-ne</span> 1 ]</div><div class="line"><span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"Usage:<span class="variable">$0</span> -c num2"</span></div><div class="line"><span class="built_in">exit</span> 0</div><div class="line"><span class="keyword">fi</span></div><div class="line">cmd_get=`/usr/<span class="built_in">local</span>/nagios/libexec/check_tcp -H localhost -p 11211 -E <span class="_">-s</span> <span class="string">'stats\r\nquit\r\n'</span> <span class="_">-e</span> <span class="string">'uptime'</span> |grep cmd_get | awk <span class="string">'&#123;print $3+0&#125;'</span>`</div><div class="line">get_hits=`/usr/<span class="built_in">local</span>/nagios/libexec/check_tcp -H localhost -p 11211 -E <span class="_">-s</span> <span class="string">'stats\r\nquit\r\n'</span> <span class="_">-e</span> <span class="string">'uptime'</span> |grep get_hits | awk <span class="string">'&#123;print $3+0&#125;'</span>`</div><div class="line">hit_rate=`<span class="built_in">echo</span> <span class="string">"<span class="variable">$get_hits</span>*100/<span class="variable">$cmd_get</span>"</span>|bc`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$hit_rate</span> <span class="_">-gt</span> <span class="variable">$1</span> ];<span class="keyword">then</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"OK - hit rate is <span class="variable">$hit_rate</span> | hit_rate=<span class="variable">$hit_rate</span>; cmd_get=<span class="variable">$cmd_get</span>; get_hits=<span class="variable">$get_hits</span>"</span></div><div class="line"><span class="built_in">exit</span> 0</div><div class="line"><span class="keyword">else</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"CRITICAL - hit rate is <span class="variable">$hit_rate</span> | hit_rate=<span class="variable">$hit_rate</span>; cmd_get=<span class="variable">$cmd_get</span>; get_hits=<span class="variable">$get_hits</span>"</span></div><div class="line"><span class="built_in">exit</span> 2</div><div class="line"><span class="keyword">fi</span></div></pre></td></tr></table></figure>
<p>测试命中率大于80%为正常为例;<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">eg：</div><div class="line">sh check_memcache 80</div><div class="line">root@ip-10-250-114-95:/liang# sh check_memcache 80</div><div class="line">OK - hit rate is 99 | hit_rate=99; cmd_get=142547; get_hits=141880</div></pre></td></tr></table></figure></p>
<p>以上证明命中率99%，即状态为OK.</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Memcached,是高性能的分布式内存缓存服务器，主要功能就是通过缓存数据库的查询，减少对数据库的访问次数，来提高动态web应用的速度和可扩展性。&lt;/p&gt;
&lt;p&gt;memcached 是以守护程序方法运行于一个或多个服务器中，随时接受客户端的连接操作，客户端可以由各种语言编写，目前一致的客户端api包括 Perl / PHP / Python / Java / C# / C 等等。客户端在与 memcached 服务建立连接之后，接下来的事情就是存取对象了， 每个被存取的对象都有一个唯一的标识符 key，存取操作均通过这个 key进行，保存到 memcached 中的对象实际上是放置内存中的，并不是保存在平时的 cache 文件中的，这也是为什么 memcached 能够如此高效快速的原因。&lt;/p&gt;
&lt;p&gt;注意，这些对象并不是持久的， 服务停止之后， 里边的数据就会丢失。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160929/MemcacheYingYongMoXing.png?1&quot; alt=&quot;Memcached应用模型&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://weizhimiao.github.io/categories/Linux/"/>
    
    
      <category term="缓存" scheme="https://weizhimiao.github.io/tags/%E7%BC%93%E5%AD%98/"/>
    
      <category term="memcache" scheme="https://weizhimiao.github.io/tags/memcache/"/>
    
      <category term="memcached" scheme="https://weizhimiao.github.io/tags/memcached/"/>
    
  </entry>
  
  <entry>
    <title>linux服务和进程管理</title>
    <link href="https://weizhimiao.github.io/2016/09/28/Linux%E6%9C%8D%E5%8A%A1%E5%92%8C%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
    <id>https://weizhimiao.github.io/2016/09/28/Linux服务和进程管理/</id>
    <published>2016-09-28T10:30:00.000Z</published>
    <updated>2016-09-29T03:17:46.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://n.sinaimg.cn/games/3ece443e/20160929/LinuxFuWuHeJinChengGuanLi.png?1" alt="Linux服务和进程管理"></p>
<a id="more"></a>
<h2 id="进程管理"><a href="#进程管理" class="headerlink" title="进程管理"></a>进程管理</h2><p>进程管理的三个主要任务</p>
<ul>
<li>判断服务器的健康状态</li>
<li>查看所有正在运行的进程</li>
<li>强制终止进程</li>
</ul>
<h3 id="进程查看"><a href="#进程查看" class="headerlink" title="进程查看"></a>进程查看</h3><h4 id="ps-aux"><a href="#ps-aux" class="headerlink" title="ps aux"></a>ps aux</h4><blockquote>
<p>查看当前系统所有运行的进程（可以不加-）</p>
<ul>
<li>-a 显示前台所有进程</li>
<li>-u 显示用户名</li>
<li>-x 显示后台进程</li>
</ul>
</blockquote>
<p>命令执行结果示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ps aux</div><div class="line">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</div><div class="line">root         1  0.0  0.3  41280  3732 ?        Ss   9月26   0:02 /usr/lib/systemd/systemd --switched-root --system</div><div class="line">root         2  0.0  0.0      0     0 ?        S    9月26   0:00 [kthreadd]</div><div class="line">root         3  0.0  0.0      0     0 ?        S    9月26   0:00 [ksoftirqd/0]</div><div class="line">root         5  0.0  0.0      0     0 ?        S&lt;   9月26   0:00 [kworker/0:0H]</div><div class="line">root         6  0.0  0.0      0     0 ?        S    9月26   0:00 [kworker/u2:0]</div><div class="line">root         7  0.0  0.0      0     0 ?        S    9月26   0:00 [migration/0]</div><div class="line">root         8  0.0  0.0      0     0 ?        S    9月26   0:00 [rcu_bh]</div><div class="line">root         9  0.0  0.0      0     0 ?        S    9月26   0:00 [rcuob/0]</div><div class="line">root        10  0.0  0.0      0     0 ?        S    9月26   0:36 [rcu_sched]</div><div class="line">root        11  0.0  0.0      0     0 ?        S    9月26   0:32 [rcuos/0]</div><div class="line">···</div></pre></td></tr></table></figure></p>
<p>参数说明:</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>USER</td>
<td>用户名</td>
</tr>
<tr>
<td>PID</td>
<td>进程PID 1  init  系统启动的第一个进程</td>
</tr>
<tr>
<td>%CPU</td>
<td>cpu占用百分比</td>
</tr>
<tr>
<td>%MEM</td>
<td>内存占用百分比</td>
</tr>
<tr>
<td>VSZ</td>
<td>虚拟内存占用量（KB）</td>
</tr>
<tr>
<td>RSS</td>
<td>固定内存占有量</td>
</tr>
<tr>
<td>TTY</td>
<td>登录终端  tty1-7 本地终端1-6 字符、 7图形） pts/0-255</td>
</tr>
<tr>
<td>STAT</td>
<td>状态 （S：睡眠 D：不可唤醒 R：运行 T：停止 Z：僵死 W：进入内存交换 X：死掉的进程 &lt;:高优先级 N：低优先级 L：被锁进内存 s：含子进程 +：位于后台 l：多线程）</td>
</tr>
<tr>
<td>START</td>
<td>进程触发时间</td>
</tr>
<tr>
<td>TIME</td>
<td>占用cpu时间</td>
</tr>
<tr>
<td>COMMAND</td>
<td>进程本身</td>
</tr>
</tbody>
</table>
<h4 id="pstree"><a href="#pstree" class="headerlink" title="pstree"></a>pstree</h4><blockquote>
<ul>
<li>-a 查看进程树</li>
</ul>
</blockquote>
<p>命令执行结果示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">pstree -a</div><div class="line">systemd --switched-root --system --deserialize 21</div><div class="line">  ├─AliHids</div><div class="line">  │   └─4*[&#123;AliHids&#125;]</div><div class="line">  ├─AliYunDun</div><div class="line">  │   └─8*[&#123;AliYunDun&#125;]</div><div class="line">  ├─AliYunDunUpdate</div><div class="line">  │   └─3*[&#123;AliYunDunUpdate&#125;]</div><div class="line">  ├─agetty --noclear tty1 linux</div><div class="line">  ├─aliyun-service -d</div><div class="line">  ├─crond -n</div><div class="line">  ├─dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation</div><div class="line">  ├─memcached -d -m 128 -u root -p 11211</div><div class="line">  │   └─6*[&#123;memcached&#125;]</div><div class="line">  ├─nginx</div><div class="line">  │   └─nginx</div><div class="line">  ├─ntpd -u ntp:ntp -g</div><div class="line">  ├─php-fpm</div><div class="line">  │   ├─php-fpm</div><div class="line">  │   └─php-fpm</div><div class="line">  ├─rsyslogd -n</div><div class="line">  │   └─2*[&#123;rsyslogd&#125;]</div><div class="line">  ├─sshd -D</div><div class="line">  │   └─sshd</div><div class="line">  │       └─bash</div><div class="line">  │           └─pstree -a</div><div class="line">  ├─systemd-journal</div><div class="line">  ├─systemd-logind</div><div class="line">  └─systemd-udevd</div></pre></td></tr></table></figure></p>
<h4 id="top"><a href="#top" class="headerlink" title="top"></a>top</h4><blockquote>
<p>实时显示进程状态</p>
</blockquote>
<p>命令执行结果示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">top - 15:04:52 up 2 days,  5:25,  1 user,  load average: 0.00, 0.01, 0.05</div><div class="line">Tasks:  70 total,   2 running,  68 sleeping,   0 stopped,   0 zombie</div><div class="line">%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</div><div class="line">KiB Mem :  1016796 total,   599400 free,    41948 used,   375448 buff/cache</div><div class="line">KiB Swap:        0 total,        0 free,        0 used.   838500 avail Mem</div><div class="line"></div><div class="line">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</div><div class="line">  917 root      20   0   82696   9152   5456 S  0.3  0.9   5:50.76 AliHids</div><div class="line">    1 root      20   0   41280   3732   2388 S  0.0  0.4   0:02.36 systemd</div><div class="line">    2 root      20   0       0      0      0 S  0.0  0.0   0:00.01 kthreadd</div><div class="line">    3 root      20   0       0      0      0 S  0.0  0.0   0:00.00 ksoftirqd/0</div><div class="line">    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H</div><div class="line">    6 root      20   0       0      0      0 S  0.0  0.0   0:00.26 kworker/u2:0</div><div class="line">    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0</div><div class="line">    ···</div></pre></td></tr></table></figure></p>
<p>参数说明</p>
<ul>
<li>第一行：系统当前时间，系统持续时间， 登录用户，1,5,15分钟之前的平均负载</li>
<li>第二行：进程总数</li>
<li>第三行：CPU占用率</li>
<li>第四行：内存使用：总共，空闲，已使用，缓存</li>
<li>第五行：swap使用情况</li>
</ul>
<p>操作命令：</p>
<ul>
<li>M,按内存占用排序</li>
<li>P,安CPU占用排序</li>
<li>q,退出</li>
</ul>
<h3 id="终止进程"><a href="#终止进程" class="headerlink" title="终止进程"></a>终止进程</h3><h4 id="kill-结束单个进程"><a href="#kill-结束单个进程" class="headerlink" title="kill 结束单个进程"></a>kill 结束单个进程</h4><blockquote>
<p>kill命令是通过向进程发送指定的信号来结束相应进程的。在默认情况下，采用编号为15的TERM信号。TERM信号将终止所有不能捕获该信号的进程。对于那些可以捕获该信号的进程就要用编号为9的kill信号，强行“杀掉”该进程。</p>
<p>命令格式：kill 信号  PID</p>
</blockquote>
<p>信号，进程间的通信方式</p>
<p>我们常用的信号有</p>
<table>
<thead>
<tr>
<th>信号名称</th>
<th>信号</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>HUP</td>
<td>1</td>
<td>终端断线</td>
</tr>
<tr>
<td>INT</td>
<td>2</td>
<td>中断（同 Ctrl + C）</td>
</tr>
<tr>
<td>QUIT</td>
<td>3</td>
<td>退出（同 Ctrl + \）</td>
</tr>
<tr>
<td>TERM</td>
<td>15</td>
<td>终止</td>
</tr>
<tr>
<td>KILL</td>
<td>9</td>
<td>强制终止</td>
</tr>
<tr>
<td>CONT</td>
<td>18</td>
<td>继续（与STOP相反， fg/bg命令）</td>
</tr>
<tr>
<td>STOP</td>
<td>19</td>
<td>暂停（同 Ctrl + Z）</td>
</tr>
</tbody>
</table>
<p>示例：结束 memcached 进程</p>
<p>获取memcached进程pid（24428，即为memcached进程PID）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">ps -aux | grep memcache</div><div class="line">root     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class="line">root     24727  0.0  0.0 112664   984 pts/0    S+   15:54   0:00 grep --color=auto memcache</div><div class="line">#</div><div class="line">ps -ef | grep memcache</div><div class="line">root     24428     1  0 11:00 ?        00:00:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class="line">root     24708 24568  0 15:49 pts/0    00:00:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>
<p>或者使用pidof查看 （ pid + of ）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@...]# pidof memcached</div><div class="line">24428</div></pre></td></tr></table></figure></p>
<p>终止 memcached<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">kill -9 24428</div><div class="line">ps -aux | grep memcache</div><div class="line">root     24729  0.0  0.0 112664   984 pts/0    S+   15:55   0:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>
<h4 id="killall"><a href="#killall" class="headerlink" title="killall"></a>killall</h4><blockquote>
<p>杀死指定名字的进程</p>
<p>命令格式：killall 信号  进程名</p>
</blockquote>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">killall -9 memcached</div></pre></td></tr></table></figure></p>
<h4 id="pkill"><a href="#pkill" class="headerlink" title="pkill"></a>pkill</h4><blockquote>
<p>支持按照一定规则匹配来杀死进程</p>
<p>命令格式：pkill [options] <pattern></pattern></p>
</blockquote>
<p>示例：杀死用户 wahaha 下的所有进程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pkill -u wahaha</div></pre></td></tr></table></figure></p>
<p>把某个终端登陆的用户踢出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pkill -9 -t 终端号</div></pre></td></tr></table></figure></p>
<p>把本地登陆终端1登陆用户踢出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pkill -9 -t tty1</div></pre></td></tr></table></figure></p>
<h2 id="服务管理"><a href="#服务管理" class="headerlink" title="服务管理"></a>服务管理</h2><h3 id="Linux中服务的分类"><a href="#Linux中服务的分类" class="headerlink" title="Linux中服务的分类"></a>Linux中服务的分类</h3><h4 id="系统默认安装的服务-RPM"><a href="#系统默认安装的服务-RPM" class="headerlink" title="系统默认安装的服务(RPM)"></a>系统默认安装的服务(RPM)</h4><ul>
<li>独立的服务</li>
<li>基于xinetd的服务，xinetd是系统超级守护进程<blockquote>
<p>xinetd服务其本身就是一个独立的服务。</p>
<p>当程序调用xinetd服务时，它先调用的事xinetd服务，让后xinetd服务在调用索要调用的服务进行相应。</p>
<p>Linux系统默认是没有安装xinetd服务的，需要进行安装后才能使用。</p>
</blockquote>
</li>
</ul>
<h4 id="源码包安装的服务"><a href="#源码包安装的服务" class="headerlink" title="源码包安装的服务"></a>源码包安装的服务</h4><h3 id="系统默认安装的服务"><a href="#系统默认安装的服务" class="headerlink" title="系统默认安装的服务"></a>系统默认安装的服务</h3><h4 id="如何区分服务的分类"><a href="#如何区分服务的分类" class="headerlink" title="如何区分服务的分类"></a>如何区分服务的分类</h4><p>查看服务的自启动状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkconfig  --list</div></pre></td></tr></table></figure></p>
<p>运行结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">chkconfig  --list</div><div class="line">注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务。SysV 配置数据可能被原生 systemd 配置覆盖。</div><div class="line">      如果您想列出 systemd 服务,请执行 &apos;systemctl list-unit-files&apos;。</div><div class="line">      欲查看对特定 target 启用的服务请执行</div><div class="line">      &apos;systemctl list-dependencies [target]&apos;。</div><div class="line">aegis          	0:关	1:关	2:开	3:开	4:开	5:开	6:关</div><div class="line">agentwatch     	0:关	1:关	2:开	3:开	4:开	5:开	6:关</div><div class="line">netconsole     	0:关	1:关	2:关	3:关	4:关	5:关	6:关</div><div class="line">network        	0:关	1:关	2:开	3:开	4:开	5:开	6:关</div></pre></td></tr></table></figure></p>
<p>Linux的运行级别：0-6</p>
<table>
<thead>
<tr>
<th>级别</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>关机</td>
</tr>
<tr>
<td>1</td>
<td>单用户模式</td>
</tr>
<tr>
<td>2</td>
<td>不完全多用户，不包含NFS服务</td>
</tr>
<tr>
<td>3</td>
<td>完全多用户,字符界面</td>
</tr>
<tr>
<td>4</td>
<td>未分配</td>
</tr>
<tr>
<td>5</td>
<td>图形界面</td>
</tr>
<tr>
<td>6</td>
<td>重启</td>
</tr>
</tbody>
</table>
<p>查看当前系统的运行级别：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">runlevel</div><div class="line">N 3</div></pre></td></tr></table></figure></p>
<p>切换系统当前的运行级别：</p>
<table>
<thead>
<tr>
<th>命令</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>init  0</td>
<td>关机                   </td>
</tr>
<tr>
<td>init  5</td>
<td>切换到图形界面（前提图形界面已经安装）</td>
</tr>
<tr>
<td>init  3</td>
<td>切换到字符界面</td>
</tr>
<tr>
<td>init  6</td>
<td>重启</td>
</tr>
</tbody>
</table>
<h4 id="独立的服务管理"><a href="#独立的服务管理" class="headerlink" title="独立的服务管理"></a>独立的服务管理</h4><ul>
<li>启动</li>
</ul>
<p>第一种方式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/etc/rc.d/init.d/服务名 start| stop | restart | status</div><div class="line"># 例：</div><div class="line">/etc/rc.d/init.d/httpd start</div></pre></td></tr></table></figure></p>
<p>第二种方式：（只支持RedHat系列的Linux）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">service 服务名 tart| stop | restart | status</div></pre></td></tr></table></figure></p>
<p><strong><em>service命令其本质是当命令运行时直接在/etc/rc.d/init.d目录下查找相应的服务，并进行相应的操作。）</em></strong></p>
<ul>
<li>自启动<br>-<br>第一种方式：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chkconfig --level 2345 服务名 on|off</div></pre></td></tr></table></figure>
</li>
</ul>
<p>第二种方式：（推荐）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi  /etc/rc.local (系统启动时会运行该文件)</div></pre></td></tr></table></figure></p>
<p>修改文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">touch /var/lock/subsys/local （更新系统的开机时间）</div><div class="line"># 在下一行，写入自己要启动的服务名，比如我要开机自启动httpd服务：</div><div class="line"># 就加入/etc/rc.d/init.d/httpd start</div><div class="line"># 更改后文件就是：</div><div class="line">touch /var/lock/subsys/local</div><div class="line">/etc/rc.d/init.d/httpd start</div></pre></td></tr></table></figure></p>
<h4 id="ntsysv自启动管理工具"><a href="#ntsysv自启动管理工具" class="headerlink" title="ntsysv自启动管理工具"></a>ntsysv自启动管理工具</h4><p>所有系统默认安装服务都可以使用ntsysv命令进行自启动管理。rpm包安装服务，自启动管理工具（只要rpm安装的，都可进行管理）</p>
<h3 id="源码包安装的服务-1"><a href="#源码包安装的服务-1" class="headerlink" title="源码包安装的服务"></a>源码包安装的服务</h3><p>启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/apache2/bin/apachectl  start</div></pre></td></tr></table></figure></p>
<p>自启动<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /etc/rc.local         </div><div class="line">加入</div><div class="line">/usr/local/apache2/bin/apachectl  start</div></pre></td></tr></table></figure></p>
<h2 id="计划任务"><a href="#计划任务" class="headerlink" title="计划任务"></a>计划任务</h2><blockquote>
<p>首先保证crond服务时启动的（crond默认是自启动的）</p>
</blockquote>
<p>命令：crontab</p>
<p>编辑格式： <em> </em> <em> </em> *  命令</p>
<p>说明：</p>
<ul>
<li>第一个*：一小时中第几分钟  0-59</li>
<li>第二个*：一天中第几个小时  0-23</li>
<li>第三个*：一个月中第几天    1-31</li>
<li>第四个*：一年第几个月      1-12</li>
<li>第五个*：一周中星期几       0-6             </li>
</ul>
<p>例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">10  *  31  *  *  命令</div><div class="line">10  *  *  *  *  命令</div><div class="line">5  4  *  5-10  *  命令</div><div class="line">*/10  *  *  *  *  命令</div><div class="line">5 4  1,15  *  *  命令  #日期和星期不要同时指定，会超出预期</div><div class="line">5 4 10 * 5 命令</div><div class="line">*/20 4 * 5 2   命令    #每隔二十分钟</div></pre></td></tr></table></figure></p>
<p>查看系统定时任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">crontab  -l</div></pre></td></tr></table></figure></p>
<p>删除定时任务(慎用，删除之前记得备份数据)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">crontab  -r</div></pre></td></tr></table></figure></p>
<p><strong>注意事项：</strong></p>
<ul>
<li>选项都不能为空，必须填入，不知道的值使用通配符*表示任何时间</li>
<li>每个时间字段都可以指定多个值，不连续的值用,间隔，连续的值用-间隔</li>
<li>间隔固定时间执行书写为*/n格式</li>
<li>命令应该给出绝对路径</li>
<li>星期几何第几天不能同时出现</li>
<li>最小时间范围是分钟，最大时间范围是月</li>
</ul>
<h2 id="查看系统启动信息"><a href="#查看系统启动信息" class="headerlink" title="查看系统启动信息"></a>查看系统启动信息</h2><p>查看系统启动信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dmesg</div></pre></td></tr></table></figure></p>
<p>系统启动信息日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cat  /var/log/dmesg</div></pre></td></tr></table></figure></p>
<p>查看eth0信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dmesg | grep eth0</div></pre></td></tr></table></figure></p>
<p>查看cpu信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dmesg | grep CPU</div></pre></td></tr></table></figure></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160929/LinuxFuWuHeJinChengGuanLi.png?1&quot; alt=&quot;Linux服务和进程管理&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Linux" scheme="https://weizhimiao.github.io/categories/Linux/"/>
    
    
      <category term="进程管理" scheme="https://weizhimiao.github.io/tags/%E8%BF%9B%E7%A8%8B%E7%AE%A1%E7%90%86/"/>
    
      <category term="服务管理" scheme="https://weizhimiao.github.io/tags/%E6%9C%8D%E5%8A%A1%E7%AE%A1%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title>Nginx运行状态监控</title>
    <link href="https://weizhimiao.github.io/2016/09/27/Nginx%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7/"/>
    <id>https://weizhimiao.github.io/2016/09/27/Nginx运行状态监控/</id>
    <published>2016-09-27T14:30:00.000Z</published>
    <updated>2016-09-27T09:41:45.000Z</updated>
    
    <content type="html"><![CDATA[<p>Nginx可以通过stub_status模块来查看服务器的状态信息。</p>
<a id="more"></a>
<h2 id="安装stub-status模块"><a href="#安装stub-status模块" class="headerlink" title="安装stub_status模块"></a>安装stub_status模块</h2><p>查看服务器当前是否已经编译安装过stub_status模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -V</div><div class="line">nginx version: nginx/1.11.4</div><div class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)</div><div class="line">configure arguments: --prefix=/usr/local/nginx</div></pre></td></tr></table></figure></p>
<p>安装 stub_status 模块</p>
<p>解压相应版本的nginx源码包，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd nginx-1.11.4</div></pre></td></tr></table></figure></p>
<p>配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/local/nginx --with-http_stub_status_module</div></pre></td></tr></table></figure></p>
<p>编译（不执行make install操作）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make</div></pre></td></tr></table></figure></p>
<p>手动替换 nginx 执行文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</div><div class="line">cp ./objs/nginx /usr/local/nginx/sbin/</div></pre></td></tr></table></figure></p>
<p>查看是否安装成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -V</div><div class="line">nginx version: nginx/1.11.4</div><div class="line">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)</div><div class="line">configure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module</div></pre></td></tr></table></figure></p>
<h2 id="启用nginx-status配置"><a href="#启用nginx-status配置" class="headerlink" title="启用nginx status配置"></a>启用nginx status配置</h2><p>修改配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure></p>
<p>加入配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location /ngx_status</div><div class="line">&#123;</div><div class="line">    stub_status on;</div><div class="line">    access_log off;</div><div class="line">    allow all;</div><div class="line">    #deny all;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重启nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># /usr/local/nginx/sbin/nginx -s reload 可能或有问题，所以先停止当前nginx进程，然后在重启。</div><div class="line">/usr/local/nginx/sbin/nginx -s stop</div><div class="line">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>浏览器或者curl访问</p>
<p><a href="http://120.76.250.101/ngx_status" target="_blank" rel="external">http://120.76.250.101/ngx_status</a><br>或<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">curl 127.0.0.1/ngx_status</div><div class="line">Active connections: 1</div><div class="line">server accepts handled requests</div><div class="line"> 2 2 2</div><div class="line">Reading: 0 Writing: 1 Waiting: 0</div></pre></td></tr></table></figure></p>
<p>参数说明</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Active connections</td>
<td>活跃的连接数量</td>
</tr>
<tr>
<td>server accepts handled requests</td>
<td>2 2 2 表示总共处理了2个连接 , 成功创建2次握手, 总共处理了2个请求</td>
</tr>
<tr>
<td>reading</td>
<td>读取客户端的连接数.</td>
</tr>
<tr>
<td>writing</td>
<td>响应数据到客户端的数量</td>
</tr>
<tr>
<td>waiting</td>
<td>开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.</td>
</tr>
</tbody>
</table>
<p>over~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Nginx可以通过stub_status模块来查看服务器的状态信息。&lt;/p&gt;
    
    </summary>
    
      <category term="Nginx" scheme="https://weizhimiao.github.io/categories/Nginx/"/>
    
    
      <category term="监控" scheme="https://weizhimiao.github.io/tags/%E7%9B%91%E6%8E%A7/"/>
    
  </entry>
  
  <entry>
    <title>PHP-FPM运行状态监控</title>
    <link href="https://weizhimiao.github.io/2016/09/27/PHP-FPM%E8%BF%90%E8%A1%8C%E7%8A%B6%E6%80%81%E7%9B%91%E6%8E%A7/"/>
    <id>https://weizhimiao.github.io/2016/09/27/PHP-FPM运行状态监控/</id>
    <published>2016-09-27T13:30:00.000Z</published>
    <updated>2016-09-27T09:29:18.000Z</updated>
    
    <content type="html"><![CDATA[<p>PHP-FPM内置了一个运行状态页，开启后便可查看PHP-FPM的详细运行状态，可以给我们在优化PHP-FPM时带来帮助。</p>
<a id="more"></a>
<h2 id="php-fpm配置"><a href="#php-fpm配置" class="headerlink" title="php-fpm配置"></a>php-fpm配置</h2><p>查看php-fpm配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ /usr/local/php56/sbin/php-fpm -t</div><div class="line">[27-Sep-2016 14:59:06] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>
<p>开启php-fpm的status配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/php56/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>
<p>修改加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pm.status_path = /phpfpm_status</div></pre></td></tr></table></figure></p>
<p>配置文件中相关的说明<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line">; The URI to view the FPM status page. If this value is not set, no URI will be</div><div class="line">; recognized as a status page. It shows the following informations:</div><div class="line">;   pool                 - the name of the pool;</div><div class="line">;   process manager      - static, dynamic or ondemand;</div><div class="line">;   start time           - the date and time FPM has started;</div><div class="line">;   start since          - number of seconds since FPM has started;</div><div class="line">;   accepted conn        - the number of request accepted by the pool;</div><div class="line">;   listen queue         - the number of request in the queue of pending</div><div class="line">;                          connections (see backlog in listen(2));</div><div class="line">;   max listen queue     - the maximum number of requests in the queue</div><div class="line">;                          of pending connections since FPM has started;</div><div class="line">;   listen queue len     - the size of the socket queue of pending connections;</div><div class="line">;   idle processes       - the number of idle processes;</div><div class="line">;   active processes     - the number of active processes;</div><div class="line">;   total processes      - the number of idle + active processes;</div><div class="line">;   max active processes - the maximum number of active processes since FPM</div><div class="line">;                          has started;</div><div class="line">;   max children reached - number of times, the process limit has been reached,</div><div class="line">;                          when pm tries to start more children (works only for</div><div class="line">;                          pm &apos;dynamic&apos; and &apos;ondemand&apos;);</div><div class="line">; Value are updated in real time.</div><div class="line">; Value are updated in real time.</div><div class="line">; Example output:</div><div class="line">;   pool:                 www</div><div class="line">;   process manager:      static</div><div class="line">;   start time:           01/Jul/2011:17:53:49 +0200</div><div class="line">;   start since:          62636</div><div class="line">;   accepted conn:        190460</div><div class="line">;   listen queue:         0</div><div class="line">;   max listen queue:     1</div><div class="line">;   listen queue len:     42</div><div class="line">;   idle processes:       4</div><div class="line">;   active processes:     11</div><div class="line">;   total processes:      15</div><div class="line">;   max active processes: 12</div><div class="line">;   max children reached: 0</div><div class="line">;</div><div class="line">; By default the status page output is formatted as text/plain. Passing either</div><div class="line">; &apos;html&apos;, &apos;xml&apos; or &apos;json&apos; in the query string will return the corresponding</div><div class="line">; output syntax. Example:</div><div class="line">;   http://www.foo.bar/status</div><div class="line">;   http://www.foo.bar/status?json</div><div class="line">;   http://www.foo.bar/status?html</div><div class="line">;   http://www.foo.bar/status?xml</div><div class="line">;</div><div class="line">; By default the status page only outputs short status. Passing &apos;full&apos; in the</div><div class="line">; query string will also return status for each pool process.</div><div class="line">; Example:</div><div class="line">;   http://www.foo.bar/status?full</div><div class="line">;   http://www.foo.bar/status?json&amp;full</div><div class="line">;   http://www.foo.bar/status?html&amp;full</div><div class="line">;   http://www.foo.bar/status?xml&amp;full</div><div class="line">; The Full status returns for each process:</div><div class="line">; The Full status returns for each process:</div><div class="line">;   pid                  - the PID of the process;</div><div class="line">;   state                - the state of the process (Idle, Running, ...);</div><div class="line">;   start time           - the date and time the process has started;</div><div class="line">;   start since          - the number of seconds since the process has started;</div><div class="line">;   requests             - the number of requests the process has served;</div><div class="line">;   request duration     - the duration in µs of the requests;</div><div class="line">;   request method       - the request method (GET, POST, ...);</div><div class="line">;   request URI          - the request URI with the query string;</div><div class="line">;   content length       - the content length of the request (only with POST);</div><div class="line">;   user                 - the user (PHP_AUTH_USER) (or &apos;-&apos; if not set);</div><div class="line">;   script               - the main script called (or &apos;-&apos; if not set);</div><div class="line">;   last request cpu     - the %cpu the last request consumed</div><div class="line">;                          it&apos;s always 0 if the process is not in Idle state</div><div class="line">;                          because CPU calculation is done when the request</div><div class="line">;                          processing has terminated;</div><div class="line">;   last request memory  - the max amount of memory the last request consumed</div><div class="line">;                          it&apos;s always 0 if the process is not in Idle state</div><div class="line">;                          because memory calculation is done when the request</div><div class="line">;                          processing has terminated;</div><div class="line">; If the process is in Idle state, then informations are related to the</div><div class="line">; last request the process has served. Otherwise informations are related to</div><div class="line">; the current request being served.</div><div class="line">; Example output:</div><div class="line">;   ************************</div><div class="line">;   pid:                  31330</div><div class="line">;   state:                Running</div><div class="line">;   start time:           01/Jul/2011:17:53:49 +0200</div><div class="line">;   start since:          63087</div><div class="line">;   requests:             12808</div><div class="line">;   request duration:     1250261</div><div class="line">;   request method:       GET</div><div class="line">;   request URI:          /test_mem.php?N=10000</div><div class="line">;   content length:       0</div><div class="line">;   user:                 -</div><div class="line">;   script:               /home/fat/web/docs/php/test_mem.php</div><div class="line">;   last request cpu:     0.00</div><div class="line">;   last request memory:  0</div><div class="line">;</div><div class="line">; Note: There is a real-time FPM status monitoring sample web page available</div><div class="line">;       It&apos;s available in: /usr/local/php56/share/php/fpm/status.html</div><div class="line">;</div><div class="line">; Note: The value must start with a leading slash (/). The value can be</div><div class="line">;       anything, but it may not be a good idea to use the .php extension or it</div><div class="line">;       may conflict with a real PHP file.</div><div class="line">; Default Value: not set</div><div class="line">pm.status_path = /phpfpm_status</div></pre></td></tr></table></figure></p>
<h2 id="重启PHP-FPM"><a href="#重启PHP-FPM" class="headerlink" title="重启PHP-FPM"></a>重启PHP-FPM</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure>
<h2 id="配置nginx代理"><a href="#配置nginx代理" class="headerlink" title="配置nginx代理"></a>配置nginx代理</h2><p>查看nginx配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -t</div><div class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</div></pre></td></tr></table></figure></p>
<p>修改配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure></p>
<p>加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">location /phpfpm_status &#123;</div><div class="line">        fastcgi_pass  127.0.0.1:9000;</div><div class="line">        include fastcgi_params;</div><div class="line">        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重启nginx<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>浏览器或者通过curl访问</p>
<p><a href="http://127.0.0.1/phpfpm_status" target="_blank" rel="external">http://you-server-ip/phpfpm_status</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@iZwz9g8nzni5lj69dhlesoZ ~]# curl 127.0.0.1/phpfpm_status</div><div class="line">pool:                 www</div><div class="line">process manager:      dynamic</div><div class="line">start time:           27/Sep/2016:15:08:57 +0800</div><div class="line">start since:          385</div><div class="line">accepted conn:        3</div><div class="line">listen queue:         0</div><div class="line">max listen queue:     0</div><div class="line">listen queue len:     128</div><div class="line">idle processes:       1</div><div class="line">active processes:     1</div><div class="line">total processes:      2</div><div class="line">max active processes: 1</div><div class="line">max children reached: 0</div><div class="line">slow requests:        0</div></pre></td></tr></table></figure>
<ul>
<li>参数说明：</li>
</ul>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pool</td>
<td>fpm池子名称，大多数为www</td>
</tr>
<tr>
<td>process manager</td>
<td>进程管理方式,值：static, dynamic or ondemand. dynamic</td>
</tr>
<tr>
<td>start time</td>
<td>启动日期,如果reload了php-fpm，时间会更新</td>
</tr>
<tr>
<td>start since</td>
<td>运行时长</td>
</tr>
<tr>
<td>accepted conn</td>
<td>当前池子接受的请求数</td>
</tr>
<tr>
<td>listen queue</td>
<td>请求等待队列，如果这个值不为0，那么要增加FPM的进程数量</td>
</tr>
<tr>
<td>max listen queue</td>
<td>请求等待队列最高的数量</td>
</tr>
<tr>
<td>listen queue len</td>
<td>socket等待队列长度</td>
</tr>
<tr>
<td>idle processes</td>
<td>空闲进程数量</td>
</tr>
<tr>
<td>active processes</td>
<td>活跃进程数量</td>
</tr>
<tr>
<td>total processes</td>
<td>总进程数量</td>
</tr>
<tr>
<td>max active processes</td>
<td>最大的活跃进程数量（FPM启动开始算）</td>
</tr>
<tr>
<td>max children reached</td>
<td>大道进程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量太小了，请改大一点。</td>
</tr>
<tr>
<td>slow requests</td>
<td>启用了php-fpm slow-log，缓慢请求的数量</td>
</tr>
</tbody>
</table>
<ul>
<li>php-fpm还提供不同格式的输入，方便我们查看和与其他监控系统对接。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://www.foo.bar/status       #默认纯文本</div><div class="line">http://www.foo.bar/status?json  #json格式</div><div class="line">http://www.foo.bar/status?html  #html</div><div class="line">http://www.foo.bar/status?xml   #xml</div></pre></td></tr></table></figure>
<ul>
<li>通过增加full参数，php-fpm还提供查看所有进程的运行状况</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">http://www.foo.bar/status?full        #默认纯文本</div><div class="line">http://www.foo.bar/status?json&amp;full   #json格式</div><div class="line">http://www.foo.bar/status?html&amp;full   #html</div><div class="line">http://www.foo.bar/status?xml&amp;full    #xml</div></pre></td></tr></table></figure>
<p>示例：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">curl &apos;http://127.0.0.1/phpfpm_status?full&apos;</div><div class="line">pool:                 www</div><div class="line">process manager:      dynamic</div><div class="line">start time:           27/Sep/2016:15:08:57 +0800</div><div class="line">start since:          1546</div><div class="line">accepted conn:        14</div><div class="line">listen queue:         0</div><div class="line">max listen queue:     0</div><div class="line">listen queue len:     128</div><div class="line">idle processes:       1</div><div class="line">active processes:     1</div><div class="line">total processes:      2</div><div class="line">max active processes: 1</div><div class="line">max children reached: 0</div><div class="line">slow requests:        0</div><div class="line">************************</div><div class="line">pid:                  12132</div><div class="line">state:                Running</div><div class="line">start time:           27/Sep/2016:15:08:57 +0800</div><div class="line">start since:          1546</div><div class="line">requests:             7</div><div class="line">request duration:     117</div><div class="line">request method:       GET</div><div class="line">request URI:          /phpfpm_status?full</div><div class="line">content length:       0</div><div class="line">user:                 -</div><div class="line">script:               /phpfpm_status</div><div class="line">last request cpu:     0.00</div><div class="line">last request memory:  0</div><div class="line">************************</div><div class="line">pid:                  12133</div><div class="line">state:                Idle</div><div class="line">start time:           27/Sep/2016:15:08:57 +0800</div><div class="line">start since:          1546</div><div class="line">requests:             7</div><div class="line">request duration:     132</div><div class="line">request method:       GET</div><div class="line">request URI:          /phpfpm_status?html&amp;full</div><div class="line">content length:       0</div><div class="line">user:                 -</div><div class="line">script:               /phpfpm_status</div><div class="line">last request cpu:     0.00</div><div class="line">last request memory:  262144</div></pre></td></tr></table></figure></p>
<p>具体进程参数说明</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pid</td>
<td>进程号</td>
</tr>
<tr>
<td>state</td>
<td>状态（Idle - 闲置， Running - 运行， …）</td>
</tr>
<tr>
<td>start time</td>
<td>进程开始运行时间</td>
</tr>
<tr>
<td>start since</td>
<td>进程开始持续时间（单位：秒）</td>
</tr>
<tr>
<td>requests</td>
<td>进程已经处理的请求数</td>
</tr>
<tr>
<td>request duration</td>
<td>µs的请求数量</td>
</tr>
<tr>
<td>request method</td>
<td>请求方式（GET, POST, …）</td>
</tr>
<tr>
<td>request URI</td>
<td>请求URI</td>
</tr>
<tr>
<td>content length</td>
<td>请求内容长度（仅限POST请求）</td>
</tr>
<tr>
<td>user</td>
<td>PHP_AUTH_USER （’-‘， 表示没有限制）</td>
</tr>
<tr>
<td>script</td>
<td>请求文件</td>
</tr>
<tr>
<td>last request cpu</td>
<td>最后一次请求占用CPU百分比（如果进程不是处于 <code>Idle - 闲置</code> 状态，该值总是0，因为当请求处理终止时，CPU计算已经完成）</td>
</tr>
<tr>
<td>last request memory</td>
<td>最后一次请求占用内存（如果进程不是处于 <code>Idle - 闲置</code> 状态，该值总是0，因为当请求处理终止时，memory计算已经完成）</td>
</tr>
</tbody>
</table>
<p><strong>Tips:</strong><br>如果进程处于 idle 状态，所显示的信息就是基于最后一次请求给出的状态，否则就是基于本次请求的状态。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;PHP-FPM内置了一个运行状态页，开启后便可查看PHP-FPM的详细运行状态，可以给我们在优化PHP-FPM时带来帮助。&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://weizhimiao.github.io/categories/PHP/"/>
    
    
      <category term="监控" scheme="https://weizhimiao.github.io/tags/%E7%9B%91%E6%8E%A7/"/>
    
      <category term="PHP-FPM" scheme="https://weizhimiao.github.io/tags/PHP-FPM/"/>
    
  </entry>
  
  <entry>
    <title>PHP扩展模块安装</title>
    <link href="https://weizhimiao.github.io/2016/09/26/PHP%E6%89%A9%E5%B1%95%E6%A8%A1%E5%9D%97%E5%AE%89%E8%A3%85/"/>
    <id>https://weizhimiao.github.io/2016/09/26/PHP扩展模块安装/</id>
    <published>2016-09-26T13:30:00.000Z</published>
    <updated>2016-09-26T13:14:08.000Z</updated>
    
    <content type="html"><![CDATA[<p>PHP编译安装之后，通常我们还需要根据我们的业务需求去安装各种扩展。通常我们可以通过php提供的phpize这个工具来为PHP动态地添加我们需要的模块。</p>
<a id="more"></a>
<h2 id="工具介绍"><a href="#工具介绍" class="headerlink" title="工具介绍"></a>工具介绍</h2><ul>
<li><p>phpize，是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块。一般在我们安装PHP时已经一起安装了。位置一般在/path/to/php/bin/phpize。</p>
</li>
<li><p>autoconf，是用来生成自动配置软件源代码脚本（configure）的 工具.configure脚本能独立于autoconf运行,且在 运行的 过程中,不需要用户的干预.</p>
</li>
<li><p>m4，是 一个宏处理器.将输入拷贝到输出,同时将宏展开.宏可以是 内嵌的 ,也可以是 用户定义的 .除了可以展开宏,m4还有一些内建的 函数,用来引用文件,执行命令,整数运算,文本操作,循环等.m4既可以作为编译器的 前端,也可以单独作为一个宏处理器.</p>
</li>
</ul>
<h2 id="示例（为PHP添加mysqli扩展）"><a href="#示例（为PHP添加mysqli扩展）" class="headerlink" title="示例（为PHP添加mysqli扩展）"></a>示例（为PHP添加mysqli扩展）</h2><p>进入PHP源码包的ext/mysqli扩展目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd  ext/mysqli</div><div class="line">./configure --with-php-config=/usr/local/php56/bin/php-config --with-mysqli=/usr/local/mysql/bin/mysql_config</div><div class="line">make &amp;&amp; make install</div><div class="line">#</div><div class="line">#Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class="line">#Installing header files:           /usr/local/php56/include/php/</div></pre></td></tr></table></figure></p>
<p>查看模块是否编译成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class="line">ll</div><div class="line">#-rwxr-xr-x 1 root root  756714 Sep 26 17:32 mysqli.so</div><div class="line">#-rwxr-xr-x 1 root root 1333912 Sep 24 23:31 opcache.a</div><div class="line">#-rwxr-xr-x 1 root root  618435 Sep 24 23:31 opcache.so</div></pre></td></tr></table></figure></p>
<p>将模块加载到php<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/php56/lib/php.ini</div><div class="line">#将下面这行写入到php.ini中</div><div class="line">extension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/mysqli.so</div></pre></td></tr></table></figure></p>
<p>重启php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>
<p>查看是否加载成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">php -m</div></pre></td></tr></table></figure></p>
<p>或浏览器访问index.php (包含phpinfo()函数)</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;PHP编译安装之后，通常我们还需要根据我们的业务需求去安装各种扩展。通常我们可以通过php提供的phpize这个工具来为PHP动态地添加我们需要的模块。&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://weizhimiao.github.io/categories/PHP/"/>
    
    
      <category term="PHP扩展" scheme="https://weizhimiao.github.io/tags/PHP%E6%89%A9%E5%B1%95/"/>
    
      <category term="phpize" scheme="https://weizhimiao.github.io/tags/phpize/"/>
    
  </entry>
  
  <entry>
    <title>LNMP环境安装与配置</title>
    <link href="https://weizhimiao.github.io/2016/09/25/LNMP%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E4%B8%8E%E9%85%8D%E7%BD%AE/"/>
    <id>https://weizhimiao.github.io/2016/09/25/LNMP环境安装与配置/</id>
    <published>2016-09-25T15:30:00.000Z</published>
    <updated>2016-09-26T13:16:26.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://n.sinaimg.cn/games/3ece443e/20160925/lnmp_log.png" alt="LNMP"><br><a id="more"></a></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><p>OS：CentOS 7.2 64</p>
<p>MySQL：<a href="http://dev.mysql.com/downloads/mysql/" target="_blank" rel="external">mysql-5.7.15</a></p>
<p>Nginx：<a href="http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz" target="_blank" rel="external">nginx-1.11.4</a></p>
<p>PHP：<a href="http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz" target="_blank" rel="external">php-5.6.25</a></p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>参考MySQL、Nginx、PHP的编译安装，分别安装 MySQL、Nginx、PHP到Linux。</p>
<h2 id="整合"><a href="#整合" class="headerlink" title="整合"></a>整合</h2><h3 id="启动-php-fpm"><a href="#启动-php-fpm" class="headerlink" title="启动 php-fpm"></a>启动 php-fpm</h3><p>新建用户和用户组，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># groupadd www-data</div><div class="line"># useradd -g www-data www-data</div></pre></td></tr></table></figure></p>
<p>需要修改 php-fpm.conf 配置文件，确保 php-fpm 模块使用 www-data 用户和 www-data 用户组的身份运行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/php56/etc/php-fpm.conf</div><div class="line">#找到以下内容并修改：</div><div class="line">; Unix user/group of processes</div><div class="line">; Note: The user is mandatory. If the group is not set, the default user&apos;s group</div><div class="line">;       will be used.</div><div class="line">user = www-data</div><div class="line">group = www-data</div></pre></td></tr></table></figure>
<p>修改 pid 配置，以方便我们后面根据pid管理php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[global]</div><div class="line">; Pid file</div><div class="line">; Note: the default prefix is /usr/local/php56/var</div><div class="line">; Default Value: none</div><div class="line">pid = run/php-fpm.pid</div></pre></td></tr></table></figure></p>
<p>PHP-FPM运行时，将会在/usr/local/php56/var/run/下生成 php-fpm.pid 文件。</p>
<p>然后启动 php-fpm 服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/php56/sbin/php-fpm</div></pre></td></tr></table></figure></p>
<p>查看是否启动成功<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ps aux | grep php</div><div class="line">root     18858  0.0  0.1 148164  3208 ?        Ss   12:38   0:00 php-fpm: master process (/usr/local/php56/etc/php-fpm.conf)</div><div class="line">www-data 18859  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www</div><div class="line">www-data 18860  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www</div><div class="line">root     18862  0.0  0.0 112664   972 pts/1    S+   12:38   0:00 grep --color=auto php</div></pre></td></tr></table></figure></p>
<p><strong>注</strong> 需要着重提醒的是，如果文件不存在，则阻止 Nginx 将请求发送到后端的 PHP-FPM 模块， 以避免遭受恶意脚本注入的攻击。<br>将 php.ini 文件中的配置项 cgi.fix_pathinfo 设置为 0 。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi /usr/local/php56/lib/php.ini</div><div class="line"></div><div class="line">cgi.fix_pathinfo=0</div></pre></td></tr></table></figure>
<h3 id="PHP-FPM-重要配置"><a href="#PHP-FPM-重要配置" class="headerlink" title="PHP-FPM 重要配置"></a>PHP-FPM 重要配置</h3><p>php-fpm.conf重要参数详解</p>
<ul>
<li><p>pid = run/php-fpm.pid</p>
<blockquote>
<p>pid设置，默认在安装目录中的var/run/php-fpm.pid，建议开启</p>
</blockquote>
</li>
<li><p>error_log = log/php-fpm.log</p>
<blockquote>
<p>错误日志，默认在安装目录中的var/log/php-fpm.log</p>
</blockquote>
</li>
<li><p>log_level = notice</p>
<blockquote>
<p>错误级别. 可用级别为: alert（必须立即处理）, error（错误情况）, warning（警告情况）, notice（一般重要信息）, debug（调试信息）. 默认: notice.</p>
</blockquote>
</li>
<li><p>emergency_restart_threshold = 60</p>
</li>
<li><p>emergency_restart_interval = 60s</p>
<blockquote>
<p>表示在emergency_restart_interval所设值内出现SIGSEGV或者SIGBUS错误的php-cgi进程数如果超过 emergency_restart_threshold个，php-fpm就会优雅重启。这两个选项一般保持默认值。</p>
</blockquote>
</li>
<li><p>process_control_timeout = 0</p>
<blockquote>
<p>设置子进程接受主进程复用信号的超时时间. 可用单位: s(秒), m(分), h(小时), 或者 d(天) 默认单位: s(秒). 默认值: 0.</p>
</blockquote>
</li>
<li><p>daemonize = yes</p>
<blockquote>
<p>后台执行fpm,默认值为yes，如果为了调试可以改为no。在FPM中，可以使用不同的设置来运行多个进程池。 这些设置可以针对每个进程池单独设置。</p>
</blockquote>
</li>
<li><p>listen = 127.0.0.1:9000</p>
<blockquote>
<p>fpm监听端口，即nginx中php处理的地址，一般默认值即可。可用格式为: ‘ip:port’, ‘port’, ‘/path/to/unix/socket’. 每个进程池都需要设置.</p>
</blockquote>
</li>
<li><p>listen.backlog = -1</p>
<blockquote>
<p>backlog数，-1表示无限制，由操作系统决定，此行注释掉就行。</p>
</blockquote>
</li>
<li><p>listen.allowed_clients = 127.0.0.1</p>
<blockquote>
<p>允许访问FastCGI进程的IP，设置any为不限制IP，如果要设置其他主机的nginx也能访问这台FPM进程，listen处要设置成本地可被访问的IP。默认值是any。每个地址是用逗号分隔. 如果没有设置或者为空，则允许任何服务器请求连接</p>
</blockquote>
</li>
<li><p>listen.owner = www</p>
</li>
<li>listen.group = www</li>
<li><p>listen.mode = 0666</p>
<blockquote>
<p>unix socket设置选项，如果使用tcp方式访问，这里注释即可。</p>
</blockquote>
</li>
<li><p>user = www</p>
</li>
<li><p>group = www</p>
<blockquote>
<p>启动进程的帐户和组</p>
</blockquote>
</li>
<li><p>pm = dynamic #对于专用服务器，pm可以设置为static。</p>
<blockquote>
<p>如何控制子进程，选项有static和dynamic。如果选择static，则由pm.max_children指定固定的子进程数。如果选择dynamic，则由下开参数决定：</p>
</blockquote>
</li>
<li><p>pm.max_children #</p>
<blockquote>
<p>子进程最大数</p>
</blockquote>
</li>
<li><p>pm.start_servers #</p>
<blockquote>
<p>启动时的进程数</p>
</blockquote>
</li>
<li><p>pm.min_spare_servers #</p>
<blockquote>
<p>保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程</p>
</blockquote>
</li>
<li><p>pm.max_spare_servers #</p>
<blockquote>
<p>保证空闲进程数最大值，如果空闲进程大于此值，此进行清理</p>
</blockquote>
</li>
<li><p>pm.max_requests = 1000</p>
<blockquote>
<p>设置每个子进程重生之前服务的请求数. 对于可能存在内存泄漏的第三方模块来说是非常有用的. 如果设置为 ‘0’ 则一直接受请求. 等同于 PHP_FCGI_MAX_REQUESTS 环境变量. 默认值: 0.</p>
</blockquote>
</li>
<li><p>pm.status_path = /status</p>
<blockquote>
<p>FPM状态页面的网址. 如果没有设置, 则无法访问状态页面. 默认值: none. munin监控会使用到</p>
</blockquote>
</li>
<li><p>ping.path = /ping</p>
<blockquote>
<p>FPM监控页面的ping网址. 如果没有设置, 则无法访问ping页面. 该页面用于外部检测FPM是否存活并且可以响应请求. 请注意必须以斜线开头 (/)。</p>
</blockquote>
</li>
<li><p>ping.response = pong</p>
<blockquote>
<p>用于定义ping请求的返回相应. 返回为 HTTP 200 的 text/plain 格式文本. 默认值: pong.</p>
</blockquote>
</li>
<li><p>request_terminate_timeout = 0</p>
<blockquote>
<p>设置单个请求的超时中止时间. 该选项可能会对php.ini设置中的’max_execution_time’因为某些特殊原因没有中止运行的脚本有用. 设置为 ‘0’ 表示 ‘Off’.当经常出现502错误时可以尝试更改此选项。</p>
</blockquote>
</li>
<li><p>request_slowlog_timeout = 10s</p>
<blockquote>
<p>当一个请求该设置的超时时间后，就会将对应的PHP调用堆栈信息完整写入到慢日志中. 设置为 ‘0’ 表示 ‘Off’</p>
</blockquote>
</li>
<li><p>slowlog = log/$pool.log.slow</p>
<blockquote>
<p>慢请求的记录日志,配合request_slowlog_timeout使用</p>
</blockquote>
</li>
<li><p>rlimit_files = 1024</p>
<blockquote>
<p>设置文件打开描述符的rlimit限制. 默认值: 系统定义值默认可打开句柄是1024，可使用 ulimit -n查看，ulimit -n 2048修改。</p>
</blockquote>
</li>
<li><p>rlimit_core = 0</p>
<blockquote>
<p>设置核心rlimit最大限制值. 可用值: ‘unlimited’ 、0或者正整数. 默认值: 系统定义值.</p>
</blockquote>
</li>
<li><p>chroot =</p>
<blockquote>
<p>启动时的Chroot目录. 所定义的目录需要是绝对路径. 如果没有设置, 则chroot不被使用.</p>
</blockquote>
</li>
<li><p>chdir =</p>
<blockquote>
<p>设置启动目录，启动时会自动Chdir到该目录. 所定义的目录需要是绝对路径. 默认值: 当前目录，或者/目录（chroot时）</p>
</blockquote>
</li>
<li><p>catch_workers_output = yes</p>
<blockquote>
<p>重定向运行过程中的stdout和stderr到主要的错误日志文件中. 如果没有设置, stdout 和 stderr 将会根据FastCGI的规则被重定向到 /dev/null . 默认值: 空.</p>
</blockquote>
</li>
</ul>
<p><strong>Tips</strong> 配置完成之后可以通过 php-fpm -t 来检测配置是否基本正确。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># /usr/local/php56/sbin/php-fpm -t</div><div class="line">[25-Sep-2016 12:58:14] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>
<h3 id="php-fpm管理"><a href="#php-fpm管理" class="headerlink" title="php-fpm管理"></a>php-fpm管理</h3><p>测试php-fpm配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/php/sbin/php-fpm -t</div><div class="line">/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf -t</div></pre></td></tr></table></figure></p>
<p>启动php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/php/sbin/php-fpm</div><div class="line">/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>
<p>关闭php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -INT `cat /usr/local/php/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>
<p>重启php-fpm<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kill -USR2 `cat /usr/local/php/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>
<h2 id="配置-Nginx-使其支持-PHP-应用："><a href="#配置-Nginx-使其支持-PHP-应用：" class="headerlink" title="配置 Nginx 使其支持 PHP 应用："></a>配置 Nginx 使其支持 PHP 应用：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vim /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure>
<p>修改默认的 location 块，使其支持 .php 文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    root   html;</div><div class="line">    index  index.php index.html index.htm;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下一步配置来保证对于 .php 文件的请求将被传送到后端的 PHP-FPM 模块， 取消默认的 PHP 配置块的注释，并修改为下面的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">location ~* \.php$ &#123;</div><div class="line">    fastcgi_index   index.php;</div><div class="line">    fastcgi_pass    127.0.0.1:9000;</div><div class="line">    include         fastcgi_params;</div><div class="line">    fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;</div><div class="line">    fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>重启 Nginx。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># /usr/local/nginx/sbin/nginx -t</div><div class="line">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</div><div class="line">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</div><div class="line">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure></p>
<p>创建测试文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;&lt;?php  phpinfo();?&gt;&quot; &gt; /usr/local/nginx/html/index.php</div></pre></td></tr></table></figure></p>
<p>打开浏览器，访问 <a href="http://ip，将会显示" target="_blank" rel="external">http://ip，将会显示</a> phpinfo() 。</p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>创建测试文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi mysql_conn_test.php</div></pre></td></tr></table></figure></p>
<p>输入<br><figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">$conn = mysql_connect(<span class="string">"localhost"</span>, <span class="string">"root"</span>, <span class="string">"123456"</span>) <span class="keyword">or</span> <span class="keyword">die</span>(<span class="string">"connect failed"</span> . mysql_error());  </div><div class="line">$sql = sprintf(<span class="string">"SHOW DATABASES;"</span>);  </div><div class="line">$result = mysql_query($sql, $conn);  </div><div class="line"><span class="keyword">while</span> ($row=mysql_fetch_array($result, MYSQL_ASSOC))&#123;</div><div class="line">  print_r($row);</div><div class="line">&#125;</div><div class="line"><span class="meta">?&gt;</span></div></pre></td></tr></table></figure></p>
<p>结果如下，则说明，连接测试成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Array ( [Database] =&gt; information_schema ) Array ( [Database] =&gt; mysql ) Array ( [Database] =&gt; performance_schema ) Array ( [Database] =&gt; sys )</div></pre></td></tr></table></figure></p>
<p>至此，LNMP环境算是基本配置成功。</p>
<p>over~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160925/lnmp_log.png&quot; alt=&quot;LNMP&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://weizhimiao.github.io/categories/PHP/"/>
    
    
      <category term="LNMP" scheme="https://weizhimiao.github.io/tags/LNMP/"/>
    
  </entry>
  
  <entry>
    <title>PHP安装</title>
    <link href="https://weizhimiao.github.io/2016/09/25/PHP%E5%AE%89%E8%A3%85/"/>
    <id>https://weizhimiao.github.io/2016/09/25/PHP安装/</id>
    <published>2016-09-25T14:30:00.000Z</published>
    <updated>2016-09-25T10:43:48.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://n.sinaimg.cn/games/3ece443e/20160925/php_log.png" alt="php"></p>
<a id="more"></a>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>OS：CentOS 7.2 64</p>
<p>PHP：<a href="http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz" target="_blank" rel="external">php-5.6.25</a></p>
<h2 id="编译前准备"><a href="#编译前准备" class="headerlink" title="编译前准备"></a>编译前准备</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install libxml2 libxml2-devel</div></pre></td></tr></table></figure>
<p>libxml2,是个C语言的XML程式库，能简单方便的提供对XML文件的各种操作，并且支持XPATH查询，及部分的支持XSLT转换等功能。</p>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>解压源码包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar zxvf php-5.6.25.tar.gz</div></pre></td></tr></table></figure></p>
<p>进入源码包目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd php-5.6.25</div></pre></td></tr></table></figure></p>
<p>编译、安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/local/php56 --enable-fpm --with-mysql</div><div class="line">make &amp;&amp; make install</div><div class="line">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class="line">Installing PHP CLI binary:        /usr/local/php56/bin/</div><div class="line">Installing PHP CLI man page:      /usr/local/php56/php/man/man1/</div><div class="line">Installing PHP FPM binary:        /usr/local/php56/sbin/</div><div class="line">Installing PHP FPM config:        /usr/local/php56/etc/</div><div class="line">Installing PHP FPM man page:      /usr/local/php56/php/man/man8/</div><div class="line">Installing PHP FPM status page:   /usr/local/php56/php/php/fpm/</div><div class="line">Installing PHP CGI binary:        /usr/local/php56/bin/</div><div class="line">Installing PHP CGI man page:      /usr/local/php56/php/man/man1/</div><div class="line">Installing build environment:     /usr/local/php56/lib/php/build/</div><div class="line">Installing header files:           /usr/local/php56/include/php/</div><div class="line">Installing helper programs:       /usr/local/php56/bin/</div><div class="line">  program: phpize</div><div class="line">  program: php-config</div><div class="line">Installing man pages:             /usr/local/php56/php/man/man1/</div><div class="line">  page: phpize.1</div><div class="line">  page: php-config.1</div><div class="line">Installing PEAR environment:      /usr/local/php56/lib/php/</div><div class="line">[PEAR] Archive_Tar    - installed: 1.4.0</div><div class="line">[PEAR] Console_Getopt - installed: 1.4.1</div><div class="line">[PEAR] Structures_Graph- installed: 1.1.1</div><div class="line">[PEAR] XML_Util       - installed: 1.3.0</div><div class="line">[PEAR] PEAR           - installed: 1.10.1</div><div class="line">Wrote PEAR system config file at: /usr/local/php56/etc/pear.conf</div><div class="line">You may want to add: /usr/local/php56/lib/php to your php.ini include_path</div><div class="line">/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php56/bin</div><div class="line">ln -s -f phar.phar /usr/local/php56/bin/phar</div><div class="line">Installing PDO headers:           /usr/local/php56/include/php/ext/pdo/</div></pre></td></tr></table></figure></p>
<p>生成配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp php.ini-development /usr/local/php56/lib/php.ini</div><div class="line">cp /usr/local/php56/etc/php-fpm.conf.default /usr/local/php56/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>
<p>查看配置文件是否已生效。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ /usr/local/php56/bin/php -r &quot;phpinfo();&quot;</div><div class="line">如果看到以下输出，则表示配置文件加载成功。</div><div class="line">Configuration File (php.ini) Path =&gt; /usr/local/php56/lib</div><div class="line">Loaded Configuration File =&gt; /usr/local/php56/lib/php.ini</div></pre></td></tr></table></figure></p>
<p>将php加入到PATH中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vi ~/.bash_profile</div><div class="line">#在export PATH前一行插入</div><div class="line">PATH=$PATH:/usr/local/php56/bin:/usr/local/php56/lib</div></pre></td></tr></table></figure></p>
<p>重新加载环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">source /root/.bash_profile</div></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@iZwz97v8o84q253plfkxvfZ php56]# php -version</div><div class="line">PHP 5.6.25 (cli) (built: Sep 24 2016 23:30:43)</div><div class="line">Copyright (c) 1997-2016 The PHP Group</div><div class="line">Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies</div></pre></td></tr></table></figure>
<p><strong>Tips:</strong><br>如何确定PHP当前使用的配置文件的位置？</p>
<p>php：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ /usr/local/php56/bin/php -r &quot;phpinfo();&quot;</div><div class="line">如果看到以下输出，则表示配置文件加载成功。</div><div class="line">Configuration File (php.ini) Path =&gt; /usr/local/php56/lib</div><div class="line">Loaded Configuration File =&gt; /usr/local/php56/lib/php.ini</div></pre></td></tr></table></figure></p>
<p>php-fpm:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/usr/local/php56/sbin/php-fpm -t</div><div class="line">[25-Sep-2016 18:01:40] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>
<p>over~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160925/php_log.png&quot; alt=&quot;php&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="PHP" scheme="https://weizhimiao.github.io/categories/PHP/"/>
    
    
      <category term="PHP-FPM" scheme="https://weizhimiao.github.io/tags/PHP-FPM/"/>
    
  </entry>
  
  <entry>
    <title>Nginx安装</title>
    <link href="https://weizhimiao.github.io/2016/09/25/nginx%E5%AE%89%E8%A3%85/"/>
    <id>https://weizhimiao.github.io/2016/09/25/nginx安装/</id>
    <published>2016-09-25T13:30:00.000Z</published>
    <updated>2016-09-25T10:46:05.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://n.sinaimg.cn/games/3ece443e/20160925/nginx_log.png" alt="nginx"></p>
<a id="more"></a>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>OS：CentOS 7.2 64</p>
<p>Nginx：<a href="http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz" target="_blank" rel="external">nginx-1.11.4</a></p>
<h2 id="编译环境准备"><a href="#编译环境准备" class="headerlink" title="编译环境准备"></a>编译环境准备</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel</div></pre></td></tr></table></figure>
<blockquote>
<p>依赖工具说明:<br>gcc 编译器<br>pcre 正则表达式工具<br>zlib 传输内容压缩<br>openssl Https支持</p>
</blockquote>
<h2 id="编译安装"><a href="#编译安装" class="headerlink" title="编译安装"></a>编译安装</h2><p>解压源码包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf nginx-1.11.4.tar.gz</div></pre></td></tr></table></figure></p>
<p>进入源码包目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd nginx-1.11.4</div></pre></td></tr></table></figure></p>
<p>执行配置命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">./configure --prefix=/usr/local</div><div class="line">Configuration summary</div><div class="line">  + using PCRE library: /usr/local/pcre</div><div class="line">  + OpenSSL library is not used</div><div class="line">  + using system zlib library</div><div class="line"></div><div class="line">  nginx path prefix: &quot;/usr/local/nginx&quot;</div><div class="line">  nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;</div><div class="line">  nginx modules path: &quot;/usr/local/nginx/modules&quot;</div><div class="line">  nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;</div><div class="line">  nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;</div><div class="line">  nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;</div><div class="line">  nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</div><div class="line">  nginx http access log file: &quot;/usr/local/nginx/logs/access.log&quot;</div><div class="line">  nginx http client request body temporary files: &quot;client_body_temp&quot;</div><div class="line">  nginx http proxy temporary files: &quot;proxy_temp&quot;</div><div class="line">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</div><div class="line">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</div><div class="line">  nginx http scgi temporary files: &quot;scgi_temp&quot;</div></pre></td></tr></table></figure></p>
<p>执行编译安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>
<h2 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h2><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -s stop</div></pre></td></tr></table></figure>
<h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure>
<h3 id="查看Nginx进程状态"><a href="#查看Nginx进程状态" class="headerlink" title="查看Nginx进程状态"></a>查看Nginx进程状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ps aux |grep nginx</div></pre></td></tr></table></figure>
<p>结果形如<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root     24367  0.0  0.0  20472   604 ?        Ss   22:52   0:00 nginx: master process /usr/local/nginx/sbin/nginx</div><div class="line">nobody   24368  0.0  0.0  20900  1320 ?        S    22:52   0:00 nginx: worker process</div><div class="line">root     24370  0.0  0.0 112664   976 pts/0    S+   22:52   0:00 grep --color=auto nginx</div></pre></td></tr></table></figure></p>
<blockquote>
<p>master proccess为主进程 守护进程<br>worker proccess为工作进程, 用于响应请求</p>
</blockquote>
<h3 id="设置开机自动启动"><a href="#设置开机自动启动" class="headerlink" title="设置开机自动启动"></a>设置开机自动启动</h3><p>编辑文件 /etc/rc.d/rc.local<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;/usr/local/nginx/sbin/nginx&quot; &gt;&gt; /etc/rc.d/rc.local</div></pre></td></tr></table></figure></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>启动nginx，在浏览器通过IP地址访问服务器。查看是否有响应。</p>
<p>~over</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160925/nginx_log.png&quot; alt=&quot;nginx&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Nginx" scheme="https://weizhimiao.github.io/categories/Nginx/"/>
    
    
      <category term="Nginx安装" scheme="https://weizhimiao.github.io/tags/Nginx%E5%AE%89%E8%A3%85/"/>
    
  </entry>
  
  <entry>
    <title>MySQL编译安装</title>
    <link href="https://weizhimiao.github.io/2016/09/25/MySQL%E5%AE%89%E8%A3%85%E7%BC%96%E8%AF%91/"/>
    <id>https://weizhimiao.github.io/2016/09/25/MySQL安装编译/</id>
    <published>2016-09-25T12:30:00.000Z</published>
    <updated>2016-09-25T10:46:14.000Z</updated>
    
    <content type="html"><![CDATA[<p><img src="http://n.sinaimg.cn/games/3ece443e/20160925/mysql_log.png" alt="MySQL"><br><a id="more"></a></p>
<h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>OS：CentOS 7.2 64</p>
<p>MySQL：<a href="http://dev.mysql.com/downloads/mysql/" target="_blank" rel="external">mysql-5.7.15</a></p>
<h2 id="编译环境准备"><a href="#编译环境准备" class="headerlink" title="编译环境准备"></a>编译环境准备</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># yum -y install make gcc-c++ cmake bison-devel ncurses-devel</div></pre></td></tr></table></figure>
<blockquote>
<p>make，Linux下非常重要的编译工具，最主要也是最基本的功能就是通过makefile文件来描述源程序之间的相互关系并自动维护编译工作。<br>gcc-c++，C++ 编译器（gcc，C编译器）<br>cmake，一个跨平台的编译自动配置工具，（作用生成makefile 文件）<br>bison-devel 一个语法分析器生成器<br>ncurses-devel，Ncurses介绍摘要:Ncurses是一个能提供功能键定义(快捷键),屏幕绘制以及基于文本终端.</p>
</blockquote>
<h3 id="ncurses"><a href="#ncurses" class="headerlink" title="ncurses"></a>ncurses</h3><p>Ncurses 提供字符终端处理库，包括面板和菜单。它提供了一套控制光标，建立窗口，改变前景背景颜色以及处理鼠标操作的函数。使用户在字符终端下编写应用程序时绕过了那些恼人的底层机制。简而言之，他是一个可以使应用程序直接控制终端屏幕显示的函数库。<br>1、yum安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install ncurses-devel</div></pre></td></tr></table></figure></p>
<p>注：如果报错，包找不到，是<em>通配符没有识别，给文件名加双引号  “ncurses</em>”</p>
<p>2、源代码编译:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">下载解压</div><div class="line">cd ncurses-5.9</div><div class="line">./configure --with-shared --without-debug --without-ada --enable-overwrite</div><div class="line">make</div><div class="line">make install</div></pre></td></tr></table></figure></p>
<ul>
<li>若不安装ncurses编译MySQL时会报错</li>
<li>–without-ada 参数为设定不编译为ada绑定，因进入chroot环境不能使用ada ；–enable-overwrite参数为定义把头文件安装到/tools/include下而不是/tools/include/ncurses目录</li>
<li>–with-shared 生成共享库</li>
</ul>
<h3 id="安装cmake和bison"><a href="#安装cmake和bison" class="headerlink" title="安装cmake和bison"></a>安装cmake和bison</h3><p>mysql在5.5以后，不再使用./configure工具，进行编译安装。而使用cmake工具替代了./configure工具。cmake的具体用法参考文档cmake说明。</p>
<p>bison是一个自由软件，用于自动生成语法分析器程序，可用于所有常见的操作系统<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">yum -y install cmake</div><div class="line">yum -y install bison</div></pre></td></tr></table></figure></p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>解压源码包<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">tar -zxvf mysql-5.7.15.tar.gz</div></pre></td></tr></table></figure></p>
<p>进入源码包目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cd mysql-5.7.15</div></pre></td></tr></table></figure></p>
<p>编译<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cmake  \</div><div class="line">-DDEFAULT_CHARSET=utf8 \</div><div class="line">-DDEFAULT_COLLATION=utf8_general_ci \</div><div class="line">-DWITH_INNOBASE_STORAGE_ENGINE=1 \</div><div class="line">-DENABLED_LOCAL_INFILE=1 \</div><div class="line">-DWITH_BOOST=/usr/local/boost</div></pre></td></tr></table></figure></p>
<p>Boost，是为C++语言标准库提供扩展的一些C++程序库的总称，，由Boost社区组织开发、维护。<br>最后一行配置，是配置boost库的，如果没有boost包，编译会报错。<br>如果之前没有安装过，可以单独安装，也可在mysql安装的时候直接下载安装，这样的话，最后一行配置修改如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-DDOWNLOAD_BOOST=1 -DWITH_BOOST=/usr/local/boost #直接下载并安装</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">make &amp;&amp; make install</div></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h3 id="创建MySQL运行用户和用户组"><a href="#创建MySQL运行用户和用户组" class="headerlink" title="创建MySQL运行用户和用户组"></a>创建MySQL运行用户和用户组</h3><p>查看mysql用户及用户组<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cat /etc/passwd     查看用户列表</div><div class="line">cat /etc/group      查看用户组列表</div></pre></td></tr></table></figure></p>
<p>如果没有就创建<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">groupadd mysql</div><div class="line">useradd -g mysql mysql</div></pre></td></tr></table></figure></p>
<p>修改/usr/local/mysql权限<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">chown -R mysql:mysql /usr/local/mysql</div></pre></td></tr></table></figure></p>
<p>初始化配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/mysql</div><div class="line">cp support-files/my-default.cnf /etc/my.cnf</div></pre></td></tr></table></figure></p>
<p>注：在启动MySQL服务时，会按照一定次序搜索my.cnf，先在/etc目录下找，找不到则会在安装目录下面找，在本例中就是 /usr/local/mysql/my.cnf，这是新版MySQL的配置文件的默认位置。</p>
<h3 id="初始化数据库并生成初始密码"><a href="#初始化数据库并生成初始密码" class="headerlink" title="初始化数据库并生成初始密码"></a>初始化数据库并生成初始密码</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/mysql/bin/mysqld --initialize --user=mysql</div></pre></td></tr></table></figure>
<p>会生成一个初始密码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># A temporary password is generated for root@localhost: -qeFRRlHV0jf</div></pre></td></tr></table></figure></p>
<p>密码：-qeFRRlHV0jf</p>
<h3 id="设置环境变量（使得mysql服务可以全局访问）"><a href="#设置环境变量（使得mysql服务可以全局访问）" class="headerlink" title="设置环境变量（使得mysql服务可以全局访问）"></a>设置环境变量（使得mysql服务可以全局访问）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">vi ~/.bash_profile</div></pre></td></tr></table></figure>
<p>在修改PATH=$PATH:$HOME/bin为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">PATH=$PATH:$HOME/bin:/usr/local/mysql/bin:/usr/local/mysql/lib</div></pre></td></tr></table></figure></p>
<p>重新加载环境变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@root ~]# source /root/.bash_profile</div></pre></td></tr></table></figure></p>
<h2 id="管理"><a href="#管理" class="headerlink" title="管理"></a>管理</h2><h3 id="启动mysql"><a href="#启动mysql" class="headerlink" title="启动mysql"></a>启动mysql</h3><p>方法一：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># 将mysql的启动服务添加到系统服务中</div><div class="line"># cp support-files/mysql.server /etc/init.d/mysql</div><div class="line"># service mysql start</div></pre></td></tr></table></figure></p>
<p>方法二：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/mysql/bin/mysqld_safe --user=mysql &amp;</div></pre></td></tr></table></figure></p>
<h3 id="设置开机自启动"><a href="#设置开机自启动" class="headerlink" title="设置开机自启动"></a>设置开机自启动</h3><p>方法一：</p>
<p>通过chkconfig实现。</p>
<p>方法二：直接修改 rc.local 文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &quot;/usr/local/mysql/bin/mysqld_safe --user=mysql &amp;&quot; &gt;&gt; /etc/rc.local</div></pre></td></tr></table></figure></p>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>登录并修改初始密码（不修改密码不让你操作，就是这么任性）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># mysql -uroot -hlocalhost -p</div><div class="line">Enter password:-qeFRRlHV0jf（初始密码）</div><div class="line"># mysql&gt; SET PASSWORD FOR &apos;root&apos;@&apos;localhost&apos; = PASSWORD(&apos;xxxxxxx&apos;);</div></pre></td></tr></table></figure></p>
<p>重新登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">#  mysql&gt; exit</div><div class="line">#  mysql -u root -p</div><div class="line">Enter password:</div></pre></td></tr></table></figure></p>
<p>能够登录进去，则说明MySQL安装成功。over~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160925/mysql_log.png&quot; alt=&quot;MySQL&quot;&gt;&lt;br&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
  </entry>
  
  <entry>
    <title>GIT使用小结</title>
    <link href="https://weizhimiao.github.io/2016/09/21/GIT%E4%BD%BF%E7%94%A8%E5%B0%8F%E7%BB%93/"/>
    <id>https://weizhimiao.github.io/2016/09/21/GIT使用小结/</id>
    <published>2016-09-21T15:30:00.000Z</published>
    <updated>2016-09-23T14:33:28.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>在使用之前先明确两个概念。</p>
<ul>
<li><p>工作区（working directory）</p>
<blockquote>
<p>我们创建的文件夹</p>
</blockquote>
</li>
<li><p>版本库（Repository）</p>
<blockquote>
<p>一个工作区中隐藏的目录（.git）这个目录不算工作区<br>版本库</p>
<ul>
<li>stage，暂存区</li>
<li>master，分支</li>
</ul>
<p>日常我们进行git add操作，是将文件修改添加到了暂存区，而进行git commit操作，则是将暂存区中的修改提交至当前分支。</p>
</blockquote>
</li>
</ul>
<a id="more"></a>
<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><ol>
<li><p>创建项目文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir demo</div></pre></td></tr></table></figure>
</li>
<li><p>进入项目目录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd demo</div><div class="line">git init（将该目录变成git可以管理的仓库（repository））</div></pre></td></tr></table></figure>
</li>
</ol>
<p>初始化后，该目录下会产生一个.git 的隐藏文件夹。</p>
<ol>
<li>添加文件到仓库<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git add 文件</div></pre></td></tr></table></figure>
</li>
</ol>
<p>添加一个文件到仓库。<br>其实，该操作作用是将文件添加至Stage暂存区。</p>
<p>  常用操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git add .   <span class="comment">#将所有文件添加至 stage</span></div><div class="line">git add -u  <span class="comment">#将所有文件添加至 stage ，同时将工作区中删除的文件也从仓库中删除。</span></div></pre></td></tr></table></figure></p>
<ol>
<li>git commit  提交到版本库<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git commit -m &quot;write readme file&quot;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>-m 为对本次版本提交的说明</p>
<ol>
<li><p>git status 查看当前版本库状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">$ mkdir git_<span class="built_in">test</span></div><div class="line">$ <span class="built_in">cd</span> git_<span class="built_in">test</span></div><div class="line">$ git init</div><div class="line"><span class="comment"># Initialized empty Git repository in /Users/zhimiao/WWW/hexo/git_test/.git/</span></div><div class="line">$ ll <span class="_">-a</span></div><div class="line"><span class="comment"># total 0</span></div><div class="line"><span class="comment"># drwxr-xr-x   3 zhimiao  staff   102B  9 23 10:25 .</span></div><div class="line"><span class="comment"># drwxr-xr-x   6 zhimiao  staff   204B  9 23 10:25 ..</span></div><div class="line"><span class="comment"># drwxr-xr-x  10 zhimiao  staff   340B  9 23 10:25 .git</span></div><div class="line">$ git status</div><div class="line"><span class="comment"># On branch master</span></div><div class="line"><span class="comment"># Initial commit</span></div><div class="line"><span class="comment"># nothing to commit (create/copy files and use "git add" to track)</span></div></pre></td></tr></table></figure>
<ul>
<li><p>git将所有的文件分为3类：已追踪的，被忽略的，和未追踪的。</p>
<ul>
<li>已追踪的（tracked）<blockquote>
<p>已追踪的文件是指已经在版本库中的文件，或者是已暂存到索引中的文件。即，一个文件通过执行git add，就会被添加到暂存区，该文件就变成一个已追踪的文件。</p>
</blockquote>
</li>
<li><p>被忽略的（ignored）</p>
<blockquote>
<p>被忽略的文件是指在版本库中被明确声明为不可见或者被忽略。一般通过在工作区新建 <code>.gitignore</code> 文件来来声明。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&gt; $ cat .gitignore</div><div class="line">.DS_Store</div><div class="line">Thumbs.db</div><div class="line">db.json</div><div class="line">*.log</div><div class="line">node_modules/</div><div class="line">public/</div><div class="line">.deploy*/</div><div class="line">&gt;</div></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>未追踪的（untracked）</p>
<blockquote>
<p>未追踪的文件是指那些不在前两类中的文件。git把工作目录下的所有文件当成一个集合，减去已经追踪的文件和忽略的文件，剩下的部分就作为未追踪的文件。</p>
</blockquote>
</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">$ echo &quot;git test&quot; &gt; readme.md</div><div class="line">$ git status</div><div class="line"># On branch master</div><div class="line"># Initial commit</div><div class="line"># Untracked files:</div><div class="line">#   (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</div><div class="line"># 	readme.md</div><div class="line"># nothing added to commit but untracked files present (use &quot;git add&quot; to track)</div><div class="line">$ git add readme.md</div><div class="line">$ git status</div><div class="line"># On branch master</div><div class="line"># Initial commit</div><div class="line"># Changes to be committed:</div><div class="line">#   (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</div><div class="line"># 	new file:   readme.md</div><div class="line">$ git commit -m &quot;add readme file&quot;</div><div class="line"># [master (root-commit) 81c90a0] add readme file</div><div class="line">#  1 file changed, 1 insertion(+)</div><div class="line">#  create mode 100644 readme.md</div><div class="line">$ git status</div><div class="line">#  On branch master</div><div class="line">#  nothing to commit, working directory clean</div></pre></td></tr></table></figure>
</li>
<li><p>git diff 显示当前尚未缓存的改动记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">$ echo &quot;Second Line &quot; &gt;&gt; readme.md</div><div class="line">$ git diff</div><div class="line"># diff --git a/readme.md b/readme.md</div><div class="line"># index f6edd6e..a1e649c 100644</div><div class="line"># --- a/readme.md</div><div class="line"># +++ b/readme.md</div><div class="line"># @@ -1 +1,2 @@</div><div class="line">#  git test</div><div class="line"># +add new Line</div></pre></td></tr></table></figure>
</li>
</ol>
<p>在开头，原始文件被『–』符号标记起来，新文件被用『+++』标记。@@ 之间表示两个不同文件版本的上下文行，以减号（-）开始的行表示从原始文件删除该行以得到新文件。相反，以加号（+）开始的行表示从原始文件中添加该行以产生新文件，而以空格开始的行则表示两个版本都有的行。</p>
<ol>
<li><p>git log 记录每次commit的信息</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">$ git add readme.md</div><div class="line">$ git commit -m &quot;update&quot;</div><div class="line">$ echo &quot;third Lines;&quot; &gt;&gt; readme.md</div><div class="line">$ git add readme.md</div><div class="line">$ git commit -m &quot;update third&quot;</div><div class="line">$ git log</div><div class="line"># commit 2ba4ebfe3ccef91f0d34646f5a0e50e339ee6f7a</div><div class="line"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class="line"># Date:   Fri Sep 23 11:21:24 2016 +0800</div><div class="line">#</div><div class="line">#     update third</div><div class="line">#</div><div class="line"># commit ed0fe412477c8ac828e450cbc319c06ac8db0445</div><div class="line"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class="line"># Date:   Fri Sep 23 11:19:34 2016 +0800</div><div class="line">#</div><div class="line">#     update</div><div class="line">#</div><div class="line"># commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c</div><div class="line"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class="line"># Date:   Fri Sep 23 10:42:58 2016 +0800</div><div class="line">#</div><div class="line">#     add readme file</div></pre></td></tr></table></figure>
</li>
<li><p>git reset 修改命令</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git reset HEAD    废除本次修改，回到上次提交的状态</div><div class="line">git reset -hard [commit id]</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$ git reset --hard HEAD^</div><div class="line"># HEAD is now at 7563423 update</div><div class="line">$ git log   </div><div class="line"># commit ed0fe412477c8ac828e450cbc319c06ac8db0445</div><div class="line"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class="line"># Date:   Fri Sep 23 11:19:34 2016 +0800</div><div class="line">#</div><div class="line">#     update</div><div class="line">#</div><div class="line"># commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c</div><div class="line"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class="line"># Date:   Fri Sep 23 10:42:58 2016 +0800</div><div class="line">#</div><div class="line">#     add readme file</div><div class="line">#</div><div class="line">$ cat readme.md</div><div class="line"># git test</div><div class="line"># Second Lines;</div></pre></td></tr></table></figure>
<p>然后我们就回到了上一次提交的版本。</p>
<ol>
<li>git rm 删除所有版本库记录（慎用）</li>
</ol>
<h2 id="从远程库克隆"><a href="#从远程库克隆" class="headerlink" title="从远程库克隆"></a>从远程库克隆</h2><p>git clone 克隆一个本地库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">$ git clone git@github.com:weizhimiao/git_test.git</div><div class="line"># Cloning into &apos;git_test&apos;...</div><div class="line"># remote: Counting objects: 3, done.</div><div class="line"># remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0</div><div class="line"># Receiving objects: 100% (3/3), done.</div><div class="line"># Checking connectivity... done.</div><div class="line">$ ll</div><div class="line"># drwxr-xr-x  4 zhimiao  staff   136B  9 23 21:53 git_test</div><div class="line">$ cd git_test</div><div class="line">$ ll</div><div class="line"># -rw-r--r--  1 zhimiao  staff    12B  9 23 21:53 README.md</div><div class="line">$ git status</div><div class="line"># On branch master</div><div class="line"># Your branch is up-to-date with &apos;origin/master&apos;.</div><div class="line"># nothing to commit, working directory clean</div></pre></td></tr></table></figure></p>
<h2 id="关联远程库"><a href="#关联远程库" class="headerlink" title="关联远程库"></a>关联远程库</h2><blockquote>
<p>本地仓库名：git_test<br>远程仓库名：git_test<br>在本地git_test仓库下执行</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git remote add origin git@github.com:weizhimiao/git_test.git</div></pre></td></tr></table></figure>
<blockquote>
<p>weizhimiao 是github账户名<br>origin 为远程仓库的名字，git的默认叫法</p>
</blockquote>
<p>将本地所有的内容推送到远程库上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git push -u origin master 把本地master分支推送到远程库</div><div class="line">-u 为把本地master 分支和远程master分支关联起来，之后就可以通过以下命令进行推送了</div><div class="line">git push origin master</div></pre></td></tr></table></figure></p>
<h2 id="分享与更新项目"><a href="#分享与更新项目" class="headerlink" title="分享与更新项目"></a>分享与更新项目</h2><ol>
<li>git push origin dev  提交到远程dev分支</li>
</ol>
<ol>
<li><p>git pull origin dev  拉取远程dev分支到本地并和本地dev分支合并</p>
</li>
<li><p>git remote add origin git@github.com:weizhimiao/git_test.git  将本地仓库推送至名为test的仓库里</p>
</li>
</ol>
<h2 id="分支管理"><a href="#分支管理" class="headerlink" title="分支管理"></a>分支管理</h2><p>创建：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">$ git branch dev</div><div class="line">$ git branch</div><div class="line">#   dev</div><div class="line"># * master</div><div class="line">$ git checkout dev</div><div class="line"># Switched to branch &apos;dev&apos;</div><div class="line">#</div><div class="line">$ git branch</div><div class="line"># * dev</div><div class="line">#   master</div></pre></td></tr></table></figure></p>
<blockquote>
<p>git branch dev 创建dev分支<br>git checkout dev  切换当前分支</p>
</blockquote>
<p>等价于<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout -b dev 创建并切换到dev分支</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># git branch 查看当前分支</div><div class="line"># git branch -a 查看本地和远程所有分支</div><div class="line"># git branch -r 常看远程分支</div><div class="line"># git branch -d 删除本地分支</div><div class="line"># git checkout master 用于dev分支完成工作后，切换回master 分支</div><div class="line">#</div><div class="line"># git merge 分支合并</div><div class="line"># 如当前分支是master，本地另一个分支是dev，用下面命令将dev合并到master分支</div><div class="line"># git merge dev</div></pre></td></tr></table></figure>
<h2 id="版本回退"><a href="#版本回退" class="headerlink" title="版本回退"></a>版本回退</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"># git log 查看历史纪录</div><div class="line">#</div><div class="line"># 回退到上一个版本</div><div class="line"># git reset -hard HEAD^</div><div class="line"># 或</div><div class="line"># git reset --hard [commit id]回退至指定版本号的版本</div><div class="line">#</div><div class="line">#</div><div class="line">#</div><div class="line"># git中</div><div class="line"># HEAD表示当前版本</div><div class="line"># HEAD^表示上一个版本</div><div class="line"># HEAD^^ 上上一个版本</div><div class="line"># HEAD~100 上100个版本</div><div class="line">#</div><div class="line"># git reflog 查看命令历史</div><div class="line"># 一般通过这个命令查看之前版本号</div><div class="line"># 例如：（前7个字符就是版本号的缩写）</div><div class="line">$ git reflog</div><div class="line">bb862b6 HEAD@&#123;0&#125;: merge dev: Fast-forward</div><div class="line">3223509 HEAD@&#123;1&#125;: checkout: moving from dev to master</div><div class="line">bb862b6 HEAD@&#123;2&#125;: commit: dev branch commint</div><div class="line">3223509 HEAD@&#123;3&#125;: checkout: moving from master to dev</div><div class="line">3223509 HEAD@&#123;4&#125;: checkout: moving from master to master</div><div class="line">3223509 HEAD@&#123;5&#125;: checkout: moving from dev to master</div><div class="line">3223509 HEAD@&#123;6&#125;: checkout: moving from master to dev</div><div class="line">3223509 HEAD@&#123;7&#125;: commit: add readme.md</div><div class="line">54906f2 HEAD@&#123;8&#125;: pull origin master: Merge made by the &apos;recursive&apos; strategy.</div><div class="line">7563423 HEAD@&#123;9&#125;: reset: moving to HEAD^</div><div class="line">7865e6f HEAD@&#123;10&#125;: commit: update third</div><div class="line">7563423 HEAD@&#123;11&#125;: commit: update</div><div class="line">81c90a0 HEAD@&#123;12&#125;: reset: moving to HEAD^</div><div class="line">ed0fe41 HEAD@&#123;13&#125;: reset: moving to HEAD^</div><div class="line">2ba4ebf HEAD@&#123;14&#125;: commit: update third</div><div class="line">ed0fe41 HEAD@&#123;15&#125;: commit: update</div><div class="line">81c90a0 HEAD@&#123;16&#125;: commit (initial): add readme file</div></pre></td></tr></table></figure>
<h2 id="管理修改"><a href="#管理修改" class="headerlink" title="管理修改"></a>管理修改</h2><blockquote>
<p>git diff HEAD – README.md</p>
</blockquote>
<p>查看工作区和版本库里最新版本的区别<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">$ git diff HEAD -- README.md</div><div class="line"># diff --git a/README.md b/README.md</div><div class="line"># index 9235721..62c0eaa 100644</div><div class="line"># --- a/README.md</div><div class="line"># +++ b/README.md</div><div class="line"># @@ -1 +1 @@</div><div class="line"># -First Line!</div><div class="line"># +branch dev line</div></pre></td></tr></table></figure></p>
<h2 id="撤销修改"><a href="#撤销修改" class="headerlink" title="撤销修改"></a>撤销修改</h2><ol>
<li><p>修改了工作区，想直接丢弃</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ git checkout -- filename</div></pre></td></tr></table></figure>
</li>
<li><p>修改了工作区内容，同事添加到了暂存区</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git reset HEAD filename</div><div class="line">$ git checkout -- filename</div></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="删除文件"><a href="#删除文件" class="headerlink" title="删除文件"></a>删除文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ git rm filename</div><div class="line">$ git commit 提交到版本库</div></pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;概念&quot;&gt;&lt;a href=&quot;#概念&quot; class=&quot;headerlink&quot; title=&quot;概念&quot;&gt;&lt;/a&gt;概念&lt;/h2&gt;&lt;p&gt;在使用之前先明确两个概念。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;p&gt;工作区（working directory）&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;我们创建的文件夹&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;版本库（Repository）&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;一个工作区中隐藏的目录（.git）这个目录不算工作区&lt;br&gt;版本库&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;stage，暂存区&lt;/li&gt;
&lt;li&gt;master，分支&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;日常我们进行git add操作，是将文件修改添加到了暂存区，而进行git commit操作，则是将暂存区中的修改提交至当前分支。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="软件工程" scheme="https://weizhimiao.github.io/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"/>
    
    
      <category term="git" scheme="https://weizhimiao.github.io/tags/git/"/>
    
      <category term="版本控制" scheme="https://weizhimiao.github.io/tags/%E7%89%88%E6%9C%AC%E6%8E%A7%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>Mac下包管理工具homebrew</title>
    <link href="https://weizhimiao.github.io/2016/09/20/Mac%E4%B8%8B%E5%8C%85%E7%AE%A1%E7%90%86%E5%B7%A5%E5%85%B7homebrew/"/>
    <id>https://weizhimiao.github.io/2016/09/20/Mac下包管理工具homebrew/</id>
    <published>2016-09-20T15:30:00.000Z</published>
    <updated>2016-09-20T15:09:18.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Homebrew"><a href="#Homebrew" class="headerlink" title="Homebrew"></a>Homebrew</h2><p>homebrew,一个在Mac OS上的软件包管理工具。是一款有Ruby开发的智能包管理系统.</p>
<p><a href="http://brew.sh" target="_blank" rel="external">官网地址</a></p>
<ul>
<li><p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/bin/ruby <span class="_">-e</span> <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></div></pre></td></tr></table></figure>
</li>
<li><p>功能：</p>
<blockquote>
<p>软件包管理。homebrew会将套件安装到独立目录，并将文件软连接链接到/usr/local</p>
</blockquote>
</li>
<li><p>命令格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ brew -h</div><div class="line">Example usage:</div><div class="line">  brew search [TEXT|/REGEX/]</div><div class="line">  brew (info|home|options) [FORMULA...]</div><div class="line">  brew install FORMULA...</div><div class="line">  brew update</div><div class="line">  brew upgrade [FORMULA...]</div><div class="line">  brew uninstall FORMULA...</div><div class="line">  brew list [FORMULA...]</div><div class="line">Troubleshooting:</div><div class="line">  brew config</div><div class="line">  brew doctor</div><div class="line">  brew install -vd FORMULA</div><div class="line">Brewing:</div><div class="line">  brew create [URL [--no-fetch]]</div><div class="line">  brew edit [FORMULA...]</div><div class="line">  https://github.com/Homebrew/brew/blob/master/share/doc/homebrew/Formula-Cookbook.md</div><div class="line">Further help:</div><div class="line">  man brew</div><div class="line">  brew help [COMMAND]</div><div class="line">  brew home</div></pre></td></tr></table></figure>
</li>
<li><p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ brew install wget</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="brew-cask"><a href="#brew-cask" class="headerlink" title="brew-cask"></a>brew-cask</h2><p>brew-cask,是一套建立在homebrew之上的Mac软件安装命令行工具。其与brew的区别是，后者侧重与软件套件和软件环境的配置安装。</p>
<p><a href="http://caskrom.github.io" target="_blank" rel="external">官网</a></p>
<ul>
<li><p>安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ brew install brew-cask</div></pre></td></tr></table></figure>
</li>
<li><p>命令格式</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">$ brew cask -h</div><div class="line">brew-cask provides a friendly homebrew-style CLI workflow for the</div><div class="line">administration of macOS applications distributed as binaries.</div><div class="line">Commands:</div><div class="line">    audit                  verifies installability of Casks</div><div class="line">    cat                    dump raw source of the given Cask to the standard output</div><div class="line">    cleanup                cleans up cached downloads and tracker symlinks</div><div class="line">    create                 creates the given Cask and opens it in an editor</div><div class="line">    doctor                 checks for configuration issues</div><div class="line">    edit                   edits the given Cask</div><div class="line">    fetch                  downloads remote application files to local cache</div><div class="line">    home                   opens the homepage of the given Cask</div><div class="line">    info                   displays information about the given Cask</div><div class="line">    install                installs the given Cask</div><div class="line">    list                   with no args, lists installed Casks; given installed Casks, lists staged files</div><div class="line">    search                 searches all known Casks</div><div class="line">    style                  checks Cask style using RuboCop</div><div class="line">    uninstall              uninstalls the given Cask</div><div class="line">    update                 a synonym for &apos;brew update&apos;</div><div class="line">    zap                    zaps all files associated with the given Cask</div><div class="line">See also &quot;man brew-cask&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>示例</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ brew cask install iterm2</div></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;Homebrew&quot;&gt;&lt;a href=&quot;#Homebrew&quot; class=&quot;headerlink&quot; title=&quot;Homebrew&quot;&gt;&lt;/a&gt;Homebrew&lt;/h2&gt;&lt;p&gt;homebrew,一个在Mac OS上的软件包管理工具。是一款有Ruby开发的智能包管理系统
    
    </summary>
    
      <category term="Mac" scheme="https://weizhimiao.github.io/categories/Mac/"/>
    
    
      <category term="Mac" scheme="https://weizhimiao.github.io/tags/Mac/"/>
    
      <category term="homebrew" scheme="https://weizhimiao.github.io/tags/homebrew/"/>
    
  </entry>
  
  <entry>
    <title>Schema数据类型优化</title>
    <link href="https://weizhimiao.github.io/2016/09/19/Schema%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E4%BC%98%E5%8C%96/"/>
    <id>https://weizhimiao.github.io/2016/09/19/Schema数据类型优化/</id>
    <published>2016-09-19T10:30:00.000Z</published>
    <updated>2016-09-20T14:35:05.000Z</updated>
    
    <content type="html"><![CDATA[<p>良好的数据路逻辑设计和物理设计是高性能的基石，所以要打造一个高性能的数据库服务，在Schema设计之初就应该需要权衡各种因素。</p>
<h2 id="选择最优化的数据类型"><a href="#选择最优化的数据类型" class="headerlink" title="选择最优化的数据类型"></a>选择最优化的数据类型</h2><p>数据库支持的数据类型非常多，选择一个正确的数据类型对于获得高性能至关重要。</p>
<p>选择合适数据类型的几个原则：</p>
<ol>
<li><p>更小的通常更好<br>一般情况下，应该尽量使用可以正确数据类型的最小数据类型。但也要确保没有低估需要存储的范围。</p>
</li>
<li><p>简单就好<br>简单的数据类型的操作通常需要更少的CPU周期。例如，</p>
</li>
</ol>
<ul>
<li>整型比字符串操作代价更低</li>
<li>使用MySQL内建的数据类型（比如，date、time、datetime），比用字符串更快</li>
<li>使用整型存储一个IP地址，比用一个字符串更好</li>
</ul>
<ol>
<li>尽量避免使用NULL<br>因为如果在查询中包含有NULL的列，对MySQL来说更难优化。所以通常情况下，最好指定列为 NOT NULL。</li>
</ol>
<p><strong>TIPS：</strong><br>datetime和timstamp列都可以存储相同类型的数据（时间和日期，都可以精确到秒），然而timestamp实际只使用datetime一般的存储空间。但另一方面，timestamp允许的时间范围要小的多。</p>
<a id="more"></a>
<h2 id="基本的数据类型"><a href="#基本的数据类型" class="headerlink" title="基本的数据类型"></a>基本的数据类型</h2><ol>
<li><p>数字</p>
<ol>
<li><p>整数</p>
<ul>
<li>TINYINT (8)</li>
<li>SMALLINT (16)</li>
<li>MEDIUMINT (24)</li>
<li>INT (32)</li>
<li>BIGINT (64)</li>
</ul>
<blockquote>
<p><strong>TIPS1:</strong> 整数类型有可选的 unsigned 属性，表示不允许有负值，如果将要使用的列不会出现负值的话，加上这个属性，将会可以使正数的上限增加一倍。</p>
<p><strong>TIPS2:</strong> int(1)与int(11)，对于存储和计算来说，这两者本质是没有区别的；两者只是在MySQL的一些交互工具中略有差别（比如，MySQL命令行客户端，用来控制显示字符的个数）。</p>
</blockquote>
</li>
<li><p>实数</p>
<ul>
<li><p>作用</p>
<blockquote>
<p>存储小数</p>
<p>存储比BIGINT更大的数</p>
</blockquote>
</li>
<li><p>float</p>
</li>
<li><p>double</p>
<blockquote>
<p>float 和 double支持使用标准的浮点运算进行近似的计算。</p>
</blockquote>
</li>
<li><p>decimal</p>
<blockquote>
<p>decimal 类型用于存储精确的小数，支持精确的计算。</p>
<p>由于CPU不支持对decimal的直接计算，所以对decimal的精确计算是由MySQL服务器自己来实现。</p>
<p><strong>Tips:</strong> 因为在进行精确计算时需要额外的空间和计算开销，所以尽量只对小数才使用decimal。比如，财务数据。另外如果数据量大的话，可以考虑使用bigint代替decimal，只需将存储的货币单位根据小数的位数乘以相应的倍数即可。</p>
</blockquote>
</li>
</ul>
</li>
</ol>
</li>
<li><p>字符串</p>
<ol>
<li><p>CHAR</p>
<blockquote>
<p>char 类型是定长的：MySQL是根据定义的字符串长度分配足够的空间。<br>char，适合存储很短的字符串，或者所有值的长度都差不多的的字符串。例如，密码的md5值。<br>另外，char还适合存储经常进行变更的值，相比于vachar，char类型很少会产生碎片。所以这一类的列，会比varchar更好。</p>
</blockquote>
</li>
<li><p>VARCHAR</p>
<blockquote>
<p>varchar 类型用于存储可变长的字符串。它只使用必要的空间，所以比定长类型更节省空间。</p>
<p>varchar,需要使用一个或者两个额外的字节来存储当前字符串的长度信息；如果列的长度小于或等于255个字节，则只需要一个字节表示，否则就需要两个字节来表示。</p>
<p>下面的这些情况适合使用varchar</p>
<ol>
<li>字符串列的长度比平均长度大很多</li>
<li>列的更新很少，所以碎片不是问题</li>
<li>使用了像UTF-8这样复杂的字符集，因为该字符集中每个字符可能使用不同的字节来进行存储</li>
</ol>
</blockquote>
<p><strong>Tips:</strong><br>用varchar(5)和varchar(200)来存储 「hello」有什么区别？</p>
<p>首先两者在存储空间的开销是一样的。<br>但是，一般的列在查询时会消耗更多的内存，因为在读到这些列时MySQL通常会分配固定大小的内存块来保存内部值。<br>尤其在使用内存临时表进行排序或者其他操作时，会特别的糟糕。<br>所以最好的策略就是，<strong>分配真正需要的空间</strong>。</p>
<p><strong>Tips：</strong><br>字符串长度定义不是字节数，而是字符数。两者概念是不同的，多字节字符集会需要更多的空间存储单个字符。</p>
</li>
</ol>
</li>
<li><p>BLOB和TEXT</p>
<blockquote>
<p>两者都是为存储很大的数据而设计的字符串数据类型，不同的是两者分别采用二进制和字符方式存储。</p>
<p>MySQL在处理两个类型的值时，处理基本相同，仅有的不同是BLOB类型是以二进制格式来存储的，所以没有排序规则和字符集，而text类型有排序规则和字符集。</p>
</blockquote>
</li>
<li><p>枚举（ENUM）</p>
<blockquote>
<p>枚举可以把一些不重复的字符串存储成一个预定义的集合。<br>MySQL会在存储枚举类型时粉肠紧凑，会根据列的值的数量压缩到一个或者两个字节中。<br>MySQL会在内部将每个值在列表中的位置保存成整数，而这些『数字–字符串』的对应关系，会保存在 .frm 文件中。<br>所以当该列需要新添加一个新的枚举值时，必须添加在之前枚举列表的最后面，否则就会出现数据错乱的问题。切记。</p>
</blockquote>
</li>
<li><p>日期和时间类型</p>
<ul>
<li><p>DATETIME</p>
<blockquote>
<p>该类型能保存大范围的值，从1001年到9999年，精度为秒。他会把时间封装到YYYYMMDDHHIISS的整数中，没有时区概念。使用8个字节的存储空间。</p>
</blockquote>
</li>
<li><p>TIMESTAMP</p>
<blockquote>
<p>该类型保存了从1970-01-01 00：00：00（格林威治时间）以来的秒数。该类型使用4个字节的存储空间，所以只能表示1970到2023年，其值还具有时区的概念。</p>
</blockquote>
</li>
</ul>
</li>
<li><p>位数据类型</p>
<blockquote>
<p>存储更紧凑。但所有这些位类型，不管底层存储格式和存储方式，从技术上来说都是字符串类型。虽然用它存储数据更紧凑，但是对于大部分应用来说，最好避免使用该类型。</p>
</blockquote>
<ul>
<li><p>BIT</p>
</li>
<li><p>SET</p>
</li>
</ul>
</li>
<li><p>特殊类型的数据</p>
<blockquote>
<p>某些数据的类型并不直接和内置的类型一致。所以需要一定的转换进行存储。</p>
</blockquote>
<ul>
<li><p>低于秒级的时间戳</p>
<blockquote>
<p>低于秒级的时间需要在引用层做处理，一般可以通过存储两个或者多个列来存储（一个存储秒级的时间戳，另外的存储秒级以下的）</p>
</blockquote>
</li>
<li><p>ipv4地址</p>
<blockquote>
<p>我们常见到有人会用 varchar(15)来存错一个IP地址，IP地址实际是一个32位的无符号整数，所以应该用无符号整数来存储IP地址。MySQL提供了 INET_ATON()和 INET_NTOA() 函数在这两表示方法之间转换。</p>
</blockquote>
</li>
</ul>
</li>
</ol>
<p>love over~<br>2016-09-19</p>
<iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="330" height="86" src="http://music.163.com/outchain/player?type=2&id=28947001&auto=1&height=66"></iframe>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;良好的数据路逻辑设计和物理设计是高性能的基石，所以要打造一个高性能的数据库服务，在Schema设计之初就应该需要权衡各种因素。&lt;/p&gt;
&lt;h2 id=&quot;选择最优化的数据类型&quot;&gt;&lt;a href=&quot;#选择最优化的数据类型&quot; class=&quot;headerlink&quot; title=&quot;选择最优化的数据类型&quot;&gt;&lt;/a&gt;选择最优化的数据类型&lt;/h2&gt;&lt;p&gt;数据库支持的数据类型非常多，选择一个正确的数据类型对于获得高性能至关重要。&lt;/p&gt;
&lt;p&gt;选择合适数据类型的几个原则：&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;p&gt;更小的通常更好&lt;br&gt;一般情况下，应该尽量使用可以正确数据类型的最小数据类型。但也要确保没有低估需要存储的范围。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;&lt;p&gt;简单就好&lt;br&gt;简单的数据类型的操作通常需要更少的CPU周期。例如，&lt;/p&gt;
&lt;/li&gt;
&lt;/ol&gt;
&lt;ul&gt;
&lt;li&gt;整型比字符串操作代价更低&lt;/li&gt;
&lt;li&gt;使用MySQL内建的数据类型（比如，date、time、datetime），比用字符串更快&lt;/li&gt;
&lt;li&gt;使用整型存储一个IP地址，比用一个字符串更好&lt;/li&gt;
&lt;/ul&gt;
&lt;ol&gt;
&lt;li&gt;尽量避免使用NULL&lt;br&gt;因为如果在查询中包含有NULL的列，对MySQL来说更难优化。所以通常情况下，最好指定列为 NOT NULL。&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;&lt;strong&gt;TIPS：&lt;/strong&gt;&lt;br&gt;datetime和timstamp列都可以存储相同类型的数据（时间和日期，都可以精确到秒），然而timestamp实际只使用datetime一般的存储空间。但另一方面，timestamp允许的时间范围要小的多。&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
      <category term="数据类型" scheme="https://weizhimiao.github.io/tags/%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B/"/>
    
  </entry>
  
  <entry>
    <title>MySQL存储引擎概述</title>
    <link href="https://weizhimiao.github.io/2016/09/17/MySQL%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E6%A6%82%E8%BF%B0/"/>
    <id>https://weizhimiao.github.io/2016/09/17/MySQL存储引擎概述/</id>
    <published>2016-09-17T15:00:00.000Z</published>
    <updated>2016-09-17T15:06:38.000Z</updated>
    
    <content type="html"><![CDATA[<p>基于存储引擎在MySQL架构中的地位，在学习和使用MySQL时我们需要对MySQL的各种存储引擎有一个大概的了解。<br>并且知道在实际项目中如何选择适合的存储引擎，以及如何实现不同存储引擎的相互切换。</p>
<a id="more"></a>
<h2 id="存储引擎分类"><a href="#存储引擎分类" class="headerlink" title="存储引擎分类"></a>存储引擎分类</h2><h3 id="InnoDB"><a href="#InnoDB" class="headerlink" title="InnoDB"></a>InnoDB</h3><p>InnoDB，是MySQL的默认事务型引擎，也是做重要、使用最广泛的存储引擎。它的性能和自动崩溃恢复特性，使得它在非事务行存储的需求中也很流行。所以除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。并且InnoDB作为事务型存储引擎，它通过一些机制和工具可以支持真正的热备份，而MySQL其他的存储引擎则不支持热备份。</p>
<h3 id="MyISAM"><a href="#MyISAM" class="headerlink" title="MyISAM"></a>MyISAM</h3><p>在MySQL 5.1 及之前的版本，MyISAM是MySQL默认的存储引擎。MyISAM提供大量的特性，包括全文索引、压缩、空间函数（GIS）等，但是MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是崩溃后无法安全恢复。尽管MyISAM不支持事务、不支持崩溃后的安全恢复，但是对于一些只读的数据，或者表比较小，可以忍受repair（修复）操作，则依然可以继续使用MyISAM。<strong>但请不要默认使用MyISAM，而是应当默认使用InnoDB</strong></p>
<h3 id="Archive"><a href="#Archive" class="headerlink" title="Archive"></a>Archive</h3><p>Archive 存储引擎只支持INSERT 和SELECT 操作，在MySQL 5.1之前还不支持索引。Archive会缓存所有的写并利用zlib对插入的行进行压缩，所以比MyISAM表的磁盘I/O更少。但是每次select操作都需要对全表进行扫描，所以Archive表适合日志和数据采集类应用，或者一些需要更快速insert操作的场合下使用。总之，MyISAM是一个针对告诉插入和压缩做了优化的简单引擎。</p>
<h3 id="Blackhole"><a href="#Blackhole" class="headerlink" title="Blackhole"></a>Blackhole</h3><p>Blackhole引擎没有实现任何的存储机制，他会丢弃所有的插入的数据，不做任何的保存。但是服务器会记录Blackhole表的日志，所以可以用于复制数据库到备库，或者只是简单地记录到日志。这种特殊的存储引擎可以在一些特殊的复制架构和日志审核时发挥所用。</p>
<h3 id="CSV"><a href="#CSV" class="headerlink" title="CSV"></a>CSV</h3><p>CSV引擎可以将普通的CSV文件作为MySQL的表来处理，但这种表不支持索引。CSV引擎可以在数据运行是拷入或者烤出文件。可以将Excel等电子表格中的数据存储为CSV文件，然后复制到MySQL数据目录下，然后就能在MySQL中打开使用。因此，CSV引擎可以作为一种数据交换的机制，非常有用。</p>
<h3 id="Federated"><a href="#Federated" class="headerlink" title="Federated"></a>Federated</h3><p>Federated引擎是访问其他MySQL服务器的一个代理，他会创建一个到远程MySQL服务器的的客户端连接，并将查询传输到远程服务器执行，然后提取或者发送需要的数据。但是尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题。因此默认是禁用的。</p>
<h3 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h3><p>Memory表所有的数据都保存在内存中，因此Memory表的访问速度非常的快（至少要比MyISAM快一个数量级），并且不需要磁盘的I/O操作。但是Memory表在系统重启后虽然表结构会保留，但是数据会丢失。</p>
<p>Memory表支持Hash索引，因此查询操作非常快。但是MySQL表采用的表级锁，因此并发写入的性能较低。</p>
<p>Memory表的应用场景：</p>
<ul>
<li>用于查找（lookup）或者映射（mapping）表。</li>
<li>用于缓存周期性聚合数据的结果。</li>
<li>用于保存数据分析中产生的中间问题。</li>
</ul>
<p><strong>Tips：</strong><br>如果MySQL在执行查询的过程中需要使用临时表来保存中间结果，内部使用的临时表就是Memory表。如果中间结果大大超出了Memory表的限制，或者有大量的BLOB或TEXT字段，则临时表会转换成MyISAM表。</p>
<h3 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h3><p>Merge引擎是MyISAM的一种变种。Merge表是由多个MyISAM表合并而来的虚拟表。</p>
<h3 id="NDB"><a href="#NDB" class="headerlink" title="NDB"></a>NDB</h3><p>MySQL服务器、NDB集群引擎、以及分布式的、share-nothing的、容灾的、高可用的NDB数据库组合，被称之为MySQL集群（MySQL Cluster）。</p>
<h3 id="其他的第三方存储引擎"><a href="#其他的第三方存储引擎" class="headerlink" title="其他的第三方存储引擎"></a>其他的第三方存储引擎</h3><p>MySQL从07年开始提供了插件式的存储引擎API，从此出现了一系列为不同目的而设计的存储引擎。其中一些已经合并到MySQL服务器，但大多数还是第三方产品或者开源项目。比较有名的有：</p>
<ul>
<li>OLTP类引擎</li>
<li>面向列的存储引擎</li>
<li>社区存储引擎</li>
</ul>
<h2 id="选择合适的存储引擎的考虑因素"><a href="#选择合适的存储引擎的考虑因素" class="headerlink" title="选择合适的存储引擎的考虑因素"></a>选择合适的存储引擎的考虑因素</h2><p>不同的应用可能会根据不同的需求而采用不同的存储引擎。那么我们再为应用选择存储引擎时，通常会考虑以下几点：</p>
<ul>
<li><p>事务<br>引用是否需要事务支持。如果需要，那么InnoDB是目前最稳定且经过验证的选择。如果不需要，并且主要是select和insert操作，那么MyISAM是不错的选择。</p>
</li>
<li><p>备份<br>如果可以定期的通过关闭服务器来执行备份，那么备份因素就可以忽略。反之，如果需要支持在线热备份，那么选择InnoDB就是基本的要求。</p>
</li>
<li><p>崩溃恢复<br>相对而言，MyISAM崩溃后发生的数据毁坏的概率要比InnoDB高的多，并且恢复速度也要慢的多。所以，即使不需要事务支持，很多人也会选择InnoDB引擎。</p>
</li>
<li><p>特有的特性<br>有些应用可能需要一些存储引擎锁独有的特性或者优化，比如依赖聚簇索引的优化，或者需要对地理空间的搜索。</p>
</li>
</ul>
<p><strong>总之，如无特殊的需求和例外，统统建议选择InnoDB存储引擎。</strong></p>
<h2 id="如何转换表的存储引擎"><a href="#如何转换表的存储引擎" class="headerlink" title="如何转换表的存储引擎"></a>如何转换表的存储引擎</h2><p>有很多中方法可以转换，一般我们会使用以下三种方法：</p>
<h3 id="ALTER-TABLE"><a href="#ALTER-TABLE" class="headerlink" title="ALTER TABLE"></a>ALTER TABLE</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysql&gt;alter table mytable engine=innodb;</div></pre></td></tr></table></figure>
<p>上述语法可以适应与任何存储引擎。但是当表数据很大时，这种方法将会执行很长时间。MySQL会按行将数据从原表复制到一张新的表中。所以，在繁忙的表上执行此操作要非常小心。</p>
<h3 id="导入-导出"><a href="#导入-导出" class="headerlink" title="导入/导出"></a>导入/导出</h3><p>使用mysqldump工具将数据到出到文件，然后修改文件中create table 语句中的存储引擎的选项，（同时注意修改表名，避免在导入的时候将原表删除，造成数据丢失）。然后导入文件到数据库，这样就得到了一个原表的一个全量复制表。</p>
<h3 id="创建与查询"><a href="#创建与查询" class="headerlink" title="创建与查询"></a>创建与查询</h3><p>综合第一种方法的高效和第二种的安全。不需要导出整张表的数据，而是先创建一个新的存储引擎的表，然后利用 insert…select语法来导数据。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt;create table innodb_table like myisam_table;</div><div class="line">mysql&gt;alter table innodb_table engine=innodb;</div><div class="line">mysql&gt;insert into innodb_table select * from myisam_table;</div></pre></td></tr></table></figure></p>
<p>如果数据量大的话，可以考虑分批处理，并使用事务进行提交操作；<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mysql&gt;start transaction;</div><div class="line">mysql&gt;insert into innodb_table select * from myisam_table where id between x and y;</div><div class="line">mysql&gt;commit;</div></pre></td></tr></table></figure></p>
<p>如果有必要，在操作的时候可以对原表加锁，以确保新表和原表数据一致。<br>这样操作之后也会得到一个对原表的全量复制的表，如果需要还可以删除原表。</p>
<p><strong>Tips：</strong><br>Persona Toolkit 提供了一个 pt-online-schema-change的工具（基于Facebook的在线变更技术），可以比较简单、方便的执行上述过程，避免收工操作可能会带来的错误是繁琐。。。。。。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;基于存储引擎在MySQL架构中的地位，在学习和使用MySQL时我们需要对MySQL的各种存储引擎有一个大概的了解。&lt;br&gt;并且知道在实际项目中如何选择适合的存储引擎，以及如何实现不同存储引擎的相互切换。&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
      <category term="存储引擎" scheme="https://weizhimiao.github.io/tags/%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E/"/>
    
  </entry>
  
  <entry>
    <title>如何查看表的相关信息</title>
    <link href="https://weizhimiao.github.io/2016/09/17/MySQL%E5%A6%82%E4%BD%95%E6%9F%A5%E7%9C%8B%E8%A1%A8%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BF%A1%E6%81%AF/"/>
    <id>https://weizhimiao.github.io/2016/09/17/MySQL如何查看表的相关信息/</id>
    <published>2016-09-17T14:00:00.000Z</published>
    <updated>2016-09-17T08:42:49.000Z</updated>
    
    <content type="html"><![CDATA[<p>在文件系统中，MySQL将每个数据库（也被称为schema）保存为数据目录下的一个子目录。在创建表的时候，MySQL会在数据库子目录下创建一个和表同名的 .frm 文件对表的定义。例如，创建一个名为 mytable 的表，MySQL会在 mytable.frm 文件中保存对该表的定义。</p>
<p>通常，我们可以使用 show table status 命令来显示表的相关信息。（MySQL 5.0 + 的版本，也可以查看 INFOMATION_SCHEMA 中对应的表的信息）。<br>例如，对于MySQL数据库中的 user 表：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">mysql&gt; show table status like 'user' \G;</div><div class="line">*************************** 1. row ***************************</div><div class="line">           Name: user</div><div class="line">         Engine: MyISAM</div><div class="line">        Version: 10</div><div class="line">     Row_format: Dynamic</div><div class="line">           Rows: 14</div><div class="line"> Avg_row_length: 63</div><div class="line">    Data_length: 952</div><div class="line">Max_data_length: 281474976710655</div><div class="line">   Index_length: 2048</div><div class="line">      Data_free: 64</div><div class="line"> Auto_increment: NULL</div><div class="line">    Create_time: 2012-12-25 14:23:08</div><div class="line">    Update_time: 2015-08-11 11:17:42</div><div class="line">     Check_time: NULL</div><div class="line">      Collation: utf8_bin</div><div class="line">       Checksum: NULL</div><div class="line"> Create_options:</div><div class="line">        Comment: Users and global privileges</div><div class="line">1 row in set (0.01 sec)</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>下面简单介绍一下每行的含义：</p>
<ul>
<li><p>Name</p>
<blockquote>
<p>表名。</p>
</blockquote>
</li>
<li><p>Engine</p>
<blockquote>
<p>表的存储引擎。</p>
</blockquote>
</li>
<li><p>Row_format</p>
<blockquote>
<p>行的格式，对于MyISAM表，可选的值为Dynamic、Fixed、Compressed。</p>
<ul>
<li>Dynamic，表示行的长度是可变的，一般包含可变长度的字段，如varchar、blob等。</li>
<li>Fixed，行的长度是固定的，只包含固定长短的列。</li>
<li>Compressed，只在压缩表中出现，表示是被压缩的。</li>
</ul>
</blockquote>
</li>
<li><p>Rrows</p>
<blockquote>
<p>表中行数，对于MyISAM和其他的一些存储引擎该值是精确的，但对于InnoDB该值只是一个大概值。</p>
</blockquote>
</li>
<li><p>Avg_row_length</p>
<blockquote>
<p>平均每行包含的字节数</p>
</blockquote>
</li>
<li><p>Data_length</p>
<blockquote>
<p>表数据的大小(单位：字节)</p>
</blockquote>
</li>
<li><p>Max_data_length</p>
<blockquote>
<p>表数据的最大容量，该值和存储引擎有关。</p>
</blockquote>
</li>
<li><p>Index_length</p>
<blockquote>
<p>索引的大小(单位：字节)</p>
</blockquote>
</li>
<li><p>Data_free</p>
<blockquote>
<p>对于MyISAM表示已经分配但是目前没有被使用的空间。这部分空间包括之前删除的行，以及后续可以被Insert利用的行。</p>
</blockquote>
</li>
<li><p>Auto_increment</p>
<blockquote>
<p>下一个Auto_increment的值。</p>
</blockquote>
</li>
<li><p>Create_time</p>
<blockquote>
<p>表的创建时间。</p>
</blockquote>
</li>
<li><p>Update_time</p>
<blockquote>
<p>表数据的最后修改时间。</p>
</blockquote>
</li>
<li><p>Check_time</p>
<blockquote>
<p>使用check table命令或者muisamchk 工具最后一次检查表的时间。</p>
</blockquote>
</li>
<li><p>Collation</p>
<blockquote>
<p>表的默认字符集和字符列排序规则。</p>
</blockquote>
</li>
<li><p>Checksum</p>
<blockquote>
<p>如果启用，保存的是整个表的实时校验和。</p>
</blockquote>
</li>
<li><p>Create_options</p>
<blockquote>
<p>创建表时指定的其他选项。</p>
</blockquote>
</li>
<li><p>Comment</p>
<blockquote>
<p>该列包含了一些其他的额外信息。对于MyISAM表，保存的是在表创建的时候附带的注释。对于InnoDB表，该值保存的是InnoDB表空间的剩余空间信息。如果是一个视图，该列将会包含『VIEW』字样。</p>
</blockquote>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;在文件系统中，MySQL将每个数据库（也被称为schema）保存为数据目录下的一个子目录。在创建表的时候，MySQL会在数据库子目录下创建一个和表同名的 .frm 文件对表的定义。例如，创建一个名为 mytable 的表，MySQL会在 mytable.frm 文件中保存对该表的定义。&lt;/p&gt;
&lt;p&gt;通常，我们可以使用 show table status 命令来显示表的相关信息。（MySQL 5.0 + 的版本，也可以查看 INFOMATION_SCHEMA 中对应的表的信息）。&lt;br&gt;例如，对于MySQL数据库中的 user 表：&lt;br&gt;&lt;figure class=&quot;highlight&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;1&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;2&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;3&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;4&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;5&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;6&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;7&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;8&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;9&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;11&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;12&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;13&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;15&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;16&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;17&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;18&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;19&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;20&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;21&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;div class=&quot;line&quot;&gt;mysql&amp;gt; show table status like &#39;user&#39; \G;&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;*************************** 1. row ***************************&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           Name: user&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;         Engine: MyISAM&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Version: 10&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Row_format: Dynamic&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;           Rows: 14&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Avg_row_length: 63&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Data_length: 952&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;Max_data_length: 281474976710655&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;   Index_length: 2048&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      Data_free: 64&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Auto_increment: NULL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Create_time: 2012-12-25 14:23:08&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;    Update_time: 2015-08-11 11:17:42&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;     Check_time: NULL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;      Collation: utf8_bin&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;       Checksum: NULL&lt;/div&gt;&lt;div class=&quot;line&quot;&gt; Create_options:&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;        Comment: Users and global privileges&lt;/div&gt;&lt;div class=&quot;line&quot;&gt;1 row in set (0.01 sec)&lt;/div&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
  </entry>
  
  <entry>
    <title>MVCC多版本并发控制</title>
    <link href="https://weizhimiao.github.io/2016/09/17/MVCC-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E6%95%B4%E7%90%86/"/>
    <id>https://weizhimiao.github.io/2016/09/17/MVCC-多版本并发控制整理/</id>
    <published>2016-09-16T17:00:00.000Z</published>
    <updated>2016-09-17T05:17:55.000Z</updated>
    
    <content type="html"><![CDATA[<p>MySQL中大多数事务型的存储引擎都不是简单的行级锁。为了提高并发性，他们一般会采用多版本并发控制（MVCC，一种行级锁的变种）来使很多情况下在避免加锁的情况下就实现并发操作，从而是的系统开销更低。</p>
<p>MySQL的InnoDB存储引擎的MCVV，是通过在每行记录后面保存两个隐藏的列来实现。一个保存行的创建时间，另一个保存过期时间。当然这里所说的时间并不是实际时间，是系统版本号。数据库系统在每开始一个事务，其系统版本号就会自动递增。一个事务开始时刻，事务会去当前的系统版本号作为当前事务的事务版本号，用来和查询到的每行记录的版本号做比较。</p>
<table>
<thead>
<tr>
<th>id</th>
<th>fields …</th>
<th>create_version</th>
<th>delete_version</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>….</td>
<td>1</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td>….</td>
<td>2</td>
<td>3</td>
</tr>
</tbody>
</table>
<a id="more"></a>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><p>Repeatable read 隔离级别下，MVCC具体操作：</p>
<h3 id="Select-操作："><a href="#Select-操作：" class="headerlink" title="Select 操作："></a>Select 操作：</h3><p>a. InnoDB 只查找版本号小于当前事务版本号的行（即，行的系统版本号小于或者等于当前事务的系统版本号），以确保当前事务读取到的行，要么是当前事务开始之前就已经存在的行，要么就是当前事务插入或者修改过的行。<br>b. 行的删除版本号要么未定义，要么大于当前事务的版本号。这样可以确保当前事务读取到行，在事务开始之前为被删除。</p>
<p>只有同事符合上述两个条件的记录，才能被作为查询结果被返回。</p>
<h3 id="Insert-操作："><a href="#Insert-操作：" class="headerlink" title="Insert 操作："></a>Insert 操作：</h3><p>InnoDB为新插入的行保存当前事务的版本号作为行版本号。</p>
<h3 id="Delete-操作："><a href="#Delete-操作：" class="headerlink" title="Delete 操作："></a>Delete 操作：</h3><p>InnoDB为删除的每一行记录保存当前的事务版本号作为行删除标识。</p>
<h3 id="Update-操作："><a href="#Update-操作：" class="headerlink" title="Update 操作："></a>Update 操作：</h3><p>InnoDB会插入一条新纪录，保存当前事务版本号作为改行的行版本号，同事保存当前的事务版本号到原来的行作为行删除标识版本号。</p>
<h2 id="多版本并发控制优缺点"><a href="#多版本并发控制优缺点" class="headerlink" title="多版本并发控制优缺点"></a>多版本并发控制优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>通过两个额外的版本号，能使大多数读操作都可以不用加锁，从而使得查询性能更好。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>每行记录多需要做存储两个版本号，需要浪费额外的存储空间。</p>
<p><strong>TIPS:</strong><br>MVCC，只在Repeatable read 和read committed两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为 read uncommitted总是读取最新的行，而不是符合当前事务版本号的行，而 serializable 则会对所有读取的行都会加锁。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;MySQL中大多数事务型的存储引擎都不是简单的行级锁。为了提高并发性，他们一般会采用多版本并发控制（MVCC，一种行级锁的变种）来使很多情况下在避免加锁的情况下就实现并发操作，从而是的系统开销更低。&lt;/p&gt;
&lt;p&gt;MySQL的InnoDB存储引擎的MCVV，是通过在每行记录后面保存两个隐藏的列来实现。一个保存行的创建时间，另一个保存过期时间。当然这里所说的时间并不是实际时间，是系统版本号。数据库系统在每开始一个事务，其系统版本号就会自动递增。一个事务开始时刻，事务会去当前的系统版本号作为当前事务的事务版本号，用来和查询到的每行记录的版本号做比较。&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;id&lt;/th&gt;
&lt;th&gt;fields …&lt;/th&gt;
&lt;th&gt;create_version&lt;/th&gt;
&lt;th&gt;delete_version&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;
&lt;tr&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;….&lt;/td&gt;
&lt;td&gt;1&lt;/td&gt;
&lt;td&gt;&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;….&lt;/td&gt;
&lt;td&gt;2&lt;/td&gt;
&lt;td&gt;3&lt;/td&gt;
&lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
      <category term="MVCC" scheme="https://weizhimiao.github.io/tags/MVCC/"/>
    
      <category term="多版本并发控制" scheme="https://weizhimiao.github.io/tags/%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>事务的ACID概念</title>
    <link href="https://weizhimiao.github.io/2016/09/17/%E4%BA%8B%E5%8A%A1%E7%9A%84ACID%E6%A6%82%E5%BF%B5/"/>
    <id>https://weizhimiao.github.io/2016/09/17/事务的ACID概念/</id>
    <published>2016-09-16T16:00:00.000Z</published>
    <updated>2016-09-16T17:54:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>数据库中的事务就是一组原子行的SQL查询，或者说一个独立的工作但愿。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。</p>
<p>ACID表示原子性（atomicity）、一致性（consistency）、隔离行（isolation）和持久性（durability）。一个运行良好的事务处理系统，必须具备这些特征。</p>
<blockquote>
<p>一个实现了ACID的数据库，相比于没有实现ACID的数据库，通常需要更强的CPU，更大的内存，更多的存储空间。所以对于一些不需要事务支持的查询类型应用，选择一个非事务型的存储引擎，是可以获得更高的性能的。</p>
</blockquote>
<a id="more"></a>
<h2 id="事务ACID的概念"><a href="#事务ACID的概念" class="headerlink" title="事务ACID的概念"></a>事务ACID的概念</h2><ul>
<li><p>A,automicity 原子性</p>
<blockquote>
<p>即，一个不可分割的最小单元。</p>
</blockquote>
</li>
<li><p>C,consistency 一致性</p>
<blockquote>
<p>总是从一种状态到另一种状态，没有第三种状态。</p>
</blockquote>
</li>
<li><p>I,isolation 隔离性</p>
<blockquote>
<p>一个事务再提交之前，对其他事务是不可见的。即不同的事务之间相互之间不影响。</p>
</blockquote>
</li>
<li><p>D,durability 持久性</p>
<blockquote>
<p>事务一旦提交，就会永久生效。</p>
</blockquote>
</li>
</ul>
<h2 id="隔离级别"><a href="#隔离级别" class="headerlink" title="隔离级别"></a>隔离级别</h2><p>隔离级别，规定一个事务中所做的修改，哪些是在事务内和事务间是可见的，哪些是不可见的。<br>一般，较低隔离级别的隔离可以支持更高的并发，系统的开销会更低。</p>
<h3 id="隔离要解决的问题"><a href="#隔离要解决的问题" class="headerlink" title="隔离要解决的问题"></a>隔离要解决的问题</h3><ul>
<li><p>脏读，Dirty read</p>
<blockquote>
<p>即其他事务可以读取到当前事务未提交的数据。</p>
</blockquote>
</li>
<li><p>不可重复读，nonrepeatable read</p>
<blockquote>
<p>即两次执行同样的查询，得到的结果可能是不一样的。</p>
</blockquote>
</li>
<li><p>幻读，Phantom read</p>
<blockquote>
<p>某一个事务在取一范围记录时，另一事务又在该范围插入了新纪录，当之前事务再读取该范围是，就会产生幻读。</p>
</blockquote>
</li>
</ul>
<h3 id="不同的隔离划分"><a href="#不同的隔离划分" class="headerlink" title="不同的隔离划分"></a>不同的隔离划分</h3><table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读可能性</th>
<th>幻读</th>
<th>加锁读</th>
</tr>
</thead>
<tbody>
<tr>
<td>read uncommitted</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
<td>Y</td>
</tr>
<tr>
<td>read committed</td>
<td>N</td>
<td>Y</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>repeatable read</td>
<td>N</td>
<td>N</td>
<td>Y</td>
<td>N</td>
</tr>
<tr>
<td>serializable</td>
<td>N</td>
<td>N</td>
<td>N</td>
<td>Y</td>
</tr>
</tbody>
</table>
<ul>
<li><p>Read uncommitted（未提交读）</p>
<blockquote>
<p>在这个级别下，事务中的修改，即使在没有提交的情况下，其他的事务也是可见的。<br>所以，除非有非常必要的理由，在实际应用中一般很少使用。</p>
</blockquote>
</li>
<li><p>Read committed（提交读）</p>
<blockquote>
<p>read committed隔离级别满足前面提到的隔离性的定义。即一个事务开始时，只能看见已经提交的事务所做的修改。换句话说，一个事务从开始到提交之前，所做的任何修改对其他的事务都是不可见的。<br><strong>大多数的数据库系统的默认隔离级别都是这个级别</strong><br>但这个级别有时候会出现不可重复读的现象，即执行两次同样的查询可能会得到两个不同的结果。</p>
</blockquote>
</li>
<li><p>repeatable read（可重复读）</p>
<blockquote>
<p>该级别解决了脏读的问题，而且保证了在同一个事务中多次读取同一条记录的结果是一致的。<br><strong>该级别是MySQL的默认事务级别</strong><br>但是理论上，该级别下会出现另一个幻读的问题。<br>MySQL的InnoDB通过多版本并发控制（MVCC）来解决了该级别下出现幻读的可能性问题。</p>
</blockquote>
</li>
<li><p>serializable（可串行化）</p>
<blockquote>
<p>该级别为最高的隔离级别。他通过强制事务串行执行，避免了前面 repeatable read 级别下可能会出现幻读的情况。简单说，就是serializable会在读取的每行数据上都加锁。所以会导致大量的超时和锁争用的情况。故实际应用中该级别也很少用到。</p>
</blockquote>
</li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;数据库中的事务就是一组原子行的SQL查询，或者说一个独立的工作但愿。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。&lt;/p&gt;
&lt;p&gt;ACID表示原子性（atomicity）、一致性（consistency）、隔离行（isolation）和持久性（durability）。一个运行良好的事务处理系统，必须具备这些特征。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;一个实现了ACID的数据库，相比于没有实现ACID的数据库，通常需要更强的CPU，更大的内存，更多的存储空间。所以对于一些不需要事务支持的查询类型应用，选择一个非事务型的存储引擎，是可以获得更高的性能的。&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
      <category term="事务" scheme="https://weizhimiao.github.io/tags/%E4%BA%8B%E5%8A%A1/"/>
    
      <category term="ACID" scheme="https://weizhimiao.github.io/tags/ACID/"/>
    
  </entry>
  
  <entry>
    <title>MySQL并发控制整理</title>
    <link href="https://weizhimiao.github.io/2016/09/16/MySQL%E7%9A%84%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6%E6%95%B4%E7%90%86/"/>
    <id>https://weizhimiao.github.io/2016/09/16/MySQL的并发控制整理/</id>
    <published>2016-09-16T13:00:00.000Z</published>
    <updated>2016-09-16T18:06:35.000Z</updated>
    
    <content type="html"><![CDATA[<p>根据控制的不同层次，MySQL的并发控制可以分为：</p>
<ul>
<li>服务器层</li>
<li>存储引擎层</li>
</ul>
<p>实现并发控制的方法策略：<strong><em>锁机制</em></strong></p>
<ul>
<li>共享锁（shared lock）&lt;======&gt; 读锁（read lock）</li>
<li>排它锁（exclusive lock） &lt;======&gt; 写锁（write lock）</li>
</ul>
<p>如何选择适合的锁？<strong><em>锁策略</em></strong></p>
<ul>
<li>锁的粒度越小，系统的并发性越高</li>
<li>所得操作越多，系统的开销越大<blockquote>
<p>所以所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡。</p>
</blockquote>
</li>
</ul>
<a id="more"></a>
<h2 id="MySQL中锁策略类型"><a href="#MySQL中锁策略类型" class="headerlink" title="MySQL中锁策略类型"></a>MySQL中锁策略类型</h2><p>MySQL不同的存储引擎中用到的锁策略基本有两种。一种是表级锁，另一种是行级锁。</p>
<ul>
<li><p>表锁，一种开销最小的锁策略。</p>
<blockquote>
<p>一个用户对表进行写操作时，需要先获得写锁，这是其他用户读该表进行的读写操作都会进行阻塞。只有当前写操作被释放之后，其他人才能活的读锁。当当前表有读锁时，其他人也可以继续获得读锁。读锁是共享性的不同的读锁之间是互相不阻塞的。<br>另外，写锁的优先级高于读锁。所以当有多个锁请求存在是，读锁的请求会被优先插入到锁队列的前边。</p>
</blockquote>
</li>
<li><p>行锁，最大程度支持并发处理，同时也是锁开销最大的锁策略。</p>
<blockquote>
<p>顾名思义，行级锁只在将要修改的记录行上进行锁操作，对其他的行的操作没有影响。</p>
</blockquote>
</li>
</ul>
<p>尽管我们一般提到的锁，都处于存储引擎这一层，但是MySQL本身在某些情况下，也会对锁策略进行控制。比如表的alter table操作，会对表本身使用表锁，而直接忽略存储引擎的锁机制。</p>
<h2 id="MySQL中死锁问题解决方法"><a href="#MySQL中死锁问题解决方法" class="headerlink" title="MySQL中死锁问题解决方法"></a>MySQL中死锁问题解决方法</h2><blockquote>
<p>死锁，即两个或者多个事务在同一资源上相互占用，并请求占用对方已经占用的资源的情况。</p>
</blockquote>
<p>既然有锁存在，当然就会有死锁的情况发生。那么MySQL中是如何处理死锁问题的呢？<br>死锁的通常解决方案有两种，即：</p>
<ul>
<li>死锁检测机制</li>
<li>超时机制</li>
</ul>
<p>InnoDB存储引擎在检测到有死锁发生的处理方法是，将当前持有最少的行级锁的事务进行回滚。待打破死锁后，重新执行因为死锁而回滚的事务。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;根据控制的不同层次，MySQL的并发控制可以分为：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;服务器层&lt;/li&gt;
&lt;li&gt;存储引擎层&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;实现并发控制的方法策略：&lt;strong&gt;&lt;em&gt;锁机制&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;共享锁（shared lock）&amp;lt;======&amp;gt; 读锁（read lock）&lt;/li&gt;
&lt;li&gt;排它锁（exclusive lock） &amp;lt;======&amp;gt; 写锁（write lock）&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;如何选择适合的锁？&lt;strong&gt;&lt;em&gt;锁策略&lt;/em&gt;&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;锁的粒度越小，系统的并发性越高&lt;/li&gt;
&lt;li&gt;所得操作越多，系统的开销越大&lt;blockquote&gt;
&lt;p&gt;所以所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
      <category term="并发控制" scheme="https://weizhimiao.github.io/tags/%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/"/>
    
  </entry>
  
  <entry>
    <title>MySQL逻辑架构设计</title>
    <link href="https://weizhimiao.github.io/2016/09/16/MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84%E5%AE%9E%E7%8E%B0%E5%B0%8F%E7%BB%93/"/>
    <id>https://weizhimiao.github.io/2016/09/16/MySQL逻辑架构实现小结/</id>
    <published>2016-09-16T12:00:00.000Z</published>
    <updated>2016-09-16T08:42:10.000Z</updated>
    
    <content type="html"><![CDATA[<p>通常MySQL架构有两种划分，一种划为两层架构，另一种划为三层。<br>两层架构划为MySQL服务器层和存储引擎层，三层架构则把MySQL层又划为两层。</p>
<p><img src="http://n.sinaimg.cn/games/3ece443e/20160916/MySQLJiaGouTu1.png" alt="MySQL架构图"></p>
<a id="more"></a>
<h2 id="三层架构说明"><a href="#三层架构说明" class="headerlink" title="三层架构说明"></a>三层架构说明</h2><ul>
<li><p>第一层，用于连接处理、授权认证、安全认证等等。大多数基于客户端/服务器端的工具或者服务器都有类似架构。</p>
</li>
<li><p>第二层，是MySQL架构的核心部分。MySQL的大部分核心服务功能大都在这一层。包括查询解析、分析、优化、缓存以及所有的内置函数的实现，还有所有的跨存储引擎的功能都在这一层实现：存储过程、触发器、试图等。</p>
</li>
<li><p>第三层，存储引擎层。存储引擎负责MySQL中数据的存储和读取。每个存储引擎都有自己的优势和劣势。MySQL服务器层通过API与存储引擎进行通信。存储引擎本身是不会解析SQL，且不同的存储引擎之间也是不会相互通信。</p>
</li>
</ul>
<h2 id="MySQL服务器接收-处理一个查询请求的过程"><a href="#MySQL服务器接收-处理一个查询请求的过程" class="headerlink" title="MySQL服务器接收/处理一个查询请求的过程"></a>MySQL服务器接收/处理一个查询请求的过程</h2><ol>
<li><p>当MySQL服务器接收到一个查询请求，首先会对当前的连接请求进行认证，认证其用户名和密码信息。</p>
</li>
<li><p>连接成功之后，会继续验证该连接是否具有执行某个特定查询的权限。</p>
</li>
<li><p>所有的验证都通过，如果是 select 操作，MySQL会先检查查询缓存中是否存在该缓存，如果存在直接返回结果。不存在继续下一步。</p>
</li>
<li><p>解析查询，并创建内部数据结构（生成 解析树），然后对解析树进行各种优化（包括，重写查询，决定表的读取顺序、选择合适的索引等等）。</p>
</li>
<li><p>通过存储引擎存储或者提取结果。</p>
</li>
<li><p>如果是select操作，生成查询缓存。</p>
</li>
<li><p>返回结果。</p>
</li>
</ol>
<p>over~</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;通常MySQL架构有两种划分，一种划为两层架构，另一种划为三层。&lt;br&gt;两层架构划为MySQL服务器层和存储引擎层，三层架构则把MySQL层又划为两层。&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;http://n.sinaimg.cn/games/3ece443e/20160916/MySQLJiaGouTu1.png&quot; alt=&quot;MySQL架构图&quot;&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="MySQL" scheme="https://weizhimiao.github.io/categories/MySQL/"/>
    
    
      <category term="MySQL逻辑架构" scheme="https://weizhimiao.github.io/tags/MySQL%E9%80%BB%E8%BE%91%E6%9E%B6%E6%9E%84/"/>
    
  </entry>
  
  <entry>
    <title>Apache中PHP支持模式小结</title>
    <link href="https://weizhimiao.github.io/2016/09/07/Apache%20%E4%B8%ADPHP%E6%94%AF%E6%8C%81%E6%A8%A1%E5%BC%8F/"/>
    <id>https://weizhimiao.github.io/2016/09/07/Apache 中PHP支持模式/</id>
    <published>2016-09-07T12:10:00.000Z</published>
    <updated>2016-09-25T10:54:12.000Z</updated>
    
    <content type="html"><![CDATA[<p>Apache通过不同的方式，能够实现对PHP支持。常见的几种支持方式有：</p>
<ul>
<li>模块支持（handler模式）</li>
<li>CGI模块</li>
<li>FastCGI模式，用Apache内置进程管理器</li>
<li>FastCGI模式，用php-fpm进程管理器</li>
</ul>
<a id="more"></a>
<h2 id="Apache安装、PHP安装、mod-fastcgi模块安装"><a href="#Apache安装、PHP安装、mod-fastcgi模块安装" class="headerlink" title="Apache安装、PHP安装、mod_fastcgi模块安装"></a>Apache安装、PHP安装、mod_fastcgi模块安装</h2><h3 id="Apache-安装"><a href="#Apache-安装" class="headerlink" title="Apache 安装"></a>Apache 安装</h3><p>略过···</p>
<h3 id="PHP-安装"><a href="#PHP-安装" class="headerlink" title="PHP 安装"></a>PHP 安装</h3><p>示例：安装PHP5.6</p>
<ol>
<li><p>下载、解压</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ ~]<span class="comment">#wget http://cn2.php.net/distributions/php-5.6.25.tar.gz</span></div><div class="line">[root@iZ23a3ua2stZ ~]<span class="comment">#tar -zxvf php-5.6.25.tar.gz</span></div></pre></td></tr></table></figure>
</li>
<li><p>./configure</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ ~]<span class="comment">#cd php-5.6.25</span></div><div class="line">[root@iZ23a3ua2stZ php-5.6.25]<span class="comment">#./configure --with-apxs2=/usr/local/apache2/bin/apxs --with-mysql --enable-fpm --prefix=/usr/local/php5.6</span></div></pre></td></tr></table></figure>
<p><code>--enable-fpm</code> 用来来激活对 FPM 的支持</p>
<p><code>--with-apxs2</code> 该参数作用是把php的解释模块编译成so 文件，并自动添加到 Apache的modules中，并自动在 <code>httpd.conf</code> 中加入对应的加载指令<code>LoadModule php5_module modules/libphp5.so</code></p>
<blockquote>
<p><strong>报错1：</strong> 在运行 <code>./configure</code> 时可能会报以下这样的错误。提示我们 运行不了 <code>apxs</code> 这个工具。</p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Sorry, I cannot run apxs.  Possible reasons follow:</div><div class="line">1 Perl is not installed</div><div class="line">2 apxs was not found. Try to pass the path using --with-apxs2=/path/to/apxs</div><div class="line">3 Apache was not built using --enable-so (the apxs usage page is displayed)</div><div class="line">The output of /usr/<span class="built_in">local</span>/apache2/bin/apxs follows:</div><div class="line">./configure: /usr/<span class="built_in">local</span>/apache2/bin/apxs: /replace/with/path/to/perl/interpreter: bad interpreter: No such file or directory</div><div class="line">configure: error: Aborting</div></pre></td></tr></table></figure>
</li>
</ol>
<blockquote>
<p>之前我们在Apache模块化体系的小结中介绍过 <code>apxs</code> 实际是一个 perl 脚本。上面报错中 <code>/replace/with/path/to/perl/interpreter</code> 提示我们找不到这个文件，<br>这行实际是 perl 脚本的声明，我们需要将它改成我们服务器perl脚本的地址。</p>
</blockquote>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ php-5.6.25]<span class="comment"># which perl</span></div><div class="line">/usr/bin/perl</div><div class="line">[root@iZ23a3ua2stZ php-5.6.25]<span class="comment"># vi /usr/local/apache2/bin/apxs</span></div><div class="line"><span class="comment">#将第一行 `#!/replace/with/path/to/perl/interpreter` 改成 `#!/usr/bin/perl`</span></div></pre></td></tr></table></figure>
<blockquote>
<p><strong>报错2：</strong> configure: error: xml2-config not found. Please check your libxml2 installation.<br>提示我们缺少 <code>libxml2</code>。安装 <code>libxml2</code>.<br><figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ php-5.6.25]<span class="comment">#yum install libxml2</span></div><div class="line">[root@iZ23a3ua2stZ php-5.6.25]<span class="comment">#yum install libxml2-devel -y</span></div></pre></td></tr></table></figure></p>
</blockquote>
<p>  <code>./configure</code> 成功会有如下显示。</p>
  <figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">+--------------------------------------------------------------------+</div><div class="line">| License:                                                           |</div><div class="line">| This software is subject to the PHP License, available <span class="keyword">in</span> this     |</div><div class="line">| distribution <span class="keyword">in</span> the file LICENSE.  By continuing this installation |</div><div class="line">| process, you are bound by the terms of this license agreement.     |</div><div class="line">| If you <span class="keyword">do</span> not agree with the terms of this license, you must abort |</div><div class="line">| the installation process at this point.                            |</div><div class="line">+--------------------------------------------------------------------+</div><div class="line">Thank you <span class="keyword">for</span> using PHP.</div><div class="line">config.status: creating php5.spec</div><div class="line">config.status: creating main/build-defs.h</div><div class="line">config.status: creating scripts/phpize</div><div class="line">config.status: creating scripts/man1/phpize.1</div><div class="line">config.status: creating scripts/php-config</div><div class="line">config.status: creating scripts/man1/php-config.1</div><div class="line">config.status: creating sapi/cli/php.1</div><div class="line">config.status: creating sapi/fpm/php-fpm.conf</div><div class="line">config.status: creating sapi/fpm/init.d.php-fpm</div><div class="line">config.status: creating sapi/fpm/php-fpm.service</div><div class="line">config.status: creating sapi/fpm/php-fpm.8</div><div class="line">config.status: creating sapi/fpm/status.html</div><div class="line">config.status: creating sapi/cgi/php-cgi.1</div><div class="line">config.status: creating ext/phar/phar.1</div><div class="line">config.status: creating ext/phar/phar.phar.1</div><div class="line">config.status: creating main/php_config.h</div></pre></td></tr></table></figure>
<ol>
<li>编译<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ php-5.6.25]<span class="comment">#make &amp;&amp; make install</span></div></pre></td></tr></table></figure>
</li>
</ol>
<p>成功安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Build complete.</div><div class="line">Don&apos;t forget to run &apos;make test&apos;.</div><div class="line">Installing PHP SAPI module:       apache2handler</div><div class="line">/usr/local/apache2/build/instdso.sh SH_LIBTOOL=&apos;/usr/local/apache2/build/libtool&apos; libphp5.la /usr/local/apache2/modules</div><div class="line">/usr/local/apache2/build/libtool --mode=install install libphp5.la /usr/local/apache2/modules/</div><div class="line">libtool: install: install .libs/libphp5.so /usr/local/apache2/modules/libphp5.so</div><div class="line">libtool: install: install .libs/libphp5.lai /usr/local/apache2/modules/libphp5.la</div><div class="line">libtool: install: warning: remember to run `libtool --finish /root/php-5.6.25/libs&apos;</div><div class="line">chmod 755 /usr/local/apache2/modules/libphp5.so</div><div class="line">[activating module `php5&apos; in /usr/local/apache2/conf/httpd.conf]</div><div class="line">Installing shared extensions:     /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/</div><div class="line">Installing PHP CLI binary:        /usr/local/php5.6/bin/</div><div class="line">Installing PHP CLI man page:      /usr/local/php5.6/php/man/man1/</div><div class="line">Installing PHP FPM binary:        /usr/local/php5.6/sbin/</div><div class="line">Installing PHP FPM config:        /usr/local/php5.6/etc/</div><div class="line">Installing PHP FPM man page:      /usr/local/php5.6/php/man/man8/</div><div class="line">Installing PHP FPM status page:   /usr/local/php5.6/php/php/fpm/</div><div class="line">Installing PHP CGI binary:        /usr/local/php5.6/bin/</div><div class="line">Installing PHP CGI man page:      /usr/local/php5.6/php/man/man1/</div><div class="line">Installing build environment:     /usr/local/php5.6/lib/php/build/</div><div class="line">Installing header files:           /usr/local/php5.6/include/php/</div><div class="line">Installing helper programs:       /usr/local/php5.6/bin/</div><div class="line">  program: phpize</div><div class="line">  program: php-config</div><div class="line">Installing man pages:             /usr/local/php5.6/php/man/man1/</div><div class="line">  page: phpize.1</div><div class="line">  page: php-config.1</div><div class="line">Installing PEAR environment:      /usr/local/php5.6/lib/php/</div><div class="line">[PEAR] Archive_Tar    - installed: 1.4.0</div><div class="line">[PEAR] Console_Getopt - installed: 1.4.1</div><div class="line">[PEAR] Structures_Graph- installed: 1.1.1</div><div class="line">[PEAR] XML_Util       - installed: 1.3.0</div><div class="line">[PEAR] PEAR           - installed: 1.10.1</div><div class="line">Wrote PEAR system config file at: /usr/local/php5.6/etc/pear.conf</div><div class="line">You may want to add: /usr/local/php5.6/lib/php to your php.ini include_path</div><div class="line">/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php5.6/bin</div><div class="line">ln -s -f phar.phar /usr/local/php5.6/bin/phar</div><div class="line">Installing PDO headers:           /usr/local/php5.6/include/php/ext/pdo/</div></pre></td></tr></table></figure></p>
<ol>
<li>设置配置文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp php.ini-development /usr/local/php5.6/lib/php.ini</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="mod-fastcgi-模块安装"><a href="#mod-fastcgi-模块安装" class="headerlink" title="mod_fastcgi 模块安装"></a>mod_fastcgi 模块安装</h3><ol>
<li><p>下载、解压<br><a href="http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz" target="_blank" rel="external">mod_fastcgi-2.4.6.tar.gz</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ ~]#wget http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz</div><div class="line">[root@iZ23a3ua2stZ ~]#tar -zxvf mod_fastcgi-2.4.6.tar.gz</div><div class="line">cd mod_fastcgi-2.4.6</div></pre></td></tr></table></figure>
</li>
<li><p>编译、安装</p>
<ul>
<li>查看安装说明<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ ~]#cd mod_fastcgi-2.4.6</div><div class="line">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#</div><div class="line">#查看 安装说明文件 (Apache 1.x请查看 INSTALL 文件)</div><div class="line">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#vi INSTALL.AP2  </div><div class="line">···</div><div class="line">$ cd &lt;mod_fastcgi_dir&gt;</div><div class="line">$ cp Makefile.AP2 Makefile</div><div class="line">$ make</div><div class="line">$ make install</div><div class="line">If your Apache2 installation isn&apos;t in /usr/local/apache2, then</div><div class="line">set the top_dir variable when running make (or edit the</div><div class="line">Makefile), e.g.</div><div class="line">  $ make top_dir=/opt/httpd/2.0.40</div><div class="line">Add an entry to httpd.conf like this:</div><div class="line">  LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class="line">···</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ol>
<p>虽然说明文件里描述的很清楚，但我们按照里面的步骤进行编译时，会产生报错。于是找了一大圈问题，发现在 <code>apache2.4</code> 下安装 <code>mod_fastcgi 2.4.6</code> 编译时汇报错，需要打个补丁。</p>
<ol>
<li><p>打补丁<br><a href="http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff" target="_blank" rel="external">补丁下载地址</a></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]<span class="comment">#wget http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff</span></div><div class="line">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]<span class="comment">#patch -p1 &lt; byte-compile-against-apache24.diff</span></div></pre></td></tr></table></figure>
</li>
<li><p>继续编译、安装</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make</div><div class="line">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make install</div></pre></td></tr></table></figure>
</li>
</ol>
<p>然后查看<code>/usr/local/apache2/modules/</code> 下是否已经编译成功 <code>mod_fastcgi.so</code>，<br>并在 <code>httpd.conf</code> 中添加 <code>LoadModule fastcgi_module modules/mod_fastcgi.so</code> 指令。</p>
<h2 id="各种模式配置"><a href="#各种模式配置" class="headerlink" title="各种模式配置"></a>各种模式配置</h2><h3 id="模块模式（最简单）"><a href="#模块模式（最简单）" class="headerlink" title="模块模式（最简单）"></a>模块模式（最简单）</h3><ul>
<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">LoadModule php5_module modules/libphp5.so</div></pre></td></tr></table></figure>
</li>
<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule mime_module&gt;</code> 配置段，在其中添加</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AddType application/x-httpd-php .php</div><div class="line">AddType application/x-httpd-php-source .phps</div></pre></td></tr></table></figure>
</li>
<li><p>重启 Apache ,在站点目录下添加 <code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    phpinfo();</div><div class="line"> <span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>
<blockquote>
<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>Apache 2.0 Handler</code>.</p>
</blockquote>
</li>
</ul>
<h3 id="CGI模式"><a href="#CGI模式" class="headerlink" title="CGI模式"></a>CGI模式</h3><ul>
<li>在 <code>httpd.conf</code> 中添加或者开启<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LoadModule cgid_module modules/mod_cgid.so</div><div class="line">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><code>mod_cgid</code> ,CGI 处理模块。在某些Unix操作系统上，在多线程服务器fork一个进程是一个代价非常大的操作，因为新进程将会复制父进程所有的线程。为了避免每次CGI调用都进行这样代价大的操作。mod_cgid 采用外部守护进程来负责分派子进程来运行CGI脚本。主服务器使用Unix套接字来与此守护进程进行通信。</p>
<p>如果在Apache编译过程中选择了多线程MPM，那么Apache将会默认安装mod_cgid模块，而不是mod_cgi。但在用户配置使用层面，mod_cgid 和 mod_cgi 基本相同，唯一例外的是，mod_cgid 通过指令 ScriptSock 给socket命名用于与CGI守护进程通信。</p>
<p><code>mod_actions</code> ,模块提供基于基于媒体类型或请求方法来执行CGI脚本的方法。该模块引入 <code>Action</code> 和 <code>Script</code> 两个指令。</p>
</blockquote>
<ul>
<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule mime_module&gt;</code> 配置段，在其中添加</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AddHandler php-cgi .php</div><div class="line">Action php-cgi "/cgi-bin/php-cgi"</div></pre></td></tr></table></figure>
</li>
<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule cgid_module&gt;</code> 配置段，在其中添加</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;IfModule cgid_module&gt;</div><div class="line">    Scriptsock /var/run/cgid.sock</div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>
</li>
<li><p>重启 Apache ,在站点目录下添加 <code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    phpinfo();</div><div class="line"> <span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>
<blockquote>
<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>CGI/FastCGI</code>.</p>
</blockquote>
</li>
</ul>
<h3 id="FastCGI模式，用Apache内置进程管理器"><a href="#FastCGI模式，用Apache内置进程管理器" class="headerlink" title="FastCGI模式，用Apache内置进程管理器"></a>FastCGI模式，用Apache内置进程管理器</h3><ul>
<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class="line">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>
</li>
<li><p>然后在 <code>httpd.conf</code> 中添加 <code>&lt;IfModule fastcgi_module&gt;</code> 配置段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;IfModule fastcgi_module&gt;</div><div class="line">   FastCgiServer /usr/local/apache2/cgi-bin/php-cgi -processes 20</div><div class="line">   AddType application/x-httpd-php .php</div><div class="line">   AddHandler php-fastcgi .php</div><div class="line">   Action php-fastcgi /cgi-bin/php-cgi</div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><code>-processes 20</code> ,配置启动的进程数</p>
</blockquote>
<ul>
<li><p>重启 Apache ,执行 <code>ps aux | grep php</code> 查看相应 php-cgi 进程是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ apache2]<span class="comment"># ps aux | grep php</span></div><div class="line">daemon   21382  0.0  0.5  42104  5604 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21435  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21436  0.0  0.4  42104  4732 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21437  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21438  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21439  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21440  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21441  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21442  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21443  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21444  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21445  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21446  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21447  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21448  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21449  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21450  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21451  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21452  0.0  0.4  42104  4732 ?        S    11:31   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">daemon   21453  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/<span class="built_in">local</span>/apache2/cgi-bin/php-cgi</div><div class="line">root     21455  0.0  0.0 112668   984 pts/0    S+   11:31   0:00 grep --color=auto php</div></pre></td></tr></table></figure>
</li>
<li><p>在站点目录下添加 <code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    phpinfo();</div><div class="line"> <span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>
<blockquote>
<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>CGI/FastCGI</code>.</p>
</blockquote>
</li>
</ul>
<h3 id="FastCGI模式，使用php-fpm进程管理器"><a href="#FastCGI模式，使用php-fpm进程管理器" class="headerlink" title="FastCGI模式，使用php-fpm进程管理器"></a>FastCGI模式，使用php-fpm进程管理器</h3><ul>
<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class="line">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>
</li>
<li><p>然后在 <code>httpd.conf</code> 中添加 <code>&lt;IfModule fastcgi_module&gt;</code> 配置段</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&lt;IfModule fastcgi_module&gt;</div><div class="line">   FastCgiExternalServer /usr/local/apache2/cgi-bin/php-cgi -host 127.0.0.1:9000</div><div class="line">   AddType application/x-httpd-php .php</div><div class="line">   AddHandler php-fastcgi .php</div><div class="line">   Action php-fastcgi /cgi-bin/php-cgi</div><div class="line">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p><code>-host 127.0.0.1:9000</code> ,是php-fpm的开启端口，所以我们还需要把php-fpm打开。</p>
</blockquote>
<ul>
<li>启动 <code>php-fpm</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ apache2]<span class="comment"># /usr/local/php5.6/sbin/php-fpm</span></div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>/usr/local/php/sbin/php-fpm{start|stop|quit|restart|reload|logrotate}</p>
<p>–start 启动php的fastcgi进程<br>–stop 强制终止php的fastcgi进程<br>–quit 平滑终止php的fastcgi进程<br>–restart 重启php的fastcgi进程<br>–reload 重新平滑加载php的php.ini<br>–logrotate 重新启用log文件</p>
</blockquote>
<ul>
<li><p>重启 Apache ,执行 <code>ps aux | grep php</code> 查看相应 php-cgi 进程是否启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@iZ23a3ua2stZ apache2]<span class="comment"># ps aux | grep php</span></div><div class="line">[root@iZ23a3ua2stZ apache2]<span class="comment"># ps aux | grep php</span></div><div class="line">root     21680  0.0  0.3 147920  3660 ?        Ss   12:41   0:00 php-fpm: master process (/usr/<span class="built_in">local</span>/php5.6/etc/php-fpm.conf)</div><div class="line">nobody   21681  0.0  0.3 147920  3312 ?        S    12:41   0:00 php-fpm: pool www</div><div class="line">nobody   21682  0.0  0.4 147920  4888 ?        S    12:41   0:00 php-fpm: pool www</div><div class="line">root     21684  0.0  0.0 112664   980 pts/3    S+   12:42   0:00 grep --color=auto php</div></pre></td></tr></table></figure>
</li>
<li><p>在站点目录下添加 <code>index.php</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&lt;?php</span></div><div class="line">    phpinfo();</div><div class="line"> <span class="meta">?&gt;</span></div></pre></td></tr></table></figure>
</li>
<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>
<blockquote>
<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>FPM/FastCGI</code>.</p>
</blockquote>
</li>
</ul>
<h2 id="各种模式比较"><a href="#各种模式比较" class="headerlink" title="各种模式比较"></a>各种模式比较</h2><blockquote>
<p>有空再整理。。。</p>
</blockquote>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Apache通过不同的方式，能够实现对PHP支持。常见的几种支持方式有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;模块支持（handler模式）&lt;/li&gt;
&lt;li&gt;CGI模块&lt;/li&gt;
&lt;li&gt;FastCGI模式，用Apache内置进程管理器&lt;/li&gt;
&lt;li&gt;FastCGI模式，用php-fpm进程管理器&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Apache" scheme="https://weizhimiao.github.io/categories/Apache/"/>
    
    
      <category term="FastCGI" scheme="https://weizhimiao.github.io/tags/FastCGI/"/>
    
      <category term="CGI" scheme="https://weizhimiao.github.io/tags/CGI/"/>
    
      <category term="Apache&amp;PHP" scheme="https://weizhimiao.github.io/tags/Apache-PHP/"/>
    
  </entry>
  
  <entry>
    <title>Apache 虚拟主机配置</title>
    <link href="https://weizhimiao.github.io/2016/09/05/Apache%20%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA%E9%85%8D%E7%BD%AE/"/>
    <id>https://weizhimiao.github.io/2016/09/05/Apache 虚拟主机配置/</id>
    <published>2016-09-05T14:10:00.000Z</published>
    <updated>2016-09-06T15:17:20.000Z</updated>
    
    <content type="html"><![CDATA[<p>虚拟主机指的是在单一机器上运行多个网站。</p>
<ul>
<li>常见的共有三种不同的配置方式。<ul>
<li>基于域名</li>
<li>基于端口（需要增加相对应的 <code>Listen</code> 指令）</li>
<li>基于IP</li>
</ul>
</li>
<li>动态虚拟主机配置。</li>
</ul>
<a id="more"></a>
<h2 id="常规配置方式"><a href="#常规配置方式" class="headerlink" title="常规配置方式"></a>常规配置方式</h2><h3 id="在httpd-conf-文件中启用-httpd-vhost-conf-配置文件"><a href="#在httpd-conf-文件中启用-httpd-vhost-conf-配置文件" class="headerlink" title="在httpd.conf 文件中启用 httpd-vhost.conf 配置文件"></a>在<code>httpd.conf</code> 文件中启用 <code>httpd-vhost.conf</code> 配置文件</h3><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Virtual hosts</div><div class="line">Include conf/extra/httpd-vhosts.conf</div></pre></td></tr></table></figure>
<h3 id="配置-httpd-vhosts-conf"><a href="#配置-httpd-vhosts-conf" class="headerlink" title="配置 httpd-vhosts.conf"></a>配置 <code>httpd-vhosts.conf</code></h3><ol>
<li>基于域名配置<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;VirtualHost *:80&gt;</div><div class="line">    ServerName domain1.com</div><div class="line">    DocumentRoot  "D:\data\domain1.com"</div><div class="line">    &lt;Directory /&gt;</div><div class="line">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class="line">        AllowOverride All</div><div class="line">        Order allow,deny</div><div class="line">        Allow from all</div><div class="line">        Require all granted</div><div class="line">    &lt;/Directory&gt;</div><div class="line">    DirectoryIndex index.php index.html</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p><strong>注：( <code>Require all granted</code> )</strong></p>
<blockquote>
<p>Apache 2.4 及以上版本访问控制与2.2有所变换，所以在2.4+的版本需要在目录下添加 <code>Require all granted</code> 否则会出现访问不到的情况。<br><a href="http://httpd.apache.org/docs/2.4/upgrading.html" target="_blank" rel="external">更多详情，点击查看</a></p>
</blockquote>
<ol>
<li><p>基于端口配置</p>
<ul>
<li><p>基于端口的配置需要先在 <code>httpd.conf</code> 中添加相应端口的 <code>Listen</code> 指令。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">#httpd.conf</div><div class="line">Listen 81</div></pre></td></tr></table></figure>
</li>
<li><p><code>httpd-vhosts.conf</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;VirtualHost *:81&gt;</div><div class="line">    #ServerName 10.235.65.14:81</div><div class="line">    DocumentRoot  "D:\data\domain3.com"</div><div class="line">    &lt;Directory /&gt;</div><div class="line">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class="line">        AllowOverride All</div><div class="line">        Order allow,deny</div><div class="line">        Allow from all</div><div class="line">        Require all granted</div><div class="line">    &lt;/Directory&gt;</div><div class="line">    DirectoryIndex index.php index.html</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>基于IP地址配置</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&lt;VirtualHost *:80&gt;</div><div class="line">    ServerName 10.235.65.14</div><div class="line">    DocumentRoot  "D:\data\domain2.com"</div><div class="line">    &lt;Directory /&gt;</div><div class="line">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class="line">        AllowOverride All</div><div class="line">        Order allow,deny</div><div class="line">        Allow from all</div><div class="line">        Require all granted</div><div class="line">    &lt;/Directory&gt;</div><div class="line">    DirectoryIndex index.php index.html</div><div class="line">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h3><p>配置完成之后，需要重启 Apache 配置才会生效。在浏览器中输入相应的域名，IP或者端口进行查看，能正常输出我们分别设置的内容，则说明我们配置成功。</p>
<h2 id="动态虚拟主机配置"><a href="#动态虚拟主机配置" class="headerlink" title="动态虚拟主机配置"></a>动态虚拟主机配置</h2><p>上面谈到的虚拟主机配置方式，每次配置完成之后都必须重启 Apache 才能生效。并且当我们要配置多个虚拟主机时就需要增加多个 <code>&lt;VirtualHost &gt;···&lt;/VirtualHost&gt;</code> ,显得繁琐。那么有没有一种更好，更有效的方式来进行配置呢？</p>
<p><code>mod_vhost_alias</code> 模块为我们提供了一种动态配置虚拟主机的方式。我们只需设置一个目录，将不同的站点资源按照一定的规则放到该目录下即可。并且不用修改配置文件，且不用重新启动Apache服务器。</p>
<p>动态配置优缺点：</p>
<ul>
<li>优点：<ul>
<li>配置文件更小，意味着Apache启动会更快，并且占用内存更少。正重要的是，更小的配置结构更易于维护，我们人为配置出错的机会更小。</li>
<li>添加新的虚拟主机，我们只需要根据相应的规则在指定的，目录下面创建文件即可。不需要重新配置和启动Apache。</li>
</ul>
</li>
<li>缺点：<ul>
<li>无法针对每个虚拟主机设置不同的日志文件。如果我们有很多的虚拟主机这确实是一个非常糟糕的事情。我们可以选择将日志记录到一个管道或者FIFO，在另一端再将日志文件按照不同的虚拟主机进行分割。比如 <a href="http://httpd.apache.org/docs/current/programs/split-logfile.html" target="_blank" rel="external"><code>aplit-logfile</code></a> 工具。</li>
</ul>
</li>
</ul>
<h3 id="配置方法"><a href="#配置方法" class="headerlink" title="配置方法"></a>配置方法</h3><ul>
<li><p>准备</p>
<ul>
<li>在 <code>httpd.conf</code> 中开启 <code>mod_vhost_alias.so</code> 模块,并添加一个新的子配置文件 <code>httpd-vhost-alias.conf</code> 方便我们配置。<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#开启 mod_vhost_alias.so 模块</div><div class="line">LoadModule vhost_alias_module libexec/apache2/mod_vhost_alias.so</div><div class="line">#去掉 LoadModule 前面的注释</div><div class="line">···</div><div class="line">#添加子配置文件</div><div class="line">#Include /private/etc/apache2/extra/httpd-vhost-alias.conf</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>配置</p>
<ul>
<li>打开子配置文件 <code>httpd-vhost-alias.conf</code> ，添加以下配置。<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">UseCanonicalName Off</div><div class="line">VirtualDocumentRoot /data1/www/%0</div><div class="line">&lt;Directory "/data1/www/"&gt;</div><div class="line">  Options None</div><div class="line">  AllowOverride None</div><div class="line">  Order allow,deny</div><div class="line">  Allow from all</div><div class="line">&lt;/Directory&gt;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>保存，并重启 Apache 。</p>
</li>
<li><p>测试</p>
<ul>
<li>分别绑定不同的域名到服务器，并在 <code>/data1/www/</code> 目录下按照不同域名新建目录，将个站点的资源分别放进相应的目录。<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">127.0.0.1 domain1.com</div><div class="line">127.0.0.1 domain2.com</div><div class="line">127.0.0.1 domain3.com</div></pre></td></tr></table></figure>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/data1/www/domain1.com/index.html   <span class="comment">#this is domain1.com test text</span></div><div class="line">/data1/www/domain2.com/index.html   <span class="comment">#this is domain2.com test text</span></div></pre></td></tr></table></figure>
<ul>
<li>浏览器分别访问 <code>domain1.com</code> 和 <code>domain2.com</code> ，查看是否是否能够正确显示出相应内容。</li>
<li>在 <code>/data1/www/</code> 目录下继续添加 <code>/data1/www/domain3.com/index.html</code> ,然后继续用浏览器访问 <code>domain3.com</code> ，查看是否能将 <code>/data1/www/domain3.com/index.html</code> 的内容输出。</li>
</ul>
</li>
</ul>
<ul>
<li><a href="http://httpd.apache.org/docs/current/vhosts/mass.html" target="_blank" rel="external">更多配置参数及方法，请查看</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;虚拟主机指的是在单一机器上运行多个网站。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;常见的共有三种不同的配置方式。&lt;ul&gt;
&lt;li&gt;基于域名&lt;/li&gt;
&lt;li&gt;基于端口（需要增加相对应的 &lt;code&gt;Listen&lt;/code&gt; 指令）&lt;/li&gt;
&lt;li&gt;基于IP&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;动态虚拟主机配置。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="Apache" scheme="https://weizhimiao.github.io/categories/Apache/"/>
    
    
      <category term="Apache虚拟主机" scheme="https://weizhimiao.github.io/tags/Apache%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA/"/>
    
  </entry>
  
</feed>
