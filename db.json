{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/next/source/css/main.styl","path":"css/main.styl","modified":1,"renderable":1},{"_id":"themes/next/source/images/avatar.gif","path":"images/avatar.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","path":"images/cc-by-nc-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","path":"images/cc-by-nc-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nc.svg","path":"images/cc-by-nc.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-nd.svg","path":"images/cc-by-nd.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by-sa.svg","path":"images/cc-by-sa.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/loading.gif","path":"images/loading.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-zero.svg","path":"images/cc-zero.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/cc-by.svg","path":"images/cc-by.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/placeholder.gif","path":"images/placeholder.gif","modified":1,"renderable":1},{"_id":"themes/next/source/images/quote-r.svg","path":"images/quote-r.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/quote-l.svg","path":"images/quote-l.svg","modified":1,"renderable":1},{"_id":"themes/next/source/images/searchicon.png","path":"images/searchicon.png","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/bootstrap.js","path":"js/src/bootstrap.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/affix.js","path":"js/src/affix.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/hook-duoshuo.js","path":"js/src/hook-duoshuo.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/motion.js","path":"js/src/motion.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/post-details.js","path":"js/src/post-details.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/scrollspy.js","path":"js/src/scrollspy.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/utils.js","path":"js/src/utils.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/README.md","path":"vendors/fastclick/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/LICENSE","path":"vendors/fastclick/LICENSE","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/bower.json","path":"vendors/fastclick/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/HELP-US-OUT.txt","path":"vendors/font-awesome/HELP-US-OUT.txt","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/bower.json","path":"vendors/font-awesome/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/README.md","path":"vendors/jquery_lazyload/README.md","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/CONTRIBUTING.md","path":"vendors/jquery_lazyload/CONTRIBUTING.md","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.scrollstop.js","path":"vendors/jquery_lazyload/jquery.scrollstop.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/bower.json","path":"vendors/jquery_lazyload/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.lazyload.js","path":"vendors/jquery_lazyload/jquery.lazyload.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/velocity/bower.json","path":"vendors/velocity/bower.json","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.ui.js","path":"vendors/velocity/velocity.ui.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.min.js","path":"vendors/velocity/velocity.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.ui.min.js","path":"vendors/velocity/velocity.ui.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/jquery/index.js","path":"vendors/jquery/index.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/blank.gif","path":"vendors/fancybox/source/blank.gif","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite.png","path":"vendors/fancybox/source/fancybox_sprite.png","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_overlay.png","path":"vendors/fancybox/source/fancybox_overlay.png","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading@2x.gif","path":"vendors/fancybox/source/fancybox_loading@2x.gif","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading.gif","path":"vendors/fancybox/source/fancybox_loading.gif","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite@2x.png","path":"vendors/fancybox/source/fancybox_sprite@2x.png","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.css","path":"vendors/fancybox/source/jquery.fancybox.css","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.pack.js","path":"vendors/fancybox/source/jquery.fancybox.pack.js","modified":1,"renderable":1},{"_id":"themes/next/source/js/src/schemes/pisces.js","path":"js/src/schemes/pisces.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.min.js","path":"vendors/fastclick/lib/fastclick.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.js","path":"vendors/fancybox/source/jquery.fancybox.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.js","path":"vendors/fastclick/lib/fastclick.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css.map","path":"vendors/font-awesome/css/font-awesome.css.map","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css","path":"vendors/font-awesome/css/font-awesome.css","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.min.css","path":"vendors/font-awesome/css/font-awesome.min.css","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.min.js","path":"vendors/ua-parser-js/dist/ua-parser.min.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff2","path":"vendors/font-awesome/fonts/fontawesome-webfont.woff2","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.pack.js","path":"vendors/ua-parser-js/dist/ua-parser.pack.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff","path":"vendors/font-awesome/fonts/fontawesome-webfont.woff","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.eot","path":"vendors/font-awesome/fonts/fontawesome-webfont.eot","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/velocity/velocity.js","path":"vendors/velocity/velocity.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/FontAwesome.otf","path":"vendors/font-awesome/fonts/FontAwesome.otf","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/fancybox_buttons.png","path":"vendors/fancybox/source/helpers/fancybox_buttons.png","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","path":"vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-media.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-media.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","path":"vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","path":"vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.ttf","path":"vendors/font-awesome/fonts/fontawesome-webfont.ttf","modified":1,"renderable":1},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.svg","path":"vendors/font-awesome/fonts/fontawesome-webfont.svg","modified":1,"renderable":1}],"Cache":[{"_id":"source/.DS_Store","hash":"53faecf9a3d9a11cf5fa4fde7e744abd78122c9f","modified":1476438428000},{"_id":"themes/next/.bowerrc","hash":"80e096fdc1cf912ee85dd9f7e6e77fd40cf60f10","modified":1469870571000},{"_id":"themes/next/.DS_Store","hash":"d20ca57e4f0f27c34d6b8971b93bc5c4c07e058e","modified":1469876190000},{"_id":"themes/next/.editorconfig","hash":"792fd2bd8174ece1a75d5fd24ab16594886f3a7f","modified":1469870571000},{"_id":"themes/next/.hound.yml","hash":"b76daa84c9ca3ad292c78412603370a367cc2bc3","modified":1469870571000},{"_id":"themes/next/.javascript_ignore","hash":"d619ee13031908cd72666e4ff652d2ea3483b1c3","modified":1469870571000},{"_id":"themes/next/.jshintrc","hash":"9928f81bd822f6a8d67fdbc909b517178533bca9","modified":1469870571000},{"_id":"themes/next/README.en.md","hash":"565ba52b3825b85a9f05b41183caca7f18b741d4","modified":1469870571000},{"_id":"themes/next/README.md","hash":"500b5606eb6a09c979d16128f8b00f4bf9bc95ac","modified":1469870571000},{"_id":"themes/next/_config.yml","hash":"4487667478da9393b101cfcf4b9d5a25d09fa7d5","modified":1474944511000},{"_id":"themes/next/gulpfile.coffee","hash":"26e5b1b945704c8bc78b928feede895c4c111c95","modified":1469870571000},{"_id":"themes/next/bower.json","hash":"f89c6700a11d81e067cc97273ca6bf96cb88c8f9","modified":1469870571000},{"_id":"themes/next/package.json","hash":"63e9c0f1dd9e5d7f51b4ae383981ef939a2ed45d","modified":1469870571000},{"_id":"source/categories/index.md","hash":"faba8865e7edc1ee1c1b66ccea5cb9155f5b28d4","modified":1469880791000},{"_id":"source/_discarded/pache性能监控.md","hash":"5be179af8a652d56afd7963a14bafd1b6a93f5c0","modified":1472006021000},{"_id":"source/_posts/.DS_Store","hash":"34ed549b56f9ce4cb9ff35d9bf18740bcc9e6861","modified":1475849730000},{"_id":"source/_posts/Apache 虚拟主机配置.md","hash":"93b2e27e6c0eb637362d26f419e4a6c77d1a44eb","modified":1473175040000},{"_id":"source/_posts/Apache 中PHP支持模式.md","hash":"c4ac7753439cb7ff3e359ba20b54bac5307ad745","modified":1474800852000},{"_id":"source/_posts/Apache分层与模块化结构体系小结.md","hash":"b30715868c1b96f765a04e64c023c009207a8cc2","modified":1472783159000},{"_id":"source/_posts/Apache多处理模块整理.md","hash":"d35eb32c111695243ebd27ab4962b232e7692f63","modified":1472008592000},{"_id":"source/_posts/ElasticSearch整理.md","hash":"8a85068ffff1536de0abd1c474ff879b3f8ce268","modified":1475919404000},{"_id":"source/_posts/Apache安装汇总.md","hash":"eac9cc36e40ab2a7fc408f8458a52ea634f033ab","modified":1472008590000},{"_id":"source/_posts/Apache性能监控.md","hash":"89088129d4f8b435728e83508fae2c4b9e848bcb","modified":1472008588000},{"_id":"source/_posts/LNMP环境安装与配置.md","hash":"9ba60ae869f3759f47f55edcedf73b2a01883dba","modified":1474895786000},{"_id":"source/_posts/GIT使用小结.md","hash":"b8aa13f0a081eee5465457d101e2c7ca40fe8021","modified":1474641208000},{"_id":"source/_posts/Linux中的用户和用户组管理.md","hash":"44dbd3404ecd96014e9a433a569e01cb0de1eeb0","modified":1475851263000},{"_id":"source/_posts/Linux常用命令.md","hash":"0398a1b74f09b81d5a3f71bd3594fdb824470ec1","modified":1475847254000},{"_id":"source/_posts/Linux常见的配置文件.md","hash":"154487455995fcc269ae5a32691d65a6042612b3","modified":1475851426000},{"_id":"source/_posts/Linux常用工具命令之rsync.md","hash":"eac0c2ee427b4b844ba882b7d2e460350d93de5d","modified":1475940560000},{"_id":"source/_posts/Linux文件和目录权限小结.md","hash":"15fa32e283dfc1fbcdd5b27ac5d40f7fdda3bd55","modified":1475852111000},{"_id":"source/_posts/Linux服务和进程管理.md","hash":"0fdd46c1e07d69f4028becb46560e7495037de58","modified":1475119066000},{"_id":"source/_posts/Linux目录结构介绍.md","hash":"25ef0bda725a237da8164ec91dc2ff3ad2fedd7e","modified":1475851852000},{"_id":"source/_posts/MVCC-多版本并发控制整理.md","hash":"dd34baf3e44e713c0fdc0fe42a3b8a57cfb7cf3f","modified":1474089475000},{"_id":"source/_posts/Linux网络配置.md","hash":"aaf6618b62b5aa0488a460f2c9a8f006ed1731ed","modified":1475848748000},{"_id":"source/_posts/Linux简介.md","hash":"1adb918a58764f183f522240b5f1f0737910f361","modified":1475847551000},{"_id":"source/_posts/Mac下包管理工具homebrew.md","hash":"028b8aa4d7dccb499322d65563e7ad93e3aa97fb","modified":1474384158000},{"_id":"source/_posts/MySQL如何查看表的相关信息.md","hash":"fd1e9ac4c63bbe82d75bba15fbbf013502e16928","modified":1474101769000},{"_id":"source/_posts/MySQL存储引擎概述.md","hash":"0ac3865578ed91baecb74b1458435b48d267572f","modified":1474124798000},{"_id":"source/_posts/Memcached分布式部署算法整理.md","hash":"472f5531a8eb2f5f664e101f7e4d4f975f6a602d","modified":1475316308000},{"_id":"source/_posts/MySQL安装编译.md","hash":"2b005ba5a8b63a736f06469f876432c116b30a85","modified":1474800374000},{"_id":"source/_posts/MySQL的并发控制整理.md","hash":"5b0b05b81c6a316c2017f755bbc88a2dc9a8de72","modified":1474049195000},{"_id":"source/_posts/Nginx服务器https配置.md","hash":"bdb88890372130c02da5fdeb1e1961eb6317c5b2","modified":1475591903000},{"_id":"source/_posts/MySQL逻辑架构实现小结.md","hash":"15295a4488770d0ee5876325079071bcf8a0bd42","modified":1474015330000},{"_id":"source/_posts/Nginx虚拟主机设置.md","hash":"5c91492f3db543a9a0f2bcc52294aae6915188b9","modified":1475592419000},{"_id":"source/_posts/PHP-FPM运行状态监控.md","hash":"75efda447b1ba32ae3e98add7fd0e7ef111093b0","modified":1474968558000},{"_id":"source/_posts/Nginx运行状态监控.md","hash":"3ee4a0c80ed26a3dec7f36c88550b3f65f5de1d1","modified":1474969305000},{"_id":"source/_posts/Nginx配置整理.md","hash":"0f33e6c98044b5fc61fd51746d9e2b3b98e99bb8","modified":1475577406000},{"_id":"source/_posts/PHP常见设计模式之单例模式.md","hash":"acf930db2c878f74895a8cca6d730f832d0901dd","modified":1476432148000},{"_id":"source/_posts/PHP常见设计模式之工厂模式.md","hash":"e8b541ee9ffb10c0629d47b4b4a0b9d1afb021e2","modified":1476438066000},{"_id":"source/_posts/PHP安装.md","hash":"15b2205abf0b87b4c7b13463db27bbcb4d327ce7","modified":1474800228000},{"_id":"source/_posts/PHP中InstanceOf运算符.md","hash":"cdbe71c75cadd44580f9c65ad08b8221f8bac1cb","modified":1475940441000},{"_id":"source/_posts/PHP常见设计模式之注册表模式.md","hash":"6dabd0ed8bcd74350cd6d97c85e8df5e771b01e8","modified":1476432207000},{"_id":"source/_posts/PHP扩展与应用库(PEAR).md","hash":"8cf3bb471c23c62761c846fb67c2600e8ed6e1d5","modified":1476327842000},{"_id":"source/_posts/PHP异常和错误处理.md","hash":"1fb21e71e41fb6639ba06a0a7702b8f77f1fc44e","modified":1475248310000},{"_id":"source/_posts/PHP扩展模块安装.md","hash":"192a13a773f0bd54eb40f9183032fae81348a801","modified":1474895648000},{"_id":"source/_posts/PHP的MVC设计与实现.md","hash":"71803983672472060f3aee6029d52ce5fe948454","modified":1476327793000},{"_id":"source/_posts/PHP项目权限控制实现小结.md","hash":"4387e39ccf5f693fb6d1bd55d55d53acb972ded5","modified":1475833746000},{"_id":"source/_posts/PHP魔术方法小结.md","hash":"45d2eb6e284a312189d15681a5e92b6fbf41287b","modified":1475846643000},{"_id":"source/_posts/PHP输出缓冲区.md","hash":"dfa796024918ec0a0eb9301330d3abb3c6fa2b32","modified":1475940465000},{"_id":"source/_posts/Redis安装与管理.md","hash":"26fe17b31ad39ffff9e84a1e4a5af1d2ef84dfae","modified":1475845205000},{"_id":"source/_posts/Redis高级应用.md","hash":"ad77347e25c13c3b7bface04333a543393ac72dc","modified":1475848805000},{"_id":"source/_posts/Schema数据类型优化.md","hash":"8a2e25d3d946a6b6272b4b3b18e1606ff06c9ec1","modified":1474382105000},{"_id":"source/_posts/Web性能优化随笔.md","hash":"c75357731c504e07fe6f59072b796ad4c4ccdb81","modified":1472008582000},{"_id":"source/_posts/Redis数据类型与操作.md","hash":"e1cf0dc6a75d194b9792e90b5385b8a93665d70d","modified":1475852286000},{"_id":"source/_posts/hexo常用命令.md","hash":"94359defa126ddf193d53ca5dc388da1b11e191c","modified":1472008586000},{"_id":"source/_posts/htaccess 文件功能及配置整理.md","hash":"3fe7cbe257d539ee28e16ddfc4108843170edd1f","modified":1473075868000},{"_id":"source/_posts/keepalived工作原理和配置.md","hash":"51a49b405facfa71d7a3f6f18c665e7c2a5ca42d","modified":1475650040000},{"_id":"source/_posts/memcache高速缓存的工作原理及应用小结.md","hash":"70cb20c771630718f02acbb6ec0c31aaaa719cfa","modified":1475202741000},{"_id":"source/_posts/nginx安装.md","hash":"9a9b177bd577855fd2f757697ade2926f0709a95","modified":1474800365000},{"_id":"source/_posts/事务的ACID概念.md","hash":"ce2887b874f4f929dc0287df09929a97af4bb418","modified":1474048475000},{"_id":"source/_posts/大型网站技术架构剖析.md","hash":"63cc32a24fd93039ecd2040a92022f25726f3166","modified":1476327730000},{"_id":"source/_posts/大话MySQL性能优化.md","hash":"6aa3c9336f31764f83c8dfdf33c3047d66ddeb90","modified":1476350746000},{"_id":"source/_posts/面向对象三大特性五大基本原则.md","hash":"713cb252cfbebd1d8d37ff7ebe9e02ffe2fa12b5","modified":1475940546000},{"_id":"source/tags/.DS_Store","hash":"4b1737e2d95536850ac239b97c1d4b1deae9a602","modified":1469946221000},{"_id":"source/tags/index.md","hash":"d26fe7051c2d903c1e42b0b55d78dffcbf3a0fe5","modified":1469878207000},{"_id":"themes/next/languages/de.yml","hash":"786afba25cfc98845a20d9901823ebeebcd1cbbf","modified":1469870571000},{"_id":"themes/next/languages/default.yml","hash":"9db835c0543ade5a89bc80ec5a898203227cf3d8","modified":1469870571000},{"_id":"themes/next/languages/en.yml","hash":"f03799cbdb5a33064ead080bcac4baca1f6bc5f9","modified":1469870571000},{"_id":"themes/next/languages/id.yml","hash":"147c01e41b931085ad14250fa900c2249dcbbdd7","modified":1469870571000},{"_id":"themes/next/languages/fr-FR.yml","hash":"1a084623c39de74301f3e92f9388a3a815a542ca","modified":1469870571000},{"_id":"themes/next/languages/ja.yml","hash":"a2c7b6301b5474aab798946fb700289df237c3cf","modified":1469870571000},{"_id":"themes/next/languages/pt.yml","hash":"ca239b39bf65c9462e59d51b12f0fe566d453197","modified":1469870571000},{"_id":"themes/next/languages/ru.yml","hash":"cc7b964a46587aea0e57b0a5269d8fd25570858e","modified":1469870571000},{"_id":"themes/next/languages/zh-hk.yml","hash":"519ab3d817ec3bc5bfc91159c494b6b3c170bea7","modified":1469870571000},{"_id":"themes/next/languages/zh-Hans.yml","hash":"f9e4042aff0bd62d8db79ba223ee457f805a421a","modified":1469881272000},{"_id":"themes/next/languages/zh-tw.yml","hash":"6b1f345aaefc13e6723dc8a6741b59ac05c20dfd","modified":1469870571000},{"_id":"themes/next/languages/pt-BR.yml","hash":"462aa865ca3d479bcf6b363cba61247b50f230ff","modified":1469870571000},{"_id":"themes/next/layout/.DS_Store","hash":"ffc8ac79028a89be495294a63ce07ae866b25b70","modified":1469876190000},{"_id":"themes/next/layout/_layout.swig","hash":"1c5211988a5be32bf8137cde3340a5dc07ff6bc2","modified":1469876510000},{"_id":"themes/next/layout/archive.swig","hash":"b5b59d70fc1563f482fa07afd435752774ad5981","modified":1469870571000},{"_id":"themes/next/layout/index.swig","hash":"427d0b95b854e311ae363088ab39a393bf8fdc8b","modified":1469870571000},{"_id":"themes/next/layout/category.swig","hash":"6422d196ceaff4220d54b8af770e7e957f3364ad","modified":1469870571000},{"_id":"themes/next/scripts/merge-configs.js","hash":"0c56be2e85c694247cfa327ea6d627b99ca265e8","modified":1469870571000},{"_id":"themes/next/layout/page.swig","hash":"8019d02232a6dd1a665b6a4d2daef8e5dd2f0049","modified":1469870571000},{"_id":"themes/next/layout/post.swig","hash":"e2e512142961ddfe77eba29eaa88f4a2ee43ae18","modified":1469870571000},{"_id":"themes/next/layout/tag.swig","hash":"07cf49c49c39a14dfbe9ce8e7d7eea3d4d0a4911","modified":1469870571000},{"_id":"themes/next/test/.jshintrc","hash":"19f93d13d1689fe033c82eb2d5f3ce30b6543cc0","modified":1469870571000},{"_id":"themes/next/test/helpers.js","hash":"a1f5de25154c3724ffc24a91ddc576cdbd60864f","modified":1469870571000},{"_id":"themes/next/test/intern.js","hash":"11fa8a4f5c3b4119a179ae0a2584c8187f907a73","modified":1469870571000},{"_id":"themes/next/source/fonts/.gitkeep","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/layout/_macro/reward.swig","hash":"37e5b7c42ec17b9b6b786c5512bcc481a21c974e","modified":1469870571000},{"_id":"themes/next/layout/_macro/post-collapse.swig","hash":"43c3433155ccd9abcbe7dce2e6bfa1f3a66af18b","modified":1469870571000},{"_id":"themes/next/layout/_macro/post.swig","hash":"a751b9eb51d01fa58b707804c1c29505da49c070","modified":1469876374000},{"_id":"themes/next/layout/_macro/sidebar.swig","hash":"1a77843ce5eac62151dc3d38f0a36c43e19e1a74","modified":1469870571000},{"_id":"themes/next/layout/_macro/wechat-subscriber.swig","hash":"14e785adeb0e671ba0ff9a553e6f0d8def6c670c","modified":1469870571000},{"_id":"themes/next/layout/_partials/comments.swig","hash":"b73f9443bee2d3ea383aad52e49ffca8aa97dcc2","modified":1469870571000},{"_id":"themes/next/layout/_partials/duoshuo-hot-articles.swig","hash":"5d4638c46aef65bf32a01681495b62416ccc98db","modified":1469870571000},{"_id":"themes/next/layout/_partials/footer.swig","hash":"d9e8b6e943802791a462406c39d76367838d0962","modified":1469881994000},{"_id":"themes/next/layout/_partials/head.swig","hash":"6b0c495b8154ef8b2d2cb0a554e164ff22cdc962","modified":1469870571000},{"_id":"themes/next/layout/_partials/header.swig","hash":"eb028685cb3c329537bbced06c063d23e6a33817","modified":1469870571000},{"_id":"themes/next/layout/_partials/pagination.swig","hash":"9e8e21d194ef44d271b1cca0bc1448c14d7edf4f","modified":1469870571000},{"_id":"themes/next/layout/_partials/search.swig","hash":"011b9d6c9f0a2f4654908ea20b9391f9b7981271","modified":1469870571000},{"_id":"themes/next/layout/_scripts/.DS_Store","hash":"f2c28a00064c2ac6d05639262e0a240ff22b746a","modified":1469876197000},{"_id":"themes/next/layout/_scripts/baidu-push.swig","hash":"82d060fe055d6e423bbc9199f82dfe5c68e74779","modified":1469870571000},{"_id":"themes/next/layout/_scripts/commons.swig","hash":"766b2bdda29523ed6cd8d7aa197f996022f8fd94","modified":1469870571000},{"_id":"themes/next/layout/_scripts/boostrap.swig","hash":"03aaebe9d50f6acb007ec38cc04acd1cfceb404d","modified":1469870571000},{"_id":"themes/next/layout/_scripts/lean-analytics.swig","hash":"e8452daeaa226ceaedd8194bd569bbacc0a3c7fb","modified":1469876140000},{"_id":"themes/next/layout/_scripts/vendors.swig","hash":"0b91cadecead8e0b5211cc42b085998d94af503a","modified":1469870571000},{"_id":"themes/next/scripts/tags/full-image.js","hash":"3acce36db0feb11a982c6c799aa6b6b47df2827c","modified":1469870571000},{"_id":"themes/next/scripts/tags/center-quote.js","hash":"535fc542781021c4326dec24d8495cbb1387634a","modified":1469870571000},{"_id":"themes/next/scripts/tags/group-pictures.js","hash":"49252824cd53184dc9b97b2f2d87ff28e1b3ef27","modified":1469870571000},{"_id":"themes/next/source/css/main.styl","hash":"20702c48d6053c92c5bcdbc68e8d0ef1369848a0","modified":1469870571000},{"_id":"themes/next/source/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1469870571000},{"_id":"themes/next/source/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1469870571000},{"_id":"themes/next/source/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1469870571000},{"_id":"themes/next/source/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1469870571000},{"_id":"themes/next/source/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1469870571000},{"_id":"themes/next/source/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1469870571000},{"_id":"themes/next/source/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1469870571000},{"_id":"themes/next/source/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1469870571000},{"_id":"themes/next/source/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1469870571000},{"_id":"themes/next/source/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1469870571000},{"_id":"themes/next/source/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1469870571000},{"_id":"themes/next/source/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1469870571000},{"_id":"themes/next/source/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1469870571000},{"_id":"themes/next/layout/_scripts/schemes/mist.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/layout/_scripts/schemes/muse.swig","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/source/css/_mixins/Mist.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/source/css/_mixins/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/source/css/_mixins/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/source/css/_variables/Muse.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/source/css/_variables/custom.styl","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1469870571000},{"_id":"themes/next/layout/_partials/head/external-fonts.swig","hash":"7ce76358411184482bb0934e70037949dd0da8ca","modified":1469870571000},{"_id":"themes/next/layout/_partials/search/localsearch.swig","hash":"ff5523d5dacaa77a55a24e50e6e6530c3b98bfad","modified":1469870571000},{"_id":"themes/next/layout/_partials/search/tinysou.swig","hash":"eefe2388ff3d424694045eda21346989b123977c","modified":1469870571000},{"_id":"themes/next/layout/_partials/search/swiftype.swig","hash":"959b7e04a96a5596056e4009b73b6489c117597e","modified":1469870571000},{"_id":"themes/next/layout/_partials/share/add-this.swig","hash":"c07f7b2f264e5215b8ed42d67e8cef2477558364","modified":1469870571000},{"_id":"themes/next/layout/_partials/share/baidushare.swig","hash":"7ca5cb4daa58b3504e17f3e02975e794bc634658","modified":1469870571000},{"_id":"themes/next/layout/_partials/share/duoshuo_share.swig","hash":"89c5a5240ecb223acfe1d12377df5562a943fd5d","modified":1469870571000},{"_id":"themes/next/layout/_partials/share/jiathis.swig","hash":"63315fcf210799f894208c9f512737096df84962","modified":1469870571000},{"_id":"themes/next/layout/_scripts/pages/post-details.swig","hash":"069d1357c717572256e5cdee09574ebce529cbae","modified":1469870571000},{"_id":"themes/next/layout/_scripts/schemes/pisces.swig","hash":"a44acf9b0d0f44ef3dfc767376a95c984cc127de","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics.swig","hash":"0a89c04055bade7baa5962f1d5aefe438d83a244","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/lean-analytics.swig","hash":"92dc60821307fc9769bea9b2d60adaeb798342af","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/comments.swig","hash":"907b931d775d32405d02a25b3b0a3ac03bf804d0","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/localsearch.swig","hash":"7f7148c8f52e4d3cfc070d964160362179fa8e91","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/mathjax.swig","hash":"5bafc33f57508d1d04a9930165240f6e9efa8d6d","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/tinysou.swig","hash":"cb3a5d36dbe1630bab84e03a52733a46df7c219b","modified":1469870571000},{"_id":"themes/next/source/css/_custom/custom.styl","hash":"328d9a9696cc2ccf59c67d3c26000d569f46344c","modified":1469870571000},{"_id":"themes/next/source/css/_mixins/Pisces.styl","hash":"715d5b40dc52f319fe4bff0325beb874774d9bd9","modified":1469870571000},{"_id":"themes/next/source/css/_mixins/base.styl","hash":"78a83c38f69a8747bb74e420e6c9eeef1ea76525","modified":1469870571000},{"_id":"themes/next/source/css/_variables/Mist.styl","hash":"c8d35a6b9e3bff6d8fdb66de853065af9d37562d","modified":1469870571000},{"_id":"themes/next/source/css/_variables/Pisces.styl","hash":"3ead77befa064d6327dc7afd0a5af7be59a5f196","modified":1469870571000},{"_id":"themes/next/source/css/_variables/base.styl","hash":"17624186f7a1f28daddea258d044f8e03b2f4bea","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/.bower.json","hash":"cc40a9b11e52348e554c84e4a5c058056f6b7aeb","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/.gitattributes","hash":"2db21acfbd457452462f71cc4048a943ee61b8e0","modified":1469870571000},{"_id":"themes/next/source/js/src/bootstrap.js","hash":"39bf93769d9080fa01a9a875183b43198f79bc19","modified":1469870571000},{"_id":"themes/next/source/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1469870571000},{"_id":"themes/next/source/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1469870571000},{"_id":"themes/next/source/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1469870571000},{"_id":"themes/next/source/js/src/post-details.js","hash":"2038f54e289b6da5def09689e69f623187147be5","modified":1469870571000},{"_id":"themes/next/source/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1469870571000},{"_id":"themes/next/source/js/src/utils.js","hash":"e5cb720894c4bc28ca8f10b33df127fb394018d9","modified":1469870571000},{"_id":"themes/next/source/vendors/fastclick/.bower.json","hash":"93ebd5b35e632f714dcf1753e1f6db77ec74449b","modified":1469870571000},{"_id":"themes/next/source/vendors/fastclick/README.md","hash":"1decd8e1adad2cd6db0ab50cf56de6035156f4ea","modified":1469870571000},{"_id":"themes/next/source/vendors/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1469870571000},{"_id":"themes/next/source/vendors/fastclick/bower.json","hash":"13379463c7463b4b96d13556b46faa4cc38d81e6","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/.bower.json","hash":"7da985a99674e54f514d4fd9fcd3bcea6e7e41d5","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/.gitignore","hash":"69d152fa46b517141ec3b1114dd6134724494d83","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/.npmignore","hash":"dcf470ab3a358103bb896a539cc03caeda10fa8b","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/HELP-US-OUT.txt","hash":"69a4c537d167b68a0ccf1c6febd138aeffca60d6","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery/.bower.json","hash":"91745c2cc6c946c7275f952b2b0760b880cea69e","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/bower.json","hash":"279a8a718ab6c930a67c41237f0aac166c1b9440","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery_lazyload/.bower.json","hash":"b7638afc93e9cd350d0783565ee9a7da6805ad8e","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery_lazyload/README.md","hash":"895d50fa29759af7835256522e9dd7dac597765c","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery_lazyload/CONTRIBUTING.md","hash":"4891864c24c28efecd81a6a8d3f261145190f901","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery_lazyload/bower.json","hash":"65bc85d12197e71c40a55c0cd7f6823995a05222","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1469870571000},{"_id":"themes/next/source/vendors/velocity/.bower.json","hash":"05f960846f1c7a93dab1d3f9a1121e86812e8c88","modified":1469870571000},{"_id":"themes/next/source/vendors/velocity/bower.json","hash":"2ec99573e84c7117368beccb9e94b6bf35d2db03","modified":1469870571000},{"_id":"themes/next/source/vendors/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1469870571000},{"_id":"themes/next/source/vendors/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1469870571000},{"_id":"themes/next/source/vendors/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1469870571000},{"_id":"themes/next/source/vendors/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics/baidu-analytics.swig","hash":"7c43d66da93cde65b473a7d6db2a86f9a42647d6","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics/busuanzi-counter.swig","hash":"4fcbf57c4918528ab51d3d042cff92cf5aefb599","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics/cnzz-analytics.swig","hash":"f9c6ee91c2a615edd8ca26edcc8a66b71883c238","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics/facebook-sdk.swig","hash":"394d008e5e94575280407ad8a1607a028026cbc3","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics/google-analytics.swig","hash":"30a23fa7e816496fdec0e932aa42e2d13098a9c2","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/analytics/tencent-analytics.swig","hash":"3658414379e0e8a34c45c40feadc3edc8dc55f88","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/comments/duoshuo.swig","hash":"696666141cdd204fd8818ac2ad18f05e320f8587","modified":1469870571000},{"_id":"themes/next/layout/_scripts/third-party/comments/disqus.swig","hash":"bff3b18f56175c53f3bc6d733166c4d998e08732","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/back-to-top.styl","hash":"b49efc66bd055a2d0be7deabfcb02ee72a9a28c8","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/buttons.styl","hash":"0dfb4b3ba3180d7285e66f270e1d3fa0f132c3d2","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/comments.styl","hash":"471f1627891aca5c0e1973e09fbcb01e1510d193","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/components.styl","hash":"10994990d6e0b4d965a728a22cf7f6ee29cae9f6","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/pagination.styl","hash":"711c8830886619d4f4a0598b0cde5499dce50c62","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/tag-cloud.styl","hash":"dd8a3b22fc2f222ac6e6c05bd8a773fb039169c0","modified":1469870571000},{"_id":"themes/next/source/css/_common/outline/outline.styl","hash":"2186be20e317505cd31886f1291429cc21f76703","modified":1469870571000},{"_id":"themes/next/source/css/_common/scaffolding/base.styl","hash":"5304f99581da3a31de3ecec959b7adf9002fde83","modified":1469870571000},{"_id":"themes/next/source/css/_common/scaffolding/helpers.styl","hash":"54c90cf7bdbf5c596179d8dae6e671bad1292662","modified":1469870571000},{"_id":"themes/next/source/css/_common/scaffolding/normalize.styl","hash":"ece571f38180febaf02ace8187ead8318a300ea7","modified":1469870571000},{"_id":"themes/next/source/css/_common/scaffolding/scaffolding.styl","hash":"013619c472c7e4b08311c464fcbe9fcf5edde603","modified":1469870571000},{"_id":"themes/next/source/css/_common/scaffolding/tables.styl","hash":"64f5d56c08d74a338813df1265580ca0cbf0190b","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Muse/_layout.styl","hash":"6ed60cc621bac096c0ed7534fa25b1a52dc571d4","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Muse/_logo.styl","hash":"8829bc556ca38bfec4add4f15a2f028092ac6d46","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Muse/_menu.styl","hash":"c2c6c4f6434b4f94aac2af5861cd769427f0ee10","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Muse/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Muse/index.styl","hash":"a0e2030a606c934fb2c5c7373aaae04a1caac4c5","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/_base.styl","hash":"c2d079788d6fc2e9a191ccdae94e50d55bf849dc","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/_header.styl","hash":"5ae7906dc7c1d9468c7f4b4a6feddddc555797a1","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/_logo.styl","hash":"38e5df90c8689a71c978fd83ba74af3d4e4e5386","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/_menu.styl","hash":"b0dcca862cd0cc6e732e33d975b476d744911742","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/_posts-expanded.styl","hash":"4303776991ef28f5742ca51c7dffe6f12f0acf34","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/_search.styl","hash":"1452cbe674cc1d008e1e9640eb4283841058fc64","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/index.styl","hash":"9a5581a770af8964064fef7afd3e16963e45547f","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/_full-image.styl","hash":"938d39eedc6e3d33918c1145a5bf1e79991d3fcf","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/_menu.styl","hash":"d09280e5b79f3b573edb30f30c7a5f03ac640986","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/_layout.styl","hash":"8d7cecde4933900c7df2db9d0a98f5f82f88dc93","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/_brand.styl","hash":"be22ad34f546a07f6d56b424338cdd898683eea4","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/_sidebar.styl","hash":"d4b7bd610ca03dbb2f5b66631c0e84a79fb4660b","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/_posts.styl","hash":"2f878213cb24c5ddc18877f6d15ec5c5f57745ac","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Pisces/index.styl","hash":"1b10ba2d3ad0c063c418dc94a0b7e0db4b342c53","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1469870571000},{"_id":"themes/next/source/js/src/schemes/pisces.js","hash":"7506e7490c69a200831393c38d25e91c156bd471","modified":1469870571000},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1469870571000},{"_id":"themes/next/source/vendors/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.css","hash":"3b87c2560832748cd06f9bfd2fd6ea8edbdae8c7","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/css/font-awesome.min.css","hash":"05ea25bc9b3ac48993e1fee322d3bc94b49a6e22","modified":1469870571000},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff2","hash":"574ea2698c03ae9477db2ea3baf460ee32f1a7ea","modified":1469870571000},{"_id":"themes/next/source/vendors/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.woff","hash":"507970402e328b2baeb05bde73bf9ded4e2c3a2d","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.eot","hash":"b3c2f08e73320135b69c23a3908b87a12053a2f6","modified":1469870571000},{"_id":"themes/next/source/vendors/velocity/velocity.js","hash":"e63dc7cea055ca60a95d286f32349d88b10c5a4d","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/fonts/FontAwesome.otf","hash":"0112e96f327d413938d37c1693806f468ffdbace","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/header/headerband.styl","hash":"d27448f199fc2f9980b601bc22b87f08b5d64dd1","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/footer/footer.styl","hash":"8994ffcce84deac0471532f270f97c44fea54dc0","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/header/header.styl","hash":"ae1ca14e51de67b07dba8f61ec79ee0e2e344574","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/header/menu.styl","hash":"c890ce7fe933abad7baf39764a01894924854e92","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/header/site-meta.styl","hash":"6c00f6e0978f4d8f9a846a15579963728aaa6a17","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/highlight/theme.styl","hash":"90f8f9706cd7fe829cf06e9959a65fd3f8b994fa","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/header/site-nav.styl","hash":"49c2b2c14a1e7fcc810c6be4b632975d0204c281","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/highlight/highlight.styl","hash":"4da051c7f3924fa2db1e73c55b2baf1c2c150255","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/pages/archive.styl","hash":"7778920dd105fa4de3a7ab206eeba30b1a7bac45","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/pages/post-detail.styl","hash":"9bf4362a4d0ae151ada84b219d39fbe5bb8c790e","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/pages/pages.styl","hash":"3c46efd6601e268093ce6d7b1471d18501878f0d","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-collapse.styl","hash":"8fae54591877a73dff0b29b2be2e8935e3c63575","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-eof.styl","hash":"2cdc094ecf907a02fce25ad4a607cd5c40da0f2b","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-expand.styl","hash":"b25132fe6a7ad67059a2c3afc60feabb479bdd75","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-gallery.styl","hash":"387ce23bba52b22a586b2dfb4ec618fe1ffd3926","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-meta.styl","hash":"d543d1377c1f61b70e3adb6da0eb12797552e5f2","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-more-link.styl","hash":"15063d79b5befc21820baf05d6f20cc1c1787477","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/pages/categories.styl","hash":"4eff5b252d7b614e500fc7d52c97ce325e57d3ab","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-nav.styl","hash":"cbca4842a54950e2934b3b8f3cd940f122111aef","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-tags.styl","hash":"a352ae5b1f8857393bf770d2e638bf15f0c9585d","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-title.styl","hash":"963105a531403d7aad6d9e5e23e3bfabb8ec065a","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-reward.styl","hash":"e792c8dc41561c96d128e9b421187f1c3dc978a0","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post-type.styl","hash":"10251257aceecb117233c9554dcf8ecfef8e2104","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author-links.styl","hash":"2e7ec9aaa3293941106b1bdd09055246aa3c3dc6","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-blogroll.styl","hash":"c44f6a553ec7ea5508f2054a13be33a62a15d3a9","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-author.styl","hash":"920343e41c124221a17f050bbb989494d44f7a24","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-nav.styl","hash":"45fa7193435a8eae9960267438750b4c9fa9587f","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/post/post.styl","hash":"4eb18b12fa0ea6c35925d9a64f64e2a7dae8c7fd","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-feed-link.styl","hash":"9486ddd2cb255227db102d09a7df4cae0fabad72","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toc.styl","hash":"7690b9596ec3a49befbe529a5a2649abec0faf76","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar-toggle.styl","hash":"2d3abbc85b979a648e0e579e45f16a6eba49d1e7","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/site-state.styl","hash":"3623e7fa4324ec1307370f33d8f287a9e20a5578","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/sidebar/sidebar.styl","hash":"234facd038f144bd0fe09a31ed1357c5d74c517f","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/tags/blockquote-center.styl","hash":"c2abe4d87148e23e15d49ee225bc650de60baf46","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/tags/full-image.styl","hash":"618f73450cf541f88a4fddc3d22898aee49d105d","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/tags/group-pictures.styl","hash":"4851b981020c5cbc354a1af9b831a2dcb3cf9d39","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/tags/tags.styl","hash":"8e66c2635d48e11de616bb29c4b1323698eebc0a","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/third-party/baidushare.styl","hash":"93b08815c4d17e2b96fef8530ec1f1064dede6ef","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/third-party/busuanzi-counter.styl","hash":"b03f891883446f3a5548b7cc90d29c77e62f1053","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/third-party/duoshuo.styl","hash":"2340dd9b3202c61d73cc708b790fac5adddbfc7f","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/third-party/localsearch.styl","hash":"795d94561888d31cb7a6ff4a125596809ea69b7d","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/third-party/third-party.styl","hash":"3afc459442c132c480d1d832f1a872f1070bb048","modified":1469870571000},{"_id":"themes/next/source/css/_common/components/third-party/jiathis.styl","hash":"327b5f63d55ec26f7663185c1a778440588d9803","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Muse/sidebar/sidebar-blogroll.styl","hash":"8b8e8cbce98a9296c8fd77f512ae85d945f65d40","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/sidebar/sidebar-blogroll.styl","hash":"8b8e8cbce98a9296c8fd77f512ae85d945f65d40","modified":1469870571000},{"_id":"themes/next/source/css/_schemes/Mist/outline/outline.styl","hash":"5dc4859c66305f871e56cba78f64bfe3bf1b5f01","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1469870571000},{"_id":"themes/next/source/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.ttf","hash":"27cf1f2ec59aece6938c7bb2feb0e287ea778ff9","modified":1469870571000},{"_id":"themes/next/source/vendors/font-awesome/fonts/fontawesome-webfont.svg","hash":"2b3c8ba7008cc014d8fb37abc6f9f49aeda83824","modified":1469870571000},{"_id":"public/atom.xml","hash":"b5ecfa27b83d2aaee6d120d742dd12fdff83e0ba","modified":1476438452856},{"_id":"public/categories/index.html","hash":"3230d06905999b530866b12a9eff3f6bcd3ad347","modified":1476438453296},{"_id":"public/categories/PHP/page/2/index.html","hash":"1244c26bba3e0c6c3f49acc505d0dc15503ca2bb","modified":1476438453299},{"_id":"public/categories/软件工程/index.html","hash":"1a0f36cf63af31f1d8048cf5a5e3d9296e9d4c4a","modified":1476438453300},{"_id":"public/categories/Mac/index.html","hash":"9a8b12573348eac77049840c280ae562ad63879d","modified":1476438453300},{"_id":"public/categories/Nginx/index.html","hash":"e078b9727a415d0a8d7492d3cf2c858c5dfe82c9","modified":1476438453300},{"_id":"public/categories/Web/index.html","hash":"0ae005ca54a8375df355f31961a4da932be888e8","modified":1476438453300},{"_id":"public/categories/架构/index.html","hash":"963b2abbdccdcd84877ae89cc0618cc1a5aa1398","modified":1476438453300},{"_id":"public/archives/2016/07/index.html","hash":"fca0ccfedb1cb6a5b04ac947bad1d2b68affb583","modified":1476438453300},{"_id":"public/archives/2016/10/page/3/index.html","hash":"b4efc3929be137ccf11cda29c31d73be9db2a1e6","modified":1476438453300},{"_id":"public/tags/Apache虚拟主机/index.html","hash":"9b6995293d3e759521b8c184704d82c5255c5f44","modified":1476438453300},{"_id":"public/tags/FastCGI/index.html","hash":"0e6e5a1990ff819be7d2406d4376c22bf57dbe10","modified":1476438453300},{"_id":"public/tags/CGI/index.html","hash":"f25a1a031a33ed42b0f18ccf7cb8d2fb336adc5e","modified":1476438453300},{"_id":"public/tags/Apache-PHP/index.html","hash":"9e2301b3e0bacc081cc77c816fd3904c15fc9578","modified":1476438453300},{"_id":"public/tags/Apache分层/index.html","hash":"0050f99fe7fb6c93f67b9e36f2f657f4b615fbfb","modified":1476438453300},{"_id":"public/tags/Apache模块/index.html","hash":"d1ead2d5515742a7e391ce521a885959a6a7c69f","modified":1476438453300},{"_id":"public/tags/Apache-Apache性能优化/index.html","hash":"691d513c073638e1421620a57bf86c228869f140","modified":1476438453300},{"_id":"public/tags/Web服务器/index.html","hash":"c5f98487bff53bc642e65af524dd89a114dde485","modified":1476438453300},{"_id":"public/tags/Apache/index.html","hash":"b5606aa41a16056705e476f3a41ebe0fe3bf831a","modified":1476438453300},{"_id":"public/tags/ElasticSearch/index.html","hash":"6321f2925d2bed53c69cbb2bae703027fc7f2829","modified":1476438453300},{"_id":"public/tags/Apache-监控/index.html","hash":"67bbce10a2bff9c005ced3b97b11a4c5724f6356","modified":1476438453300},{"_id":"public/tags/LNMP/index.html","hash":"faa7c2490076fe44e3cdb13515ee5e75f33d6a5d","modified":1476438453300},{"_id":"public/tags/git/index.html","hash":"c7dc98d8fafd2acfbd18f01ceb528a7c31b2a521","modified":1476438453300},{"_id":"public/tags/版本控制/index.html","hash":"018f8a2e879e1583b2b6ef965bfa519b01cdddcc","modified":1476438453300},{"_id":"public/tags/rsync/index.html","hash":"bed26b7ae1a1dfc5e02257663525006b133fa50b","modified":1476438453300},{"_id":"public/tags/进程管理/index.html","hash":"2c576d2874af6677896fce333e4d4a6192f30aa4","modified":1476438453300},{"_id":"public/tags/服务管理/index.html","hash":"c80e5eb892eedd6a3e707f4c7e36b4734ea32c16","modified":1476438453300},{"_id":"public/tags/MVCC/index.html","hash":"12e54b3f4a4582a8b933d5027715c1ff9f1fd8c6","modified":1476438453300},{"_id":"public/tags/多版本并发控制/index.html","hash":"98bda5fafa53a29f4ad93189267c954fcbfb182f","modified":1476438453300},{"_id":"public/tags/Mac/index.html","hash":"c4a70738504ba235c1c5a1750aac8de21041c9d9","modified":1476438453300},{"_id":"public/tags/homebrew/index.html","hash":"6de9b73eb679c2ae29ba7b2d95b1b04591c5a258","modified":1476438453301},{"_id":"public/tags/存储引擎/index.html","hash":"0feb15468f1ea4af00be29d9c330399e08398ff8","modified":1476438453301},{"_id":"public/tags/分布式部署算法/index.html","hash":"fbf0d0b0cecd91ba65eff6d43cb239ade9ee1510","modified":1476438453301},{"_id":"public/tags/并发控制/index.html","hash":"da7f6a3e3485c4700aaeaee81a2bf0f491005e08","modified":1476438453301},{"_id":"public/tags/https/index.html","hash":"1698cc68bb85c07d1e0d78f70027563b0616fc7a","modified":1476438453301},{"_id":"public/tags/MySQL逻辑架构/index.html","hash":"c98507e1cede779d0c0b1d657f0baa7fdcbd268d","modified":1476438453301},{"_id":"public/tags/虚拟主机/index.html","hash":"1d7f88e0cec46db59be9fe4fa29d6992cfdc3d1a","modified":1476438453301},{"_id":"public/tags/PHP-FPM/index.html","hash":"ef20b35130d08de3ff1e5455831320a0fa1d8442","modified":1476438453301},{"_id":"public/tags/监控/index.html","hash":"33ac19481852e0cb1bea4d9319b52951492b8548","modified":1476438453301},{"_id":"public/tags/PEAR/index.html","hash":"c7c720ecc59c04b4fedc23bafc4f1053128fe4dc","modified":1476438453301},{"_id":"public/tags/错误处理/index.html","hash":"cf83377ec591091a79493d0344762bb530ec3ceb","modified":1476438453301},{"_id":"public/tags/异常处理/index.html","hash":"2db63e7c939357c07267340bfff35e21ba309425","modified":1476438453301},{"_id":"public/tags/PHP扩展/index.html","hash":"58b13548dfc8f87559f52da809a31cb1bf01b4f4","modified":1476438453301},{"_id":"public/tags/phpize/index.html","hash":"8c239e0ca9bc12024687b76f2f11fb6d189daecd","modified":1476438453301},{"_id":"public/tags/MVC/index.html","hash":"284894baba482730aa7186498b402d8c63ce64d2","modified":1476438453301},{"_id":"public/tags/权限控制/index.html","hash":"eee1916016e7718ee531081dc6faa09ecaacb96e","modified":1476438453301},{"_id":"public/tags/RBAC/index.html","hash":"65d6adf379ca1899d624bad94da1da7f95c21f0a","modified":1476438453301},{"_id":"public/tags/Redis/index.html","hash":"ef9dce8040ac635a954725ca9f4b88026c80b35c","modified":1476438453301},{"_id":"public/tags/Web/index.html","hash":"87c4d00b09103194b9059ef5049658ef48fe89bc","modified":1476438453301},{"_id":"public/tags/数据类型/index.html","hash":"d14895c3dfc55e72772e4425687016cb3a489aee","modified":1476438453301},{"_id":"public/tags/性能优化/index.html","hash":"3b7a6997688b3c2732cca723ba7b5107ad0dc26c","modified":1476438453301},{"_id":"public/tags/hexo/index.html","hash":"c70970dc0b05f121dc08e6e543d123a9bd6aec80","modified":1476438453301},{"_id":"public/tags/htaccess/index.html","hash":"66bb27edc27e2f9aa77cc3757d0dfe6a21017c52","modified":1476438453301},{"_id":"public/tags/负载均衡/index.html","hash":"e378cdf977bd5c730e04c51b044391a7e233365e","modified":1476438453301},{"_id":"public/tags/缓存/index.html","hash":"f065858595a10725d927f8737d329b724f08f47c","modified":1476438453301},{"_id":"public/tags/memcache/index.html","hash":"60219618de06e2a982295422ce7fd4459de4f514","modified":1476438453301},{"_id":"public/tags/memcached/index.html","hash":"96f45166b23d5546dad9b83b312dc8879fa10ea4","modified":1476438453301},{"_id":"public/tags/Nginx安装/index.html","hash":"dd21367fce09e99221b73663c178423f9d4b6db4","modified":1476438453301},{"_id":"public/tags/事务/index.html","hash":"921b4a43bc9ed006e6573104e414095f9a5651fe","modified":1476438453302},{"_id":"public/tags/ACID/index.html","hash":"55a83b3385bae9a2a1c42c6551b3df08075ed2cc","modified":1476438453302},{"_id":"public/tags/index.html","hash":"8f150091cadf67a860a73470fc77142d4255ae6f","modified":1476438453302},{"_id":"public/2016/10/13/大话MySQL性能优化/index.html","hash":"21d6c93fd9491de3894fcf7f270d5ac758c1ee44","modified":1476438453302},{"_id":"public/2016/10/13/大型网站技术架构剖析/index.html","hash":"36a7d68dd29134948a1e893ccda704d4fe522a92","modified":1476438453302},{"_id":"public/2016/10/12/PHP的MVC设计与实现/index.html","hash":"c58ba6174ff6850747fe4eaf6d5b68c8461e08cf","modified":1476438453302},{"_id":"public/2016/10/12/PHP扩展与应用库(PEAR)/index.html","hash":"cdb6af655468f2645b73c33d42ae6c290beeabc0","modified":1476438453302},{"_id":"public/2016/10/08/Linux常用工具命令之rsync/index.html","hash":"0d435568b7d4c21c54437968059eb2bbb83a1494","modified":1476438453302},{"_id":"public/2016/10/07/PHP输出缓冲区/index.html","hash":"d3067f8749903f562d7da983b8f74b2fab54eff0","modified":1476438453302},{"_id":"public/2016/10/07/PHP项目权限控制实现小结/index.html","hash":"681e5bb2dea6de36169bb2aa062e16135624545f","modified":1476438453302},{"_id":"public/2016/10/06/PHP魔术方法小结/index.html","hash":"d9231b95faba2fd54082984a4c30921251526385","modified":1476438453302},{"_id":"public/2016/10/06/Linux文件和目录权限小结/index.html","hash":"aa790de13d4a6e83db55738be32066d92d577fc5","modified":1476438453302},{"_id":"public/2016/10/06/Linux常用命令/index.html","hash":"d994d7fd48a3f5f830fef5d769b321a0dbf1ebe0","modified":1476438453302},{"_id":"public/2016/10/06/Linux目录结构介绍/index.html","hash":"7f5660a61be519e6cbe02159bea92b8c3cc4e3d8","modified":1476438453302},{"_id":"public/2016/10/06/Linux中的用户和用户组管理/index.html","hash":"20584914959ea174832c1c54898c6b7750487ac6","modified":1476438453302},{"_id":"public/2016/10/06/Linux网络配置/index.html","hash":"f2ffde27babb2f543054efc6028150e8d2e25540","modified":1476438453302},{"_id":"public/2016/10/06/Linux简介/index.html","hash":"bc132d1657bb63d759b7daa860fa83c5a14b8d25","modified":1476438453302},{"_id":"public/2016/10/06/Linux常见的配置文件/index.html","hash":"47581a30b13c29b90600e3895651e42faf6c0d6a","modified":1476438453302},{"_id":"public/2016/10/05/ElasticSearch整理/index.html","hash":"d848f41397fc43384db0861354b18970d6e3df22","modified":1476438453302},{"_id":"public/2016/10/05/keepalived工作原理和配置/index.html","hash":"78454f02fab490a482b50a8d14da9bc5b695e605","modified":1476438453302},{"_id":"public/2016/10/04/Nginx服务器https配置/index.html","hash":"1f7c0850026d178c5bcecbb6641cbba93a1724c3","modified":1476438453303},{"_id":"public/2016/10/04/Nginx虚拟主机设置/index.html","hash":"af7f4821d08a1988be07f5b62773383021c3a1a5","modified":1476438453303},{"_id":"public/2016/10/03/Nginx配置整理/index.html","hash":"c10f48a488944e9e50819f02a669aedd106af233","modified":1476438453303},{"_id":"public/2016/10/01/Memcached分布式部署算法整理/index.html","hash":"cdd82ef94b4c9cff16aa45dec4f610af1aba1903","modified":1476438453303},{"_id":"public/2016/09/30/PHP异常和错误处理/index.html","hash":"783f3c97171ba1bd792bb1d12dfa36e531fb4496","modified":1476438453303},{"_id":"public/2016/09/29/memcache高速缓存的工作原理及应用小结/index.html","hash":"d1d9b20fb616afd8554d2f074958c986982797ad","modified":1476438453303},{"_id":"public/2016/09/28/Linux服务和进程管理/index.html","hash":"9f5a46d21759a675246c9f891d9d6b4af7082788","modified":1476438453303},{"_id":"public/2016/09/27/Nginx运行状态监控/index.html","hash":"e93f06a0ce355b89a7eebd49140079bde2b24b81","modified":1476438453303},{"_id":"public/2016/09/27/PHP-FPM运行状态监控/index.html","hash":"76cea84e2a8c1a3ad4bdf0cb2458de272c59de4e","modified":1476438453303},{"_id":"public/2016/09/27/Redis高级应用/index.html","hash":"8aab319a08dd4a4765917fbc04acf1297c77738b","modified":1476438453303},{"_id":"public/2016/09/27/Redis安装与管理/index.html","hash":"89175a62966b4afb3bb3919e85dca37ea4fcd89d","modified":1476438453303},{"_id":"public/2016/09/27/Redis数据类型与操作/index.html","hash":"961d4de038bff967404d9e7b9739cd0f7f1cf03b","modified":1476438453303},{"_id":"public/2016/09/26/PHP扩展模块安装/index.html","hash":"da45a04c4ab4a281f2e7beca3ecf3f94d0d57a8e","modified":1476438453303},{"_id":"public/2016/09/25/LNMP环境安装与配置/index.html","hash":"e100ccd3d3bf0dd24a6a32f33c31beb765a58e6a","modified":1476438453303},{"_id":"public/2016/09/25/PHP安装/index.html","hash":"4f25905bfada8e12a1c0ce0eadd899430fcede4e","modified":1476438453303},{"_id":"public/2016/09/25/nginx安装/index.html","hash":"f95957ee3306441602f075ebc2dddbcbabae2b0e","modified":1476438453304},{"_id":"public/2016/09/25/MySQL安装编译/index.html","hash":"ab35ee30213f176f9871ff3e1117583da378e499","modified":1476438453304},{"_id":"public/2016/09/22/PHP中InstanceOf运算符/index.html","hash":"dbf4b1c6650b77a5e76f55c91c9a617a2fb0fea8","modified":1476438453304},{"_id":"public/2016/09/21/GIT使用小结/index.html","hash":"5fd4301962d6356f54e6863fcffb1a190aa3bf0c","modified":1476438453304},{"_id":"public/2016/09/20/Mac下包管理工具homebrew/index.html","hash":"894898ce243e68288b97224e1db0aa24313ce680","modified":1476438453304},{"_id":"public/2016/09/19/Schema数据类型优化/index.html","hash":"44f8ef30d08eb7c0a3c2da3a8cfc11b181664b68","modified":1476438453304},{"_id":"public/2016/09/17/MySQL存储引擎概述/index.html","hash":"7fa08f8ea12f79c8eba0bee6c5152e0d64789c0d","modified":1476438453304},{"_id":"public/2016/09/17/MySQL如何查看表的相关信息/index.html","hash":"6008f7f940e117b5f00b4dfbc00f051a3b95ff96","modified":1476438453304},{"_id":"public/2016/09/17/MVCC-多版本并发控制整理/index.html","hash":"29a1742adcb5b5065e56c7d838ba321ae8311fc5","modified":1476438453304},{"_id":"public/2016/09/17/事务的ACID概念/index.html","hash":"54bb9b5f42d0f282b8be2667b071347af3ca19b1","modified":1476438453304},{"_id":"public/2016/09/16/MySQL的并发控制整理/index.html","hash":"007b4e519d3b4f1e3d47323bf312628471d786e5","modified":1476438453304},{"_id":"public/2016/09/16/MySQL逻辑架构实现小结/index.html","hash":"866c4045236a3078d892d3d0abc184616f7960ee","modified":1476438453304},{"_id":"public/2016/09/07/Apache 中PHP支持模式/index.html","hash":"ad19951e86a22f8a8ab92fa4ea2ed99bb8870d47","modified":1476438453304},{"_id":"public/2016/09/05/Apache 虚拟主机配置/index.html","hash":"ca65ff6438a5f832a928458a40e77e6074e3647a","modified":1476438453304},{"_id":"public/2016/09/05/htaccess 文件功能及配置整理/index.html","hash":"7a65a82af1f3c05fb2af965951a696973077321e","modified":1476438453304},{"_id":"public/2016/08/26/Apache分层与模块化结构体系小结/index.html","hash":"f0f1c93df616588a8df3803d4754d502fc4d0213","modified":1476438453304},{"_id":"public/2016/08/23/Apache性能监控/index.html","hash":"951f8c6526363f7713f36484c853a0cbf761341e","modified":1476438453304},{"_id":"public/2016/08/22/Apache多处理模块整理/index.html","hash":"e106d798991d4dbda0dcb755ed037c716a561df3","modified":1476438453305},{"_id":"public/2016/08/22/面向对象三大特性五大基本原则/index.html","hash":"46c23566ae984a4a22ece40cc7c6a2facd27e2fd","modified":1476438453305},{"_id":"public/2016/08/12/hexo常用命令/index.html","hash":"ec92126a4511dad12ef3bc99c8a4ce144a423a38","modified":1476438453305},{"_id":"public/2016/08/09/Apache安装汇总/index.html","hash":"7c4b162d43009de5eb499dd2314f68645802b0b4","modified":1476438453305},{"_id":"public/2016/07/31/Web性能优化随笔/index.html","hash":"4744b456ed309aba68ae218c94de1e621bc75ad0","modified":1476438453305},{"_id":"public/categories/Apache/index.html","hash":"eef51a81c845af1b0f551a146236a52ab3bf8bae","modified":1476438453305},{"_id":"public/categories/Linux/index.html","hash":"5e4ffd46839db84c7aae1bce85e237793a36f1e6","modified":1476438453305},{"_id":"public/categories/Linux/page/2/index.html","hash":"e177cd33686306f97db1ecaae96e4ff53cec9900","modified":1476438453305},{"_id":"public/categories/PHP/index.html","hash":"a4640fa0a136eca70ddbfafaff8e3d70727ed9ce","modified":1476438453305},{"_id":"public/categories/MySQL/index.html","hash":"cd136c410e9413fa7885d6b5bbb99e8752f07bde","modified":1476438453305},{"_id":"public/archives/index.html","hash":"372e6384a27fb43d0e808879ada15ea7491d29d5","modified":1476438453305},{"_id":"public/archives/page/2/index.html","hash":"22d16cc502b7e11ce65e381ece20f217b1489f26","modified":1476438453305},{"_id":"public/archives/page/3/index.html","hash":"1a533ae5702d427645504fa82ebfa6f1cd04ebb1","modified":1476438453305},{"_id":"public/archives/page/4/index.html","hash":"9d65932dd5b6ffca1d4a4001e615d8be7b9a8f89","modified":1476438453305},{"_id":"public/archives/page/5/index.html","hash":"5121f617dfdee5b05ae321d6f74844f59aa5f47c","modified":1476438453305},{"_id":"public/archives/page/6/index.html","hash":"4ff1eb7980d8cf6ecfa8b3d251347d92e30da6fb","modified":1476438453306},{"_id":"public/archives/2016/index.html","hash":"3491a89419c68f946e8b3435412a251f74589496","modified":1476438453306},{"_id":"public/archives/2016/page/2/index.html","hash":"9514097efa8d2c58dcdbca68251b4ea1afab16ea","modified":1476438453306},{"_id":"public/archives/2016/page/3/index.html","hash":"95c73ce4a7eab065ff03929b9fa22a57564f5bf0","modified":1476438453306},{"_id":"public/archives/2016/page/4/index.html","hash":"a386f277286179241950fae99bbdcee35150d7c7","modified":1476438453306},{"_id":"public/archives/2016/page/5/index.html","hash":"e78ded0c72ec575af8f94289490ab6b35f21f7ab","modified":1476438453306},{"_id":"public/archives/2016/page/6/index.html","hash":"3a1c1fc31bb5358816e0e1c82f6ffd526a0d6a9d","modified":1476438453306},{"_id":"public/archives/2016/08/index.html","hash":"f63c5c187084be777a0235b5a6e92a447196f0a0","modified":1476438453306},{"_id":"public/archives/2016/09/index.html","hash":"5fa88527bcd79af017e0750fdd2f1feabb3fe9bf","modified":1476438453307},{"_id":"public/archives/2016/09/page/2/index.html","hash":"90619f7791df38fb943053bc609040dfd0402b5f","modified":1476438453307},{"_id":"public/archives/2016/09/page/3/index.html","hash":"e79e4b9013a4032c79fbe99a27a0e5f9040dead6","modified":1476438453307},{"_id":"public/archives/2016/10/index.html","hash":"68de78b5fa6cb21e4f975f181ba489e49a7bf525","modified":1476438453307},{"_id":"public/archives/2016/10/page/2/index.html","hash":"407f018470dacca6c487e46d24565d13cda63131","modified":1476438453307},{"_id":"public/index.html","hash":"888161aa1b6de661b6efb2e2fb42a92b3e47eab6","modified":1476438453307},{"_id":"public/tags/单例模式/index.html","hash":"27c5e7280d6dd6eb0bf696729a27f99127fdfd31","modified":1476438453314},{"_id":"public/tags/设计模式/index.html","hash":"35b94f8ae20931bdecc4369d37f2fd8deb78d309","modified":1476438453314},{"_id":"public/tags/工厂模式/index.html","hash":"66deb44cc1f63833e1ea112fd4cef1ca2b1c11f5","modified":1476438453314},{"_id":"public/tags/注册表模式/index.html","hash":"e260117a8481dd9e5b35885f80c97778a202aaf4","modified":1476438453314},{"_id":"public/2016/10/14/PHP常见设计模式之工厂模式/index.html","hash":"4e3938578960e70a9610dbaf260abd8ea498fe55","modified":1476438453314},{"_id":"public/2016/10/14/PHP常见设计模式之单例模式/index.html","hash":"9cd97b25fdc5c918993368e04bf4a880ed493c2c","modified":1476438453315},{"_id":"public/2016/10/14/PHP常见设计模式之注册表模式/index.html","hash":"3ac98881d46005f07632d51bc01b5c1d4e5505a7","modified":1476438453315},{"_id":"public/page/2/index.html","hash":"51a7ae851c45b8200a9a0441095d746bedb23906","modified":1476438453315},{"_id":"public/page/3/index.html","hash":"92d1a7ee70b58766f4884554f906212516ca8225","modified":1476438453315},{"_id":"public/page/4/index.html","hash":"c38a42ab065d8bfae7e5991758f405de14a8b9d2","modified":1476438453315},{"_id":"public/page/5/index.html","hash":"6c68a02abd28cfc92e8d57d8c280fe154f4e1c09","modified":1476438453315},{"_id":"public/page/6/index.html","hash":"01562ba5945230555d2bf9b40c08840716580d2d","modified":1476438453315},{"_id":"public/images/avatar.gif","hash":"264082bb3a1af70d5499c7d22b0902cb454b6d12","modified":1476438453319},{"_id":"public/images/cc-by-nc-sa.svg","hash":"3031be41e8753c70508aa88e84ed8f4f653f157e","modified":1476438453319},{"_id":"public/images/cc-by-nc-nd.svg","hash":"c6524ece3f8039a5f612feaf865d21ec8a794564","modified":1476438453319},{"_id":"public/images/cc-by-nc.svg","hash":"8d39b39d88f8501c0d27f8df9aae47136ebc59b7","modified":1476438453320},{"_id":"public/images/loading.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1476438453320},{"_id":"public/images/cc-by-nd.svg","hash":"c563508ce9ced1e66948024ba1153400ac0e0621","modified":1476438453320},{"_id":"public/images/cc-zero.svg","hash":"87669bf8ac268a91d027a0a4802c92a1473e9030","modified":1476438453320},{"_id":"public/images/cc-by-sa.svg","hash":"aa4742d733c8af8d38d4c183b8adbdcab045872e","modified":1476438453320},{"_id":"public/images/quote-r.svg","hash":"e60ae504f9d99b712c793c3740c6b100d057d4ec","modified":1476438453320},{"_id":"public/images/placeholder.gif","hash":"5fbd472222feb8a22cf5b8aa5dc5b8e13af88e2b","modified":1476438453320},{"_id":"public/images/cc-by.svg","hash":"28a0a4fe355a974a5e42f68031652b76798d4f7e","modified":1476438453320},{"_id":"public/images/quote-l.svg","hash":"94e870b4c8c48da61d09522196d4dd40e277a98f","modified":1476438453320},{"_id":"public/vendors/fastclick/LICENSE","hash":"dcd5b6b43095d9e90353a28b09cb269de8d4838e","modified":1476438453320},{"_id":"public/images/searchicon.png","hash":"67727a6a969be0b2659b908518fa6706eed307b8","modified":1476438453320},{"_id":"public/vendors/font-awesome/HELP-US-OUT.txt","hash":"69a4c537d167b68a0ccf1c6febd138aeffca60d6","modified":1476438453320},{"_id":"public/vendors/fancybox/source/blank.gif","hash":"2daeaa8b5f19f0bc209d976c02bd6acb51b00b0a","modified":1476438453320},{"_id":"public/vendors/fancybox/source/fancybox_sprite.png","hash":"17df19f97628e77be09c352bf27425faea248251","modified":1476438453321},{"_id":"public/vendors/fancybox/source/fancybox_overlay.png","hash":"b3a4ee645ba494f52840ef8412015ba0f465dbe0","modified":1476438453321},{"_id":"public/vendors/fancybox/source/fancybox_loading@2x.gif","hash":"273b123496a42ba45c3416adb027cd99745058b0","modified":1476438453321},{"_id":"public/vendors/fancybox/source/fancybox_loading.gif","hash":"1a755fb2599f3a313cc6cfdb14df043f8c14a99c","modified":1476438453321},{"_id":"public/vendors/font-awesome/css/font-awesome.css.map","hash":"0189d278706509412bac4745f96c83984e1d59f4","modified":1476438453321},{"_id":"public/vendors/fancybox/source/fancybox_sprite@2x.png","hash":"30c58913f327e28f466a00f4c1ac8001b560aed8","modified":1476438453321},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.woff2","hash":"574ea2698c03ae9477db2ea3baf460ee32f1a7ea","modified":1476438453321},{"_id":"public/vendors/fancybox/source/helpers/fancybox_buttons.png","hash":"e385b139516c6813dcd64b8fc431c364ceafe5f3","modified":1476438453321},{"_id":"public/css/main.css","hash":"07d8fce51e7b43fd38ff2efc314522600fce278e","modified":1476438454080},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.woff","hash":"507970402e328b2baeb05bde73bf9ded4e2c3a2d","modified":1476438454080},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.eot","hash":"b3c2f08e73320135b69c23a3908b87a12053a2f6","modified":1476438454088},{"_id":"public/vendors/font-awesome/fonts/FontAwesome.otf","hash":"0112e96f327d413938d37c1693806f468ffdbace","modified":1476438454088},{"_id":"public/js/src/bootstrap.js","hash":"39bf93769d9080fa01a9a875183b43198f79bc19","modified":1476438454103},{"_id":"public/js/src/hook-duoshuo.js","hash":"a6119070c0119f33e08b29da7d2cce2635eb40a0","modified":1476438454103},{"_id":"public/js/src/affix.js","hash":"978e0422b5bf1b560236d8d10ebc1adcf66392e3","modified":1476438454103},{"_id":"public/js/src/motion.js","hash":"269414e84df544a4ccb88519f6abae4943db3c67","modified":1476438454104},{"_id":"public/js/src/post-details.js","hash":"2038f54e289b6da5def09689e69f623187147be5","modified":1476438454104},{"_id":"public/vendors/fastclick/README.html","hash":"da3c74d484c73cc7df565e8abbfa4d6a5a18d4da","modified":1476438454104},{"_id":"public/js/src/scrollspy.js","hash":"fe4da1b9fe73518226446f5f27d2831e4426fc35","modified":1476438454104},{"_id":"public/js/src/utils.js","hash":"e5cb720894c4bc28ca8f10b33df127fb394018d9","modified":1476438454104},{"_id":"public/vendors/fastclick/bower.json","hash":"4dcecf83afddba148464d5339c93f6d0aa9f42e9","modified":1476438454104},{"_id":"public/vendors/font-awesome/bower.json","hash":"64394a2a9aa00f8e321d8daa5e51a420f0e96dad","modified":1476438454104},{"_id":"public/vendors/jquery_lazyload/README.html","hash":"bde24335f6bc09d8801c0dcd7274f71b466552bd","modified":1476438454104},{"_id":"public/vendors/jquery_lazyload/CONTRIBUTING.html","hash":"a6358170d346af13b1452ac157b60505bec7015c","modified":1476438454104},{"_id":"public/vendors/jquery_lazyload/jquery.scrollstop.js","hash":"0e9a81785a011c98be5ea821a8ed7d411818cfd1","modified":1476438454104},{"_id":"public/vendors/jquery_lazyload/bower.json","hash":"ae3c3b61e6e7f9e1d7e3585ad854380ecc04cf53","modified":1476438454104},{"_id":"public/vendors/jquery_lazyload/jquery.lazyload.js","hash":"481fd478650e12b67c201a0ea41e92743f8b45a3","modified":1476438454104},{"_id":"public/vendors/velocity/bower.json","hash":"0ef14e7ccdfba5db6eb3f8fc6aa3b47282c36409","modified":1476438454104},{"_id":"public/vendors/velocity/velocity.ui.min.js","hash":"ed5e534cd680a25d8d14429af824f38a2c7d9908","modified":1476438454104},{"_id":"public/vendors/fancybox/source/jquery.fancybox.css","hash":"5f163444617b6cf267342f06ac166a237bb62df9","modified":1476438454104},{"_id":"public/js/src/schemes/pisces.js","hash":"7506e7490c69a200831393c38d25e91c156bd471","modified":1476438454104},{"_id":"public/vendors/fastclick/lib/fastclick.min.js","hash":"2cae0f5a6c5d6f3cb993015e6863f9483fc4de18","modified":1476438454105},{"_id":"public/vendors/ua-parser-js/dist/ua-parser.pack.js","hash":"214dad442a92d36af77ed0ca1d9092b16687f02f","modified":1476438454105},{"_id":"public/vendors/ua-parser-js/dist/ua-parser.min.js","hash":"38628e75e4412cc6f11074e03e1c6d257aae495b","modified":1476438454105},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-buttons.css","hash":"1a9d8e5c22b371fcc69d4dbbb823d9c39f04c0c8","modified":1476438454105},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-buttons.js","hash":"91e41741c2e93f732c82aaacec4cfc6e3f3ec876","modified":1476438454105},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-media.js","hash":"3bdf69ed2469e4fb57f5a95f17300eef891ff90d","modified":1476438454105},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.css","hash":"4ac329c16a5277592fc12a37cca3d72ca4ec292f","modified":1476438454105},{"_id":"public/vendors/fancybox/source/helpers/jquery.fancybox-thumbs.js","hash":"53e194f4a72e649c04fb586dd57762b8c022800b","modified":1476438454105},{"_id":"public/vendors/velocity/velocity.min.js","hash":"2f1afadc12e4cf59ef3b405308d21baa97e739c6","modified":1476438454105},{"_id":"public/vendors/velocity/velocity.ui.js","hash":"6a1d101eab3de87527bb54fcc8c7b36b79d8f0df","modified":1476438454105},{"_id":"public/vendors/jquery/index.js","hash":"41b4bfbaa96be6d1440db6e78004ade1c134e276","modified":1476438454105},{"_id":"public/vendors/fancybox/source/jquery.fancybox.pack.js","hash":"53360764b429c212f424399384417ccc233bb3be","modified":1476438454105},{"_id":"public/vendors/fancybox/source/jquery.fancybox.js","hash":"1cf3d47b5ccb7cb6e9019c64f2a88d03a64853e4","modified":1476438454105},{"_id":"public/vendors/fastclick/lib/fastclick.js","hash":"06cef196733a710e77ad7e386ced6963f092dc55","modified":1476438454105},{"_id":"public/vendors/font-awesome/css/font-awesome.css","hash":"3b87c2560832748cd06f9bfd2fd6ea8edbdae8c7","modified":1476438454119},{"_id":"public/vendors/font-awesome/css/font-awesome.min.css","hash":"05ea25bc9b3ac48993e1fee322d3bc94b49a6e22","modified":1476438454119},{"_id":"public/vendors/velocity/velocity.js","hash":"9f08181baea0cc0e906703b7e5df9111b9ef3373","modified":1476438454119},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.ttf","hash":"27cf1f2ec59aece6938c7bb2feb0e287ea778ff9","modified":1476438454119},{"_id":"public/vendors/font-awesome/fonts/fontawesome-webfont.svg","hash":"2b3c8ba7008cc014d8fb37abc6f9f49aeda83824","modified":1476438454129}],"Category":[{"name":"Apache","_id":"ciu9lbwui0004699f2035xwad"},{"name":"Linux","_id":"ciu9lbwv0000k699fq63oa3bc"},{"name":"PHP","_id":"ciu9lbwv5000q699fn0ytdkbl"},{"name":"软件工程","_id":"ciu9lbwvb000y699fcl1mbyv2"},{"name":"MySQL","_id":"ciu9lbwvm001f699f4hb9zdg8"},{"name":"Mac","_id":"ciu9lbwvw001o699f51tmox5y"},{"name":"Nginx","_id":"ciu9lbwwc0027699fq8s8yem7"},{"name":"Web","_id":"ciu9lbwxg003x699fd3b67zce"},{"name":"架构","_id":"ciu9lbwy4004m699fvlgbtsrh"}],"Data":[],"Page":[{"title":"分类","date":"2016-07-30T12:11:50.000Z","type":"categories","_content":"","source":"categories/index.md","raw":"---\ntitle: 分类\ndate: 2016-07-30 20:11:50\ntype: \"categories\"\n---\n","updated":"2016-07-30T12:13:11.000Z","path":"categories/index.html","comments":1,"layout":"page","_id":"ciu9lbwu40000699fz2r60c7f","content":"","excerpt":"","more":""},{"title":"标签","date":"2016-07-30T10:00:00.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"title: 标签\ndate: 2016-07-30 18:00:00\ntype: \"tags\"\n---\n","updated":"2016-07-30T11:30:07.000Z","path":"tags/index.html","comments":1,"layout":"page","_id":"ciu9lbx25006x699f2jriajlu","content":"","excerpt":"","more":""}],"Post":[{"title":"Apache 虚拟主机配置","date":"2016-09-05T14:10:00.000Z","_content":"虚拟主机指的是在单一机器上运行多个网站。\n* 常见的共有三种不同的配置方式。\n  * 基于域名\n  * 基于端口（需要增加相对应的 `Listen` 指令）\n  * 基于IP\n* 动态虚拟主机配置。\n\n<!-- more -->\n\n## 常规配置方式\n\n### 在`httpd.conf` 文件中启用 `httpd-vhost.conf` 配置文件\n```ini\n# Virtual hosts\nInclude conf/extra/httpd-vhosts.conf\n```\n\n### 配置 `httpd-vhosts.conf`\n\n1. 基于域名配置\n```ini\n<VirtualHost *:80>\n    ServerName domain1.com\n    DocumentRoot  \"D:\\data\\domain1.com\"\n    <Directory />\n        Options +Indexes +FollowSymLinks +ExecCGI\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n        Require all granted\n    </Directory>\n    DirectoryIndex index.php index.html\n</VirtualHost>\n```\n**注：( `Require all granted` )**\n> Apache 2.4 及以上版本访问控制与2.2有所变换，所以在2.4+的版本需要在目录下添加 `Require all granted` 否则会出现访问不到的情况。\n> [更多详情，点击查看](http://httpd.apache.org/docs/2.4/upgrading.html)\n\n2. 基于端口配置\n  - 基于端口的配置需要先在 `httpd.conf` 中添加相应端口的 `Listen` 指令。\n```ini\n#httpd.conf\nListen 81\n```\n  - `httpd-vhosts.conf`\n```ini\n<VirtualHost *:81>\n    #ServerName 10.235.65.14:81\n    DocumentRoot  \"D:\\data\\domain3.com\"\n    <Directory />\n        Options +Indexes +FollowSymLinks +ExecCGI\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n        Require all granted\n    </Directory>\n    DirectoryIndex index.php index.html\n</VirtualHost>\n```\n\n3. 基于IP地址配置\n```ini\n<VirtualHost *:80>\n    ServerName 10.235.65.14\n    DocumentRoot  \"D:\\data\\domain2.com\"\n    <Directory />\n        Options +Indexes +FollowSymLinks +ExecCGI\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n        Require all granted\n    </Directory>\n    DirectoryIndex index.php index.html\n</VirtualHost>\n```\n\n### 验证\n配置完成之后，需要重启 Apache 配置才会生效。在浏览器中输入相应的域名，IP或者端口进行查看，能正常输出我们分别设置的内容，则说明我们配置成功。\n\n\n## 动态虚拟主机配置\n上面谈到的虚拟主机配置方式，每次配置完成之后都必须重启 Apache 才能生效。并且当我们要配置多个虚拟主机时就需要增加多个 `<VirtualHost >···</VirtualHost>` ,显得繁琐。那么有没有一种更好，更有效的方式来进行配置呢？\n\n`mod_vhost_alias` 模块为我们提供了一种动态配置虚拟主机的方式。我们只需设置一个目录，将不同的站点资源按照一定的规则放到该目录下即可。并且不用修改配置文件，且不用重新启动Apache服务器。\n\n动态配置优缺点：\n* 优点：\n  * 配置文件更小，意味着Apache启动会更快，并且占用内存更少。正重要的是，更小的配置结构更易于维护，我们人为配置出错的机会更小。\n  * 添加新的虚拟主机，我们只需要根据相应的规则在指定的，目录下面创建文件即可。不需要重新配置和启动Apache。\n* 缺点：\n  * 无法针对每个虚拟主机设置不同的日志文件。如果我们有很多的虚拟主机这确实是一个非常糟糕的事情。我们可以选择将日志记录到一个管道或者FIFO，在另一端再将日志文件按照不同的虚拟主机进行分割。比如 [`aplit-logfile`](http://httpd.apache.org/docs/current/programs/split-logfile.html) 工具。\n\n### 配置方法\n* 准备\n  * 在 `httpd.conf` 中开启 `mod_vhost_alias.so` 模块,并添加一个新的子配置文件 `httpd-vhost-alias.conf` 方便我们配置。\n  ```ini\n  #开启 mod_vhost_alias.so 模块\n  LoadModule vhost_alias_module libexec/apache2/mod_vhost_alias.so\n  #去掉 LoadModule 前面的注释\n  ···\n  #添加子配置文件\n  #Include /private/etc/apache2/extra/httpd-vhost-alias.conf\n  ```\n* 配置\n  * 打开子配置文件 `httpd-vhost-alias.conf` ，添加以下配置。\n  ```ini\n  UseCanonicalName Off\n  VirtualDocumentRoot /data1/www/%0\n  <Directory \"/data1/www/\">\n    Options None\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n  </Directory>\n  ```\n  保存，并重启 Apache 。\n  \n* 测试\n  * 分别绑定不同的域名到服务器，并在 `/data1/www/` 目录下按照不同域名新建目录，将个站点的资源分别放进相应的目录。\n  ```ini\n  127.0.0.1 domain1.com\n  127.0.0.1 domain2.com\n  127.0.0.1 domain3.com\n  ```\n  ```bash\n  /data1/www/domain1.com/index.html   #this is domain1.com test text\n  /data1/www/domain2.com/index.html   #this is domain2.com test text\n  ```\n  * 浏览器分别访问 `domain1.com` 和 `domain2.com ` ，查看是否是否能够正确显示出相应内容。\n  * 在 `/data1/www/` 目录下继续添加 `/data1/www/domain3.com/index.html` ,然后继续用浏览器访问 `domain3.com` ，查看是否能将 `/data1/www/domain3.com/index.html` 的内容输出。\n\n\n* [更多配置参数及方法，请查看](http://httpd.apache.org/docs/current/vhosts/mass.html)\n","source":"_posts/Apache 虚拟主机配置.md","raw":"---\ntitle: Apache 虚拟主机配置\ndate: 2016-09-05 22:10:00\ntags:\n- Apache虚拟主机\ncategories:\n- Apache\n---\n虚拟主机指的是在单一机器上运行多个网站。\n* 常见的共有三种不同的配置方式。\n  * 基于域名\n  * 基于端口（需要增加相对应的 `Listen` 指令）\n  * 基于IP\n* 动态虚拟主机配置。\n\n<!-- more -->\n\n## 常规配置方式\n\n### 在`httpd.conf` 文件中启用 `httpd-vhost.conf` 配置文件\n```ini\n# Virtual hosts\nInclude conf/extra/httpd-vhosts.conf\n```\n\n### 配置 `httpd-vhosts.conf`\n\n1. 基于域名配置\n```ini\n<VirtualHost *:80>\n    ServerName domain1.com\n    DocumentRoot  \"D:\\data\\domain1.com\"\n    <Directory />\n        Options +Indexes +FollowSymLinks +ExecCGI\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n        Require all granted\n    </Directory>\n    DirectoryIndex index.php index.html\n</VirtualHost>\n```\n**注：( `Require all granted` )**\n> Apache 2.4 及以上版本访问控制与2.2有所变换，所以在2.4+的版本需要在目录下添加 `Require all granted` 否则会出现访问不到的情况。\n> [更多详情，点击查看](http://httpd.apache.org/docs/2.4/upgrading.html)\n\n2. 基于端口配置\n  - 基于端口的配置需要先在 `httpd.conf` 中添加相应端口的 `Listen` 指令。\n```ini\n#httpd.conf\nListen 81\n```\n  - `httpd-vhosts.conf`\n```ini\n<VirtualHost *:81>\n    #ServerName 10.235.65.14:81\n    DocumentRoot  \"D:\\data\\domain3.com\"\n    <Directory />\n        Options +Indexes +FollowSymLinks +ExecCGI\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n        Require all granted\n    </Directory>\n    DirectoryIndex index.php index.html\n</VirtualHost>\n```\n\n3. 基于IP地址配置\n```ini\n<VirtualHost *:80>\n    ServerName 10.235.65.14\n    DocumentRoot  \"D:\\data\\domain2.com\"\n    <Directory />\n        Options +Indexes +FollowSymLinks +ExecCGI\n        AllowOverride All\n        Order allow,deny\n        Allow from all\n        Require all granted\n    </Directory>\n    DirectoryIndex index.php index.html\n</VirtualHost>\n```\n\n### 验证\n配置完成之后，需要重启 Apache 配置才会生效。在浏览器中输入相应的域名，IP或者端口进行查看，能正常输出我们分别设置的内容，则说明我们配置成功。\n\n\n## 动态虚拟主机配置\n上面谈到的虚拟主机配置方式，每次配置完成之后都必须重启 Apache 才能生效。并且当我们要配置多个虚拟主机时就需要增加多个 `<VirtualHost >···</VirtualHost>` ,显得繁琐。那么有没有一种更好，更有效的方式来进行配置呢？\n\n`mod_vhost_alias` 模块为我们提供了一种动态配置虚拟主机的方式。我们只需设置一个目录，将不同的站点资源按照一定的规则放到该目录下即可。并且不用修改配置文件，且不用重新启动Apache服务器。\n\n动态配置优缺点：\n* 优点：\n  * 配置文件更小，意味着Apache启动会更快，并且占用内存更少。正重要的是，更小的配置结构更易于维护，我们人为配置出错的机会更小。\n  * 添加新的虚拟主机，我们只需要根据相应的规则在指定的，目录下面创建文件即可。不需要重新配置和启动Apache。\n* 缺点：\n  * 无法针对每个虚拟主机设置不同的日志文件。如果我们有很多的虚拟主机这确实是一个非常糟糕的事情。我们可以选择将日志记录到一个管道或者FIFO，在另一端再将日志文件按照不同的虚拟主机进行分割。比如 [`aplit-logfile`](http://httpd.apache.org/docs/current/programs/split-logfile.html) 工具。\n\n### 配置方法\n* 准备\n  * 在 `httpd.conf` 中开启 `mod_vhost_alias.so` 模块,并添加一个新的子配置文件 `httpd-vhost-alias.conf` 方便我们配置。\n  ```ini\n  #开启 mod_vhost_alias.so 模块\n  LoadModule vhost_alias_module libexec/apache2/mod_vhost_alias.so\n  #去掉 LoadModule 前面的注释\n  ···\n  #添加子配置文件\n  #Include /private/etc/apache2/extra/httpd-vhost-alias.conf\n  ```\n* 配置\n  * 打开子配置文件 `httpd-vhost-alias.conf` ，添加以下配置。\n  ```ini\n  UseCanonicalName Off\n  VirtualDocumentRoot /data1/www/%0\n  <Directory \"/data1/www/\">\n    Options None\n    AllowOverride None\n    Order allow,deny\n    Allow from all\n  </Directory>\n  ```\n  保存，并重启 Apache 。\n  \n* 测试\n  * 分别绑定不同的域名到服务器，并在 `/data1/www/` 目录下按照不同域名新建目录，将个站点的资源分别放进相应的目录。\n  ```ini\n  127.0.0.1 domain1.com\n  127.0.0.1 domain2.com\n  127.0.0.1 domain3.com\n  ```\n  ```bash\n  /data1/www/domain1.com/index.html   #this is domain1.com test text\n  /data1/www/domain2.com/index.html   #this is domain2.com test text\n  ```\n  * 浏览器分别访问 `domain1.com` 和 `domain2.com ` ，查看是否是否能够正确显示出相应内容。\n  * 在 `/data1/www/` 目录下继续添加 `/data1/www/domain3.com/index.html` ,然后继续用浏览器访问 `domain3.com` ，查看是否能将 `/data1/www/domain3.com/index.html` 的内容输出。\n\n\n* [更多配置参数及方法，请查看](http://httpd.apache.org/docs/current/vhosts/mass.html)\n","slug":"Apache 虚拟主机配置","published":1,"updated":"2016-09-06T15:17:20.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwu60001699frqkvimzp","content":"<p>虚拟主机指的是在单一机器上运行多个网站。</p>\n<ul>\n<li>常见的共有三种不同的配置方式。<ul>\n<li>基于域名</li>\n<li>基于端口（需要增加相对应的 <code>Listen</code> 指令）</li>\n<li>基于IP</li>\n</ul>\n</li>\n<li>动态虚拟主机配置。</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"常规配置方式\"><a href=\"#常规配置方式\" class=\"headerlink\" title=\"常规配置方式\"></a>常规配置方式</h2><h3 id=\"在httpd-conf-文件中启用-httpd-vhost-conf-配置文件\"><a href=\"#在httpd-conf-文件中启用-httpd-vhost-conf-配置文件\" class=\"headerlink\" title=\"在httpd.conf 文件中启用 httpd-vhost.conf 配置文件\"></a>在<code>httpd.conf</code> 文件中启用 <code>httpd-vhost.conf</code> 配置文件</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># Virtual hosts</div><div class=\"line\">Include conf/extra/httpd-vhosts.conf</div></pre></td></tr></table></figure>\n<h3 id=\"配置-httpd-vhosts-conf\"><a href=\"#配置-httpd-vhosts-conf\" class=\"headerlink\" title=\"配置 httpd-vhosts.conf\"></a>配置 <code>httpd-vhosts.conf</code></h3><ol>\n<li>基于域名配置<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;VirtualHost *:80&gt;</div><div class=\"line\">    ServerName domain1.com</div><div class=\"line\">    DocumentRoot  \"D:\\data\\domain1.com\"</div><div class=\"line\">    &lt;Directory /&gt;</div><div class=\"line\">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Order allow,deny</div><div class=\"line\">        Allow from all</div><div class=\"line\">        Require all granted</div><div class=\"line\">    &lt;/Directory&gt;</div><div class=\"line\">    DirectoryIndex index.php index.html</div><div class=\"line\">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong>注：( <code>Require all granted</code> )</strong></p>\n<blockquote>\n<p>Apache 2.4 及以上版本访问控制与2.2有所变换，所以在2.4+的版本需要在目录下添加 <code>Require all granted</code> 否则会出现访问不到的情况。<br><a href=\"http://httpd.apache.org/docs/2.4/upgrading.html\" target=\"_blank\" rel=\"external\">更多详情，点击查看</a></p>\n</blockquote>\n<ol>\n<li><p>基于端口配置</p>\n<ul>\n<li><p>基于端口的配置需要先在 <code>httpd.conf</code> 中添加相应端口的 <code>Listen</code> 指令。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">#httpd.conf</div><div class=\"line\">Listen 81</div></pre></td></tr></table></figure>\n</li>\n<li><p><code>httpd-vhosts.conf</code></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;VirtualHost *:81&gt;</div><div class=\"line\">    #ServerName 10.235.65.14:81</div><div class=\"line\">    DocumentRoot  \"D:\\data\\domain3.com\"</div><div class=\"line\">    &lt;Directory /&gt;</div><div class=\"line\">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Order allow,deny</div><div class=\"line\">        Allow from all</div><div class=\"line\">        Require all granted</div><div class=\"line\">    &lt;/Directory&gt;</div><div class=\"line\">    DirectoryIndex index.php index.html</div><div class=\"line\">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>基于IP地址配置</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;VirtualHost *:80&gt;</div><div class=\"line\">    ServerName 10.235.65.14</div><div class=\"line\">    DocumentRoot  \"D:\\data\\domain2.com\"</div><div class=\"line\">    &lt;Directory /&gt;</div><div class=\"line\">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Order allow,deny</div><div class=\"line\">        Allow from all</div><div class=\"line\">        Require all granted</div><div class=\"line\">    &lt;/Directory&gt;</div><div class=\"line\">    DirectoryIndex index.php index.html</div><div class=\"line\">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h3><p>配置完成之后，需要重启 Apache 配置才会生效。在浏览器中输入相应的域名，IP或者端口进行查看，能正常输出我们分别设置的内容，则说明我们配置成功。</p>\n<h2 id=\"动态虚拟主机配置\"><a href=\"#动态虚拟主机配置\" class=\"headerlink\" title=\"动态虚拟主机配置\"></a>动态虚拟主机配置</h2><p>上面谈到的虚拟主机配置方式，每次配置完成之后都必须重启 Apache 才能生效。并且当我们要配置多个虚拟主机时就需要增加多个 <code>&lt;VirtualHost &gt;···&lt;/VirtualHost&gt;</code> ,显得繁琐。那么有没有一种更好，更有效的方式来进行配置呢？</p>\n<p><code>mod_vhost_alias</code> 模块为我们提供了一种动态配置虚拟主机的方式。我们只需设置一个目录，将不同的站点资源按照一定的规则放到该目录下即可。并且不用修改配置文件，且不用重新启动Apache服务器。</p>\n<p>动态配置优缺点：</p>\n<ul>\n<li>优点：<ul>\n<li>配置文件更小，意味着Apache启动会更快，并且占用内存更少。正重要的是，更小的配置结构更易于维护，我们人为配置出错的机会更小。</li>\n<li>添加新的虚拟主机，我们只需要根据相应的规则在指定的，目录下面创建文件即可。不需要重新配置和启动Apache。</li>\n</ul>\n</li>\n<li>缺点：<ul>\n<li>无法针对每个虚拟主机设置不同的日志文件。如果我们有很多的虚拟主机这确实是一个非常糟糕的事情。我们可以选择将日志记录到一个管道或者FIFO，在另一端再将日志文件按照不同的虚拟主机进行分割。比如 <a href=\"http://httpd.apache.org/docs/current/programs/split-logfile.html\" target=\"_blank\" rel=\"external\"><code>aplit-logfile</code></a> 工具。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"配置方法\"><a href=\"#配置方法\" class=\"headerlink\" title=\"配置方法\"></a>配置方法</h3><ul>\n<li><p>准备</p>\n<ul>\n<li>在 <code>httpd.conf</code> 中开启 <code>mod_vhost_alias.so</code> 模块,并添加一个新的子配置文件 <code>httpd-vhost-alias.conf</code> 方便我们配置。<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">#开启 mod_vhost_alias.so 模块</div><div class=\"line\">LoadModule vhost_alias_module libexec/apache2/mod_vhost_alias.so</div><div class=\"line\">#去掉 LoadModule 前面的注释</div><div class=\"line\">···</div><div class=\"line\">#添加子配置文件</div><div class=\"line\">#Include /private/etc/apache2/extra/httpd-vhost-alias.conf</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>配置</p>\n<ul>\n<li>打开子配置文件 <code>httpd-vhost-alias.conf</code> ，添加以下配置。<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">UseCanonicalName Off</div><div class=\"line\">VirtualDocumentRoot /data1/www/%0</div><div class=\"line\">&lt;Directory \"/data1/www/\"&gt;</div><div class=\"line\">  Options None</div><div class=\"line\">  AllowOverride None</div><div class=\"line\">  Order allow,deny</div><div class=\"line\">  Allow from all</div><div class=\"line\">&lt;/Directory&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>保存，并重启 Apache 。</p>\n</li>\n<li><p>测试</p>\n<ul>\n<li>分别绑定不同的域名到服务器，并在 <code>/data1/www/</code> 目录下按照不同域名新建目录，将个站点的资源分别放进相应的目录。<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1 domain1.com</div><div class=\"line\">127.0.0.1 domain2.com</div><div class=\"line\">127.0.0.1 domain3.com</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/data1/www/domain1.com/index.html   <span class=\"comment\">#this is domain1.com test text</span></div><div class=\"line\">/data1/www/domain2.com/index.html   <span class=\"comment\">#this is domain2.com test text</span></div></pre></td></tr></table></figure>\n<ul>\n<li>浏览器分别访问 <code>domain1.com</code> 和 <code>domain2.com</code> ，查看是否是否能够正确显示出相应内容。</li>\n<li>在 <code>/data1/www/</code> 目录下继续添加 <code>/data1/www/domain3.com/index.html</code> ,然后继续用浏览器访问 <code>domain3.com</code> ，查看是否能将 <code>/data1/www/domain3.com/index.html</code> 的内容输出。</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><a href=\"http://httpd.apache.org/docs/current/vhosts/mass.html\" target=\"_blank\" rel=\"external\">更多配置参数及方法，请查看</a></li>\n</ul>\n","excerpt":"<p>虚拟主机指的是在单一机器上运行多个网站。</p>\n<ul>\n<li>常见的共有三种不同的配置方式。<ul>\n<li>基于域名</li>\n<li>基于端口（需要增加相对应的 <code>Listen</code> 指令）</li>\n<li>基于IP</li>\n</ul>\n</li>\n<li>动态虚拟主机配置。</li>\n</ul>","more":"<h2 id=\"常规配置方式\"><a href=\"#常规配置方式\" class=\"headerlink\" title=\"常规配置方式\"></a>常规配置方式</h2><h3 id=\"在httpd-conf-文件中启用-httpd-vhost-conf-配置文件\"><a href=\"#在httpd-conf-文件中启用-httpd-vhost-conf-配置文件\" class=\"headerlink\" title=\"在httpd.conf 文件中启用 httpd-vhost.conf 配置文件\"></a>在<code>httpd.conf</code> 文件中启用 <code>httpd-vhost.conf</code> 配置文件</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># Virtual hosts</div><div class=\"line\">Include conf/extra/httpd-vhosts.conf</div></pre></td></tr></table></figure>\n<h3 id=\"配置-httpd-vhosts-conf\"><a href=\"#配置-httpd-vhosts-conf\" class=\"headerlink\" title=\"配置 httpd-vhosts.conf\"></a>配置 <code>httpd-vhosts.conf</code></h3><ol>\n<li>基于域名配置<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;VirtualHost *:80&gt;</div><div class=\"line\">    ServerName domain1.com</div><div class=\"line\">    DocumentRoot  \"D:\\data\\domain1.com\"</div><div class=\"line\">    &lt;Directory /&gt;</div><div class=\"line\">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Order allow,deny</div><div class=\"line\">        Allow from all</div><div class=\"line\">        Require all granted</div><div class=\"line\">    &lt;/Directory&gt;</div><div class=\"line\">    DirectoryIndex index.php index.html</div><div class=\"line\">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong>注：( <code>Require all granted</code> )</strong></p>\n<blockquote>\n<p>Apache 2.4 及以上版本访问控制与2.2有所变换，所以在2.4+的版本需要在目录下添加 <code>Require all granted</code> 否则会出现访问不到的情况。<br><a href=\"http://httpd.apache.org/docs/2.4/upgrading.html\">更多详情，点击查看</a></p>\n</blockquote>\n<ol>\n<li><p>基于端口配置</p>\n<ul>\n<li><p>基于端口的配置需要先在 <code>httpd.conf</code> 中添加相应端口的 <code>Listen</code> 指令。</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">#httpd.conf</div><div class=\"line\">Listen 81</div></pre></td></tr></table></figure>\n</li>\n<li><p><code>httpd-vhosts.conf</code></p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;VirtualHost *:81&gt;</div><div class=\"line\">    #ServerName 10.235.65.14:81</div><div class=\"line\">    DocumentRoot  \"D:\\data\\domain3.com\"</div><div class=\"line\">    &lt;Directory /&gt;</div><div class=\"line\">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Order allow,deny</div><div class=\"line\">        Allow from all</div><div class=\"line\">        Require all granted</div><div class=\"line\">    &lt;/Directory&gt;</div><div class=\"line\">    DirectoryIndex index.php index.html</div><div class=\"line\">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>基于IP地址配置</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;VirtualHost *:80&gt;</div><div class=\"line\">    ServerName 10.235.65.14</div><div class=\"line\">    DocumentRoot  \"D:\\data\\domain2.com\"</div><div class=\"line\">    &lt;Directory /&gt;</div><div class=\"line\">        Options +Indexes +FollowSymLinks +ExecCGI</div><div class=\"line\">        AllowOverride All</div><div class=\"line\">        Order allow,deny</div><div class=\"line\">        Allow from all</div><div class=\"line\">        Require all granted</div><div class=\"line\">    &lt;/Directory&gt;</div><div class=\"line\">    DirectoryIndex index.php index.html</div><div class=\"line\">&lt;/VirtualHost&gt;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"验证\"><a href=\"#验证\" class=\"headerlink\" title=\"验证\"></a>验证</h3><p>配置完成之后，需要重启 Apache 配置才会生效。在浏览器中输入相应的域名，IP或者端口进行查看，能正常输出我们分别设置的内容，则说明我们配置成功。</p>\n<h2 id=\"动态虚拟主机配置\"><a href=\"#动态虚拟主机配置\" class=\"headerlink\" title=\"动态虚拟主机配置\"></a>动态虚拟主机配置</h2><p>上面谈到的虚拟主机配置方式，每次配置完成之后都必须重启 Apache 才能生效。并且当我们要配置多个虚拟主机时就需要增加多个 <code>&lt;VirtualHost &gt;···&lt;/VirtualHost&gt;</code> ,显得繁琐。那么有没有一种更好，更有效的方式来进行配置呢？</p>\n<p><code>mod_vhost_alias</code> 模块为我们提供了一种动态配置虚拟主机的方式。我们只需设置一个目录，将不同的站点资源按照一定的规则放到该目录下即可。并且不用修改配置文件，且不用重新启动Apache服务器。</p>\n<p>动态配置优缺点：</p>\n<ul>\n<li>优点：<ul>\n<li>配置文件更小，意味着Apache启动会更快，并且占用内存更少。正重要的是，更小的配置结构更易于维护，我们人为配置出错的机会更小。</li>\n<li>添加新的虚拟主机，我们只需要根据相应的规则在指定的，目录下面创建文件即可。不需要重新配置和启动Apache。</li>\n</ul>\n</li>\n<li>缺点：<ul>\n<li>无法针对每个虚拟主机设置不同的日志文件。如果我们有很多的虚拟主机这确实是一个非常糟糕的事情。我们可以选择将日志记录到一个管道或者FIFO，在另一端再将日志文件按照不同的虚拟主机进行分割。比如 <a href=\"http://httpd.apache.org/docs/current/programs/split-logfile.html\"><code>aplit-logfile</code></a> 工具。</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"配置方法\"><a href=\"#配置方法\" class=\"headerlink\" title=\"配置方法\"></a>配置方法</h3><ul>\n<li><p>准备</p>\n<ul>\n<li>在 <code>httpd.conf</code> 中开启 <code>mod_vhost_alias.so</code> 模块,并添加一个新的子配置文件 <code>httpd-vhost-alias.conf</code> 方便我们配置。<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">#开启 mod_vhost_alias.so 模块</div><div class=\"line\">LoadModule vhost_alias_module libexec/apache2/mod_vhost_alias.so</div><div class=\"line\">#去掉 LoadModule 前面的注释</div><div class=\"line\">···</div><div class=\"line\">#添加子配置文件</div><div class=\"line\">#Include /private/etc/apache2/extra/httpd-vhost-alias.conf</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>配置</p>\n<ul>\n<li>打开子配置文件 <code>httpd-vhost-alias.conf</code> ，添加以下配置。<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">UseCanonicalName Off</div><div class=\"line\">VirtualDocumentRoot /data1/www/%0</div><div class=\"line\">&lt;Directory \"/data1/www/\"&gt;</div><div class=\"line\">  Options None</div><div class=\"line\">  AllowOverride None</div><div class=\"line\">  Order allow,deny</div><div class=\"line\">  Allow from all</div><div class=\"line\">&lt;/Directory&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>保存，并重启 Apache 。</p>\n</li>\n<li><p>测试</p>\n<ul>\n<li>分别绑定不同的域名到服务器，并在 <code>/data1/www/</code> 目录下按照不同域名新建目录，将个站点的资源分别放进相应的目录。<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1 domain1.com</div><div class=\"line\">127.0.0.1 domain2.com</div><div class=\"line\">127.0.0.1 domain3.com</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/data1/www/domain1.com/index.html   <span class=\"comment\">#this is domain1.com test text</span></div><div class=\"line\">/data1/www/domain2.com/index.html   <span class=\"comment\">#this is domain2.com test text</span></div></pre></td></tr></table></figure>\n<ul>\n<li>浏览器分别访问 <code>domain1.com</code> 和 <code>domain2.com</code> ，查看是否是否能够正确显示出相应内容。</li>\n<li>在 <code>/data1/www/</code> 目录下继续添加 <code>/data1/www/domain3.com/index.html</code> ,然后继续用浏览器访问 <code>domain3.com</code> ，查看是否能将 <code>/data1/www/domain3.com/index.html</code> 的内容输出。</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li><a href=\"http://httpd.apache.org/docs/current/vhosts/mass.html\">更多配置参数及方法，请查看</a></li>\n</ul>"},{"title":"Apache中PHP支持模式小结","date":"2016-09-07T12:10:00.000Z","_content":"Apache通过不同的方式，能够实现对PHP支持。常见的几种支持方式有：\n- 模块支持（handler模式）\n- CGI模块\n- FastCGI模式，用Apache内置进程管理器\n- FastCGI模式，用php-fpm进程管理器\n\n<!-- more -->\n## Apache安装、PHP安装、mod_fastcgi模块安装\n### Apache 安装\n略过···\n### PHP 安装\n示例：安装PHP5.6\n\n1. 下载、解压\n```sh\n[root@iZ23a3ua2stZ ~]#wget http://cn2.php.net/distributions/php-5.6.25.tar.gz\n[root@iZ23a3ua2stZ ~]#tar -zxvf php-5.6.25.tar.gz\n```\n2. ./configure\n```sh\n[root@iZ23a3ua2stZ ~]#cd php-5.6.25\n[root@iZ23a3ua2stZ php-5.6.25]#./configure --with-apxs2=/usr/local/apache2/bin/apxs --with-mysql --enable-fpm --prefix=/usr/local/php5.6\n```\n  `--enable-fpm` 用来来激活对 FPM 的支持\n\n  `--with-apxs2` 该参数作用是把php的解释模块编译成so 文件，并自动添加到 Apache的modules中，并自动在 `httpd.conf` 中加入对应的加载指令`LoadModule php5_module modules/libphp5.so`\n> **报错1：** 在运行 `./configure` 时可能会报以下这样的错误。提示我们 运行不了 `apxs` 这个工具。\n\n  ```sh\nSorry, I cannot run apxs.  Possible reasons follow:\n1 Perl is not installed\n2 apxs was not found. Try to pass the path using --with-apxs2=/path/to/apxs\n3 Apache was not built using --enable-so (the apxs usage page is displayed)\nThe output of /usr/local/apache2/bin/apxs follows:\n./configure: /usr/local/apache2/bin/apxs: /replace/with/path/to/perl/interpreter: bad interpreter: No such file or directory\nconfigure: error: Aborting\n```\n> 之前我们在Apache模块化体系的小结中介绍过 `apxs` 实际是一个 perl 脚本。上面报错中 `/replace/with/path/to/perl/interpreter` 提示我们找不到这个文件，\n这行实际是 perl 脚本的声明，我们需要将它改成我们服务器perl脚本的地址。\n\n  ```sh\n[root@iZ23a3ua2stZ php-5.6.25]# which perl\n/usr/bin/perl\n[root@iZ23a3ua2stZ php-5.6.25]# vi /usr/local/apache2/bin/apxs\n#将第一行 `#!/replace/with/path/to/perl/interpreter` 改成 `#!/usr/bin/perl`\n```\n> **报错2：** configure: error: xml2-config not found. Please check your libxml2 installation.\n提示我们缺少 `libxml2`。安装 `libxml2`.\n```sh\n[root@iZ23a3ua2stZ php-5.6.25]#yum install libxml2\n[root@iZ23a3ua2stZ php-5.6.25]#yum install libxml2-devel -y\n```\n\n  `./configure` 成功会有如下显示。\n\n  ```sh\n+--------------------------------------------------------------------+\n| License:                                                           |\n| This software is subject to the PHP License, available in this     |\n| distribution in the file LICENSE.  By continuing this installation |\n| process, you are bound by the terms of this license agreement.     |\n| If you do not agree with the terms of this license, you must abort |\n| the installation process at this point.                            |\n+--------------------------------------------------------------------+\nThank you for using PHP.\nconfig.status: creating php5.spec\nconfig.status: creating main/build-defs.h\nconfig.status: creating scripts/phpize\nconfig.status: creating scripts/man1/phpize.1\nconfig.status: creating scripts/php-config\nconfig.status: creating scripts/man1/php-config.1\nconfig.status: creating sapi/cli/php.1\nconfig.status: creating sapi/fpm/php-fpm.conf\nconfig.status: creating sapi/fpm/init.d.php-fpm\nconfig.status: creating sapi/fpm/php-fpm.service\nconfig.status: creating sapi/fpm/php-fpm.8\nconfig.status: creating sapi/fpm/status.html\nconfig.status: creating sapi/cgi/php-cgi.1\nconfig.status: creating ext/phar/phar.1\nconfig.status: creating ext/phar/phar.phar.1\nconfig.status: creating main/php_config.h\n```\n\n3. 编译\n```sh\n[root@iZ23a3ua2stZ php-5.6.25]#make && make install\n```\n成功安装\n```\nBuild complete.\nDon't forget to run 'make test'.\nInstalling PHP SAPI module:       apache2handler\n/usr/local/apache2/build/instdso.sh SH_LIBTOOL='/usr/local/apache2/build/libtool' libphp5.la /usr/local/apache2/modules\n/usr/local/apache2/build/libtool --mode=install install libphp5.la /usr/local/apache2/modules/\nlibtool: install: install .libs/libphp5.so /usr/local/apache2/modules/libphp5.so\nlibtool: install: install .libs/libphp5.lai /usr/local/apache2/modules/libphp5.la\nlibtool: install: warning: remember to run `libtool --finish /root/php-5.6.25/libs'\nchmod 755 /usr/local/apache2/modules/libphp5.so\n[activating module `php5' in /usr/local/apache2/conf/httpd.conf]\nInstalling shared extensions:     /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/\nInstalling PHP CLI binary:        /usr/local/php5.6/bin/\nInstalling PHP CLI man page:      /usr/local/php5.6/php/man/man1/\nInstalling PHP FPM binary:        /usr/local/php5.6/sbin/\nInstalling PHP FPM config:        /usr/local/php5.6/etc/\nInstalling PHP FPM man page:      /usr/local/php5.6/php/man/man8/\nInstalling PHP FPM status page:   /usr/local/php5.6/php/php/fpm/\nInstalling PHP CGI binary:        /usr/local/php5.6/bin/\nInstalling PHP CGI man page:      /usr/local/php5.6/php/man/man1/\nInstalling build environment:     /usr/local/php5.6/lib/php/build/\nInstalling header files:           /usr/local/php5.6/include/php/\nInstalling helper programs:       /usr/local/php5.6/bin/\n  program: phpize\n  program: php-config\nInstalling man pages:             /usr/local/php5.6/php/man/man1/\n  page: phpize.1\n  page: php-config.1\nInstalling PEAR environment:      /usr/local/php5.6/lib/php/\n[PEAR] Archive_Tar    - installed: 1.4.0\n[PEAR] Console_Getopt - installed: 1.4.1\n[PEAR] Structures_Graph- installed: 1.1.1\n[PEAR] XML_Util       - installed: 1.3.0\n[PEAR] PEAR           - installed: 1.10.1\nWrote PEAR system config file at: /usr/local/php5.6/etc/pear.conf\nYou may want to add: /usr/local/php5.6/lib/php to your php.ini include_path\n/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php5.6/bin\nln -s -f phar.phar /usr/local/php5.6/bin/phar\nInstalling PDO headers:           /usr/local/php5.6/include/php/ext/pdo/\n```\n\n4. 设置配置文件\n```\ncp php.ini-development /usr/local/php5.6/lib/php.ini\n```\n\n### mod_fastcgi 模块安装\n\n1. 下载、解压\n[mod_fastcgi-2.4.6.tar.gz](http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz)\n```\n[root@iZ23a3ua2stZ ~]#wget http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz\n[root@iZ23a3ua2stZ ~]#tar -zxvf mod_fastcgi-2.4.6.tar.gz\ncd mod_fastcgi-2.4.6\n```\n2. 编译、安装\n  - 查看安装说明\n```\n[root@iZ23a3ua2stZ ~]#cd mod_fastcgi-2.4.6\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#\n#查看 安装说明文件 (Apache 1.x请查看 INSTALL 文件)\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#vi INSTALL.AP2  \n···\n$ cd <mod_fastcgi_dir>\n$ cp Makefile.AP2 Makefile\n$ make\n$ make install\nIf your Apache2 installation isn't in /usr/local/apache2, then\nset the top_dir variable when running make (or edit the\nMakefile), e.g.\n  $ make top_dir=/opt/httpd/2.0.40\nAdd an entry to httpd.conf like this:\n  LoadModule fastcgi_module modules/mod_fastcgi.so\n···\n```\n虽然说明文件里描述的很清楚，但我们按照里面的步骤进行编译时，会产生报错。于是找了一大圈问题，发现在 `apache2.4` 下安装 `mod_fastcgi 2.4.6` 编译时汇报错，需要打个补丁。\n\n3. 打补丁\n[补丁下载地址](http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff)\n```sh\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#wget http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#patch -p1 < byte-compile-against-apache24.diff\n```\n\n4. 继续编译、安装\n```\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make install\n```\n然后查看`/usr/local/apache2/modules/` 下是否已经编译成功 `mod_fastcgi.so`，\n并在 `httpd.conf` 中添加 `LoadModule fastcgi_module modules/mod_fastcgi.so` 指令。\n\n\n## 各种模式配置\n### 模块模式（最简单）\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule php5_module modules/libphp5.so\n```\n- 然后在 `httpd.conf` 中找到 `<IfModule mime_module>` 配置段，在其中添加\n```ini\nAddType application/x-httpd-php .php\nAddType application/x-httpd-php-source .phps\n```\n- 重启 Apache ,在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `Apache 2.0 Handler`.\n\n### CGI模式\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule cgid_module modules/mod_cgid.so\nLoadModule actions_module modules/mod_actions.so\n```\n> `mod_cgid` ,CGI 处理模块。在某些Unix操作系统上，在多线程服务器fork一个进程是一个代价非常大的操作，因为新进程将会复制父进程所有的线程。为了避免每次CGI调用都进行这样代价大的操作。mod_cgid 采用外部守护进程来负责分派子进程来运行CGI脚本。主服务器使用Unix套接字来与此守护进程进行通信。\n\n  > 如果在Apache编译过程中选择了多线程MPM，那么Apache将会默认安装mod_cgid模块，而不是mod_cgi。但在用户配置使用层面，mod_cgid 和 mod_cgi 基本相同，唯一例外的是，mod_cgid 通过指令 ScriptSock 给socket命名用于与CGI守护进程通信。\n\n  > `mod_actions` ,模块提供基于基于媒体类型或请求方法来执行CGI脚本的方法。该模块引入 `Action` 和 `Script` 两个指令。\n\n- 然后在 `httpd.conf` 中找到 `<IfModule mime_module>` 配置段，在其中添加\n```ini\nAddHandler php-cgi .php\nAction php-cgi \"/cgi-bin/php-cgi\"\n```\n- 然后在 `httpd.conf` 中找到 `<IfModule cgid_module>` 配置段，在其中添加\n```ini\n<IfModule cgid_module>\n    Scriptsock /var/run/cgid.sock\n</IfModule>\n```\n\n- 重启 Apache ,在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `CGI/FastCGI`.\n\n### FastCGI模式，用Apache内置进程管理器\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule fastcgi_module modules/mod_fastcgi.so\nLoadModule actions_module modules/mod_actions.so\n```\n- 然后在 `httpd.conf` 中添加 `<IfModule fastcgi_module>` 配置段\n```ini\n<IfModule fastcgi_module>\n   FastCgiServer /usr/local/apache2/cgi-bin/php-cgi -processes 20\n   AddType application/x-httpd-php .php\n   AddHandler php-fastcgi .php\n   Action php-fastcgi /cgi-bin/php-cgi\n</IfModule>\n```\n> `-processes 20` ,配置启动的进程数\n\n- 重启 Apache ,执行 `ps aux | grep php` 查看相应 php-cgi 进程是否启动\n```bash\n[root@iZ23a3ua2stZ apache2]# ps aux | grep php\ndaemon   21382  0.0  0.5  42104  5604 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21435  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21436  0.0  0.4  42104  4732 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21437  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21438  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21439  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21440  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21441  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21442  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21443  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21444  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21445  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21446  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21447  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21448  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21449  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21450  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21451  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21452  0.0  0.4  42104  4732 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21453  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\nroot     21455  0.0  0.0 112668   984 pts/0    S+   11:31   0:00 grep --color=auto php\n```\n\n- 在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `CGI/FastCGI`.\n\n### FastCGI模式，使用php-fpm进程管理器\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule fastcgi_module modules/mod_fastcgi.so\nLoadModule actions_module modules/mod_actions.so\n```\n- 然后在 `httpd.conf` 中添加 `<IfModule fastcgi_module>` 配置段\n```ini\n<IfModule fastcgi_module>\n   FastCgiExternalServer /usr/local/apache2/cgi-bin/php-cgi -host 127.0.0.1:9000\n   AddType application/x-httpd-php .php\n   AddHandler php-fastcgi .php\n   Action php-fastcgi /cgi-bin/php-cgi\n</IfModule>\n```\n> `-host 127.0.0.1:9000` ,是php-fpm的开启端口，所以我们还需要把php-fpm打开。\n\n- 启动 `php-fpm`\n```bash\n[root@iZ23a3ua2stZ apache2]# /usr/local/php5.6/sbin/php-fpm\n```\n> /usr/local/php/sbin/php-fpm{start|stop|quit|restart|reload|logrotate}\n>\n> --start 启动php的fastcgi进程\n> --stop 强制终止php的fastcgi进程\n> --quit 平滑终止php的fastcgi进程\n> --restart 重启php的fastcgi进程\n> --reload 重新平滑加载php的php.ini\n> --logrotate 重新启用log文件\n\n- 重启 Apache ,执行 `ps aux | grep php` 查看相应 php-cgi 进程是否启动\n```bash\n[root@iZ23a3ua2stZ apache2]# ps aux | grep php\n[root@iZ23a3ua2stZ apache2]# ps aux | grep php\nroot     21680  0.0  0.3 147920  3660 ?        Ss   12:41   0:00 php-fpm: master process (/usr/local/php5.6/etc/php-fpm.conf)\nnobody   21681  0.0  0.3 147920  3312 ?        S    12:41   0:00 php-fpm: pool www\nnobody   21682  0.0  0.4 147920  4888 ?        S    12:41   0:00 php-fpm: pool www\nroot     21684  0.0  0.0 112664   980 pts/3    S+   12:42   0:00 grep --color=auto php\n```\n\n- 在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `FPM/FastCGI`.\n\n## 各种模式比较\n> 有空再整理。。。\n","source":"_posts/Apache 中PHP支持模式.md","raw":"---\ntitle: Apache中PHP支持模式小结\ndate: 2016-09-07 20:10:00\ntags:\n- FastCGI\n- CGI\n- Apache&PHP\ncategories:\n- Apache\n---\nApache通过不同的方式，能够实现对PHP支持。常见的几种支持方式有：\n- 模块支持（handler模式）\n- CGI模块\n- FastCGI模式，用Apache内置进程管理器\n- FastCGI模式，用php-fpm进程管理器\n\n<!-- more -->\n## Apache安装、PHP安装、mod_fastcgi模块安装\n### Apache 安装\n略过···\n### PHP 安装\n示例：安装PHP5.6\n\n1. 下载、解压\n```sh\n[root@iZ23a3ua2stZ ~]#wget http://cn2.php.net/distributions/php-5.6.25.tar.gz\n[root@iZ23a3ua2stZ ~]#tar -zxvf php-5.6.25.tar.gz\n```\n2. ./configure\n```sh\n[root@iZ23a3ua2stZ ~]#cd php-5.6.25\n[root@iZ23a3ua2stZ php-5.6.25]#./configure --with-apxs2=/usr/local/apache2/bin/apxs --with-mysql --enable-fpm --prefix=/usr/local/php5.6\n```\n  `--enable-fpm` 用来来激活对 FPM 的支持\n\n  `--with-apxs2` 该参数作用是把php的解释模块编译成so 文件，并自动添加到 Apache的modules中，并自动在 `httpd.conf` 中加入对应的加载指令`LoadModule php5_module modules/libphp5.so`\n> **报错1：** 在运行 `./configure` 时可能会报以下这样的错误。提示我们 运行不了 `apxs` 这个工具。\n\n  ```sh\nSorry, I cannot run apxs.  Possible reasons follow:\n1 Perl is not installed\n2 apxs was not found. Try to pass the path using --with-apxs2=/path/to/apxs\n3 Apache was not built using --enable-so (the apxs usage page is displayed)\nThe output of /usr/local/apache2/bin/apxs follows:\n./configure: /usr/local/apache2/bin/apxs: /replace/with/path/to/perl/interpreter: bad interpreter: No such file or directory\nconfigure: error: Aborting\n```\n> 之前我们在Apache模块化体系的小结中介绍过 `apxs` 实际是一个 perl 脚本。上面报错中 `/replace/with/path/to/perl/interpreter` 提示我们找不到这个文件，\n这行实际是 perl 脚本的声明，我们需要将它改成我们服务器perl脚本的地址。\n\n  ```sh\n[root@iZ23a3ua2stZ php-5.6.25]# which perl\n/usr/bin/perl\n[root@iZ23a3ua2stZ php-5.6.25]# vi /usr/local/apache2/bin/apxs\n#将第一行 `#!/replace/with/path/to/perl/interpreter` 改成 `#!/usr/bin/perl`\n```\n> **报错2：** configure: error: xml2-config not found. Please check your libxml2 installation.\n提示我们缺少 `libxml2`。安装 `libxml2`.\n```sh\n[root@iZ23a3ua2stZ php-5.6.25]#yum install libxml2\n[root@iZ23a3ua2stZ php-5.6.25]#yum install libxml2-devel -y\n```\n\n  `./configure` 成功会有如下显示。\n\n  ```sh\n+--------------------------------------------------------------------+\n| License:                                                           |\n| This software is subject to the PHP License, available in this     |\n| distribution in the file LICENSE.  By continuing this installation |\n| process, you are bound by the terms of this license agreement.     |\n| If you do not agree with the terms of this license, you must abort |\n| the installation process at this point.                            |\n+--------------------------------------------------------------------+\nThank you for using PHP.\nconfig.status: creating php5.spec\nconfig.status: creating main/build-defs.h\nconfig.status: creating scripts/phpize\nconfig.status: creating scripts/man1/phpize.1\nconfig.status: creating scripts/php-config\nconfig.status: creating scripts/man1/php-config.1\nconfig.status: creating sapi/cli/php.1\nconfig.status: creating sapi/fpm/php-fpm.conf\nconfig.status: creating sapi/fpm/init.d.php-fpm\nconfig.status: creating sapi/fpm/php-fpm.service\nconfig.status: creating sapi/fpm/php-fpm.8\nconfig.status: creating sapi/fpm/status.html\nconfig.status: creating sapi/cgi/php-cgi.1\nconfig.status: creating ext/phar/phar.1\nconfig.status: creating ext/phar/phar.phar.1\nconfig.status: creating main/php_config.h\n```\n\n3. 编译\n```sh\n[root@iZ23a3ua2stZ php-5.6.25]#make && make install\n```\n成功安装\n```\nBuild complete.\nDon't forget to run 'make test'.\nInstalling PHP SAPI module:       apache2handler\n/usr/local/apache2/build/instdso.sh SH_LIBTOOL='/usr/local/apache2/build/libtool' libphp5.la /usr/local/apache2/modules\n/usr/local/apache2/build/libtool --mode=install install libphp5.la /usr/local/apache2/modules/\nlibtool: install: install .libs/libphp5.so /usr/local/apache2/modules/libphp5.so\nlibtool: install: install .libs/libphp5.lai /usr/local/apache2/modules/libphp5.la\nlibtool: install: warning: remember to run `libtool --finish /root/php-5.6.25/libs'\nchmod 755 /usr/local/apache2/modules/libphp5.so\n[activating module `php5' in /usr/local/apache2/conf/httpd.conf]\nInstalling shared extensions:     /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/\nInstalling PHP CLI binary:        /usr/local/php5.6/bin/\nInstalling PHP CLI man page:      /usr/local/php5.6/php/man/man1/\nInstalling PHP FPM binary:        /usr/local/php5.6/sbin/\nInstalling PHP FPM config:        /usr/local/php5.6/etc/\nInstalling PHP FPM man page:      /usr/local/php5.6/php/man/man8/\nInstalling PHP FPM status page:   /usr/local/php5.6/php/php/fpm/\nInstalling PHP CGI binary:        /usr/local/php5.6/bin/\nInstalling PHP CGI man page:      /usr/local/php5.6/php/man/man1/\nInstalling build environment:     /usr/local/php5.6/lib/php/build/\nInstalling header files:           /usr/local/php5.6/include/php/\nInstalling helper programs:       /usr/local/php5.6/bin/\n  program: phpize\n  program: php-config\nInstalling man pages:             /usr/local/php5.6/php/man/man1/\n  page: phpize.1\n  page: php-config.1\nInstalling PEAR environment:      /usr/local/php5.6/lib/php/\n[PEAR] Archive_Tar    - installed: 1.4.0\n[PEAR] Console_Getopt - installed: 1.4.1\n[PEAR] Structures_Graph- installed: 1.1.1\n[PEAR] XML_Util       - installed: 1.3.0\n[PEAR] PEAR           - installed: 1.10.1\nWrote PEAR system config file at: /usr/local/php5.6/etc/pear.conf\nYou may want to add: /usr/local/php5.6/lib/php to your php.ini include_path\n/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php5.6/bin\nln -s -f phar.phar /usr/local/php5.6/bin/phar\nInstalling PDO headers:           /usr/local/php5.6/include/php/ext/pdo/\n```\n\n4. 设置配置文件\n```\ncp php.ini-development /usr/local/php5.6/lib/php.ini\n```\n\n### mod_fastcgi 模块安装\n\n1. 下载、解压\n[mod_fastcgi-2.4.6.tar.gz](http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz)\n```\n[root@iZ23a3ua2stZ ~]#wget http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz\n[root@iZ23a3ua2stZ ~]#tar -zxvf mod_fastcgi-2.4.6.tar.gz\ncd mod_fastcgi-2.4.6\n```\n2. 编译、安装\n  - 查看安装说明\n```\n[root@iZ23a3ua2stZ ~]#cd mod_fastcgi-2.4.6\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#\n#查看 安装说明文件 (Apache 1.x请查看 INSTALL 文件)\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#vi INSTALL.AP2  \n···\n$ cd <mod_fastcgi_dir>\n$ cp Makefile.AP2 Makefile\n$ make\n$ make install\nIf your Apache2 installation isn't in /usr/local/apache2, then\nset the top_dir variable when running make (or edit the\nMakefile), e.g.\n  $ make top_dir=/opt/httpd/2.0.40\nAdd an entry to httpd.conf like this:\n  LoadModule fastcgi_module modules/mod_fastcgi.so\n···\n```\n虽然说明文件里描述的很清楚，但我们按照里面的步骤进行编译时，会产生报错。于是找了一大圈问题，发现在 `apache2.4` 下安装 `mod_fastcgi 2.4.6` 编译时汇报错，需要打个补丁。\n\n3. 打补丁\n[补丁下载地址](http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff)\n```sh\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#wget http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#patch -p1 < byte-compile-against-apache24.diff\n```\n\n4. 继续编译、安装\n```\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make\n[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make install\n```\n然后查看`/usr/local/apache2/modules/` 下是否已经编译成功 `mod_fastcgi.so`，\n并在 `httpd.conf` 中添加 `LoadModule fastcgi_module modules/mod_fastcgi.so` 指令。\n\n\n## 各种模式配置\n### 模块模式（最简单）\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule php5_module modules/libphp5.so\n```\n- 然后在 `httpd.conf` 中找到 `<IfModule mime_module>` 配置段，在其中添加\n```ini\nAddType application/x-httpd-php .php\nAddType application/x-httpd-php-source .phps\n```\n- 重启 Apache ,在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `Apache 2.0 Handler`.\n\n### CGI模式\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule cgid_module modules/mod_cgid.so\nLoadModule actions_module modules/mod_actions.so\n```\n> `mod_cgid` ,CGI 处理模块。在某些Unix操作系统上，在多线程服务器fork一个进程是一个代价非常大的操作，因为新进程将会复制父进程所有的线程。为了避免每次CGI调用都进行这样代价大的操作。mod_cgid 采用外部守护进程来负责分派子进程来运行CGI脚本。主服务器使用Unix套接字来与此守护进程进行通信。\n\n  > 如果在Apache编译过程中选择了多线程MPM，那么Apache将会默认安装mod_cgid模块，而不是mod_cgi。但在用户配置使用层面，mod_cgid 和 mod_cgi 基本相同，唯一例外的是，mod_cgid 通过指令 ScriptSock 给socket命名用于与CGI守护进程通信。\n\n  > `mod_actions` ,模块提供基于基于媒体类型或请求方法来执行CGI脚本的方法。该模块引入 `Action` 和 `Script` 两个指令。\n\n- 然后在 `httpd.conf` 中找到 `<IfModule mime_module>` 配置段，在其中添加\n```ini\nAddHandler php-cgi .php\nAction php-cgi \"/cgi-bin/php-cgi\"\n```\n- 然后在 `httpd.conf` 中找到 `<IfModule cgid_module>` 配置段，在其中添加\n```ini\n<IfModule cgid_module>\n    Scriptsock /var/run/cgid.sock\n</IfModule>\n```\n\n- 重启 Apache ,在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `CGI/FastCGI`.\n\n### FastCGI模式，用Apache内置进程管理器\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule fastcgi_module modules/mod_fastcgi.so\nLoadModule actions_module modules/mod_actions.so\n```\n- 然后在 `httpd.conf` 中添加 `<IfModule fastcgi_module>` 配置段\n```ini\n<IfModule fastcgi_module>\n   FastCgiServer /usr/local/apache2/cgi-bin/php-cgi -processes 20\n   AddType application/x-httpd-php .php\n   AddHandler php-fastcgi .php\n   Action php-fastcgi /cgi-bin/php-cgi\n</IfModule>\n```\n> `-processes 20` ,配置启动的进程数\n\n- 重启 Apache ,执行 `ps aux | grep php` 查看相应 php-cgi 进程是否启动\n```bash\n[root@iZ23a3ua2stZ apache2]# ps aux | grep php\ndaemon   21382  0.0  0.5  42104  5604 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21435  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21436  0.0  0.4  42104  4732 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21437  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21438  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21439  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21440  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21441  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21442  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21443  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21444  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21445  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21446  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21447  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21448  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21449  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21450  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21451  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21452  0.0  0.4  42104  4732 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\ndaemon   21453  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/local/apache2/cgi-bin/php-cgi\nroot     21455  0.0  0.0 112668   984 pts/0    S+   11:31   0:00 grep --color=auto php\n```\n\n- 在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `CGI/FastCGI`.\n\n### FastCGI模式，使用php-fpm进程管理器\n- 在 `httpd.conf` 中添加或者开启\n```ini\nLoadModule fastcgi_module modules/mod_fastcgi.so\nLoadModule actions_module modules/mod_actions.so\n```\n- 然后在 `httpd.conf` 中添加 `<IfModule fastcgi_module>` 配置段\n```ini\n<IfModule fastcgi_module>\n   FastCgiExternalServer /usr/local/apache2/cgi-bin/php-cgi -host 127.0.0.1:9000\n   AddType application/x-httpd-php .php\n   AddHandler php-fastcgi .php\n   Action php-fastcgi /cgi-bin/php-cgi\n</IfModule>\n```\n> `-host 127.0.0.1:9000` ,是php-fpm的开启端口，所以我们还需要把php-fpm打开。\n\n- 启动 `php-fpm`\n```bash\n[root@iZ23a3ua2stZ apache2]# /usr/local/php5.6/sbin/php-fpm\n```\n> /usr/local/php/sbin/php-fpm{start|stop|quit|restart|reload|logrotate}\n>\n> --start 启动php的fastcgi进程\n> --stop 强制终止php的fastcgi进程\n> --quit 平滑终止php的fastcgi进程\n> --restart 重启php的fastcgi进程\n> --reload 重新平滑加载php的php.ini\n> --logrotate 重新启用log文件\n\n- 重启 Apache ,执行 `ps aux | grep php` 查看相应 php-cgi 进程是否启动\n```bash\n[root@iZ23a3ua2stZ apache2]# ps aux | grep php\n[root@iZ23a3ua2stZ apache2]# ps aux | grep php\nroot     21680  0.0  0.3 147920  3660 ?        Ss   12:41   0:00 php-fpm: master process (/usr/local/php5.6/etc/php-fpm.conf)\nnobody   21681  0.0  0.3 147920  3312 ?        S    12:41   0:00 php-fpm: pool www\nnobody   21682  0.0  0.4 147920  4888 ?        S    12:41   0:00 php-fpm: pool www\nroot     21684  0.0  0.0 112664   980 pts/3    S+   12:42   0:00 grep --color=auto php\n```\n\n- 在站点目录下添加 `index.php`\n```php\n<?php\n    phpinfo();\n ?>\n```\n- 通过浏览器访问该文件，能够正确输出，则说明配置成功。\n> 这时 `phpinfo();` 输出的 `Server API` 应该为 `FPM/FastCGI`.\n\n## 各种模式比较\n> 有空再整理。。。\n","slug":"Apache 中PHP支持模式","published":1,"updated":"2016-09-25T10:54:12.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwuc0002699f62nsjmgy","content":"<p>Apache通过不同的方式，能够实现对PHP支持。常见的几种支持方式有：</p>\n<ul>\n<li>模块支持（handler模式）</li>\n<li>CGI模块</li>\n<li>FastCGI模式，用Apache内置进程管理器</li>\n<li>FastCGI模式，用php-fpm进程管理器</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"Apache安装、PHP安装、mod-fastcgi模块安装\"><a href=\"#Apache安装、PHP安装、mod-fastcgi模块安装\" class=\"headerlink\" title=\"Apache安装、PHP安装、mod_fastcgi模块安装\"></a>Apache安装、PHP安装、mod_fastcgi模块安装</h2><h3 id=\"Apache-安装\"><a href=\"#Apache-安装\" class=\"headerlink\" title=\"Apache 安装\"></a>Apache 安装</h3><p>略过···</p>\n<h3 id=\"PHP-安装\"><a href=\"#PHP-安装\" class=\"headerlink\" title=\"PHP 安装\"></a>PHP 安装</h3><p>示例：安装PHP5.6</p>\n<ol>\n<li><p>下载、解压</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]<span class=\"comment\">#wget http://cn2.php.net/distributions/php-5.6.25.tar.gz</span></div><div class=\"line\">[root@iZ23a3ua2stZ ~]<span class=\"comment\">#tar -zxvf php-5.6.25.tar.gz</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>./configure</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]<span class=\"comment\">#cd php-5.6.25</span></div><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#./configure --with-apxs2=/usr/local/apache2/bin/apxs --with-mysql --enable-fpm --prefix=/usr/local/php5.6</span></div></pre></td></tr></table></figure>\n<p><code>--enable-fpm</code> 用来来激活对 FPM 的支持</p>\n<p><code>--with-apxs2</code> 该参数作用是把php的解释模块编译成so 文件，并自动添加到 Apache的modules中，并自动在 <code>httpd.conf</code> 中加入对应的加载指令<code>LoadModule php5_module modules/libphp5.so</code></p>\n<blockquote>\n<p><strong>报错1：</strong> 在运行 <code>./configure</code> 时可能会报以下这样的错误。提示我们 运行不了 <code>apxs</code> 这个工具。</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">Sorry, I cannot run apxs.  Possible reasons follow:</div><div class=\"line\">1 Perl is not installed</div><div class=\"line\">2 apxs was not found. Try to pass the path using --with-apxs2=/path/to/apxs</div><div class=\"line\">3 Apache was not built using --enable-so (the apxs usage page is displayed)</div><div class=\"line\">The output of /usr/<span class=\"built_in\">local</span>/apache2/bin/apxs follows:</div><div class=\"line\">./configure: /usr/<span class=\"built_in\">local</span>/apache2/bin/apxs: /replace/with/path/to/perl/interpreter: bad interpreter: No such file or directory</div><div class=\"line\">configure: error: Aborting</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<blockquote>\n<p>之前我们在Apache模块化体系的小结中介绍过 <code>apxs</code> 实际是一个 perl 脚本。上面报错中 <code>/replace/with/path/to/perl/interpreter</code> 提示我们找不到这个文件，<br>这行实际是 perl 脚本的声明，我们需要将它改成我们服务器perl脚本的地址。</p>\n</blockquote>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\"># which perl</span></div><div class=\"line\">/usr/bin/perl</div><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\"># vi /usr/local/apache2/bin/apxs</span></div><div class=\"line\"><span class=\"comment\">#将第一行 `#!/replace/with/path/to/perl/interpreter` 改成 `#!/usr/bin/perl`</span></div></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>报错2：</strong> configure: error: xml2-config not found. Please check your libxml2 installation.<br>提示我们缺少 <code>libxml2</code>。安装 <code>libxml2</code>.<br><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#yum install libxml2</span></div><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#yum install libxml2-devel -y</span></div></pre></td></tr></table></figure></p>\n</blockquote>\n<p>  <code>./configure</code> 成功会有如下显示。</p>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\">+--------------------------------------------------------------------+</div><div class=\"line\">| License:                                                           |</div><div class=\"line\">| This software is subject to the PHP License, available <span class=\"keyword\">in</span> this     |</div><div class=\"line\">| distribution <span class=\"keyword\">in</span> the file LICENSE.  By continuing this installation |</div><div class=\"line\">| process, you are bound by the terms of this license agreement.     |</div><div class=\"line\">| If you <span class=\"keyword\">do</span> not agree with the terms of this license, you must abort |</div><div class=\"line\">| the installation process at this point.                            |</div><div class=\"line\">+--------------------------------------------------------------------+</div><div class=\"line\">Thank you <span class=\"keyword\">for</span> using PHP.</div><div class=\"line\">config.status: creating php5.spec</div><div class=\"line\">config.status: creating main/build-defs.h</div><div class=\"line\">config.status: creating scripts/phpize</div><div class=\"line\">config.status: creating scripts/man1/phpize.1</div><div class=\"line\">config.status: creating scripts/php-config</div><div class=\"line\">config.status: creating scripts/man1/php-config.1</div><div class=\"line\">config.status: creating sapi/cli/php.1</div><div class=\"line\">config.status: creating sapi/fpm/php-fpm.conf</div><div class=\"line\">config.status: creating sapi/fpm/init.d.php-fpm</div><div class=\"line\">config.status: creating sapi/fpm/php-fpm.service</div><div class=\"line\">config.status: creating sapi/fpm/php-fpm.8</div><div class=\"line\">config.status: creating sapi/fpm/status.html</div><div class=\"line\">config.status: creating sapi/cgi/php-cgi.1</div><div class=\"line\">config.status: creating ext/phar/phar.1</div><div class=\"line\">config.status: creating ext/phar/phar.phar.1</div><div class=\"line\">config.status: creating main/php_config.h</div></pre></td></tr></table></figure>\n<ol>\n<li>编译<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#make &amp;&amp; make install</span></div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>成功安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\">Build complete.</div><div class=\"line\">Don&apos;t forget to run &apos;make test&apos;.</div><div class=\"line\">Installing PHP SAPI module:       apache2handler</div><div class=\"line\">/usr/local/apache2/build/instdso.sh SH_LIBTOOL=&apos;/usr/local/apache2/build/libtool&apos; libphp5.la /usr/local/apache2/modules</div><div class=\"line\">/usr/local/apache2/build/libtool --mode=install install libphp5.la /usr/local/apache2/modules/</div><div class=\"line\">libtool: install: install .libs/libphp5.so /usr/local/apache2/modules/libphp5.so</div><div class=\"line\">libtool: install: install .libs/libphp5.lai /usr/local/apache2/modules/libphp5.la</div><div class=\"line\">libtool: install: warning: remember to run `libtool --finish /root/php-5.6.25/libs&apos;</div><div class=\"line\">chmod 755 /usr/local/apache2/modules/libphp5.so</div><div class=\"line\">[activating module `php5&apos; in /usr/local/apache2/conf/httpd.conf]</div><div class=\"line\">Installing shared extensions:     /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/</div><div class=\"line\">Installing PHP CLI binary:        /usr/local/php5.6/bin/</div><div class=\"line\">Installing PHP CLI man page:      /usr/local/php5.6/php/man/man1/</div><div class=\"line\">Installing PHP FPM binary:        /usr/local/php5.6/sbin/</div><div class=\"line\">Installing PHP FPM config:        /usr/local/php5.6/etc/</div><div class=\"line\">Installing PHP FPM man page:      /usr/local/php5.6/php/man/man8/</div><div class=\"line\">Installing PHP FPM status page:   /usr/local/php5.6/php/php/fpm/</div><div class=\"line\">Installing PHP CGI binary:        /usr/local/php5.6/bin/</div><div class=\"line\">Installing PHP CGI man page:      /usr/local/php5.6/php/man/man1/</div><div class=\"line\">Installing build environment:     /usr/local/php5.6/lib/php/build/</div><div class=\"line\">Installing header files:           /usr/local/php5.6/include/php/</div><div class=\"line\">Installing helper programs:       /usr/local/php5.6/bin/</div><div class=\"line\">  program: phpize</div><div class=\"line\">  program: php-config</div><div class=\"line\">Installing man pages:             /usr/local/php5.6/php/man/man1/</div><div class=\"line\">  page: phpize.1</div><div class=\"line\">  page: php-config.1</div><div class=\"line\">Installing PEAR environment:      /usr/local/php5.6/lib/php/</div><div class=\"line\">[PEAR] Archive_Tar    - installed: 1.4.0</div><div class=\"line\">[PEAR] Console_Getopt - installed: 1.4.1</div><div class=\"line\">[PEAR] Structures_Graph- installed: 1.1.1</div><div class=\"line\">[PEAR] XML_Util       - installed: 1.3.0</div><div class=\"line\">[PEAR] PEAR           - installed: 1.10.1</div><div class=\"line\">Wrote PEAR system config file at: /usr/local/php5.6/etc/pear.conf</div><div class=\"line\">You may want to add: /usr/local/php5.6/lib/php to your php.ini include_path</div><div class=\"line\">/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php5.6/bin</div><div class=\"line\">ln -s -f phar.phar /usr/local/php5.6/bin/phar</div><div class=\"line\">Installing PDO headers:           /usr/local/php5.6/include/php/ext/pdo/</div></pre></td></tr></table></figure></p>\n<ol>\n<li>设置配置文件<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp php.ini-development /usr/local/php5.6/lib/php.ini</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"mod-fastcgi-模块安装\"><a href=\"#mod-fastcgi-模块安装\" class=\"headerlink\" title=\"mod_fastcgi 模块安装\"></a>mod_fastcgi 模块安装</h3><ol>\n<li><p>下载、解压<br><a href=\"http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz\" target=\"_blank\" rel=\"external\">mod_fastcgi-2.4.6.tar.gz</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]#wget http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz</div><div class=\"line\">[root@iZ23a3ua2stZ ~]#tar -zxvf mod_fastcgi-2.4.6.tar.gz</div><div class=\"line\">cd mod_fastcgi-2.4.6</div></pre></td></tr></table></figure>\n</li>\n<li><p>编译、安装</p>\n<ul>\n<li>查看安装说明<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]#cd mod_fastcgi-2.4.6</div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#</div><div class=\"line\">#查看 安装说明文件 (Apache 1.x请查看 INSTALL 文件)</div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#vi INSTALL.AP2  </div><div class=\"line\">···</div><div class=\"line\">$ cd &lt;mod_fastcgi_dir&gt;</div><div class=\"line\">$ cp Makefile.AP2 Makefile</div><div class=\"line\">$ make</div><div class=\"line\">$ make install</div><div class=\"line\">If your Apache2 installation isn&apos;t in /usr/local/apache2, then</div><div class=\"line\">set the top_dir variable when running make (or edit the</div><div class=\"line\">Makefile), e.g.</div><div class=\"line\">  $ make top_dir=/opt/httpd/2.0.40</div><div class=\"line\">Add an entry to httpd.conf like this:</div><div class=\"line\">  LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class=\"line\">···</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>\n<p>虽然说明文件里描述的很清楚，但我们按照里面的步骤进行编译时，会产生报错。于是找了一大圈问题，发现在 <code>apache2.4</code> 下安装 <code>mod_fastcgi 2.4.6</code> 编译时汇报错，需要打个补丁。</p>\n<ol>\n<li><p>打补丁<br><a href=\"http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff\" target=\"_blank\" rel=\"external\">补丁下载地址</a></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]<span class=\"comment\">#wget http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff</span></div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]<span class=\"comment\">#patch -p1 &lt; byte-compile-against-apache24.diff</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>继续编译、安装</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make</div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make install</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>然后查看<code>/usr/local/apache2/modules/</code> 下是否已经编译成功 <code>mod_fastcgi.so</code>，<br>并在 <code>httpd.conf</code> 中添加 <code>LoadModule fastcgi_module modules/mod_fastcgi.so</code> 指令。</p>\n<h2 id=\"各种模式配置\"><a href=\"#各种模式配置\" class=\"headerlink\" title=\"各种模式配置\"></a>各种模式配置</h2><h3 id=\"模块模式（最简单）\"><a href=\"#模块模式（最简单）\" class=\"headerlink\" title=\"模块模式（最简单）\"></a>模块模式（最简单）</h3><ul>\n<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule php5_module modules/libphp5.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule mime_module&gt;</code> 配置段，在其中添加</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">AddType application/x-httpd-php .php</div><div class=\"line\">AddType application/x-httpd-php-source .phps</div></pre></td></tr></table></figure>\n</li>\n<li><p>重启 Apache ,在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>Apache 2.0 Handler</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"CGI模式\"><a href=\"#CGI模式\" class=\"headerlink\" title=\"CGI模式\"></a>CGI模式</h3><ul>\n<li>在 <code>httpd.conf</code> 中添加或者开启<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule cgid_module modules/mod_cgid.so</div><div class=\"line\">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><code>mod_cgid</code> ,CGI 处理模块。在某些Unix操作系统上，在多线程服务器fork一个进程是一个代价非常大的操作，因为新进程将会复制父进程所有的线程。为了避免每次CGI调用都进行这样代价大的操作。mod_cgid 采用外部守护进程来负责分派子进程来运行CGI脚本。主服务器使用Unix套接字来与此守护进程进行通信。</p>\n<p>如果在Apache编译过程中选择了多线程MPM，那么Apache将会默认安装mod_cgid模块，而不是mod_cgi。但在用户配置使用层面，mod_cgid 和 mod_cgi 基本相同，唯一例外的是，mod_cgid 通过指令 ScriptSock 给socket命名用于与CGI守护进程通信。</p>\n<p><code>mod_actions</code> ,模块提供基于基于媒体类型或请求方法来执行CGI脚本的方法。该模块引入 <code>Action</code> 和 <code>Script</code> 两个指令。</p>\n</blockquote>\n<ul>\n<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule mime_module&gt;</code> 配置段，在其中添加</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">AddHandler php-cgi .php</div><div class=\"line\">Action php-cgi \"/cgi-bin/php-cgi\"</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule cgid_module&gt;</code> 配置段，在其中添加</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule cgid_module&gt;</div><div class=\"line\">    Scriptsock /var/run/cgid.sock</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n</li>\n<li><p>重启 Apache ,在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>CGI/FastCGI</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"FastCGI模式，用Apache内置进程管理器\"><a href=\"#FastCGI模式，用Apache内置进程管理器\" class=\"headerlink\" title=\"FastCGI模式，用Apache内置进程管理器\"></a>FastCGI模式，用Apache内置进程管理器</h3><ul>\n<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class=\"line\">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中添加 <code>&lt;IfModule fastcgi_module&gt;</code> 配置段</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule fastcgi_module&gt;</div><div class=\"line\">   FastCgiServer /usr/local/apache2/cgi-bin/php-cgi -processes 20</div><div class=\"line\">   AddType application/x-httpd-php .php</div><div class=\"line\">   AddHandler php-fastcgi .php</div><div class=\"line\">   Action php-fastcgi /cgi-bin/php-cgi</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><code>-processes 20</code> ,配置启动的进程数</p>\n</blockquote>\n<ul>\n<li><p>重启 Apache ,执行 <code>ps aux | grep php</code> 查看相应 php-cgi 进程是否启动</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># ps aux | grep php</span></div><div class=\"line\">daemon   21382  0.0  0.5  42104  5604 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21435  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21436  0.0  0.4  42104  4732 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21437  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21438  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21439  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21440  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21441  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21442  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21443  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21444  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21445  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21446  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21447  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21448  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21449  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21450  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21451  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21452  0.0  0.4  42104  4732 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21453  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">root     21455  0.0  0.0 112668   984 pts/0    S+   11:31   0:00 grep --color=auto php</div></pre></td></tr></table></figure>\n</li>\n<li><p>在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>CGI/FastCGI</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"FastCGI模式，使用php-fpm进程管理器\"><a href=\"#FastCGI模式，使用php-fpm进程管理器\" class=\"headerlink\" title=\"FastCGI模式，使用php-fpm进程管理器\"></a>FastCGI模式，使用php-fpm进程管理器</h3><ul>\n<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class=\"line\">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中添加 <code>&lt;IfModule fastcgi_module&gt;</code> 配置段</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule fastcgi_module&gt;</div><div class=\"line\">   FastCgiExternalServer /usr/local/apache2/cgi-bin/php-cgi -host 127.0.0.1:9000</div><div class=\"line\">   AddType application/x-httpd-php .php</div><div class=\"line\">   AddHandler php-fastcgi .php</div><div class=\"line\">   Action php-fastcgi /cgi-bin/php-cgi</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><code>-host 127.0.0.1:9000</code> ,是php-fpm的开启端口，所以我们还需要把php-fpm打开。</p>\n</blockquote>\n<ul>\n<li>启动 <code>php-fpm</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># /usr/local/php5.6/sbin/php-fpm</span></div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>/usr/local/php/sbin/php-fpm{start|stop|quit|restart|reload|logrotate}</p>\n<p>–start 启动php的fastcgi进程<br>–stop 强制终止php的fastcgi进程<br>–quit 平滑终止php的fastcgi进程<br>–restart 重启php的fastcgi进程<br>–reload 重新平滑加载php的php.ini<br>–logrotate 重新启用log文件</p>\n</blockquote>\n<ul>\n<li><p>重启 Apache ,执行 <code>ps aux | grep php</code> 查看相应 php-cgi 进程是否启动</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># ps aux | grep php</span></div><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># ps aux | grep php</span></div><div class=\"line\">root     21680  0.0  0.3 147920  3660 ?        Ss   12:41   0:00 php-fpm: master process (/usr/<span class=\"built_in\">local</span>/php5.6/etc/php-fpm.conf)</div><div class=\"line\">nobody   21681  0.0  0.3 147920  3312 ?        S    12:41   0:00 php-fpm: pool www</div><div class=\"line\">nobody   21682  0.0  0.4 147920  4888 ?        S    12:41   0:00 php-fpm: pool www</div><div class=\"line\">root     21684  0.0  0.0 112664   980 pts/3    S+   12:42   0:00 grep --color=auto php</div></pre></td></tr></table></figure>\n</li>\n<li><p>在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>FPM/FastCGI</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"各种模式比较\"><a href=\"#各种模式比较\" class=\"headerlink\" title=\"各种模式比较\"></a>各种模式比较</h2><blockquote>\n<p>有空再整理。。。</p>\n</blockquote>\n","excerpt":"<p>Apache通过不同的方式，能够实现对PHP支持。常见的几种支持方式有：</p>\n<ul>\n<li>模块支持（handler模式）</li>\n<li>CGI模块</li>\n<li>FastCGI模式，用Apache内置进程管理器</li>\n<li>FastCGI模式，用php-fpm进程管理器</li>\n</ul>","more":"<h2 id=\"Apache安装、PHP安装、mod-fastcgi模块安装\"><a href=\"#Apache安装、PHP安装、mod-fastcgi模块安装\" class=\"headerlink\" title=\"Apache安装、PHP安装、mod_fastcgi模块安装\"></a>Apache安装、PHP安装、mod_fastcgi模块安装</h2><h3 id=\"Apache-安装\"><a href=\"#Apache-安装\" class=\"headerlink\" title=\"Apache 安装\"></a>Apache 安装</h3><p>略过···</p>\n<h3 id=\"PHP-安装\"><a href=\"#PHP-安装\" class=\"headerlink\" title=\"PHP 安装\"></a>PHP 安装</h3><p>示例：安装PHP5.6</p>\n<ol>\n<li><p>下载、解压</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]<span class=\"comment\">#wget http://cn2.php.net/distributions/php-5.6.25.tar.gz</span></div><div class=\"line\">[root@iZ23a3ua2stZ ~]<span class=\"comment\">#tar -zxvf php-5.6.25.tar.gz</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>./configure</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]<span class=\"comment\">#cd php-5.6.25</span></div><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#./configure --with-apxs2=/usr/local/apache2/bin/apxs --with-mysql --enable-fpm --prefix=/usr/local/php5.6</span></div></pre></td></tr></table></figure>\n<p><code>--enable-fpm</code> 用来来激活对 FPM 的支持</p>\n<p><code>--with-apxs2</code> 该参数作用是把php的解释模块编译成so 文件，并自动添加到 Apache的modules中，并自动在 <code>httpd.conf</code> 中加入对应的加载指令<code>LoadModule php5_module modules/libphp5.so</code></p>\n<blockquote>\n<p><strong>报错1：</strong> 在运行 <code>./configure</code> 时可能会报以下这样的错误。提示我们 运行不了 <code>apxs</code> 这个工具。</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">Sorry, I cannot run apxs.  Possible reasons follow:</div><div class=\"line\">1 Perl is not installed</div><div class=\"line\">2 apxs was not found. Try to pass the path using --with-apxs2=/path/to/apxs</div><div class=\"line\">3 Apache was not built using --enable-so (the apxs usage page is displayed)</div><div class=\"line\">The output of /usr/<span class=\"built_in\">local</span>/apache2/bin/apxs follows:</div><div class=\"line\">./configure: /usr/<span class=\"built_in\">local</span>/apache2/bin/apxs: /replace/with/path/to/perl/interpreter: bad interpreter: No such file or directory</div><div class=\"line\">configure: error: Aborting</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<blockquote>\n<p>之前我们在Apache模块化体系的小结中介绍过 <code>apxs</code> 实际是一个 perl 脚本。上面报错中 <code>/replace/with/path/to/perl/interpreter</code> 提示我们找不到这个文件，<br>这行实际是 perl 脚本的声明，我们需要将它改成我们服务器perl脚本的地址。</p>\n</blockquote>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\"># which perl</span></div><div class=\"line\">/usr/bin/perl</div><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\"># vi /usr/local/apache2/bin/apxs</span></div><div class=\"line\"><span class=\"comment\">#将第一行 `#!/replace/with/path/to/perl/interpreter` 改成 `#!/usr/bin/perl`</span></div></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>报错2：</strong> configure: error: xml2-config not found. Please check your libxml2 installation.<br>提示我们缺少 <code>libxml2</code>。安装 <code>libxml2</code>.<br><figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#yum install libxml2</span></div><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#yum install libxml2-devel -y</span></div></pre></td></tr></table></figure></p>\n</blockquote>\n<p>  <code>./configure</code> 成功会有如下显示。</p>\n  <figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\">+--------------------------------------------------------------------+</div><div class=\"line\">| License:                                                           |</div><div class=\"line\">| This software is subject to the PHP License, available <span class=\"keyword\">in</span> this     |</div><div class=\"line\">| distribution <span class=\"keyword\">in</span> the file LICENSE.  By continuing this installation |</div><div class=\"line\">| process, you are bound by the terms of this license agreement.     |</div><div class=\"line\">| If you <span class=\"keyword\">do</span> not agree with the terms of this license, you must abort |</div><div class=\"line\">| the installation process at this point.                            |</div><div class=\"line\">+--------------------------------------------------------------------+</div><div class=\"line\">Thank you <span class=\"keyword\">for</span> using PHP.</div><div class=\"line\">config.status: creating php5.spec</div><div class=\"line\">config.status: creating main/build-defs.h</div><div class=\"line\">config.status: creating scripts/phpize</div><div class=\"line\">config.status: creating scripts/man1/phpize.1</div><div class=\"line\">config.status: creating scripts/php-config</div><div class=\"line\">config.status: creating scripts/man1/php-config.1</div><div class=\"line\">config.status: creating sapi/cli/php.1</div><div class=\"line\">config.status: creating sapi/fpm/php-fpm.conf</div><div class=\"line\">config.status: creating sapi/fpm/init.d.php-fpm</div><div class=\"line\">config.status: creating sapi/fpm/php-fpm.service</div><div class=\"line\">config.status: creating sapi/fpm/php-fpm.8</div><div class=\"line\">config.status: creating sapi/fpm/status.html</div><div class=\"line\">config.status: creating sapi/cgi/php-cgi.1</div><div class=\"line\">config.status: creating ext/phar/phar.1</div><div class=\"line\">config.status: creating ext/phar/phar.phar.1</div><div class=\"line\">config.status: creating main/php_config.h</div></pre></td></tr></table></figure>\n<ol>\n<li>编译<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ php-5.6.25]<span class=\"comment\">#make &amp;&amp; make install</span></div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>成功安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div></pre></td><td class=\"code\"><pre><div class=\"line\">Build complete.</div><div class=\"line\">Don&apos;t forget to run &apos;make test&apos;.</div><div class=\"line\">Installing PHP SAPI module:       apache2handler</div><div class=\"line\">/usr/local/apache2/build/instdso.sh SH_LIBTOOL=&apos;/usr/local/apache2/build/libtool&apos; libphp5.la /usr/local/apache2/modules</div><div class=\"line\">/usr/local/apache2/build/libtool --mode=install install libphp5.la /usr/local/apache2/modules/</div><div class=\"line\">libtool: install: install .libs/libphp5.so /usr/local/apache2/modules/libphp5.so</div><div class=\"line\">libtool: install: install .libs/libphp5.lai /usr/local/apache2/modules/libphp5.la</div><div class=\"line\">libtool: install: warning: remember to run `libtool --finish /root/php-5.6.25/libs&apos;</div><div class=\"line\">chmod 755 /usr/local/apache2/modules/libphp5.so</div><div class=\"line\">[activating module `php5&apos; in /usr/local/apache2/conf/httpd.conf]</div><div class=\"line\">Installing shared extensions:     /usr/local/php5.6/lib/php/extensions/no-debug-zts-20131226/</div><div class=\"line\">Installing PHP CLI binary:        /usr/local/php5.6/bin/</div><div class=\"line\">Installing PHP CLI man page:      /usr/local/php5.6/php/man/man1/</div><div class=\"line\">Installing PHP FPM binary:        /usr/local/php5.6/sbin/</div><div class=\"line\">Installing PHP FPM config:        /usr/local/php5.6/etc/</div><div class=\"line\">Installing PHP FPM man page:      /usr/local/php5.6/php/man/man8/</div><div class=\"line\">Installing PHP FPM status page:   /usr/local/php5.6/php/php/fpm/</div><div class=\"line\">Installing PHP CGI binary:        /usr/local/php5.6/bin/</div><div class=\"line\">Installing PHP CGI man page:      /usr/local/php5.6/php/man/man1/</div><div class=\"line\">Installing build environment:     /usr/local/php5.6/lib/php/build/</div><div class=\"line\">Installing header files:           /usr/local/php5.6/include/php/</div><div class=\"line\">Installing helper programs:       /usr/local/php5.6/bin/</div><div class=\"line\">  program: phpize</div><div class=\"line\">  program: php-config</div><div class=\"line\">Installing man pages:             /usr/local/php5.6/php/man/man1/</div><div class=\"line\">  page: phpize.1</div><div class=\"line\">  page: php-config.1</div><div class=\"line\">Installing PEAR environment:      /usr/local/php5.6/lib/php/</div><div class=\"line\">[PEAR] Archive_Tar    - installed: 1.4.0</div><div class=\"line\">[PEAR] Console_Getopt - installed: 1.4.1</div><div class=\"line\">[PEAR] Structures_Graph- installed: 1.1.1</div><div class=\"line\">[PEAR] XML_Util       - installed: 1.3.0</div><div class=\"line\">[PEAR] PEAR           - installed: 1.10.1</div><div class=\"line\">Wrote PEAR system config file at: /usr/local/php5.6/etc/pear.conf</div><div class=\"line\">You may want to add: /usr/local/php5.6/lib/php to your php.ini include_path</div><div class=\"line\">/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php5.6/bin</div><div class=\"line\">ln -s -f phar.phar /usr/local/php5.6/bin/phar</div><div class=\"line\">Installing PDO headers:           /usr/local/php5.6/include/php/ext/pdo/</div></pre></td></tr></table></figure></p>\n<ol>\n<li>设置配置文件<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp php.ini-development /usr/local/php5.6/lib/php.ini</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"mod-fastcgi-模块安装\"><a href=\"#mod-fastcgi-模块安装\" class=\"headerlink\" title=\"mod_fastcgi 模块安装\"></a>mod_fastcgi 模块安装</h3><ol>\n<li><p>下载、解压<br><a href=\"http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz\">mod_fastcgi-2.4.6.tar.gz</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]#wget http://n.sinaimg.cn/games/3ece443e/20160907/mod_fastcgi-2.4.6.tar.gz</div><div class=\"line\">[root@iZ23a3ua2stZ ~]#tar -zxvf mod_fastcgi-2.4.6.tar.gz</div><div class=\"line\">cd mod_fastcgi-2.4.6</div></pre></td></tr></table></figure>\n</li>\n<li><p>编译、安装</p>\n<ul>\n<li>查看安装说明<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ ~]#cd mod_fastcgi-2.4.6</div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#</div><div class=\"line\">#查看 安装说明文件 (Apache 1.x请查看 INSTALL 文件)</div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#vi INSTALL.AP2  </div><div class=\"line\">···</div><div class=\"line\">$ cd &lt;mod_fastcgi_dir&gt;</div><div class=\"line\">$ cp Makefile.AP2 Makefile</div><div class=\"line\">$ make</div><div class=\"line\">$ make install</div><div class=\"line\">If your Apache2 installation isn&apos;t in /usr/local/apache2, then</div><div class=\"line\">set the top_dir variable when running make (or edit the</div><div class=\"line\">Makefile), e.g.</div><div class=\"line\">  $ make top_dir=/opt/httpd/2.0.40</div><div class=\"line\">Add an entry to httpd.conf like this:</div><div class=\"line\">  LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class=\"line\">···</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ol>\n<p>虽然说明文件里描述的很清楚，但我们按照里面的步骤进行编译时，会产生报错。于是找了一大圈问题，发现在 <code>apache2.4</code> 下安装 <code>mod_fastcgi 2.4.6</code> 编译时汇报错，需要打个补丁。</p>\n<ol>\n<li><p>打补丁<br><a href=\"http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff\">补丁下载地址</a></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]<span class=\"comment\">#wget http://n.sinaimg.cn/games/3ece443e/20160907/byte-compile-against-apache24.diff</span></div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]<span class=\"comment\">#patch -p1 &lt; byte-compile-against-apache24.diff</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>继续编译、安装</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make</div><div class=\"line\">[root@iZ23a3ua2stZ mod_fastcgi-2.4.6]#make install</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>然后查看<code>/usr/local/apache2/modules/</code> 下是否已经编译成功 <code>mod_fastcgi.so</code>，<br>并在 <code>httpd.conf</code> 中添加 <code>LoadModule fastcgi_module modules/mod_fastcgi.so</code> 指令。</p>\n<h2 id=\"各种模式配置\"><a href=\"#各种模式配置\" class=\"headerlink\" title=\"各种模式配置\"></a>各种模式配置</h2><h3 id=\"模块模式（最简单）\"><a href=\"#模块模式（最简单）\" class=\"headerlink\" title=\"模块模式（最简单）\"></a>模块模式（最简单）</h3><ul>\n<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule php5_module modules/libphp5.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule mime_module&gt;</code> 配置段，在其中添加</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">AddType application/x-httpd-php .php</div><div class=\"line\">AddType application/x-httpd-php-source .phps</div></pre></td></tr></table></figure>\n</li>\n<li><p>重启 Apache ,在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>Apache 2.0 Handler</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"CGI模式\"><a href=\"#CGI模式\" class=\"headerlink\" title=\"CGI模式\"></a>CGI模式</h3><ul>\n<li>在 <code>httpd.conf</code> 中添加或者开启<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule cgid_module modules/mod_cgid.so</div><div class=\"line\">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><code>mod_cgid</code> ,CGI 处理模块。在某些Unix操作系统上，在多线程服务器fork一个进程是一个代价非常大的操作，因为新进程将会复制父进程所有的线程。为了避免每次CGI调用都进行这样代价大的操作。mod_cgid 采用外部守护进程来负责分派子进程来运行CGI脚本。主服务器使用Unix套接字来与此守护进程进行通信。</p>\n<p>如果在Apache编译过程中选择了多线程MPM，那么Apache将会默认安装mod_cgid模块，而不是mod_cgi。但在用户配置使用层面，mod_cgid 和 mod_cgi 基本相同，唯一例外的是，mod_cgid 通过指令 ScriptSock 给socket命名用于与CGI守护进程通信。</p>\n<p><code>mod_actions</code> ,模块提供基于基于媒体类型或请求方法来执行CGI脚本的方法。该模块引入 <code>Action</code> 和 <code>Script</code> 两个指令。</p>\n</blockquote>\n<ul>\n<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule mime_module&gt;</code> 配置段，在其中添加</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">AddHandler php-cgi .php</div><div class=\"line\">Action php-cgi \"/cgi-bin/php-cgi\"</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中找到 <code>&lt;IfModule cgid_module&gt;</code> 配置段，在其中添加</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule cgid_module&gt;</div><div class=\"line\">    Scriptsock /var/run/cgid.sock</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n</li>\n<li><p>重启 Apache ,在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>CGI/FastCGI</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"FastCGI模式，用Apache内置进程管理器\"><a href=\"#FastCGI模式，用Apache内置进程管理器\" class=\"headerlink\" title=\"FastCGI模式，用Apache内置进程管理器\"></a>FastCGI模式，用Apache内置进程管理器</h3><ul>\n<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class=\"line\">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中添加 <code>&lt;IfModule fastcgi_module&gt;</code> 配置段</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule fastcgi_module&gt;</div><div class=\"line\">   FastCgiServer /usr/local/apache2/cgi-bin/php-cgi -processes 20</div><div class=\"line\">   AddType application/x-httpd-php .php</div><div class=\"line\">   AddHandler php-fastcgi .php</div><div class=\"line\">   Action php-fastcgi /cgi-bin/php-cgi</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><code>-processes 20</code> ,配置启动的进程数</p>\n</blockquote>\n<ul>\n<li><p>重启 Apache ,执行 <code>ps aux | grep php</code> 查看相应 php-cgi 进程是否启动</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># ps aux | grep php</span></div><div class=\"line\">daemon   21382  0.0  0.5  42104  5604 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21435  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21436  0.0  0.4  42104  4732 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21437  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21438  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21439  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21440  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21441  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21442  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21443  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21444  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21445  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21446  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21447  0.0  0.4  42104  4724 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21448  0.0  0.4  42104  4728 ?        S    11:30   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21449  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21450  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21451  0.0  0.4  42104  4724 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21452  0.0  0.4  42104  4732 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">daemon   21453  0.0  0.4  42104  4728 ?        S    11:31   0:00 /usr/<span class=\"built_in\">local</span>/apache2/cgi-bin/php-cgi</div><div class=\"line\">root     21455  0.0  0.0 112668   984 pts/0    S+   11:31   0:00 grep --color=auto php</div></pre></td></tr></table></figure>\n</li>\n<li><p>在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>CGI/FastCGI</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"FastCGI模式，使用php-fpm进程管理器\"><a href=\"#FastCGI模式，使用php-fpm进程管理器\" class=\"headerlink\" title=\"FastCGI模式，使用php-fpm进程管理器\"></a>FastCGI模式，使用php-fpm进程管理器</h3><ul>\n<li><p>在 <code>httpd.conf</code> 中添加或者开启</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule fastcgi_module modules/mod_fastcgi.so</div><div class=\"line\">LoadModule actions_module modules/mod_actions.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>然后在 <code>httpd.conf</code> 中添加 <code>&lt;IfModule fastcgi_module&gt;</code> 配置段</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule fastcgi_module&gt;</div><div class=\"line\">   FastCgiExternalServer /usr/local/apache2/cgi-bin/php-cgi -host 127.0.0.1:9000</div><div class=\"line\">   AddType application/x-httpd-php .php</div><div class=\"line\">   AddHandler php-fastcgi .php</div><div class=\"line\">   Action php-fastcgi /cgi-bin/php-cgi</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p><code>-host 127.0.0.1:9000</code> ,是php-fpm的开启端口，所以我们还需要把php-fpm打开。</p>\n</blockquote>\n<ul>\n<li>启动 <code>php-fpm</code><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># /usr/local/php5.6/sbin/php-fpm</span></div></pre></td></tr></table></figure>\n</li>\n</ul>\n<blockquote>\n<p>/usr/local/php/sbin/php-fpm{start|stop|quit|restart|reload|logrotate}</p>\n<p>–start 启动php的fastcgi进程<br>–stop 强制终止php的fastcgi进程<br>–quit 平滑终止php的fastcgi进程<br>–restart 重启php的fastcgi进程<br>–reload 重新平滑加载php的php.ini<br>–logrotate 重新启用log文件</p>\n</blockquote>\n<ul>\n<li><p>重启 Apache ,执行 <code>ps aux | grep php</code> 查看相应 php-cgi 进程是否启动</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># ps aux | grep php</span></div><div class=\"line\">[root@iZ23a3ua2stZ apache2]<span class=\"comment\"># ps aux | grep php</span></div><div class=\"line\">root     21680  0.0  0.3 147920  3660 ?        Ss   12:41   0:00 php-fpm: master process (/usr/<span class=\"built_in\">local</span>/php5.6/etc/php-fpm.conf)</div><div class=\"line\">nobody   21681  0.0  0.3 147920  3312 ?        S    12:41   0:00 php-fpm: pool www</div><div class=\"line\">nobody   21682  0.0  0.4 147920  4888 ?        S    12:41   0:00 php-fpm: pool www</div><div class=\"line\">root     21684  0.0  0.0 112664   980 pts/3    S+   12:42   0:00 grep --color=auto php</div></pre></td></tr></table></figure>\n</li>\n<li><p>在站点目录下添加 <code>index.php</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">    phpinfo();</div><div class=\"line\"> <span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>通过浏览器访问该文件，能够正确输出，则说明配置成功。</p>\n<blockquote>\n<p>这时 <code>phpinfo();</code> 输出的 <code>Server API</code> 应该为 <code>FPM/FastCGI</code>.</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"各种模式比较\"><a href=\"#各种模式比较\" class=\"headerlink\" title=\"各种模式比较\"></a>各种模式比较</h2><blockquote>\n<p>有空再整理。。。</p>\n</blockquote>"},{"title":"Apache分层与模块化体系结构小结","date":"2016-08-26T02:10:00.000Z","_content":"\n## Apache的分层体系结构\n最新版本的Apache按照其功能一般会被划分为五层，\n1. 操作系统平台功能层\n> 各操作系统本身提供的底层功能，比如进程、线程管理,进程和线程之间通信、网络套接字通信、文件操作等\n\n2. 可移植运行库层（操作系统适配层）\n> 封装不同操作系统的底层细节，向上提供统一的接口。\n\n3. Apache核心功能层\n> 提供最基本的HTTP服务功能，对其他模块提供对应的API。\n\n4. Apache可选功能层\n> 这一层通常指 Apache模块，Apache核心功能层提供不了的功能交给不同的Apache模块来处理。\n\n5. Apache第三方功能层\n> Apache的一些模块中用到的一些第三方开发的类库等\n\n![Apache的分层体系结构](http://n.sinaimg.cn/games/3ece443e/20160826/apacheFenCengYuMoKuaiHuaTiXiJieGou.png)\n\n<!-- more -->\n\n**Apache源码目录结构简介**\n\n```\nbuild/    #\ndocs/     #包含一些相关文档\ninclude/  #包含一些必须的头文件\nmodules/  #包含Apache的各种模块\nos/       #各种操作系统的依赖文件\nserver/   #Apache核心功能（请求处理、协议处理、多处理模块mpm等）\nsrclib/   #Apache开发和运行需要的基础库（Apr_util,apr,pcre）\nsupport/  #一些辅助工具等\ntest/     #APR的测试函数\n```\n\n### 操作系统平台功能层\nApache实质上还是运行在操作系统上面的应用程序，因此必须使用操作系统本身提供的底层功能，比如进程和线程、进程和线程的通信，网络套接字通信和文件操作等。\n\n### 可移植运行库（操作系统适配层，APR）\nAPR(Apache portable runtime) 是操作系统的适配层，通过APR也实现了Apache的跨平台。因为不同的操作系统提供的底层API不同，也就是实现同一个操作所用的函数方法不同，这时在Apache和操作系统中间设计一个APR，这样APR根据不同的操作系统分别实现一个相同的功能，这样apache可以调用APR的提供的一个API接口。\n\n\n例如，如果Apache要创建一个进程，这时会调用 APR中的 apr_proc_create()函数，此时APR会自动识别操作系统的类型根据不同的类型调用操作系统通过的API，如是Unix系列则会调用unix中的fork()方法实现创建进程；如果是windows系统，则调用createProcess()创建进程。\n\n所以，Apache在处理与操作系统有关的事物时，不用考虑是基于哪一个操作系统，直接用APR的统一API接口就可，具体的由APR来实现跨操作系统。\n\n实际上任何应用程序都可以借助APR进行跨平台。\n\n### Apache核心功能层\n1. 核心功能层主要实现Apache的基本功能和核心功能，包括读取和响应HTTP请求，处理HTTP协议；核心功能层包括核心程序和核心模块\n\n**核心程序** 主要是实现Apache的基本功能：\n* 启动和终止apache\n* 处理配置文件(config.c)\n* 接受和处理HTTP连接\n* 读取HTTP请求并对该请求进行处理\n* 处理HTTP协议\n\n核心功能层另一个是 **核心模块**\n\n 2. Apache 最基本的核心功能由apache 核心完成，除此之外，核心无法提供的功能则全部由模块提供。为了允许这些模块能完成控制apache的处理，apache核心程序提供了对应的API；这些API是指每个模块中包含的一系列的函数(核心程序处理HTTP请求的时候用来将信息传递给模块)，以及一些列apr的函数。\n\n### Apache可选功能层\nApache有很多模块，包括mod_ssl mod_proxy mod_perl ；apache的文件都是C语言开发的，如果有perl脚本写的模块，必须把mod_perl 模块加载，否则不能运行\n\n### Apache第三方功能库\napahe的一些模块会使用到第三方的开发库，比如 mod_ssl 使用了 openssl；mod_perl 使用了perl 开发库，这些库并不属于apache，是第三方库。\n\n\n## Apache模块化体系结构\nApache体系结构的模块化特点，主要体现在第三层（核心功能层）与第四层（可选功能层）。Apache采用模块化体系结构，使它作为一个HTTP服务器的大部分功能都被分割为相互独立的模块，使我们能够通过增加或者删除模块就可以扩展和修改Apache的功能。\n\n### 核心模块&可选模块\nApache中大部分模块都是可选择的，这意味着这些模块的缺失至多影响Apache的功能完整性，而不影响起运行。但有两个模块是必须的，mod_core和mod_so。\n\n#### 核心模块\n\n* **mod_core:** 负责处理配置文件中的大部分配置指令，并根据这些指令运行Apache。\n* **mod_so:** 负责动态加载其余的模块。没有该模块，其余的模块就无法被加载使用。\n* **MPM模块** 即，多进程处理模块，虽然该模块是一个可选模块，但一般情况下，我们都会使用，所以我们将其也视为核心模块。\n> 前两个模块我们必须静态编译。mpm模块的话，当我们在编译Apache是已经确定使用某一MPM模块之后通过也可将其采用静态编译的方式进行编译。但是如果我们想要在Apache安装之后动态修改MPM模式的话，那么在Apache编译安装的时候，MPM模块就需要通过动态编译的方式进行编译安装。\n\n\n#### 非核心模块\n一些常见的可选模块：\n* mod_alias\n> Provides for mapping different parts of the host filesystem in the document tree and for URL redirection\n> 为不同的url地址映射到文件系统的指定位置，即『起别名』\n\n* mod_autoindex\n> 用于生成目录索引\n\n* mod_cache\n> RFC 2616标准的HTTP缓存的过滤器。是apache中基于URI键的内容动态缓冲(内存或磁盘)。\n> 从Apache2.2起，mod_cache和mod_file_cache将不再是试验模块，它们已经足够稳定，可以用于实际生产中了。这些缓冲体系提供了一个强有力的途径来加速原始web服务器(origin webserver)和代理服务器(proxy)的HTTP处理速度。\n\n* mod_cgi\n>  执行cgi脚本\n\n* mod_dir\n> 目录的索引可以来自两个来源：\n> * 由用户编写的文件，通常被称为 index.html。该DirectoryIndex指令设置该文件的名称。这是由控制 mod_dir。\n> * 否则，由服务器生成的列表。这是通过提供mod_autoindex。\n>\n> 这两种功能是分开的，这样如果你想你可以完全删除（或更换）自动索引生成。\n>\n> 当服务器收到一个URL请求的“斜线”重定向发出 http://servername/foo/dirname那里 dirname是一个目录。目录需要一个结尾斜杠，所以mod_dir发出一个重定向 http://servername/foo/dirname/。\n\n* mod_filter\n> 该模块实现输出内容过滤器的智能，上下文相关的配置。例如，Apache可以被配置为处理不同的内容类型通过不同的过滤器，即使当内容类型是不是预先已知的（例如，在一个代理）。\n\n* mod_include\n> 服务器端包含\n\n* mod_isapi\n> ISAPI Extensions within Apache for Windows\n> 本模块实现了互联网服务扩展应用程序编程接口(Internet Server extension API)。本模块使得Windows上的Apache能有限地实现互联网服务扩展(比如调用ISAPI的动态连接库)。\n\n* mod_mime\n> 关联请求的文件名的扩展名与文件的行为（处理器和过滤器）和内容（MIME类型，语言，字符集和编码)\n\n* mod_mime_magic\n> 通过读取部分文件内容自动猜测文件的MIME类型\n> 本模块采取Unix系统下file(1)命令相同的方法：检查文件开始的几个字节，来判定文件的MIME类型。它被作为当mod_mime无法解析时，用来处理的\"第二道防线\"。\n\n* mod_proxy\n> 用于提供代理服务，能够支持的包括正向代理、反向代理、透明代理、缓存、负载均衡，HTTP代理、FTP代理、SSL代理等若干强大的功能.\n\n* mod_rewrite\n> 提供了一个基于规则的重写动态URL重写引擎。\n\n* mod_session\n> 会话支持\n\n* mod_ssl\n> 提供使用安全套接字层（SSL）和传输层安全（TLS）协议强加密。（https协议必须）\n\n* mod_status\n> 提供有关服务器活动和性能信息\n\n* mod_vhost_alias\n> 虚拟主机配置支持\n\n### 静态模块&动态模块\n\n#### 概念&区别\n**什么是静态？**  其实就是编译的时候所有的模块自己编译进 httpd 这个文件中 ，启动的时候这些模块就已经加载进来了，也就是可以使用了。\n\n查看当前Apache通过静态编译的模块\n```\n[root@MyServer ~]# httpd -l\nCompiled in modules:\ncore.c\nmod_so.c\nhttp_core.c\nevent.c\n```\n\n**那么什么是动态？**  静态是直接编译进httpd中， 那么动态显然就不编译进去了，也就是你启动的时候根本不会加载这个模块， 而是给你一个module.so 文件，你一定要使用 loadmodule 这个语法来加载，这个模块才有效。\n\n***配置方法：***\n静态的模块通常在http.conf中用<ifmodule></ifmodule> 来配置，动态的要先loadmoule来加载，然后再<ifmodule></ifmodule>配置。\n官方说静态的比动态的在性能方面多5%左右。\n\n***比较：***\n相对来说，静态的效率高些，而动态方式配置方面灵活。想想如果编译进去的C这个module你想升级或者去掉，静态方式的就只能重新编译Apache了。\n\n下面这句在Apache源文件夹下运行，可以查看默认情况下Apache都给你装了那些module进去：\n```\n./configure –help | grep disable\n```\n\n####\n\n#### 模块管理\n\n##### 1. 模块的类型：\n* 基本(B)模块默认包含，必须明确禁用；\n* 扩展(E)/实验(X)模块默认不包含，必须明确启用。\n\n那么，针对以上这些类型的模块，在编译时有以下几种操作方式：\n\n**--disable-MODULE**\n禁用MODULE模块(仅用于基本模块)\n\n**--enable-MODULE=shared**\n将MODULE编译为DSO(可用于所有模块)\n\n**--enable-MODULE=static**\n将MODULE静态连接进核心(仅用于扩展和实验模块)\n\n**--enable-mods-shared=MODULE-LIST**\n将MODULE-LIST中的所有模块都编译成DSO(可用于所有模块)\n\n**--enable-modules=MODULE-LIST**\n将MODULE-LIST静态连接进核心(可用于所有模块)\n\n***针对--enable-modules和--enable-mods-shared有两个懒办法就是 most参数和all参数，分别表示“很多的”和“所有”。***\n**例如：**\n```\nmod_alias是个基本模块，不想安装的话就： --disable-alias\nmod_rewrite是个扩展模块，想动态加载它：--enable-rewrite=shared，想静态加载就是：--enable-rewrite=static\n想静态编译mod_alias和mod_rewrite：--enable-modules='alias rewrite'\n想动态编译mod_alias和mod_rewrite：--enable-mods-shared='alias rewrite'\n```\n\n##### 2. 动态模块管理\n**Tips:** 让Apache日后可以动态编译和加载模块：\n如果想让Apache日后可以支持动态编译(DSO)更多的module，需要在初次安装时把so这个模块编译到核心（即，静态编译）。\n> 如果编译中包含任何DSO模块，则mod_so会被自动包含进核心。如果希望核心以后能够装载DSO，但不实际编译任何DSO模块，则需明确指定：\n> * 针对apache1.x: --enable-module=so\n> * 针对apache2.x: --enable-so=static\n\n针对Apache2.2.x的一些例子：\n```\n最大化静态安装Apache:\n./configure --prefix=/usr/local/apache --enable-modules=all\n最大化动态安装Apache:\n./configure --prefix=/usr/local/apache --enable-mods-shared=all\n静态安装rewrite、动态安装deflate以及headers\n./configure --prefix=/usr/local/apache --enable-rewrite=static --enable-deflate=shared --enable-headers=shared\n不安装基本的alais，保留以后的扩展DSO能力：\n./configure --prefix=/usr/local/apache --enable-so=static --disable-alias\n```\n\n##### 利用APXS工具动态为Apache编译新的DSO（动态共享对象）\n一般如果我们需要开启或者关闭某一些模块，只需要在 `httpd.conf` 中注释相应的模块的加载指令或者去掉指令前面的注释。\n但如果我们需要的模块在 Apache编译安装的时候没有编译进去，我们可以用APXS工具来动态编译，并加入到Apache中。\n\nAPXS,是一个给Apache服务器编译和安装扩展模块的工具。即将一个或者多个源代码或者目标文件编译成一个动态共享对象（DSO），然后可以通过Apache的 LoadModule 指令加载运行。\n因此，要使用该工具，我们的Apache必须支持DSO特性，即已经安装有mod_so 模块，否则安装会报错。\n\napxs命令选项说明：\n```\napxs -g [ -S name=value ] -n modname\napxs -q [ -v ] [ -S name=value ] query ...\napxs -c [ -S name=value ] [ -o dsofile ] [ -I incdir ] [ -D name=value ] [ -L libdir ] [ -l libname ] [ -Wc,compiler-flags ] [ -Wl,linker-flags ] files ...\napxs -i [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...\napxs -e [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...\n\n```\n\n常用选项：\n- -n modname\n  > 明确的设置模块名称, -i(安装)和-g（模板生成）选项\n\n执行选项：\n- -q\n  > 设置编译httpd时的变量和环境\n\n配置选项：\n- -S name=value\n  > 此选项更改apxs的上述设置。\n\n模板生成选项：\n- -g\n  > 该选项将生成一个子目录（名称将取决 -n设置），并会生成两个文件，一个要编译模块的源文件，用来创建模块或作为一个快速启动的apxs机制。另一个，用于编译和安装此模块，如mod_name.cMakefile\n\nDSO 编译选项\n- -c\n > 表明将进行编译操作。它首先编译C源文件(.c)，到对应的目标文件（.o），然后通过连接这些目标文件以及其余的目标文件（.a和.a）构建一个动态的共享对象dsofile\n\n- -o dsofile\n  > 明确规定创建动态共享对象文件名。如果没有指定，并且不能从文件名猜测到，则会生成 mod_unknow.so\n\n- -D name=value\n > 直接传给编译命令自定义参数\n\n- -L libdir\n > 设置编译时将要用到的自定义类库路径\n\n- -l libname\n > 设置编译时用到的自定义类库名称\n\n- -Wc，compiler-flags\n > 设置或添加本地编译器特定的选项\n\n- -Wl，linker-flags\n > 设置或添加本地特定连接的选项。\n\n- -p\n > 该选项将会使apxs 连接和引用apr/apr-util类库，使用apr/apr-util将会对编译非常有用。\n\nDSO的安装和配置选项\n\n- -i\n  > 表明安装操作，安装一个或多个动态共享对象到服务器的模块目录\n\n- -a\n > 自动添加 LoadModule 指令到 httpd.conf 配置文件，或者开启该指令。\n\n- -A\n > 同 -a 选项，但创建的 LoadModule指令是被注释的状态，也就是说该模块已经准备就绪，但没开启。\n\n- -e\n > 类似于 -a 和 -A 用来编辑 httpd.conf 而不安装该模块。\n\n\n##### 示例\n示例：我们有一个可用的Apache 模块 mod_foo.c 想要编译进Apache的DSO。\n```\n$ apxs -c mod_foo.c\n/path/to/libtool --mode=compile gcc ... -c mod_foo.c\n/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo\n$ _\n```\n\n然后，在Apache的配置文件中加入 loadModule 指令加载此共享对象。为了简化该步骤 apxs 提供了自动更新配置文件的的功能选项(-a,-A)。\n\n```\n$ apxs -i -a mod_foo.la\n/path/to/instdso.sh mod_foo.la /path/to/apache/modules\n/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so\n[activating module `foo' in /path/to/apache/conf/httpd.conf]\n$ _\n```\n这时，我们在httpd.conf 中就能看到这条指令。\n```\nLoadModule foo_module modules/mod_foo.so\n```\n如果没有使用 -a 选项自动添加，则需要手动添加进去。\n\n如果想默认不开启该模块，可以使用 -A 选项。即\n```\n$ apxs -i -A mod_foo.c\n```\n\n**apxs快速测试**\n\n我们可以通过创建一个Apache的测试模块，通过对应的Makefile\n```\n$ apxs -g -n foo\nCreating [DIR] foo\nCreating [FILE] foo/Makefile\nCreating [FILE] foo/modules.mk\nCreating [FILE] foo/mod_foo.c\nCreating [FILE] foo/.deps\n$ _\n```\n然后可以立即编译该测试模块到DSO，并加载到Apache。\n\n```\n$ cd foo\n$ make all reload\napxs -c mod_foo.c\n/path/to/libtool --mode=compile gcc ... -c mod_foo.c\n/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo\napxs -i -a -n \"foo\" mod_foo.la\n/path/to/instdso.sh mod_foo.la /path/to/apache/modules\n/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so\n[activating module `foo' in /path/to/apache/conf/httpd.conf]\napachectl restart\n/path/to/apache/sbin/apachectl restart: httpd not running, trying to start\n[Tue Mar 31 11:27:55 1998] [debug] mod_so.c(303): loaded module foo_module\n/path/to/apache/sbin/apachectl restart: httpd started\n$ _\n```\n\nover~\n","source":"_posts/Apache分层与模块化结构体系小结.md","raw":"---\ntitle: Apache分层与模块化体系结构小结\ndate: 2016-08-26 10:10:00\ntags:\n- Apache分层\n- Apache模块\ncategories:\n- Apache\n---\n\n## Apache的分层体系结构\n最新版本的Apache按照其功能一般会被划分为五层，\n1. 操作系统平台功能层\n> 各操作系统本身提供的底层功能，比如进程、线程管理,进程和线程之间通信、网络套接字通信、文件操作等\n\n2. 可移植运行库层（操作系统适配层）\n> 封装不同操作系统的底层细节，向上提供统一的接口。\n\n3. Apache核心功能层\n> 提供最基本的HTTP服务功能，对其他模块提供对应的API。\n\n4. Apache可选功能层\n> 这一层通常指 Apache模块，Apache核心功能层提供不了的功能交给不同的Apache模块来处理。\n\n5. Apache第三方功能层\n> Apache的一些模块中用到的一些第三方开发的类库等\n\n![Apache的分层体系结构](http://n.sinaimg.cn/games/3ece443e/20160826/apacheFenCengYuMoKuaiHuaTiXiJieGou.png)\n\n<!-- more -->\n\n**Apache源码目录结构简介**\n\n```\nbuild/    #\ndocs/     #包含一些相关文档\ninclude/  #包含一些必须的头文件\nmodules/  #包含Apache的各种模块\nos/       #各种操作系统的依赖文件\nserver/   #Apache核心功能（请求处理、协议处理、多处理模块mpm等）\nsrclib/   #Apache开发和运行需要的基础库（Apr_util,apr,pcre）\nsupport/  #一些辅助工具等\ntest/     #APR的测试函数\n```\n\n### 操作系统平台功能层\nApache实质上还是运行在操作系统上面的应用程序，因此必须使用操作系统本身提供的底层功能，比如进程和线程、进程和线程的通信，网络套接字通信和文件操作等。\n\n### 可移植运行库（操作系统适配层，APR）\nAPR(Apache portable runtime) 是操作系统的适配层，通过APR也实现了Apache的跨平台。因为不同的操作系统提供的底层API不同，也就是实现同一个操作所用的函数方法不同，这时在Apache和操作系统中间设计一个APR，这样APR根据不同的操作系统分别实现一个相同的功能，这样apache可以调用APR的提供的一个API接口。\n\n\n例如，如果Apache要创建一个进程，这时会调用 APR中的 apr_proc_create()函数，此时APR会自动识别操作系统的类型根据不同的类型调用操作系统通过的API，如是Unix系列则会调用unix中的fork()方法实现创建进程；如果是windows系统，则调用createProcess()创建进程。\n\n所以，Apache在处理与操作系统有关的事物时，不用考虑是基于哪一个操作系统，直接用APR的统一API接口就可，具体的由APR来实现跨操作系统。\n\n实际上任何应用程序都可以借助APR进行跨平台。\n\n### Apache核心功能层\n1. 核心功能层主要实现Apache的基本功能和核心功能，包括读取和响应HTTP请求，处理HTTP协议；核心功能层包括核心程序和核心模块\n\n**核心程序** 主要是实现Apache的基本功能：\n* 启动和终止apache\n* 处理配置文件(config.c)\n* 接受和处理HTTP连接\n* 读取HTTP请求并对该请求进行处理\n* 处理HTTP协议\n\n核心功能层另一个是 **核心模块**\n\n 2. Apache 最基本的核心功能由apache 核心完成，除此之外，核心无法提供的功能则全部由模块提供。为了允许这些模块能完成控制apache的处理，apache核心程序提供了对应的API；这些API是指每个模块中包含的一系列的函数(核心程序处理HTTP请求的时候用来将信息传递给模块)，以及一些列apr的函数。\n\n### Apache可选功能层\nApache有很多模块，包括mod_ssl mod_proxy mod_perl ；apache的文件都是C语言开发的，如果有perl脚本写的模块，必须把mod_perl 模块加载，否则不能运行\n\n### Apache第三方功能库\napahe的一些模块会使用到第三方的开发库，比如 mod_ssl 使用了 openssl；mod_perl 使用了perl 开发库，这些库并不属于apache，是第三方库。\n\n\n## Apache模块化体系结构\nApache体系结构的模块化特点，主要体现在第三层（核心功能层）与第四层（可选功能层）。Apache采用模块化体系结构，使它作为一个HTTP服务器的大部分功能都被分割为相互独立的模块，使我们能够通过增加或者删除模块就可以扩展和修改Apache的功能。\n\n### 核心模块&可选模块\nApache中大部分模块都是可选择的，这意味着这些模块的缺失至多影响Apache的功能完整性，而不影响起运行。但有两个模块是必须的，mod_core和mod_so。\n\n#### 核心模块\n\n* **mod_core:** 负责处理配置文件中的大部分配置指令，并根据这些指令运行Apache。\n* **mod_so:** 负责动态加载其余的模块。没有该模块，其余的模块就无法被加载使用。\n* **MPM模块** 即，多进程处理模块，虽然该模块是一个可选模块，但一般情况下，我们都会使用，所以我们将其也视为核心模块。\n> 前两个模块我们必须静态编译。mpm模块的话，当我们在编译Apache是已经确定使用某一MPM模块之后通过也可将其采用静态编译的方式进行编译。但是如果我们想要在Apache安装之后动态修改MPM模式的话，那么在Apache编译安装的时候，MPM模块就需要通过动态编译的方式进行编译安装。\n\n\n#### 非核心模块\n一些常见的可选模块：\n* mod_alias\n> Provides for mapping different parts of the host filesystem in the document tree and for URL redirection\n> 为不同的url地址映射到文件系统的指定位置，即『起别名』\n\n* mod_autoindex\n> 用于生成目录索引\n\n* mod_cache\n> RFC 2616标准的HTTP缓存的过滤器。是apache中基于URI键的内容动态缓冲(内存或磁盘)。\n> 从Apache2.2起，mod_cache和mod_file_cache将不再是试验模块，它们已经足够稳定，可以用于实际生产中了。这些缓冲体系提供了一个强有力的途径来加速原始web服务器(origin webserver)和代理服务器(proxy)的HTTP处理速度。\n\n* mod_cgi\n>  执行cgi脚本\n\n* mod_dir\n> 目录的索引可以来自两个来源：\n> * 由用户编写的文件，通常被称为 index.html。该DirectoryIndex指令设置该文件的名称。这是由控制 mod_dir。\n> * 否则，由服务器生成的列表。这是通过提供mod_autoindex。\n>\n> 这两种功能是分开的，这样如果你想你可以完全删除（或更换）自动索引生成。\n>\n> 当服务器收到一个URL请求的“斜线”重定向发出 http://servername/foo/dirname那里 dirname是一个目录。目录需要一个结尾斜杠，所以mod_dir发出一个重定向 http://servername/foo/dirname/。\n\n* mod_filter\n> 该模块实现输出内容过滤器的智能，上下文相关的配置。例如，Apache可以被配置为处理不同的内容类型通过不同的过滤器，即使当内容类型是不是预先已知的（例如，在一个代理）。\n\n* mod_include\n> 服务器端包含\n\n* mod_isapi\n> ISAPI Extensions within Apache for Windows\n> 本模块实现了互联网服务扩展应用程序编程接口(Internet Server extension API)。本模块使得Windows上的Apache能有限地实现互联网服务扩展(比如调用ISAPI的动态连接库)。\n\n* mod_mime\n> 关联请求的文件名的扩展名与文件的行为（处理器和过滤器）和内容（MIME类型，语言，字符集和编码)\n\n* mod_mime_magic\n> 通过读取部分文件内容自动猜测文件的MIME类型\n> 本模块采取Unix系统下file(1)命令相同的方法：检查文件开始的几个字节，来判定文件的MIME类型。它被作为当mod_mime无法解析时，用来处理的\"第二道防线\"。\n\n* mod_proxy\n> 用于提供代理服务，能够支持的包括正向代理、反向代理、透明代理、缓存、负载均衡，HTTP代理、FTP代理、SSL代理等若干强大的功能.\n\n* mod_rewrite\n> 提供了一个基于规则的重写动态URL重写引擎。\n\n* mod_session\n> 会话支持\n\n* mod_ssl\n> 提供使用安全套接字层（SSL）和传输层安全（TLS）协议强加密。（https协议必须）\n\n* mod_status\n> 提供有关服务器活动和性能信息\n\n* mod_vhost_alias\n> 虚拟主机配置支持\n\n### 静态模块&动态模块\n\n#### 概念&区别\n**什么是静态？**  其实就是编译的时候所有的模块自己编译进 httpd 这个文件中 ，启动的时候这些模块就已经加载进来了，也就是可以使用了。\n\n查看当前Apache通过静态编译的模块\n```\n[root@MyServer ~]# httpd -l\nCompiled in modules:\ncore.c\nmod_so.c\nhttp_core.c\nevent.c\n```\n\n**那么什么是动态？**  静态是直接编译进httpd中， 那么动态显然就不编译进去了，也就是你启动的时候根本不会加载这个模块， 而是给你一个module.so 文件，你一定要使用 loadmodule 这个语法来加载，这个模块才有效。\n\n***配置方法：***\n静态的模块通常在http.conf中用<ifmodule></ifmodule> 来配置，动态的要先loadmoule来加载，然后再<ifmodule></ifmodule>配置。\n官方说静态的比动态的在性能方面多5%左右。\n\n***比较：***\n相对来说，静态的效率高些，而动态方式配置方面灵活。想想如果编译进去的C这个module你想升级或者去掉，静态方式的就只能重新编译Apache了。\n\n下面这句在Apache源文件夹下运行，可以查看默认情况下Apache都给你装了那些module进去：\n```\n./configure –help | grep disable\n```\n\n####\n\n#### 模块管理\n\n##### 1. 模块的类型：\n* 基本(B)模块默认包含，必须明确禁用；\n* 扩展(E)/实验(X)模块默认不包含，必须明确启用。\n\n那么，针对以上这些类型的模块，在编译时有以下几种操作方式：\n\n**--disable-MODULE**\n禁用MODULE模块(仅用于基本模块)\n\n**--enable-MODULE=shared**\n将MODULE编译为DSO(可用于所有模块)\n\n**--enable-MODULE=static**\n将MODULE静态连接进核心(仅用于扩展和实验模块)\n\n**--enable-mods-shared=MODULE-LIST**\n将MODULE-LIST中的所有模块都编译成DSO(可用于所有模块)\n\n**--enable-modules=MODULE-LIST**\n将MODULE-LIST静态连接进核心(可用于所有模块)\n\n***针对--enable-modules和--enable-mods-shared有两个懒办法就是 most参数和all参数，分别表示“很多的”和“所有”。***\n**例如：**\n```\nmod_alias是个基本模块，不想安装的话就： --disable-alias\nmod_rewrite是个扩展模块，想动态加载它：--enable-rewrite=shared，想静态加载就是：--enable-rewrite=static\n想静态编译mod_alias和mod_rewrite：--enable-modules='alias rewrite'\n想动态编译mod_alias和mod_rewrite：--enable-mods-shared='alias rewrite'\n```\n\n##### 2. 动态模块管理\n**Tips:** 让Apache日后可以动态编译和加载模块：\n如果想让Apache日后可以支持动态编译(DSO)更多的module，需要在初次安装时把so这个模块编译到核心（即，静态编译）。\n> 如果编译中包含任何DSO模块，则mod_so会被自动包含进核心。如果希望核心以后能够装载DSO，但不实际编译任何DSO模块，则需明确指定：\n> * 针对apache1.x: --enable-module=so\n> * 针对apache2.x: --enable-so=static\n\n针对Apache2.2.x的一些例子：\n```\n最大化静态安装Apache:\n./configure --prefix=/usr/local/apache --enable-modules=all\n最大化动态安装Apache:\n./configure --prefix=/usr/local/apache --enable-mods-shared=all\n静态安装rewrite、动态安装deflate以及headers\n./configure --prefix=/usr/local/apache --enable-rewrite=static --enable-deflate=shared --enable-headers=shared\n不安装基本的alais，保留以后的扩展DSO能力：\n./configure --prefix=/usr/local/apache --enable-so=static --disable-alias\n```\n\n##### 利用APXS工具动态为Apache编译新的DSO（动态共享对象）\n一般如果我们需要开启或者关闭某一些模块，只需要在 `httpd.conf` 中注释相应的模块的加载指令或者去掉指令前面的注释。\n但如果我们需要的模块在 Apache编译安装的时候没有编译进去，我们可以用APXS工具来动态编译，并加入到Apache中。\n\nAPXS,是一个给Apache服务器编译和安装扩展模块的工具。即将一个或者多个源代码或者目标文件编译成一个动态共享对象（DSO），然后可以通过Apache的 LoadModule 指令加载运行。\n因此，要使用该工具，我们的Apache必须支持DSO特性，即已经安装有mod_so 模块，否则安装会报错。\n\napxs命令选项说明：\n```\napxs -g [ -S name=value ] -n modname\napxs -q [ -v ] [ -S name=value ] query ...\napxs -c [ -S name=value ] [ -o dsofile ] [ -I incdir ] [ -D name=value ] [ -L libdir ] [ -l libname ] [ -Wc,compiler-flags ] [ -Wl,linker-flags ] files ...\napxs -i [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...\napxs -e [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...\n\n```\n\n常用选项：\n- -n modname\n  > 明确的设置模块名称, -i(安装)和-g（模板生成）选项\n\n执行选项：\n- -q\n  > 设置编译httpd时的变量和环境\n\n配置选项：\n- -S name=value\n  > 此选项更改apxs的上述设置。\n\n模板生成选项：\n- -g\n  > 该选项将生成一个子目录（名称将取决 -n设置），并会生成两个文件，一个要编译模块的源文件，用来创建模块或作为一个快速启动的apxs机制。另一个，用于编译和安装此模块，如mod_name.cMakefile\n\nDSO 编译选项\n- -c\n > 表明将进行编译操作。它首先编译C源文件(.c)，到对应的目标文件（.o），然后通过连接这些目标文件以及其余的目标文件（.a和.a）构建一个动态的共享对象dsofile\n\n- -o dsofile\n  > 明确规定创建动态共享对象文件名。如果没有指定，并且不能从文件名猜测到，则会生成 mod_unknow.so\n\n- -D name=value\n > 直接传给编译命令自定义参数\n\n- -L libdir\n > 设置编译时将要用到的自定义类库路径\n\n- -l libname\n > 设置编译时用到的自定义类库名称\n\n- -Wc，compiler-flags\n > 设置或添加本地编译器特定的选项\n\n- -Wl，linker-flags\n > 设置或添加本地特定连接的选项。\n\n- -p\n > 该选项将会使apxs 连接和引用apr/apr-util类库，使用apr/apr-util将会对编译非常有用。\n\nDSO的安装和配置选项\n\n- -i\n  > 表明安装操作，安装一个或多个动态共享对象到服务器的模块目录\n\n- -a\n > 自动添加 LoadModule 指令到 httpd.conf 配置文件，或者开启该指令。\n\n- -A\n > 同 -a 选项，但创建的 LoadModule指令是被注释的状态，也就是说该模块已经准备就绪，但没开启。\n\n- -e\n > 类似于 -a 和 -A 用来编辑 httpd.conf 而不安装该模块。\n\n\n##### 示例\n示例：我们有一个可用的Apache 模块 mod_foo.c 想要编译进Apache的DSO。\n```\n$ apxs -c mod_foo.c\n/path/to/libtool --mode=compile gcc ... -c mod_foo.c\n/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo\n$ _\n```\n\n然后，在Apache的配置文件中加入 loadModule 指令加载此共享对象。为了简化该步骤 apxs 提供了自动更新配置文件的的功能选项(-a,-A)。\n\n```\n$ apxs -i -a mod_foo.la\n/path/to/instdso.sh mod_foo.la /path/to/apache/modules\n/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so\n[activating module `foo' in /path/to/apache/conf/httpd.conf]\n$ _\n```\n这时，我们在httpd.conf 中就能看到这条指令。\n```\nLoadModule foo_module modules/mod_foo.so\n```\n如果没有使用 -a 选项自动添加，则需要手动添加进去。\n\n如果想默认不开启该模块，可以使用 -A 选项。即\n```\n$ apxs -i -A mod_foo.c\n```\n\n**apxs快速测试**\n\n我们可以通过创建一个Apache的测试模块，通过对应的Makefile\n```\n$ apxs -g -n foo\nCreating [DIR] foo\nCreating [FILE] foo/Makefile\nCreating [FILE] foo/modules.mk\nCreating [FILE] foo/mod_foo.c\nCreating [FILE] foo/.deps\n$ _\n```\n然后可以立即编译该测试模块到DSO，并加载到Apache。\n\n```\n$ cd foo\n$ make all reload\napxs -c mod_foo.c\n/path/to/libtool --mode=compile gcc ... -c mod_foo.c\n/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo\napxs -i -a -n \"foo\" mod_foo.la\n/path/to/instdso.sh mod_foo.la /path/to/apache/modules\n/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so\n[activating module `foo' in /path/to/apache/conf/httpd.conf]\napachectl restart\n/path/to/apache/sbin/apachectl restart: httpd not running, trying to start\n[Tue Mar 31 11:27:55 1998] [debug] mod_so.c(303): loaded module foo_module\n/path/to/apache/sbin/apachectl restart: httpd started\n$ _\n```\n\nover~\n","slug":"Apache分层与模块化结构体系小结","published":1,"updated":"2016-09-02T02:25:59.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwui0005699fjpgjvswx","content":"<h2 id=\"Apache的分层体系结构\"><a href=\"#Apache的分层体系结构\" class=\"headerlink\" title=\"Apache的分层体系结构\"></a>Apache的分层体系结构</h2><p>最新版本的Apache按照其功能一般会被划分为五层，</p>\n<ol>\n<li><p>操作系统平台功能层</p>\n<blockquote>\n<p>各操作系统本身提供的底层功能，比如进程、线程管理,进程和线程之间通信、网络套接字通信、文件操作等</p>\n</blockquote>\n</li>\n<li><p>可移植运行库层（操作系统适配层）</p>\n<blockquote>\n<p>封装不同操作系统的底层细节，向上提供统一的接口。</p>\n</blockquote>\n</li>\n<li><p>Apache核心功能层</p>\n<blockquote>\n<p>提供最基本的HTTP服务功能，对其他模块提供对应的API。</p>\n</blockquote>\n</li>\n<li><p>Apache可选功能层</p>\n<blockquote>\n<p>这一层通常指 Apache模块，Apache核心功能层提供不了的功能交给不同的Apache模块来处理。</p>\n</blockquote>\n</li>\n<li><p>Apache第三方功能层</p>\n<blockquote>\n<p>Apache的一些模块中用到的一些第三方开发的类库等</p>\n</blockquote>\n</li>\n</ol>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160826/apacheFenCengYuMoKuaiHuaTiXiJieGou.png\" alt=\"Apache的分层体系结构\"></p>\n<a id=\"more\"></a>\n<p><strong>Apache源码目录结构简介</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">build/    #</div><div class=\"line\">docs/     #包含一些相关文档</div><div class=\"line\">include/  #包含一些必须的头文件</div><div class=\"line\">modules/  #包含Apache的各种模块</div><div class=\"line\">os/       #各种操作系统的依赖文件</div><div class=\"line\">server/   #Apache核心功能（请求处理、协议处理、多处理模块mpm等）</div><div class=\"line\">srclib/   #Apache开发和运行需要的基础库（Apr_util,apr,pcre）</div><div class=\"line\">support/  #一些辅助工具等</div><div class=\"line\">test/     #APR的测试函数</div></pre></td></tr></table></figure>\n<h3 id=\"操作系统平台功能层\"><a href=\"#操作系统平台功能层\" class=\"headerlink\" title=\"操作系统平台功能层\"></a>操作系统平台功能层</h3><p>Apache实质上还是运行在操作系统上面的应用程序，因此必须使用操作系统本身提供的底层功能，比如进程和线程、进程和线程的通信，网络套接字通信和文件操作等。</p>\n<h3 id=\"可移植运行库（操作系统适配层，APR）\"><a href=\"#可移植运行库（操作系统适配层，APR）\" class=\"headerlink\" title=\"可移植运行库（操作系统适配层，APR）\"></a>可移植运行库（操作系统适配层，APR）</h3><p>APR(Apache portable runtime) 是操作系统的适配层，通过APR也实现了Apache的跨平台。因为不同的操作系统提供的底层API不同，也就是实现同一个操作所用的函数方法不同，这时在Apache和操作系统中间设计一个APR，这样APR根据不同的操作系统分别实现一个相同的功能，这样apache可以调用APR的提供的一个API接口。</p>\n<p>例如，如果Apache要创建一个进程，这时会调用 APR中的 apr_proc_create()函数，此时APR会自动识别操作系统的类型根据不同的类型调用操作系统通过的API，如是Unix系列则会调用unix中的fork()方法实现创建进程；如果是windows系统，则调用createProcess()创建进程。</p>\n<p>所以，Apache在处理与操作系统有关的事物时，不用考虑是基于哪一个操作系统，直接用APR的统一API接口就可，具体的由APR来实现跨操作系统。</p>\n<p>实际上任何应用程序都可以借助APR进行跨平台。</p>\n<h3 id=\"Apache核心功能层\"><a href=\"#Apache核心功能层\" class=\"headerlink\" title=\"Apache核心功能层\"></a>Apache核心功能层</h3><ol>\n<li>核心功能层主要实现Apache的基本功能和核心功能，包括读取和响应HTTP请求，处理HTTP协议；核心功能层包括核心程序和核心模块</li>\n</ol>\n<p><strong>核心程序</strong> 主要是实现Apache的基本功能：</p>\n<ul>\n<li>启动和终止apache</li>\n<li>处理配置文件(config.c)</li>\n<li>接受和处理HTTP连接</li>\n<li>读取HTTP请求并对该请求进行处理</li>\n<li>处理HTTP协议</li>\n</ul>\n<p>核心功能层另一个是 <strong>核心模块</strong></p>\n<ol>\n<li>Apache 最基本的核心功能由apache 核心完成，除此之外，核心无法提供的功能则全部由模块提供。为了允许这些模块能完成控制apache的处理，apache核心程序提供了对应的API；这些API是指每个模块中包含的一系列的函数(核心程序处理HTTP请求的时候用来将信息传递给模块)，以及一些列apr的函数。</li>\n</ol>\n<h3 id=\"Apache可选功能层\"><a href=\"#Apache可选功能层\" class=\"headerlink\" title=\"Apache可选功能层\"></a>Apache可选功能层</h3><p>Apache有很多模块，包括mod_ssl mod_proxy mod_perl ；apache的文件都是C语言开发的，如果有perl脚本写的模块，必须把mod_perl 模块加载，否则不能运行</p>\n<h3 id=\"Apache第三方功能库\"><a href=\"#Apache第三方功能库\" class=\"headerlink\" title=\"Apache第三方功能库\"></a>Apache第三方功能库</h3><p>apahe的一些模块会使用到第三方的开发库，比如 mod_ssl 使用了 openssl；mod_perl 使用了perl 开发库，这些库并不属于apache，是第三方库。</p>\n<h2 id=\"Apache模块化体系结构\"><a href=\"#Apache模块化体系结构\" class=\"headerlink\" title=\"Apache模块化体系结构\"></a>Apache模块化体系结构</h2><p>Apache体系结构的模块化特点，主要体现在第三层（核心功能层）与第四层（可选功能层）。Apache采用模块化体系结构，使它作为一个HTTP服务器的大部分功能都被分割为相互独立的模块，使我们能够通过增加或者删除模块就可以扩展和修改Apache的功能。</p>\n<h3 id=\"核心模块-amp-可选模块\"><a href=\"#核心模块-amp-可选模块\" class=\"headerlink\" title=\"核心模块&amp;可选模块\"></a>核心模块&amp;可选模块</h3><p>Apache中大部分模块都是可选择的，这意味着这些模块的缺失至多影响Apache的功能完整性，而不影响起运行。但有两个模块是必须的，mod_core和mod_so。</p>\n<h4 id=\"核心模块\"><a href=\"#核心模块\" class=\"headerlink\" title=\"核心模块\"></a>核心模块</h4><ul>\n<li><strong>mod_core:</strong> 负责处理配置文件中的大部分配置指令，并根据这些指令运行Apache。</li>\n<li><strong>mod_so:</strong> 负责动态加载其余的模块。没有该模块，其余的模块就无法被加载使用。</li>\n<li><strong>MPM模块</strong> 即，多进程处理模块，虽然该模块是一个可选模块，但一般情况下，我们都会使用，所以我们将其也视为核心模块。<blockquote>\n<p>前两个模块我们必须静态编译。mpm模块的话，当我们在编译Apache是已经确定使用某一MPM模块之后通过也可将其采用静态编译的方式进行编译。但是如果我们想要在Apache安装之后动态修改MPM模式的话，那么在Apache编译安装的时候，MPM模块就需要通过动态编译的方式进行编译安装。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"非核心模块\"><a href=\"#非核心模块\" class=\"headerlink\" title=\"非核心模块\"></a>非核心模块</h4><p>一些常见的可选模块：</p>\n<ul>\n<li><p>mod_alias</p>\n<blockquote>\n<p>Provides for mapping different parts of the host filesystem in the document tree and for URL redirection<br>为不同的url地址映射到文件系统的指定位置，即『起别名』</p>\n</blockquote>\n</li>\n<li><p>mod_autoindex</p>\n<blockquote>\n<p>用于生成目录索引</p>\n</blockquote>\n</li>\n<li><p>mod_cache</p>\n<blockquote>\n<p>RFC 2616标准的HTTP缓存的过滤器。是apache中基于URI键的内容动态缓冲(内存或磁盘)。<br>从Apache2.2起，mod_cache和mod_file_cache将不再是试验模块，它们已经足够稳定，可以用于实际生产中了。这些缓冲体系提供了一个强有力的途径来加速原始web服务器(origin webserver)和代理服务器(proxy)的HTTP处理速度。</p>\n</blockquote>\n</li>\n<li><p>mod_cgi</p>\n<blockquote>\n<p> 执行cgi脚本</p>\n</blockquote>\n</li>\n<li><p>mod_dir</p>\n<blockquote>\n<p>目录的索引可以来自两个来源：</p>\n<ul>\n<li>由用户编写的文件，通常被称为 index.html。该DirectoryIndex指令设置该文件的名称。这是由控制 mod_dir。</li>\n<li>否则，由服务器生成的列表。这是通过提供mod_autoindex。</li>\n</ul>\n<p>这两种功能是分开的，这样如果你想你可以完全删除（或更换）自动索引生成。</p>\n<p>当服务器收到一个URL请求的“斜线”重定向发出 <a href=\"http://servername/foo/dirname那里\" target=\"_blank\" rel=\"external\">http://servername/foo/dirname那里</a> dirname是一个目录。目录需要一个结尾斜杠，所以mod_dir发出一个重定向 <a href=\"http://servername/foo/dirname/。\" target=\"_blank\" rel=\"external\">http://servername/foo/dirname/。</a></p>\n</blockquote>\n</li>\n<li><p>mod_filter</p>\n<blockquote>\n<p>该模块实现输出内容过滤器的智能，上下文相关的配置。例如，Apache可以被配置为处理不同的内容类型通过不同的过滤器，即使当内容类型是不是预先已知的（例如，在一个代理）。</p>\n</blockquote>\n</li>\n<li><p>mod_include</p>\n<blockquote>\n<p>服务器端包含</p>\n</blockquote>\n</li>\n<li><p>mod_isapi</p>\n<blockquote>\n<p>ISAPI Extensions within Apache for Windows<br>本模块实现了互联网服务扩展应用程序编程接口(Internet Server extension API)。本模块使得Windows上的Apache能有限地实现互联网服务扩展(比如调用ISAPI的动态连接库)。</p>\n</blockquote>\n</li>\n<li><p>mod_mime</p>\n<blockquote>\n<p>关联请求的文件名的扩展名与文件的行为（处理器和过滤器）和内容（MIME类型，语言，字符集和编码)</p>\n</blockquote>\n</li>\n<li><p>mod_mime_magic</p>\n<blockquote>\n<p>通过读取部分文件内容自动猜测文件的MIME类型<br>本模块采取Unix系统下file(1)命令相同的方法：检查文件开始的几个字节，来判定文件的MIME类型。它被作为当mod_mime无法解析时，用来处理的”第二道防线”。</p>\n</blockquote>\n</li>\n<li><p>mod_proxy</p>\n<blockquote>\n<p>用于提供代理服务，能够支持的包括正向代理、反向代理、透明代理、缓存、负载均衡，HTTP代理、FTP代理、SSL代理等若干强大的功能.</p>\n</blockquote>\n</li>\n<li><p>mod_rewrite</p>\n<blockquote>\n<p>提供了一个基于规则的重写动态URL重写引擎。</p>\n</blockquote>\n</li>\n<li><p>mod_session</p>\n<blockquote>\n<p>会话支持</p>\n</blockquote>\n</li>\n<li><p>mod_ssl</p>\n<blockquote>\n<p>提供使用安全套接字层（SSL）和传输层安全（TLS）协议强加密。（https协议必须）</p>\n</blockquote>\n</li>\n<li><p>mod_status</p>\n<blockquote>\n<p>提供有关服务器活动和性能信息</p>\n</blockquote>\n</li>\n<li><p>mod_vhost_alias</p>\n<blockquote>\n<p>虚拟主机配置支持</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"静态模块-amp-动态模块\"><a href=\"#静态模块-amp-动态模块\" class=\"headerlink\" title=\"静态模块&amp;动态模块\"></a>静态模块&amp;动态模块</h3><h4 id=\"概念-amp-区别\"><a href=\"#概念-amp-区别\" class=\"headerlink\" title=\"概念&amp;区别\"></a>概念&amp;区别</h4><p><strong>什么是静态？</strong>  其实就是编译的时候所有的模块自己编译进 httpd 这个文件中 ，启动的时候这些模块就已经加载进来了，也就是可以使用了。</p>\n<p>查看当前Apache通过静态编译的模块<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@MyServer ~]# httpd -l</div><div class=\"line\">Compiled in modules:</div><div class=\"line\">core.c</div><div class=\"line\">mod_so.c</div><div class=\"line\">http_core.c</div><div class=\"line\">event.c</div></pre></td></tr></table></figure></p>\n<p><strong>那么什么是动态？</strong>  静态是直接编译进httpd中， 那么动态显然就不编译进去了，也就是你启动的时候根本不会加载这个模块， 而是给你一个module.so 文件，你一定要使用 loadmodule 这个语法来加载，这个模块才有效。</p>\n<p><strong><em>配置方法：</em></strong><br>静态的模块通常在http.conf中用<ifmodule></ifmodule> 来配置，动态的要先loadmoule来加载，然后再<ifmodule></ifmodule>配置。<br>官方说静态的比动态的在性能方面多5%左右。</p>\n<p><strong><em>比较：</em></strong><br>相对来说，静态的效率高些，而动态方式配置方面灵活。想想如果编译进去的C这个module你想升级或者去掉，静态方式的就只能重新编译Apache了。</p>\n<p>下面这句在Apache源文件夹下运行，可以查看默认情况下Apache都给你装了那些module进去：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure –help | grep disable</div></pre></td></tr></table></figure></p>\n<p>####</p>\n<h4 id=\"模块管理\"><a href=\"#模块管理\" class=\"headerlink\" title=\"模块管理\"></a>模块管理</h4><h5 id=\"1-模块的类型：\"><a href=\"#1-模块的类型：\" class=\"headerlink\" title=\"1. 模块的类型：\"></a>1. 模块的类型：</h5><ul>\n<li>基本(B)模块默认包含，必须明确禁用；</li>\n<li>扩展(E)/实验(X)模块默认不包含，必须明确启用。</li>\n</ul>\n<p>那么，针对以上这些类型的模块，在编译时有以下几种操作方式：</p>\n<p><strong>–disable-MODULE</strong><br>禁用MODULE模块(仅用于基本模块)</p>\n<p><strong>–enable-MODULE=shared</strong><br>将MODULE编译为DSO(可用于所有模块)</p>\n<p><strong>–enable-MODULE=static</strong><br>将MODULE静态连接进核心(仅用于扩展和实验模块)</p>\n<p><strong>–enable-mods-shared=MODULE-LIST</strong><br>将MODULE-LIST中的所有模块都编译成DSO(可用于所有模块)</p>\n<p><strong>–enable-modules=MODULE-LIST</strong><br>将MODULE-LIST静态连接进核心(可用于所有模块)</p>\n<p><strong><em>针对–enable-modules和–enable-mods-shared有两个懒办法就是 most参数和all参数，分别表示“很多的”和“所有”。</em></strong><br><strong>例如：</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">mod_alias是个基本模块，不想安装的话就： --disable-alias</div><div class=\"line\">mod_rewrite是个扩展模块，想动态加载它：--enable-rewrite=shared，想静态加载就是：--enable-rewrite=static</div><div class=\"line\">想静态编译mod_alias和mod_rewrite：--enable-modules=&apos;alias rewrite&apos;</div><div class=\"line\">想动态编译mod_alias和mod_rewrite：--enable-mods-shared=&apos;alias rewrite&apos;</div></pre></td></tr></table></figure></p>\n<h5 id=\"2-动态模块管理\"><a href=\"#2-动态模块管理\" class=\"headerlink\" title=\"2. 动态模块管理\"></a>2. 动态模块管理</h5><p><strong>Tips:</strong> 让Apache日后可以动态编译和加载模块：<br>如果想让Apache日后可以支持动态编译(DSO)更多的module，需要在初次安装时把so这个模块编译到核心（即，静态编译）。</p>\n<blockquote>\n<p>如果编译中包含任何DSO模块，则mod_so会被自动包含进核心。如果希望核心以后能够装载DSO，但不实际编译任何DSO模块，则需明确指定：</p>\n<ul>\n<li>针对apache1.x: –enable-module=so</li>\n<li>针对apache2.x: –enable-so=static</li>\n</ul>\n</blockquote>\n<p>针对Apache2.2.x的一些例子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">最大化静态安装Apache:</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-modules=all</div><div class=\"line\">最大化动态安装Apache:</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-mods-shared=all</div><div class=\"line\">静态安装rewrite、动态安装deflate以及headers</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-rewrite=static --enable-deflate=shared --enable-headers=shared</div><div class=\"line\">不安装基本的alais，保留以后的扩展DSO能力：</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-so=static --disable-alias</div></pre></td></tr></table></figure></p>\n<h5 id=\"利用APXS工具动态为Apache编译新的DSO（动态共享对象）\"><a href=\"#利用APXS工具动态为Apache编译新的DSO（动态共享对象）\" class=\"headerlink\" title=\"利用APXS工具动态为Apache编译新的DSO（动态共享对象）\"></a>利用APXS工具动态为Apache编译新的DSO（动态共享对象）</h5><p>一般如果我们需要开启或者关闭某一些模块，只需要在 <code>httpd.conf</code> 中注释相应的模块的加载指令或者去掉指令前面的注释。<br>但如果我们需要的模块在 Apache编译安装的时候没有编译进去，我们可以用APXS工具来动态编译，并加入到Apache中。</p>\n<p>APXS,是一个给Apache服务器编译和安装扩展模块的工具。即将一个或者多个源代码或者目标文件编译成一个动态共享对象（DSO），然后可以通过Apache的 LoadModule 指令加载运行。<br>因此，要使用该工具，我们的Apache必须支持DSO特性，即已经安装有mod_so 模块，否则安装会报错。</p>\n<p>apxs命令选项说明：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">apxs -g [ -S name=value ] -n modname</div><div class=\"line\">apxs -q [ -v ] [ -S name=value ] query ...</div><div class=\"line\">apxs -c [ -S name=value ] [ -o dsofile ] [ -I incdir ] [ -D name=value ] [ -L libdir ] [ -l libname ] [ -Wc,compiler-flags ] [ -Wl,linker-flags ] files ...</div><div class=\"line\">apxs -i [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...</div><div class=\"line\">apxs -e [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...</div></pre></td></tr></table></figure></p>\n<p>常用选项：</p>\n<ul>\n<li>-n modname<blockquote>\n<p>明确的设置模块名称, -i(安装)和-g（模板生成）选项</p>\n</blockquote>\n</li>\n</ul>\n<p>执行选项：</p>\n<ul>\n<li>-q<blockquote>\n<p>设置编译httpd时的变量和环境</p>\n</blockquote>\n</li>\n</ul>\n<p>配置选项：</p>\n<ul>\n<li>-S name=value<blockquote>\n<p>此选项更改apxs的上述设置。</p>\n</blockquote>\n</li>\n</ul>\n<p>模板生成选项：</p>\n<ul>\n<li>-g<blockquote>\n<p>该选项将生成一个子目录（名称将取决 -n设置），并会生成两个文件，一个要编译模块的源文件，用来创建模块或作为一个快速启动的apxs机制。另一个，用于编译和安装此模块，如mod_name.cMakefile</p>\n</blockquote>\n</li>\n</ul>\n<p>DSO 编译选项</p>\n<ul>\n<li><p>-c</p>\n<blockquote>\n<p>表明将进行编译操作。它首先编译C源文件(.c)，到对应的目标文件（.o），然后通过连接这些目标文件以及其余的目标文件（.a和.a）构建一个动态的共享对象dsofile</p>\n</blockquote>\n</li>\n<li><p>-o dsofile</p>\n<blockquote>\n<p>明确规定创建动态共享对象文件名。如果没有指定，并且不能从文件名猜测到，则会生成 mod_unknow.so</p>\n</blockquote>\n</li>\n<li><p>-D name=value</p>\n<blockquote>\n<p>直接传给编译命令自定义参数</p>\n</blockquote>\n</li>\n<li><p>-L libdir</p>\n<blockquote>\n<p>设置编译时将要用到的自定义类库路径</p>\n</blockquote>\n</li>\n<li><p>-l libname</p>\n<blockquote>\n<p>设置编译时用到的自定义类库名称</p>\n</blockquote>\n</li>\n<li><p>-Wc，compiler-flags</p>\n<blockquote>\n<p>设置或添加本地编译器特定的选项</p>\n</blockquote>\n</li>\n<li><p>-Wl，linker-flags</p>\n<blockquote>\n<p>设置或添加本地特定连接的选项。</p>\n</blockquote>\n</li>\n<li><p>-p</p>\n<blockquote>\n<p>该选项将会使apxs 连接和引用apr/apr-util类库，使用apr/apr-util将会对编译非常有用。</p>\n</blockquote>\n</li>\n</ul>\n<p>DSO的安装和配置选项</p>\n<ul>\n<li><p>-i</p>\n<blockquote>\n<p>表明安装操作，安装一个或多个动态共享对象到服务器的模块目录</p>\n</blockquote>\n</li>\n<li><p>-a</p>\n<blockquote>\n<p>自动添加 LoadModule 指令到 httpd.conf 配置文件，或者开启该指令。</p>\n</blockquote>\n</li>\n<li><p>-A</p>\n<blockquote>\n<p>同 -a 选项，但创建的 LoadModule指令是被注释的状态，也就是说该模块已经准备就绪，但没开启。</p>\n</blockquote>\n</li>\n<li><p>-e</p>\n<blockquote>\n<p>类似于 -a 和 -A 用来编辑 httpd.conf 而不安装该模块。</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h5><p>示例：我们有一个可用的Apache 模块 mod_foo.c 想要编译进Apache的DSO。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=compile gcc ... -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo</div><div class=\"line\">$ _</div></pre></td></tr></table></figure></p>\n<p>然后，在Apache的配置文件中加入 loadModule 指令加载此共享对象。为了简化该步骤 apxs 提供了自动更新配置文件的的功能选项(-a,-A)。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -i -a mod_foo.la</div><div class=\"line\">/path/to/instdso.sh mod_foo.la /path/to/apache/modules</div><div class=\"line\">/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so</div><div class=\"line\">[activating module `foo&apos; in /path/to/apache/conf/httpd.conf]</div><div class=\"line\">$ _</div></pre></td></tr></table></figure>\n<p>这时，我们在httpd.conf 中就能看到这条指令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule foo_module modules/mod_foo.so</div></pre></td></tr></table></figure></p>\n<p>如果没有使用 -a 选项自动添加，则需要手动添加进去。</p>\n<p>如果想默认不开启该模块，可以使用 -A 选项。即<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -i -A mod_foo.c</div></pre></td></tr></table></figure></p>\n<p><strong>apxs快速测试</strong></p>\n<p>我们可以通过创建一个Apache的测试模块，通过对应的Makefile<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -g -n foo</div><div class=\"line\">Creating [DIR] foo</div><div class=\"line\">Creating [FILE] foo/Makefile</div><div class=\"line\">Creating [FILE] foo/modules.mk</div><div class=\"line\">Creating [FILE] foo/mod_foo.c</div><div class=\"line\">Creating [FILE] foo/.deps</div><div class=\"line\">$ _</div></pre></td></tr></table></figure></p>\n<p>然后可以立即编译该测试模块到DSO，并加载到Apache。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ cd foo</div><div class=\"line\">$ make all reload</div><div class=\"line\">apxs -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=compile gcc ... -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo</div><div class=\"line\">apxs -i -a -n &quot;foo&quot; mod_foo.la</div><div class=\"line\">/path/to/instdso.sh mod_foo.la /path/to/apache/modules</div><div class=\"line\">/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so</div><div class=\"line\">[activating module `foo&apos; in /path/to/apache/conf/httpd.conf]</div><div class=\"line\">apachectl restart</div><div class=\"line\">/path/to/apache/sbin/apachectl restart: httpd not running, trying to start</div><div class=\"line\">[Tue Mar 31 11:27:55 1998] [debug] mod_so.c(303): loaded module foo_module</div><div class=\"line\">/path/to/apache/sbin/apachectl restart: httpd started</div><div class=\"line\">$ _</div></pre></td></tr></table></figure>\n<p>over~</p>\n","excerpt":"<h2 id=\"Apache的分层体系结构\"><a href=\"#Apache的分层体系结构\" class=\"headerlink\" title=\"Apache的分层体系结构\"></a>Apache的分层体系结构</h2><p>最新版本的Apache按照其功能一般会被划分为五层，</p>\n<ol>\n<li><p>操作系统平台功能层</p>\n<blockquote>\n<p>各操作系统本身提供的底层功能，比如进程、线程管理,进程和线程之间通信、网络套接字通信、文件操作等</p>\n</blockquote>\n</li>\n<li><p>可移植运行库层（操作系统适配层）</p>\n<blockquote>\n<p>封装不同操作系统的底层细节，向上提供统一的接口。</p>\n</blockquote>\n</li>\n<li><p>Apache核心功能层</p>\n<blockquote>\n<p>提供最基本的HTTP服务功能，对其他模块提供对应的API。</p>\n</blockquote>\n</li>\n<li><p>Apache可选功能层</p>\n<blockquote>\n<p>这一层通常指 Apache模块，Apache核心功能层提供不了的功能交给不同的Apache模块来处理。</p>\n</blockquote>\n</li>\n<li><p>Apache第三方功能层</p>\n<blockquote>\n<p>Apache的一些模块中用到的一些第三方开发的类库等</p>\n</blockquote>\n</li>\n</ol>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160826/apacheFenCengYuMoKuaiHuaTiXiJieGou.png\" alt=\"Apache的分层体系结构\"></p>","more":"<p><strong>Apache源码目录结构简介</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">build/    #</div><div class=\"line\">docs/     #包含一些相关文档</div><div class=\"line\">include/  #包含一些必须的头文件</div><div class=\"line\">modules/  #包含Apache的各种模块</div><div class=\"line\">os/       #各种操作系统的依赖文件</div><div class=\"line\">server/   #Apache核心功能（请求处理、协议处理、多处理模块mpm等）</div><div class=\"line\">srclib/   #Apache开发和运行需要的基础库（Apr_util,apr,pcre）</div><div class=\"line\">support/  #一些辅助工具等</div><div class=\"line\">test/     #APR的测试函数</div></pre></td></tr></table></figure>\n<h3 id=\"操作系统平台功能层\"><a href=\"#操作系统平台功能层\" class=\"headerlink\" title=\"操作系统平台功能层\"></a>操作系统平台功能层</h3><p>Apache实质上还是运行在操作系统上面的应用程序，因此必须使用操作系统本身提供的底层功能，比如进程和线程、进程和线程的通信，网络套接字通信和文件操作等。</p>\n<h3 id=\"可移植运行库（操作系统适配层，APR）\"><a href=\"#可移植运行库（操作系统适配层，APR）\" class=\"headerlink\" title=\"可移植运行库（操作系统适配层，APR）\"></a>可移植运行库（操作系统适配层，APR）</h3><p>APR(Apache portable runtime) 是操作系统的适配层，通过APR也实现了Apache的跨平台。因为不同的操作系统提供的底层API不同，也就是实现同一个操作所用的函数方法不同，这时在Apache和操作系统中间设计一个APR，这样APR根据不同的操作系统分别实现一个相同的功能，这样apache可以调用APR的提供的一个API接口。</p>\n<p>例如，如果Apache要创建一个进程，这时会调用 APR中的 apr_proc_create()函数，此时APR会自动识别操作系统的类型根据不同的类型调用操作系统通过的API，如是Unix系列则会调用unix中的fork()方法实现创建进程；如果是windows系统，则调用createProcess()创建进程。</p>\n<p>所以，Apache在处理与操作系统有关的事物时，不用考虑是基于哪一个操作系统，直接用APR的统一API接口就可，具体的由APR来实现跨操作系统。</p>\n<p>实际上任何应用程序都可以借助APR进行跨平台。</p>\n<h3 id=\"Apache核心功能层\"><a href=\"#Apache核心功能层\" class=\"headerlink\" title=\"Apache核心功能层\"></a>Apache核心功能层</h3><ol>\n<li>核心功能层主要实现Apache的基本功能和核心功能，包括读取和响应HTTP请求，处理HTTP协议；核心功能层包括核心程序和核心模块</li>\n</ol>\n<p><strong>核心程序</strong> 主要是实现Apache的基本功能：</p>\n<ul>\n<li>启动和终止apache</li>\n<li>处理配置文件(config.c)</li>\n<li>接受和处理HTTP连接</li>\n<li>读取HTTP请求并对该请求进行处理</li>\n<li>处理HTTP协议</li>\n</ul>\n<p>核心功能层另一个是 <strong>核心模块</strong></p>\n<ol>\n<li>Apache 最基本的核心功能由apache 核心完成，除此之外，核心无法提供的功能则全部由模块提供。为了允许这些模块能完成控制apache的处理，apache核心程序提供了对应的API；这些API是指每个模块中包含的一系列的函数(核心程序处理HTTP请求的时候用来将信息传递给模块)，以及一些列apr的函数。</li>\n</ol>\n<h3 id=\"Apache可选功能层\"><a href=\"#Apache可选功能层\" class=\"headerlink\" title=\"Apache可选功能层\"></a>Apache可选功能层</h3><p>Apache有很多模块，包括mod_ssl mod_proxy mod_perl ；apache的文件都是C语言开发的，如果有perl脚本写的模块，必须把mod_perl 模块加载，否则不能运行</p>\n<h3 id=\"Apache第三方功能库\"><a href=\"#Apache第三方功能库\" class=\"headerlink\" title=\"Apache第三方功能库\"></a>Apache第三方功能库</h3><p>apahe的一些模块会使用到第三方的开发库，比如 mod_ssl 使用了 openssl；mod_perl 使用了perl 开发库，这些库并不属于apache，是第三方库。</p>\n<h2 id=\"Apache模块化体系结构\"><a href=\"#Apache模块化体系结构\" class=\"headerlink\" title=\"Apache模块化体系结构\"></a>Apache模块化体系结构</h2><p>Apache体系结构的模块化特点，主要体现在第三层（核心功能层）与第四层（可选功能层）。Apache采用模块化体系结构，使它作为一个HTTP服务器的大部分功能都被分割为相互独立的模块，使我们能够通过增加或者删除模块就可以扩展和修改Apache的功能。</p>\n<h3 id=\"核心模块-amp-可选模块\"><a href=\"#核心模块-amp-可选模块\" class=\"headerlink\" title=\"核心模块&amp;可选模块\"></a>核心模块&amp;可选模块</h3><p>Apache中大部分模块都是可选择的，这意味着这些模块的缺失至多影响Apache的功能完整性，而不影响起运行。但有两个模块是必须的，mod_core和mod_so。</p>\n<h4 id=\"核心模块\"><a href=\"#核心模块\" class=\"headerlink\" title=\"核心模块\"></a>核心模块</h4><ul>\n<li><strong>mod_core:</strong> 负责处理配置文件中的大部分配置指令，并根据这些指令运行Apache。</li>\n<li><strong>mod_so:</strong> 负责动态加载其余的模块。没有该模块，其余的模块就无法被加载使用。</li>\n<li><strong>MPM模块</strong> 即，多进程处理模块，虽然该模块是一个可选模块，但一般情况下，我们都会使用，所以我们将其也视为核心模块。<blockquote>\n<p>前两个模块我们必须静态编译。mpm模块的话，当我们在编译Apache是已经确定使用某一MPM模块之后通过也可将其采用静态编译的方式进行编译。但是如果我们想要在Apache安装之后动态修改MPM模式的话，那么在Apache编译安装的时候，MPM模块就需要通过动态编译的方式进行编译安装。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"非核心模块\"><a href=\"#非核心模块\" class=\"headerlink\" title=\"非核心模块\"></a>非核心模块</h4><p>一些常见的可选模块：</p>\n<ul>\n<li><p>mod_alias</p>\n<blockquote>\n<p>Provides for mapping different parts of the host filesystem in the document tree and for URL redirection<br>为不同的url地址映射到文件系统的指定位置，即『起别名』</p>\n</blockquote>\n</li>\n<li><p>mod_autoindex</p>\n<blockquote>\n<p>用于生成目录索引</p>\n</blockquote>\n</li>\n<li><p>mod_cache</p>\n<blockquote>\n<p>RFC 2616标准的HTTP缓存的过滤器。是apache中基于URI键的内容动态缓冲(内存或磁盘)。<br>从Apache2.2起，mod_cache和mod_file_cache将不再是试验模块，它们已经足够稳定，可以用于实际生产中了。这些缓冲体系提供了一个强有力的途径来加速原始web服务器(origin webserver)和代理服务器(proxy)的HTTP处理速度。</p>\n</blockquote>\n</li>\n<li><p>mod_cgi</p>\n<blockquote>\n<p> 执行cgi脚本</p>\n</blockquote>\n</li>\n<li><p>mod_dir</p>\n<blockquote>\n<p>目录的索引可以来自两个来源：</p>\n<ul>\n<li>由用户编写的文件，通常被称为 index.html。该DirectoryIndex指令设置该文件的名称。这是由控制 mod_dir。</li>\n<li>否则，由服务器生成的列表。这是通过提供mod_autoindex。</li>\n</ul>\n<p>这两种功能是分开的，这样如果你想你可以完全删除（或更换）自动索引生成。</p>\n<p>当服务器收到一个URL请求的“斜线”重定向发出 <a href=\"http://servername/foo/dirname那里\">http://servername/foo/dirname那里</a> dirname是一个目录。目录需要一个结尾斜杠，所以mod_dir发出一个重定向 <a href=\"http://servername/foo/dirname/。\">http://servername/foo/dirname/。</a></p>\n</blockquote>\n</li>\n<li><p>mod_filter</p>\n<blockquote>\n<p>该模块实现输出内容过滤器的智能，上下文相关的配置。例如，Apache可以被配置为处理不同的内容类型通过不同的过滤器，即使当内容类型是不是预先已知的（例如，在一个代理）。</p>\n</blockquote>\n</li>\n<li><p>mod_include</p>\n<blockquote>\n<p>服务器端包含</p>\n</blockquote>\n</li>\n<li><p>mod_isapi</p>\n<blockquote>\n<p>ISAPI Extensions within Apache for Windows<br>本模块实现了互联网服务扩展应用程序编程接口(Internet Server extension API)。本模块使得Windows上的Apache能有限地实现互联网服务扩展(比如调用ISAPI的动态连接库)。</p>\n</blockquote>\n</li>\n<li><p>mod_mime</p>\n<blockquote>\n<p>关联请求的文件名的扩展名与文件的行为（处理器和过滤器）和内容（MIME类型，语言，字符集和编码)</p>\n</blockquote>\n</li>\n<li><p>mod_mime_magic</p>\n<blockquote>\n<p>通过读取部分文件内容自动猜测文件的MIME类型<br>本模块采取Unix系统下file(1)命令相同的方法：检查文件开始的几个字节，来判定文件的MIME类型。它被作为当mod_mime无法解析时，用来处理的”第二道防线”。</p>\n</blockquote>\n</li>\n<li><p>mod_proxy</p>\n<blockquote>\n<p>用于提供代理服务，能够支持的包括正向代理、反向代理、透明代理、缓存、负载均衡，HTTP代理、FTP代理、SSL代理等若干强大的功能.</p>\n</blockquote>\n</li>\n<li><p>mod_rewrite</p>\n<blockquote>\n<p>提供了一个基于规则的重写动态URL重写引擎。</p>\n</blockquote>\n</li>\n<li><p>mod_session</p>\n<blockquote>\n<p>会话支持</p>\n</blockquote>\n</li>\n<li><p>mod_ssl</p>\n<blockquote>\n<p>提供使用安全套接字层（SSL）和传输层安全（TLS）协议强加密。（https协议必须）</p>\n</blockquote>\n</li>\n<li><p>mod_status</p>\n<blockquote>\n<p>提供有关服务器活动和性能信息</p>\n</blockquote>\n</li>\n<li><p>mod_vhost_alias</p>\n<blockquote>\n<p>虚拟主机配置支持</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"静态模块-amp-动态模块\"><a href=\"#静态模块-amp-动态模块\" class=\"headerlink\" title=\"静态模块&amp;动态模块\"></a>静态模块&amp;动态模块</h3><h4 id=\"概念-amp-区别\"><a href=\"#概念-amp-区别\" class=\"headerlink\" title=\"概念&amp;区别\"></a>概念&amp;区别</h4><p><strong>什么是静态？</strong>  其实就是编译的时候所有的模块自己编译进 httpd 这个文件中 ，启动的时候这些模块就已经加载进来了，也就是可以使用了。</p>\n<p>查看当前Apache通过静态编译的模块<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@MyServer ~]# httpd -l</div><div class=\"line\">Compiled in modules:</div><div class=\"line\">core.c</div><div class=\"line\">mod_so.c</div><div class=\"line\">http_core.c</div><div class=\"line\">event.c</div></pre></td></tr></table></figure></p>\n<p><strong>那么什么是动态？</strong>  静态是直接编译进httpd中， 那么动态显然就不编译进去了，也就是你启动的时候根本不会加载这个模块， 而是给你一个module.so 文件，你一定要使用 loadmodule 这个语法来加载，这个模块才有效。</p>\n<p><strong><em>配置方法：</em></strong><br>静态的模块通常在http.conf中用<ifmodule></ifmodule> 来配置，动态的要先loadmoule来加载，然后再<ifmodule></ifmodule>配置。<br>官方说静态的比动态的在性能方面多5%左右。</p>\n<p><strong><em>比较：</em></strong><br>相对来说，静态的效率高些，而动态方式配置方面灵活。想想如果编译进去的C这个module你想升级或者去掉，静态方式的就只能重新编译Apache了。</p>\n<p>下面这句在Apache源文件夹下运行，可以查看默认情况下Apache都给你装了那些module进去：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure –help | grep disable</div></pre></td></tr></table></figure></p>\n<p>####</p>\n<h4 id=\"模块管理\"><a href=\"#模块管理\" class=\"headerlink\" title=\"模块管理\"></a>模块管理</h4><h5 id=\"1-模块的类型：\"><a href=\"#1-模块的类型：\" class=\"headerlink\" title=\"1. 模块的类型：\"></a>1. 模块的类型：</h5><ul>\n<li>基本(B)模块默认包含，必须明确禁用；</li>\n<li>扩展(E)/实验(X)模块默认不包含，必须明确启用。</li>\n</ul>\n<p>那么，针对以上这些类型的模块，在编译时有以下几种操作方式：</p>\n<p><strong>–disable-MODULE</strong><br>禁用MODULE模块(仅用于基本模块)</p>\n<p><strong>–enable-MODULE=shared</strong><br>将MODULE编译为DSO(可用于所有模块)</p>\n<p><strong>–enable-MODULE=static</strong><br>将MODULE静态连接进核心(仅用于扩展和实验模块)</p>\n<p><strong>–enable-mods-shared=MODULE-LIST</strong><br>将MODULE-LIST中的所有模块都编译成DSO(可用于所有模块)</p>\n<p><strong>–enable-modules=MODULE-LIST</strong><br>将MODULE-LIST静态连接进核心(可用于所有模块)</p>\n<p><strong><em>针对–enable-modules和–enable-mods-shared有两个懒办法就是 most参数和all参数，分别表示“很多的”和“所有”。</em></strong><br><strong>例如：</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">mod_alias是个基本模块，不想安装的话就： --disable-alias</div><div class=\"line\">mod_rewrite是个扩展模块，想动态加载它：--enable-rewrite=shared，想静态加载就是：--enable-rewrite=static</div><div class=\"line\">想静态编译mod_alias和mod_rewrite：--enable-modules=&apos;alias rewrite&apos;</div><div class=\"line\">想动态编译mod_alias和mod_rewrite：--enable-mods-shared=&apos;alias rewrite&apos;</div></pre></td></tr></table></figure></p>\n<h5 id=\"2-动态模块管理\"><a href=\"#2-动态模块管理\" class=\"headerlink\" title=\"2. 动态模块管理\"></a>2. 动态模块管理</h5><p><strong>Tips:</strong> 让Apache日后可以动态编译和加载模块：<br>如果想让Apache日后可以支持动态编译(DSO)更多的module，需要在初次安装时把so这个模块编译到核心（即，静态编译）。</p>\n<blockquote>\n<p>如果编译中包含任何DSO模块，则mod_so会被自动包含进核心。如果希望核心以后能够装载DSO，但不实际编译任何DSO模块，则需明确指定：</p>\n<ul>\n<li>针对apache1.x: –enable-module=so</li>\n<li>针对apache2.x: –enable-so=static</li>\n</ul>\n</blockquote>\n<p>针对Apache2.2.x的一些例子：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">最大化静态安装Apache:</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-modules=all</div><div class=\"line\">最大化动态安装Apache:</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-mods-shared=all</div><div class=\"line\">静态安装rewrite、动态安装deflate以及headers</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-rewrite=static --enable-deflate=shared --enable-headers=shared</div><div class=\"line\">不安装基本的alais，保留以后的扩展DSO能力：</div><div class=\"line\">./configure --prefix=/usr/local/apache --enable-so=static --disable-alias</div></pre></td></tr></table></figure></p>\n<h5 id=\"利用APXS工具动态为Apache编译新的DSO（动态共享对象）\"><a href=\"#利用APXS工具动态为Apache编译新的DSO（动态共享对象）\" class=\"headerlink\" title=\"利用APXS工具动态为Apache编译新的DSO（动态共享对象）\"></a>利用APXS工具动态为Apache编译新的DSO（动态共享对象）</h5><p>一般如果我们需要开启或者关闭某一些模块，只需要在 <code>httpd.conf</code> 中注释相应的模块的加载指令或者去掉指令前面的注释。<br>但如果我们需要的模块在 Apache编译安装的时候没有编译进去，我们可以用APXS工具来动态编译，并加入到Apache中。</p>\n<p>APXS,是一个给Apache服务器编译和安装扩展模块的工具。即将一个或者多个源代码或者目标文件编译成一个动态共享对象（DSO），然后可以通过Apache的 LoadModule 指令加载运行。<br>因此，要使用该工具，我们的Apache必须支持DSO特性，即已经安装有mod_so 模块，否则安装会报错。</p>\n<p>apxs命令选项说明：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">apxs -g [ -S name=value ] -n modname</div><div class=\"line\">apxs -q [ -v ] [ -S name=value ] query ...</div><div class=\"line\">apxs -c [ -S name=value ] [ -o dsofile ] [ -I incdir ] [ -D name=value ] [ -L libdir ] [ -l libname ] [ -Wc,compiler-flags ] [ -Wl,linker-flags ] files ...</div><div class=\"line\">apxs -i [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...</div><div class=\"line\">apxs -e [ -S name=value ] [ -n modname ] [ -a ] [ -A ] dso-file ...</div></pre></td></tr></table></figure></p>\n<p>常用选项：</p>\n<ul>\n<li>-n modname<blockquote>\n<p>明确的设置模块名称, -i(安装)和-g（模板生成）选项</p>\n</blockquote>\n</li>\n</ul>\n<p>执行选项：</p>\n<ul>\n<li>-q<blockquote>\n<p>设置编译httpd时的变量和环境</p>\n</blockquote>\n</li>\n</ul>\n<p>配置选项：</p>\n<ul>\n<li>-S name=value<blockquote>\n<p>此选项更改apxs的上述设置。</p>\n</blockquote>\n</li>\n</ul>\n<p>模板生成选项：</p>\n<ul>\n<li>-g<blockquote>\n<p>该选项将生成一个子目录（名称将取决 -n设置），并会生成两个文件，一个要编译模块的源文件，用来创建模块或作为一个快速启动的apxs机制。另一个，用于编译和安装此模块，如mod_name.cMakefile</p>\n</blockquote>\n</li>\n</ul>\n<p>DSO 编译选项</p>\n<ul>\n<li><p>-c</p>\n<blockquote>\n<p>表明将进行编译操作。它首先编译C源文件(.c)，到对应的目标文件（.o），然后通过连接这些目标文件以及其余的目标文件（.a和.a）构建一个动态的共享对象dsofile</p>\n</blockquote>\n</li>\n<li><p>-o dsofile</p>\n<blockquote>\n<p>明确规定创建动态共享对象文件名。如果没有指定，并且不能从文件名猜测到，则会生成 mod_unknow.so</p>\n</blockquote>\n</li>\n<li><p>-D name=value</p>\n<blockquote>\n<p>直接传给编译命令自定义参数</p>\n</blockquote>\n</li>\n<li><p>-L libdir</p>\n<blockquote>\n<p>设置编译时将要用到的自定义类库路径</p>\n</blockquote>\n</li>\n<li><p>-l libname</p>\n<blockquote>\n<p>设置编译时用到的自定义类库名称</p>\n</blockquote>\n</li>\n<li><p>-Wc，compiler-flags</p>\n<blockquote>\n<p>设置或添加本地编译器特定的选项</p>\n</blockquote>\n</li>\n<li><p>-Wl，linker-flags</p>\n<blockquote>\n<p>设置或添加本地特定连接的选项。</p>\n</blockquote>\n</li>\n<li><p>-p</p>\n<blockquote>\n<p>该选项将会使apxs 连接和引用apr/apr-util类库，使用apr/apr-util将会对编译非常有用。</p>\n</blockquote>\n</li>\n</ul>\n<p>DSO的安装和配置选项</p>\n<ul>\n<li><p>-i</p>\n<blockquote>\n<p>表明安装操作，安装一个或多个动态共享对象到服务器的模块目录</p>\n</blockquote>\n</li>\n<li><p>-a</p>\n<blockquote>\n<p>自动添加 LoadModule 指令到 httpd.conf 配置文件，或者开启该指令。</p>\n</blockquote>\n</li>\n<li><p>-A</p>\n<blockquote>\n<p>同 -a 选项，但创建的 LoadModule指令是被注释的状态，也就是说该模块已经准备就绪，但没开启。</p>\n</blockquote>\n</li>\n<li><p>-e</p>\n<blockquote>\n<p>类似于 -a 和 -A 用来编辑 httpd.conf 而不安装该模块。</p>\n</blockquote>\n</li>\n</ul>\n<h5 id=\"示例\"><a href=\"#示例\" class=\"headerlink\" title=\"示例\"></a>示例</h5><p>示例：我们有一个可用的Apache 模块 mod_foo.c 想要编译进Apache的DSO。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=compile gcc ... -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo</div><div class=\"line\">$ _</div></pre></td></tr></table></figure></p>\n<p>然后，在Apache的配置文件中加入 loadModule 指令加载此共享对象。为了简化该步骤 apxs 提供了自动更新配置文件的的功能选项(-a,-A)。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -i -a mod_foo.la</div><div class=\"line\">/path/to/instdso.sh mod_foo.la /path/to/apache/modules</div><div class=\"line\">/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so</div><div class=\"line\">[activating module `foo&apos; in /path/to/apache/conf/httpd.conf]</div><div class=\"line\">$ _</div></pre></td></tr></table></figure>\n<p>这时，我们在httpd.conf 中就能看到这条指令。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">LoadModule foo_module modules/mod_foo.so</div></pre></td></tr></table></figure></p>\n<p>如果没有使用 -a 选项自动添加，则需要手动添加进去。</p>\n<p>如果想默认不开启该模块，可以使用 -A 选项。即<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -i -A mod_foo.c</div></pre></td></tr></table></figure></p>\n<p><strong>apxs快速测试</strong></p>\n<p>我们可以通过创建一个Apache的测试模块，通过对应的Makefile<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ apxs -g -n foo</div><div class=\"line\">Creating [DIR] foo</div><div class=\"line\">Creating [FILE] foo/Makefile</div><div class=\"line\">Creating [FILE] foo/modules.mk</div><div class=\"line\">Creating [FILE] foo/mod_foo.c</div><div class=\"line\">Creating [FILE] foo/.deps</div><div class=\"line\">$ _</div></pre></td></tr></table></figure></p>\n<p>然后可以立即编译该测试模块到DSO，并加载到Apache。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ cd foo</div><div class=\"line\">$ make all reload</div><div class=\"line\">apxs -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=compile gcc ... -c mod_foo.c</div><div class=\"line\">/path/to/libtool --mode=link gcc ... -o mod_foo.la mod_foo.slo</div><div class=\"line\">apxs -i -a -n &quot;foo&quot; mod_foo.la</div><div class=\"line\">/path/to/instdso.sh mod_foo.la /path/to/apache/modules</div><div class=\"line\">/path/to/libtool --mode=install cp mod_foo.la /path/to/apache/modules ... chmod 755 /path/to/apache/modules/mod_foo.so</div><div class=\"line\">[activating module `foo&apos; in /path/to/apache/conf/httpd.conf]</div><div class=\"line\">apachectl restart</div><div class=\"line\">/path/to/apache/sbin/apachectl restart: httpd not running, trying to start</div><div class=\"line\">[Tue Mar 31 11:27:55 1998] [debug] mod_so.c(303): loaded module foo_module</div><div class=\"line\">/path/to/apache/sbin/apachectl restart: httpd started</div><div class=\"line\">$ _</div></pre></td></tr></table></figure>\n<p>over~</p>"},{"title":"Apache 并行处理模块小结","date":"2016-08-22T14:36:00.000Z","_content":"Apache 2.X  支持插入式并行处理模块，称为多路处理模块 MPM，（Multi-Processing Modules）它是一个用于选择和处理网络端口的绑定，接收请求并指派子进程处理来自客户端的请求的一个Apache模块。和其他Apache模块相比，它最大的区别是，在任何时间， 必须有一个，而且只有一个 MPM 加载到服务器中。\n> 原理就是增加服务器服务进程或线程数量，是服务器可同时处理更多用户请求。\n\n<!-- more -->\n\n## 如何为Apache选择并安装一个合适的MPM模块\n\n### 安装\nMPM 必须在编译前夕，配置时指定，然后编译到服务器程序中。\n\n即在执行 configure 时，使用参数 --with-mpm=NAME 来指定一个希望安装的MPM模块。NAME 是指定的 MPM 名称。\n\n例：\n```\n./configure --prefix=/usr/local/apache2 --with-mpm=worker\nmake & make install\n```\n或者也可以编译为支持指定的几种或者全部MPM，之后通过修改配置来更换具体使用哪种MPM。\n```\n--enable-mpms-shared='prefork worker'\n--enable-mpms-shared=all\n```\n\n例：\n```\n./configure --prefix=/usr/local/apache2 --enable-mpms-shared=all\n···\n```\n安装成功之后，会在modules文件夹下，自动编译出我们指定的MPM的so模块，在httpd.conf中修改Apache的多处理模式MPM可以切换不同MPM模块：\n```\n#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so\nLoadModule mpm_worker_module modules/mod_mpm_worker.so\n#LoadModule mpm_event_module modules/mod_mpm_event.so\n```\n### 如何查看当前使用的是哪种MPM模块\n\n1. 使用 ./httpd -l 来确定选择的 MPM。 此命令会列出编译到服务器程序中的所有模块，包括 MPM。例：\n```\n$ httpd -l\nCompiled in modules:\n  core.c\n  mod_so.c\n  http_core.c\n  prefork.c\n```\n  如上显示，我们呢当前安装的是以prefork方式工作的MPM模块。\n\n2. 使用./httpd -V 来确定当前使用的MPM模块。\n```\n$ httpd -V\nServer version: Apache/2.4.18 (Unix)\nServer built:   Feb 20 2016 20:03:19\nServer's Module Magic Number: 20120211:52\nServer loaded:  APR 1.4.8, APR-UTIL 1.5.2\nCompiled using: APR 1.4.8, APR-UTIL 1.5.2\nArchitecture:   64-bit\nServer MPM:     prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FLOCK_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=256\n -D HTTPD_ROOT=\"/usr\"\n -D SUEXEC_BIN=\"/usr/bin/suexec\"\n -D DEFAULT_PIDLOG=\"/private/var/run/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/private/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/private/etc/apache2/httpd.conf\"\n```\n\n\n## 常见的几种MPM模块以及它们之间的区别\n如果我们在编译的时候没有明确选择使用哪种MPM模块，那么Apache将会根据不同的系统选择不同的MPM模块进行编译安装。\n\n系统  | 默认MPM\n-----|-------\nBeOS |beos\nNetware|mpm_netware\nOS/2\t|mpmt_os2\nUnix\t|prefork\nWindows\t|mpm_winnt\n\n对于类UNIX系统，根据不同的场景需要我们可以选择使用不同的MPM模块。\n* prefork\n* worker\n* event\n\n### prefork MPM\n> 非线程型的、预派生的MPM\n\n**原理：** 启动之初，就预先fork一些子进程，然后等待请求进来。\n```\n# prefork MPM\n# StartServers: number of server processes to start\n# MinSpareServers: minimum number of server processes which are kept spare\n# MaxSpareServers: maximum number of server processes which are kept spare\n# MaxRequestWorkers: maximum number of server processes allowed to start\n# MaxConnectionsPerChild: maximum number of connections a server process serves\n#                         before terminating\n<IfModule mpm_prefork_module>\n    StartServers             1  #推荐 小=默认，中=20~50，大=50~100\n    MinSpareServers          1  #推荐 与 StartServers 保持一致\n    MaxSpareServers         10  #推荐 小=20，中=30~80，大=80~120\n    MaxRequestWorkers      250  #推荐 小=500，中=500~1500，大=1500~3000\n    MaxConnectionsPerChild   0  #推荐 小=10000，中或大10000~50000\n    #ServerLimit           250  #推荐 与 MaxRequestWorkers 保持一致，当MaxRequestWorkers 值超过256，则需要增加该值配置\n</IfModule>\n```\n启动时建立`StartServers`个子进程，然后按每秒创建指数级个进程数，直到达到`MinSpareServers`个进程（最多增到每秒32个）。如果空闲进程大于`MaxSpareServers`，则检查kill掉一些空闲进程。\n\n`MaxRequestWorkers`指定Apache最多可以同时同时处理的请求数，即进程数，当请求数多余这个值之后，多余的请求就会进入请求队列等待处理（默认不能大于256）。但可以通过设定ServerLimit来增大限制数，serverlimit最大为20000。apache2.3.1之前的版本该参数叫 MaxClients 。当我们的服务器资源很多，但访问却很慢时，我们就可以试一下增大该值，来提高服务器的请求处理能力。\n`MaxConnectionsPerChild`每个子进程可处理的请求数。处理完之后子进程就会自动销毁。`0`表示无限，永不销毁。\n\n* 优点：成熟稳定，兼容所有新老模块。同时，不需要担心线程安全的问题。\n* 缺点：相对于线程，进程相对占用更多的系统资源，消耗更多的内存。所以不擅长处理高并发请求。\n\n\n### worker MPM\n> 支持混合的多线程、多进程的MPM。相比于prefork，worker采用了多进程和多线程混合模式，所以在使用中它占据更少的内存，在高并发情况下表现更优秀。\n\n```\n# worker MPM\n# StartServers: initial number of server processes to start\n# MinSpareThreads: minimum number of worker threads which are kept spare\n# MaxSpareThreads: maximum number of worker threads which are kept spare\n# ThreadsPerChild: constant umber of worker threads in each server process\n# MaxRequestWorkers: maximum number of worker threads\n# MaxConnectionsPerChild: maximum number of connections a server process serves\n#                         before terminating\n<IfModule mpm_worker_module>\n    StartServers             3  #推荐 小=默认，中=3~5，大=5~10\n    MinSpareThreads         75  #推荐 小=默认，中=50~100，大=100~200\n    MaxSpareThreads        250  #推荐 小=默认，中=80~160，大=200~400\n    ThreadsPerChild         25  #推荐 小=默认，中=50~100，大=100~200\n    MaxRequestWorkers      400  #推荐 小=500，中=500~1500，大=1500~3000\n    MaxConnectionsPerChild   0  #推荐 小=10000，中或大=10000~50000\n    #ServerLimit           250  #推荐 当 MaxRequestWorkers/ThreadsPerChild 大于16时，则需要增加该值配置。并且该值必须大于等于MaxRequestWorkers/ThreadsPerChild 的值\n</IfModule>\n\n```\n`ThreadsPerChild` 每个进程包含线程数\n`MaxSpareThreads` 定义最大空闲线程数，超过则清理\n\n* 优点：占用更少系统资源，高并发情况下表现更优秀。\n* 缺点：必须考虑线程安全的问题。\n\n### event MPM\n> worker方式的升级版，也采用多进程和多线程混合模式，并且解决了在 `keep-alive` 情况下，长期被占用的线程的资源浪费问题。\n\n```\n# event MPM\n# StartServers: initial number of server processes to start\n# MinSpareThreads: minimum number of worker threads which are kept spare\n# MaxSpareThreads: maximum number of worker threads which are kept spare\n# ThreadsPerChild: constant number of worker threads in each server process\n# MaxRequestWorkers: maximum number of worker threads\n# MaxConnectionsPerChild: maximum number of connections a server process serves\n#                         before terminating\n<IfModule mpm_event_module>\n    StartServers             3\n    MinSpareThreads         75\n    MaxSpareThreads        250\n    ThreadsPerChild         25\n    MaxRequestWorkers      400\n    MaxConnectionsPerChild   0\n</IfModule>\n\n```\n\n\n* 优点：更好的高并发请求处理能力。\n* 缺点：兼容性问题可能不是很好（最新的官方自带的模块，已经全部支持event MPM了），需要Linux系统（Linux 2.6+）对EPoll的支持，才能启用\n\n\n**Tips：**\n* ***空闲子进程：*** 即没有正在处理请求的子进程。\n* ***请求等待队列：*** 任何超过 MaxClients 或 MaxRequestWorkers 限制的请求都将进入到等待队列，直到收到 ListenBacklog 指令限制的最大值为止（默认 ListenBacklog 511）\n* ***ServerLimit：*** 该值表示Apache允许创建的最大进程数。值得注意的是 Apache在编译的时候会有一个硬限制 ServerLimit 20000 ，你不能超过该值。该值如果设置过高，将会有过多的内存被分配，可能会导致Apache 无法启动或者不稳定的情况。\n\n## 简单测试对比\n\n对上面三种模式，我们做简单的测试进行对比。\n\n### 静态页面\n```\n./ab -k -c 200 -n 200000 192.168.1.234/index.html\n```\n\n结果：\n```\nprefork：9556QPS\nworker ：11038QPS\nevent ：10224QPS\n```\n### PHP页面\n```\n./ab -k -c 200 -n 200000 192.168.1.234/index.php  #echo \"hello world\";\n```\n结果：\n```\nprefork：6094QPS\nworker ：7411QPS\nevent ：7089QPS\n```\n","source":"_posts/Apache多处理模块整理.md","raw":"---\ntitle: Apache 并行处理模块小结\ndate: 2016-08-22 22:36:00\ntags:\n- Apache Apache性能优化\ncategories:\n- Apache\n---\nApache 2.X  支持插入式并行处理模块，称为多路处理模块 MPM，（Multi-Processing Modules）它是一个用于选择和处理网络端口的绑定，接收请求并指派子进程处理来自客户端的请求的一个Apache模块。和其他Apache模块相比，它最大的区别是，在任何时间， 必须有一个，而且只有一个 MPM 加载到服务器中。\n> 原理就是增加服务器服务进程或线程数量，是服务器可同时处理更多用户请求。\n\n<!-- more -->\n\n## 如何为Apache选择并安装一个合适的MPM模块\n\n### 安装\nMPM 必须在编译前夕，配置时指定，然后编译到服务器程序中。\n\n即在执行 configure 时，使用参数 --with-mpm=NAME 来指定一个希望安装的MPM模块。NAME 是指定的 MPM 名称。\n\n例：\n```\n./configure --prefix=/usr/local/apache2 --with-mpm=worker\nmake & make install\n```\n或者也可以编译为支持指定的几种或者全部MPM，之后通过修改配置来更换具体使用哪种MPM。\n```\n--enable-mpms-shared='prefork worker'\n--enable-mpms-shared=all\n```\n\n例：\n```\n./configure --prefix=/usr/local/apache2 --enable-mpms-shared=all\n···\n```\n安装成功之后，会在modules文件夹下，自动编译出我们指定的MPM的so模块，在httpd.conf中修改Apache的多处理模式MPM可以切换不同MPM模块：\n```\n#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so\nLoadModule mpm_worker_module modules/mod_mpm_worker.so\n#LoadModule mpm_event_module modules/mod_mpm_event.so\n```\n### 如何查看当前使用的是哪种MPM模块\n\n1. 使用 ./httpd -l 来确定选择的 MPM。 此命令会列出编译到服务器程序中的所有模块，包括 MPM。例：\n```\n$ httpd -l\nCompiled in modules:\n  core.c\n  mod_so.c\n  http_core.c\n  prefork.c\n```\n  如上显示，我们呢当前安装的是以prefork方式工作的MPM模块。\n\n2. 使用./httpd -V 来确定当前使用的MPM模块。\n```\n$ httpd -V\nServer version: Apache/2.4.18 (Unix)\nServer built:   Feb 20 2016 20:03:19\nServer's Module Magic Number: 20120211:52\nServer loaded:  APR 1.4.8, APR-UTIL 1.5.2\nCompiled using: APR 1.4.8, APR-UTIL 1.5.2\nArchitecture:   64-bit\nServer MPM:     prefork\n  threaded:     no\n    forked:     yes (variable process count)\nServer compiled with....\n -D APR_HAS_SENDFILE\n -D APR_HAS_MMAP\n -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)\n -D APR_USE_FLOCK_SERIALIZE\n -D APR_USE_PTHREAD_SERIALIZE\n -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT\n -D APR_HAS_OTHER_CHILD\n -D AP_HAVE_RELIABLE_PIPED_LOGS\n -D DYNAMIC_MODULE_LIMIT=256\n -D HTTPD_ROOT=\"/usr\"\n -D SUEXEC_BIN=\"/usr/bin/suexec\"\n -D DEFAULT_PIDLOG=\"/private/var/run/httpd.pid\"\n -D DEFAULT_SCOREBOARD=\"logs/apache_runtime_status\"\n -D DEFAULT_ERRORLOG=\"logs/error_log\"\n -D AP_TYPES_CONFIG_FILE=\"/private/etc/apache2/mime.types\"\n -D SERVER_CONFIG_FILE=\"/private/etc/apache2/httpd.conf\"\n```\n\n\n## 常见的几种MPM模块以及它们之间的区别\n如果我们在编译的时候没有明确选择使用哪种MPM模块，那么Apache将会根据不同的系统选择不同的MPM模块进行编译安装。\n\n系统  | 默认MPM\n-----|-------\nBeOS |beos\nNetware|mpm_netware\nOS/2\t|mpmt_os2\nUnix\t|prefork\nWindows\t|mpm_winnt\n\n对于类UNIX系统，根据不同的场景需要我们可以选择使用不同的MPM模块。\n* prefork\n* worker\n* event\n\n### prefork MPM\n> 非线程型的、预派生的MPM\n\n**原理：** 启动之初，就预先fork一些子进程，然后等待请求进来。\n```\n# prefork MPM\n# StartServers: number of server processes to start\n# MinSpareServers: minimum number of server processes which are kept spare\n# MaxSpareServers: maximum number of server processes which are kept spare\n# MaxRequestWorkers: maximum number of server processes allowed to start\n# MaxConnectionsPerChild: maximum number of connections a server process serves\n#                         before terminating\n<IfModule mpm_prefork_module>\n    StartServers             1  #推荐 小=默认，中=20~50，大=50~100\n    MinSpareServers          1  #推荐 与 StartServers 保持一致\n    MaxSpareServers         10  #推荐 小=20，中=30~80，大=80~120\n    MaxRequestWorkers      250  #推荐 小=500，中=500~1500，大=1500~3000\n    MaxConnectionsPerChild   0  #推荐 小=10000，中或大10000~50000\n    #ServerLimit           250  #推荐 与 MaxRequestWorkers 保持一致，当MaxRequestWorkers 值超过256，则需要增加该值配置\n</IfModule>\n```\n启动时建立`StartServers`个子进程，然后按每秒创建指数级个进程数，直到达到`MinSpareServers`个进程（最多增到每秒32个）。如果空闲进程大于`MaxSpareServers`，则检查kill掉一些空闲进程。\n\n`MaxRequestWorkers`指定Apache最多可以同时同时处理的请求数，即进程数，当请求数多余这个值之后，多余的请求就会进入请求队列等待处理（默认不能大于256）。但可以通过设定ServerLimit来增大限制数，serverlimit最大为20000。apache2.3.1之前的版本该参数叫 MaxClients 。当我们的服务器资源很多，但访问却很慢时，我们就可以试一下增大该值，来提高服务器的请求处理能力。\n`MaxConnectionsPerChild`每个子进程可处理的请求数。处理完之后子进程就会自动销毁。`0`表示无限，永不销毁。\n\n* 优点：成熟稳定，兼容所有新老模块。同时，不需要担心线程安全的问题。\n* 缺点：相对于线程，进程相对占用更多的系统资源，消耗更多的内存。所以不擅长处理高并发请求。\n\n\n### worker MPM\n> 支持混合的多线程、多进程的MPM。相比于prefork，worker采用了多进程和多线程混合模式，所以在使用中它占据更少的内存，在高并发情况下表现更优秀。\n\n```\n# worker MPM\n# StartServers: initial number of server processes to start\n# MinSpareThreads: minimum number of worker threads which are kept spare\n# MaxSpareThreads: maximum number of worker threads which are kept spare\n# ThreadsPerChild: constant umber of worker threads in each server process\n# MaxRequestWorkers: maximum number of worker threads\n# MaxConnectionsPerChild: maximum number of connections a server process serves\n#                         before terminating\n<IfModule mpm_worker_module>\n    StartServers             3  #推荐 小=默认，中=3~5，大=5~10\n    MinSpareThreads         75  #推荐 小=默认，中=50~100，大=100~200\n    MaxSpareThreads        250  #推荐 小=默认，中=80~160，大=200~400\n    ThreadsPerChild         25  #推荐 小=默认，中=50~100，大=100~200\n    MaxRequestWorkers      400  #推荐 小=500，中=500~1500，大=1500~3000\n    MaxConnectionsPerChild   0  #推荐 小=10000，中或大=10000~50000\n    #ServerLimit           250  #推荐 当 MaxRequestWorkers/ThreadsPerChild 大于16时，则需要增加该值配置。并且该值必须大于等于MaxRequestWorkers/ThreadsPerChild 的值\n</IfModule>\n\n```\n`ThreadsPerChild` 每个进程包含线程数\n`MaxSpareThreads` 定义最大空闲线程数，超过则清理\n\n* 优点：占用更少系统资源，高并发情况下表现更优秀。\n* 缺点：必须考虑线程安全的问题。\n\n### event MPM\n> worker方式的升级版，也采用多进程和多线程混合模式，并且解决了在 `keep-alive` 情况下，长期被占用的线程的资源浪费问题。\n\n```\n# event MPM\n# StartServers: initial number of server processes to start\n# MinSpareThreads: minimum number of worker threads which are kept spare\n# MaxSpareThreads: maximum number of worker threads which are kept spare\n# ThreadsPerChild: constant number of worker threads in each server process\n# MaxRequestWorkers: maximum number of worker threads\n# MaxConnectionsPerChild: maximum number of connections a server process serves\n#                         before terminating\n<IfModule mpm_event_module>\n    StartServers             3\n    MinSpareThreads         75\n    MaxSpareThreads        250\n    ThreadsPerChild         25\n    MaxRequestWorkers      400\n    MaxConnectionsPerChild   0\n</IfModule>\n\n```\n\n\n* 优点：更好的高并发请求处理能力。\n* 缺点：兼容性问题可能不是很好（最新的官方自带的模块，已经全部支持event MPM了），需要Linux系统（Linux 2.6+）对EPoll的支持，才能启用\n\n\n**Tips：**\n* ***空闲子进程：*** 即没有正在处理请求的子进程。\n* ***请求等待队列：*** 任何超过 MaxClients 或 MaxRequestWorkers 限制的请求都将进入到等待队列，直到收到 ListenBacklog 指令限制的最大值为止（默认 ListenBacklog 511）\n* ***ServerLimit：*** 该值表示Apache允许创建的最大进程数。值得注意的是 Apache在编译的时候会有一个硬限制 ServerLimit 20000 ，你不能超过该值。该值如果设置过高，将会有过多的内存被分配，可能会导致Apache 无法启动或者不稳定的情况。\n\n## 简单测试对比\n\n对上面三种模式，我们做简单的测试进行对比。\n\n### 静态页面\n```\n./ab -k -c 200 -n 200000 192.168.1.234/index.html\n```\n\n结果：\n```\nprefork：9556QPS\nworker ：11038QPS\nevent ：10224QPS\n```\n### PHP页面\n```\n./ab -k -c 200 -n 200000 192.168.1.234/index.php  #echo \"hello world\";\n```\n结果：\n```\nprefork：6094QPS\nworker ：7411QPS\nevent ：7089QPS\n```\n","slug":"Apache多处理模块整理","published":1,"updated":"2016-08-24T03:16:32.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwul0006699fassakhuk","content":"<p>Apache 2.X  支持插入式并行处理模块，称为多路处理模块 MPM，（Multi-Processing Modules）它是一个用于选择和处理网络端口的绑定，接收请求并指派子进程处理来自客户端的请求的一个Apache模块。和其他Apache模块相比，它最大的区别是，在任何时间， 必须有一个，而且只有一个 MPM 加载到服务器中。</p>\n<blockquote>\n<p>原理就是增加服务器服务进程或线程数量，是服务器可同时处理更多用户请求。</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"如何为Apache选择并安装一个合适的MPM模块\"><a href=\"#如何为Apache选择并安装一个合适的MPM模块\" class=\"headerlink\" title=\"如何为Apache选择并安装一个合适的MPM模块\"></a>如何为Apache选择并安装一个合适的MPM模块</h2><h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>MPM 必须在编译前夕，配置时指定，然后编译到服务器程序中。</p>\n<p>即在执行 configure 时，使用参数 –with-mpm=NAME 来指定一个希望安装的MPM模块。NAME 是指定的 MPM 名称。</p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/apache2 --with-mpm=worker</div><div class=\"line\">make &amp; make install</div></pre></td></tr></table></figure></p>\n<p>或者也可以编译为支持指定的几种或者全部MPM，之后通过修改配置来更换具体使用哪种MPM。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">--enable-mpms-shared=&apos;prefork worker&apos;</div><div class=\"line\">--enable-mpms-shared=all</div></pre></td></tr></table></figure></p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/apache2 --enable-mpms-shared=all</div><div class=\"line\">···</div></pre></td></tr></table></figure></p>\n<p>安装成功之后，会在modules文件夹下，自动编译出我们指定的MPM的so模块，在httpd.conf中修改Apache的多处理模式MPM可以切换不同MPM模块：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so</div><div class=\"line\">LoadModule mpm_worker_module modules/mod_mpm_worker.so</div><div class=\"line\">#LoadModule mpm_event_module modules/mod_mpm_event.so</div></pre></td></tr></table></figure></p>\n<h3 id=\"如何查看当前使用的是哪种MPM模块\"><a href=\"#如何查看当前使用的是哪种MPM模块\" class=\"headerlink\" title=\"如何查看当前使用的是哪种MPM模块\"></a>如何查看当前使用的是哪种MPM模块</h3><ol>\n<li><p>使用 ./httpd -l 来确定选择的 MPM。 此命令会列出编译到服务器程序中的所有模块，包括 MPM。例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ httpd -l</div><div class=\"line\">Compiled in modules:</div><div class=\"line\">  core.c</div><div class=\"line\">  mod_so.c</div><div class=\"line\">  http_core.c</div><div class=\"line\">  prefork.c</div></pre></td></tr></table></figure>\n<p>如上显示，我们呢当前安装的是以prefork方式工作的MPM模块。</p>\n</li>\n<li><p>使用./httpd -V 来确定当前使用的MPM模块。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ httpd -V</div><div class=\"line\">Server version: Apache/2.4.18 (Unix)</div><div class=\"line\">Server built:   Feb 20 2016 20:03:19</div><div class=\"line\">Server&apos;s Module Magic Number: 20120211:52</div><div class=\"line\">Server loaded:  APR 1.4.8, APR-UTIL 1.5.2</div><div class=\"line\">Compiled using: APR 1.4.8, APR-UTIL 1.5.2</div><div class=\"line\">Architecture:   64-bit</div><div class=\"line\">Server MPM:     prefork</div><div class=\"line\">  threaded:     no</div><div class=\"line\">    forked:     yes (variable process count)</div><div class=\"line\">Server compiled with....</div><div class=\"line\"> -D APR_HAS_SENDFILE</div><div class=\"line\"> -D APR_HAS_MMAP</div><div class=\"line\"> -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)</div><div class=\"line\"> -D APR_USE_FLOCK_SERIALIZE</div><div class=\"line\"> -D APR_USE_PTHREAD_SERIALIZE</div><div class=\"line\"> -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT</div><div class=\"line\"> -D APR_HAS_OTHER_CHILD</div><div class=\"line\"> -D AP_HAVE_RELIABLE_PIPED_LOGS</div><div class=\"line\"> -D DYNAMIC_MODULE_LIMIT=256</div><div class=\"line\"> -D HTTPD_ROOT=&quot;/usr&quot;</div><div class=\"line\"> -D SUEXEC_BIN=&quot;/usr/bin/suexec&quot;</div><div class=\"line\"> -D DEFAULT_PIDLOG=&quot;/private/var/run/httpd.pid&quot;</div><div class=\"line\"> -D DEFAULT_SCOREBOARD=&quot;logs/apache_runtime_status&quot;</div><div class=\"line\"> -D DEFAULT_ERRORLOG=&quot;logs/error_log&quot;</div><div class=\"line\"> -D AP_TYPES_CONFIG_FILE=&quot;/private/etc/apache2/mime.types&quot;</div><div class=\"line\"> -D SERVER_CONFIG_FILE=&quot;/private/etc/apache2/httpd.conf&quot;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"常见的几种MPM模块以及它们之间的区别\"><a href=\"#常见的几种MPM模块以及它们之间的区别\" class=\"headerlink\" title=\"常见的几种MPM模块以及它们之间的区别\"></a>常见的几种MPM模块以及它们之间的区别</h2><p>如果我们在编译的时候没有明确选择使用哪种MPM模块，那么Apache将会根据不同的系统选择不同的MPM模块进行编译安装。</p>\n<table>\n<thead>\n<tr>\n<th>系统</th>\n<th>默认MPM</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BeOS</td>\n<td>beos</td>\n</tr>\n<tr>\n<td>Netware</td>\n<td>mpm_netware</td>\n</tr>\n<tr>\n<td>OS/2</td>\n<td>mpmt_os2</td>\n</tr>\n<tr>\n<td>Unix</td>\n<td>prefork</td>\n</tr>\n<tr>\n<td>Windows</td>\n<td>mpm_winnt</td>\n</tr>\n</tbody>\n</table>\n<p>对于类UNIX系统，根据不同的场景需要我们可以选择使用不同的MPM模块。</p>\n<ul>\n<li>prefork</li>\n<li>worker</li>\n<li>event</li>\n</ul>\n<h3 id=\"prefork-MPM\"><a href=\"#prefork-MPM\" class=\"headerlink\" title=\"prefork MPM\"></a>prefork MPM</h3><blockquote>\n<p>非线程型的、预派生的MPM</p>\n</blockquote>\n<p><strong>原理：</strong> 启动之初，就预先fork一些子进程，然后等待请求进来。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"># prefork MPM</div><div class=\"line\"># StartServers: number of server processes to start</div><div class=\"line\"># MinSpareServers: minimum number of server processes which are kept spare</div><div class=\"line\"># MaxSpareServers: maximum number of server processes which are kept spare</div><div class=\"line\"># MaxRequestWorkers: maximum number of server processes allowed to start</div><div class=\"line\"># MaxConnectionsPerChild: maximum number of connections a server process serves</div><div class=\"line\">#                         before terminating</div><div class=\"line\">&lt;IfModule mpm_prefork_module&gt;</div><div class=\"line\">    StartServers             1  #推荐 小=默认，中=20~50，大=50~100</div><div class=\"line\">    MinSpareServers          1  #推荐 与 StartServers 保持一致</div><div class=\"line\">    MaxSpareServers         10  #推荐 小=20，中=30~80，大=80~120</div><div class=\"line\">    MaxRequestWorkers      250  #推荐 小=500，中=500~1500，大=1500~3000</div><div class=\"line\">    MaxConnectionsPerChild   0  #推荐 小=10000，中或大10000~50000</div><div class=\"line\">    #ServerLimit           250  #推荐 与 MaxRequestWorkers 保持一致，当MaxRequestWorkers 值超过256，则需要增加该值配置</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure></p>\n<p>启动时建立<code>StartServers</code>个子进程，然后按每秒创建指数级个进程数，直到达到<code>MinSpareServers</code>个进程（最多增到每秒32个）。如果空闲进程大于<code>MaxSpareServers</code>，则检查kill掉一些空闲进程。</p>\n<p><code>MaxRequestWorkers</code>指定Apache最多可以同时同时处理的请求数，即进程数，当请求数多余这个值之后，多余的请求就会进入请求队列等待处理（默认不能大于256）。但可以通过设定ServerLimit来增大限制数，serverlimit最大为20000。apache2.3.1之前的版本该参数叫 MaxClients 。当我们的服务器资源很多，但访问却很慢时，我们就可以试一下增大该值，来提高服务器的请求处理能力。<br><code>MaxConnectionsPerChild</code>每个子进程可处理的请求数。处理完之后子进程就会自动销毁。<code>0</code>表示无限，永不销毁。</p>\n<ul>\n<li>优点：成熟稳定，兼容所有新老模块。同时，不需要担心线程安全的问题。</li>\n<li>缺点：相对于线程，进程相对占用更多的系统资源，消耗更多的内存。所以不擅长处理高并发请求。</li>\n</ul>\n<h3 id=\"worker-MPM\"><a href=\"#worker-MPM\" class=\"headerlink\" title=\"worker MPM\"></a>worker MPM</h3><blockquote>\n<p>支持混合的多线程、多进程的MPM。相比于prefork，worker采用了多进程和多线程混合模式，所以在使用中它占据更少的内存，在高并发情况下表现更优秀。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"># worker MPM</div><div class=\"line\"># StartServers: initial number of server processes to start</div><div class=\"line\"># MinSpareThreads: minimum number of worker threads which are kept spare</div><div class=\"line\"># MaxSpareThreads: maximum number of worker threads which are kept spare</div><div class=\"line\"># ThreadsPerChild: constant umber of worker threads in each server process</div><div class=\"line\"># MaxRequestWorkers: maximum number of worker threads</div><div class=\"line\"># MaxConnectionsPerChild: maximum number of connections a server process serves</div><div class=\"line\">#                         before terminating</div><div class=\"line\">&lt;IfModule mpm_worker_module&gt;</div><div class=\"line\">    StartServers             3  #推荐 小=默认，中=3~5，大=5~10</div><div class=\"line\">    MinSpareThreads         75  #推荐 小=默认，中=50~100，大=100~200</div><div class=\"line\">    MaxSpareThreads        250  #推荐 小=默认，中=80~160，大=200~400</div><div class=\"line\">    ThreadsPerChild         25  #推荐 小=默认，中=50~100，大=100~200</div><div class=\"line\">    MaxRequestWorkers      400  #推荐 小=500，中=500~1500，大=1500~3000</div><div class=\"line\">    MaxConnectionsPerChild   0  #推荐 小=10000，中或大=10000~50000</div><div class=\"line\">    #ServerLimit           250  #推荐 当 MaxRequestWorkers/ThreadsPerChild 大于16时，则需要增加该值配置。并且该值必须大于等于MaxRequestWorkers/ThreadsPerChild 的值</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n<p><code>ThreadsPerChild</code> 每个进程包含线程数<br><code>MaxSpareThreads</code> 定义最大空闲线程数，超过则清理</p>\n<ul>\n<li>优点：占用更少系统资源，高并发情况下表现更优秀。</li>\n<li>缺点：必须考虑线程安全的问题。</li>\n</ul>\n<h3 id=\"event-MPM\"><a href=\"#event-MPM\" class=\"headerlink\" title=\"event MPM\"></a>event MPM</h3><blockquote>\n<p>worker方式的升级版，也采用多进程和多线程混合模式，并且解决了在 <code>keep-alive</code> 情况下，长期被占用的线程的资源浪费问题。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"># event MPM</div><div class=\"line\"># StartServers: initial number of server processes to start</div><div class=\"line\"># MinSpareThreads: minimum number of worker threads which are kept spare</div><div class=\"line\"># MaxSpareThreads: maximum number of worker threads which are kept spare</div><div class=\"line\"># ThreadsPerChild: constant number of worker threads in each server process</div><div class=\"line\"># MaxRequestWorkers: maximum number of worker threads</div><div class=\"line\"># MaxConnectionsPerChild: maximum number of connections a server process serves</div><div class=\"line\">#                         before terminating</div><div class=\"line\">&lt;IfModule mpm_event_module&gt;</div><div class=\"line\">    StartServers             3</div><div class=\"line\">    MinSpareThreads         75</div><div class=\"line\">    MaxSpareThreads        250</div><div class=\"line\">    ThreadsPerChild         25</div><div class=\"line\">    MaxRequestWorkers      400</div><div class=\"line\">    MaxConnectionsPerChild   0</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n<ul>\n<li>优点：更好的高并发请求处理能力。</li>\n<li>缺点：兼容性问题可能不是很好（最新的官方自带的模块，已经全部支持event MPM了），需要Linux系统（Linux 2.6+）对EPoll的支持，才能启用</li>\n</ul>\n<p><strong>Tips：</strong></p>\n<ul>\n<li><strong><em>空闲子进程：</em></strong> 即没有正在处理请求的子进程。</li>\n<li><strong><em>请求等待队列：</em></strong> 任何超过 MaxClients 或 MaxRequestWorkers 限制的请求都将进入到等待队列，直到收到 ListenBacklog 指令限制的最大值为止（默认 ListenBacklog 511）</li>\n<li><strong><em>ServerLimit：</em></strong> 该值表示Apache允许创建的最大进程数。值得注意的是 Apache在编译的时候会有一个硬限制 ServerLimit 20000 ，你不能超过该值。该值如果设置过高，将会有过多的内存被分配，可能会导致Apache 无法启动或者不稳定的情况。</li>\n</ul>\n<h2 id=\"简单测试对比\"><a href=\"#简单测试对比\" class=\"headerlink\" title=\"简单测试对比\"></a>简单测试对比</h2><p>对上面三种模式，我们做简单的测试进行对比。</p>\n<h3 id=\"静态页面\"><a href=\"#静态页面\" class=\"headerlink\" title=\"静态页面\"></a>静态页面</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./ab -k -c 200 -n 200000 192.168.1.234/index.html</div></pre></td></tr></table></figure>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">prefork：9556QPS</div><div class=\"line\">worker ：11038QPS</div><div class=\"line\">event ：10224QPS</div></pre></td></tr></table></figure></p>\n<h3 id=\"PHP页面\"><a href=\"#PHP页面\" class=\"headerlink\" title=\"PHP页面\"></a>PHP页面</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./ab -k -c 200 -n 200000 192.168.1.234/index.php  #echo &quot;hello world&quot;;</div></pre></td></tr></table></figure>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">prefork：6094QPS</div><div class=\"line\">worker ：7411QPS</div><div class=\"line\">event ：7089QPS</div></pre></td></tr></table></figure></p>\n","excerpt":"<p>Apache 2.X  支持插入式并行处理模块，称为多路处理模块 MPM，（Multi-Processing Modules）它是一个用于选择和处理网络端口的绑定，接收请求并指派子进程处理来自客户端的请求的一个Apache模块。和其他Apache模块相比，它最大的区别是，在任何时间， 必须有一个，而且只有一个 MPM 加载到服务器中。</p>\n<blockquote>\n<p>原理就是增加服务器服务进程或线程数量，是服务器可同时处理更多用户请求。</p>\n</blockquote>","more":"<h2 id=\"如何为Apache选择并安装一个合适的MPM模块\"><a href=\"#如何为Apache选择并安装一个合适的MPM模块\" class=\"headerlink\" title=\"如何为Apache选择并安装一个合适的MPM模块\"></a>如何为Apache选择并安装一个合适的MPM模块</h2><h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><p>MPM 必须在编译前夕，配置时指定，然后编译到服务器程序中。</p>\n<p>即在执行 configure 时，使用参数 –with-mpm=NAME 来指定一个希望安装的MPM模块。NAME 是指定的 MPM 名称。</p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/apache2 --with-mpm=worker</div><div class=\"line\">make &amp; make install</div></pre></td></tr></table></figure></p>\n<p>或者也可以编译为支持指定的几种或者全部MPM，之后通过修改配置来更换具体使用哪种MPM。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">--enable-mpms-shared=&apos;prefork worker&apos;</div><div class=\"line\">--enable-mpms-shared=all</div></pre></td></tr></table></figure></p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/apache2 --enable-mpms-shared=all</div><div class=\"line\">···</div></pre></td></tr></table></figure></p>\n<p>安装成功之后，会在modules文件夹下，自动编译出我们指定的MPM的so模块，在httpd.conf中修改Apache的多处理模式MPM可以切换不同MPM模块：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">#LoadModule mpm_prefork_module modules/mod_mpm_prefork.so</div><div class=\"line\">LoadModule mpm_worker_module modules/mod_mpm_worker.so</div><div class=\"line\">#LoadModule mpm_event_module modules/mod_mpm_event.so</div></pre></td></tr></table></figure></p>\n<h3 id=\"如何查看当前使用的是哪种MPM模块\"><a href=\"#如何查看当前使用的是哪种MPM模块\" class=\"headerlink\" title=\"如何查看当前使用的是哪种MPM模块\"></a>如何查看当前使用的是哪种MPM模块</h3><ol>\n<li><p>使用 ./httpd -l 来确定选择的 MPM。 此命令会列出编译到服务器程序中的所有模块，包括 MPM。例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ httpd -l</div><div class=\"line\">Compiled in modules:</div><div class=\"line\">  core.c</div><div class=\"line\">  mod_so.c</div><div class=\"line\">  http_core.c</div><div class=\"line\">  prefork.c</div></pre></td></tr></table></figure>\n<p>如上显示，我们呢当前安装的是以prefork方式工作的MPM模块。</p>\n</li>\n<li><p>使用./httpd -V 来确定当前使用的MPM模块。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ httpd -V</div><div class=\"line\">Server version: Apache/2.4.18 (Unix)</div><div class=\"line\">Server built:   Feb 20 2016 20:03:19</div><div class=\"line\">Server&apos;s Module Magic Number: 20120211:52</div><div class=\"line\">Server loaded:  APR 1.4.8, APR-UTIL 1.5.2</div><div class=\"line\">Compiled using: APR 1.4.8, APR-UTIL 1.5.2</div><div class=\"line\">Architecture:   64-bit</div><div class=\"line\">Server MPM:     prefork</div><div class=\"line\">  threaded:     no</div><div class=\"line\">    forked:     yes (variable process count)</div><div class=\"line\">Server compiled with....</div><div class=\"line\"> -D APR_HAS_SENDFILE</div><div class=\"line\"> -D APR_HAS_MMAP</div><div class=\"line\"> -D APR_HAVE_IPV6 (IPv4-mapped addresses enabled)</div><div class=\"line\"> -D APR_USE_FLOCK_SERIALIZE</div><div class=\"line\"> -D APR_USE_PTHREAD_SERIALIZE</div><div class=\"line\"> -D SINGLE_LISTEN_UNSERIALIZED_ACCEPT</div><div class=\"line\"> -D APR_HAS_OTHER_CHILD</div><div class=\"line\"> -D AP_HAVE_RELIABLE_PIPED_LOGS</div><div class=\"line\"> -D DYNAMIC_MODULE_LIMIT=256</div><div class=\"line\"> -D HTTPD_ROOT=&quot;/usr&quot;</div><div class=\"line\"> -D SUEXEC_BIN=&quot;/usr/bin/suexec&quot;</div><div class=\"line\"> -D DEFAULT_PIDLOG=&quot;/private/var/run/httpd.pid&quot;</div><div class=\"line\"> -D DEFAULT_SCOREBOARD=&quot;logs/apache_runtime_status&quot;</div><div class=\"line\"> -D DEFAULT_ERRORLOG=&quot;logs/error_log&quot;</div><div class=\"line\"> -D AP_TYPES_CONFIG_FILE=&quot;/private/etc/apache2/mime.types&quot;</div><div class=\"line\"> -D SERVER_CONFIG_FILE=&quot;/private/etc/apache2/httpd.conf&quot;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"常见的几种MPM模块以及它们之间的区别\"><a href=\"#常见的几种MPM模块以及它们之间的区别\" class=\"headerlink\" title=\"常见的几种MPM模块以及它们之间的区别\"></a>常见的几种MPM模块以及它们之间的区别</h2><p>如果我们在编译的时候没有明确选择使用哪种MPM模块，那么Apache将会根据不同的系统选择不同的MPM模块进行编译安装。</p>\n<table>\n<thead>\n<tr>\n<th>系统</th>\n<th>默认MPM</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>BeOS</td>\n<td>beos</td>\n</tr>\n<tr>\n<td>Netware</td>\n<td>mpm_netware</td>\n</tr>\n<tr>\n<td>OS/2</td>\n<td>mpmt_os2</td>\n</tr>\n<tr>\n<td>Unix</td>\n<td>prefork</td>\n</tr>\n<tr>\n<td>Windows</td>\n<td>mpm_winnt</td>\n</tr>\n</tbody>\n</table>\n<p>对于类UNIX系统，根据不同的场景需要我们可以选择使用不同的MPM模块。</p>\n<ul>\n<li>prefork</li>\n<li>worker</li>\n<li>event</li>\n</ul>\n<h3 id=\"prefork-MPM\"><a href=\"#prefork-MPM\" class=\"headerlink\" title=\"prefork MPM\"></a>prefork MPM</h3><blockquote>\n<p>非线程型的、预派生的MPM</p>\n</blockquote>\n<p><strong>原理：</strong> 启动之初，就预先fork一些子进程，然后等待请求进来。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\"># prefork MPM</div><div class=\"line\"># StartServers: number of server processes to start</div><div class=\"line\"># MinSpareServers: minimum number of server processes which are kept spare</div><div class=\"line\"># MaxSpareServers: maximum number of server processes which are kept spare</div><div class=\"line\"># MaxRequestWorkers: maximum number of server processes allowed to start</div><div class=\"line\"># MaxConnectionsPerChild: maximum number of connections a server process serves</div><div class=\"line\">#                         before terminating</div><div class=\"line\">&lt;IfModule mpm_prefork_module&gt;</div><div class=\"line\">    StartServers             1  #推荐 小=默认，中=20~50，大=50~100</div><div class=\"line\">    MinSpareServers          1  #推荐 与 StartServers 保持一致</div><div class=\"line\">    MaxSpareServers         10  #推荐 小=20，中=30~80，大=80~120</div><div class=\"line\">    MaxRequestWorkers      250  #推荐 小=500，中=500~1500，大=1500~3000</div><div class=\"line\">    MaxConnectionsPerChild   0  #推荐 小=10000，中或大10000~50000</div><div class=\"line\">    #ServerLimit           250  #推荐 与 MaxRequestWorkers 保持一致，当MaxRequestWorkers 值超过256，则需要增加该值配置</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure></p>\n<p>启动时建立<code>StartServers</code>个子进程，然后按每秒创建指数级个进程数，直到达到<code>MinSpareServers</code>个进程（最多增到每秒32个）。如果空闲进程大于<code>MaxSpareServers</code>，则检查kill掉一些空闲进程。</p>\n<p><code>MaxRequestWorkers</code>指定Apache最多可以同时同时处理的请求数，即进程数，当请求数多余这个值之后，多余的请求就会进入请求队列等待处理（默认不能大于256）。但可以通过设定ServerLimit来增大限制数，serverlimit最大为20000。apache2.3.1之前的版本该参数叫 MaxClients 。当我们的服务器资源很多，但访问却很慢时，我们就可以试一下增大该值，来提高服务器的请求处理能力。<br><code>MaxConnectionsPerChild</code>每个子进程可处理的请求数。处理完之后子进程就会自动销毁。<code>0</code>表示无限，永不销毁。</p>\n<ul>\n<li>优点：成熟稳定，兼容所有新老模块。同时，不需要担心线程安全的问题。</li>\n<li>缺点：相对于线程，进程相对占用更多的系统资源，消耗更多的内存。所以不擅长处理高并发请求。</li>\n</ul>\n<h3 id=\"worker-MPM\"><a href=\"#worker-MPM\" class=\"headerlink\" title=\"worker MPM\"></a>worker MPM</h3><blockquote>\n<p>支持混合的多线程、多进程的MPM。相比于prefork，worker采用了多进程和多线程混合模式，所以在使用中它占据更少的内存，在高并发情况下表现更优秀。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\"># worker MPM</div><div class=\"line\"># StartServers: initial number of server processes to start</div><div class=\"line\"># MinSpareThreads: minimum number of worker threads which are kept spare</div><div class=\"line\"># MaxSpareThreads: maximum number of worker threads which are kept spare</div><div class=\"line\"># ThreadsPerChild: constant umber of worker threads in each server process</div><div class=\"line\"># MaxRequestWorkers: maximum number of worker threads</div><div class=\"line\"># MaxConnectionsPerChild: maximum number of connections a server process serves</div><div class=\"line\">#                         before terminating</div><div class=\"line\">&lt;IfModule mpm_worker_module&gt;</div><div class=\"line\">    StartServers             3  #推荐 小=默认，中=3~5，大=5~10</div><div class=\"line\">    MinSpareThreads         75  #推荐 小=默认，中=50~100，大=100~200</div><div class=\"line\">    MaxSpareThreads        250  #推荐 小=默认，中=80~160，大=200~400</div><div class=\"line\">    ThreadsPerChild         25  #推荐 小=默认，中=50~100，大=100~200</div><div class=\"line\">    MaxRequestWorkers      400  #推荐 小=500，中=500~1500，大=1500~3000</div><div class=\"line\">    MaxConnectionsPerChild   0  #推荐 小=10000，中或大=10000~50000</div><div class=\"line\">    #ServerLimit           250  #推荐 当 MaxRequestWorkers/ThreadsPerChild 大于16时，则需要增加该值配置。并且该值必须大于等于MaxRequestWorkers/ThreadsPerChild 的值</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n<p><code>ThreadsPerChild</code> 每个进程包含线程数<br><code>MaxSpareThreads</code> 定义最大空闲线程数，超过则清理</p>\n<ul>\n<li>优点：占用更少系统资源，高并发情况下表现更优秀。</li>\n<li>缺点：必须考虑线程安全的问题。</li>\n</ul>\n<h3 id=\"event-MPM\"><a href=\"#event-MPM\" class=\"headerlink\" title=\"event MPM\"></a>event MPM</h3><blockquote>\n<p>worker方式的升级版，也采用多进程和多线程混合模式，并且解决了在 <code>keep-alive</code> 情况下，长期被占用的线程的资源浪费问题。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"># event MPM</div><div class=\"line\"># StartServers: initial number of server processes to start</div><div class=\"line\"># MinSpareThreads: minimum number of worker threads which are kept spare</div><div class=\"line\"># MaxSpareThreads: maximum number of worker threads which are kept spare</div><div class=\"line\"># ThreadsPerChild: constant number of worker threads in each server process</div><div class=\"line\"># MaxRequestWorkers: maximum number of worker threads</div><div class=\"line\"># MaxConnectionsPerChild: maximum number of connections a server process serves</div><div class=\"line\">#                         before terminating</div><div class=\"line\">&lt;IfModule mpm_event_module&gt;</div><div class=\"line\">    StartServers             3</div><div class=\"line\">    MinSpareThreads         75</div><div class=\"line\">    MaxSpareThreads        250</div><div class=\"line\">    ThreadsPerChild         25</div><div class=\"line\">    MaxRequestWorkers      400</div><div class=\"line\">    MaxConnectionsPerChild   0</div><div class=\"line\">&lt;/IfModule&gt;</div></pre></td></tr></table></figure>\n<ul>\n<li>优点：更好的高并发请求处理能力。</li>\n<li>缺点：兼容性问题可能不是很好（最新的官方自带的模块，已经全部支持event MPM了），需要Linux系统（Linux 2.6+）对EPoll的支持，才能启用</li>\n</ul>\n<p><strong>Tips：</strong></p>\n<ul>\n<li><strong><em>空闲子进程：</em></strong> 即没有正在处理请求的子进程。</li>\n<li><strong><em>请求等待队列：</em></strong> 任何超过 MaxClients 或 MaxRequestWorkers 限制的请求都将进入到等待队列，直到收到 ListenBacklog 指令限制的最大值为止（默认 ListenBacklog 511）</li>\n<li><strong><em>ServerLimit：</em></strong> 该值表示Apache允许创建的最大进程数。值得注意的是 Apache在编译的时候会有一个硬限制 ServerLimit 20000 ，你不能超过该值。该值如果设置过高，将会有过多的内存被分配，可能会导致Apache 无法启动或者不稳定的情况。</li>\n</ul>\n<h2 id=\"简单测试对比\"><a href=\"#简单测试对比\" class=\"headerlink\" title=\"简单测试对比\"></a>简单测试对比</h2><p>对上面三种模式，我们做简单的测试进行对比。</p>\n<h3 id=\"静态页面\"><a href=\"#静态页面\" class=\"headerlink\" title=\"静态页面\"></a>静态页面</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./ab -k -c 200 -n 200000 192.168.1.234/index.html</div></pre></td></tr></table></figure>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">prefork：9556QPS</div><div class=\"line\">worker ：11038QPS</div><div class=\"line\">event ：10224QPS</div></pre></td></tr></table></figure></p>\n<h3 id=\"PHP页面\"><a href=\"#PHP页面\" class=\"headerlink\" title=\"PHP页面\"></a>PHP页面</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./ab -k -c 200 -n 200000 192.168.1.234/index.php  #echo &quot;hello world&quot;;</div></pre></td></tr></table></figure>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">prefork：6094QPS</div><div class=\"line\">worker ：7411QPS</div><div class=\"line\">event ：7089QPS</div></pre></td></tr></table></figure></p>"},{"title":"Apache的安装","date":"2016-08-09T06:00:00.000Z","author":"zhimiao","_content":"\nApache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。\nApache的安装无外乎两种方式：\n* 二进制包安装\n* 源码包安装\n\n\n<!-- more -->\n\n接下来我将会演示和记录通过源码包来安装apache到服务器。\n环境：阿里云 Centos 7.2 64\n\n## 安装前准备工作\n通过源码包安装，我们需要将源码编译成计算机运行的二进制，因此我们需要编译工具。\n### gcc安装\nGNU编译器套件（GNU Compiler Collection）包括C、C++、Objective-C、Fortran、Java、Ada和Go语言的前端，也包括了这些语言的库（如libstdc++、libgcj等等）。GCC的初衷是为GNU操作系统专门编写的一款编译器。\n```\n[root@iZ28v78hcmrZ ~]# gcc\ngcc: 致命错误：没有输入文件\n编译中断。\n[root@iZ28v78hcmrZ ~]# yum install gcc\n···\n作为依赖被升级:\n  cpp.x86_64 0:4.8.5-4.el7            gcc-c++.x86_64 0:4.8.5-4.el7            gcc-gfortran.x86_64 0:4.8.5-4.el7    libgcc.x86_64 0:4.8.5-4.el7\n  libgfortran.x86_64 0:4.8.5-4.el7    libgomp.x86_64 0:4.8.5-4.el7            libquadmath.x86_64 0:4.8.5-4.el7     libquadmath-devel.x86_64 0:4.8.5-4.el7\n  libstdc++.x86_64 0:4.8.5-4.el7      libstdc++-devel.x86_64 0:4.8.5-4.el7\n\n完毕！\n[root@iZ28v78hcmrZ ~]#\n```\n### APR、APR-UTIL 安装\n\nAPR （全称：Apache Portable Runtime）可移植运行时库、APR-UTIL（全称：Apache Portable Runtime Utility Library）可移植运行时工具库。它们的作用是使得对平台细节的处理进行下移。对于应用程序而言，它们根本就不需要考虑具体的平台，不管是Unix、Linux还是Window，应用程序执行的接口基本都是统一一致的。\nAPR的目标则是希望安全合并所有的能够合并的代码而不需要牺牲性能，为大多数平台提供所有的APR特性支持，包括Win32、OS/2、BeOS、Darwin、Linux等等。\n\n\n\n关于apr和apr-util，apache可以使用系统已经安装的版本，也可以不实用系统提供的版本。具体方法是分别下载apr和apr-util，解压到apache源码包中的srclib/apr和srclib/apr-util路径中（路径中不包含版本号等信息），在编译源码包之前的./configure 过程中使用 --with-included-apr 选项\n\n### PRCE (Perl-Compatible Regular Expressions Library,Perl兼容的正则表达式库)\nPCRE(Perl Compatible Regular Expressions)是一个用C语言编写的正则表达式函数库。\nPCRE被广泛使用在许多开源软件之中，最著名的莫过于Apache HTTP服务器和PHP脚本语言、R脚本语言，此外，正如从其名字所能看到的，PCRE也是perl语言的缺省正则库。\n\n[PCRE 下载网址][pcre_download]\n[pcre_download]:https://sourceforge.net/projects/pcre/files/\n\n```\n#解压\n[root@iZ94m2e99jtZ ~]# tar -zxvf pcre-8.38.tar.gz\n[root@iZ94m2e99jtZ ~]# cd pcre-8.38\n[root@iZ94m2e99jtZ pcre-8.38]# ./configure\n···\npcre-8.38 configuration summary:\n\n    Install prefix .................. : /usr/local\n    C preprocessor .................. : gcc -E\n    C compiler ...................... : gcc\n    C++ preprocessor ................ : g++ -E\n    C++ compiler .................... : g++\n    Linker .......................... : /usr/bin/ld -m elf_x86_64\n    C preprocessor flags ............ :\n    C compiler flags ................ : -g -O2 -fvisibility=hidden\n    C++ compiler flags .............. : -O2 -fvisibility=hidden -fvisibility-inlines-hidden\n    Linker flags .................... :\n    Extra libraries ................. :\n\n    Build 8 bit pcre library ........ : yes\n    Build 16 bit pcre library ....... : no\n    Build 32 bit pcre library ....... : no\n    Build C++ library ............... : yes\n    Enable JIT compiling support .... : no\n    Enable UTF-8/16/32 support ...... : no\n    Unicode properties .............. : no\n    Newline char/sequence ........... : lf\n    \\R matches only ANYCRLF ......... : no\n    EBCDIC coding ................... : no\n    EBCDIC code for NL .............. : n/a\n    Rebuild char tables ............. : no\n    Use stack recursion ............. : yes\n    POSIX mem threshold ............. : 10\n    Internal link size .............. : 2\n    Nested parentheses limit ........ : 250\n    Match limit ..................... : 10000000\n    Match limit recursion ........... : MATCH_LIMIT\n    Build shared libs ............... : yes\n    Build static libs ............... : yes\n    Use JIT in pcregrep ............. : no\n    Buffer size for pcregrep ........ : 20480\n    Link pcregrep with libz ......... : no\n    Link pcregrep with libbz2 ....... : no\n    Link pcretest with libedit ...... : no\n    Link pcretest with libreadline .. : no\n    Valgrind support ................ : no\n    Code coverage ................... : no\n\n[root@iZ94m2e99jtZ pcre-8.38]# make & make install\n\n```\n\n**Tips**\n在编译pcre时可能会出现这样的：configure: error: You need a C++ compiler for C++ support.提示我们缺少一个C++ 的编译器，需要我们再安装一个C++的编译器。\n```\n[root@iZ94m2e99jtZ pcre-8.38]# yum install gcc-c++\n\n```\n\n\n\n\n### 下载\n\n[apr、apr-uitl官网][apr_website]\n[apr_website]:http://apr.apache.org/\n\n[apr 下载地址][apr_1.5.2_download]\n[apr_1.5.2_download]:http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz\n[apr-uitl 下载地址][apr-uitl_1.5.4_download]\n[apr-uitl_1.5.4_download]:http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz\n\n\n[apache 源码包][apache_download]\n[apache_download]:http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz\n\n下载、解压、将apr和apr-util分别复制到httpd-2.4.23/srclib/apr和httpd-2.4.23/srclib/apr-util中\n\n```\n[root@iZ94m2e99jtZ ~]# wget http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz\n[root@iZ94m2e99jtZ ~]# wget  http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz\n[root@iZ94m2e99jtZ ~]# wget http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz\n\n[root@iZ94m2e99jtZ ~]# tar -zxvf apr-1.5.2.tar.gz\n[root@iZ94m2e99jtZ ~]# tar -zxvf apr-util-1.5.4.tar.gz\n[root@iZ94m2e99jtZ ~]# tar -zxvf httpd-2.4.23.tar.gz\n\n[root@iZ94m2e99jtZ ~]# ll\n总用量 10088\ndrwxr-xr-x 27 1000  1000    4096 4月  25 2015 apr-1.5.2\n-rw-r--r--  1 root root  1031613 4月  29 2015 apr-1.5.2.tar.gz\ndrwxr-xr-x 19 1000  1000    4096 9月  17 2014 apr-util-1.5.4\n-rw-r--r--  1 root root   874044 9月  20 2014 apr-util-1.5.4.tar.gz\ndrwxr-xr-x 11  501 games    4096 7月   1 01:15 httpd-2.4.23\n-rw-r--r--  1 root root  8406575 7月   5 03:50 httpd-2.4.23.tar.gz\n[root@iZ94m2e99jtZ ~]#\n\n[root@iZ94m2e99jtZ ~]# cp -r  apr-1.5.2 httpd-2.4.23/srclib/apr\n[root@iZ94m2e99jtZ ~]# cp -r  apr-util-1.5.4 httpd-2.4.23/srclib/apr-util\n\n```\n\n## 安装\n\n### Configuring the source tree\n如果使用所有默认选项，只需键入的./configure即可，但一般我们根据自己的需求来修改一些配置。\n\n其中最重要的选项应该是apache的安装位置的配置项 --prefix ；\n此外，我们可以指定哪些功能被启用和禁用模块要包含在Apache中。apache配备了一个广泛的默认包含的模块。它们将被编译为可以装载或在运行时卸载共享对象（的DSO）。您也可以选择通过选项--enable-模块=静态编译静态模块。\n\n额外的模块使用--enable模块选项，其中模块与除去mod_个串并转换为破折号任何下划线模块的名称启用。\n同样，我们可以禁用与--disable模块选件模块。使用这些选项的时候，因为配置无法警告你，如果你指定的模块不存在要小心;它会简单地忽略选项。 此外，有时需要提供的配置脚本与你的编译器，库和头文件的位置额外信息。这是通过两种环境变量或命令行选项来配置完成。有关详细信息，请参考配置页面。或使用--help选项调用配置。\n\n[Apache 官方配置说明][apache_configure_doc]\n[apache_configure_doc]:http://httpd.apache.org/docs/2.4/programs/configure.html#installationdirectories\n\n\n```\n概要\n\n你应该叫configure从分布的根目录中的脚本。\n\n./configure [OPTION]... [VAR=VALUE]...\n\n要指定环境变量（例如CC， CFLAGS......），它们指定为 。请参见下面 的一些有用的变量的说明。VAR=VALUE\n\n最佳\n选项\n\n配置选项\n安装目录\n系统类型\n可选功能\n支持程序的选项\n配置选项\n下列选项影响的行为 configure本身。\n\n-C\n--config-cache\n这是一个别名 --cache-file=config.cache\n--cache-file=FILE\n测试结果将在文件中缓存文件。此选项默认为禁用 ​​。\n-h\n--help [short|recursive]\n输出的帮助和退出。随着说法short只是具体 ​​到这个包的选项将显示出来。参数 recursive显示所有包含包的简短帮助。\n-n\n--no-create\n该configure脚本运行正常，但不创建输出文件。这是有用的生成makefile文件编译前检查测试结果。\n-q\n--quiet\n不打印checking ...在配置过程的消息。\n--srcdir=DIR\n定义目录DIR是源文件目录。默认为所在目录configure的位置，或父目录。\n--silent\n与...一样 --quiet\n-V\n- 版\n显示版权信息并退出。\n安装目录\n这些选项定义安装目录。安装树取决于所选的布局。\n\n--prefix=PREFIX\n在安装结构无关的文件PREFIX。默认安装目录设置为 /usr/local/apache2。\n--exec-prefix=EPREFIX\n在安装体系相关的文件EPREFIX。默认安装目录设置为 PREFIX目录。\n默认情况下，make install将安装所有文件 /usr/local/apache2/bin，/usr/local/apache2/lib 等等。您可以指定以外的安装前缀 /usr/local/apache2使用--prefix，例如--prefix=$HOME。\n\n定义一个目录布局\n--enable-layout=LAYOUT\n配置源代码和编译脚本的假设基础上的布局安装树布局。这使您可以分别指定为Apache HTTP服务器安装在每个类型的文件的位置。该config.layout 文件包含几个示例配置，你还可以创建下面的例子中你自己的自定义配置。该文件中的不同布局分为<Layout FOO>...</Layout>部分，并通过名称简称为中FOO，默认布局Apache。\n安装目录微调\n为了更好地控制安装目录中，使用下面的选项。请注意，目录默认被设置 autoconf，并通过相应布局设置被覆盖。\n\n--bindir=DIR\n在用户安装可执行文件DIR。用户可执行文件都支持这样的程序htpasswd， dbmmanage等等。这对于网站管理员有用。默认情况下DIR设置为 EPREFIX/bin。\n--datadir=DIR\n在安装只读体系结构无关的数据DIR。默认datadir设置为 PREFIX/share。此选项是提供 autoconf与当前未使用。\n--includedir=DIR\n在安装C头文件DIR。默认 includedir设置为 EPREFIX/include。\n--infodir=DIR\n在安装info文档DIR。默认infodir设置为 PREFIX/info。此选项当前未使用。\n--libdir=DIR\n在安装目标代码库DIR。默认 libdir设置为 EPREFIX/lib。\n--libexecdir=DIR\n在安装程序的可执行文件（例如，共享模块） DIR。默认libexecdir设置为 EPREFIX/modules。\n--localstatedir=DIR\n在安装修改的单机数据DIR。默认localstatedir设置为 PREFIX/var。此选项是提供 autoconf与当前未使用。\n--mandir=DIR\n在安装该男子文档DIR。默认 mandir设置为 EPREFIX/man。\n--oldincludedir=DIR\n在非GCC安装C头文件DIR。默认oldincludedir设置为 /usr/include。此选项是提供 autoconf与当前未使用。\n--sbindir=DIR\n在系统中安装管理员可执行DIR。这些都是服务器程序，如httpd， apachectl，suexec等，这些都需要运行在Apache HTTP服务器。默认 sbindir设置为 EPREFIX/sbin。\n--sharedstatedir=DIR\n在安装修改的架构无关的数据DIR。默认sharedstatedir设置为 PREFIX/com。此选项是提供 autoconf与当前未使用。\n--sysconfdir=DIR\n安装只读的单机数据，如服务器配置文件httpd.conf，mime.types等在 DIR。默认sysconfdir设置为 PREFIX/conf。\n系统类型\n这些选项用于交叉编译Apache HTTP服务器到另一个系统上运行。在正常的情况下，建立和运行在同一系统上的服务器时，不使用这些选项。\n\n--build=BUILD\n定义系统类型上的工具正在建立该系统。它默认为脚本的结果 config.guess。\n--host=HOST\n定义系统类型的服务器将运行，系统的 HOST默认为BUILD。\n--target=TARGET\n配置构建编译器系统类型 目标。它默认为HOST。此选项被提供autoconf，而不是必要的Apache HTTP服务器。\n可选功能\n这些选项用于微调您的HTTP服务器将具备的功能。\n\n一般语法\n一般来说，你可以使用下面的语法来启用或禁用功能：\n\n--disable-FEATURE\n不包括特征。这是相同的 。--enable-FEATURE=no\n--enable-FEATURE[=ARG]\n包括特征。为默认值ARG 为yes。\n--enable-MODULE=shared\n相应的模块将被建设成为DSO模块。默认情况下启用的模块是动态链接的。\n--enable-MODULE=static\n相应的模块将被静态链接。\n注意\n\nconfigure不会抱怨 ，即使富不存在，所以你需要仔细类型。 --enable-foo\n选择模块编译\n大多数模块由默认编译并已被明确或通过使用关键字禁用few （见--enable-modules，--enable-mods-shared 并且--enable-mods-static下面进一步解释）或--enable-modules=none作为一组被删除。\n\n其它模块默认不编译并已被明确或通过使用关键字启用all或 reallyall可用。\n\n要了解哪些模块是默认编译，运行 ./configure -h或./configure --help 下看Optional Features。假设你有兴趣mod_example1和 mod_example2，你看这个：\n\n可选功能：\n  ...\n  --disable-例1示例模块1\n  --enable-例题例如模块2\n  ...\n然后mod_example1是默认启用的，你就可以使用--disable-example1不编译。 mod_example2默认情况下禁用，你就可以使用--enable-example2 编译它。\n\n多道处理模块\n多道处理模块，或的MPM，实现了服务器的基本行为。单个MPM必须为了使服务器的功能被激活。出现在可用MPM列表 模块索引页。\n\n的MPM可以建成为数字存储示波器的动态加载或静态与服务器相连，并使用下列选项被启用：\n\n--with-mpm=MPM\n选择适合您的服务器的默认MPM。如果MPM的构建为DSO模块（见--enable-mpms-shared），该指令选择将默认的配置文件中加载的MPM。否则，这个指令选择唯一可用的MPM，这将静态链接到服务器。\n\n如果省略此选项，默认的MPM为您的操作系统将被使用。\n\n--enable-mpms-shared=MPM-LIST\n使动态共享模块的MPM的列表。这些模块之一必须动态使用加载 LoadModule指令。\n\nMPM-LIST是加了引号的MPM名称的空格分隔的列表。例如：\n\n--enable-mpms-shared='prefork worker'\n此外，您还可以使用特殊关键字all，这将选择支持在当前平台上动态加载所有的MPM和他们建立的DSO模块。例如：\n\n--enable-mpms-shared=all\n第三方模块\n要添加其他第三方模块使用下列选项：\n\n--with-module=module-type:module-file[, module-type:module-file]\n添加一个或多个第三方的模块，以静态链接模块列表。该模块的源文件module-file 将在搜索 你的Apache HTTP服务器的源代码树的子目录。如果没有找到有它正在考虑模块文件是一个绝对文件路径，并尝试将源文件复制到 模块式子目录。如果子目录不存在，它将被创建并与标准的填充 。modules/module-typeconfigureMakefile.in\n\n此选项很有用添加由一个源文件小的外部组件。对于更复杂的模块，你应该阅读供应商的文档。\n\n注意\n\n如果你想建立一个DSO模块，而不是一个静态链接使用apxs。\n累积和其他选项\n--enable-maintainer-mode\n打开调试和编译时警告，并加载所有编译的模块。\n--enable-mods-shared=MODULE-LIST\n定义启用并建立动态共享模块模块的列表。这意味着，这些模块必须通过使用动态加载 LoadModule指令。\n\nMODULE-LIST是加了引号的modulenames空格分隔列表。该模块名称没有给出前面mod_。例如：\n\n--enable-mods-shared='headers rewrite dav'\n此外，您还可以使用特殊的关键字reallyall， all，most和few。例如，\n\n--enable-mods-shared=most\n将编译大多数模块，并将其建设成为DSO模块，\n\n--enable-mods-shared=few\n将只编译一个非常基本的模块组。\n\n默认设置为most。\n\n在LoadModule对所选择的模块的指令将在主配置文件中自动生成。默认情况下，所有的指令都只是由一个配置要求或明确选择的模块被注释掉--enable-foo的说法。您可以更改设置启用或关闭加载的模块LoadModule的指令 httpd.conf。此外， LoadModule所有构建的模块的指令可通过配置选项被激活 --enable-load-all-modules。\n\n--enable-mods-static=MODULE-LIST\n此选项的行为类似--enable-mods-shared，但在给定的模块静态链接。这意味着，这些模块将始终存在，同时运行httpd。他们不必被加载LoadModule。\n--enable-modules=MODULE-LIST\n此选项的行为等来--enable-mods-shared，并且还将动态地链接的给定模块。特殊关键字none禁用所有模块的版本。\n--enable-v4-mapped\n允许IPv6的套接字来处理IPv4连接。\n--with-port=PORT\n这定义上的端口httpd会听。生成配置文件时，该端口号用于 httpd.conf。默认值是80。\n--with-program-name\n定义一个替代的可执行文件名 ​​称。默认值是 httpd。\n可选包\n这些选项用于定义可选包。\n\n一般语法\n一般来说，你可以使用下面的语法定义一个可选包：\n\n--with-PACKAGE[=ARG]\n使用包PACKAGE。为默认值 ARG为yes。\n--without-PACKAGE\n不要使用包PACKAGE。这是相同的 。此选项所提供 ，但对于Apache HTTP服务器不是非常有用。--with-PACKAGE=noautoconf\n特定软件包\n--with-apr=DIR|FILE\n在Apache可移植运行时（APR）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的年利率，而不是你要告诉configure路径的 apr-config脚本。你可以设置绝对路径和名称或目录切换到安装四月apr-config必须在该目录或子目录中存在 bin。\n--with-apr-util=DIR|FILE\nApache可移植运行实用程序（APU）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的APU，而不是你要告诉configure路径的 apu-config脚本。你可以设置绝对路径和名称或目录切换到安装APU，apu-config必须在该目录或子目录中存在 bin。\n--with-ssl=DIR\n如果mod_ssl已启用configure 已安装的OpenSSL的搜索。您可以将目录路径设置为SSL / TLS工具包来代替。\n--with-z=DIR\nconfigure已安装的自动搜索 zlib，如果你的源配置需要一个库（例如，当mod_deflate使能）。您可以设置压缩库的目录路径来代替。\nApache HTTP服务器的一些特性，如 mod_authn_dbm和mod_rewrite的DBM RewriteMap使用简单的键/值对数据库信息的快速查询。SDBM被包括在APU，所以这个数据库是始终可用。如果您想使用其他数据库类型，可以使用下面的选项，以使它们：\n\n--with-gdbm[=path]\n如果没有路径指定，configure将搜索在平时的搜索路径GNU DBM安装的包含文件和库。一个明确的 路径会导致configure在寻找 path/lib，并 path/include为相关的文件。最后，路径可以指定用冒号隔开具体包括和库路径。\n--with-ndbm[=path]\n像--with-gdbm，但搜索新DBM安装。\n--with-berkeley-db[=path]\n像--with-gdbm，但搜索一个Berkeley DB的安装。\n注意\n\n由APU提供，并通过其配置脚本传递的DBM选项。他们利用确定已安装的APU时是无用的--with-apr-util。\n您可以使用自己的HTTP服务器一起使用一个以上的DBM实现。该拨款DBM类型将每次运行时配置中配置。\n支持程序的选项\n--enable-static-support\n构建支持二进制文件的静态链接的版本。这意味着，一个独立的可执行文件将集成所有必要的库来构建。否则，支持二进制文件默认情况下，动态链接。\n--enable-suexec\n使用此选项可启用suexec，它允许您设置UID和GID的催生过程。除非你了解你的服务器上运行的SUID二进制的所有安全隐患，请勿使用此选项。更多选项来配置suexec介绍如下。\n这可以通过使用下列选项来创建一个单一的支持程序的静态链接二进制文件：\n\n--enable-static-ab\n建立一个静态链接的版本ab。\n--enable-static-checkgid\n建立一个静态链接的版本checkgid。\n--enable-static-htdbm\n建立一个静态链接的版本htdbm。\n--enable-static-htdigest\n建立一个静态链接的版本htdigest。\n--enable-static-htpasswd\n建立一个静态链接的版本htpasswd。\n--enable-static-logresolve\n建立一个静态链接的版本logresolve。\n--enable-static-rotatelogs\n建立一个静态链接的版本rotatelogs。\nsuexec 配置选项\n下列选项用于微调的行为suexec。参见配置和安装suEXEC的 进一步的信息。\n\n--with-suexec-bin\n这定义的路径suexec二进制文件。默认值是--sbindir（见安装目录微调）。\n--with-suexec-caller\n这定义允许呼叫的用户suexec。它应该是相同下，用户 httpd正常运行。\n--with-suexec-docroot\n这个定义下的目录树suexec允许访问的可执行文件。默认值是 --datadir/htdocs。\n--with-suexec-gidmin\n这个定义的最低GID成为目标用户 suexec。默认值是100。\n--with-suexec-logfile\n这个定义的文件名suexec​​日志文件。默认情况下，日志文件被命名为suexec_log，位于 --logfiledir。\n--with-suexec-safepath\n定义环境变量的值PATH由启动的进 ​​程进行设置suexec。默认值是/usr/local/bin:/usr/bin:/bin。\n--with-suexec-userdir\n此定义包含所有可执行文件的用户目录下的子目录suexec的访问是允许的。当你想使用此设置时必须 suexec使用特定用户目录在一起（如所提供的mod_userdir）。默认值是 public_html。\n--with-suexec-uidmin\n它定义为最低的UID允许为目标用户 suexec。默认值是100。\n--with-suexec-umask\n设置umask由启动的进 ​​程 suexec。它默认为您的系统设置。\n最佳\n环境变量\n\n有一些有用的环境变量覆盖所作出的选择 configure，或帮助它找到库和程序与非标准名称或位置。\n\nCC\n定义要用于编译的C编译器的命令。\nCFLAGS\n要使用编译设置C编译器的标志。\nCPP\n定义C预处理命令使用。\nCPPFLAGS\n将C / C ++预处理器的标志，例如 ，如果你在一个非标准目录头了includedir。-Iincludedir\nLDFLAGS\n设置连接器选项，例如，如果你在一个非标准目录库LIBDIR。-Llibdir\n\n\n```\n\n***示例：***\n这里是一个典型的例子编译Apache，安装树/ SW /包装/与特定的编译器和标志，加上两个额外的模块阿帕奇mod_ldap模块和mod_lua\n\n```\n$ CC=\"pgcc\" CFLAGS=\"-O2\" \\\n./configure --prefix=/sw/pkg/apache \\\n--enable-ldap=shared \\\n--enable-lua=shared\n\n```\n\n我们本次采用基本的默认设置 来进行安装\n```\n[root@iZ94m2e99jtZ ~]# cd httpd-2.4.23\n[root@iZ94m2e99jtZ httpd-2.4.23]# ./configure  --with-included-apr\n\n```\n\n### Build\n\n```\n[root@iZ94m2e99jtZ httpd-2.4.23]# make\n```\n### Install\n```\n[root@iZ94m2e99jtZ httpd-2.4.23]# make install\n···\nInstalling configuration files\nmkdir /usr/local/apache2/conf\nmkdir /usr/local/apache2/conf/extra\nmkdir /usr/local/apache2/conf/original\nmkdir /usr/local/apache2/conf/original/extra\nInstalling HTML documents\nmkdir /usr/local/apache2/htdocs\nInstalling error documents\nmkdir /usr/local/apache2/error\nInstalling icons\nmkdir /usr/local/apache2/icons\nmkdir /usr/local/apache2/logs\nInstalling CGIs\nmkdir /usr/local/apache2/cgi-bin\nInstalling header files\nInstalling build system files\nInstalling man pages and online manual\nmkdir /usr/local/apache2/man\nmkdir /usr/local/apache2/man/man1\nmkdir /usr/local/apache2/man/man8\nmkdir /usr/local/apache2/manual\n```\n\n### Customize（定制）\n\n接下来，我们可以通过在 /usr/local/apache2/conf 目录，编辑配置文件来自定义我们的Apache HTTP服务器。\n\n[配置指令快速参考索引][apache_conf_directive_index]\n[apache_conf_directive_index]:http://httpd.apache.org/docs/2.4/zh-cn/mod/directives.html\n\n### Testinh(测试)\n启动Apache服务器\n```\n[root@iZ94m2e99jtZ httpd-2.4.23]# /usr/local/apache2/bin/apachectl -k start\n\n[root@iZ94m2e99jtZ httpd-2.4.23]# ps aux | grep httpd\nroot     15386  0.0  0.2  70556  2188 ?        Ss   11:53   0:00 /usr/local/apache2/bin/httpd -k start\ndaemon   15387  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start\ndaemon   15388  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start\ndaemon   15389  0.0  0.4 359520  4256 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start\nroot     15472  0.0  0.0 112664   972 pts/0    S+   11:53   0:00 grep --color=auto httpd\n```\n浏览器访问：http://IP地址\n\n当出现『It works!』字样说明我们已经安装成功\n\n***注意*** 如果通过浏览器访问不到，可能是请求服务器防火墙给拦截了，所以我们需要在防火墙里将我们用到的80端口给放行。\n我以我当前Centos7 的系统为例，Centos7现在默认的防火墙是firewalld，Centos6以及6以前的版本则使用的是iptables，所以具体设置方法还请自己去搜索。\n```\n[root@iZ94m2e99jtZ ~]# firewall-cmd  --permanent --zone=public --add-port=80/tcp  #将80端口开放\nsuccess\n[root@iZ94m2e99jtZ ~]# firewall-cmd  --reload #重新加载防火墙配置\nsuccess\n```\n## 日常管理\n一般常见的管理方式有两种\n* 直接通过httpd命令来管理\n* 通过apachectl来管理\n***Tips*** apachetl其实一个是对httpd命令进行了封装sh脚本\n\n### 常用命令\n\n```\n#通过apachectl来管理\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k start  #启动\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k restart  #重启\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k stop  #停止\n\n#直接通过httpd命令来管理\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/httpd -k start|restart|graceful|graceful-stop|stop\n\n```\n\n### 具体参数\n```\nUsage: /usr/local/apache2/bin/httpd [-D name] [-d directory] [-f file]\n                                    [-C \"directive\"] [-c \"directive\"]\n                                    [-k start|restart|graceful|graceful-stop|stop]\n                                    [-v] [-V] [-h] [-l] [-L] [-t] [-T] [-S] [-X]\nOptions:\n  -D name            : define a name for use in <IfDefine name> directives\n  -d directory       : specify an alternate initial ServerRoot\n  -f file            : specify an alternate ServerConfigFile\n  -C \"directive\"     : process directive before reading config files\n  -c \"directive\"     : process directive after reading config files\n  -e level           : show startup errors of level (see LogLevel)\n  -E file            : log startup errors to file\n  -v                 : show version number\n  -V                 : show compile settings\n  -h                 : list available command line options (this page)\n  -l                 : list compiled in modules\n  -L                 : list available configuration directives\n  -t -D DUMP_VHOSTS  : show parsed vhost settings\n  -t -D DUMP_RUN_CFG : show parsed run settings\n  -S                 : a synonym for -t -D DUMP_VHOSTS -D DUMP_RUN_CFG\n  -t -D DUMP_MODULES : show all loaded modules\n  -M                 : a synonym for -t -D DUMP_MODULES\n  -t -D DUMP_INCLUDES: show all included configuration files\n  -t                 : run syntax check for config files\n  -T                 : start without DocumentRoot(s) check\n  -X                 : debug mode (only one worker, do not detach)\n\n```\n","source":"_posts/Apache安装汇总.md","raw":"---\ntitle: Apache的安装\ndate: 2016-08-09 14:00:00\nauthor: zhimiao\ntags:\n- Web服务器\n- Apache\ncategories:\n- Apache\n---\n\nApache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。\nApache的安装无外乎两种方式：\n* 二进制包安装\n* 源码包安装\n\n\n<!-- more -->\n\n接下来我将会演示和记录通过源码包来安装apache到服务器。\n环境：阿里云 Centos 7.2 64\n\n## 安装前准备工作\n通过源码包安装，我们需要将源码编译成计算机运行的二进制，因此我们需要编译工具。\n### gcc安装\nGNU编译器套件（GNU Compiler Collection）包括C、C++、Objective-C、Fortran、Java、Ada和Go语言的前端，也包括了这些语言的库（如libstdc++、libgcj等等）。GCC的初衷是为GNU操作系统专门编写的一款编译器。\n```\n[root@iZ28v78hcmrZ ~]# gcc\ngcc: 致命错误：没有输入文件\n编译中断。\n[root@iZ28v78hcmrZ ~]# yum install gcc\n···\n作为依赖被升级:\n  cpp.x86_64 0:4.8.5-4.el7            gcc-c++.x86_64 0:4.8.5-4.el7            gcc-gfortran.x86_64 0:4.8.5-4.el7    libgcc.x86_64 0:4.8.5-4.el7\n  libgfortran.x86_64 0:4.8.5-4.el7    libgomp.x86_64 0:4.8.5-4.el7            libquadmath.x86_64 0:4.8.5-4.el7     libquadmath-devel.x86_64 0:4.8.5-4.el7\n  libstdc++.x86_64 0:4.8.5-4.el7      libstdc++-devel.x86_64 0:4.8.5-4.el7\n\n完毕！\n[root@iZ28v78hcmrZ ~]#\n```\n### APR、APR-UTIL 安装\n\nAPR （全称：Apache Portable Runtime）可移植运行时库、APR-UTIL（全称：Apache Portable Runtime Utility Library）可移植运行时工具库。它们的作用是使得对平台细节的处理进行下移。对于应用程序而言，它们根本就不需要考虑具体的平台，不管是Unix、Linux还是Window，应用程序执行的接口基本都是统一一致的。\nAPR的目标则是希望安全合并所有的能够合并的代码而不需要牺牲性能，为大多数平台提供所有的APR特性支持，包括Win32、OS/2、BeOS、Darwin、Linux等等。\n\n\n\n关于apr和apr-util，apache可以使用系统已经安装的版本，也可以不实用系统提供的版本。具体方法是分别下载apr和apr-util，解压到apache源码包中的srclib/apr和srclib/apr-util路径中（路径中不包含版本号等信息），在编译源码包之前的./configure 过程中使用 --with-included-apr 选项\n\n### PRCE (Perl-Compatible Regular Expressions Library,Perl兼容的正则表达式库)\nPCRE(Perl Compatible Regular Expressions)是一个用C语言编写的正则表达式函数库。\nPCRE被广泛使用在许多开源软件之中，最著名的莫过于Apache HTTP服务器和PHP脚本语言、R脚本语言，此外，正如从其名字所能看到的，PCRE也是perl语言的缺省正则库。\n\n[PCRE 下载网址][pcre_download]\n[pcre_download]:https://sourceforge.net/projects/pcre/files/\n\n```\n#解压\n[root@iZ94m2e99jtZ ~]# tar -zxvf pcre-8.38.tar.gz\n[root@iZ94m2e99jtZ ~]# cd pcre-8.38\n[root@iZ94m2e99jtZ pcre-8.38]# ./configure\n···\npcre-8.38 configuration summary:\n\n    Install prefix .................. : /usr/local\n    C preprocessor .................. : gcc -E\n    C compiler ...................... : gcc\n    C++ preprocessor ................ : g++ -E\n    C++ compiler .................... : g++\n    Linker .......................... : /usr/bin/ld -m elf_x86_64\n    C preprocessor flags ............ :\n    C compiler flags ................ : -g -O2 -fvisibility=hidden\n    C++ compiler flags .............. : -O2 -fvisibility=hidden -fvisibility-inlines-hidden\n    Linker flags .................... :\n    Extra libraries ................. :\n\n    Build 8 bit pcre library ........ : yes\n    Build 16 bit pcre library ....... : no\n    Build 32 bit pcre library ....... : no\n    Build C++ library ............... : yes\n    Enable JIT compiling support .... : no\n    Enable UTF-8/16/32 support ...... : no\n    Unicode properties .............. : no\n    Newline char/sequence ........... : lf\n    \\R matches only ANYCRLF ......... : no\n    EBCDIC coding ................... : no\n    EBCDIC code for NL .............. : n/a\n    Rebuild char tables ............. : no\n    Use stack recursion ............. : yes\n    POSIX mem threshold ............. : 10\n    Internal link size .............. : 2\n    Nested parentheses limit ........ : 250\n    Match limit ..................... : 10000000\n    Match limit recursion ........... : MATCH_LIMIT\n    Build shared libs ............... : yes\n    Build static libs ............... : yes\n    Use JIT in pcregrep ............. : no\n    Buffer size for pcregrep ........ : 20480\n    Link pcregrep with libz ......... : no\n    Link pcregrep with libbz2 ....... : no\n    Link pcretest with libedit ...... : no\n    Link pcretest with libreadline .. : no\n    Valgrind support ................ : no\n    Code coverage ................... : no\n\n[root@iZ94m2e99jtZ pcre-8.38]# make & make install\n\n```\n\n**Tips**\n在编译pcre时可能会出现这样的：configure: error: You need a C++ compiler for C++ support.提示我们缺少一个C++ 的编译器，需要我们再安装一个C++的编译器。\n```\n[root@iZ94m2e99jtZ pcre-8.38]# yum install gcc-c++\n\n```\n\n\n\n\n### 下载\n\n[apr、apr-uitl官网][apr_website]\n[apr_website]:http://apr.apache.org/\n\n[apr 下载地址][apr_1.5.2_download]\n[apr_1.5.2_download]:http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz\n[apr-uitl 下载地址][apr-uitl_1.5.4_download]\n[apr-uitl_1.5.4_download]:http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz\n\n\n[apache 源码包][apache_download]\n[apache_download]:http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz\n\n下载、解压、将apr和apr-util分别复制到httpd-2.4.23/srclib/apr和httpd-2.4.23/srclib/apr-util中\n\n```\n[root@iZ94m2e99jtZ ~]# wget http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz\n[root@iZ94m2e99jtZ ~]# wget  http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz\n[root@iZ94m2e99jtZ ~]# wget http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz\n\n[root@iZ94m2e99jtZ ~]# tar -zxvf apr-1.5.2.tar.gz\n[root@iZ94m2e99jtZ ~]# tar -zxvf apr-util-1.5.4.tar.gz\n[root@iZ94m2e99jtZ ~]# tar -zxvf httpd-2.4.23.tar.gz\n\n[root@iZ94m2e99jtZ ~]# ll\n总用量 10088\ndrwxr-xr-x 27 1000  1000    4096 4月  25 2015 apr-1.5.2\n-rw-r--r--  1 root root  1031613 4月  29 2015 apr-1.5.2.tar.gz\ndrwxr-xr-x 19 1000  1000    4096 9月  17 2014 apr-util-1.5.4\n-rw-r--r--  1 root root   874044 9月  20 2014 apr-util-1.5.4.tar.gz\ndrwxr-xr-x 11  501 games    4096 7月   1 01:15 httpd-2.4.23\n-rw-r--r--  1 root root  8406575 7月   5 03:50 httpd-2.4.23.tar.gz\n[root@iZ94m2e99jtZ ~]#\n\n[root@iZ94m2e99jtZ ~]# cp -r  apr-1.5.2 httpd-2.4.23/srclib/apr\n[root@iZ94m2e99jtZ ~]# cp -r  apr-util-1.5.4 httpd-2.4.23/srclib/apr-util\n\n```\n\n## 安装\n\n### Configuring the source tree\n如果使用所有默认选项，只需键入的./configure即可，但一般我们根据自己的需求来修改一些配置。\n\n其中最重要的选项应该是apache的安装位置的配置项 --prefix ；\n此外，我们可以指定哪些功能被启用和禁用模块要包含在Apache中。apache配备了一个广泛的默认包含的模块。它们将被编译为可以装载或在运行时卸载共享对象（的DSO）。您也可以选择通过选项--enable-模块=静态编译静态模块。\n\n额外的模块使用--enable模块选项，其中模块与除去mod_个串并转换为破折号任何下划线模块的名称启用。\n同样，我们可以禁用与--disable模块选件模块。使用这些选项的时候，因为配置无法警告你，如果你指定的模块不存在要小心;它会简单地忽略选项。 此外，有时需要提供的配置脚本与你的编译器，库和头文件的位置额外信息。这是通过两种环境变量或命令行选项来配置完成。有关详细信息，请参考配置页面。或使用--help选项调用配置。\n\n[Apache 官方配置说明][apache_configure_doc]\n[apache_configure_doc]:http://httpd.apache.org/docs/2.4/programs/configure.html#installationdirectories\n\n\n```\n概要\n\n你应该叫configure从分布的根目录中的脚本。\n\n./configure [OPTION]... [VAR=VALUE]...\n\n要指定环境变量（例如CC， CFLAGS......），它们指定为 。请参见下面 的一些有用的变量的说明。VAR=VALUE\n\n最佳\n选项\n\n配置选项\n安装目录\n系统类型\n可选功能\n支持程序的选项\n配置选项\n下列选项影响的行为 configure本身。\n\n-C\n--config-cache\n这是一个别名 --cache-file=config.cache\n--cache-file=FILE\n测试结果将在文件中缓存文件。此选项默认为禁用 ​​。\n-h\n--help [short|recursive]\n输出的帮助和退出。随着说法short只是具体 ​​到这个包的选项将显示出来。参数 recursive显示所有包含包的简短帮助。\n-n\n--no-create\n该configure脚本运行正常，但不创建输出文件。这是有用的生成makefile文件编译前检查测试结果。\n-q\n--quiet\n不打印checking ...在配置过程的消息。\n--srcdir=DIR\n定义目录DIR是源文件目录。默认为所在目录configure的位置，或父目录。\n--silent\n与...一样 --quiet\n-V\n- 版\n显示版权信息并退出。\n安装目录\n这些选项定义安装目录。安装树取决于所选的布局。\n\n--prefix=PREFIX\n在安装结构无关的文件PREFIX。默认安装目录设置为 /usr/local/apache2。\n--exec-prefix=EPREFIX\n在安装体系相关的文件EPREFIX。默认安装目录设置为 PREFIX目录。\n默认情况下，make install将安装所有文件 /usr/local/apache2/bin，/usr/local/apache2/lib 等等。您可以指定以外的安装前缀 /usr/local/apache2使用--prefix，例如--prefix=$HOME。\n\n定义一个目录布局\n--enable-layout=LAYOUT\n配置源代码和编译脚本的假设基础上的布局安装树布局。这使您可以分别指定为Apache HTTP服务器安装在每个类型的文件的位置。该config.layout 文件包含几个示例配置，你还可以创建下面的例子中你自己的自定义配置。该文件中的不同布局分为<Layout FOO>...</Layout>部分，并通过名称简称为中FOO，默认布局Apache。\n安装目录微调\n为了更好地控制安装目录中，使用下面的选项。请注意，目录默认被设置 autoconf，并通过相应布局设置被覆盖。\n\n--bindir=DIR\n在用户安装可执行文件DIR。用户可执行文件都支持这样的程序htpasswd， dbmmanage等等。这对于网站管理员有用。默认情况下DIR设置为 EPREFIX/bin。\n--datadir=DIR\n在安装只读体系结构无关的数据DIR。默认datadir设置为 PREFIX/share。此选项是提供 autoconf与当前未使用。\n--includedir=DIR\n在安装C头文件DIR。默认 includedir设置为 EPREFIX/include。\n--infodir=DIR\n在安装info文档DIR。默认infodir设置为 PREFIX/info。此选项当前未使用。\n--libdir=DIR\n在安装目标代码库DIR。默认 libdir设置为 EPREFIX/lib。\n--libexecdir=DIR\n在安装程序的可执行文件（例如，共享模块） DIR。默认libexecdir设置为 EPREFIX/modules。\n--localstatedir=DIR\n在安装修改的单机数据DIR。默认localstatedir设置为 PREFIX/var。此选项是提供 autoconf与当前未使用。\n--mandir=DIR\n在安装该男子文档DIR。默认 mandir设置为 EPREFIX/man。\n--oldincludedir=DIR\n在非GCC安装C头文件DIR。默认oldincludedir设置为 /usr/include。此选项是提供 autoconf与当前未使用。\n--sbindir=DIR\n在系统中安装管理员可执行DIR。这些都是服务器程序，如httpd， apachectl，suexec等，这些都需要运行在Apache HTTP服务器。默认 sbindir设置为 EPREFIX/sbin。\n--sharedstatedir=DIR\n在安装修改的架构无关的数据DIR。默认sharedstatedir设置为 PREFIX/com。此选项是提供 autoconf与当前未使用。\n--sysconfdir=DIR\n安装只读的单机数据，如服务器配置文件httpd.conf，mime.types等在 DIR。默认sysconfdir设置为 PREFIX/conf。\n系统类型\n这些选项用于交叉编译Apache HTTP服务器到另一个系统上运行。在正常的情况下，建立和运行在同一系统上的服务器时，不使用这些选项。\n\n--build=BUILD\n定义系统类型上的工具正在建立该系统。它默认为脚本的结果 config.guess。\n--host=HOST\n定义系统类型的服务器将运行，系统的 HOST默认为BUILD。\n--target=TARGET\n配置构建编译器系统类型 目标。它默认为HOST。此选项被提供autoconf，而不是必要的Apache HTTP服务器。\n可选功能\n这些选项用于微调您的HTTP服务器将具备的功能。\n\n一般语法\n一般来说，你可以使用下面的语法来启用或禁用功能：\n\n--disable-FEATURE\n不包括特征。这是相同的 。--enable-FEATURE=no\n--enable-FEATURE[=ARG]\n包括特征。为默认值ARG 为yes。\n--enable-MODULE=shared\n相应的模块将被建设成为DSO模块。默认情况下启用的模块是动态链接的。\n--enable-MODULE=static\n相应的模块将被静态链接。\n注意\n\nconfigure不会抱怨 ，即使富不存在，所以你需要仔细类型。 --enable-foo\n选择模块编译\n大多数模块由默认编译并已被明确或通过使用关键字禁用few （见--enable-modules，--enable-mods-shared 并且--enable-mods-static下面进一步解释）或--enable-modules=none作为一组被删除。\n\n其它模块默认不编译并已被明确或通过使用关键字启用all或 reallyall可用。\n\n要了解哪些模块是默认编译，运行 ./configure -h或./configure --help 下看Optional Features。假设你有兴趣mod_example1和 mod_example2，你看这个：\n\n可选功能：\n  ...\n  --disable-例1示例模块1\n  --enable-例题例如模块2\n  ...\n然后mod_example1是默认启用的，你就可以使用--disable-example1不编译。 mod_example2默认情况下禁用，你就可以使用--enable-example2 编译它。\n\n多道处理模块\n多道处理模块，或的MPM，实现了服务器的基本行为。单个MPM必须为了使服务器的功能被激活。出现在可用MPM列表 模块索引页。\n\n的MPM可以建成为数字存储示波器的动态加载或静态与服务器相连，并使用下列选项被启用：\n\n--with-mpm=MPM\n选择适合您的服务器的默认MPM。如果MPM的构建为DSO模块（见--enable-mpms-shared），该指令选择将默认的配置文件中加载的MPM。否则，这个指令选择唯一可用的MPM，这将静态链接到服务器。\n\n如果省略此选项，默认的MPM为您的操作系统将被使用。\n\n--enable-mpms-shared=MPM-LIST\n使动态共享模块的MPM的列表。这些模块之一必须动态使用加载 LoadModule指令。\n\nMPM-LIST是加了引号的MPM名称的空格分隔的列表。例如：\n\n--enable-mpms-shared='prefork worker'\n此外，您还可以使用特殊关键字all，这将选择支持在当前平台上动态加载所有的MPM和他们建立的DSO模块。例如：\n\n--enable-mpms-shared=all\n第三方模块\n要添加其他第三方模块使用下列选项：\n\n--with-module=module-type:module-file[, module-type:module-file]\n添加一个或多个第三方的模块，以静态链接模块列表。该模块的源文件module-file 将在搜索 你的Apache HTTP服务器的源代码树的子目录。如果没有找到有它正在考虑模块文件是一个绝对文件路径，并尝试将源文件复制到 模块式子目录。如果子目录不存在，它将被创建并与标准的填充 。modules/module-typeconfigureMakefile.in\n\n此选项很有用添加由一个源文件小的外部组件。对于更复杂的模块，你应该阅读供应商的文档。\n\n注意\n\n如果你想建立一个DSO模块，而不是一个静态链接使用apxs。\n累积和其他选项\n--enable-maintainer-mode\n打开调试和编译时警告，并加载所有编译的模块。\n--enable-mods-shared=MODULE-LIST\n定义启用并建立动态共享模块模块的列表。这意味着，这些模块必须通过使用动态加载 LoadModule指令。\n\nMODULE-LIST是加了引号的modulenames空格分隔列表。该模块名称没有给出前面mod_。例如：\n\n--enable-mods-shared='headers rewrite dav'\n此外，您还可以使用特殊的关键字reallyall， all，most和few。例如，\n\n--enable-mods-shared=most\n将编译大多数模块，并将其建设成为DSO模块，\n\n--enable-mods-shared=few\n将只编译一个非常基本的模块组。\n\n默认设置为most。\n\n在LoadModule对所选择的模块的指令将在主配置文件中自动生成。默认情况下，所有的指令都只是由一个配置要求或明确选择的模块被注释掉--enable-foo的说法。您可以更改设置启用或关闭加载的模块LoadModule的指令 httpd.conf。此外， LoadModule所有构建的模块的指令可通过配置选项被激活 --enable-load-all-modules。\n\n--enable-mods-static=MODULE-LIST\n此选项的行为类似--enable-mods-shared，但在给定的模块静态链接。这意味着，这些模块将始终存在，同时运行httpd。他们不必被加载LoadModule。\n--enable-modules=MODULE-LIST\n此选项的行为等来--enable-mods-shared，并且还将动态地链接的给定模块。特殊关键字none禁用所有模块的版本。\n--enable-v4-mapped\n允许IPv6的套接字来处理IPv4连接。\n--with-port=PORT\n这定义上的端口httpd会听。生成配置文件时，该端口号用于 httpd.conf。默认值是80。\n--with-program-name\n定义一个替代的可执行文件名 ​​称。默认值是 httpd。\n可选包\n这些选项用于定义可选包。\n\n一般语法\n一般来说，你可以使用下面的语法定义一个可选包：\n\n--with-PACKAGE[=ARG]\n使用包PACKAGE。为默认值 ARG为yes。\n--without-PACKAGE\n不要使用包PACKAGE。这是相同的 。此选项所提供 ，但对于Apache HTTP服务器不是非常有用。--with-PACKAGE=noautoconf\n特定软件包\n--with-apr=DIR|FILE\n在Apache可移植运行时（APR）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的年利率，而不是你要告诉configure路径的 apr-config脚本。你可以设置绝对路径和名称或目录切换到安装四月apr-config必须在该目录或子目录中存在 bin。\n--with-apr-util=DIR|FILE\nApache可移植运行实用程序（APU）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的APU，而不是你要告诉configure路径的 apu-config脚本。你可以设置绝对路径和名称或目录切换到安装APU，apu-config必须在该目录或子目录中存在 bin。\n--with-ssl=DIR\n如果mod_ssl已启用configure 已安装的OpenSSL的搜索。您可以将目录路径设置为SSL / TLS工具包来代替。\n--with-z=DIR\nconfigure已安装的自动搜索 zlib，如果你的源配置需要一个库（例如，当mod_deflate使能）。您可以设置压缩库的目录路径来代替。\nApache HTTP服务器的一些特性，如 mod_authn_dbm和mod_rewrite的DBM RewriteMap使用简单的键/值对数据库信息的快速查询。SDBM被包括在APU，所以这个数据库是始终可用。如果您想使用其他数据库类型，可以使用下面的选项，以使它们：\n\n--with-gdbm[=path]\n如果没有路径指定，configure将搜索在平时的搜索路径GNU DBM安装的包含文件和库。一个明确的 路径会导致configure在寻找 path/lib，并 path/include为相关的文件。最后，路径可以指定用冒号隔开具体包括和库路径。\n--with-ndbm[=path]\n像--with-gdbm，但搜索新DBM安装。\n--with-berkeley-db[=path]\n像--with-gdbm，但搜索一个Berkeley DB的安装。\n注意\n\n由APU提供，并通过其配置脚本传递的DBM选项。他们利用确定已安装的APU时是无用的--with-apr-util。\n您可以使用自己的HTTP服务器一起使用一个以上的DBM实现。该拨款DBM类型将每次运行时配置中配置。\n支持程序的选项\n--enable-static-support\n构建支持二进制文件的静态链接的版本。这意味着，一个独立的可执行文件将集成所有必要的库来构建。否则，支持二进制文件默认情况下，动态链接。\n--enable-suexec\n使用此选项可启用suexec，它允许您设置UID和GID的催生过程。除非你了解你的服务器上运行的SUID二进制的所有安全隐患，请勿使用此选项。更多选项来配置suexec介绍如下。\n这可以通过使用下列选项来创建一个单一的支持程序的静态链接二进制文件：\n\n--enable-static-ab\n建立一个静态链接的版本ab。\n--enable-static-checkgid\n建立一个静态链接的版本checkgid。\n--enable-static-htdbm\n建立一个静态链接的版本htdbm。\n--enable-static-htdigest\n建立一个静态链接的版本htdigest。\n--enable-static-htpasswd\n建立一个静态链接的版本htpasswd。\n--enable-static-logresolve\n建立一个静态链接的版本logresolve。\n--enable-static-rotatelogs\n建立一个静态链接的版本rotatelogs。\nsuexec 配置选项\n下列选项用于微调的行为suexec。参见配置和安装suEXEC的 进一步的信息。\n\n--with-suexec-bin\n这定义的路径suexec二进制文件。默认值是--sbindir（见安装目录微调）。\n--with-suexec-caller\n这定义允许呼叫的用户suexec。它应该是相同下，用户 httpd正常运行。\n--with-suexec-docroot\n这个定义下的目录树suexec允许访问的可执行文件。默认值是 --datadir/htdocs。\n--with-suexec-gidmin\n这个定义的最低GID成为目标用户 suexec。默认值是100。\n--with-suexec-logfile\n这个定义的文件名suexec​​日志文件。默认情况下，日志文件被命名为suexec_log，位于 --logfiledir。\n--with-suexec-safepath\n定义环境变量的值PATH由启动的进 ​​程进行设置suexec。默认值是/usr/local/bin:/usr/bin:/bin。\n--with-suexec-userdir\n此定义包含所有可执行文件的用户目录下的子目录suexec的访问是允许的。当你想使用此设置时必须 suexec使用特定用户目录在一起（如所提供的mod_userdir）。默认值是 public_html。\n--with-suexec-uidmin\n它定义为最低的UID允许为目标用户 suexec。默认值是100。\n--with-suexec-umask\n设置umask由启动的进 ​​程 suexec。它默认为您的系统设置。\n最佳\n环境变量\n\n有一些有用的环境变量覆盖所作出的选择 configure，或帮助它找到库和程序与非标准名称或位置。\n\nCC\n定义要用于编译的C编译器的命令。\nCFLAGS\n要使用编译设置C编译器的标志。\nCPP\n定义C预处理命令使用。\nCPPFLAGS\n将C / C ++预处理器的标志，例如 ，如果你在一个非标准目录头了includedir。-Iincludedir\nLDFLAGS\n设置连接器选项，例如，如果你在一个非标准目录库LIBDIR。-Llibdir\n\n\n```\n\n***示例：***\n这里是一个典型的例子编译Apache，安装树/ SW /包装/与特定的编译器和标志，加上两个额外的模块阿帕奇mod_ldap模块和mod_lua\n\n```\n$ CC=\"pgcc\" CFLAGS=\"-O2\" \\\n./configure --prefix=/sw/pkg/apache \\\n--enable-ldap=shared \\\n--enable-lua=shared\n\n```\n\n我们本次采用基本的默认设置 来进行安装\n```\n[root@iZ94m2e99jtZ ~]# cd httpd-2.4.23\n[root@iZ94m2e99jtZ httpd-2.4.23]# ./configure  --with-included-apr\n\n```\n\n### Build\n\n```\n[root@iZ94m2e99jtZ httpd-2.4.23]# make\n```\n### Install\n```\n[root@iZ94m2e99jtZ httpd-2.4.23]# make install\n···\nInstalling configuration files\nmkdir /usr/local/apache2/conf\nmkdir /usr/local/apache2/conf/extra\nmkdir /usr/local/apache2/conf/original\nmkdir /usr/local/apache2/conf/original/extra\nInstalling HTML documents\nmkdir /usr/local/apache2/htdocs\nInstalling error documents\nmkdir /usr/local/apache2/error\nInstalling icons\nmkdir /usr/local/apache2/icons\nmkdir /usr/local/apache2/logs\nInstalling CGIs\nmkdir /usr/local/apache2/cgi-bin\nInstalling header files\nInstalling build system files\nInstalling man pages and online manual\nmkdir /usr/local/apache2/man\nmkdir /usr/local/apache2/man/man1\nmkdir /usr/local/apache2/man/man8\nmkdir /usr/local/apache2/manual\n```\n\n### Customize（定制）\n\n接下来，我们可以通过在 /usr/local/apache2/conf 目录，编辑配置文件来自定义我们的Apache HTTP服务器。\n\n[配置指令快速参考索引][apache_conf_directive_index]\n[apache_conf_directive_index]:http://httpd.apache.org/docs/2.4/zh-cn/mod/directives.html\n\n### Testinh(测试)\n启动Apache服务器\n```\n[root@iZ94m2e99jtZ httpd-2.4.23]# /usr/local/apache2/bin/apachectl -k start\n\n[root@iZ94m2e99jtZ httpd-2.4.23]# ps aux | grep httpd\nroot     15386  0.0  0.2  70556  2188 ?        Ss   11:53   0:00 /usr/local/apache2/bin/httpd -k start\ndaemon   15387  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start\ndaemon   15388  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start\ndaemon   15389  0.0  0.4 359520  4256 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start\nroot     15472  0.0  0.0 112664   972 pts/0    S+   11:53   0:00 grep --color=auto httpd\n```\n浏览器访问：http://IP地址\n\n当出现『It works!』字样说明我们已经安装成功\n\n***注意*** 如果通过浏览器访问不到，可能是请求服务器防火墙给拦截了，所以我们需要在防火墙里将我们用到的80端口给放行。\n我以我当前Centos7 的系统为例，Centos7现在默认的防火墙是firewalld，Centos6以及6以前的版本则使用的是iptables，所以具体设置方法还请自己去搜索。\n```\n[root@iZ94m2e99jtZ ~]# firewall-cmd  --permanent --zone=public --add-port=80/tcp  #将80端口开放\nsuccess\n[root@iZ94m2e99jtZ ~]# firewall-cmd  --reload #重新加载防火墙配置\nsuccess\n```\n## 日常管理\n一般常见的管理方式有两种\n* 直接通过httpd命令来管理\n* 通过apachectl来管理\n***Tips*** apachetl其实一个是对httpd命令进行了封装sh脚本\n\n### 常用命令\n\n```\n#通过apachectl来管理\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k start  #启动\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k restart  #重启\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k stop  #停止\n\n#直接通过httpd命令来管理\n[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/httpd -k start|restart|graceful|graceful-stop|stop\n\n```\n\n### 具体参数\n```\nUsage: /usr/local/apache2/bin/httpd [-D name] [-d directory] [-f file]\n                                    [-C \"directive\"] [-c \"directive\"]\n                                    [-k start|restart|graceful|graceful-stop|stop]\n                                    [-v] [-V] [-h] [-l] [-L] [-t] [-T] [-S] [-X]\nOptions:\n  -D name            : define a name for use in <IfDefine name> directives\n  -d directory       : specify an alternate initial ServerRoot\n  -f file            : specify an alternate ServerConfigFile\n  -C \"directive\"     : process directive before reading config files\n  -c \"directive\"     : process directive after reading config files\n  -e level           : show startup errors of level (see LogLevel)\n  -E file            : log startup errors to file\n  -v                 : show version number\n  -V                 : show compile settings\n  -h                 : list available command line options (this page)\n  -l                 : list compiled in modules\n  -L                 : list available configuration directives\n  -t -D DUMP_VHOSTS  : show parsed vhost settings\n  -t -D DUMP_RUN_CFG : show parsed run settings\n  -S                 : a synonym for -t -D DUMP_VHOSTS -D DUMP_RUN_CFG\n  -t -D DUMP_MODULES : show all loaded modules\n  -M                 : a synonym for -t -D DUMP_MODULES\n  -t -D DUMP_INCLUDES: show all included configuration files\n  -t                 : run syntax check for config files\n  -T                 : start without DocumentRoot(s) check\n  -X                 : debug mode (only one worker, do not detach)\n\n```\n","slug":"Apache安装汇总","published":1,"updated":"2016-08-24T03:16:30.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwuo0008699f0dyn8iyo","content":"<p>Apache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。<br>Apache的安装无外乎两种方式：</p>\n<ul>\n<li>二进制包安装</li>\n<li>源码包安装</li>\n</ul>\n<a id=\"more\"></a>\n<p>接下来我将会演示和记录通过源码包来安装apache到服务器。<br>环境：阿里云 Centos 7.2 64</p>\n<h2 id=\"安装前准备工作\"><a href=\"#安装前准备工作\" class=\"headerlink\" title=\"安装前准备工作\"></a>安装前准备工作</h2><p>通过源码包安装，我们需要将源码编译成计算机运行的二进制，因此我们需要编译工具。</p>\n<h3 id=\"gcc安装\"><a href=\"#gcc安装\" class=\"headerlink\" title=\"gcc安装\"></a>gcc安装</h3><p>GNU编译器套件（GNU Compiler Collection）包括C、C++、Objective-C、Fortran、Java、Ada和Go语言的前端，也包括了这些语言的库（如libstdc++、libgcj等等）。GCC的初衷是为GNU操作系统专门编写的一款编译器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ28v78hcmrZ ~]# gcc</div><div class=\"line\">gcc: 致命错误：没有输入文件</div><div class=\"line\">编译中断。</div><div class=\"line\">[root@iZ28v78hcmrZ ~]# yum install gcc</div><div class=\"line\">···</div><div class=\"line\">作为依赖被升级:</div><div class=\"line\">  cpp.x86_64 0:4.8.5-4.el7            gcc-c++.x86_64 0:4.8.5-4.el7            gcc-gfortran.x86_64 0:4.8.5-4.el7    libgcc.x86_64 0:4.8.5-4.el7</div><div class=\"line\">  libgfortran.x86_64 0:4.8.5-4.el7    libgomp.x86_64 0:4.8.5-4.el7            libquadmath.x86_64 0:4.8.5-4.el7     libquadmath-devel.x86_64 0:4.8.5-4.el7</div><div class=\"line\">  libstdc++.x86_64 0:4.8.5-4.el7      libstdc++-devel.x86_64 0:4.8.5-4.el7</div><div class=\"line\"></div><div class=\"line\">完毕！</div><div class=\"line\">[root@iZ28v78hcmrZ ~]#</div></pre></td></tr></table></figure></p>\n<h3 id=\"APR、APR-UTIL-安装\"><a href=\"#APR、APR-UTIL-安装\" class=\"headerlink\" title=\"APR、APR-UTIL 安装\"></a>APR、APR-UTIL 安装</h3><p>APR （全称：Apache Portable Runtime）可移植运行时库、APR-UTIL（全称：Apache Portable Runtime Utility Library）可移植运行时工具库。它们的作用是使得对平台细节的处理进行下移。对于应用程序而言，它们根本就不需要考虑具体的平台，不管是Unix、Linux还是Window，应用程序执行的接口基本都是统一一致的。<br>APR的目标则是希望安全合并所有的能够合并的代码而不需要牺牲性能，为大多数平台提供所有的APR特性支持，包括Win32、OS/2、BeOS、Darwin、Linux等等。</p>\n<p>关于apr和apr-util，apache可以使用系统已经安装的版本，也可以不实用系统提供的版本。具体方法是分别下载apr和apr-util，解压到apache源码包中的srclib/apr和srclib/apr-util路径中（路径中不包含版本号等信息），在编译源码包之前的./configure 过程中使用 –with-included-apr 选项</p>\n<h3 id=\"PRCE-Perl-Compatible-Regular-Expressions-Library-Perl兼容的正则表达式库\"><a href=\"#PRCE-Perl-Compatible-Regular-Expressions-Library-Perl兼容的正则表达式库\" class=\"headerlink\" title=\"PRCE (Perl-Compatible Regular Expressions Library,Perl兼容的正则表达式库)\"></a>PRCE (Perl-Compatible Regular Expressions Library,Perl兼容的正则表达式库)</h3><p>PCRE(Perl Compatible Regular Expressions)是一个用C语言编写的正则表达式函数库。<br>PCRE被广泛使用在许多开源软件之中，最著名的莫过于Apache HTTP服务器和PHP脚本语言、R脚本语言，此外，正如从其名字所能看到的，PCRE也是perl语言的缺省正则库。</p>\n<p><a href=\"https://sourceforge.net/projects/pcre/files/\" target=\"_blank\" rel=\"external\">PCRE 下载网址</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">#解压</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf pcre-8.38.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# cd pcre-8.38</div><div class=\"line\">[root@iZ94m2e99jtZ pcre-8.38]# ./configure</div><div class=\"line\">···</div><div class=\"line\">pcre-8.38 configuration summary:</div><div class=\"line\"></div><div class=\"line\">    Install prefix .................. : /usr/local</div><div class=\"line\">    C preprocessor .................. : gcc -E</div><div class=\"line\">    C compiler ...................... : gcc</div><div class=\"line\">    C++ preprocessor ................ : g++ -E</div><div class=\"line\">    C++ compiler .................... : g++</div><div class=\"line\">    Linker .......................... : /usr/bin/ld -m elf_x86_64</div><div class=\"line\">    C preprocessor flags ............ :</div><div class=\"line\">    C compiler flags ................ : -g -O2 -fvisibility=hidden</div><div class=\"line\">    C++ compiler flags .............. : -O2 -fvisibility=hidden -fvisibility-inlines-hidden</div><div class=\"line\">    Linker flags .................... :</div><div class=\"line\">    Extra libraries ................. :</div><div class=\"line\"></div><div class=\"line\">    Build 8 bit pcre library ........ : yes</div><div class=\"line\">    Build 16 bit pcre library ....... : no</div><div class=\"line\">    Build 32 bit pcre library ....... : no</div><div class=\"line\">    Build C++ library ............... : yes</div><div class=\"line\">    Enable JIT compiling support .... : no</div><div class=\"line\">    Enable UTF-8/16/32 support ...... : no</div><div class=\"line\">    Unicode properties .............. : no</div><div class=\"line\">    Newline char/sequence ........... : lf</div><div class=\"line\">    \\R matches only ANYCRLF ......... : no</div><div class=\"line\">    EBCDIC coding ................... : no</div><div class=\"line\">    EBCDIC code for NL .............. : n/a</div><div class=\"line\">    Rebuild char tables ............. : no</div><div class=\"line\">    Use stack recursion ............. : yes</div><div class=\"line\">    POSIX mem threshold ............. : 10</div><div class=\"line\">    Internal link size .............. : 2</div><div class=\"line\">    Nested parentheses limit ........ : 250</div><div class=\"line\">    Match limit ..................... : 10000000</div><div class=\"line\">    Match limit recursion ........... : MATCH_LIMIT</div><div class=\"line\">    Build shared libs ............... : yes</div><div class=\"line\">    Build static libs ............... : yes</div><div class=\"line\">    Use JIT in pcregrep ............. : no</div><div class=\"line\">    Buffer size for pcregrep ........ : 20480</div><div class=\"line\">    Link pcregrep with libz ......... : no</div><div class=\"line\">    Link pcregrep with libbz2 ....... : no</div><div class=\"line\">    Link pcretest with libedit ...... : no</div><div class=\"line\">    Link pcretest with libreadline .. : no</div><div class=\"line\">    Valgrind support ................ : no</div><div class=\"line\">    Code coverage ................... : no</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ pcre-8.38]# make &amp; make install</div></pre></td></tr></table></figure>\n<p><strong>Tips</strong><br>在编译pcre时可能会出现这样的：configure: error: You need a C++ compiler for C++ support.提示我们缺少一个C++ 的编译器，需要我们再安装一个C++的编译器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ pcre-8.38]# yum install gcc-c++</div></pre></td></tr></table></figure></p>\n<h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p><a href=\"http://apr.apache.org/\" target=\"_blank\" rel=\"external\">apr、apr-uitl官网</a></p>\n<p><a href=\"http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz\" target=\"_blank\" rel=\"external\">apr 下载地址</a></p>\n<p><a href=\"http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz\" target=\"_blank\" rel=\"external\">apr-uitl 下载地址</a></p>\n<p><a href=\"http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz\" target=\"_blank\" rel=\"external\">apache 源码包</a></p>\n<p>下载、解压、将apr和apr-util分别复制到httpd-2.4.23/srclib/apr和httpd-2.4.23/srclib/apr-util中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ ~]# wget http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# wget  http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# wget http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf apr-1.5.2.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf apr-util-1.5.4.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf httpd-2.4.23.tar.gz</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ ~]# ll</div><div class=\"line\">总用量 10088</div><div class=\"line\">drwxr-xr-x 27 1000  1000    4096 4月  25 2015 apr-1.5.2</div><div class=\"line\">-rw-r--r--  1 root root  1031613 4月  29 2015 apr-1.5.2.tar.gz</div><div class=\"line\">drwxr-xr-x 19 1000  1000    4096 9月  17 2014 apr-util-1.5.4</div><div class=\"line\">-rw-r--r--  1 root root   874044 9月  20 2014 apr-util-1.5.4.tar.gz</div><div class=\"line\">drwxr-xr-x 11  501 games    4096 7月   1 01:15 httpd-2.4.23</div><div class=\"line\">-rw-r--r--  1 root root  8406575 7月   5 03:50 httpd-2.4.23.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]#</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ ~]# cp -r  apr-1.5.2 httpd-2.4.23/srclib/apr</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# cp -r  apr-util-1.5.4 httpd-2.4.23/srclib/apr-util</div></pre></td></tr></table></figure>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h3 id=\"Configuring-the-source-tree\"><a href=\"#Configuring-the-source-tree\" class=\"headerlink\" title=\"Configuring the source tree\"></a>Configuring the source tree</h3><p>如果使用所有默认选项，只需键入的./configure即可，但一般我们根据自己的需求来修改一些配置。</p>\n<p>其中最重要的选项应该是apache的安装位置的配置项 –prefix ；<br>此外，我们可以指定哪些功能被启用和禁用模块要包含在Apache中。apache配备了一个广泛的默认包含的模块。它们将被编译为可以装载或在运行时卸载共享对象（的DSO）。您也可以选择通过选项–enable-模块=静态编译静态模块。</p>\n<p>额外的模块使用–enable模块选项，其中模块与除去mod_个串并转换为破折号任何下划线模块的名称启用。<br>同样，我们可以禁用与–disable模块选件模块。使用这些选项的时候，因为配置无法警告你，如果你指定的模块不存在要小心;它会简单地忽略选项。 此外，有时需要提供的配置脚本与你的编译器，库和头文件的位置额外信息。这是通过两种环境变量或命令行选项来配置完成。有关详细信息，请参考配置页面。或使用–help选项调用配置。</p>\n<p><a href=\"http://httpd.apache.org/docs/2.4/programs/configure.html#installationdirectories\" target=\"_blank\" rel=\"external\">Apache 官方配置说明</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div></pre></td><td class=\"code\"><pre><div class=\"line\">概要</div><div class=\"line\"></div><div class=\"line\">你应该叫configure从分布的根目录中的脚本。</div><div class=\"line\"></div><div class=\"line\">./configure [OPTION]... [VAR=VALUE]...</div><div class=\"line\"></div><div class=\"line\">要指定环境变量（例如CC， CFLAGS......），它们指定为 。请参见下面 的一些有用的变量的说明。VAR=VALUE</div><div class=\"line\"></div><div class=\"line\">最佳</div><div class=\"line\">选项</div><div class=\"line\"></div><div class=\"line\">配置选项</div><div class=\"line\">安装目录</div><div class=\"line\">系统类型</div><div class=\"line\">可选功能</div><div class=\"line\">支持程序的选项</div><div class=\"line\">配置选项</div><div class=\"line\">下列选项影响的行为 configure本身。</div><div class=\"line\"></div><div class=\"line\">-C</div><div class=\"line\">--config-cache</div><div class=\"line\">这是一个别名 --cache-file=config.cache</div><div class=\"line\">--cache-file=FILE</div><div class=\"line\">测试结果将在文件中缓存文件。此选项默认为禁用 ​​。</div><div class=\"line\">-h</div><div class=\"line\">--help [short|recursive]</div><div class=\"line\">输出的帮助和退出。随着说法short只是具体 ​​到这个包的选项将显示出来。参数 recursive显示所有包含包的简短帮助。</div><div class=\"line\">-n</div><div class=\"line\">--no-create</div><div class=\"line\">该configure脚本运行正常，但不创建输出文件。这是有用的生成makefile文件编译前检查测试结果。</div><div class=\"line\">-q</div><div class=\"line\">--quiet</div><div class=\"line\">不打印checking ...在配置过程的消息。</div><div class=\"line\">--srcdir=DIR</div><div class=\"line\">定义目录DIR是源文件目录。默认为所在目录configure的位置，或父目录。</div><div class=\"line\">--silent</div><div class=\"line\">与...一样 --quiet</div><div class=\"line\">-V</div><div class=\"line\">- 版</div><div class=\"line\">显示版权信息并退出。</div><div class=\"line\">安装目录</div><div class=\"line\">这些选项定义安装目录。安装树取决于所选的布局。</div><div class=\"line\"></div><div class=\"line\">--prefix=PREFIX</div><div class=\"line\">在安装结构无关的文件PREFIX。默认安装目录设置为 /usr/local/apache2。</div><div class=\"line\">--exec-prefix=EPREFIX</div><div class=\"line\">在安装体系相关的文件EPREFIX。默认安装目录设置为 PREFIX目录。</div><div class=\"line\">默认情况下，make install将安装所有文件 /usr/local/apache2/bin，/usr/local/apache2/lib 等等。您可以指定以外的安装前缀 /usr/local/apache2使用--prefix，例如--prefix=$HOME。</div><div class=\"line\"></div><div class=\"line\">定义一个目录布局</div><div class=\"line\">--enable-layout=LAYOUT</div><div class=\"line\">配置源代码和编译脚本的假设基础上的布局安装树布局。这使您可以分别指定为Apache HTTP服务器安装在每个类型的文件的位置。该config.layout 文件包含几个示例配置，你还可以创建下面的例子中你自己的自定义配置。该文件中的不同布局分为&lt;Layout FOO&gt;...&lt;/Layout&gt;部分，并通过名称简称为中FOO，默认布局Apache。</div><div class=\"line\">安装目录微调</div><div class=\"line\">为了更好地控制安装目录中，使用下面的选项。请注意，目录默认被设置 autoconf，并通过相应布局设置被覆盖。</div><div class=\"line\"></div><div class=\"line\">--bindir=DIR</div><div class=\"line\">在用户安装可执行文件DIR。用户可执行文件都支持这样的程序htpasswd， dbmmanage等等。这对于网站管理员有用。默认情况下DIR设置为 EPREFIX/bin。</div><div class=\"line\">--datadir=DIR</div><div class=\"line\">在安装只读体系结构无关的数据DIR。默认datadir设置为 PREFIX/share。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--includedir=DIR</div><div class=\"line\">在安装C头文件DIR。默认 includedir设置为 EPREFIX/include。</div><div class=\"line\">--infodir=DIR</div><div class=\"line\">在安装info文档DIR。默认infodir设置为 PREFIX/info。此选项当前未使用。</div><div class=\"line\">--libdir=DIR</div><div class=\"line\">在安装目标代码库DIR。默认 libdir设置为 EPREFIX/lib。</div><div class=\"line\">--libexecdir=DIR</div><div class=\"line\">在安装程序的可执行文件（例如，共享模块） DIR。默认libexecdir设置为 EPREFIX/modules。</div><div class=\"line\">--localstatedir=DIR</div><div class=\"line\">在安装修改的单机数据DIR。默认localstatedir设置为 PREFIX/var。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--mandir=DIR</div><div class=\"line\">在安装该男子文档DIR。默认 mandir设置为 EPREFIX/man。</div><div class=\"line\">--oldincludedir=DIR</div><div class=\"line\">在非GCC安装C头文件DIR。默认oldincludedir设置为 /usr/include。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--sbindir=DIR</div><div class=\"line\">在系统中安装管理员可执行DIR。这些都是服务器程序，如httpd， apachectl，suexec等，这些都需要运行在Apache HTTP服务器。默认 sbindir设置为 EPREFIX/sbin。</div><div class=\"line\">--sharedstatedir=DIR</div><div class=\"line\">在安装修改的架构无关的数据DIR。默认sharedstatedir设置为 PREFIX/com。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--sysconfdir=DIR</div><div class=\"line\">安装只读的单机数据，如服务器配置文件httpd.conf，mime.types等在 DIR。默认sysconfdir设置为 PREFIX/conf。</div><div class=\"line\">系统类型</div><div class=\"line\">这些选项用于交叉编译Apache HTTP服务器到另一个系统上运行。在正常的情况下，建立和运行在同一系统上的服务器时，不使用这些选项。</div><div class=\"line\"></div><div class=\"line\">--build=BUILD</div><div class=\"line\">定义系统类型上的工具正在建立该系统。它默认为脚本的结果 config.guess。</div><div class=\"line\">--host=HOST</div><div class=\"line\">定义系统类型的服务器将运行，系统的 HOST默认为BUILD。</div><div class=\"line\">--target=TARGET</div><div class=\"line\">配置构建编译器系统类型 目标。它默认为HOST。此选项被提供autoconf，而不是必要的Apache HTTP服务器。</div><div class=\"line\">可选功能</div><div class=\"line\">这些选项用于微调您的HTTP服务器将具备的功能。</div><div class=\"line\"></div><div class=\"line\">一般语法</div><div class=\"line\">一般来说，你可以使用下面的语法来启用或禁用功能：</div><div class=\"line\"></div><div class=\"line\">--disable-FEATURE</div><div class=\"line\">不包括特征。这是相同的 。--enable-FEATURE=no</div><div class=\"line\">--enable-FEATURE[=ARG]</div><div class=\"line\">包括特征。为默认值ARG 为yes。</div><div class=\"line\">--enable-MODULE=shared</div><div class=\"line\">相应的模块将被建设成为DSO模块。默认情况下启用的模块是动态链接的。</div><div class=\"line\">--enable-MODULE=static</div><div class=\"line\">相应的模块将被静态链接。</div><div class=\"line\">注意</div><div class=\"line\"></div><div class=\"line\">configure不会抱怨 ，即使富不存在，所以你需要仔细类型。 --enable-foo</div><div class=\"line\">选择模块编译</div><div class=\"line\">大多数模块由默认编译并已被明确或通过使用关键字禁用few （见--enable-modules，--enable-mods-shared 并且--enable-mods-static下面进一步解释）或--enable-modules=none作为一组被删除。</div><div class=\"line\"></div><div class=\"line\">其它模块默认不编译并已被明确或通过使用关键字启用all或 reallyall可用。</div><div class=\"line\"></div><div class=\"line\">要了解哪些模块是默认编译，运行 ./configure -h或./configure --help 下看Optional Features。假设你有兴趣mod_example1和 mod_example2，你看这个：</div><div class=\"line\"></div><div class=\"line\">可选功能：</div><div class=\"line\">  ...</div><div class=\"line\">  --disable-例1示例模块1</div><div class=\"line\">  --enable-例题例如模块2</div><div class=\"line\">  ...</div><div class=\"line\">然后mod_example1是默认启用的，你就可以使用--disable-example1不编译。 mod_example2默认情况下禁用，你就可以使用--enable-example2 编译它。</div><div class=\"line\"></div><div class=\"line\">多道处理模块</div><div class=\"line\">多道处理模块，或的MPM，实现了服务器的基本行为。单个MPM必须为了使服务器的功能被激活。出现在可用MPM列表 模块索引页。</div><div class=\"line\"></div><div class=\"line\">的MPM可以建成为数字存储示波器的动态加载或静态与服务器相连，并使用下列选项被启用：</div><div class=\"line\"></div><div class=\"line\">--with-mpm=MPM</div><div class=\"line\">选择适合您的服务器的默认MPM。如果MPM的构建为DSO模块（见--enable-mpms-shared），该指令选择将默认的配置文件中加载的MPM。否则，这个指令选择唯一可用的MPM，这将静态链接到服务器。</div><div class=\"line\"></div><div class=\"line\">如果省略此选项，默认的MPM为您的操作系统将被使用。</div><div class=\"line\"></div><div class=\"line\">--enable-mpms-shared=MPM-LIST</div><div class=\"line\">使动态共享模块的MPM的列表。这些模块之一必须动态使用加载 LoadModule指令。</div><div class=\"line\"></div><div class=\"line\">MPM-LIST是加了引号的MPM名称的空格分隔的列表。例如：</div><div class=\"line\"></div><div class=\"line\">--enable-mpms-shared=&apos;prefork worker&apos;</div><div class=\"line\">此外，您还可以使用特殊关键字all，这将选择支持在当前平台上动态加载所有的MPM和他们建立的DSO模块。例如：</div><div class=\"line\"></div><div class=\"line\">--enable-mpms-shared=all</div><div class=\"line\">第三方模块</div><div class=\"line\">要添加其他第三方模块使用下列选项：</div><div class=\"line\"></div><div class=\"line\">--with-module=module-type:module-file[, module-type:module-file]</div><div class=\"line\">添加一个或多个第三方的模块，以静态链接模块列表。该模块的源文件module-file 将在搜索 你的Apache HTTP服务器的源代码树的子目录。如果没有找到有它正在考虑模块文件是一个绝对文件路径，并尝试将源文件复制到 模块式子目录。如果子目录不存在，它将被创建并与标准的填充 。modules/module-typeconfigureMakefile.in</div><div class=\"line\"></div><div class=\"line\">此选项很有用添加由一个源文件小的外部组件。对于更复杂的模块，你应该阅读供应商的文档。</div><div class=\"line\"></div><div class=\"line\">注意</div><div class=\"line\"></div><div class=\"line\">如果你想建立一个DSO模块，而不是一个静态链接使用apxs。</div><div class=\"line\">累积和其他选项</div><div class=\"line\">--enable-maintainer-mode</div><div class=\"line\">打开调试和编译时警告，并加载所有编译的模块。</div><div class=\"line\">--enable-mods-shared=MODULE-LIST</div><div class=\"line\">定义启用并建立动态共享模块模块的列表。这意味着，这些模块必须通过使用动态加载 LoadModule指令。</div><div class=\"line\"></div><div class=\"line\">MODULE-LIST是加了引号的modulenames空格分隔列表。该模块名称没有给出前面mod_。例如：</div><div class=\"line\"></div><div class=\"line\">--enable-mods-shared=&apos;headers rewrite dav&apos;</div><div class=\"line\">此外，您还可以使用特殊的关键字reallyall， all，most和few。例如，</div><div class=\"line\"></div><div class=\"line\">--enable-mods-shared=most</div><div class=\"line\">将编译大多数模块，并将其建设成为DSO模块，</div><div class=\"line\"></div><div class=\"line\">--enable-mods-shared=few</div><div class=\"line\">将只编译一个非常基本的模块组。</div><div class=\"line\"></div><div class=\"line\">默认设置为most。</div><div class=\"line\"></div><div class=\"line\">在LoadModule对所选择的模块的指令将在主配置文件中自动生成。默认情况下，所有的指令都只是由一个配置要求或明确选择的模块被注释掉--enable-foo的说法。您可以更改设置启用或关闭加载的模块LoadModule的指令 httpd.conf。此外， LoadModule所有构建的模块的指令可通过配置选项被激活 --enable-load-all-modules。</div><div class=\"line\"></div><div class=\"line\">--enable-mods-static=MODULE-LIST</div><div class=\"line\">此选项的行为类似--enable-mods-shared，但在给定的模块静态链接。这意味着，这些模块将始终存在，同时运行httpd。他们不必被加载LoadModule。</div><div class=\"line\">--enable-modules=MODULE-LIST</div><div class=\"line\">此选项的行为等来--enable-mods-shared，并且还将动态地链接的给定模块。特殊关键字none禁用所有模块的版本。</div><div class=\"line\">--enable-v4-mapped</div><div class=\"line\">允许IPv6的套接字来处理IPv4连接。</div><div class=\"line\">--with-port=PORT</div><div class=\"line\">这定义上的端口httpd会听。生成配置文件时，该端口号用于 httpd.conf。默认值是80。</div><div class=\"line\">--with-program-name</div><div class=\"line\">定义一个替代的可执行文件名 ​​称。默认值是 httpd。</div><div class=\"line\">可选包</div><div class=\"line\">这些选项用于定义可选包。</div><div class=\"line\"></div><div class=\"line\">一般语法</div><div class=\"line\">一般来说，你可以使用下面的语法定义一个可选包：</div><div class=\"line\"></div><div class=\"line\">--with-PACKAGE[=ARG]</div><div class=\"line\">使用包PACKAGE。为默认值 ARG为yes。</div><div class=\"line\">--without-PACKAGE</div><div class=\"line\">不要使用包PACKAGE。这是相同的 。此选项所提供 ，但对于Apache HTTP服务器不是非常有用。--with-PACKAGE=noautoconf</div><div class=\"line\">特定软件包</div><div class=\"line\">--with-apr=DIR|FILE</div><div class=\"line\">在Apache可移植运行时（APR）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的年利率，而不是你要告诉configure路径的 apr-config脚本。你可以设置绝对路径和名称或目录切换到安装四月apr-config必须在该目录或子目录中存在 bin。</div><div class=\"line\">--with-apr-util=DIR|FILE</div><div class=\"line\">Apache可移植运行实用程序（APU）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的APU，而不是你要告诉configure路径的 apu-config脚本。你可以设置绝对路径和名称或目录切换到安装APU，apu-config必须在该目录或子目录中存在 bin。</div><div class=\"line\">--with-ssl=DIR</div><div class=\"line\">如果mod_ssl已启用configure 已安装的OpenSSL的搜索。您可以将目录路径设置为SSL / TLS工具包来代替。</div><div class=\"line\">--with-z=DIR</div><div class=\"line\">configure已安装的自动搜索 zlib，如果你的源配置需要一个库（例如，当mod_deflate使能）。您可以设置压缩库的目录路径来代替。</div><div class=\"line\">Apache HTTP服务器的一些特性，如 mod_authn_dbm和mod_rewrite的DBM RewriteMap使用简单的键/值对数据库信息的快速查询。SDBM被包括在APU，所以这个数据库是始终可用。如果您想使用其他数据库类型，可以使用下面的选项，以使它们：</div><div class=\"line\"></div><div class=\"line\">--with-gdbm[=path]</div><div class=\"line\">如果没有路径指定，configure将搜索在平时的搜索路径GNU DBM安装的包含文件和库。一个明确的 路径会导致configure在寻找 path/lib，并 path/include为相关的文件。最后，路径可以指定用冒号隔开具体包括和库路径。</div><div class=\"line\">--with-ndbm[=path]</div><div class=\"line\">像--with-gdbm，但搜索新DBM安装。</div><div class=\"line\">--with-berkeley-db[=path]</div><div class=\"line\">像--with-gdbm，但搜索一个Berkeley DB的安装。</div><div class=\"line\">注意</div><div class=\"line\"></div><div class=\"line\">由APU提供，并通过其配置脚本传递的DBM选项。他们利用确定已安装的APU时是无用的--with-apr-util。</div><div class=\"line\">您可以使用自己的HTTP服务器一起使用一个以上的DBM实现。该拨款DBM类型将每次运行时配置中配置。</div><div class=\"line\">支持程序的选项</div><div class=\"line\">--enable-static-support</div><div class=\"line\">构建支持二进制文件的静态链接的版本。这意味着，一个独立的可执行文件将集成所有必要的库来构建。否则，支持二进制文件默认情况下，动态链接。</div><div class=\"line\">--enable-suexec</div><div class=\"line\">使用此选项可启用suexec，它允许您设置UID和GID的催生过程。除非你了解你的服务器上运行的SUID二进制的所有安全隐患，请勿使用此选项。更多选项来配置suexec介绍如下。</div><div class=\"line\">这可以通过使用下列选项来创建一个单一的支持程序的静态链接二进制文件：</div><div class=\"line\"></div><div class=\"line\">--enable-static-ab</div><div class=\"line\">建立一个静态链接的版本ab。</div><div class=\"line\">--enable-static-checkgid</div><div class=\"line\">建立一个静态链接的版本checkgid。</div><div class=\"line\">--enable-static-htdbm</div><div class=\"line\">建立一个静态链接的版本htdbm。</div><div class=\"line\">--enable-static-htdigest</div><div class=\"line\">建立一个静态链接的版本htdigest。</div><div class=\"line\">--enable-static-htpasswd</div><div class=\"line\">建立一个静态链接的版本htpasswd。</div><div class=\"line\">--enable-static-logresolve</div><div class=\"line\">建立一个静态链接的版本logresolve。</div><div class=\"line\">--enable-static-rotatelogs</div><div class=\"line\">建立一个静态链接的版本rotatelogs。</div><div class=\"line\">suexec 配置选项</div><div class=\"line\">下列选项用于微调的行为suexec。参见配置和安装suEXEC的 进一步的信息。</div><div class=\"line\"></div><div class=\"line\">--with-suexec-bin</div><div class=\"line\">这定义的路径suexec二进制文件。默认值是--sbindir（见安装目录微调）。</div><div class=\"line\">--with-suexec-caller</div><div class=\"line\">这定义允许呼叫的用户suexec。它应该是相同下，用户 httpd正常运行。</div><div class=\"line\">--with-suexec-docroot</div><div class=\"line\">这个定义下的目录树suexec允许访问的可执行文件。默认值是 --datadir/htdocs。</div><div class=\"line\">--with-suexec-gidmin</div><div class=\"line\">这个定义的最低GID成为目标用户 suexec。默认值是100。</div><div class=\"line\">--with-suexec-logfile</div><div class=\"line\">这个定义的文件名suexec​​日志文件。默认情况下，日志文件被命名为suexec_log，位于 --logfiledir。</div><div class=\"line\">--with-suexec-safepath</div><div class=\"line\">定义环境变量的值PATH由启动的进 ​​程进行设置suexec。默认值是/usr/local/bin:/usr/bin:/bin。</div><div class=\"line\">--with-suexec-userdir</div><div class=\"line\">此定义包含所有可执行文件的用户目录下的子目录suexec的访问是允许的。当你想使用此设置时必须 suexec使用特定用户目录在一起（如所提供的mod_userdir）。默认值是 public_html。</div><div class=\"line\">--with-suexec-uidmin</div><div class=\"line\">它定义为最低的UID允许为目标用户 suexec。默认值是100。</div><div class=\"line\">--with-suexec-umask</div><div class=\"line\">设置umask由启动的进 ​​程 suexec。它默认为您的系统设置。</div><div class=\"line\">最佳</div><div class=\"line\">环境变量</div><div class=\"line\"></div><div class=\"line\">有一些有用的环境变量覆盖所作出的选择 configure，或帮助它找到库和程序与非标准名称或位置。</div><div class=\"line\"></div><div class=\"line\">CC</div><div class=\"line\">定义要用于编译的C编译器的命令。</div><div class=\"line\">CFLAGS</div><div class=\"line\">要使用编译设置C编译器的标志。</div><div class=\"line\">CPP</div><div class=\"line\">定义C预处理命令使用。</div><div class=\"line\">CPPFLAGS</div><div class=\"line\">将C / C ++预处理器的标志，例如 ，如果你在一个非标准目录头了includedir。-Iincludedir</div><div class=\"line\">LDFLAGS</div><div class=\"line\">设置连接器选项，例如，如果你在一个非标准目录库LIBDIR。-Llibdir</div></pre></td></tr></table></figure>\n<p><strong><em>示例：</em></strong><br>这里是一个典型的例子编译Apache，安装树/ SW /包装/与特定的编译器和标志，加上两个额外的模块阿帕奇mod_ldap模块和mod_lua</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ CC=&quot;pgcc&quot; CFLAGS=&quot;-O2&quot; \\</div><div class=\"line\">./configure --prefix=/sw/pkg/apache \\</div><div class=\"line\">--enable-ldap=shared \\</div><div class=\"line\">--enable-lua=shared</div></pre></td></tr></table></figure>\n<p>我们本次采用基本的默认设置 来进行安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ ~]# cd httpd-2.4.23</div><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# ./configure  --with-included-apr</div></pre></td></tr></table></figure></p>\n<h3 id=\"Build\"><a href=\"#Build\" class=\"headerlink\" title=\"Build\"></a>Build</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# make</div></pre></td></tr></table></figure>\n<h3 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# make install</div><div class=\"line\">···</div><div class=\"line\">Installing configuration files</div><div class=\"line\">mkdir /usr/local/apache2/conf</div><div class=\"line\">mkdir /usr/local/apache2/conf/extra</div><div class=\"line\">mkdir /usr/local/apache2/conf/original</div><div class=\"line\">mkdir /usr/local/apache2/conf/original/extra</div><div class=\"line\">Installing HTML documents</div><div class=\"line\">mkdir /usr/local/apache2/htdocs</div><div class=\"line\">Installing error documents</div><div class=\"line\">mkdir /usr/local/apache2/error</div><div class=\"line\">Installing icons</div><div class=\"line\">mkdir /usr/local/apache2/icons</div><div class=\"line\">mkdir /usr/local/apache2/logs</div><div class=\"line\">Installing CGIs</div><div class=\"line\">mkdir /usr/local/apache2/cgi-bin</div><div class=\"line\">Installing header files</div><div class=\"line\">Installing build system files</div><div class=\"line\">Installing man pages and online manual</div><div class=\"line\">mkdir /usr/local/apache2/man</div><div class=\"line\">mkdir /usr/local/apache2/man/man1</div><div class=\"line\">mkdir /usr/local/apache2/man/man8</div><div class=\"line\">mkdir /usr/local/apache2/manual</div></pre></td></tr></table></figure>\n<h3 id=\"Customize（定制）\"><a href=\"#Customize（定制）\" class=\"headerlink\" title=\"Customize（定制）\"></a>Customize（定制）</h3><p>接下来，我们可以通过在 /usr/local/apache2/conf 目录，编辑配置文件来自定义我们的Apache HTTP服务器。</p>\n<p><a href=\"http://httpd.apache.org/docs/2.4/zh-cn/mod/directives.html\" target=\"_blank\" rel=\"external\">配置指令快速参考索引</a></p>\n<h3 id=\"Testinh-测试\"><a href=\"#Testinh-测试\" class=\"headerlink\" title=\"Testinh(测试)\"></a>Testinh(测试)</h3><p>启动Apache服务器<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# /usr/local/apache2/bin/apachectl -k start</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# ps aux | grep httpd</div><div class=\"line\">root     15386  0.0  0.2  70556  2188 ?        Ss   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">daemon   15387  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">daemon   15388  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">daemon   15389  0.0  0.4 359520  4256 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">root     15472  0.0  0.0 112664   972 pts/0    S+   11:53   0:00 grep --color=auto httpd</div></pre></td></tr></table></figure></p>\n<p>浏览器访问：<a href=\"http://IP地址\" target=\"_blank\" rel=\"external\">http://IP地址</a></p>\n<p>当出现『It works!』字样说明我们已经安装成功</p>\n<p><strong><em>注意</em></strong> 如果通过浏览器访问不到，可能是请求服务器防火墙给拦截了，所以我们需要在防火墙里将我们用到的80端口给放行。<br>我以我当前Centos7 的系统为例，Centos7现在默认的防火墙是firewalld，Centos6以及6以前的版本则使用的是iptables，所以具体设置方法还请自己去搜索。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ ~]# firewall-cmd  --permanent --zone=public --add-port=80/tcp  #将80端口开放</div><div class=\"line\">success</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# firewall-cmd  --reload #重新加载防火墙配置</div><div class=\"line\">success</div></pre></td></tr></table></figure></p>\n<h2 id=\"日常管理\"><a href=\"#日常管理\" class=\"headerlink\" title=\"日常管理\"></a>日常管理</h2><p>一般常见的管理方式有两种</p>\n<ul>\n<li>直接通过httpd命令来管理</li>\n<li>通过apachectl来管理<br><strong><em>Tips</em></strong> apachetl其实一个是对httpd命令进行了封装sh脚本</li>\n</ul>\n<h3 id=\"常用命令\"><a href=\"#常用命令\" class=\"headerlink\" title=\"常用命令\"></a>常用命令</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">#通过apachectl来管理</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k start  #启动</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k restart  #重启</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k stop  #停止</div><div class=\"line\"></div><div class=\"line\">#直接通过httpd命令来管理</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/httpd -k start|restart|graceful|graceful-stop|stop</div></pre></td></tr></table></figure>\n<h3 id=\"具体参数\"><a href=\"#具体参数\" class=\"headerlink\" title=\"具体参数\"></a>具体参数</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">Usage: /usr/local/apache2/bin/httpd [-D name] [-d directory] [-f file]</div><div class=\"line\">                                    [-C &quot;directive&quot;] [-c &quot;directive&quot;]</div><div class=\"line\">                                    [-k start|restart|graceful|graceful-stop|stop]</div><div class=\"line\">                                    [-v] [-V] [-h] [-l] [-L] [-t] [-T] [-S] [-X]</div><div class=\"line\">Options:</div><div class=\"line\">  -D name            : define a name for use in &lt;IfDefine name&gt; directives</div><div class=\"line\">  -d directory       : specify an alternate initial ServerRoot</div><div class=\"line\">  -f file            : specify an alternate ServerConfigFile</div><div class=\"line\">  -C &quot;directive&quot;     : process directive before reading config files</div><div class=\"line\">  -c &quot;directive&quot;     : process directive after reading config files</div><div class=\"line\">  -e level           : show startup errors of level (see LogLevel)</div><div class=\"line\">  -E file            : log startup errors to file</div><div class=\"line\">  -v                 : show version number</div><div class=\"line\">  -V                 : show compile settings</div><div class=\"line\">  -h                 : list available command line options (this page)</div><div class=\"line\">  -l                 : list compiled in modules</div><div class=\"line\">  -L                 : list available configuration directives</div><div class=\"line\">  -t -D DUMP_VHOSTS  : show parsed vhost settings</div><div class=\"line\">  -t -D DUMP_RUN_CFG : show parsed run settings</div><div class=\"line\">  -S                 : a synonym for -t -D DUMP_VHOSTS -D DUMP_RUN_CFG</div><div class=\"line\">  -t -D DUMP_MODULES : show all loaded modules</div><div class=\"line\">  -M                 : a synonym for -t -D DUMP_MODULES</div><div class=\"line\">  -t -D DUMP_INCLUDES: show all included configuration files</div><div class=\"line\">  -t                 : run syntax check for config files</div><div class=\"line\">  -T                 : start without DocumentRoot(s) check</div><div class=\"line\">  -X                 : debug mode (only one worker, do not detach)</div></pre></td></tr></table></figure>\n","excerpt":"<p>Apache是世界使用排名第一的Web服务器软件。它可以运行在几乎所有广泛使用的计算机平台上，由于其跨平台和安全性被广泛使用，是最流行的Web服务器端软件之一。<br>Apache的安装无外乎两种方式：</p>\n<ul>\n<li>二进制包安装</li>\n<li>源码包安装</li>\n</ul>","more":"<p>接下来我将会演示和记录通过源码包来安装apache到服务器。<br>环境：阿里云 Centos 7.2 64</p>\n<h2 id=\"安装前准备工作\"><a href=\"#安装前准备工作\" class=\"headerlink\" title=\"安装前准备工作\"></a>安装前准备工作</h2><p>通过源码包安装，我们需要将源码编译成计算机运行的二进制，因此我们需要编译工具。</p>\n<h3 id=\"gcc安装\"><a href=\"#gcc安装\" class=\"headerlink\" title=\"gcc安装\"></a>gcc安装</h3><p>GNU编译器套件（GNU Compiler Collection）包括C、C++、Objective-C、Fortran、Java、Ada和Go语言的前端，也包括了这些语言的库（如libstdc++、libgcj等等）。GCC的初衷是为GNU操作系统专门编写的一款编译器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ28v78hcmrZ ~]# gcc</div><div class=\"line\">gcc: 致命错误：没有输入文件</div><div class=\"line\">编译中断。</div><div class=\"line\">[root@iZ28v78hcmrZ ~]# yum install gcc</div><div class=\"line\">···</div><div class=\"line\">作为依赖被升级:</div><div class=\"line\">  cpp.x86_64 0:4.8.5-4.el7            gcc-c++.x86_64 0:4.8.5-4.el7            gcc-gfortran.x86_64 0:4.8.5-4.el7    libgcc.x86_64 0:4.8.5-4.el7</div><div class=\"line\">  libgfortran.x86_64 0:4.8.5-4.el7    libgomp.x86_64 0:4.8.5-4.el7            libquadmath.x86_64 0:4.8.5-4.el7     libquadmath-devel.x86_64 0:4.8.5-4.el7</div><div class=\"line\">  libstdc++.x86_64 0:4.8.5-4.el7      libstdc++-devel.x86_64 0:4.8.5-4.el7</div><div class=\"line\"></div><div class=\"line\">完毕！</div><div class=\"line\">[root@iZ28v78hcmrZ ~]#</div></pre></td></tr></table></figure></p>\n<h3 id=\"APR、APR-UTIL-安装\"><a href=\"#APR、APR-UTIL-安装\" class=\"headerlink\" title=\"APR、APR-UTIL 安装\"></a>APR、APR-UTIL 安装</h3><p>APR （全称：Apache Portable Runtime）可移植运行时库、APR-UTIL（全称：Apache Portable Runtime Utility Library）可移植运行时工具库。它们的作用是使得对平台细节的处理进行下移。对于应用程序而言，它们根本就不需要考虑具体的平台，不管是Unix、Linux还是Window，应用程序执行的接口基本都是统一一致的。<br>APR的目标则是希望安全合并所有的能够合并的代码而不需要牺牲性能，为大多数平台提供所有的APR特性支持，包括Win32、OS/2、BeOS、Darwin、Linux等等。</p>\n<p>关于apr和apr-util，apache可以使用系统已经安装的版本，也可以不实用系统提供的版本。具体方法是分别下载apr和apr-util，解压到apache源码包中的srclib/apr和srclib/apr-util路径中（路径中不包含版本号等信息），在编译源码包之前的./configure 过程中使用 –with-included-apr 选项</p>\n<h3 id=\"PRCE-Perl-Compatible-Regular-Expressions-Library-Perl兼容的正则表达式库\"><a href=\"#PRCE-Perl-Compatible-Regular-Expressions-Library-Perl兼容的正则表达式库\" class=\"headerlink\" title=\"PRCE (Perl-Compatible Regular Expressions Library,Perl兼容的正则表达式库)\"></a>PRCE (Perl-Compatible Regular Expressions Library,Perl兼容的正则表达式库)</h3><p>PCRE(Perl Compatible Regular Expressions)是一个用C语言编写的正则表达式函数库。<br>PCRE被广泛使用在许多开源软件之中，最著名的莫过于Apache HTTP服务器和PHP脚本语言、R脚本语言，此外，正如从其名字所能看到的，PCRE也是perl语言的缺省正则库。</p>\n<p><a href=\"https://sourceforge.net/projects/pcre/files/\">PCRE 下载网址</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div></pre></td><td class=\"code\"><pre><div class=\"line\">#解压</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf pcre-8.38.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# cd pcre-8.38</div><div class=\"line\">[root@iZ94m2e99jtZ pcre-8.38]# ./configure</div><div class=\"line\">···</div><div class=\"line\">pcre-8.38 configuration summary:</div><div class=\"line\"></div><div class=\"line\">    Install prefix .................. : /usr/local</div><div class=\"line\">    C preprocessor .................. : gcc -E</div><div class=\"line\">    C compiler ...................... : gcc</div><div class=\"line\">    C++ preprocessor ................ : g++ -E</div><div class=\"line\">    C++ compiler .................... : g++</div><div class=\"line\">    Linker .......................... : /usr/bin/ld -m elf_x86_64</div><div class=\"line\">    C preprocessor flags ............ :</div><div class=\"line\">    C compiler flags ................ : -g -O2 -fvisibility=hidden</div><div class=\"line\">    C++ compiler flags .............. : -O2 -fvisibility=hidden -fvisibility-inlines-hidden</div><div class=\"line\">    Linker flags .................... :</div><div class=\"line\">    Extra libraries ................. :</div><div class=\"line\"></div><div class=\"line\">    Build 8 bit pcre library ........ : yes</div><div class=\"line\">    Build 16 bit pcre library ....... : no</div><div class=\"line\">    Build 32 bit pcre library ....... : no</div><div class=\"line\">    Build C++ library ............... : yes</div><div class=\"line\">    Enable JIT compiling support .... : no</div><div class=\"line\">    Enable UTF-8/16/32 support ...... : no</div><div class=\"line\">    Unicode properties .............. : no</div><div class=\"line\">    Newline char/sequence ........... : lf</div><div class=\"line\">    \\R matches only ANYCRLF ......... : no</div><div class=\"line\">    EBCDIC coding ................... : no</div><div class=\"line\">    EBCDIC code for NL .............. : n/a</div><div class=\"line\">    Rebuild char tables ............. : no</div><div class=\"line\">    Use stack recursion ............. : yes</div><div class=\"line\">    POSIX mem threshold ............. : 10</div><div class=\"line\">    Internal link size .............. : 2</div><div class=\"line\">    Nested parentheses limit ........ : 250</div><div class=\"line\">    Match limit ..................... : 10000000</div><div class=\"line\">    Match limit recursion ........... : MATCH_LIMIT</div><div class=\"line\">    Build shared libs ............... : yes</div><div class=\"line\">    Build static libs ............... : yes</div><div class=\"line\">    Use JIT in pcregrep ............. : no</div><div class=\"line\">    Buffer size for pcregrep ........ : 20480</div><div class=\"line\">    Link pcregrep with libz ......... : no</div><div class=\"line\">    Link pcregrep with libbz2 ....... : no</div><div class=\"line\">    Link pcretest with libedit ...... : no</div><div class=\"line\">    Link pcretest with libreadline .. : no</div><div class=\"line\">    Valgrind support ................ : no</div><div class=\"line\">    Code coverage ................... : no</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ pcre-8.38]# make &amp; make install</div></pre></td></tr></table></figure>\n<p><strong>Tips</strong><br>在编译pcre时可能会出现这样的：configure: error: You need a C++ compiler for C++ support.提示我们缺少一个C++ 的编译器，需要我们再安装一个C++的编译器。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ pcre-8.38]# yum install gcc-c++</div></pre></td></tr></table></figure></p>\n<h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p><a href=\"http://apr.apache.org/\">apr、apr-uitl官网</a></p>\n<p><a href=\"http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz\">apr 下载地址</a></p>\n<p><a href=\"http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz\">apr-uitl 下载地址</a></p>\n<p><a href=\"http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz\">apache 源码包</a></p>\n<p>下载、解压、将apr和apr-util分别复制到httpd-2.4.23/srclib/apr和httpd-2.4.23/srclib/apr-util中</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ ~]# wget http://mirrors.hust.edu.cn/apache//apr/apr-1.5.2.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# wget  http://mirrors.hust.edu.cn/apache//apr/apr-util-1.5.4.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# wget http://mirrors.tuna.tsinghua.edu.cn/apache//httpd/httpd-2.4.23.tar.gz</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf apr-1.5.2.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf apr-util-1.5.4.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# tar -zxvf httpd-2.4.23.tar.gz</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ ~]# ll</div><div class=\"line\">总用量 10088</div><div class=\"line\">drwxr-xr-x 27 1000  1000    4096 4月  25 2015 apr-1.5.2</div><div class=\"line\">-rw-r--r--  1 root root  1031613 4月  29 2015 apr-1.5.2.tar.gz</div><div class=\"line\">drwxr-xr-x 19 1000  1000    4096 9月  17 2014 apr-util-1.5.4</div><div class=\"line\">-rw-r--r--  1 root root   874044 9月  20 2014 apr-util-1.5.4.tar.gz</div><div class=\"line\">drwxr-xr-x 11  501 games    4096 7月   1 01:15 httpd-2.4.23</div><div class=\"line\">-rw-r--r--  1 root root  8406575 7月   5 03:50 httpd-2.4.23.tar.gz</div><div class=\"line\">[root@iZ94m2e99jtZ ~]#</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ ~]# cp -r  apr-1.5.2 httpd-2.4.23/srclib/apr</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# cp -r  apr-util-1.5.4 httpd-2.4.23/srclib/apr-util</div></pre></td></tr></table></figure>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h3 id=\"Configuring-the-source-tree\"><a href=\"#Configuring-the-source-tree\" class=\"headerlink\" title=\"Configuring the source tree\"></a>Configuring the source tree</h3><p>如果使用所有默认选项，只需键入的./configure即可，但一般我们根据自己的需求来修改一些配置。</p>\n<p>其中最重要的选项应该是apache的安装位置的配置项 –prefix ；<br>此外，我们可以指定哪些功能被启用和禁用模块要包含在Apache中。apache配备了一个广泛的默认包含的模块。它们将被编译为可以装载或在运行时卸载共享对象（的DSO）。您也可以选择通过选项–enable-模块=静态编译静态模块。</p>\n<p>额外的模块使用–enable模块选项，其中模块与除去mod_个串并转换为破折号任何下划线模块的名称启用。<br>同样，我们可以禁用与–disable模块选件模块。使用这些选项的时候，因为配置无法警告你，如果你指定的模块不存在要小心;它会简单地忽略选项。 此外，有时需要提供的配置脚本与你的编译器，库和头文件的位置额外信息。这是通过两种环境变量或命令行选项来配置完成。有关详细信息，请参考配置页面。或使用–help选项调用配置。</p>\n<p><a href=\"http://httpd.apache.org/docs/2.4/programs/configure.html#installationdirectories\">Apache 官方配置说明</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div></pre></td><td class=\"code\"><pre><div class=\"line\">概要</div><div class=\"line\"></div><div class=\"line\">你应该叫configure从分布的根目录中的脚本。</div><div class=\"line\"></div><div class=\"line\">./configure [OPTION]... [VAR=VALUE]...</div><div class=\"line\"></div><div class=\"line\">要指定环境变量（例如CC， CFLAGS......），它们指定为 。请参见下面 的一些有用的变量的说明。VAR=VALUE</div><div class=\"line\"></div><div class=\"line\">最佳</div><div class=\"line\">选项</div><div class=\"line\"></div><div class=\"line\">配置选项</div><div class=\"line\">安装目录</div><div class=\"line\">系统类型</div><div class=\"line\">可选功能</div><div class=\"line\">支持程序的选项</div><div class=\"line\">配置选项</div><div class=\"line\">下列选项影响的行为 configure本身。</div><div class=\"line\"></div><div class=\"line\">-C</div><div class=\"line\">--config-cache</div><div class=\"line\">这是一个别名 --cache-file=config.cache</div><div class=\"line\">--cache-file=FILE</div><div class=\"line\">测试结果将在文件中缓存文件。此选项默认为禁用 ​​。</div><div class=\"line\">-h</div><div class=\"line\">--help [short|recursive]</div><div class=\"line\">输出的帮助和退出。随着说法short只是具体 ​​到这个包的选项将显示出来。参数 recursive显示所有包含包的简短帮助。</div><div class=\"line\">-n</div><div class=\"line\">--no-create</div><div class=\"line\">该configure脚本运行正常，但不创建输出文件。这是有用的生成makefile文件编译前检查测试结果。</div><div class=\"line\">-q</div><div class=\"line\">--quiet</div><div class=\"line\">不打印checking ...在配置过程的消息。</div><div class=\"line\">--srcdir=DIR</div><div class=\"line\">定义目录DIR是源文件目录。默认为所在目录configure的位置，或父目录。</div><div class=\"line\">--silent</div><div class=\"line\">与...一样 --quiet</div><div class=\"line\">-V</div><div class=\"line\">- 版</div><div class=\"line\">显示版权信息并退出。</div><div class=\"line\">安装目录</div><div class=\"line\">这些选项定义安装目录。安装树取决于所选的布局。</div><div class=\"line\"></div><div class=\"line\">--prefix=PREFIX</div><div class=\"line\">在安装结构无关的文件PREFIX。默认安装目录设置为 /usr/local/apache2。</div><div class=\"line\">--exec-prefix=EPREFIX</div><div class=\"line\">在安装体系相关的文件EPREFIX。默认安装目录设置为 PREFIX目录。</div><div class=\"line\">默认情况下，make install将安装所有文件 /usr/local/apache2/bin，/usr/local/apache2/lib 等等。您可以指定以外的安装前缀 /usr/local/apache2使用--prefix，例如--prefix=$HOME。</div><div class=\"line\"></div><div class=\"line\">定义一个目录布局</div><div class=\"line\">--enable-layout=LAYOUT</div><div class=\"line\">配置源代码和编译脚本的假设基础上的布局安装树布局。这使您可以分别指定为Apache HTTP服务器安装在每个类型的文件的位置。该config.layout 文件包含几个示例配置，你还可以创建下面的例子中你自己的自定义配置。该文件中的不同布局分为&lt;Layout FOO&gt;...&lt;/Layout&gt;部分，并通过名称简称为中FOO，默认布局Apache。</div><div class=\"line\">安装目录微调</div><div class=\"line\">为了更好地控制安装目录中，使用下面的选项。请注意，目录默认被设置 autoconf，并通过相应布局设置被覆盖。</div><div class=\"line\"></div><div class=\"line\">--bindir=DIR</div><div class=\"line\">在用户安装可执行文件DIR。用户可执行文件都支持这样的程序htpasswd， dbmmanage等等。这对于网站管理员有用。默认情况下DIR设置为 EPREFIX/bin。</div><div class=\"line\">--datadir=DIR</div><div class=\"line\">在安装只读体系结构无关的数据DIR。默认datadir设置为 PREFIX/share。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--includedir=DIR</div><div class=\"line\">在安装C头文件DIR。默认 includedir设置为 EPREFIX/include。</div><div class=\"line\">--infodir=DIR</div><div class=\"line\">在安装info文档DIR。默认infodir设置为 PREFIX/info。此选项当前未使用。</div><div class=\"line\">--libdir=DIR</div><div class=\"line\">在安装目标代码库DIR。默认 libdir设置为 EPREFIX/lib。</div><div class=\"line\">--libexecdir=DIR</div><div class=\"line\">在安装程序的可执行文件（例如，共享模块） DIR。默认libexecdir设置为 EPREFIX/modules。</div><div class=\"line\">--localstatedir=DIR</div><div class=\"line\">在安装修改的单机数据DIR。默认localstatedir设置为 PREFIX/var。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--mandir=DIR</div><div class=\"line\">在安装该男子文档DIR。默认 mandir设置为 EPREFIX/man。</div><div class=\"line\">--oldincludedir=DIR</div><div class=\"line\">在非GCC安装C头文件DIR。默认oldincludedir设置为 /usr/include。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--sbindir=DIR</div><div class=\"line\">在系统中安装管理员可执行DIR。这些都是服务器程序，如httpd， apachectl，suexec等，这些都需要运行在Apache HTTP服务器。默认 sbindir设置为 EPREFIX/sbin。</div><div class=\"line\">--sharedstatedir=DIR</div><div class=\"line\">在安装修改的架构无关的数据DIR。默认sharedstatedir设置为 PREFIX/com。此选项是提供 autoconf与当前未使用。</div><div class=\"line\">--sysconfdir=DIR</div><div class=\"line\">安装只读的单机数据，如服务器配置文件httpd.conf，mime.types等在 DIR。默认sysconfdir设置为 PREFIX/conf。</div><div class=\"line\">系统类型</div><div class=\"line\">这些选项用于交叉编译Apache HTTP服务器到另一个系统上运行。在正常的情况下，建立和运行在同一系统上的服务器时，不使用这些选项。</div><div class=\"line\"></div><div class=\"line\">--build=BUILD</div><div class=\"line\">定义系统类型上的工具正在建立该系统。它默认为脚本的结果 config.guess。</div><div class=\"line\">--host=HOST</div><div class=\"line\">定义系统类型的服务器将运行，系统的 HOST默认为BUILD。</div><div class=\"line\">--target=TARGET</div><div class=\"line\">配置构建编译器系统类型 目标。它默认为HOST。此选项被提供autoconf，而不是必要的Apache HTTP服务器。</div><div class=\"line\">可选功能</div><div class=\"line\">这些选项用于微调您的HTTP服务器将具备的功能。</div><div class=\"line\"></div><div class=\"line\">一般语法</div><div class=\"line\">一般来说，你可以使用下面的语法来启用或禁用功能：</div><div class=\"line\"></div><div class=\"line\">--disable-FEATURE</div><div class=\"line\">不包括特征。这是相同的 。--enable-FEATURE=no</div><div class=\"line\">--enable-FEATURE[=ARG]</div><div class=\"line\">包括特征。为默认值ARG 为yes。</div><div class=\"line\">--enable-MODULE=shared</div><div class=\"line\">相应的模块将被建设成为DSO模块。默认情况下启用的模块是动态链接的。</div><div class=\"line\">--enable-MODULE=static</div><div class=\"line\">相应的模块将被静态链接。</div><div class=\"line\">注意</div><div class=\"line\"></div><div class=\"line\">configure不会抱怨 ，即使富不存在，所以你需要仔细类型。 --enable-foo</div><div class=\"line\">选择模块编译</div><div class=\"line\">大多数模块由默认编译并已被明确或通过使用关键字禁用few （见--enable-modules，--enable-mods-shared 并且--enable-mods-static下面进一步解释）或--enable-modules=none作为一组被删除。</div><div class=\"line\"></div><div class=\"line\">其它模块默认不编译并已被明确或通过使用关键字启用all或 reallyall可用。</div><div class=\"line\"></div><div class=\"line\">要了解哪些模块是默认编译，运行 ./configure -h或./configure --help 下看Optional Features。假设你有兴趣mod_example1和 mod_example2，你看这个：</div><div class=\"line\"></div><div class=\"line\">可选功能：</div><div class=\"line\">  ...</div><div class=\"line\">  --disable-例1示例模块1</div><div class=\"line\">  --enable-例题例如模块2</div><div class=\"line\">  ...</div><div class=\"line\">然后mod_example1是默认启用的，你就可以使用--disable-example1不编译。 mod_example2默认情况下禁用，你就可以使用--enable-example2 编译它。</div><div class=\"line\"></div><div class=\"line\">多道处理模块</div><div class=\"line\">多道处理模块，或的MPM，实现了服务器的基本行为。单个MPM必须为了使服务器的功能被激活。出现在可用MPM列表 模块索引页。</div><div class=\"line\"></div><div class=\"line\">的MPM可以建成为数字存储示波器的动态加载或静态与服务器相连，并使用下列选项被启用：</div><div class=\"line\"></div><div class=\"line\">--with-mpm=MPM</div><div class=\"line\">选择适合您的服务器的默认MPM。如果MPM的构建为DSO模块（见--enable-mpms-shared），该指令选择将默认的配置文件中加载的MPM。否则，这个指令选择唯一可用的MPM，这将静态链接到服务器。</div><div class=\"line\"></div><div class=\"line\">如果省略此选项，默认的MPM为您的操作系统将被使用。</div><div class=\"line\"></div><div class=\"line\">--enable-mpms-shared=MPM-LIST</div><div class=\"line\">使动态共享模块的MPM的列表。这些模块之一必须动态使用加载 LoadModule指令。</div><div class=\"line\"></div><div class=\"line\">MPM-LIST是加了引号的MPM名称的空格分隔的列表。例如：</div><div class=\"line\"></div><div class=\"line\">--enable-mpms-shared=&apos;prefork worker&apos;</div><div class=\"line\">此外，您还可以使用特殊关键字all，这将选择支持在当前平台上动态加载所有的MPM和他们建立的DSO模块。例如：</div><div class=\"line\"></div><div class=\"line\">--enable-mpms-shared=all</div><div class=\"line\">第三方模块</div><div class=\"line\">要添加其他第三方模块使用下列选项：</div><div class=\"line\"></div><div class=\"line\">--with-module=module-type:module-file[, module-type:module-file]</div><div class=\"line\">添加一个或多个第三方的模块，以静态链接模块列表。该模块的源文件module-file 将在搜索 你的Apache HTTP服务器的源代码树的子目录。如果没有找到有它正在考虑模块文件是一个绝对文件路径，并尝试将源文件复制到 模块式子目录。如果子目录不存在，它将被创建并与标准的填充 。modules/module-typeconfigureMakefile.in</div><div class=\"line\"></div><div class=\"line\">此选项很有用添加由一个源文件小的外部组件。对于更复杂的模块，你应该阅读供应商的文档。</div><div class=\"line\"></div><div class=\"line\">注意</div><div class=\"line\"></div><div class=\"line\">如果你想建立一个DSO模块，而不是一个静态链接使用apxs。</div><div class=\"line\">累积和其他选项</div><div class=\"line\">--enable-maintainer-mode</div><div class=\"line\">打开调试和编译时警告，并加载所有编译的模块。</div><div class=\"line\">--enable-mods-shared=MODULE-LIST</div><div class=\"line\">定义启用并建立动态共享模块模块的列表。这意味着，这些模块必须通过使用动态加载 LoadModule指令。</div><div class=\"line\"></div><div class=\"line\">MODULE-LIST是加了引号的modulenames空格分隔列表。该模块名称没有给出前面mod_。例如：</div><div class=\"line\"></div><div class=\"line\">--enable-mods-shared=&apos;headers rewrite dav&apos;</div><div class=\"line\">此外，您还可以使用特殊的关键字reallyall， all，most和few。例如，</div><div class=\"line\"></div><div class=\"line\">--enable-mods-shared=most</div><div class=\"line\">将编译大多数模块，并将其建设成为DSO模块，</div><div class=\"line\"></div><div class=\"line\">--enable-mods-shared=few</div><div class=\"line\">将只编译一个非常基本的模块组。</div><div class=\"line\"></div><div class=\"line\">默认设置为most。</div><div class=\"line\"></div><div class=\"line\">在LoadModule对所选择的模块的指令将在主配置文件中自动生成。默认情况下，所有的指令都只是由一个配置要求或明确选择的模块被注释掉--enable-foo的说法。您可以更改设置启用或关闭加载的模块LoadModule的指令 httpd.conf。此外， LoadModule所有构建的模块的指令可通过配置选项被激活 --enable-load-all-modules。</div><div class=\"line\"></div><div class=\"line\">--enable-mods-static=MODULE-LIST</div><div class=\"line\">此选项的行为类似--enable-mods-shared，但在给定的模块静态链接。这意味着，这些模块将始终存在，同时运行httpd。他们不必被加载LoadModule。</div><div class=\"line\">--enable-modules=MODULE-LIST</div><div class=\"line\">此选项的行为等来--enable-mods-shared，并且还将动态地链接的给定模块。特殊关键字none禁用所有模块的版本。</div><div class=\"line\">--enable-v4-mapped</div><div class=\"line\">允许IPv6的套接字来处理IPv4连接。</div><div class=\"line\">--with-port=PORT</div><div class=\"line\">这定义上的端口httpd会听。生成配置文件时，该端口号用于 httpd.conf。默认值是80。</div><div class=\"line\">--with-program-name</div><div class=\"line\">定义一个替代的可执行文件名 ​​称。默认值是 httpd。</div><div class=\"line\">可选包</div><div class=\"line\">这些选项用于定义可选包。</div><div class=\"line\"></div><div class=\"line\">一般语法</div><div class=\"line\">一般来说，你可以使用下面的语法定义一个可选包：</div><div class=\"line\"></div><div class=\"line\">--with-PACKAGE[=ARG]</div><div class=\"line\">使用包PACKAGE。为默认值 ARG为yes。</div><div class=\"line\">--without-PACKAGE</div><div class=\"line\">不要使用包PACKAGE。这是相同的 。此选项所提供 ，但对于Apache HTTP服务器不是非常有用。--with-PACKAGE=noautoconf</div><div class=\"line\">特定软件包</div><div class=\"line\">--with-apr=DIR|FILE</div><div class=\"line\">在Apache可移植运行时（APR）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的年利率，而不是你要告诉configure路径的 apr-config脚本。你可以设置绝对路径和名称或目录切换到安装四月apr-config必须在该目录或子目录中存在 bin。</div><div class=\"line\">--with-apr-util=DIR|FILE</div><div class=\"line\">Apache可移植运行实用程序（APU）是httpd的源代码分发的一部分，将自动与HTTP服务器共同建立。如果您想使用已安装的APU，而不是你要告诉configure路径的 apu-config脚本。你可以设置绝对路径和名称或目录切换到安装APU，apu-config必须在该目录或子目录中存在 bin。</div><div class=\"line\">--with-ssl=DIR</div><div class=\"line\">如果mod_ssl已启用configure 已安装的OpenSSL的搜索。您可以将目录路径设置为SSL / TLS工具包来代替。</div><div class=\"line\">--with-z=DIR</div><div class=\"line\">configure已安装的自动搜索 zlib，如果你的源配置需要一个库（例如，当mod_deflate使能）。您可以设置压缩库的目录路径来代替。</div><div class=\"line\">Apache HTTP服务器的一些特性，如 mod_authn_dbm和mod_rewrite的DBM RewriteMap使用简单的键/值对数据库信息的快速查询。SDBM被包括在APU，所以这个数据库是始终可用。如果您想使用其他数据库类型，可以使用下面的选项，以使它们：</div><div class=\"line\"></div><div class=\"line\">--with-gdbm[=path]</div><div class=\"line\">如果没有路径指定，configure将搜索在平时的搜索路径GNU DBM安装的包含文件和库。一个明确的 路径会导致configure在寻找 path/lib，并 path/include为相关的文件。最后，路径可以指定用冒号隔开具体包括和库路径。</div><div class=\"line\">--with-ndbm[=path]</div><div class=\"line\">像--with-gdbm，但搜索新DBM安装。</div><div class=\"line\">--with-berkeley-db[=path]</div><div class=\"line\">像--with-gdbm，但搜索一个Berkeley DB的安装。</div><div class=\"line\">注意</div><div class=\"line\"></div><div class=\"line\">由APU提供，并通过其配置脚本传递的DBM选项。他们利用确定已安装的APU时是无用的--with-apr-util。</div><div class=\"line\">您可以使用自己的HTTP服务器一起使用一个以上的DBM实现。该拨款DBM类型将每次运行时配置中配置。</div><div class=\"line\">支持程序的选项</div><div class=\"line\">--enable-static-support</div><div class=\"line\">构建支持二进制文件的静态链接的版本。这意味着，一个独立的可执行文件将集成所有必要的库来构建。否则，支持二进制文件默认情况下，动态链接。</div><div class=\"line\">--enable-suexec</div><div class=\"line\">使用此选项可启用suexec，它允许您设置UID和GID的催生过程。除非你了解你的服务器上运行的SUID二进制的所有安全隐患，请勿使用此选项。更多选项来配置suexec介绍如下。</div><div class=\"line\">这可以通过使用下列选项来创建一个单一的支持程序的静态链接二进制文件：</div><div class=\"line\"></div><div class=\"line\">--enable-static-ab</div><div class=\"line\">建立一个静态链接的版本ab。</div><div class=\"line\">--enable-static-checkgid</div><div class=\"line\">建立一个静态链接的版本checkgid。</div><div class=\"line\">--enable-static-htdbm</div><div class=\"line\">建立一个静态链接的版本htdbm。</div><div class=\"line\">--enable-static-htdigest</div><div class=\"line\">建立一个静态链接的版本htdigest。</div><div class=\"line\">--enable-static-htpasswd</div><div class=\"line\">建立一个静态链接的版本htpasswd。</div><div class=\"line\">--enable-static-logresolve</div><div class=\"line\">建立一个静态链接的版本logresolve。</div><div class=\"line\">--enable-static-rotatelogs</div><div class=\"line\">建立一个静态链接的版本rotatelogs。</div><div class=\"line\">suexec 配置选项</div><div class=\"line\">下列选项用于微调的行为suexec。参见配置和安装suEXEC的 进一步的信息。</div><div class=\"line\"></div><div class=\"line\">--with-suexec-bin</div><div class=\"line\">这定义的路径suexec二进制文件。默认值是--sbindir（见安装目录微调）。</div><div class=\"line\">--with-suexec-caller</div><div class=\"line\">这定义允许呼叫的用户suexec。它应该是相同下，用户 httpd正常运行。</div><div class=\"line\">--with-suexec-docroot</div><div class=\"line\">这个定义下的目录树suexec允许访问的可执行文件。默认值是 --datadir/htdocs。</div><div class=\"line\">--with-suexec-gidmin</div><div class=\"line\">这个定义的最低GID成为目标用户 suexec。默认值是100。</div><div class=\"line\">--with-suexec-logfile</div><div class=\"line\">这个定义的文件名suexec​​日志文件。默认情况下，日志文件被命名为suexec_log，位于 --logfiledir。</div><div class=\"line\">--with-suexec-safepath</div><div class=\"line\">定义环境变量的值PATH由启动的进 ​​程进行设置suexec。默认值是/usr/local/bin:/usr/bin:/bin。</div><div class=\"line\">--with-suexec-userdir</div><div class=\"line\">此定义包含所有可执行文件的用户目录下的子目录suexec的访问是允许的。当你想使用此设置时必须 suexec使用特定用户目录在一起（如所提供的mod_userdir）。默认值是 public_html。</div><div class=\"line\">--with-suexec-uidmin</div><div class=\"line\">它定义为最低的UID允许为目标用户 suexec。默认值是100。</div><div class=\"line\">--with-suexec-umask</div><div class=\"line\">设置umask由启动的进 ​​程 suexec。它默认为您的系统设置。</div><div class=\"line\">最佳</div><div class=\"line\">环境变量</div><div class=\"line\"></div><div class=\"line\">有一些有用的环境变量覆盖所作出的选择 configure，或帮助它找到库和程序与非标准名称或位置。</div><div class=\"line\"></div><div class=\"line\">CC</div><div class=\"line\">定义要用于编译的C编译器的命令。</div><div class=\"line\">CFLAGS</div><div class=\"line\">要使用编译设置C编译器的标志。</div><div class=\"line\">CPP</div><div class=\"line\">定义C预处理命令使用。</div><div class=\"line\">CPPFLAGS</div><div class=\"line\">将C / C ++预处理器的标志，例如 ，如果你在一个非标准目录头了includedir。-Iincludedir</div><div class=\"line\">LDFLAGS</div><div class=\"line\">设置连接器选项，例如，如果你在一个非标准目录库LIBDIR。-Llibdir</div></pre></td></tr></table></figure>\n<p><strong><em>示例：</em></strong><br>这里是一个典型的例子编译Apache，安装树/ SW /包装/与特定的编译器和标志，加上两个额外的模块阿帕奇mod_ldap模块和mod_lua</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ CC=&quot;pgcc&quot; CFLAGS=&quot;-O2&quot; \\</div><div class=\"line\">./configure --prefix=/sw/pkg/apache \\</div><div class=\"line\">--enable-ldap=shared \\</div><div class=\"line\">--enable-lua=shared</div></pre></td></tr></table></figure>\n<p>我们本次采用基本的默认设置 来进行安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ ~]# cd httpd-2.4.23</div><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# ./configure  --with-included-apr</div></pre></td></tr></table></figure></p>\n<h3 id=\"Build\"><a href=\"#Build\" class=\"headerlink\" title=\"Build\"></a>Build</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# make</div></pre></td></tr></table></figure>\n<h3 id=\"Install\"><a href=\"#Install\" class=\"headerlink\" title=\"Install\"></a>Install</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# make install</div><div class=\"line\">···</div><div class=\"line\">Installing configuration files</div><div class=\"line\">mkdir /usr/local/apache2/conf</div><div class=\"line\">mkdir /usr/local/apache2/conf/extra</div><div class=\"line\">mkdir /usr/local/apache2/conf/original</div><div class=\"line\">mkdir /usr/local/apache2/conf/original/extra</div><div class=\"line\">Installing HTML documents</div><div class=\"line\">mkdir /usr/local/apache2/htdocs</div><div class=\"line\">Installing error documents</div><div class=\"line\">mkdir /usr/local/apache2/error</div><div class=\"line\">Installing icons</div><div class=\"line\">mkdir /usr/local/apache2/icons</div><div class=\"line\">mkdir /usr/local/apache2/logs</div><div class=\"line\">Installing CGIs</div><div class=\"line\">mkdir /usr/local/apache2/cgi-bin</div><div class=\"line\">Installing header files</div><div class=\"line\">Installing build system files</div><div class=\"line\">Installing man pages and online manual</div><div class=\"line\">mkdir /usr/local/apache2/man</div><div class=\"line\">mkdir /usr/local/apache2/man/man1</div><div class=\"line\">mkdir /usr/local/apache2/man/man8</div><div class=\"line\">mkdir /usr/local/apache2/manual</div></pre></td></tr></table></figure>\n<h3 id=\"Customize（定制）\"><a href=\"#Customize（定制）\" class=\"headerlink\" title=\"Customize（定制）\"></a>Customize（定制）</h3><p>接下来，我们可以通过在 /usr/local/apache2/conf 目录，编辑配置文件来自定义我们的Apache HTTP服务器。</p>\n<p><a href=\"http://httpd.apache.org/docs/2.4/zh-cn/mod/directives.html\">配置指令快速参考索引</a></p>\n<h3 id=\"Testinh-测试\"><a href=\"#Testinh-测试\" class=\"headerlink\" title=\"Testinh(测试)\"></a>Testinh(测试)</h3><p>启动Apache服务器<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# /usr/local/apache2/bin/apachectl -k start</div><div class=\"line\"></div><div class=\"line\">[root@iZ94m2e99jtZ httpd-2.4.23]# ps aux | grep httpd</div><div class=\"line\">root     15386  0.0  0.2  70556  2188 ?        Ss   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">daemon   15387  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">daemon   15388  0.0  0.4 359520  4260 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">daemon   15389  0.0  0.4 359520  4256 ?        Sl   11:53   0:00 /usr/local/apache2/bin/httpd -k start</div><div class=\"line\">root     15472  0.0  0.0 112664   972 pts/0    S+   11:53   0:00 grep --color=auto httpd</div></pre></td></tr></table></figure></p>\n<p>浏览器访问：<a href=\"http://IP地址\">http://IP地址</a></p>\n<p>当出现『It works!』字样说明我们已经安装成功</p>\n<p><strong><em>注意</em></strong> 如果通过浏览器访问不到，可能是请求服务器防火墙给拦截了，所以我们需要在防火墙里将我们用到的80端口给放行。<br>我以我当前Centos7 的系统为例，Centos7现在默认的防火墙是firewalld，Centos6以及6以前的版本则使用的是iptables，所以具体设置方法还请自己去搜索。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZ94m2e99jtZ ~]# firewall-cmd  --permanent --zone=public --add-port=80/tcp  #将80端口开放</div><div class=\"line\">success</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# firewall-cmd  --reload #重新加载防火墙配置</div><div class=\"line\">success</div></pre></td></tr></table></figure></p>\n<h2 id=\"日常管理\"><a href=\"#日常管理\" class=\"headerlink\" title=\"日常管理\"></a>日常管理</h2><p>一般常见的管理方式有两种</p>\n<ul>\n<li>直接通过httpd命令来管理</li>\n<li>通过apachectl来管理<br><strong><em>Tips</em></strong> apachetl其实一个是对httpd命令进行了封装sh脚本</li>\n</ul>\n<h3 id=\"常用命令\"><a href=\"#常用命令\" class=\"headerlink\" title=\"常用命令\"></a>常用命令</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">#通过apachectl来管理</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k start  #启动</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k restart  #重启</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/apachectl -k stop  #停止</div><div class=\"line\"></div><div class=\"line\">#直接通过httpd命令来管理</div><div class=\"line\">[root@iZ94m2e99jtZ ~]# /usr/local/apache2/bin/httpd -k start|restart|graceful|graceful-stop|stop</div></pre></td></tr></table></figure>\n<h3 id=\"具体参数\"><a href=\"#具体参数\" class=\"headerlink\" title=\"具体参数\"></a>具体参数</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\">Usage: /usr/local/apache2/bin/httpd [-D name] [-d directory] [-f file]</div><div class=\"line\">                                    [-C &quot;directive&quot;] [-c &quot;directive&quot;]</div><div class=\"line\">                                    [-k start|restart|graceful|graceful-stop|stop]</div><div class=\"line\">                                    [-v] [-V] [-h] [-l] [-L] [-t] [-T] [-S] [-X]</div><div class=\"line\">Options:</div><div class=\"line\">  -D name            : define a name for use in &lt;IfDefine name&gt; directives</div><div class=\"line\">  -d directory       : specify an alternate initial ServerRoot</div><div class=\"line\">  -f file            : specify an alternate ServerConfigFile</div><div class=\"line\">  -C &quot;directive&quot;     : process directive before reading config files</div><div class=\"line\">  -c &quot;directive&quot;     : process directive after reading config files</div><div class=\"line\">  -e level           : show startup errors of level (see LogLevel)</div><div class=\"line\">  -E file            : log startup errors to file</div><div class=\"line\">  -v                 : show version number</div><div class=\"line\">  -V                 : show compile settings</div><div class=\"line\">  -h                 : list available command line options (this page)</div><div class=\"line\">  -l                 : list compiled in modules</div><div class=\"line\">  -L                 : list available configuration directives</div><div class=\"line\">  -t -D DUMP_VHOSTS  : show parsed vhost settings</div><div class=\"line\">  -t -D DUMP_RUN_CFG : show parsed run settings</div><div class=\"line\">  -S                 : a synonym for -t -D DUMP_VHOSTS -D DUMP_RUN_CFG</div><div class=\"line\">  -t -D DUMP_MODULES : show all loaded modules</div><div class=\"line\">  -M                 : a synonym for -t -D DUMP_MODULES</div><div class=\"line\">  -t -D DUMP_INCLUDES: show all included configuration files</div><div class=\"line\">  -t                 : run syntax check for config files</div><div class=\"line\">  -T                 : start without DocumentRoot(s) check</div><div class=\"line\">  -X                 : debug mode (only one worker, do not detach)</div></pre></td></tr></table></figure>"},{"title":"ElasticSearch整理","date":"2016-10-05T13:00:00.000Z","_content":"\nElasticSearch是由Shay Banon发起的一个开源搜索服务器项目。由于其分布式特性和实时搜索能力，成为当前搜索和数据分析解决方案领域的重要成员。\n\n\n![ElasticSearch](http://n.sinaimg.cn/games/3ece443e/20161006/ElasticSearch.png)\n\n<!-- more -->\n## 基本概念\n索引\n> 索引（index）是ElasticSearch存放数据的一种逻辑结构。类比关系型数据库中的数据表。\n\n文档\n> 文档（document）是ElasticSearch中存储的主要实体。每个ElasticSearch文档类比关系型数据库中数据表的没一行数据。\n文档由字段（行数据的列）组成，一个文档由多个字段组成，并且ElasticSearch允许一个字段重复出现多次，该类型字段被称为多只字段。每个字段对应一种类型（字符串型、数值型、日期型等），并且ElasticSearch可以自动确定字段类型。不同于关系型数据库，ElasticSearch的文档结构可以是不固定的。即不同的文档可以有不同的字段集合。\n\n文档类型\n> ElasticSearch中，一个索引可以存储许多不同用途的对象。按照不同的用途我们可以将文档划分成不同的类型加以区分。\n\n节点和集群\n> ElasticSearch既可以作为一个独立搜索服务器工作，也支持多台一起协作进行运行，构成一个集群（cluster），其中的每个服务器被称为节点（node）。ElasticSearch可以通过索引分片,将海量的数据进行分割并分布到不同的节点，来实现更强的可用性和更高的性能。\n\n分片\n> 对于存储大规模的文档，ElasticSearch会将数据进行切分，每部分切成一个单独的Apache Lucene索引，称为分片（shared）。每个分片可以存储在集群的不同的节点上，当一个查询需要用到多个分片时，ElasticSearch会将请求发送至多个分片，之后结果进行合并。\n\n副本\n> 分片副本是对原始分片的一个拷贝，每个主分片可以有零个或者多个副分片。当主分片丢失时，副分片就会被提升为主分片。启用分片副本功能，可以提高查询的吞吐或实现系统的高可用性。\n\n## 安装\n### 环境准备\n\nJDK6+\n\nJDK的安装方式比较简单，只需将下载回来的程序包解压到相应的目录即可。\n```\nwget http://download.oracle.com/otn-pub/java/jdk/8u101-b13/jdk-8u101-linux-x64.tar.gz\nmkdir /usr/local/java\ntar -zxf jdk-8u101-linux-x64.tar.gz -C /usr/local/java/\n```\n设置JDK的环境变量，如下：\n```\n# tail -3 ~/.bash_profile\nexport JAVA_HOME=/usr/local/java/jdk1.8.0_101\nexport PATH=$PATH:$JAVA_HOME/bin\nexportCLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$CLASSPATH\n```\n重新加载环境变量\n```\n# source .bash_profile\n```\n在Shell提示符中执行java –version命令，显示如下结果，说明安装成功：\n```\n# java -version\njava version \"1.8.0_45\"\nJava(TM) SE Runtime Environment (build 1.8.0_45-b14)\nJava HotSpot(TM) 64-Bit Server VM (build 25.45-b02,mixed mode)\n```\n\n### 安装Elasticsearch\n\n下载Elasticsearch后，解压到对应的目录就完成Elasticsearch的安装。\n```\n# wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.7.0.zip\n# unzip elasticsearch-1.7.0.zip\n# mv elasticsearch-1.7.0 /usr/local/elasticsearch\n```\n\n\n\n\n### 目录结构\n```\nelasticsearch/\n├── bin\n│   ...#运行elasticsearch和进行插件管理所需的脚本\n├── config\n│   ...#elasticsearch配置文件所在目录\n├── data\n│   ...#存储elasticsearch用到的数据\n├── lib\n│   ...#elasticsearch运行中用到的库\n├── LICENSE.txt\n├── logs\n│   ...#存储elasticsearch运行中产生的事件信息和错误信息\n├── nohup\n├── NOTICE.txt\n└── README.textile\n\n10 directories, 60 files\n```\n\n\n### 配置\n所有的配置文件都位于config目录下。该目录下包含两个文件。\n```\n├── config\n│   ├── elasticsearch.yml\n│   └── logging.yml\n```\n\nelasticsearch.yml\n> 负责设置服务器的默认配置。\n> 比较重要的两个值cluster.name 和 node.name.\n> - cluster.name,保存的是集群名称。通过集群名称可以区分不同的集群。配置具有相同名称的节点将尝试组成一个集群。\n> - node.name，节点名称。我们也可以不指定该名称，elasticsearch会自动为节点选择一个唯一名称。但每次启动时这个唯一名称会发生改变。\n\n其他配置\n```\n##################### Elasticsearch Configuration Example #####################\n\n＃此文件包含各种配置设置的概述，\n＃针对操作人员。应用程序开发人员应该\n＃在咨询<http://elasticsearch.org/guide>指南。\n#\n＃安装过程被覆盖在\n＃<http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup.html>。\n#\n＃Elasticsearch附带了大多数设置合理的默认值，\n＃所以你可以尝试使用它而不用修改。\n#\n＃大多数时候，这些默认值是蛮好的运行生产\n＃集群。如果你正在微调群集，或者想知道的某些配置选项＃效果，请_DO ask_上\n＃邮件列表或IRC频道[http://elasticsearch.org/community。\n#\n＃配置中的任何元素都可以用环境变量替换\n＃通过将它们放置在$ {...}符号。 例如：\n#\n#node.rack: ${RACK_ENV_VAR}\n\n＃有关支持的格式和配置文件信息语法，请参阅\n＃<http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup-configuration.html>\n\n################################### Cluster 集群###################################\n\n＃集群名称标识群集的自动发现。如果你在同一个网络上的正在运行多个群集，请确保您使用的是唯一的名称。\n＃\n＃cluster.name：elasticsearch\n\n#################################### Node 节点#####################################\n\n\n＃节点名称是在启动时动态生成的，但你也可以手动配置它们。你可以给这个节点起一个特定的名称：\n＃\n#node.name: \"Franz Kafka\"\n\n＃每个节点可以被配置为允许或拒绝称为集群主节点，\n＃和允许或拒绝来存储数据。\n＃\n＃允许此节点可以作为主节点（默认启用）：\n＃\n#node.master: true\n#\n# 允许此节点可以用来存储数据（默认启用）：\n#\n#node.data: true\n\n\n＃你可以利用这些设置，以设计高级集群拓扑。\n＃\n＃1，你想这个节点永远不会成为一个主节点，只保存数据。这将是群集的“主力”。\n＃\n＃\n#node.master: false\n#node.data: true\n#\n＃2，你要这个节点只能作为主：不存储任何数据和有免费的资源。这将是群集的“协调员”。\n＃\n＃\n#node.master: true\n#node.data: false\n#\n＃3，你希望这个节点是不是主数据节点，但可以充当“搜索负载平衡器”（取从节点的数据，聚集结果等）\n＃\n#node.master: false\n#node.data: false\n\n\n＃使用群集健康状况API[http://localhost:9200/_cluster/health]，\n＃节点信息API[http://localhost:9200/_nodes]或GUI工具\n＃如<http://www.elasticsearch.org/overview/marvel/>\n＃<http://github.com/karmi/elasticsearch-paramedic>\n＃<http://github.com/lukas-vlcek/bigdesk>和\n＃<http://mobz.github.com/elasticsearch-head>检查群集状态。\n\n\n\n＃一个节点可以有与之关联的通用属性，可用于定制分片分配过滤，或分配意识。\n＃\n＃属性是一个简单的键值对，类似node.key：值，下面是一个例子：\n＃\n#node.rack: rack314\n\n＃默认情况下，多个节点被允许从相同的安装位置\n# 如果要禁用的话，设置如下：\n#node.max_local_storage_nodes: 1\n\n\n#################################### Index 索引####################################\n\n#\n＃您可以设置一些选项（如分片/副本选项，映射或分析器的定义，事务日志设置...）对全局参数，在这个文件中。\n#\n# Note, that it makes more sense to configure index settings specifically for\n# a certain index, either when creating it or by using the index templates API.\n#\n＃请注意，它更有意义专门配置索引设置\n＃某个具体的索引，创造它或使用该索引模板API。\n# See <http://elasticsearch.org/guide/en/elasticsearch/reference/current/index-modules.html> and\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/indices-create-index.html>\n# for more information.\n\n\n# 设置一个索引的分片（副本）数量（默认 5）\n#\n#index.number_of_shards: 5\n\n＃设置索引（默认值为1）的副本（额外副本）数量：\n＃\n#index.number_of_replicas: 1\n\n# Note, that for development on a local machine, with small indices, it usually\n# makes sense to \"disable\" the distributed features:\n#\n＃注意，对于在本地机器，它通常比较小的值。禁用分布式特点是很有必要的\n＃\n#index.number_of_shards: 1\n#index.number_of_replicas: 0\n\n\n＃这些设置直接影响索引和搜索操作的性能\n＃在集群中。假设你有足够多的机器来保存分片及\n＃副本，经验法则是：\n#\n# 1. 更多的分片能提高索引效率，一个大的索引允许存储在不同的服务器上\n# 2. 更多的副本能够提高搜索效率，并且能够增强系统的可用性\n#\n#  \"number_of_shards\" 对于一个索引不能动态修改设置一次.\n#\n# T \"number_of_replicas\" 可以增加或者减少在任何时候，通过索引更新或者api操作\n#\n# Elasticsearch takes care about load balancing, relocating, gathering the\n# results from nodes, etc. Experiment with different settings to fine-tune\n# your setup.\n\n＃Elasticsearch需要关心负载均衡，搬迁，从节点收集结果，等。\n# 你可以通过不断的微调进行设置\n\n＃使用索引状态API（<http://localhost:9200/A/_status>）检查\n＃索引状态。\n\n\n#################################### Paths ####################################\n\n# 路径包含目录配置（此文件并logging.yml）：\n#path.conf: /path/to/conf\n\n# 索引数据存储路径配置\n#path.data: /path/to/data\n#\n＃可以任选地包括一个以上的位置，方便扩展和使用。 例如：\n#\n#path.data: /path/to/data1,/path/to/data2\n\n# 临时文件路径：\n#\n#path.work: /path/to/work\n\n# 日志文件路径:\n#\n#path.logs: /path/to/logs\n\n# 插件安装目录\n#\n#path.plugins: /path/to/plugins\n\n\n#################################### Plugin ###################################\n\n# 如果这里列出的插件没有安装用于当前节点，该节点将无法启动。\n#\n#plugin.mandatory: mapper-attachments,lang-groovy\n\n\n################################### Memory ####################################\n\n＃Elasticsearch表现不佳时，JVM启动交换：你应该确保它永远不会_交换。\n#\n# 将此属性设置为true锁定内存：\n#\n#bootstrap.mlockall: true\n\n\n# 确保ES_MIN_MEM和ES_MAX_MEM环境变量设置\n＃为相同的值，并且该机器有足够的内存来分配\n＃为Elasticsearch，留出足够的内存为操作系统本身。\n＃\n#\n# You should also make sure that the Elasticsearch process is allowed to lock\n# the memory, eg. by using `ulimit -l unlimited`.\n# 你还应该确保该Elasticsearch允许进程锁定内存\n＃例如。通过使用`ulimit -l unlimited`。\n\n############################## Network And HTTP ###############################\n\n\n＃Elasticsearch，默认情况下，本身绑定到0.0.0.0地址，并监听\n＃端口[9200-9300] HTTP流量和端口[9300-9400]节点到节点\n＃沟通。（范围意味着，如果端口忙，它会自动将\n＃尝试下口）。\n\n# 设置绑定专用地址（IPv4或IPv6）：\n#network.bind_host: 192.168.0.1\n\n＃设置其他节点将使用与该节点通信的地址。否则\n＃，它会自动的产生。它必须指向一个实际的IP地址。\n#\n#network.publish_host: 192.168.0.1\n\n# 同时设置“bind_host'和'publish_host”：\n#\n#network.host: 192.168.0.1\n\n# 设置一个自定义的节点间通讯端口，（默认为 9300）\n#transport.tcp.port: 9300\n\n# 启用节点间通讯压缩\n#\n#transport.tcp.compress: true\n\n# 设置自定义端口侦听HTTP流量：\n#\n#http.port: 9200\n\n# 设置自定义允许的内容长度：\n#\n#http.max_content_length: 100mb\n\n# 完全禁用HTTP：\n#\n#http.enabled: false\n\n\n################################### Gateway ###################################\n\n\n＃网关允许持收集集群之间的群集状态\n＃集群中每个状态改变（例如添加一个索引），都将会存储\n＃在网关，并且当集群首次启动时，\n＃它会从网关读出其状态。\n\n\n＃有几种类型的网关实现的。欲了解更多信息，请参阅\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-gateway.html>.\n\n＃默认网关类型为“本地”网关（推荐）：\n#\n#gateway.type: local\n\n# 设置当集群崩溃时，如何重新启动并恢复进程（使用共享网关时，尽可能多的使用本地数据）\n\n# 允许恢复后，在一个集群中有N个节点：\n#\n#gateway.recover_after_nodes: 1\n\n＃设置超时时间，在启动恢复过程中，前面设置的N个节点全部重启（接受时间值）：\n#\n\n#gateway.recover_after_time: 5m\n\n＃设置在一个句群众预计的节点数\n#一旦这些N个节点全部启用（满足recover_after_nodes），立即开始恢复过程（无需等待恢复时间后到期）：\n#\n#gateway.expected_nodes: 2\n\n\n############################# Recovery Throttling 恢复节流 #############################\n\n\n＃这些设置可以控制碎片分配的过程，在节点恢复期间、副本定位、重新平衡，或添加和删除节点时\n\n\n#\n# 设置一个节点上同时恢复数量\n# 1. 初步恢复期间\n#\n#cluster.routing.allocation.node_initial_primaries_recoveries: 4\n#\n# 2. 在添加/删除节点，再平衡期间\n#\n#cluster.routing.allocation.node_concurrent_recoveries: 2\n\n# 设置一个恢复时的吞吐量值（如100MB，默认20MB）\n#\n#indices.recovery.max_bytes_per_sec: 20mb\n\n\n# 设置一个并发流数量限制，在同级别的分片恢复时\n#\n#indices.recovery.concurrent_streams: 5\n\n\n################################## Discovery 发现##################################\n\n\n＃发现基础设施，确保节点可以在群集内找到和主节点的选举。是默认是通过多播方式来进行发现。\n\n# 设置一个节点确保能在集群内发现N个其他合格的节点能成为主节点。\n\n#discovery.zen.minimum_master_nodes: 1\n\n\n# 设置一个过期时间，在通过ping发现其他节点时\n# 在一个较差的网络环境中设置一个较长的值，可以最大限度的减少报错\n\n#discovery.zen.ping.timeout: 3s\n\n# 更多的信息，请看\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-zen.html>\n\n\n＃单播发现允许明确地控制哪些节点将被用于发现群集。它可以在多播不存在，或限制集群通信时使用。\n#\n# 1. 多播发现（默认启用）\n#\n#discovery.zen.ping.multicast.enabled: false\n#\n# 2. 配置一个初始清单在集群的主节点上，为了发现一个刚启用的节点\n#\n#discovery.zen.ping.unicast.hosts: [\"host1\", \"host2:port\"]\n\n# 为了发现 ，EC2允许使用AWS EC2 API\n# 你必须安装云AWS插件启用EC2发现。\n#\n# 更多信息请查看\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-ec2.html>\n#\n# See <http://elasticsearch.org/tutorials/elasticsearch-on-ec2/>\n# 一步一步的教程\n\n# 为了发现 ，GCE发现允许使用谷歌Compute Engine的API\n#\n# 你必须安装云GCE GCE插件启用的发现。\n#\n# For more information, see <https://github.com/elasticsearch/elasticsearch-cloud-gce>.\n\n# Azure的发现允许以执行发现使用Azure的API。\n#\n# 你必须安装云cloud-azure插件启用的发现。\n# For more information, see <https://github.com/elasticsearch/elasticsearch-cloud-azure>.\n\n################################## Slow Log ##################################\n\n# 分片级查询并会的对应等级的日志\n\n#index.search.slowlog.threshold.query.warn: 10s\n#index.search.slowlog.threshold.query.info: 5s\n#index.search.slowlog.threshold.query.debug: 2s\n#index.search.slowlog.threshold.query.trace: 500ms\n\n#index.search.slowlog.threshold.fetch.warn: 1s\n#index.search.slowlog.threshold.fetch.info: 800ms\n#index.search.slowlog.threshold.fetch.debug: 500ms\n#index.search.slowlog.threshold.fetch.trace: 200ms\n\n#index.indexing.slowlog.threshold.index.warn: 10s\n#index.indexing.slowlog.threshold.index.info: 5s\n#index.indexing.slowlog.threshold.index.debug: 2s\n#index.indexing.slowlog.threshold.index.trace: 500ms\n\n################################## GC Logging ################################\n\n#monitor.jvm.gc.young.warn: 1000ms\n#monitor.jvm.gc.young.info: 700ms\n#monitor.jvm.gc.young.debug: 400ms\n\n#monitor.jvm.gc.old.warn: 10s\n#monitor.jvm.gc.old.info: 5s\n#monitor.jvm.gc.old.debug: 2s\n\n################################## Security ################################\n\n# Uncomment if you want to enable JSONP as a valid return transport on the\n# http server. With this enabled, it may pose a security risk, so disabling\n# it unless you need it is recommended (it is disabled by default).\n\n＃不推荐，如果要启用JSONP作为HTTP服务器上的返回。\n#启用此功能，它可能会带来安全风险，因此禁用它，除非你需要的建议（它被默认禁用）。\n\n#http.jsonp.enable: true\n\n```\n\n\n\nlogging.yml\n> 定义多少信息写入系统日志、定义日志文件，并定期创建新文件\n\n\n\n### 管理\n启动Elasticsearch\n```\n# /usr/local/elasticsearch/bin/elasticsearch  -d\n```\n> -d 表示将进程放入后台运行\n\n或者通过\u0004nohup命令\n```\n# nohup /usr/local/elasticsearch/bin/elasticsearch > nohup\n```\n\n将elasticsearch设置成开机自启动\n```\n# echo \"nohup /usr/local/elasticsearch/bin/elasticsearch > nohup\" > /etc/rc.local\n```\n\n确认elasticsearch的9200端口已监听，说明elasticsearch已成功运行\n\n```\n# netstat -anp |grep :9200\ntcp        0      0 :::9200                     :::*                        LISTEN      3362/java\n```\n如何关闭elasticsearch\n- 方法一：如果节点与控制台相连并且当前elasticsearch是使用-f选项运行，则只需要按下Ctrl+C组合键即可\n- 方法二：通过发送TERM信号来终止服务器进程 kill -9 进程ID\n- 方法三：使用REST API\n\n关闭整个集群\n```\n# curl -XPOST http://localhost:9200/_cluster/nodes/_shutdown\n```\n关闭单个节点\n```\n# curl -XPOST  http://127.0.0.1:9200/_cluster/nodes/2ens0yuEQ12G6ct1UDpihQ/_shutdown\n```\n2ens0yuEQ12G6ct1UDpihQ ，为要关闭的节点标志符\n\n查看节点标志符，可以从elasticsearch日志中或者通过REST API中获得\n```\n# curl http://localhost:9200/_nodes/?pretty\n{\n  \"cluster_name\" : \"elasticsearch\",\n  \"nodes\" : {\n    \"13QfvIdATEurGAhVAlO6tQ\" : {\n      \"name\" : \"Edwin Jarvis\",\n      ...\n    }\n  }\n}\n```\n13QfvIdATEurGAhVAlO6tQ,即为节点标志符\n\n\n### 测试\n```\n# curl http://localhost:9200\n{\n  \"status\" : 200,\n  \"name\" : \"Destroyer of Demons\",\n  \"cluster_name\" : \"elasticsearch\",\n  \"version\" : {\n    \"number\" : \"1.7.0\",\n    \"build_hash\" : \"929b9739cae115e73c346cb5f9a6f24ba735a743\",\n    \"build_timestamp\" : \"2015-07-16T14:31:07Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n```\n查看elasticsearch服务器当前运行状况\n```\n# curl http://localhost:9200/_cluster/health?pretty\n{\n  \"cluster_name\" : \"elasticsearch\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 1,\n  \"number_of_data_nodes\" : 1,\n  \"active_primary_shards\" : 0,\n  \"active_shards\" : 0,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0\n}\n```\n\n## 使用（基于REST API数据操作）\n\n### REST\n\nREST 定义了一组体系架构原则，您可以根据这些原则设计以系统资源为中心的 Web 服务，包括使用不同语言编写的客户端如何通过 HTTP 处理和传输资源状态。 它用简洁易行的方式向HTTP中的条目暴露CRUD（Create、Replace、Update、Delete，创建、替换、更新、删除）的应用功能。\n\n### 创建文档\n\n示例：创建一个文档用来存储一篇blog，内容如下：\n```\n{\n  \"title\":\"my first article title\",\n  \"content\":\"this is article content\",\n  \"date\":\"2016-10-05\"\n}\n```\n操作：\n```\n# curl -XPUT  http://localhost:9200/blog/article/1 -d '{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\"}'\n```\n返回结果如下：\n```\n{\"_index\":\"blog\",\"_type\":\"article\",\"_id\":\"1\",\"_version\":1,\"created\":true}\n```\n返回了操作结果信息，并显示新文档的存储位置。并且包含文档的唯一标识符以及当前版本信息。\n\n### 检索文档\n按照REST风格，我们想要查看刚才创建的文档。\n```\n# curl -XGET  http://localhost:9200/blog/article/1\n```\n结果\n```\ncurl -XGET  http://localhost:9200/blog/article/1?pretty\n{\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"found\" : true,\n  \"_source\":{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\"}\n}\n```\n### 更新文档\nElasticsearch中更新索引中的文档是非常复杂的工作。必须先提取文档、从_source字段获得数据、移除旧文档、应用变更，作为新文档创建索引。\n\n示例，更改之前创建的blog，并增加author字段\n```\n# curl -XPOST  http://localhost:9200/blog/article/1 -d '{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\",\"author\":\"zhimiao\"}'\n```\n结果：\n```\n# {\"_index\":\"blog\",\"_type\":\"article\",\"_id\":\"1\",\"_version\":3,\"created\":false}\n```\n\n查看是否更新成功\n```\n# curl -XGET  http://localhost:9200/blog/article/1?pretty\n{\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"_version\" : 4,\n  \"found\" : true,\n  \"_source\":{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\",\"author\":\"zhimiao\"}\n}\n```\n\n### 删除文档\n\n```\n# curl -XDELETE  http://localhost:9200/blog/article/1?pretty\n{\n  \"found\" : true,\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"_version\" : 7\n}\n```\n查看是否已删除\n```\n# curl -XGET  http://localhost:9200/blog/article/1?pretty\n{\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"found\" : false\n}\n```\n","source":"_posts/ElasticSearch整理.md","raw":"---\ntitle: ElasticSearch整理\ndate: 2016-10-05 21:00:00\ntags:\n- ElasticSearch\ncategories:\n- Linux\n---\n\nElasticSearch是由Shay Banon发起的一个开源搜索服务器项目。由于其分布式特性和实时搜索能力，成为当前搜索和数据分析解决方案领域的重要成员。\n\n\n![ElasticSearch](http://n.sinaimg.cn/games/3ece443e/20161006/ElasticSearch.png)\n\n<!-- more -->\n## 基本概念\n索引\n> 索引（index）是ElasticSearch存放数据的一种逻辑结构。类比关系型数据库中的数据表。\n\n文档\n> 文档（document）是ElasticSearch中存储的主要实体。每个ElasticSearch文档类比关系型数据库中数据表的没一行数据。\n文档由字段（行数据的列）组成，一个文档由多个字段组成，并且ElasticSearch允许一个字段重复出现多次，该类型字段被称为多只字段。每个字段对应一种类型（字符串型、数值型、日期型等），并且ElasticSearch可以自动确定字段类型。不同于关系型数据库，ElasticSearch的文档结构可以是不固定的。即不同的文档可以有不同的字段集合。\n\n文档类型\n> ElasticSearch中，一个索引可以存储许多不同用途的对象。按照不同的用途我们可以将文档划分成不同的类型加以区分。\n\n节点和集群\n> ElasticSearch既可以作为一个独立搜索服务器工作，也支持多台一起协作进行运行，构成一个集群（cluster），其中的每个服务器被称为节点（node）。ElasticSearch可以通过索引分片,将海量的数据进行分割并分布到不同的节点，来实现更强的可用性和更高的性能。\n\n分片\n> 对于存储大规模的文档，ElasticSearch会将数据进行切分，每部分切成一个单独的Apache Lucene索引，称为分片（shared）。每个分片可以存储在集群的不同的节点上，当一个查询需要用到多个分片时，ElasticSearch会将请求发送至多个分片，之后结果进行合并。\n\n副本\n> 分片副本是对原始分片的一个拷贝，每个主分片可以有零个或者多个副分片。当主分片丢失时，副分片就会被提升为主分片。启用分片副本功能，可以提高查询的吞吐或实现系统的高可用性。\n\n## 安装\n### 环境准备\n\nJDK6+\n\nJDK的安装方式比较简单，只需将下载回来的程序包解压到相应的目录即可。\n```\nwget http://download.oracle.com/otn-pub/java/jdk/8u101-b13/jdk-8u101-linux-x64.tar.gz\nmkdir /usr/local/java\ntar -zxf jdk-8u101-linux-x64.tar.gz -C /usr/local/java/\n```\n设置JDK的环境变量，如下：\n```\n# tail -3 ~/.bash_profile\nexport JAVA_HOME=/usr/local/java/jdk1.8.0_101\nexport PATH=$PATH:$JAVA_HOME/bin\nexportCLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$CLASSPATH\n```\n重新加载环境变量\n```\n# source .bash_profile\n```\n在Shell提示符中执行java –version命令，显示如下结果，说明安装成功：\n```\n# java -version\njava version \"1.8.0_45\"\nJava(TM) SE Runtime Environment (build 1.8.0_45-b14)\nJava HotSpot(TM) 64-Bit Server VM (build 25.45-b02,mixed mode)\n```\n\n### 安装Elasticsearch\n\n下载Elasticsearch后，解压到对应的目录就完成Elasticsearch的安装。\n```\n# wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.7.0.zip\n# unzip elasticsearch-1.7.0.zip\n# mv elasticsearch-1.7.0 /usr/local/elasticsearch\n```\n\n\n\n\n### 目录结构\n```\nelasticsearch/\n├── bin\n│   ...#运行elasticsearch和进行插件管理所需的脚本\n├── config\n│   ...#elasticsearch配置文件所在目录\n├── data\n│   ...#存储elasticsearch用到的数据\n├── lib\n│   ...#elasticsearch运行中用到的库\n├── LICENSE.txt\n├── logs\n│   ...#存储elasticsearch运行中产生的事件信息和错误信息\n├── nohup\n├── NOTICE.txt\n└── README.textile\n\n10 directories, 60 files\n```\n\n\n### 配置\n所有的配置文件都位于config目录下。该目录下包含两个文件。\n```\n├── config\n│   ├── elasticsearch.yml\n│   └── logging.yml\n```\n\nelasticsearch.yml\n> 负责设置服务器的默认配置。\n> 比较重要的两个值cluster.name 和 node.name.\n> - cluster.name,保存的是集群名称。通过集群名称可以区分不同的集群。配置具有相同名称的节点将尝试组成一个集群。\n> - node.name，节点名称。我们也可以不指定该名称，elasticsearch会自动为节点选择一个唯一名称。但每次启动时这个唯一名称会发生改变。\n\n其他配置\n```\n##################### Elasticsearch Configuration Example #####################\n\n＃此文件包含各种配置设置的概述，\n＃针对操作人员。应用程序开发人员应该\n＃在咨询<http://elasticsearch.org/guide>指南。\n#\n＃安装过程被覆盖在\n＃<http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup.html>。\n#\n＃Elasticsearch附带了大多数设置合理的默认值，\n＃所以你可以尝试使用它而不用修改。\n#\n＃大多数时候，这些默认值是蛮好的运行生产\n＃集群。如果你正在微调群集，或者想知道的某些配置选项＃效果，请_DO ask_上\n＃邮件列表或IRC频道[http://elasticsearch.org/community。\n#\n＃配置中的任何元素都可以用环境变量替换\n＃通过将它们放置在$ {...}符号。 例如：\n#\n#node.rack: ${RACK_ENV_VAR}\n\n＃有关支持的格式和配置文件信息语法，请参阅\n＃<http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup-configuration.html>\n\n################################### Cluster 集群###################################\n\n＃集群名称标识群集的自动发现。如果你在同一个网络上的正在运行多个群集，请确保您使用的是唯一的名称。\n＃\n＃cluster.name：elasticsearch\n\n#################################### Node 节点#####################################\n\n\n＃节点名称是在启动时动态生成的，但你也可以手动配置它们。你可以给这个节点起一个特定的名称：\n＃\n#node.name: \"Franz Kafka\"\n\n＃每个节点可以被配置为允许或拒绝称为集群主节点，\n＃和允许或拒绝来存储数据。\n＃\n＃允许此节点可以作为主节点（默认启用）：\n＃\n#node.master: true\n#\n# 允许此节点可以用来存储数据（默认启用）：\n#\n#node.data: true\n\n\n＃你可以利用这些设置，以设计高级集群拓扑。\n＃\n＃1，你想这个节点永远不会成为一个主节点，只保存数据。这将是群集的“主力”。\n＃\n＃\n#node.master: false\n#node.data: true\n#\n＃2，你要这个节点只能作为主：不存储任何数据和有免费的资源。这将是群集的“协调员”。\n＃\n＃\n#node.master: true\n#node.data: false\n#\n＃3，你希望这个节点是不是主数据节点，但可以充当“搜索负载平衡器”（取从节点的数据，聚集结果等）\n＃\n#node.master: false\n#node.data: false\n\n\n＃使用群集健康状况API[http://localhost:9200/_cluster/health]，\n＃节点信息API[http://localhost:9200/_nodes]或GUI工具\n＃如<http://www.elasticsearch.org/overview/marvel/>\n＃<http://github.com/karmi/elasticsearch-paramedic>\n＃<http://github.com/lukas-vlcek/bigdesk>和\n＃<http://mobz.github.com/elasticsearch-head>检查群集状态。\n\n\n\n＃一个节点可以有与之关联的通用属性，可用于定制分片分配过滤，或分配意识。\n＃\n＃属性是一个简单的键值对，类似node.key：值，下面是一个例子：\n＃\n#node.rack: rack314\n\n＃默认情况下，多个节点被允许从相同的安装位置\n# 如果要禁用的话，设置如下：\n#node.max_local_storage_nodes: 1\n\n\n#################################### Index 索引####################################\n\n#\n＃您可以设置一些选项（如分片/副本选项，映射或分析器的定义，事务日志设置...）对全局参数，在这个文件中。\n#\n# Note, that it makes more sense to configure index settings specifically for\n# a certain index, either when creating it or by using the index templates API.\n#\n＃请注意，它更有意义专门配置索引设置\n＃某个具体的索引，创造它或使用该索引模板API。\n# See <http://elasticsearch.org/guide/en/elasticsearch/reference/current/index-modules.html> and\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/indices-create-index.html>\n# for more information.\n\n\n# 设置一个索引的分片（副本）数量（默认 5）\n#\n#index.number_of_shards: 5\n\n＃设置索引（默认值为1）的副本（额外副本）数量：\n＃\n#index.number_of_replicas: 1\n\n# Note, that for development on a local machine, with small indices, it usually\n# makes sense to \"disable\" the distributed features:\n#\n＃注意，对于在本地机器，它通常比较小的值。禁用分布式特点是很有必要的\n＃\n#index.number_of_shards: 1\n#index.number_of_replicas: 0\n\n\n＃这些设置直接影响索引和搜索操作的性能\n＃在集群中。假设你有足够多的机器来保存分片及\n＃副本，经验法则是：\n#\n# 1. 更多的分片能提高索引效率，一个大的索引允许存储在不同的服务器上\n# 2. 更多的副本能够提高搜索效率，并且能够增强系统的可用性\n#\n#  \"number_of_shards\" 对于一个索引不能动态修改设置一次.\n#\n# T \"number_of_replicas\" 可以增加或者减少在任何时候，通过索引更新或者api操作\n#\n# Elasticsearch takes care about load balancing, relocating, gathering the\n# results from nodes, etc. Experiment with different settings to fine-tune\n# your setup.\n\n＃Elasticsearch需要关心负载均衡，搬迁，从节点收集结果，等。\n# 你可以通过不断的微调进行设置\n\n＃使用索引状态API（<http://localhost:9200/A/_status>）检查\n＃索引状态。\n\n\n#################################### Paths ####################################\n\n# 路径包含目录配置（此文件并logging.yml）：\n#path.conf: /path/to/conf\n\n# 索引数据存储路径配置\n#path.data: /path/to/data\n#\n＃可以任选地包括一个以上的位置，方便扩展和使用。 例如：\n#\n#path.data: /path/to/data1,/path/to/data2\n\n# 临时文件路径：\n#\n#path.work: /path/to/work\n\n# 日志文件路径:\n#\n#path.logs: /path/to/logs\n\n# 插件安装目录\n#\n#path.plugins: /path/to/plugins\n\n\n#################################### Plugin ###################################\n\n# 如果这里列出的插件没有安装用于当前节点，该节点将无法启动。\n#\n#plugin.mandatory: mapper-attachments,lang-groovy\n\n\n################################### Memory ####################################\n\n＃Elasticsearch表现不佳时，JVM启动交换：你应该确保它永远不会_交换。\n#\n# 将此属性设置为true锁定内存：\n#\n#bootstrap.mlockall: true\n\n\n# 确保ES_MIN_MEM和ES_MAX_MEM环境变量设置\n＃为相同的值，并且该机器有足够的内存来分配\n＃为Elasticsearch，留出足够的内存为操作系统本身。\n＃\n#\n# You should also make sure that the Elasticsearch process is allowed to lock\n# the memory, eg. by using `ulimit -l unlimited`.\n# 你还应该确保该Elasticsearch允许进程锁定内存\n＃例如。通过使用`ulimit -l unlimited`。\n\n############################## Network And HTTP ###############################\n\n\n＃Elasticsearch，默认情况下，本身绑定到0.0.0.0地址，并监听\n＃端口[9200-9300] HTTP流量和端口[9300-9400]节点到节点\n＃沟通。（范围意味着，如果端口忙，它会自动将\n＃尝试下口）。\n\n# 设置绑定专用地址（IPv4或IPv6）：\n#network.bind_host: 192.168.0.1\n\n＃设置其他节点将使用与该节点通信的地址。否则\n＃，它会自动的产生。它必须指向一个实际的IP地址。\n#\n#network.publish_host: 192.168.0.1\n\n# 同时设置“bind_host'和'publish_host”：\n#\n#network.host: 192.168.0.1\n\n# 设置一个自定义的节点间通讯端口，（默认为 9300）\n#transport.tcp.port: 9300\n\n# 启用节点间通讯压缩\n#\n#transport.tcp.compress: true\n\n# 设置自定义端口侦听HTTP流量：\n#\n#http.port: 9200\n\n# 设置自定义允许的内容长度：\n#\n#http.max_content_length: 100mb\n\n# 完全禁用HTTP：\n#\n#http.enabled: false\n\n\n################################### Gateway ###################################\n\n\n＃网关允许持收集集群之间的群集状态\n＃集群中每个状态改变（例如添加一个索引），都将会存储\n＃在网关，并且当集群首次启动时，\n＃它会从网关读出其状态。\n\n\n＃有几种类型的网关实现的。欲了解更多信息，请参阅\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-gateway.html>.\n\n＃默认网关类型为“本地”网关（推荐）：\n#\n#gateway.type: local\n\n# 设置当集群崩溃时，如何重新启动并恢复进程（使用共享网关时，尽可能多的使用本地数据）\n\n# 允许恢复后，在一个集群中有N个节点：\n#\n#gateway.recover_after_nodes: 1\n\n＃设置超时时间，在启动恢复过程中，前面设置的N个节点全部重启（接受时间值）：\n#\n\n#gateway.recover_after_time: 5m\n\n＃设置在一个句群众预计的节点数\n#一旦这些N个节点全部启用（满足recover_after_nodes），立即开始恢复过程（无需等待恢复时间后到期）：\n#\n#gateway.expected_nodes: 2\n\n\n############################# Recovery Throttling 恢复节流 #############################\n\n\n＃这些设置可以控制碎片分配的过程，在节点恢复期间、副本定位、重新平衡，或添加和删除节点时\n\n\n#\n# 设置一个节点上同时恢复数量\n# 1. 初步恢复期间\n#\n#cluster.routing.allocation.node_initial_primaries_recoveries: 4\n#\n# 2. 在添加/删除节点，再平衡期间\n#\n#cluster.routing.allocation.node_concurrent_recoveries: 2\n\n# 设置一个恢复时的吞吐量值（如100MB，默认20MB）\n#\n#indices.recovery.max_bytes_per_sec: 20mb\n\n\n# 设置一个并发流数量限制，在同级别的分片恢复时\n#\n#indices.recovery.concurrent_streams: 5\n\n\n################################## Discovery 发现##################################\n\n\n＃发现基础设施，确保节点可以在群集内找到和主节点的选举。是默认是通过多播方式来进行发现。\n\n# 设置一个节点确保能在集群内发现N个其他合格的节点能成为主节点。\n\n#discovery.zen.minimum_master_nodes: 1\n\n\n# 设置一个过期时间，在通过ping发现其他节点时\n# 在一个较差的网络环境中设置一个较长的值，可以最大限度的减少报错\n\n#discovery.zen.ping.timeout: 3s\n\n# 更多的信息，请看\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-zen.html>\n\n\n＃单播发现允许明确地控制哪些节点将被用于发现群集。它可以在多播不存在，或限制集群通信时使用。\n#\n# 1. 多播发现（默认启用）\n#\n#discovery.zen.ping.multicast.enabled: false\n#\n# 2. 配置一个初始清单在集群的主节点上，为了发现一个刚启用的节点\n#\n#discovery.zen.ping.unicast.hosts: [\"host1\", \"host2:port\"]\n\n# 为了发现 ，EC2允许使用AWS EC2 API\n# 你必须安装云AWS插件启用EC2发现。\n#\n# 更多信息请查看\n# <http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-ec2.html>\n#\n# See <http://elasticsearch.org/tutorials/elasticsearch-on-ec2/>\n# 一步一步的教程\n\n# 为了发现 ，GCE发现允许使用谷歌Compute Engine的API\n#\n# 你必须安装云GCE GCE插件启用的发现。\n#\n# For more information, see <https://github.com/elasticsearch/elasticsearch-cloud-gce>.\n\n# Azure的发现允许以执行发现使用Azure的API。\n#\n# 你必须安装云cloud-azure插件启用的发现。\n# For more information, see <https://github.com/elasticsearch/elasticsearch-cloud-azure>.\n\n################################## Slow Log ##################################\n\n# 分片级查询并会的对应等级的日志\n\n#index.search.slowlog.threshold.query.warn: 10s\n#index.search.slowlog.threshold.query.info: 5s\n#index.search.slowlog.threshold.query.debug: 2s\n#index.search.slowlog.threshold.query.trace: 500ms\n\n#index.search.slowlog.threshold.fetch.warn: 1s\n#index.search.slowlog.threshold.fetch.info: 800ms\n#index.search.slowlog.threshold.fetch.debug: 500ms\n#index.search.slowlog.threshold.fetch.trace: 200ms\n\n#index.indexing.slowlog.threshold.index.warn: 10s\n#index.indexing.slowlog.threshold.index.info: 5s\n#index.indexing.slowlog.threshold.index.debug: 2s\n#index.indexing.slowlog.threshold.index.trace: 500ms\n\n################################## GC Logging ################################\n\n#monitor.jvm.gc.young.warn: 1000ms\n#monitor.jvm.gc.young.info: 700ms\n#monitor.jvm.gc.young.debug: 400ms\n\n#monitor.jvm.gc.old.warn: 10s\n#monitor.jvm.gc.old.info: 5s\n#monitor.jvm.gc.old.debug: 2s\n\n################################## Security ################################\n\n# Uncomment if you want to enable JSONP as a valid return transport on the\n# http server. With this enabled, it may pose a security risk, so disabling\n# it unless you need it is recommended (it is disabled by default).\n\n＃不推荐，如果要启用JSONP作为HTTP服务器上的返回。\n#启用此功能，它可能会带来安全风险，因此禁用它，除非你需要的建议（它被默认禁用）。\n\n#http.jsonp.enable: true\n\n```\n\n\n\nlogging.yml\n> 定义多少信息写入系统日志、定义日志文件，并定期创建新文件\n\n\n\n### 管理\n启动Elasticsearch\n```\n# /usr/local/elasticsearch/bin/elasticsearch  -d\n```\n> -d 表示将进程放入后台运行\n\n或者通过\u0004nohup命令\n```\n# nohup /usr/local/elasticsearch/bin/elasticsearch > nohup\n```\n\n将elasticsearch设置成开机自启动\n```\n# echo \"nohup /usr/local/elasticsearch/bin/elasticsearch > nohup\" > /etc/rc.local\n```\n\n确认elasticsearch的9200端口已监听，说明elasticsearch已成功运行\n\n```\n# netstat -anp |grep :9200\ntcp        0      0 :::9200                     :::*                        LISTEN      3362/java\n```\n如何关闭elasticsearch\n- 方法一：如果节点与控制台相连并且当前elasticsearch是使用-f选项运行，则只需要按下Ctrl+C组合键即可\n- 方法二：通过发送TERM信号来终止服务器进程 kill -9 进程ID\n- 方法三：使用REST API\n\n关闭整个集群\n```\n# curl -XPOST http://localhost:9200/_cluster/nodes/_shutdown\n```\n关闭单个节点\n```\n# curl -XPOST  http://127.0.0.1:9200/_cluster/nodes/2ens0yuEQ12G6ct1UDpihQ/_shutdown\n```\n2ens0yuEQ12G6ct1UDpihQ ，为要关闭的节点标志符\n\n查看节点标志符，可以从elasticsearch日志中或者通过REST API中获得\n```\n# curl http://localhost:9200/_nodes/?pretty\n{\n  \"cluster_name\" : \"elasticsearch\",\n  \"nodes\" : {\n    \"13QfvIdATEurGAhVAlO6tQ\" : {\n      \"name\" : \"Edwin Jarvis\",\n      ...\n    }\n  }\n}\n```\n13QfvIdATEurGAhVAlO6tQ,即为节点标志符\n\n\n### 测试\n```\n# curl http://localhost:9200\n{\n  \"status\" : 200,\n  \"name\" : \"Destroyer of Demons\",\n  \"cluster_name\" : \"elasticsearch\",\n  \"version\" : {\n    \"number\" : \"1.7.0\",\n    \"build_hash\" : \"929b9739cae115e73c346cb5f9a6f24ba735a743\",\n    \"build_timestamp\" : \"2015-07-16T14:31:07Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n```\n查看elasticsearch服务器当前运行状况\n```\n# curl http://localhost:9200/_cluster/health?pretty\n{\n  \"cluster_name\" : \"elasticsearch\",\n  \"status\" : \"green\",\n  \"timed_out\" : false,\n  \"number_of_nodes\" : 1,\n  \"number_of_data_nodes\" : 1,\n  \"active_primary_shards\" : 0,\n  \"active_shards\" : 0,\n  \"relocating_shards\" : 0,\n  \"initializing_shards\" : 0,\n  \"unassigned_shards\" : 0,\n  \"delayed_unassigned_shards\" : 0,\n  \"number_of_pending_tasks\" : 0,\n  \"number_of_in_flight_fetch\" : 0\n}\n```\n\n## 使用（基于REST API数据操作）\n\n### REST\n\nREST 定义了一组体系架构原则，您可以根据这些原则设计以系统资源为中心的 Web 服务，包括使用不同语言编写的客户端如何通过 HTTP 处理和传输资源状态。 它用简洁易行的方式向HTTP中的条目暴露CRUD（Create、Replace、Update、Delete，创建、替换、更新、删除）的应用功能。\n\n### 创建文档\n\n示例：创建一个文档用来存储一篇blog，内容如下：\n```\n{\n  \"title\":\"my first article title\",\n  \"content\":\"this is article content\",\n  \"date\":\"2016-10-05\"\n}\n```\n操作：\n```\n# curl -XPUT  http://localhost:9200/blog/article/1 -d '{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\"}'\n```\n返回结果如下：\n```\n{\"_index\":\"blog\",\"_type\":\"article\",\"_id\":\"1\",\"_version\":1,\"created\":true}\n```\n返回了操作结果信息，并显示新文档的存储位置。并且包含文档的唯一标识符以及当前版本信息。\n\n### 检索文档\n按照REST风格，我们想要查看刚才创建的文档。\n```\n# curl -XGET  http://localhost:9200/blog/article/1\n```\n结果\n```\ncurl -XGET  http://localhost:9200/blog/article/1?pretty\n{\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"_version\" : 1,\n  \"found\" : true,\n  \"_source\":{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\"}\n}\n```\n### 更新文档\nElasticsearch中更新索引中的文档是非常复杂的工作。必须先提取文档、从_source字段获得数据、移除旧文档、应用变更，作为新文档创建索引。\n\n示例，更改之前创建的blog，并增加author字段\n```\n# curl -XPOST  http://localhost:9200/blog/article/1 -d '{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\",\"author\":\"zhimiao\"}'\n```\n结果：\n```\n# {\"_index\":\"blog\",\"_type\":\"article\",\"_id\":\"1\",\"_version\":3,\"created\":false}\n```\n\n查看是否更新成功\n```\n# curl -XGET  http://localhost:9200/blog/article/1?pretty\n{\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"_version\" : 4,\n  \"found\" : true,\n  \"_source\":{\"title\":\"my first article title\",\"content\":\"this is article content\",\"date\":\"2016-10-05\",\"author\":\"zhimiao\"}\n}\n```\n\n### 删除文档\n\n```\n# curl -XDELETE  http://localhost:9200/blog/article/1?pretty\n{\n  \"found\" : true,\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"_version\" : 7\n}\n```\n查看是否已删除\n```\n# curl -XGET  http://localhost:9200/blog/article/1?pretty\n{\n  \"_index\" : \"blog\",\n  \"_type\" : \"article\",\n  \"_id\" : \"1\",\n  \"found\" : false\n}\n```\n","slug":"ElasticSearch整理","published":1,"updated":"2016-10-08T09:36:44.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwus000b699fwk4t9sq4","content":"<p>ElasticSearch是由Shay Banon发起的一个开源搜索服务器项目。由于其分布式特性和实时搜索能力，成为当前搜索和数据分析解决方案领域的重要成员。</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161006/ElasticSearch.png\" alt=\"ElasticSearch\"></p>\n<a id=\"more\"></a>\n<h2 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h2><p>索引</p>\n<blockquote>\n<p>索引（index）是ElasticSearch存放数据的一种逻辑结构。类比关系型数据库中的数据表。</p>\n</blockquote>\n<p>文档</p>\n<blockquote>\n<p>文档（document）是ElasticSearch中存储的主要实体。每个ElasticSearch文档类比关系型数据库中数据表的没一行数据。<br>文档由字段（行数据的列）组成，一个文档由多个字段组成，并且ElasticSearch允许一个字段重复出现多次，该类型字段被称为多只字段。每个字段对应一种类型（字符串型、数值型、日期型等），并且ElasticSearch可以自动确定字段类型。不同于关系型数据库，ElasticSearch的文档结构可以是不固定的。即不同的文档可以有不同的字段集合。</p>\n</blockquote>\n<p>文档类型</p>\n<blockquote>\n<p>ElasticSearch中，一个索引可以存储许多不同用途的对象。按照不同的用途我们可以将文档划分成不同的类型加以区分。</p>\n</blockquote>\n<p>节点和集群</p>\n<blockquote>\n<p>ElasticSearch既可以作为一个独立搜索服务器工作，也支持多台一起协作进行运行，构成一个集群（cluster），其中的每个服务器被称为节点（node）。ElasticSearch可以通过索引分片,将海量的数据进行分割并分布到不同的节点，来实现更强的可用性和更高的性能。</p>\n</blockquote>\n<p>分片</p>\n<blockquote>\n<p>对于存储大规模的文档，ElasticSearch会将数据进行切分，每部分切成一个单独的Apache Lucene索引，称为分片（shared）。每个分片可以存储在集群的不同的节点上，当一个查询需要用到多个分片时，ElasticSearch会将请求发送至多个分片，之后结果进行合并。</p>\n</blockquote>\n<p>副本</p>\n<blockquote>\n<p>分片副本是对原始分片的一个拷贝，每个主分片可以有零个或者多个副分片。当主分片丢失时，副分片就会被提升为主分片。启用分片副本功能，可以提高查询的吞吐或实现系统的高可用性。</p>\n</blockquote>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h3 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><p>JDK6+</p>\n<p>JDK的安装方式比较简单，只需将下载回来的程序包解压到相应的目录即可。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://download.oracle.com/otn-pub/java/jdk/8u101-b13/jdk-8u101-linux-x64.tar.gz</div><div class=\"line\">mkdir /usr/local/java</div><div class=\"line\">tar -zxf jdk-8u101-linux-x64.tar.gz -C /usr/local/java/</div></pre></td></tr></table></figure></p>\n<p>设置JDK的环境变量，如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># tail -3 ~/.bash_profile</div><div class=\"line\">export JAVA_HOME=/usr/local/java/jdk1.8.0_101</div><div class=\"line\">export PATH=$PATH:$JAVA_HOME/bin</div><div class=\"line\">exportCLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$CLASSPATH</div></pre></td></tr></table></figure></p>\n<p>重新加载环境变量<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># source .bash_profile</div></pre></td></tr></table></figure></p>\n<p>在Shell提示符中执行java –version命令，显示如下结果，说明安装成功：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># java -version</div><div class=\"line\">java version &quot;1.8.0_45&quot;</div><div class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_45-b14)</div><div class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.45-b02,mixed mode)</div></pre></td></tr></table></figure></p>\n<h3 id=\"安装Elasticsearch\"><a href=\"#安装Elasticsearch\" class=\"headerlink\" title=\"安装Elasticsearch\"></a>安装Elasticsearch</h3><p>下载Elasticsearch后，解压到对应的目录就完成Elasticsearch的安装。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.7.0.zip</div><div class=\"line\"># unzip elasticsearch-1.7.0.zip</div><div class=\"line\"># mv elasticsearch-1.7.0 /usr/local/elasticsearch</div></pre></td></tr></table></figure></p>\n<h3 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">elasticsearch/</div><div class=\"line\">├── bin</div><div class=\"line\">│   ...#运行elasticsearch和进行插件管理所需的脚本</div><div class=\"line\">├── config</div><div class=\"line\">│   ...#elasticsearch配置文件所在目录</div><div class=\"line\">├── data</div><div class=\"line\">│   ...#存储elasticsearch用到的数据</div><div class=\"line\">├── lib</div><div class=\"line\">│   ...#elasticsearch运行中用到的库</div><div class=\"line\">├── LICENSE.txt</div><div class=\"line\">├── logs</div><div class=\"line\">│   ...#存储elasticsearch运行中产生的事件信息和错误信息</div><div class=\"line\">├── nohup</div><div class=\"line\">├── NOTICE.txt</div><div class=\"line\">└── README.textile</div><div class=\"line\"></div><div class=\"line\">10 directories, 60 files</div></pre></td></tr></table></figure>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>所有的配置文件都位于config目录下。该目录下包含两个文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">├── config</div><div class=\"line\">│   ├── elasticsearch.yml</div><div class=\"line\">│   └── logging.yml</div></pre></td></tr></table></figure></p>\n<p>elasticsearch.yml</p>\n<blockquote>\n<p>负责设置服务器的默认配置。<br>比较重要的两个值cluster.name 和 node.name.</p>\n<ul>\n<li>cluster.name,保存的是集群名称。通过集群名称可以区分不同的集群。配置具有相同名称的节点将尝试组成一个集群。</li>\n<li>node.name，节点名称。我们也可以不指定该名称，elasticsearch会自动为节点选择一个唯一名称。但每次启动时这个唯一名称会发生改变。</li>\n</ul>\n</blockquote>\n<p>其他配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div><div class=\"line\">311</div><div class=\"line\">312</div><div class=\"line\">313</div><div class=\"line\">314</div><div class=\"line\">315</div><div class=\"line\">316</div><div class=\"line\">317</div><div class=\"line\">318</div><div class=\"line\">319</div><div class=\"line\">320</div><div class=\"line\">321</div><div class=\"line\">322</div><div class=\"line\">323</div><div class=\"line\">324</div><div class=\"line\">325</div><div class=\"line\">326</div><div class=\"line\">327</div><div class=\"line\">328</div><div class=\"line\">329</div><div class=\"line\">330</div><div class=\"line\">331</div><div class=\"line\">332</div><div class=\"line\">333</div><div class=\"line\">334</div><div class=\"line\">335</div><div class=\"line\">336</div><div class=\"line\">337</div><div class=\"line\">338</div><div class=\"line\">339</div><div class=\"line\">340</div><div class=\"line\">341</div><div class=\"line\">342</div><div class=\"line\">343</div><div class=\"line\">344</div><div class=\"line\">345</div><div class=\"line\">346</div><div class=\"line\">347</div><div class=\"line\">348</div><div class=\"line\">349</div><div class=\"line\">350</div><div class=\"line\">351</div><div class=\"line\">352</div><div class=\"line\">353</div><div class=\"line\">354</div><div class=\"line\">355</div><div class=\"line\">356</div><div class=\"line\">357</div><div class=\"line\">358</div><div class=\"line\">359</div><div class=\"line\">360</div><div class=\"line\">361</div><div class=\"line\">362</div><div class=\"line\">363</div><div class=\"line\">364</div><div class=\"line\">365</div><div class=\"line\">366</div><div class=\"line\">367</div><div class=\"line\">368</div><div class=\"line\">369</div><div class=\"line\">370</div><div class=\"line\">371</div><div class=\"line\">372</div><div class=\"line\">373</div><div class=\"line\">374</div><div class=\"line\">375</div><div class=\"line\">376</div><div class=\"line\">377</div><div class=\"line\">378</div><div class=\"line\">379</div><div class=\"line\">380</div><div class=\"line\">381</div></pre></td><td class=\"code\"><pre><div class=\"line\">##################### Elasticsearch Configuration Example #####################</div><div class=\"line\"></div><div class=\"line\">＃此文件包含各种配置设置的概述，</div><div class=\"line\">＃针对操作人员。应用程序开发人员应该</div><div class=\"line\">＃在咨询&lt;http://elasticsearch.org/guide&gt;指南。</div><div class=\"line\">#</div><div class=\"line\">＃安装过程被覆盖在</div><div class=\"line\">＃&lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup.html&gt;。</div><div class=\"line\">#</div><div class=\"line\">＃Elasticsearch附带了大多数设置合理的默认值，</div><div class=\"line\">＃所以你可以尝试使用它而不用修改。</div><div class=\"line\">#</div><div class=\"line\">＃大多数时候，这些默认值是蛮好的运行生产</div><div class=\"line\">＃集群。如果你正在微调群集，或者想知道的某些配置选项＃效果，请_DO ask_上</div><div class=\"line\">＃邮件列表或IRC频道[http://elasticsearch.org/community。</div><div class=\"line\">#</div><div class=\"line\">＃配置中的任何元素都可以用环境变量替换</div><div class=\"line\">＃通过将它们放置在$ &#123;...&#125;符号。 例如：</div><div class=\"line\">#</div><div class=\"line\">#node.rack: $&#123;RACK_ENV_VAR&#125;</div><div class=\"line\"></div><div class=\"line\">＃有关支持的格式和配置文件信息语法，请参阅</div><div class=\"line\">＃&lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup-configuration.html&gt;</div><div class=\"line\"></div><div class=\"line\">################################### Cluster 集群###################################</div><div class=\"line\"></div><div class=\"line\">＃集群名称标识群集的自动发现。如果你在同一个网络上的正在运行多个群集，请确保您使用的是唯一的名称。</div><div class=\"line\">＃</div><div class=\"line\">＃cluster.name：elasticsearch</div><div class=\"line\"></div><div class=\"line\">#################################### Node 节点#####################################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃节点名称是在启动时动态生成的，但你也可以手动配置它们。你可以给这个节点起一个特定的名称：</div><div class=\"line\">＃</div><div class=\"line\">#node.name: &quot;Franz Kafka&quot;</div><div class=\"line\"></div><div class=\"line\">＃每个节点可以被配置为允许或拒绝称为集群主节点，</div><div class=\"line\">＃和允许或拒绝来存储数据。</div><div class=\"line\">＃</div><div class=\"line\">＃允许此节点可以作为主节点（默认启用）：</div><div class=\"line\">＃</div><div class=\"line\">#node.master: true</div><div class=\"line\">#</div><div class=\"line\"># 允许此节点可以用来存储数据（默认启用）：</div><div class=\"line\">#</div><div class=\"line\">#node.data: true</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃你可以利用这些设置，以设计高级集群拓扑。</div><div class=\"line\">＃</div><div class=\"line\">＃1，你想这个节点永远不会成为一个主节点，只保存数据。这将是群集的“主力”。</div><div class=\"line\">＃</div><div class=\"line\">＃</div><div class=\"line\">#node.master: false</div><div class=\"line\">#node.data: true</div><div class=\"line\">#</div><div class=\"line\">＃2，你要这个节点只能作为主：不存储任何数据和有免费的资源。这将是群集的“协调员”。</div><div class=\"line\">＃</div><div class=\"line\">＃</div><div class=\"line\">#node.master: true</div><div class=\"line\">#node.data: false</div><div class=\"line\">#</div><div class=\"line\">＃3，你希望这个节点是不是主数据节点，但可以充当“搜索负载平衡器”（取从节点的数据，聚集结果等）</div><div class=\"line\">＃</div><div class=\"line\">#node.master: false</div><div class=\"line\">#node.data: false</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃使用群集健康状况API[http://localhost:9200/_cluster/health]，</div><div class=\"line\">＃节点信息API[http://localhost:9200/_nodes]或GUI工具</div><div class=\"line\">＃如&lt;http://www.elasticsearch.org/overview/marvel/&gt;</div><div class=\"line\">＃&lt;http://github.com/karmi/elasticsearch-paramedic&gt;</div><div class=\"line\">＃&lt;http://github.com/lukas-vlcek/bigdesk&gt;和</div><div class=\"line\">＃&lt;http://mobz.github.com/elasticsearch-head&gt;检查群集状态。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃一个节点可以有与之关联的通用属性，可用于定制分片分配过滤，或分配意识。</div><div class=\"line\">＃</div><div class=\"line\">＃属性是一个简单的键值对，类似node.key：值，下面是一个例子：</div><div class=\"line\">＃</div><div class=\"line\">#node.rack: rack314</div><div class=\"line\"></div><div class=\"line\">＃默认情况下，多个节点被允许从相同的安装位置</div><div class=\"line\"># 如果要禁用的话，设置如下：</div><div class=\"line\">#node.max_local_storage_nodes: 1</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#################################### Index 索引####################################</div><div class=\"line\"></div><div class=\"line\">#</div><div class=\"line\">＃您可以设置一些选项（如分片/副本选项，映射或分析器的定义，事务日志设置...）对全局参数，在这个文件中。</div><div class=\"line\">#</div><div class=\"line\"># Note, that it makes more sense to configure index settings specifically for</div><div class=\"line\"># a certain index, either when creating it or by using the index templates API.</div><div class=\"line\">#</div><div class=\"line\">＃请注意，它更有意义专门配置索引设置</div><div class=\"line\">＃某个具体的索引，创造它或使用该索引模板API。</div><div class=\"line\"># See &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/index-modules.html&gt; and</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/indices-create-index.html&gt;</div><div class=\"line\"># for more information.</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 设置一个索引的分片（副本）数量（默认 5）</div><div class=\"line\">#</div><div class=\"line\">#index.number_of_shards: 5</div><div class=\"line\"></div><div class=\"line\">＃设置索引（默认值为1）的副本（额外副本）数量：</div><div class=\"line\">＃</div><div class=\"line\">#index.number_of_replicas: 1</div><div class=\"line\"></div><div class=\"line\"># Note, that for development on a local machine, with small indices, it usually</div><div class=\"line\"># makes sense to &quot;disable&quot; the distributed features:</div><div class=\"line\">#</div><div class=\"line\">＃注意，对于在本地机器，它通常比较小的值。禁用分布式特点是很有必要的</div><div class=\"line\">＃</div><div class=\"line\">#index.number_of_shards: 1</div><div class=\"line\">#index.number_of_replicas: 0</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃这些设置直接影响索引和搜索操作的性能</div><div class=\"line\">＃在集群中。假设你有足够多的机器来保存分片及</div><div class=\"line\">＃副本，经验法则是：</div><div class=\"line\">#</div><div class=\"line\"># 1. 更多的分片能提高索引效率，一个大的索引允许存储在不同的服务器上</div><div class=\"line\"># 2. 更多的副本能够提高搜索效率，并且能够增强系统的可用性</div><div class=\"line\">#</div><div class=\"line\">#  &quot;number_of_shards&quot; 对于一个索引不能动态修改设置一次.</div><div class=\"line\">#</div><div class=\"line\"># T &quot;number_of_replicas&quot; 可以增加或者减少在任何时候，通过索引更新或者api操作</div><div class=\"line\">#</div><div class=\"line\"># Elasticsearch takes care about load balancing, relocating, gathering the</div><div class=\"line\"># results from nodes, etc. Experiment with different settings to fine-tune</div><div class=\"line\"># your setup.</div><div class=\"line\"></div><div class=\"line\">＃Elasticsearch需要关心负载均衡，搬迁，从节点收集结果，等。</div><div class=\"line\"># 你可以通过不断的微调进行设置</div><div class=\"line\"></div><div class=\"line\">＃使用索引状态API（&lt;http://localhost:9200/A/_status&gt;）检查</div><div class=\"line\">＃索引状态。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#################################### Paths ####################################</div><div class=\"line\"></div><div class=\"line\"># 路径包含目录配置（此文件并logging.yml）：</div><div class=\"line\">#path.conf: /path/to/conf</div><div class=\"line\"></div><div class=\"line\"># 索引数据存储路径配置</div><div class=\"line\">#path.data: /path/to/data</div><div class=\"line\">#</div><div class=\"line\">＃可以任选地包括一个以上的位置，方便扩展和使用。 例如：</div><div class=\"line\">#</div><div class=\"line\">#path.data: /path/to/data1,/path/to/data2</div><div class=\"line\"></div><div class=\"line\"># 临时文件路径：</div><div class=\"line\">#</div><div class=\"line\">#path.work: /path/to/work</div><div class=\"line\"></div><div class=\"line\"># 日志文件路径:</div><div class=\"line\">#</div><div class=\"line\">#path.logs: /path/to/logs</div><div class=\"line\"></div><div class=\"line\"># 插件安装目录</div><div class=\"line\">#</div><div class=\"line\">#path.plugins: /path/to/plugins</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#################################### Plugin ###################################</div><div class=\"line\"></div><div class=\"line\"># 如果这里列出的插件没有安装用于当前节点，该节点将无法启动。</div><div class=\"line\">#</div><div class=\"line\">#plugin.mandatory: mapper-attachments,lang-groovy</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">################################### Memory ####################################</div><div class=\"line\"></div><div class=\"line\">＃Elasticsearch表现不佳时，JVM启动交换：你应该确保它永远不会_交换。</div><div class=\"line\">#</div><div class=\"line\"># 将此属性设置为true锁定内存：</div><div class=\"line\">#</div><div class=\"line\">#bootstrap.mlockall: true</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 确保ES_MIN_MEM和ES_MAX_MEM环境变量设置</div><div class=\"line\">＃为相同的值，并且该机器有足够的内存来分配</div><div class=\"line\">＃为Elasticsearch，留出足够的内存为操作系统本身。</div><div class=\"line\">＃</div><div class=\"line\">#</div><div class=\"line\"># You should also make sure that the Elasticsearch process is allowed to lock</div><div class=\"line\"># the memory, eg. by using `ulimit -l unlimited`.</div><div class=\"line\"># 你还应该确保该Elasticsearch允许进程锁定内存</div><div class=\"line\">＃例如。通过使用`ulimit -l unlimited`。</div><div class=\"line\"></div><div class=\"line\">############################## Network And HTTP ###############################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃Elasticsearch，默认情况下，本身绑定到0.0.0.0地址，并监听</div><div class=\"line\">＃端口[9200-9300] HTTP流量和端口[9300-9400]节点到节点</div><div class=\"line\">＃沟通。（范围意味着，如果端口忙，它会自动将</div><div class=\"line\">＃尝试下口）。</div><div class=\"line\"></div><div class=\"line\"># 设置绑定专用地址（IPv4或IPv6）：</div><div class=\"line\">#network.bind_host: 192.168.0.1</div><div class=\"line\"></div><div class=\"line\">＃设置其他节点将使用与该节点通信的地址。否则</div><div class=\"line\">＃，它会自动的产生。它必须指向一个实际的IP地址。</div><div class=\"line\">#</div><div class=\"line\">#network.publish_host: 192.168.0.1</div><div class=\"line\"></div><div class=\"line\"># 同时设置“bind_host&apos;和&apos;publish_host”：</div><div class=\"line\">#</div><div class=\"line\">#network.host: 192.168.0.1</div><div class=\"line\"></div><div class=\"line\"># 设置一个自定义的节点间通讯端口，（默认为 9300）</div><div class=\"line\">#transport.tcp.port: 9300</div><div class=\"line\"></div><div class=\"line\"># 启用节点间通讯压缩</div><div class=\"line\">#</div><div class=\"line\">#transport.tcp.compress: true</div><div class=\"line\"></div><div class=\"line\"># 设置自定义端口侦听HTTP流量：</div><div class=\"line\">#</div><div class=\"line\">#http.port: 9200</div><div class=\"line\"></div><div class=\"line\"># 设置自定义允许的内容长度：</div><div class=\"line\">#</div><div class=\"line\">#http.max_content_length: 100mb</div><div class=\"line\"></div><div class=\"line\"># 完全禁用HTTP：</div><div class=\"line\">#</div><div class=\"line\">#http.enabled: false</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">################################### Gateway ###################################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃网关允许持收集集群之间的群集状态</div><div class=\"line\">＃集群中每个状态改变（例如添加一个索引），都将会存储</div><div class=\"line\">＃在网关，并且当集群首次启动时，</div><div class=\"line\">＃它会从网关读出其状态。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃有几种类型的网关实现的。欲了解更多信息，请参阅</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-gateway.html&gt;.</div><div class=\"line\"></div><div class=\"line\">＃默认网关类型为“本地”网关（推荐）：</div><div class=\"line\">#</div><div class=\"line\">#gateway.type: local</div><div class=\"line\"></div><div class=\"line\"># 设置当集群崩溃时，如何重新启动并恢复进程（使用共享网关时，尽可能多的使用本地数据）</div><div class=\"line\"></div><div class=\"line\"># 允许恢复后，在一个集群中有N个节点：</div><div class=\"line\">#</div><div class=\"line\">#gateway.recover_after_nodes: 1</div><div class=\"line\"></div><div class=\"line\">＃设置超时时间，在启动恢复过程中，前面设置的N个节点全部重启（接受时间值）：</div><div class=\"line\">#</div><div class=\"line\"></div><div class=\"line\">#gateway.recover_after_time: 5m</div><div class=\"line\"></div><div class=\"line\">＃设置在一个句群众预计的节点数</div><div class=\"line\">#一旦这些N个节点全部启用（满足recover_after_nodes），立即开始恢复过程（无需等待恢复时间后到期）：</div><div class=\"line\">#</div><div class=\"line\">#gateway.expected_nodes: 2</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">############################# Recovery Throttling 恢复节流 #############################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃这些设置可以控制碎片分配的过程，在节点恢复期间、副本定位、重新平衡，或添加和删除节点时</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#</div><div class=\"line\"># 设置一个节点上同时恢复数量</div><div class=\"line\"># 1. 初步恢复期间</div><div class=\"line\">#</div><div class=\"line\">#cluster.routing.allocation.node_initial_primaries_recoveries: 4</div><div class=\"line\">#</div><div class=\"line\"># 2. 在添加/删除节点，再平衡期间</div><div class=\"line\">#</div><div class=\"line\">#cluster.routing.allocation.node_concurrent_recoveries: 2</div><div class=\"line\"></div><div class=\"line\"># 设置一个恢复时的吞吐量值（如100MB，默认20MB）</div><div class=\"line\">#</div><div class=\"line\">#indices.recovery.max_bytes_per_sec: 20mb</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 设置一个并发流数量限制，在同级别的分片恢复时</div><div class=\"line\">#</div><div class=\"line\">#indices.recovery.concurrent_streams: 5</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">################################## Discovery 发现##################################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃发现基础设施，确保节点可以在群集内找到和主节点的选举。是默认是通过多播方式来进行发现。</div><div class=\"line\"></div><div class=\"line\"># 设置一个节点确保能在集群内发现N个其他合格的节点能成为主节点。</div><div class=\"line\"></div><div class=\"line\">#discovery.zen.minimum_master_nodes: 1</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 设置一个过期时间，在通过ping发现其他节点时</div><div class=\"line\"># 在一个较差的网络环境中设置一个较长的值，可以最大限度的减少报错</div><div class=\"line\"></div><div class=\"line\">#discovery.zen.ping.timeout: 3s</div><div class=\"line\"></div><div class=\"line\"># 更多的信息，请看</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-zen.html&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃单播发现允许明确地控制哪些节点将被用于发现群集。它可以在多播不存在，或限制集群通信时使用。</div><div class=\"line\">#</div><div class=\"line\"># 1. 多播发现（默认启用）</div><div class=\"line\">#</div><div class=\"line\">#discovery.zen.ping.multicast.enabled: false</div><div class=\"line\">#</div><div class=\"line\"># 2. 配置一个初始清单在集群的主节点上，为了发现一个刚启用的节点</div><div class=\"line\">#</div><div class=\"line\">#discovery.zen.ping.unicast.hosts: [&quot;host1&quot;, &quot;host2:port&quot;]</div><div class=\"line\"></div><div class=\"line\"># 为了发现 ，EC2允许使用AWS EC2 API</div><div class=\"line\"># 你必须安装云AWS插件启用EC2发现。</div><div class=\"line\">#</div><div class=\"line\"># 更多信息请查看</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-ec2.html&gt;</div><div class=\"line\">#</div><div class=\"line\"># See &lt;http://elasticsearch.org/tutorials/elasticsearch-on-ec2/&gt;</div><div class=\"line\"># 一步一步的教程</div><div class=\"line\"></div><div class=\"line\"># 为了发现 ，GCE发现允许使用谷歌Compute Engine的API</div><div class=\"line\">#</div><div class=\"line\"># 你必须安装云GCE GCE插件启用的发现。</div><div class=\"line\">#</div><div class=\"line\"># For more information, see &lt;https://github.com/elasticsearch/elasticsearch-cloud-gce&gt;.</div><div class=\"line\"></div><div class=\"line\"># Azure的发现允许以执行发现使用Azure的API。</div><div class=\"line\">#</div><div class=\"line\"># 你必须安装云cloud-azure插件启用的发现。</div><div class=\"line\"># For more information, see &lt;https://github.com/elasticsearch/elasticsearch-cloud-azure&gt;.</div><div class=\"line\"></div><div class=\"line\">################################## Slow Log ##################################</div><div class=\"line\"></div><div class=\"line\"># 分片级查询并会的对应等级的日志</div><div class=\"line\"></div><div class=\"line\">#index.search.slowlog.threshold.query.warn: 10s</div><div class=\"line\">#index.search.slowlog.threshold.query.info: 5s</div><div class=\"line\">#index.search.slowlog.threshold.query.debug: 2s</div><div class=\"line\">#index.search.slowlog.threshold.query.trace: 500ms</div><div class=\"line\"></div><div class=\"line\">#index.search.slowlog.threshold.fetch.warn: 1s</div><div class=\"line\">#index.search.slowlog.threshold.fetch.info: 800ms</div><div class=\"line\">#index.search.slowlog.threshold.fetch.debug: 500ms</div><div class=\"line\">#index.search.slowlog.threshold.fetch.trace: 200ms</div><div class=\"line\"></div><div class=\"line\">#index.indexing.slowlog.threshold.index.warn: 10s</div><div class=\"line\">#index.indexing.slowlog.threshold.index.info: 5s</div><div class=\"line\">#index.indexing.slowlog.threshold.index.debug: 2s</div><div class=\"line\">#index.indexing.slowlog.threshold.index.trace: 500ms</div><div class=\"line\"></div><div class=\"line\">################################## GC Logging ################################</div><div class=\"line\"></div><div class=\"line\">#monitor.jvm.gc.young.warn: 1000ms</div><div class=\"line\">#monitor.jvm.gc.young.info: 700ms</div><div class=\"line\">#monitor.jvm.gc.young.debug: 400ms</div><div class=\"line\"></div><div class=\"line\">#monitor.jvm.gc.old.warn: 10s</div><div class=\"line\">#monitor.jvm.gc.old.info: 5s</div><div class=\"line\">#monitor.jvm.gc.old.debug: 2s</div><div class=\"line\"></div><div class=\"line\">################################## Security ################################</div><div class=\"line\"></div><div class=\"line\"># Uncomment if you want to enable JSONP as a valid return transport on the</div><div class=\"line\"># http server. With this enabled, it may pose a security risk, so disabling</div><div class=\"line\"># it unless you need it is recommended (it is disabled by default).</div><div class=\"line\"></div><div class=\"line\">＃不推荐，如果要启用JSONP作为HTTP服务器上的返回。</div><div class=\"line\">#启用此功能，它可能会带来安全风险，因此禁用它，除非你需要的建议（它被默认禁用）。</div><div class=\"line\"></div><div class=\"line\">#http.jsonp.enable: true</div></pre></td></tr></table></figure></p>\n<p>logging.yml</p>\n<blockquote>\n<p>定义多少信息写入系统日志、定义日志文件，并定期创建新文件</p>\n</blockquote>\n<h3 id=\"管理\"><a href=\"#管理\" class=\"headerlink\" title=\"管理\"></a>管理</h3><p>启动Elasticsearch<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/elasticsearch/bin/elasticsearch  -d</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>-d 表示将进程放入后台运行</p>\n</blockquote>\n<p>或者通过\u0004nohup命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># nohup /usr/local/elasticsearch/bin/elasticsearch &gt; nohup</div></pre></td></tr></table></figure></p>\n<p>将elasticsearch设置成开机自启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># echo &quot;nohup /usr/local/elasticsearch/bin/elasticsearch &gt; nohup&quot; &gt; /etc/rc.local</div></pre></td></tr></table></figure></p>\n<p>确认elasticsearch的9200端口已监听，说明elasticsearch已成功运行</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># netstat -anp |grep :9200</div><div class=\"line\">tcp        0      0 :::9200                     :::*                        LISTEN      3362/java</div></pre></td></tr></table></figure>\n<p>如何关闭elasticsearch</p>\n<ul>\n<li>方法一：如果节点与控制台相连并且当前elasticsearch是使用-f选项运行，则只需要按下Ctrl+C组合键即可</li>\n<li>方法二：通过发送TERM信号来终止服务器进程 kill -9 进程ID</li>\n<li>方法三：使用REST API</li>\n</ul>\n<p>关闭整个集群<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPOST http://localhost:9200/_cluster/nodes/_shutdown</div></pre></td></tr></table></figure></p>\n<p>关闭单个节点<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPOST  http://127.0.0.1:9200/_cluster/nodes/2ens0yuEQ12G6ct1UDpihQ/_shutdown</div></pre></td></tr></table></figure></p>\n<p>2ens0yuEQ12G6ct1UDpihQ ，为要关闭的节点标志符</p>\n<p>查看节点标志符，可以从elasticsearch日志中或者通过REST API中获得<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl http://localhost:9200/_nodes/?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</div><div class=\"line\">  &quot;nodes&quot; : &#123;</div><div class=\"line\">    &quot;13QfvIdATEurGAhVAlO6tQ&quot; : &#123;</div><div class=\"line\">      &quot;name&quot; : &quot;Edwin Jarvis&quot;,</div><div class=\"line\">      ...</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>13QfvIdATEurGAhVAlO6tQ,即为节点标志符</p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl http://localhost:9200</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;status&quot; : 200,</div><div class=\"line\">  &quot;name&quot; : &quot;Destroyer of Demons&quot;,</div><div class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</div><div class=\"line\">  &quot;version&quot; : &#123;</div><div class=\"line\">    &quot;number&quot; : &quot;1.7.0&quot;,</div><div class=\"line\">    &quot;build_hash&quot; : &quot;929b9739cae115e73c346cb5f9a6f24ba735a743&quot;,</div><div class=\"line\">    &quot;build_timestamp&quot; : &quot;2015-07-16T14:31:07Z&quot;,</div><div class=\"line\">    &quot;build_snapshot&quot; : false,</div><div class=\"line\">    &quot;lucene_version&quot; : &quot;4.10.4&quot;</div><div class=\"line\">  &#125;,</div><div class=\"line\">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>查看elasticsearch服务器当前运行状况<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl http://localhost:9200/_cluster/health?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</div><div class=\"line\">  &quot;status&quot; : &quot;green&quot;,</div><div class=\"line\">  &quot;timed_out&quot; : false,</div><div class=\"line\">  &quot;number_of_nodes&quot; : 1,</div><div class=\"line\">  &quot;number_of_data_nodes&quot; : 1,</div><div class=\"line\">  &quot;active_primary_shards&quot; : 0,</div><div class=\"line\">  &quot;active_shards&quot; : 0,</div><div class=\"line\">  &quot;relocating_shards&quot; : 0,</div><div class=\"line\">  &quot;initializing_shards&quot; : 0,</div><div class=\"line\">  &quot;unassigned_shards&quot; : 0,</div><div class=\"line\">  &quot;delayed_unassigned_shards&quot; : 0,</div><div class=\"line\">  &quot;number_of_pending_tasks&quot; : 0,</div><div class=\"line\">  &quot;number_of_in_flight_fetch&quot; : 0</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"使用（基于REST-API数据操作）\"><a href=\"#使用（基于REST-API数据操作）\" class=\"headerlink\" title=\"使用（基于REST API数据操作）\"></a>使用（基于REST API数据操作）</h2><h3 id=\"REST\"><a href=\"#REST\" class=\"headerlink\" title=\"REST\"></a>REST</h3><p>REST 定义了一组体系架构原则，您可以根据这些原则设计以系统资源为中心的 Web 服务，包括使用不同语言编写的客户端如何通过 HTTP 处理和传输资源状态。 它用简洁易行的方式向HTTP中的条目暴露CRUD（Create、Replace、Update、Delete，创建、替换、更新、删除）的应用功能。</p>\n<h3 id=\"创建文档\"><a href=\"#创建文档\" class=\"headerlink\" title=\"创建文档\"></a>创建文档</h3><p>示例：创建一个文档用来存储一篇blog，内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  &quot;title&quot;:&quot;my first article title&quot;,</div><div class=\"line\">  &quot;content&quot;:&quot;this is article content&quot;,</div><div class=\"line\">  &quot;date&quot;:&quot;2016-10-05&quot;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>操作：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPUT  http://localhost:9200/blog/article/1 -d &apos;&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>\n<p>返回结果如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;&quot;_index&quot;:&quot;blog&quot;,&quot;_type&quot;:&quot;article&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:1,&quot;created&quot;:true&#125;</div></pre></td></tr></table></figure></p>\n<p>返回了操作结果信息，并显示新文档的存储位置。并且包含文档的唯一标识符以及当前版本信息。</p>\n<h3 id=\"检索文档\"><a href=\"#检索文档\" class=\"headerlink\" title=\"检索文档\"></a>检索文档</h3><p>按照REST风格，我们想要查看刚才创建的文档。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XGET  http://localhost:9200/blog/article/1</div></pre></td></tr></table></figure></p>\n<p>结果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">curl -XGET  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;_version&quot; : 1,</div><div class=\"line\">  &quot;found&quot; : true,</div><div class=\"line\">  &quot;_source&quot;:&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"更新文档\"><a href=\"#更新文档\" class=\"headerlink\" title=\"更新文档\"></a>更新文档</h3><p>Elasticsearch中更新索引中的文档是非常复杂的工作。必须先提取文档、从_source字段获得数据、移除旧文档、应用变更，作为新文档创建索引。</p>\n<p>示例，更改之前创建的blog，并增加author字段<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPOST  http://localhost:9200/blog/article/1 -d &apos;&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;,&quot;author&quot;:&quot;zhimiao&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># &#123;&quot;_index&quot;:&quot;blog&quot;,&quot;_type&quot;:&quot;article&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:3,&quot;created&quot;:false&#125;</div></pre></td></tr></table></figure></p>\n<p>查看是否更新成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XGET  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;_version&quot; : 4,</div><div class=\"line\">  &quot;found&quot; : true,</div><div class=\"line\">  &quot;_source&quot;:&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;,&quot;author&quot;:&quot;zhimiao&quot;&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"删除文档\"><a href=\"#删除文档\" class=\"headerlink\" title=\"删除文档\"></a>删除文档</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XDELETE  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;found&quot; : true,</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;_version&quot; : 7</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>查看是否已删除<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XGET  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;found&quot; : false</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n","excerpt":"<p>ElasticSearch是由Shay Banon发起的一个开源搜索服务器项目。由于其分布式特性和实时搜索能力，成为当前搜索和数据分析解决方案领域的重要成员。</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161006/ElasticSearch.png\" alt=\"ElasticSearch\"></p>","more":"<h2 id=\"基本概念\"><a href=\"#基本概念\" class=\"headerlink\" title=\"基本概念\"></a>基本概念</h2><p>索引</p>\n<blockquote>\n<p>索引（index）是ElasticSearch存放数据的一种逻辑结构。类比关系型数据库中的数据表。</p>\n</blockquote>\n<p>文档</p>\n<blockquote>\n<p>文档（document）是ElasticSearch中存储的主要实体。每个ElasticSearch文档类比关系型数据库中数据表的没一行数据。<br>文档由字段（行数据的列）组成，一个文档由多个字段组成，并且ElasticSearch允许一个字段重复出现多次，该类型字段被称为多只字段。每个字段对应一种类型（字符串型、数值型、日期型等），并且ElasticSearch可以自动确定字段类型。不同于关系型数据库，ElasticSearch的文档结构可以是不固定的。即不同的文档可以有不同的字段集合。</p>\n</blockquote>\n<p>文档类型</p>\n<blockquote>\n<p>ElasticSearch中，一个索引可以存储许多不同用途的对象。按照不同的用途我们可以将文档划分成不同的类型加以区分。</p>\n</blockquote>\n<p>节点和集群</p>\n<blockquote>\n<p>ElasticSearch既可以作为一个独立搜索服务器工作，也支持多台一起协作进行运行，构成一个集群（cluster），其中的每个服务器被称为节点（node）。ElasticSearch可以通过索引分片,将海量的数据进行分割并分布到不同的节点，来实现更强的可用性和更高的性能。</p>\n</blockquote>\n<p>分片</p>\n<blockquote>\n<p>对于存储大规模的文档，ElasticSearch会将数据进行切分，每部分切成一个单独的Apache Lucene索引，称为分片（shared）。每个分片可以存储在集群的不同的节点上，当一个查询需要用到多个分片时，ElasticSearch会将请求发送至多个分片，之后结果进行合并。</p>\n</blockquote>\n<p>副本</p>\n<blockquote>\n<p>分片副本是对原始分片的一个拷贝，每个主分片可以有零个或者多个副分片。当主分片丢失时，副分片就会被提升为主分片。启用分片副本功能，可以提高查询的吞吐或实现系统的高可用性。</p>\n</blockquote>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h3 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h3><p>JDK6+</p>\n<p>JDK的安装方式比较简单，只需将下载回来的程序包解压到相应的目录即可。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://download.oracle.com/otn-pub/java/jdk/8u101-b13/jdk-8u101-linux-x64.tar.gz</div><div class=\"line\">mkdir /usr/local/java</div><div class=\"line\">tar -zxf jdk-8u101-linux-x64.tar.gz -C /usr/local/java/</div></pre></td></tr></table></figure></p>\n<p>设置JDK的环境变量，如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># tail -3 ~/.bash_profile</div><div class=\"line\">export JAVA_HOME=/usr/local/java/jdk1.8.0_101</div><div class=\"line\">export PATH=$PATH:$JAVA_HOME/bin</div><div class=\"line\">exportCLASSPATH=.:$JAVA_HOME/lib/tools.jar:$JAVA_HOME/lib/dt.jar:$CLASSPATH</div></pre></td></tr></table></figure></p>\n<p>重新加载环境变量<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># source .bash_profile</div></pre></td></tr></table></figure></p>\n<p>在Shell提示符中执行java –version命令，显示如下结果，说明安装成功：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># java -version</div><div class=\"line\">java version &quot;1.8.0_45&quot;</div><div class=\"line\">Java(TM) SE Runtime Environment (build 1.8.0_45-b14)</div><div class=\"line\">Java HotSpot(TM) 64-Bit Server VM (build 25.45-b02,mixed mode)</div></pre></td></tr></table></figure></p>\n<h3 id=\"安装Elasticsearch\"><a href=\"#安装Elasticsearch\" class=\"headerlink\" title=\"安装Elasticsearch\"></a>安装Elasticsearch</h3><p>下载Elasticsearch后，解压到对应的目录就完成Elasticsearch的安装。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.7.0.zip</div><div class=\"line\"># unzip elasticsearch-1.7.0.zip</div><div class=\"line\"># mv elasticsearch-1.7.0 /usr/local/elasticsearch</div></pre></td></tr></table></figure></p>\n<h3 id=\"目录结构\"><a href=\"#目录结构\" class=\"headerlink\" title=\"目录结构\"></a>目录结构</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">elasticsearch/</div><div class=\"line\">├── bin</div><div class=\"line\">│   ...#运行elasticsearch和进行插件管理所需的脚本</div><div class=\"line\">├── config</div><div class=\"line\">│   ...#elasticsearch配置文件所在目录</div><div class=\"line\">├── data</div><div class=\"line\">│   ...#存储elasticsearch用到的数据</div><div class=\"line\">├── lib</div><div class=\"line\">│   ...#elasticsearch运行中用到的库</div><div class=\"line\">├── LICENSE.txt</div><div class=\"line\">├── logs</div><div class=\"line\">│   ...#存储elasticsearch运行中产生的事件信息和错误信息</div><div class=\"line\">├── nohup</div><div class=\"line\">├── NOTICE.txt</div><div class=\"line\">└── README.textile</div><div class=\"line\"></div><div class=\"line\">10 directories, 60 files</div></pre></td></tr></table></figure>\n<h3 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h3><p>所有的配置文件都位于config目录下。该目录下包含两个文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">├── config</div><div class=\"line\">│   ├── elasticsearch.yml</div><div class=\"line\">│   └── logging.yml</div></pre></td></tr></table></figure></p>\n<p>elasticsearch.yml</p>\n<blockquote>\n<p>负责设置服务器的默认配置。<br>比较重要的两个值cluster.name 和 node.name.</p>\n<ul>\n<li>cluster.name,保存的是集群名称。通过集群名称可以区分不同的集群。配置具有相同名称的节点将尝试组成一个集群。</li>\n<li>node.name，节点名称。我们也可以不指定该名称，elasticsearch会自动为节点选择一个唯一名称。但每次启动时这个唯一名称会发生改变。</li>\n</ul>\n</blockquote>\n<p>其他配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div><div class=\"line\">311</div><div class=\"line\">312</div><div class=\"line\">313</div><div class=\"line\">314</div><div class=\"line\">315</div><div class=\"line\">316</div><div class=\"line\">317</div><div class=\"line\">318</div><div class=\"line\">319</div><div class=\"line\">320</div><div class=\"line\">321</div><div class=\"line\">322</div><div class=\"line\">323</div><div class=\"line\">324</div><div class=\"line\">325</div><div class=\"line\">326</div><div class=\"line\">327</div><div class=\"line\">328</div><div class=\"line\">329</div><div class=\"line\">330</div><div class=\"line\">331</div><div class=\"line\">332</div><div class=\"line\">333</div><div class=\"line\">334</div><div class=\"line\">335</div><div class=\"line\">336</div><div class=\"line\">337</div><div class=\"line\">338</div><div class=\"line\">339</div><div class=\"line\">340</div><div class=\"line\">341</div><div class=\"line\">342</div><div class=\"line\">343</div><div class=\"line\">344</div><div class=\"line\">345</div><div class=\"line\">346</div><div class=\"line\">347</div><div class=\"line\">348</div><div class=\"line\">349</div><div class=\"line\">350</div><div class=\"line\">351</div><div class=\"line\">352</div><div class=\"line\">353</div><div class=\"line\">354</div><div class=\"line\">355</div><div class=\"line\">356</div><div class=\"line\">357</div><div class=\"line\">358</div><div class=\"line\">359</div><div class=\"line\">360</div><div class=\"line\">361</div><div class=\"line\">362</div><div class=\"line\">363</div><div class=\"line\">364</div><div class=\"line\">365</div><div class=\"line\">366</div><div class=\"line\">367</div><div class=\"line\">368</div><div class=\"line\">369</div><div class=\"line\">370</div><div class=\"line\">371</div><div class=\"line\">372</div><div class=\"line\">373</div><div class=\"line\">374</div><div class=\"line\">375</div><div class=\"line\">376</div><div class=\"line\">377</div><div class=\"line\">378</div><div class=\"line\">379</div><div class=\"line\">380</div><div class=\"line\">381</div></pre></td><td class=\"code\"><pre><div class=\"line\">##################### Elasticsearch Configuration Example #####################</div><div class=\"line\"></div><div class=\"line\">＃此文件包含各种配置设置的概述，</div><div class=\"line\">＃针对操作人员。应用程序开发人员应该</div><div class=\"line\">＃在咨询&lt;http://elasticsearch.org/guide&gt;指南。</div><div class=\"line\">#</div><div class=\"line\">＃安装过程被覆盖在</div><div class=\"line\">＃&lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup.html&gt;。</div><div class=\"line\">#</div><div class=\"line\">＃Elasticsearch附带了大多数设置合理的默认值，</div><div class=\"line\">＃所以你可以尝试使用它而不用修改。</div><div class=\"line\">#</div><div class=\"line\">＃大多数时候，这些默认值是蛮好的运行生产</div><div class=\"line\">＃集群。如果你正在微调群集，或者想知道的某些配置选项＃效果，请_DO ask_上</div><div class=\"line\">＃邮件列表或IRC频道[http://elasticsearch.org/community。</div><div class=\"line\">#</div><div class=\"line\">＃配置中的任何元素都可以用环境变量替换</div><div class=\"line\">＃通过将它们放置在$ &#123;...&#125;符号。 例如：</div><div class=\"line\">#</div><div class=\"line\">#node.rack: $&#123;RACK_ENV_VAR&#125;</div><div class=\"line\"></div><div class=\"line\">＃有关支持的格式和配置文件信息语法，请参阅</div><div class=\"line\">＃&lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/setup-configuration.html&gt;</div><div class=\"line\"></div><div class=\"line\">################################### Cluster 集群###################################</div><div class=\"line\"></div><div class=\"line\">＃集群名称标识群集的自动发现。如果你在同一个网络上的正在运行多个群集，请确保您使用的是唯一的名称。</div><div class=\"line\">＃</div><div class=\"line\">＃cluster.name：elasticsearch</div><div class=\"line\"></div><div class=\"line\">#################################### Node 节点#####################################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃节点名称是在启动时动态生成的，但你也可以手动配置它们。你可以给这个节点起一个特定的名称：</div><div class=\"line\">＃</div><div class=\"line\">#node.name: &quot;Franz Kafka&quot;</div><div class=\"line\"></div><div class=\"line\">＃每个节点可以被配置为允许或拒绝称为集群主节点，</div><div class=\"line\">＃和允许或拒绝来存储数据。</div><div class=\"line\">＃</div><div class=\"line\">＃允许此节点可以作为主节点（默认启用）：</div><div class=\"line\">＃</div><div class=\"line\">#node.master: true</div><div class=\"line\">#</div><div class=\"line\"># 允许此节点可以用来存储数据（默认启用）：</div><div class=\"line\">#</div><div class=\"line\">#node.data: true</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃你可以利用这些设置，以设计高级集群拓扑。</div><div class=\"line\">＃</div><div class=\"line\">＃1，你想这个节点永远不会成为一个主节点，只保存数据。这将是群集的“主力”。</div><div class=\"line\">＃</div><div class=\"line\">＃</div><div class=\"line\">#node.master: false</div><div class=\"line\">#node.data: true</div><div class=\"line\">#</div><div class=\"line\">＃2，你要这个节点只能作为主：不存储任何数据和有免费的资源。这将是群集的“协调员”。</div><div class=\"line\">＃</div><div class=\"line\">＃</div><div class=\"line\">#node.master: true</div><div class=\"line\">#node.data: false</div><div class=\"line\">#</div><div class=\"line\">＃3，你希望这个节点是不是主数据节点，但可以充当“搜索负载平衡器”（取从节点的数据，聚集结果等）</div><div class=\"line\">＃</div><div class=\"line\">#node.master: false</div><div class=\"line\">#node.data: false</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃使用群集健康状况API[http://localhost:9200/_cluster/health]，</div><div class=\"line\">＃节点信息API[http://localhost:9200/_nodes]或GUI工具</div><div class=\"line\">＃如&lt;http://www.elasticsearch.org/overview/marvel/&gt;</div><div class=\"line\">＃&lt;http://github.com/karmi/elasticsearch-paramedic&gt;</div><div class=\"line\">＃&lt;http://github.com/lukas-vlcek/bigdesk&gt;和</div><div class=\"line\">＃&lt;http://mobz.github.com/elasticsearch-head&gt;检查群集状态。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃一个节点可以有与之关联的通用属性，可用于定制分片分配过滤，或分配意识。</div><div class=\"line\">＃</div><div class=\"line\">＃属性是一个简单的键值对，类似node.key：值，下面是一个例子：</div><div class=\"line\">＃</div><div class=\"line\">#node.rack: rack314</div><div class=\"line\"></div><div class=\"line\">＃默认情况下，多个节点被允许从相同的安装位置</div><div class=\"line\"># 如果要禁用的话，设置如下：</div><div class=\"line\">#node.max_local_storage_nodes: 1</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#################################### Index 索引####################################</div><div class=\"line\"></div><div class=\"line\">#</div><div class=\"line\">＃您可以设置一些选项（如分片/副本选项，映射或分析器的定义，事务日志设置...）对全局参数，在这个文件中。</div><div class=\"line\">#</div><div class=\"line\"># Note, that it makes more sense to configure index settings specifically for</div><div class=\"line\"># a certain index, either when creating it or by using the index templates API.</div><div class=\"line\">#</div><div class=\"line\">＃请注意，它更有意义专门配置索引设置</div><div class=\"line\">＃某个具体的索引，创造它或使用该索引模板API。</div><div class=\"line\"># See &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/index-modules.html&gt; and</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/indices-create-index.html&gt;</div><div class=\"line\"># for more information.</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 设置一个索引的分片（副本）数量（默认 5）</div><div class=\"line\">#</div><div class=\"line\">#index.number_of_shards: 5</div><div class=\"line\"></div><div class=\"line\">＃设置索引（默认值为1）的副本（额外副本）数量：</div><div class=\"line\">＃</div><div class=\"line\">#index.number_of_replicas: 1</div><div class=\"line\"></div><div class=\"line\"># Note, that for development on a local machine, with small indices, it usually</div><div class=\"line\"># makes sense to &quot;disable&quot; the distributed features:</div><div class=\"line\">#</div><div class=\"line\">＃注意，对于在本地机器，它通常比较小的值。禁用分布式特点是很有必要的</div><div class=\"line\">＃</div><div class=\"line\">#index.number_of_shards: 1</div><div class=\"line\">#index.number_of_replicas: 0</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃这些设置直接影响索引和搜索操作的性能</div><div class=\"line\">＃在集群中。假设你有足够多的机器来保存分片及</div><div class=\"line\">＃副本，经验法则是：</div><div class=\"line\">#</div><div class=\"line\"># 1. 更多的分片能提高索引效率，一个大的索引允许存储在不同的服务器上</div><div class=\"line\"># 2. 更多的副本能够提高搜索效率，并且能够增强系统的可用性</div><div class=\"line\">#</div><div class=\"line\">#  &quot;number_of_shards&quot; 对于一个索引不能动态修改设置一次.</div><div class=\"line\">#</div><div class=\"line\"># T &quot;number_of_replicas&quot; 可以增加或者减少在任何时候，通过索引更新或者api操作</div><div class=\"line\">#</div><div class=\"line\"># Elasticsearch takes care about load balancing, relocating, gathering the</div><div class=\"line\"># results from nodes, etc. Experiment with different settings to fine-tune</div><div class=\"line\"># your setup.</div><div class=\"line\"></div><div class=\"line\">＃Elasticsearch需要关心负载均衡，搬迁，从节点收集结果，等。</div><div class=\"line\"># 你可以通过不断的微调进行设置</div><div class=\"line\"></div><div class=\"line\">＃使用索引状态API（&lt;http://localhost:9200/A/_status&gt;）检查</div><div class=\"line\">＃索引状态。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#################################### Paths ####################################</div><div class=\"line\"></div><div class=\"line\"># 路径包含目录配置（此文件并logging.yml）：</div><div class=\"line\">#path.conf: /path/to/conf</div><div class=\"line\"></div><div class=\"line\"># 索引数据存储路径配置</div><div class=\"line\">#path.data: /path/to/data</div><div class=\"line\">#</div><div class=\"line\">＃可以任选地包括一个以上的位置，方便扩展和使用。 例如：</div><div class=\"line\">#</div><div class=\"line\">#path.data: /path/to/data1,/path/to/data2</div><div class=\"line\"></div><div class=\"line\"># 临时文件路径：</div><div class=\"line\">#</div><div class=\"line\">#path.work: /path/to/work</div><div class=\"line\"></div><div class=\"line\"># 日志文件路径:</div><div class=\"line\">#</div><div class=\"line\">#path.logs: /path/to/logs</div><div class=\"line\"></div><div class=\"line\"># 插件安装目录</div><div class=\"line\">#</div><div class=\"line\">#path.plugins: /path/to/plugins</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#################################### Plugin ###################################</div><div class=\"line\"></div><div class=\"line\"># 如果这里列出的插件没有安装用于当前节点，该节点将无法启动。</div><div class=\"line\">#</div><div class=\"line\">#plugin.mandatory: mapper-attachments,lang-groovy</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">################################### Memory ####################################</div><div class=\"line\"></div><div class=\"line\">＃Elasticsearch表现不佳时，JVM启动交换：你应该确保它永远不会_交换。</div><div class=\"line\">#</div><div class=\"line\"># 将此属性设置为true锁定内存：</div><div class=\"line\">#</div><div class=\"line\">#bootstrap.mlockall: true</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 确保ES_MIN_MEM和ES_MAX_MEM环境变量设置</div><div class=\"line\">＃为相同的值，并且该机器有足够的内存来分配</div><div class=\"line\">＃为Elasticsearch，留出足够的内存为操作系统本身。</div><div class=\"line\">＃</div><div class=\"line\">#</div><div class=\"line\"># You should also make sure that the Elasticsearch process is allowed to lock</div><div class=\"line\"># the memory, eg. by using `ulimit -l unlimited`.</div><div class=\"line\"># 你还应该确保该Elasticsearch允许进程锁定内存</div><div class=\"line\">＃例如。通过使用`ulimit -l unlimited`。</div><div class=\"line\"></div><div class=\"line\">############################## Network And HTTP ###############################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃Elasticsearch，默认情况下，本身绑定到0.0.0.0地址，并监听</div><div class=\"line\">＃端口[9200-9300] HTTP流量和端口[9300-9400]节点到节点</div><div class=\"line\">＃沟通。（范围意味着，如果端口忙，它会自动将</div><div class=\"line\">＃尝试下口）。</div><div class=\"line\"></div><div class=\"line\"># 设置绑定专用地址（IPv4或IPv6）：</div><div class=\"line\">#network.bind_host: 192.168.0.1</div><div class=\"line\"></div><div class=\"line\">＃设置其他节点将使用与该节点通信的地址。否则</div><div class=\"line\">＃，它会自动的产生。它必须指向一个实际的IP地址。</div><div class=\"line\">#</div><div class=\"line\">#network.publish_host: 192.168.0.1</div><div class=\"line\"></div><div class=\"line\"># 同时设置“bind_host&apos;和&apos;publish_host”：</div><div class=\"line\">#</div><div class=\"line\">#network.host: 192.168.0.1</div><div class=\"line\"></div><div class=\"line\"># 设置一个自定义的节点间通讯端口，（默认为 9300）</div><div class=\"line\">#transport.tcp.port: 9300</div><div class=\"line\"></div><div class=\"line\"># 启用节点间通讯压缩</div><div class=\"line\">#</div><div class=\"line\">#transport.tcp.compress: true</div><div class=\"line\"></div><div class=\"line\"># 设置自定义端口侦听HTTP流量：</div><div class=\"line\">#</div><div class=\"line\">#http.port: 9200</div><div class=\"line\"></div><div class=\"line\"># 设置自定义允许的内容长度：</div><div class=\"line\">#</div><div class=\"line\">#http.max_content_length: 100mb</div><div class=\"line\"></div><div class=\"line\"># 完全禁用HTTP：</div><div class=\"line\">#</div><div class=\"line\">#http.enabled: false</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">################################### Gateway ###################################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃网关允许持收集集群之间的群集状态</div><div class=\"line\">＃集群中每个状态改变（例如添加一个索引），都将会存储</div><div class=\"line\">＃在网关，并且当集群首次启动时，</div><div class=\"line\">＃它会从网关读出其状态。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃有几种类型的网关实现的。欲了解更多信息，请参阅</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-gateway.html&gt;.</div><div class=\"line\"></div><div class=\"line\">＃默认网关类型为“本地”网关（推荐）：</div><div class=\"line\">#</div><div class=\"line\">#gateway.type: local</div><div class=\"line\"></div><div class=\"line\"># 设置当集群崩溃时，如何重新启动并恢复进程（使用共享网关时，尽可能多的使用本地数据）</div><div class=\"line\"></div><div class=\"line\"># 允许恢复后，在一个集群中有N个节点：</div><div class=\"line\">#</div><div class=\"line\">#gateway.recover_after_nodes: 1</div><div class=\"line\"></div><div class=\"line\">＃设置超时时间，在启动恢复过程中，前面设置的N个节点全部重启（接受时间值）：</div><div class=\"line\">#</div><div class=\"line\"></div><div class=\"line\">#gateway.recover_after_time: 5m</div><div class=\"line\"></div><div class=\"line\">＃设置在一个句群众预计的节点数</div><div class=\"line\">#一旦这些N个节点全部启用（满足recover_after_nodes），立即开始恢复过程（无需等待恢复时间后到期）：</div><div class=\"line\">#</div><div class=\"line\">#gateway.expected_nodes: 2</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">############################# Recovery Throttling 恢复节流 #############################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃这些设置可以控制碎片分配的过程，在节点恢复期间、副本定位、重新平衡，或添加和删除节点时</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#</div><div class=\"line\"># 设置一个节点上同时恢复数量</div><div class=\"line\"># 1. 初步恢复期间</div><div class=\"line\">#</div><div class=\"line\">#cluster.routing.allocation.node_initial_primaries_recoveries: 4</div><div class=\"line\">#</div><div class=\"line\"># 2. 在添加/删除节点，再平衡期间</div><div class=\"line\">#</div><div class=\"line\">#cluster.routing.allocation.node_concurrent_recoveries: 2</div><div class=\"line\"></div><div class=\"line\"># 设置一个恢复时的吞吐量值（如100MB，默认20MB）</div><div class=\"line\">#</div><div class=\"line\">#indices.recovery.max_bytes_per_sec: 20mb</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 设置一个并发流数量限制，在同级别的分片恢复时</div><div class=\"line\">#</div><div class=\"line\">#indices.recovery.concurrent_streams: 5</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">################################## Discovery 发现##################################</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃发现基础设施，确保节点可以在群集内找到和主节点的选举。是默认是通过多播方式来进行发现。</div><div class=\"line\"></div><div class=\"line\"># 设置一个节点确保能在集群内发现N个其他合格的节点能成为主节点。</div><div class=\"line\"></div><div class=\"line\">#discovery.zen.minimum_master_nodes: 1</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"># 设置一个过期时间，在通过ping发现其他节点时</div><div class=\"line\"># 在一个较差的网络环境中设置一个较长的值，可以最大限度的减少报错</div><div class=\"line\"></div><div class=\"line\">#discovery.zen.ping.timeout: 3s</div><div class=\"line\"></div><div class=\"line\"># 更多的信息，请看</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-zen.html&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">＃单播发现允许明确地控制哪些节点将被用于发现群集。它可以在多播不存在，或限制集群通信时使用。</div><div class=\"line\">#</div><div class=\"line\"># 1. 多播发现（默认启用）</div><div class=\"line\">#</div><div class=\"line\">#discovery.zen.ping.multicast.enabled: false</div><div class=\"line\">#</div><div class=\"line\"># 2. 配置一个初始清单在集群的主节点上，为了发现一个刚启用的节点</div><div class=\"line\">#</div><div class=\"line\">#discovery.zen.ping.unicast.hosts: [&quot;host1&quot;, &quot;host2:port&quot;]</div><div class=\"line\"></div><div class=\"line\"># 为了发现 ，EC2允许使用AWS EC2 API</div><div class=\"line\"># 你必须安装云AWS插件启用EC2发现。</div><div class=\"line\">#</div><div class=\"line\"># 更多信息请查看</div><div class=\"line\"># &lt;http://elasticsearch.org/guide/en/elasticsearch/reference/current/modules-discovery-ec2.html&gt;</div><div class=\"line\">#</div><div class=\"line\"># See &lt;http://elasticsearch.org/tutorials/elasticsearch-on-ec2/&gt;</div><div class=\"line\"># 一步一步的教程</div><div class=\"line\"></div><div class=\"line\"># 为了发现 ，GCE发现允许使用谷歌Compute Engine的API</div><div class=\"line\">#</div><div class=\"line\"># 你必须安装云GCE GCE插件启用的发现。</div><div class=\"line\">#</div><div class=\"line\"># For more information, see &lt;https://github.com/elasticsearch/elasticsearch-cloud-gce&gt;.</div><div class=\"line\"></div><div class=\"line\"># Azure的发现允许以执行发现使用Azure的API。</div><div class=\"line\">#</div><div class=\"line\"># 你必须安装云cloud-azure插件启用的发现。</div><div class=\"line\"># For more information, see &lt;https://github.com/elasticsearch/elasticsearch-cloud-azure&gt;.</div><div class=\"line\"></div><div class=\"line\">################################## Slow Log ##################################</div><div class=\"line\"></div><div class=\"line\"># 分片级查询并会的对应等级的日志</div><div class=\"line\"></div><div class=\"line\">#index.search.slowlog.threshold.query.warn: 10s</div><div class=\"line\">#index.search.slowlog.threshold.query.info: 5s</div><div class=\"line\">#index.search.slowlog.threshold.query.debug: 2s</div><div class=\"line\">#index.search.slowlog.threshold.query.trace: 500ms</div><div class=\"line\"></div><div class=\"line\">#index.search.slowlog.threshold.fetch.warn: 1s</div><div class=\"line\">#index.search.slowlog.threshold.fetch.info: 800ms</div><div class=\"line\">#index.search.slowlog.threshold.fetch.debug: 500ms</div><div class=\"line\">#index.search.slowlog.threshold.fetch.trace: 200ms</div><div class=\"line\"></div><div class=\"line\">#index.indexing.slowlog.threshold.index.warn: 10s</div><div class=\"line\">#index.indexing.slowlog.threshold.index.info: 5s</div><div class=\"line\">#index.indexing.slowlog.threshold.index.debug: 2s</div><div class=\"line\">#index.indexing.slowlog.threshold.index.trace: 500ms</div><div class=\"line\"></div><div class=\"line\">################################## GC Logging ################################</div><div class=\"line\"></div><div class=\"line\">#monitor.jvm.gc.young.warn: 1000ms</div><div class=\"line\">#monitor.jvm.gc.young.info: 700ms</div><div class=\"line\">#monitor.jvm.gc.young.debug: 400ms</div><div class=\"line\"></div><div class=\"line\">#monitor.jvm.gc.old.warn: 10s</div><div class=\"line\">#monitor.jvm.gc.old.info: 5s</div><div class=\"line\">#monitor.jvm.gc.old.debug: 2s</div><div class=\"line\"></div><div class=\"line\">################################## Security ################################</div><div class=\"line\"></div><div class=\"line\"># Uncomment if you want to enable JSONP as a valid return transport on the</div><div class=\"line\"># http server. With this enabled, it may pose a security risk, so disabling</div><div class=\"line\"># it unless you need it is recommended (it is disabled by default).</div><div class=\"line\"></div><div class=\"line\">＃不推荐，如果要启用JSONP作为HTTP服务器上的返回。</div><div class=\"line\">#启用此功能，它可能会带来安全风险，因此禁用它，除非你需要的建议（它被默认禁用）。</div><div class=\"line\"></div><div class=\"line\">#http.jsonp.enable: true</div></pre></td></tr></table></figure></p>\n<p>logging.yml</p>\n<blockquote>\n<p>定义多少信息写入系统日志、定义日志文件，并定期创建新文件</p>\n</blockquote>\n<h3 id=\"管理\"><a href=\"#管理\" class=\"headerlink\" title=\"管理\"></a>管理</h3><p>启动Elasticsearch<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/elasticsearch/bin/elasticsearch  -d</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>-d 表示将进程放入后台运行</p>\n</blockquote>\n<p>或者通过\u0004nohup命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># nohup /usr/local/elasticsearch/bin/elasticsearch &gt; nohup</div></pre></td></tr></table></figure></p>\n<p>将elasticsearch设置成开机自启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># echo &quot;nohup /usr/local/elasticsearch/bin/elasticsearch &gt; nohup&quot; &gt; /etc/rc.local</div></pre></td></tr></table></figure></p>\n<p>确认elasticsearch的9200端口已监听，说明elasticsearch已成功运行</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># netstat -anp |grep :9200</div><div class=\"line\">tcp        0      0 :::9200                     :::*                        LISTEN      3362/java</div></pre></td></tr></table></figure>\n<p>如何关闭elasticsearch</p>\n<ul>\n<li>方法一：如果节点与控制台相连并且当前elasticsearch是使用-f选项运行，则只需要按下Ctrl+C组合键即可</li>\n<li>方法二：通过发送TERM信号来终止服务器进程 kill -9 进程ID</li>\n<li>方法三：使用REST API</li>\n</ul>\n<p>关闭整个集群<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPOST http://localhost:9200/_cluster/nodes/_shutdown</div></pre></td></tr></table></figure></p>\n<p>关闭单个节点<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPOST  http://127.0.0.1:9200/_cluster/nodes/2ens0yuEQ12G6ct1UDpihQ/_shutdown</div></pre></td></tr></table></figure></p>\n<p>2ens0yuEQ12G6ct1UDpihQ ，为要关闭的节点标志符</p>\n<p>查看节点标志符，可以从elasticsearch日志中或者通过REST API中获得<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl http://localhost:9200/_nodes/?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</div><div class=\"line\">  &quot;nodes&quot; : &#123;</div><div class=\"line\">    &quot;13QfvIdATEurGAhVAlO6tQ&quot; : &#123;</div><div class=\"line\">      &quot;name&quot; : &quot;Edwin Jarvis&quot;,</div><div class=\"line\">      ...</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>13QfvIdATEurGAhVAlO6tQ,即为节点标志符</p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl http://localhost:9200</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;status&quot; : 200,</div><div class=\"line\">  &quot;name&quot; : &quot;Destroyer of Demons&quot;,</div><div class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</div><div class=\"line\">  &quot;version&quot; : &#123;</div><div class=\"line\">    &quot;number&quot; : &quot;1.7.0&quot;,</div><div class=\"line\">    &quot;build_hash&quot; : &quot;929b9739cae115e73c346cb5f9a6f24ba735a743&quot;,</div><div class=\"line\">    &quot;build_timestamp&quot; : &quot;2015-07-16T14:31:07Z&quot;,</div><div class=\"line\">    &quot;build_snapshot&quot; : false,</div><div class=\"line\">    &quot;lucene_version&quot; : &quot;4.10.4&quot;</div><div class=\"line\">  &#125;,</div><div class=\"line\">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>查看elasticsearch服务器当前运行状况<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl http://localhost:9200/_cluster/health?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</div><div class=\"line\">  &quot;status&quot; : &quot;green&quot;,</div><div class=\"line\">  &quot;timed_out&quot; : false,</div><div class=\"line\">  &quot;number_of_nodes&quot; : 1,</div><div class=\"line\">  &quot;number_of_data_nodes&quot; : 1,</div><div class=\"line\">  &quot;active_primary_shards&quot; : 0,</div><div class=\"line\">  &quot;active_shards&quot; : 0,</div><div class=\"line\">  &quot;relocating_shards&quot; : 0,</div><div class=\"line\">  &quot;initializing_shards&quot; : 0,</div><div class=\"line\">  &quot;unassigned_shards&quot; : 0,</div><div class=\"line\">  &quot;delayed_unassigned_shards&quot; : 0,</div><div class=\"line\">  &quot;number_of_pending_tasks&quot; : 0,</div><div class=\"line\">  &quot;number_of_in_flight_fetch&quot; : 0</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"使用（基于REST-API数据操作）\"><a href=\"#使用（基于REST-API数据操作）\" class=\"headerlink\" title=\"使用（基于REST API数据操作）\"></a>使用（基于REST API数据操作）</h2><h3 id=\"REST\"><a href=\"#REST\" class=\"headerlink\" title=\"REST\"></a>REST</h3><p>REST 定义了一组体系架构原则，您可以根据这些原则设计以系统资源为中心的 Web 服务，包括使用不同语言编写的客户端如何通过 HTTP 处理和传输资源状态。 它用简洁易行的方式向HTTP中的条目暴露CRUD（Create、Replace、Update、Delete，创建、替换、更新、删除）的应用功能。</p>\n<h3 id=\"创建文档\"><a href=\"#创建文档\" class=\"headerlink\" title=\"创建文档\"></a>创建文档</h3><p>示例：创建一个文档用来存储一篇blog，内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;</div><div class=\"line\">  &quot;title&quot;:&quot;my first article title&quot;,</div><div class=\"line\">  &quot;content&quot;:&quot;this is article content&quot;,</div><div class=\"line\">  &quot;date&quot;:&quot;2016-10-05&quot;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>操作：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPUT  http://localhost:9200/blog/article/1 -d &apos;&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>\n<p>返回结果如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">&#123;&quot;_index&quot;:&quot;blog&quot;,&quot;_type&quot;:&quot;article&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:1,&quot;created&quot;:true&#125;</div></pre></td></tr></table></figure></p>\n<p>返回了操作结果信息，并显示新文档的存储位置。并且包含文档的唯一标识符以及当前版本信息。</p>\n<h3 id=\"检索文档\"><a href=\"#检索文档\" class=\"headerlink\" title=\"检索文档\"></a>检索文档</h3><p>按照REST风格，我们想要查看刚才创建的文档。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XGET  http://localhost:9200/blog/article/1</div></pre></td></tr></table></figure></p>\n<p>结果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">curl -XGET  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;_version&quot; : 1,</div><div class=\"line\">  &quot;found&quot; : true,</div><div class=\"line\">  &quot;_source&quot;:&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"更新文档\"><a href=\"#更新文档\" class=\"headerlink\" title=\"更新文档\"></a>更新文档</h3><p>Elasticsearch中更新索引中的文档是非常复杂的工作。必须先提取文档、从_source字段获得数据、移除旧文档、应用变更，作为新文档创建索引。</p>\n<p>示例，更改之前创建的blog，并增加author字段<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XPOST  http://localhost:9200/blog/article/1 -d &apos;&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;,&quot;author&quot;:&quot;zhimiao&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>\n<p>结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># &#123;&quot;_index&quot;:&quot;blog&quot;,&quot;_type&quot;:&quot;article&quot;,&quot;_id&quot;:&quot;1&quot;,&quot;_version&quot;:3,&quot;created&quot;:false&#125;</div></pre></td></tr></table></figure></p>\n<p>查看是否更新成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XGET  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;_version&quot; : 4,</div><div class=\"line\">  &quot;found&quot; : true,</div><div class=\"line\">  &quot;_source&quot;:&#123;&quot;title&quot;:&quot;my first article title&quot;,&quot;content&quot;:&quot;this is article content&quot;,&quot;date&quot;:&quot;2016-10-05&quot;,&quot;author&quot;:&quot;zhimiao&quot;&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h3 id=\"删除文档\"><a href=\"#删除文档\" class=\"headerlink\" title=\"删除文档\"></a>删除文档</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XDELETE  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;found&quot; : true,</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;_version&quot; : 7</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>查看是否已删除<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\"># curl -XGET  http://localhost:9200/blog/article/1?pretty</div><div class=\"line\">&#123;</div><div class=\"line\">  &quot;_index&quot; : &quot;blog&quot;,</div><div class=\"line\">  &quot;_type&quot; : &quot;article&quot;,</div><div class=\"line\">  &quot;_id&quot; : &quot;1&quot;,</div><div class=\"line\">  &quot;found&quot; : false</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>"},{"title":"Apache性能监控","author":"zhimiao","date":"2016-08-23T08:10:00.000Z","update":"2016-08-24T02:00:00.000Z","_content":"谈到服务器性能监控，目前市面上有很多成熟的关于性能监控的产品可供我们使用。比如 [Cloud Insight](http://www.oneapm.com/ci/feature.html)\n。但通过 Apache本身提供的监控模块或者通过一些简单的bash命令也能实现简单的监控。\n\n<!-- more -->\n\n## Linux下通过Server-status来监控Apache\n\n1. 加载 mod_status.so 模块\n> mod_status, Apache状态管理模块\n\n    ```\n#在httpd.conf中加入下面这句或将其前面注释去掉\nLoadModule status_module modules/server_status.so\n```\n\n2. 修改配置文件\n  * 方式一：直接在 httpd.conf 底部添加以下配置\n```\n<location /c-server-status>\n    setHandle Server-status\n    Order Deny,Allow\n    Deny from nothing\n    Allow from all\n</location>\nExtendedStatus on\n```\n  * 方式二：添加到子配置文件中\n  在 httpd.conf 中找到 `Include conf/extra/httpd-info.conf`,去掉`#`,\n  在 httpd-info.conf 文件中加入 方式一 中的内容。\n\n  **Tips：**\n  * `<location /c-server-status>`: 这个名字可以任意取，最好不要让别人猜到。\n  * `ExtendedStatus on`: 启用扩展状态。该设置仅能用于全局设置，不能在特定的虚拟主机中打开或者关闭。并且，启用该扩展会使服务器运行效率降低。\n\n3. 重启Apache\n```\n/usr/local/apache2/bin/httpd -k start|restart|stop\n```\n\n4. 访问页面\n\n  http://your-domain/c-server-status\n\n  http://your-domain/c-server-status?refresh=5\n\n  [官网示例](http://www.apache.org/server-status)\n\n5. 监控参数\n\n\n参数名称|\t参数描述\n-------|---------\nTotal Accesses|\t服务器自启动来接收到的请求连接数\nTotal kBytes|\t传输的总数据量，单位是KB\nCPULoad\t|NCPU负荷\nUptime\t|运行时间，单位秒\nReqPerSec\t|每秒请求数\nBytesPerSec\t|每秒传输数据量，单位B/s\nBytesPerReq\t|平均每个请求的数据传输量（事实上就是BytesPerSec/BytesPerSec）\nBusyWorkers\t|在跑的进程数\nIdleWorkers\t|空闲的进程数\n\n## Linux下通过命令来实现监控\n\n1. ps 查看httpd进程数\n```\n$ps -ef | grep httpd | wc -l\n```\n当连接数多了，他就会生出更多进程来处理请求。当然这结果包含 grep httpd 的进程输出，所以一般来说实际进程数比输出结果少1\n2. 用netstat来查看当前连接数\n```\n$netstat -ant | grep \":80\" | wc -l\n```\n连接数目并不等于httpd线程数目，当然连接数目越多，httpd进程数就有可能数会增多。上面的返回结果数目，有可能包括多种连接状态，比如 LISTEN、ESTABLISHED、TIME_WAIT等等，可以加入状态关键字进一步过滤，得到想要的结果。\n3. 实时检测httpd连接数\n```\n#watch -n 1 -d \"pgrep httpd|wc -l\"\n```\n4. 计算httpd进程占用内在的平均数\n```\n#ps aux|grep -v grep|awk '/httpd/{sum+=$6}; END{print sum/n}'\n```\n5. 查看Apache的并发请求数及期TCP连接状态\n```\n#netstat -n | awk '/^tcp/{++S[$NF]}END{for(a in S) print a, S[a]}'\n返回结果示例：\nLAST_ACK 5\nSYN_RECV 30       #表示正在等待处理的请求数；\nESTABLISHED 1597  #表示正常数据传输状态；\nFIN_WAIT1 51\nFIN_WAIT2 504\nTIME_WAIT 1057    #表示处理完毕,等待超时结束的请求数\n```\n\n常见的连接状态\n\n状态|描述\n---|----\nCLOSED|无连接是活动的或正在进行\nLISTEN|服务器在等待进入呼叫\nSYN_RECV|一个连接请求已经到达,等待确认\nSYN_SENT|应用已经开始,打开一个连接\nESTABLISHED|正常数据传输状态\nFIN_WAIT1|应用说它已经完成\nFIN_WAIT2|另一边已同意释放\nITMED_WAIT|等待所有分组死掉\nCLOSING|两边同时尝试关闭\nTIME_WAIT|另一边已初始化一个释放\nLAST_ACK|等待所有分组死掉\n","source":"_posts/Apache性能监控.md","raw":"title: Apache性能监控\ntags:\n  - Apache 监控\ncategories:\n  - Apache\nauthor: zhimiao\ndate: 2016-08-23 16:10:00\nupdate: 2016-08-24 10:00:00\n---\n谈到服务器性能监控，目前市面上有很多成熟的关于性能监控的产品可供我们使用。比如 [Cloud Insight](http://www.oneapm.com/ci/feature.html)\n。但通过 Apache本身提供的监控模块或者通过一些简单的bash命令也能实现简单的监控。\n\n<!-- more -->\n\n## Linux下通过Server-status来监控Apache\n\n1. 加载 mod_status.so 模块\n> mod_status, Apache状态管理模块\n\n    ```\n#在httpd.conf中加入下面这句或将其前面注释去掉\nLoadModule status_module modules/server_status.so\n```\n\n2. 修改配置文件\n  * 方式一：直接在 httpd.conf 底部添加以下配置\n```\n<location /c-server-status>\n    setHandle Server-status\n    Order Deny,Allow\n    Deny from nothing\n    Allow from all\n</location>\nExtendedStatus on\n```\n  * 方式二：添加到子配置文件中\n  在 httpd.conf 中找到 `Include conf/extra/httpd-info.conf`,去掉`#`,\n  在 httpd-info.conf 文件中加入 方式一 中的内容。\n\n  **Tips：**\n  * `<location /c-server-status>`: 这个名字可以任意取，最好不要让别人猜到。\n  * `ExtendedStatus on`: 启用扩展状态。该设置仅能用于全局设置，不能在特定的虚拟主机中打开或者关闭。并且，启用该扩展会使服务器运行效率降低。\n\n3. 重启Apache\n```\n/usr/local/apache2/bin/httpd -k start|restart|stop\n```\n\n4. 访问页面\n\n  http://your-domain/c-server-status\n\n  http://your-domain/c-server-status?refresh=5\n\n  [官网示例](http://www.apache.org/server-status)\n\n5. 监控参数\n\n\n参数名称|\t参数描述\n-------|---------\nTotal Accesses|\t服务器自启动来接收到的请求连接数\nTotal kBytes|\t传输的总数据量，单位是KB\nCPULoad\t|NCPU负荷\nUptime\t|运行时间，单位秒\nReqPerSec\t|每秒请求数\nBytesPerSec\t|每秒传输数据量，单位B/s\nBytesPerReq\t|平均每个请求的数据传输量（事实上就是BytesPerSec/BytesPerSec）\nBusyWorkers\t|在跑的进程数\nIdleWorkers\t|空闲的进程数\n\n## Linux下通过命令来实现监控\n\n1. ps 查看httpd进程数\n```\n$ps -ef | grep httpd | wc -l\n```\n当连接数多了，他就会生出更多进程来处理请求。当然这结果包含 grep httpd 的进程输出，所以一般来说实际进程数比输出结果少1\n2. 用netstat来查看当前连接数\n```\n$netstat -ant | grep \":80\" | wc -l\n```\n连接数目并不等于httpd线程数目，当然连接数目越多，httpd进程数就有可能数会增多。上面的返回结果数目，有可能包括多种连接状态，比如 LISTEN、ESTABLISHED、TIME_WAIT等等，可以加入状态关键字进一步过滤，得到想要的结果。\n3. 实时检测httpd连接数\n```\n#watch -n 1 -d \"pgrep httpd|wc -l\"\n```\n4. 计算httpd进程占用内在的平均数\n```\n#ps aux|grep -v grep|awk '/httpd/{sum+=$6}; END{print sum/n}'\n```\n5. 查看Apache的并发请求数及期TCP连接状态\n```\n#netstat -n | awk '/^tcp/{++S[$NF]}END{for(a in S) print a, S[a]}'\n返回结果示例：\nLAST_ACK 5\nSYN_RECV 30       #表示正在等待处理的请求数；\nESTABLISHED 1597  #表示正常数据传输状态；\nFIN_WAIT1 51\nFIN_WAIT2 504\nTIME_WAIT 1057    #表示处理完毕,等待超时结束的请求数\n```\n\n常见的连接状态\n\n状态|描述\n---|----\nCLOSED|无连接是活动的或正在进行\nLISTEN|服务器在等待进入呼叫\nSYN_RECV|一个连接请求已经到达,等待确认\nSYN_SENT|应用已经开始,打开一个连接\nESTABLISHED|正常数据传输状态\nFIN_WAIT1|应用说它已经完成\nFIN_WAIT2|另一边已同意释放\nITMED_WAIT|等待所有分组死掉\nCLOSING|两边同时尝试关闭\nTIME_WAIT|另一边已初始化一个释放\nLAST_ACK|等待所有分组死掉\n","slug":"Apache性能监控","published":1,"updated":"2016-08-24T03:16:28.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwuu000d699f2k3oojyp","content":"<p>谈到服务器性能监控，目前市面上有很多成熟的关于性能监控的产品可供我们使用。比如 <a href=\"http://www.oneapm.com/ci/feature.html\" target=\"_blank\" rel=\"external\">Cloud Insight</a><br>。但通过 Apache本身提供的监控模块或者通过一些简单的bash命令也能实现简单的监控。</p>\n<a id=\"more\"></a>\n<h2 id=\"Linux下通过Server-status来监控Apache\"><a href=\"#Linux下通过Server-status来监控Apache\" class=\"headerlink\" title=\"Linux下通过Server-status来监控Apache\"></a>Linux下通过Server-status来监控Apache</h2><ol>\n<li><p>加载 mod_status.so 模块</p>\n<blockquote>\n<p>mod_status, Apache状态管理模块</p>\n</blockquote>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">#在httpd.conf中加入下面这句或将其前面注释去掉</div><div class=\"line\">LoadModule status_module modules/server_status.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>修改配置文件</p>\n<ul>\n<li><p>方式一：直接在 httpd.conf 底部添加以下配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;location /c-server-status&gt;</div><div class=\"line\">    setHandle Server-status</div><div class=\"line\">    Order Deny,Allow</div><div class=\"line\">    Deny from nothing</div><div class=\"line\">    Allow from all</div><div class=\"line\">&lt;/location&gt;</div><div class=\"line\">ExtendedStatus on</div></pre></td></tr></table></figure>\n</li>\n<li><p>方式二：添加到子配置文件中<br>在 httpd.conf 中找到 <code>Include conf/extra/httpd-info.conf</code>,去掉<code>#</code>,<br>在 httpd-info.conf 文件中加入 方式一 中的内容。</p>\n</li>\n</ul>\n<p><strong>Tips：</strong></p>\n<ul>\n<li><code>&lt;location /c-server-status&gt;</code>: 这个名字可以任意取，最好不要让别人猜到。</li>\n<li><code>ExtendedStatus on</code>: 启用扩展状态。该设置仅能用于全局设置，不能在特定的虚拟主机中打开或者关闭。并且，启用该扩展会使服务器运行效率降低。</li>\n</ul>\n</li>\n<li><p>重启Apache</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/apache2/bin/httpd -k start|restart|stop</div></pre></td></tr></table></figure>\n</li>\n<li><p>访问页面</p>\n<p><a href=\"http://your-domain/c-server-status\" target=\"_blank\" rel=\"external\">http://your-domain/c-server-status</a></p>\n<p><a href=\"http://your-domain/c-server-status?refresh=5\" target=\"_blank\" rel=\"external\">http://your-domain/c-server-status?refresh=5</a></p>\n<p><a href=\"http://www.apache.org/server-status\" target=\"_blank\" rel=\"external\">官网示例</a></p>\n</li>\n<li><p>监控参数</p>\n</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>参数名称</th>\n<th>参数描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Total Accesses</td>\n<td>服务器自启动来接收到的请求连接数</td>\n</tr>\n<tr>\n<td>Total kBytes</td>\n<td>传输的总数据量，单位是KB</td>\n</tr>\n<tr>\n<td>CPULoad</td>\n<td>NCPU负荷</td>\n</tr>\n<tr>\n<td>Uptime</td>\n<td>运行时间，单位秒</td>\n</tr>\n<tr>\n<td>ReqPerSec</td>\n<td>每秒请求数</td>\n</tr>\n<tr>\n<td>BytesPerSec</td>\n<td>每秒传输数据量，单位B/s</td>\n</tr>\n<tr>\n<td>BytesPerReq</td>\n<td>平均每个请求的数据传输量（事实上就是BytesPerSec/BytesPerSec）</td>\n</tr>\n<tr>\n<td>BusyWorkers</td>\n<td>在跑的进程数</td>\n</tr>\n<tr>\n<td>IdleWorkers</td>\n<td>空闲的进程数</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Linux下通过命令来实现监控\"><a href=\"#Linux下通过命令来实现监控\" class=\"headerlink\" title=\"Linux下通过命令来实现监控\"></a>Linux下通过命令来实现监控</h2><ol>\n<li>ps 查看httpd进程数<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ps -ef | grep httpd | wc -l</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>当连接数多了，他就会生出更多进程来处理请求。当然这结果包含 grep httpd 的进程输出，所以一般来说实际进程数比输出结果少1</p>\n<ol>\n<li>用netstat来查看当前连接数<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$netstat -ant | grep &quot;:80&quot; | wc -l</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>连接数目并不等于httpd线程数目，当然连接数目越多，httpd进程数就有可能数会增多。上面的返回结果数目，有可能包括多种连接状态，比如 LISTEN、ESTABLISHED、TIME_WAIT等等，可以加入状态关键字进一步过滤，得到想要的结果。</p>\n<ol>\n<li><p>实时检测httpd连接数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">#watch -n 1 -d &quot;pgrep httpd|wc -l&quot;</div></pre></td></tr></table></figure>\n</li>\n<li><p>计算httpd进程占用内在的平均数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">#ps aux|grep -v grep|awk &apos;/httpd/&#123;sum+=$6&#125;; END&#123;print sum/n&#125;&apos;</div></pre></td></tr></table></figure>\n</li>\n<li><p>查看Apache的并发请求数及期TCP连接状态</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">#netstat -n | awk &apos;/^tcp/&#123;++S[$NF]&#125;END&#123;for(a in S) print a, S[a]&#125;&apos;</div><div class=\"line\">返回结果示例：</div><div class=\"line\">LAST_ACK 5</div><div class=\"line\">SYN_RECV 30       #表示正在等待处理的请求数；</div><div class=\"line\">ESTABLISHED 1597  #表示正常数据传输状态；</div><div class=\"line\">FIN_WAIT1 51</div><div class=\"line\">FIN_WAIT2 504</div><div class=\"line\">TIME_WAIT 1057    #表示处理完毕,等待超时结束的请求数</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>常见的连接状态</p>\n<table>\n<thead>\n<tr>\n<th>状态</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CLOSED</td>\n<td>无连接是活动的或正在进行</td>\n</tr>\n<tr>\n<td>LISTEN</td>\n<td>服务器在等待进入呼叫</td>\n</tr>\n<tr>\n<td>SYN_RECV</td>\n<td>一个连接请求已经到达,等待确认</td>\n</tr>\n<tr>\n<td>SYN_SENT</td>\n<td>应用已经开始,打开一个连接</td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td>正常数据传输状态</td>\n</tr>\n<tr>\n<td>FIN_WAIT1</td>\n<td>应用说它已经完成</td>\n</tr>\n<tr>\n<td>FIN_WAIT2</td>\n<td>另一边已同意释放</td>\n</tr>\n<tr>\n<td>ITMED_WAIT</td>\n<td>等待所有分组死掉</td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>两边同时尝试关闭</td>\n</tr>\n<tr>\n<td>TIME_WAIT</td>\n<td>另一边已初始化一个释放</td>\n</tr>\n<tr>\n<td>LAST_ACK</td>\n<td>等待所有分组死掉</td>\n</tr>\n</tbody>\n</table>\n","excerpt":"<p>谈到服务器性能监控，目前市面上有很多成熟的关于性能监控的产品可供我们使用。比如 <a href=\"http://www.oneapm.com/ci/feature.html\">Cloud Insight</a><br>。但通过 Apache本身提供的监控模块或者通过一些简单的bash命令也能实现简单的监控。</p>","more":"<h2 id=\"Linux下通过Server-status来监控Apache\"><a href=\"#Linux下通过Server-status来监控Apache\" class=\"headerlink\" title=\"Linux下通过Server-status来监控Apache\"></a>Linux下通过Server-status来监控Apache</h2><ol>\n<li><p>加载 mod_status.so 模块</p>\n<blockquote>\n<p>mod_status, Apache状态管理模块</p>\n</blockquote>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">#在httpd.conf中加入下面这句或将其前面注释去掉</div><div class=\"line\">LoadModule status_module modules/server_status.so</div></pre></td></tr></table></figure>\n</li>\n<li><p>修改配置文件</p>\n<ul>\n<li><p>方式一：直接在 httpd.conf 底部添加以下配置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;location /c-server-status&gt;</div><div class=\"line\">    setHandle Server-status</div><div class=\"line\">    Order Deny,Allow</div><div class=\"line\">    Deny from nothing</div><div class=\"line\">    Allow from all</div><div class=\"line\">&lt;/location&gt;</div><div class=\"line\">ExtendedStatus on</div></pre></td></tr></table></figure>\n</li>\n<li><p>方式二：添加到子配置文件中<br>在 httpd.conf 中找到 <code>Include conf/extra/httpd-info.conf</code>,去掉<code>#</code>,<br>在 httpd-info.conf 文件中加入 方式一 中的内容。</p>\n</li>\n</ul>\n<p><strong>Tips：</strong></p>\n<ul>\n<li><code>&lt;location /c-server-status&gt;</code>: 这个名字可以任意取，最好不要让别人猜到。</li>\n<li><code>ExtendedStatus on</code>: 启用扩展状态。该设置仅能用于全局设置，不能在特定的虚拟主机中打开或者关闭。并且，启用该扩展会使服务器运行效率降低。</li>\n</ul>\n</li>\n<li><p>重启Apache</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/apache2/bin/httpd -k start|restart|stop</div></pre></td></tr></table></figure>\n</li>\n<li><p>访问页面</p>\n<p><a href=\"http://your-domain/c-server-status\">http://your-domain/c-server-status</a></p>\n<p><a href=\"http://your-domain/c-server-status?refresh=5\">http://your-domain/c-server-status?refresh=5</a></p>\n<p><a href=\"http://www.apache.org/server-status\">官网示例</a></p>\n</li>\n<li><p>监控参数</p>\n</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>参数名称</th>\n<th>参数描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Total Accesses</td>\n<td>服务器自启动来接收到的请求连接数</td>\n</tr>\n<tr>\n<td>Total kBytes</td>\n<td>传输的总数据量，单位是KB</td>\n</tr>\n<tr>\n<td>CPULoad</td>\n<td>NCPU负荷</td>\n</tr>\n<tr>\n<td>Uptime</td>\n<td>运行时间，单位秒</td>\n</tr>\n<tr>\n<td>ReqPerSec</td>\n<td>每秒请求数</td>\n</tr>\n<tr>\n<td>BytesPerSec</td>\n<td>每秒传输数据量，单位B/s</td>\n</tr>\n<tr>\n<td>BytesPerReq</td>\n<td>平均每个请求的数据传输量（事实上就是BytesPerSec/BytesPerSec）</td>\n</tr>\n<tr>\n<td>BusyWorkers</td>\n<td>在跑的进程数</td>\n</tr>\n<tr>\n<td>IdleWorkers</td>\n<td>空闲的进程数</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"Linux下通过命令来实现监控\"><a href=\"#Linux下通过命令来实现监控\" class=\"headerlink\" title=\"Linux下通过命令来实现监控\"></a>Linux下通过命令来实现监控</h2><ol>\n<li>ps 查看httpd进程数<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ps -ef | grep httpd | wc -l</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>当连接数多了，他就会生出更多进程来处理请求。当然这结果包含 grep httpd 的进程输出，所以一般来说实际进程数比输出结果少1</p>\n<ol>\n<li>用netstat来查看当前连接数<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$netstat -ant | grep &quot;:80&quot; | wc -l</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>连接数目并不等于httpd线程数目，当然连接数目越多，httpd进程数就有可能数会增多。上面的返回结果数目，有可能包括多种连接状态，比如 LISTEN、ESTABLISHED、TIME_WAIT等等，可以加入状态关键字进一步过滤，得到想要的结果。</p>\n<ol>\n<li><p>实时检测httpd连接数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">#watch -n 1 -d &quot;pgrep httpd|wc -l&quot;</div></pre></td></tr></table></figure>\n</li>\n<li><p>计算httpd进程占用内在的平均数</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">#ps aux|grep -v grep|awk &apos;/httpd/&#123;sum+=$6&#125;; END&#123;print sum/n&#125;&apos;</div></pre></td></tr></table></figure>\n</li>\n<li><p>查看Apache的并发请求数及期TCP连接状态</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">#netstat -n | awk &apos;/^tcp/&#123;++S[$NF]&#125;END&#123;for(a in S) print a, S[a]&#125;&apos;</div><div class=\"line\">返回结果示例：</div><div class=\"line\">LAST_ACK 5</div><div class=\"line\">SYN_RECV 30       #表示正在等待处理的请求数；</div><div class=\"line\">ESTABLISHED 1597  #表示正常数据传输状态；</div><div class=\"line\">FIN_WAIT1 51</div><div class=\"line\">FIN_WAIT2 504</div><div class=\"line\">TIME_WAIT 1057    #表示处理完毕,等待超时结束的请求数</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>常见的连接状态</p>\n<table>\n<thead>\n<tr>\n<th>状态</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CLOSED</td>\n<td>无连接是活动的或正在进行</td>\n</tr>\n<tr>\n<td>LISTEN</td>\n<td>服务器在等待进入呼叫</td>\n</tr>\n<tr>\n<td>SYN_RECV</td>\n<td>一个连接请求已经到达,等待确认</td>\n</tr>\n<tr>\n<td>SYN_SENT</td>\n<td>应用已经开始,打开一个连接</td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td>正常数据传输状态</td>\n</tr>\n<tr>\n<td>FIN_WAIT1</td>\n<td>应用说它已经完成</td>\n</tr>\n<tr>\n<td>FIN_WAIT2</td>\n<td>另一边已同意释放</td>\n</tr>\n<tr>\n<td>ITMED_WAIT</td>\n<td>等待所有分组死掉</td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>两边同时尝试关闭</td>\n</tr>\n<tr>\n<td>TIME_WAIT</td>\n<td>另一边已初始化一个释放</td>\n</tr>\n<tr>\n<td>LAST_ACK</td>\n<td>等待所有分组死掉</td>\n</tr>\n</tbody>\n</table>"},{"title":"LNMP环境安装与配置","date":"2016-09-25T15:30:00.000Z","ctime":"2016-09-25T15:30:00.000Z","utime":"2016-09-25T15:30:00.000Z","modif_times":0,"_content":"\n![LNMP](http://n.sinaimg.cn/games/3ece443e/20160925/lnmp_log.png)\n<!-- more -->\n\n## 环境准备\n\nOS：CentOS 7.2 64\n\nMySQL：[mysql-5.7.15](http://dev.mysql.com/downloads/mysql/)\n\nNginx：[nginx-1.11.4](http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz)\n\nPHP：[php-5.6.25](http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz)\n\n## 安装\n参考MySQL、Nginx、PHP的编译安装，分别安装 MySQL、Nginx、PHP到Linux。\n\n## 整合\n\n### 启动 php-fpm\n\n新建用户和用户组，\n```\n# groupadd www-data\n# useradd -g www-data www-data\n```\n需要修改 php-fpm.conf 配置文件，确保 php-fpm 模块使用 www-data 用户和 www-data 用户组的身份运行。\n\n```\nvi /usr/local/php56/etc/php-fpm.conf\n#找到以下内容并修改：\n; Unix user/group of processes\n; Note: The user is mandatory. If the group is not set, the default user's group\n;       will be used.\nuser = www-data\ngroup = www-data\n```\n修改 pid 配置，以方便我们后面根据pid管理php-fpm\n```\n[global]\n; Pid file\n; Note: the default prefix is /usr/local/php56/var\n; Default Value: none\npid = run/php-fpm.pid\n```\nPHP-FPM运行时，将会在/usr/local/php56/var/run/下生成 php-fpm.pid 文件。\n\n然后启动 php-fpm 服务：\n```\n/usr/local/php56/sbin/php-fpm\n```\n查看是否启动成功\n```\nps aux | grep php\nroot     18858  0.0  0.1 148164  3208 ?        Ss   12:38   0:00 php-fpm: master process (/usr/local/php56/etc/php-fpm.conf)\nwww-data 18859  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www\nwww-data 18860  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www\nroot     18862  0.0  0.0 112664   972 pts/1    S+   12:38   0:00 grep --color=auto php\n```\n**注** 需要着重提醒的是，如果文件不存在，则阻止 Nginx 将请求发送到后端的 PHP-FPM 模块， 以避免遭受恶意脚本注入的攻击。\n将 php.ini 文件中的配置项 cgi.fix_pathinfo 设置为 0 。\n\n```\nvi /usr/local/php56/lib/php.ini\n\ncgi.fix_pathinfo=0\n```\n\n\n### PHP-FPM 重要配置\nphp-fpm.conf重要参数详解\n\n- pid = run/php-fpm.pid\n> pid设置，默认在安装目录中的var/run/php-fpm.pid，建议开启\n\n- error_log = log/php-fpm.log\n> 错误日志，默认在安装目录中的var/log/php-fpm.log\n\n- log_level = notice\n> 错误级别. 可用级别为: alert（必须立即处理）, error（错误情况）, warning（警告情况）, notice（一般重要信息）, debug（调试信息）. 默认: notice.\n\n- emergency_restart_threshold = 60\n- emergency_restart_interval = 60s\n> 表示在emergency_restart_interval所设值内出现SIGSEGV或者SIGBUS错误的php-cgi进程数如果超过 emergency_restart_threshold个，php-fpm就会优雅重启。这两个选项一般保持默认值。\n\n- process_control_timeout = 0\n> 设置子进程接受主进程复用信号的超时时间. 可用单位: s(秒), m(分), h(小时), 或者 d(天) 默认单位: s(秒). 默认值: 0.\n\n- daemonize = yes\n> 后台执行fpm,默认值为yes，如果为了调试可以改为no。在FPM中，可以使用不同的设置来运行多个进程池。 这些设置可以针对每个进程池单独设置。\n\n- listen = 127.0.0.1:9000\n> fpm监听端口，即nginx中php处理的地址，一般默认值即可。可用格式为: 'ip:port', 'port', '/path/to/unix/socket'. 每个进程池都需要设置.\n\n- listen.backlog = -1\n> backlog数，-1表示无限制，由操作系统决定，此行注释掉就行。\n\n- listen.allowed_clients = 127.0.0.1\n> 允许访问FastCGI进程的IP，设置any为不限制IP，如果要设置其他主机的nginx也能访问这台FPM进程，listen处要设置成本地可被访问的IP。默认值是any。每个地址是用逗号分隔. 如果没有设置或者为空，则允许任何服务器请求连接\n\n- listen.owner = www\n- listen.group = www\n- listen.mode = 0666\n> unix socket设置选项，如果使用tcp方式访问，这里注释即可。\n\n- user = www\n- group = www\n> 启动进程的帐户和组\n\n- pm = dynamic #对于专用服务器，pm可以设置为static。\n> 如何控制子进程，选项有static和dynamic。如果选择static，则由pm.max_children指定固定的子进程数。如果选择dynamic，则由下开参数决定：\n\n- pm.max_children #\n> 子进程最大数\n\n- pm.start_servers #\n> 启动时的进程数\n\n- pm.min_spare_servers #\n> 保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程\n\n- pm.max_spare_servers #\n> 保证空闲进程数最大值，如果空闲进程大于此值，此进行清理\n\n- pm.max_requests = 1000\n> 设置每个子进程重生之前服务的请求数. 对于可能存在内存泄漏的第三方模块来说是非常有用的. 如果设置为 '0' 则一直接受请求. 等同于 PHP_FCGI_MAX_REQUESTS 环境变量. 默认值: 0.\n\n- pm.status_path = /status\n> FPM状态页面的网址. 如果没有设置, 则无法访问状态页面. 默认值: none. munin监控会使用到\n\n- ping.path = /ping\n> FPM监控页面的ping网址. 如果没有设置, 则无法访问ping页面. 该页面用于外部检测FPM是否存活并且可以响应请求. 请注意必须以斜线开头 (/)。\n\n- ping.response = pong\n> 用于定义ping请求的返回相应. 返回为 HTTP 200 的 text/plain 格式文本. 默认值: pong.\n\n- request_terminate_timeout = 0\n> 设置单个请求的超时中止时间. 该选项可能会对php.ini设置中的'max_execution_time'因为某些特殊原因没有中止运行的脚本有用. 设置为 '0' 表示 'Off'.当经常出现502错误时可以尝试更改此选项。\n\n- request_slowlog_timeout = 10s\n> 当一个请求该设置的超时时间后，就会将对应的PHP调用堆栈信息完整写入到慢日志中. 设置为 '0' 表示 'Off'\n\n- slowlog = log/$pool.log.slow\n> 慢请求的记录日志,配合request_slowlog_timeout使用\n\n- rlimit_files = 1024\n> 设置文件打开描述符的rlimit限制. 默认值: 系统定义值默认可打开句柄是1024，可使用 ulimit -n查看，ulimit -n 2048修改。\n\n- rlimit_core = 0\n> 设置核心rlimit最大限制值. 可用值: 'unlimited' 、0或者正整数. 默认值: 系统定义值.\n\n- chroot =\n> 启动时的Chroot目录. 所定义的目录需要是绝对路径. 如果没有设置, 则chroot不被使用.\n\n- chdir =\n> 设置启动目录，启动时会自动Chdir到该目录. 所定义的目录需要是绝对路径. 默认值: 当前目录，或者/目录（chroot时）\n\n- catch_workers_output = yes\n> 重定向运行过程中的stdout和stderr到主要的错误日志文件中. 如果没有设置, stdout 和 stderr 将会根据FastCGI的规则被重定向到 /dev/null . 默认值: 空.\n\n\n**Tips** 配置完成之后可以通过 php-fpm -t 来检测配置是否基本正确。\n```\n# /usr/local/php56/sbin/php-fpm -t\n[25-Sep-2016 12:58:14] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful\n```\n\n### php-fpm管理\n\n测试php-fpm配置\n```\n/usr/local/php/sbin/php-fpm -t\n/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf -t\n```\n启动php-fpm\n```\n/usr/local/php/sbin/php-fpm\n/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf\n```\n关闭php-fpm\n```\nkill -INT `cat /usr/local/php/var/run/php-fpm.pid`\n```\n重启php-fpm\n```\nkill -USR2 `cat /usr/local/php/var/run/php-fpm.pid`\n```\n\n## 配置 Nginx 使其支持 PHP 应用：\n```\nvim /usr/local/nginx/conf/nginx.conf\n```\n修改默认的 location 块，使其支持 .php 文件：\n```\nlocation / {\n    root   html;\n    index  index.php index.html index.htm;\n}\n```\n下一步配置来保证对于 .php 文件的请求将被传送到后端的 PHP-FPM 模块， 取消默认的 PHP 配置块的注释，并修改为下面的内容：\n```\nlocation ~* \\.php$ {\n    fastcgi_index   index.php;\n    fastcgi_pass    127.0.0.1:9000;\n    include         fastcgi_params;\n    fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n    fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;\n}\n```\n重启 Nginx。\n```\n# /usr/local/nginx/sbin/nginx -t\nnginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful\n/usr/local/nginx/sbin/nginx -s reload\n```\n创建测试文件。\n```\necho \"<?php  phpinfo();?>\" > /usr/local/nginx/html/index.php\n```\n\n打开浏览器，访问 http://ip，将会显示 phpinfo() 。\n\n## 测试\n\n创建测试文件\n```\nvi mysql_conn_test.php\n```\n输入\n```php\n<?php\n$conn = mysql_connect(\"localhost\", \"root\", \"123456\") or die(\"connect failed\" . mysql_error());  \n$sql = sprintf(\"SHOW DATABASES;\");  \n$result = mysql_query($sql, $conn);  \nwhile ($row=mysql_fetch_array($result, MYSQL_ASSOC)){\n  print_r($row);\n}\n?>\n```\n结果如下，则说明，连接测试成功。\n```\nArray ( [Database] => information_schema ) Array ( [Database] => mysql ) Array ( [Database] => performance_schema ) Array ( [Database] => sys )\n```\n至此，LNMP环境算是基本配置成功。\n\nover~\n","source":"_posts/LNMP环境安装与配置.md","raw":"---\ntitle: LNMP环境安装与配置\ndate: 2016-09-25 23:30:00\nctime: 2016-09-25 23:30:00\nutime: 2016-09-25 23:30:00\nmodif_times: 0\ntags:\n- LNMP\ncategories:\n- PHP\n---\n\n![LNMP](http://n.sinaimg.cn/games/3ece443e/20160925/lnmp_log.png)\n<!-- more -->\n\n## 环境准备\n\nOS：CentOS 7.2 64\n\nMySQL：[mysql-5.7.15](http://dev.mysql.com/downloads/mysql/)\n\nNginx：[nginx-1.11.4](http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz)\n\nPHP：[php-5.6.25](http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz)\n\n## 安装\n参考MySQL、Nginx、PHP的编译安装，分别安装 MySQL、Nginx、PHP到Linux。\n\n## 整合\n\n### 启动 php-fpm\n\n新建用户和用户组，\n```\n# groupadd www-data\n# useradd -g www-data www-data\n```\n需要修改 php-fpm.conf 配置文件，确保 php-fpm 模块使用 www-data 用户和 www-data 用户组的身份运行。\n\n```\nvi /usr/local/php56/etc/php-fpm.conf\n#找到以下内容并修改：\n; Unix user/group of processes\n; Note: The user is mandatory. If the group is not set, the default user's group\n;       will be used.\nuser = www-data\ngroup = www-data\n```\n修改 pid 配置，以方便我们后面根据pid管理php-fpm\n```\n[global]\n; Pid file\n; Note: the default prefix is /usr/local/php56/var\n; Default Value: none\npid = run/php-fpm.pid\n```\nPHP-FPM运行时，将会在/usr/local/php56/var/run/下生成 php-fpm.pid 文件。\n\n然后启动 php-fpm 服务：\n```\n/usr/local/php56/sbin/php-fpm\n```\n查看是否启动成功\n```\nps aux | grep php\nroot     18858  0.0  0.1 148164  3208 ?        Ss   12:38   0:00 php-fpm: master process (/usr/local/php56/etc/php-fpm.conf)\nwww-data 18859  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www\nwww-data 18860  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www\nroot     18862  0.0  0.0 112664   972 pts/1    S+   12:38   0:00 grep --color=auto php\n```\n**注** 需要着重提醒的是，如果文件不存在，则阻止 Nginx 将请求发送到后端的 PHP-FPM 模块， 以避免遭受恶意脚本注入的攻击。\n将 php.ini 文件中的配置项 cgi.fix_pathinfo 设置为 0 。\n\n```\nvi /usr/local/php56/lib/php.ini\n\ncgi.fix_pathinfo=0\n```\n\n\n### PHP-FPM 重要配置\nphp-fpm.conf重要参数详解\n\n- pid = run/php-fpm.pid\n> pid设置，默认在安装目录中的var/run/php-fpm.pid，建议开启\n\n- error_log = log/php-fpm.log\n> 错误日志，默认在安装目录中的var/log/php-fpm.log\n\n- log_level = notice\n> 错误级别. 可用级别为: alert（必须立即处理）, error（错误情况）, warning（警告情况）, notice（一般重要信息）, debug（调试信息）. 默认: notice.\n\n- emergency_restart_threshold = 60\n- emergency_restart_interval = 60s\n> 表示在emergency_restart_interval所设值内出现SIGSEGV或者SIGBUS错误的php-cgi进程数如果超过 emergency_restart_threshold个，php-fpm就会优雅重启。这两个选项一般保持默认值。\n\n- process_control_timeout = 0\n> 设置子进程接受主进程复用信号的超时时间. 可用单位: s(秒), m(分), h(小时), 或者 d(天) 默认单位: s(秒). 默认值: 0.\n\n- daemonize = yes\n> 后台执行fpm,默认值为yes，如果为了调试可以改为no。在FPM中，可以使用不同的设置来运行多个进程池。 这些设置可以针对每个进程池单独设置。\n\n- listen = 127.0.0.1:9000\n> fpm监听端口，即nginx中php处理的地址，一般默认值即可。可用格式为: 'ip:port', 'port', '/path/to/unix/socket'. 每个进程池都需要设置.\n\n- listen.backlog = -1\n> backlog数，-1表示无限制，由操作系统决定，此行注释掉就行。\n\n- listen.allowed_clients = 127.0.0.1\n> 允许访问FastCGI进程的IP，设置any为不限制IP，如果要设置其他主机的nginx也能访问这台FPM进程，listen处要设置成本地可被访问的IP。默认值是any。每个地址是用逗号分隔. 如果没有设置或者为空，则允许任何服务器请求连接\n\n- listen.owner = www\n- listen.group = www\n- listen.mode = 0666\n> unix socket设置选项，如果使用tcp方式访问，这里注释即可。\n\n- user = www\n- group = www\n> 启动进程的帐户和组\n\n- pm = dynamic #对于专用服务器，pm可以设置为static。\n> 如何控制子进程，选项有static和dynamic。如果选择static，则由pm.max_children指定固定的子进程数。如果选择dynamic，则由下开参数决定：\n\n- pm.max_children #\n> 子进程最大数\n\n- pm.start_servers #\n> 启动时的进程数\n\n- pm.min_spare_servers #\n> 保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程\n\n- pm.max_spare_servers #\n> 保证空闲进程数最大值，如果空闲进程大于此值，此进行清理\n\n- pm.max_requests = 1000\n> 设置每个子进程重生之前服务的请求数. 对于可能存在内存泄漏的第三方模块来说是非常有用的. 如果设置为 '0' 则一直接受请求. 等同于 PHP_FCGI_MAX_REQUESTS 环境变量. 默认值: 0.\n\n- pm.status_path = /status\n> FPM状态页面的网址. 如果没有设置, 则无法访问状态页面. 默认值: none. munin监控会使用到\n\n- ping.path = /ping\n> FPM监控页面的ping网址. 如果没有设置, 则无法访问ping页面. 该页面用于外部检测FPM是否存活并且可以响应请求. 请注意必须以斜线开头 (/)。\n\n- ping.response = pong\n> 用于定义ping请求的返回相应. 返回为 HTTP 200 的 text/plain 格式文本. 默认值: pong.\n\n- request_terminate_timeout = 0\n> 设置单个请求的超时中止时间. 该选项可能会对php.ini设置中的'max_execution_time'因为某些特殊原因没有中止运行的脚本有用. 设置为 '0' 表示 'Off'.当经常出现502错误时可以尝试更改此选项。\n\n- request_slowlog_timeout = 10s\n> 当一个请求该设置的超时时间后，就会将对应的PHP调用堆栈信息完整写入到慢日志中. 设置为 '0' 表示 'Off'\n\n- slowlog = log/$pool.log.slow\n> 慢请求的记录日志,配合request_slowlog_timeout使用\n\n- rlimit_files = 1024\n> 设置文件打开描述符的rlimit限制. 默认值: 系统定义值默认可打开句柄是1024，可使用 ulimit -n查看，ulimit -n 2048修改。\n\n- rlimit_core = 0\n> 设置核心rlimit最大限制值. 可用值: 'unlimited' 、0或者正整数. 默认值: 系统定义值.\n\n- chroot =\n> 启动时的Chroot目录. 所定义的目录需要是绝对路径. 如果没有设置, 则chroot不被使用.\n\n- chdir =\n> 设置启动目录，启动时会自动Chdir到该目录. 所定义的目录需要是绝对路径. 默认值: 当前目录，或者/目录（chroot时）\n\n- catch_workers_output = yes\n> 重定向运行过程中的stdout和stderr到主要的错误日志文件中. 如果没有设置, stdout 和 stderr 将会根据FastCGI的规则被重定向到 /dev/null . 默认值: 空.\n\n\n**Tips** 配置完成之后可以通过 php-fpm -t 来检测配置是否基本正确。\n```\n# /usr/local/php56/sbin/php-fpm -t\n[25-Sep-2016 12:58:14] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful\n```\n\n### php-fpm管理\n\n测试php-fpm配置\n```\n/usr/local/php/sbin/php-fpm -t\n/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf -t\n```\n启动php-fpm\n```\n/usr/local/php/sbin/php-fpm\n/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf\n```\n关闭php-fpm\n```\nkill -INT `cat /usr/local/php/var/run/php-fpm.pid`\n```\n重启php-fpm\n```\nkill -USR2 `cat /usr/local/php/var/run/php-fpm.pid`\n```\n\n## 配置 Nginx 使其支持 PHP 应用：\n```\nvim /usr/local/nginx/conf/nginx.conf\n```\n修改默认的 location 块，使其支持 .php 文件：\n```\nlocation / {\n    root   html;\n    index  index.php index.html index.htm;\n}\n```\n下一步配置来保证对于 .php 文件的请求将被传送到后端的 PHP-FPM 模块， 取消默认的 PHP 配置块的注释，并修改为下面的内容：\n```\nlocation ~* \\.php$ {\n    fastcgi_index   index.php;\n    fastcgi_pass    127.0.0.1:9000;\n    include         fastcgi_params;\n    fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;\n    fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;\n}\n```\n重启 Nginx。\n```\n# /usr/local/nginx/sbin/nginx -t\nnginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful\n/usr/local/nginx/sbin/nginx -s reload\n```\n创建测试文件。\n```\necho \"<?php  phpinfo();?>\" > /usr/local/nginx/html/index.php\n```\n\n打开浏览器，访问 http://ip，将会显示 phpinfo() 。\n\n## 测试\n\n创建测试文件\n```\nvi mysql_conn_test.php\n```\n输入\n```php\n<?php\n$conn = mysql_connect(\"localhost\", \"root\", \"123456\") or die(\"connect failed\" . mysql_error());  \n$sql = sprintf(\"SHOW DATABASES;\");  \n$result = mysql_query($sql, $conn);  \nwhile ($row=mysql_fetch_array($result, MYSQL_ASSOC)){\n  print_r($row);\n}\n?>\n```\n结果如下，则说明，连接测试成功。\n```\nArray ( [Database] => information_schema ) Array ( [Database] => mysql ) Array ( [Database] => performance_schema ) Array ( [Database] => sys )\n```\n至此，LNMP环境算是基本配置成功。\n\nover~\n","slug":"LNMP环境安装与配置","published":1,"updated":"2016-09-26T13:16:26.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwuw000h699flflv9svx","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/lnmp_log.png\" alt=\"LNMP\"><br><a id=\"more\"></a></p>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><p>OS：CentOS 7.2 64</p>\n<p>MySQL：<a href=\"http://dev.mysql.com/downloads/mysql/\" target=\"_blank\" rel=\"external\">mysql-5.7.15</a></p>\n<p>Nginx：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz\" target=\"_blank\" rel=\"external\">nginx-1.11.4</a></p>\n<p>PHP：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz\" target=\"_blank\" rel=\"external\">php-5.6.25</a></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>参考MySQL、Nginx、PHP的编译安装，分别安装 MySQL、Nginx、PHP到Linux。</p>\n<h2 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h2><h3 id=\"启动-php-fpm\"><a href=\"#启动-php-fpm\" class=\"headerlink\" title=\"启动 php-fpm\"></a>启动 php-fpm</h3><p>新建用户和用户组，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># groupadd www-data</div><div class=\"line\"># useradd -g www-data www-data</div></pre></td></tr></table></figure></p>\n<p>需要修改 php-fpm.conf 配置文件，确保 php-fpm 模块使用 www-data 用户和 www-data 用户组的身份运行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/etc/php-fpm.conf</div><div class=\"line\">#找到以下内容并修改：</div><div class=\"line\">; Unix user/group of processes</div><div class=\"line\">; Note: The user is mandatory. If the group is not set, the default user&apos;s group</div><div class=\"line\">;       will be used.</div><div class=\"line\">user = www-data</div><div class=\"line\">group = www-data</div></pre></td></tr></table></figure>\n<p>修改 pid 配置，以方便我们后面根据pid管理php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[global]</div><div class=\"line\">; Pid file</div><div class=\"line\">; Note: the default prefix is /usr/local/php56/var</div><div class=\"line\">; Default Value: none</div><div class=\"line\">pid = run/php-fpm.pid</div></pre></td></tr></table></figure></p>\n<p>PHP-FPM运行时，将会在/usr/local/php56/var/run/下生成 php-fpm.pid 文件。</p>\n<p>然后启动 php-fpm 服务：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php56/sbin/php-fpm</div></pre></td></tr></table></figure></p>\n<p>查看是否启动成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux | grep php</div><div class=\"line\">root     18858  0.0  0.1 148164  3208 ?        Ss   12:38   0:00 php-fpm: master process (/usr/local/php56/etc/php-fpm.conf)</div><div class=\"line\">www-data 18859  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www</div><div class=\"line\">www-data 18860  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www</div><div class=\"line\">root     18862  0.0  0.0 112664   972 pts/1    S+   12:38   0:00 grep --color=auto php</div></pre></td></tr></table></figure></p>\n<p><strong>注</strong> 需要着重提醒的是，如果文件不存在，则阻止 Nginx 将请求发送到后端的 PHP-FPM 模块， 以避免遭受恶意脚本注入的攻击。<br>将 php.ini 文件中的配置项 cgi.fix_pathinfo 设置为 0 。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/lib/php.ini</div><div class=\"line\"></div><div class=\"line\">cgi.fix_pathinfo=0</div></pre></td></tr></table></figure>\n<h3 id=\"PHP-FPM-重要配置\"><a href=\"#PHP-FPM-重要配置\" class=\"headerlink\" title=\"PHP-FPM 重要配置\"></a>PHP-FPM 重要配置</h3><p>php-fpm.conf重要参数详解</p>\n<ul>\n<li><p>pid = run/php-fpm.pid</p>\n<blockquote>\n<p>pid设置，默认在安装目录中的var/run/php-fpm.pid，建议开启</p>\n</blockquote>\n</li>\n<li><p>error_log = log/php-fpm.log</p>\n<blockquote>\n<p>错误日志，默认在安装目录中的var/log/php-fpm.log</p>\n</blockquote>\n</li>\n<li><p>log_level = notice</p>\n<blockquote>\n<p>错误级别. 可用级别为: alert（必须立即处理）, error（错误情况）, warning（警告情况）, notice（一般重要信息）, debug（调试信息）. 默认: notice.</p>\n</blockquote>\n</li>\n<li><p>emergency_restart_threshold = 60</p>\n</li>\n<li><p>emergency_restart_interval = 60s</p>\n<blockquote>\n<p>表示在emergency_restart_interval所设值内出现SIGSEGV或者SIGBUS错误的php-cgi进程数如果超过 emergency_restart_threshold个，php-fpm就会优雅重启。这两个选项一般保持默认值。</p>\n</blockquote>\n</li>\n<li><p>process_control_timeout = 0</p>\n<blockquote>\n<p>设置子进程接受主进程复用信号的超时时间. 可用单位: s(秒), m(分), h(小时), 或者 d(天) 默认单位: s(秒). 默认值: 0.</p>\n</blockquote>\n</li>\n<li><p>daemonize = yes</p>\n<blockquote>\n<p>后台执行fpm,默认值为yes，如果为了调试可以改为no。在FPM中，可以使用不同的设置来运行多个进程池。 这些设置可以针对每个进程池单独设置。</p>\n</blockquote>\n</li>\n<li><p>listen = 127.0.0.1:9000</p>\n<blockquote>\n<p>fpm监听端口，即nginx中php处理的地址，一般默认值即可。可用格式为: ‘ip:port’, ‘port’, ‘/path/to/unix/socket’. 每个进程池都需要设置.</p>\n</blockquote>\n</li>\n<li><p>listen.backlog = -1</p>\n<blockquote>\n<p>backlog数，-1表示无限制，由操作系统决定，此行注释掉就行。</p>\n</blockquote>\n</li>\n<li><p>listen.allowed_clients = 127.0.0.1</p>\n<blockquote>\n<p>允许访问FastCGI进程的IP，设置any为不限制IP，如果要设置其他主机的nginx也能访问这台FPM进程，listen处要设置成本地可被访问的IP。默认值是any。每个地址是用逗号分隔. 如果没有设置或者为空，则允许任何服务器请求连接</p>\n</blockquote>\n</li>\n<li><p>listen.owner = www</p>\n</li>\n<li>listen.group = www</li>\n<li><p>listen.mode = 0666</p>\n<blockquote>\n<p>unix socket设置选项，如果使用tcp方式访问，这里注释即可。</p>\n</blockquote>\n</li>\n<li><p>user = www</p>\n</li>\n<li><p>group = www</p>\n<blockquote>\n<p>启动进程的帐户和组</p>\n</blockquote>\n</li>\n<li><p>pm = dynamic #对于专用服务器，pm可以设置为static。</p>\n<blockquote>\n<p>如何控制子进程，选项有static和dynamic。如果选择static，则由pm.max_children指定固定的子进程数。如果选择dynamic，则由下开参数决定：</p>\n</blockquote>\n</li>\n<li><p>pm.max_children #</p>\n<blockquote>\n<p>子进程最大数</p>\n</blockquote>\n</li>\n<li><p>pm.start_servers #</p>\n<blockquote>\n<p>启动时的进程数</p>\n</blockquote>\n</li>\n<li><p>pm.min_spare_servers #</p>\n<blockquote>\n<p>保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程</p>\n</blockquote>\n</li>\n<li><p>pm.max_spare_servers #</p>\n<blockquote>\n<p>保证空闲进程数最大值，如果空闲进程大于此值，此进行清理</p>\n</blockquote>\n</li>\n<li><p>pm.max_requests = 1000</p>\n<blockquote>\n<p>设置每个子进程重生之前服务的请求数. 对于可能存在内存泄漏的第三方模块来说是非常有用的. 如果设置为 ‘0’ 则一直接受请求. 等同于 PHP_FCGI_MAX_REQUESTS 环境变量. 默认值: 0.</p>\n</blockquote>\n</li>\n<li><p>pm.status_path = /status</p>\n<blockquote>\n<p>FPM状态页面的网址. 如果没有设置, 则无法访问状态页面. 默认值: none. munin监控会使用到</p>\n</blockquote>\n</li>\n<li><p>ping.path = /ping</p>\n<blockquote>\n<p>FPM监控页面的ping网址. 如果没有设置, 则无法访问ping页面. 该页面用于外部检测FPM是否存活并且可以响应请求. 请注意必须以斜线开头 (/)。</p>\n</blockquote>\n</li>\n<li><p>ping.response = pong</p>\n<blockquote>\n<p>用于定义ping请求的返回相应. 返回为 HTTP 200 的 text/plain 格式文本. 默认值: pong.</p>\n</blockquote>\n</li>\n<li><p>request_terminate_timeout = 0</p>\n<blockquote>\n<p>设置单个请求的超时中止时间. 该选项可能会对php.ini设置中的’max_execution_time’因为某些特殊原因没有中止运行的脚本有用. 设置为 ‘0’ 表示 ‘Off’.当经常出现502错误时可以尝试更改此选项。</p>\n</blockquote>\n</li>\n<li><p>request_slowlog_timeout = 10s</p>\n<blockquote>\n<p>当一个请求该设置的超时时间后，就会将对应的PHP调用堆栈信息完整写入到慢日志中. 设置为 ‘0’ 表示 ‘Off’</p>\n</blockquote>\n</li>\n<li><p>slowlog = log/$pool.log.slow</p>\n<blockquote>\n<p>慢请求的记录日志,配合request_slowlog_timeout使用</p>\n</blockquote>\n</li>\n<li><p>rlimit_files = 1024</p>\n<blockquote>\n<p>设置文件打开描述符的rlimit限制. 默认值: 系统定义值默认可打开句柄是1024，可使用 ulimit -n查看，ulimit -n 2048修改。</p>\n</blockquote>\n</li>\n<li><p>rlimit_core = 0</p>\n<blockquote>\n<p>设置核心rlimit最大限制值. 可用值: ‘unlimited’ 、0或者正整数. 默认值: 系统定义值.</p>\n</blockquote>\n</li>\n<li><p>chroot =</p>\n<blockquote>\n<p>启动时的Chroot目录. 所定义的目录需要是绝对路径. 如果没有设置, 则chroot不被使用.</p>\n</blockquote>\n</li>\n<li><p>chdir =</p>\n<blockquote>\n<p>设置启动目录，启动时会自动Chdir到该目录. 所定义的目录需要是绝对路径. 默认值: 当前目录，或者/目录（chroot时）</p>\n</blockquote>\n</li>\n<li><p>catch_workers_output = yes</p>\n<blockquote>\n<p>重定向运行过程中的stdout和stderr到主要的错误日志文件中. 如果没有设置, stdout 和 stderr 将会根据FastCGI的规则被重定向到 /dev/null . 默认值: 空.</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>Tips</strong> 配置完成之后可以通过 php-fpm -t 来检测配置是否基本正确。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/php56/sbin/php-fpm -t</div><div class=\"line\">[25-Sep-2016 12:58:14] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>\n<h3 id=\"php-fpm管理\"><a href=\"#php-fpm管理\" class=\"headerlink\" title=\"php-fpm管理\"></a>php-fpm管理</h3><p>测试php-fpm配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php/sbin/php-fpm -t</div><div class=\"line\">/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf -t</div></pre></td></tr></table></figure></p>\n<p>启动php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php/sbin/php-fpm</div><div class=\"line\">/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>\n<p>关闭php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -INT `cat /usr/local/php/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<p>重启php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置-Nginx-使其支持-PHP-应用：\"><a href=\"#配置-Nginx-使其支持-PHP-应用：\" class=\"headerlink\" title=\"配置 Nginx 使其支持 PHP 应用：\"></a>配置 Nginx 使其支持 PHP 应用：</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vim /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure>\n<p>修改默认的 location 块，使其支持 .php 文件：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">location / &#123;</div><div class=\"line\">    root   html;</div><div class=\"line\">    index  index.php index.html index.htm;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>下一步配置来保证对于 .php 文件的请求将被传送到后端的 PHP-FPM 模块， 取消默认的 PHP 配置块的注释，并修改为下面的内容：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">location ~* \\.php$ &#123;</div><div class=\"line\">    fastcgi_index   index.php;</div><div class=\"line\">    fastcgi_pass    127.0.0.1:9000;</div><div class=\"line\">    include         fastcgi_params;</div><div class=\"line\">    fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;</div><div class=\"line\">    fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>重启 Nginx。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/nginx/sbin/nginx -t</div><div class=\"line\">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</div><div class=\"line\">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure></p>\n<p>创建测试文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;&lt;?php  phpinfo();?&gt;&quot; &gt; /usr/local/nginx/html/index.php</div></pre></td></tr></table></figure></p>\n<p>打开浏览器，访问 <a href=\"http://ip，将会显示\" target=\"_blank\" rel=\"external\">http://ip，将会显示</a> phpinfo() 。</p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>创建测试文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi mysql_conn_test.php</div></pre></td></tr></table></figure></p>\n<p>输入<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">$conn = mysql_connect(<span class=\"string\">\"localhost\"</span>, <span class=\"string\">\"root\"</span>, <span class=\"string\">\"123456\"</span>) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"connect failed\"</span> . mysql_error());  </div><div class=\"line\">$sql = sprintf(<span class=\"string\">\"SHOW DATABASES;\"</span>);  </div><div class=\"line\">$result = mysql_query($sql, $conn);  </div><div class=\"line\"><span class=\"keyword\">while</span> ($row=mysql_fetch_array($result, MYSQL_ASSOC))&#123;</div><div class=\"line\">  print_r($row);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p>结果如下，则说明，连接测试成功。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Array ( [Database] =&gt; information_schema ) Array ( [Database] =&gt; mysql ) Array ( [Database] =&gt; performance_schema ) Array ( [Database] =&gt; sys )</div></pre></td></tr></table></figure></p>\n<p>至此，LNMP环境算是基本配置成功。</p>\n<p>over~</p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/lnmp_log.png\" alt=\"LNMP\"><br>","more":"</p>\n<h2 id=\"环境准备\"><a href=\"#环境准备\" class=\"headerlink\" title=\"环境准备\"></a>环境准备</h2><p>OS：CentOS 7.2 64</p>\n<p>MySQL：<a href=\"http://dev.mysql.com/downloads/mysql/\">mysql-5.7.15</a></p>\n<p>Nginx：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz\">nginx-1.11.4</a></p>\n<p>PHP：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz\">php-5.6.25</a></p>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><p>参考MySQL、Nginx、PHP的编译安装，分别安装 MySQL、Nginx、PHP到Linux。</p>\n<h2 id=\"整合\"><a href=\"#整合\" class=\"headerlink\" title=\"整合\"></a>整合</h2><h3 id=\"启动-php-fpm\"><a href=\"#启动-php-fpm\" class=\"headerlink\" title=\"启动 php-fpm\"></a>启动 php-fpm</h3><p>新建用户和用户组，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># groupadd www-data</div><div class=\"line\"># useradd -g www-data www-data</div></pre></td></tr></table></figure></p>\n<p>需要修改 php-fpm.conf 配置文件，确保 php-fpm 模块使用 www-data 用户和 www-data 用户组的身份运行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/etc/php-fpm.conf</div><div class=\"line\">#找到以下内容并修改：</div><div class=\"line\">; Unix user/group of processes</div><div class=\"line\">; Note: The user is mandatory. If the group is not set, the default user&apos;s group</div><div class=\"line\">;       will be used.</div><div class=\"line\">user = www-data</div><div class=\"line\">group = www-data</div></pre></td></tr></table></figure>\n<p>修改 pid 配置，以方便我们后面根据pid管理php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[global]</div><div class=\"line\">; Pid file</div><div class=\"line\">; Note: the default prefix is /usr/local/php56/var</div><div class=\"line\">; Default Value: none</div><div class=\"line\">pid = run/php-fpm.pid</div></pre></td></tr></table></figure></p>\n<p>PHP-FPM运行时，将会在/usr/local/php56/var/run/下生成 php-fpm.pid 文件。</p>\n<p>然后启动 php-fpm 服务：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php56/sbin/php-fpm</div></pre></td></tr></table></figure></p>\n<p>查看是否启动成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux | grep php</div><div class=\"line\">root     18858  0.0  0.1 148164  3208 ?        Ss   12:38   0:00 php-fpm: master process (/usr/local/php56/etc/php-fpm.conf)</div><div class=\"line\">www-data 18859  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www</div><div class=\"line\">www-data 18860  0.0  0.1 148164  2856 ?        S    12:38   0:00 php-fpm: pool www</div><div class=\"line\">root     18862  0.0  0.0 112664   972 pts/1    S+   12:38   0:00 grep --color=auto php</div></pre></td></tr></table></figure></p>\n<p><strong>注</strong> 需要着重提醒的是，如果文件不存在，则阻止 Nginx 将请求发送到后端的 PHP-FPM 模块， 以避免遭受恶意脚本注入的攻击。<br>将 php.ini 文件中的配置项 cgi.fix_pathinfo 设置为 0 。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/lib/php.ini</div><div class=\"line\"></div><div class=\"line\">cgi.fix_pathinfo=0</div></pre></td></tr></table></figure>\n<h3 id=\"PHP-FPM-重要配置\"><a href=\"#PHP-FPM-重要配置\" class=\"headerlink\" title=\"PHP-FPM 重要配置\"></a>PHP-FPM 重要配置</h3><p>php-fpm.conf重要参数详解</p>\n<ul>\n<li><p>pid = run/php-fpm.pid</p>\n<blockquote>\n<p>pid设置，默认在安装目录中的var/run/php-fpm.pid，建议开启</p>\n</blockquote>\n</li>\n<li><p>error_log = log/php-fpm.log</p>\n<blockquote>\n<p>错误日志，默认在安装目录中的var/log/php-fpm.log</p>\n</blockquote>\n</li>\n<li><p>log_level = notice</p>\n<blockquote>\n<p>错误级别. 可用级别为: alert（必须立即处理）, error（错误情况）, warning（警告情况）, notice（一般重要信息）, debug（调试信息）. 默认: notice.</p>\n</blockquote>\n</li>\n<li><p>emergency_restart_threshold = 60</p>\n</li>\n<li><p>emergency_restart_interval = 60s</p>\n<blockquote>\n<p>表示在emergency_restart_interval所设值内出现SIGSEGV或者SIGBUS错误的php-cgi进程数如果超过 emergency_restart_threshold个，php-fpm就会优雅重启。这两个选项一般保持默认值。</p>\n</blockquote>\n</li>\n<li><p>process_control_timeout = 0</p>\n<blockquote>\n<p>设置子进程接受主进程复用信号的超时时间. 可用单位: s(秒), m(分), h(小时), 或者 d(天) 默认单位: s(秒). 默认值: 0.</p>\n</blockquote>\n</li>\n<li><p>daemonize = yes</p>\n<blockquote>\n<p>后台执行fpm,默认值为yes，如果为了调试可以改为no。在FPM中，可以使用不同的设置来运行多个进程池。 这些设置可以针对每个进程池单独设置。</p>\n</blockquote>\n</li>\n<li><p>listen = 127.0.0.1:9000</p>\n<blockquote>\n<p>fpm监听端口，即nginx中php处理的地址，一般默认值即可。可用格式为: ‘ip:port’, ‘port’, ‘/path/to/unix/socket’. 每个进程池都需要设置.</p>\n</blockquote>\n</li>\n<li><p>listen.backlog = -1</p>\n<blockquote>\n<p>backlog数，-1表示无限制，由操作系统决定，此行注释掉就行。</p>\n</blockquote>\n</li>\n<li><p>listen.allowed_clients = 127.0.0.1</p>\n<blockquote>\n<p>允许访问FastCGI进程的IP，设置any为不限制IP，如果要设置其他主机的nginx也能访问这台FPM进程，listen处要设置成本地可被访问的IP。默认值是any。每个地址是用逗号分隔. 如果没有设置或者为空，则允许任何服务器请求连接</p>\n</blockquote>\n</li>\n<li><p>listen.owner = www</p>\n</li>\n<li>listen.group = www</li>\n<li><p>listen.mode = 0666</p>\n<blockquote>\n<p>unix socket设置选项，如果使用tcp方式访问，这里注释即可。</p>\n</blockquote>\n</li>\n<li><p>user = www</p>\n</li>\n<li><p>group = www</p>\n<blockquote>\n<p>启动进程的帐户和组</p>\n</blockquote>\n</li>\n<li><p>pm = dynamic #对于专用服务器，pm可以设置为static。</p>\n<blockquote>\n<p>如何控制子进程，选项有static和dynamic。如果选择static，则由pm.max_children指定固定的子进程数。如果选择dynamic，则由下开参数决定：</p>\n</blockquote>\n</li>\n<li><p>pm.max_children #</p>\n<blockquote>\n<p>子进程最大数</p>\n</blockquote>\n</li>\n<li><p>pm.start_servers #</p>\n<blockquote>\n<p>启动时的进程数</p>\n</blockquote>\n</li>\n<li><p>pm.min_spare_servers #</p>\n<blockquote>\n<p>保证空闲进程数最小值，如果空闲进程小于此值，则创建新的子进程</p>\n</blockquote>\n</li>\n<li><p>pm.max_spare_servers #</p>\n<blockquote>\n<p>保证空闲进程数最大值，如果空闲进程大于此值，此进行清理</p>\n</blockquote>\n</li>\n<li><p>pm.max_requests = 1000</p>\n<blockquote>\n<p>设置每个子进程重生之前服务的请求数. 对于可能存在内存泄漏的第三方模块来说是非常有用的. 如果设置为 ‘0’ 则一直接受请求. 等同于 PHP_FCGI_MAX_REQUESTS 环境变量. 默认值: 0.</p>\n</blockquote>\n</li>\n<li><p>pm.status_path = /status</p>\n<blockquote>\n<p>FPM状态页面的网址. 如果没有设置, 则无法访问状态页面. 默认值: none. munin监控会使用到</p>\n</blockquote>\n</li>\n<li><p>ping.path = /ping</p>\n<blockquote>\n<p>FPM监控页面的ping网址. 如果没有设置, 则无法访问ping页面. 该页面用于外部检测FPM是否存活并且可以响应请求. 请注意必须以斜线开头 (/)。</p>\n</blockquote>\n</li>\n<li><p>ping.response = pong</p>\n<blockquote>\n<p>用于定义ping请求的返回相应. 返回为 HTTP 200 的 text/plain 格式文本. 默认值: pong.</p>\n</blockquote>\n</li>\n<li><p>request_terminate_timeout = 0</p>\n<blockquote>\n<p>设置单个请求的超时中止时间. 该选项可能会对php.ini设置中的’max_execution_time’因为某些特殊原因没有中止运行的脚本有用. 设置为 ‘0’ 表示 ‘Off’.当经常出现502错误时可以尝试更改此选项。</p>\n</blockquote>\n</li>\n<li><p>request_slowlog_timeout = 10s</p>\n<blockquote>\n<p>当一个请求该设置的超时时间后，就会将对应的PHP调用堆栈信息完整写入到慢日志中. 设置为 ‘0’ 表示 ‘Off’</p>\n</blockquote>\n</li>\n<li><p>slowlog = log/$pool.log.slow</p>\n<blockquote>\n<p>慢请求的记录日志,配合request_slowlog_timeout使用</p>\n</blockquote>\n</li>\n<li><p>rlimit_files = 1024</p>\n<blockquote>\n<p>设置文件打开描述符的rlimit限制. 默认值: 系统定义值默认可打开句柄是1024，可使用 ulimit -n查看，ulimit -n 2048修改。</p>\n</blockquote>\n</li>\n<li><p>rlimit_core = 0</p>\n<blockquote>\n<p>设置核心rlimit最大限制值. 可用值: ‘unlimited’ 、0或者正整数. 默认值: 系统定义值.</p>\n</blockquote>\n</li>\n<li><p>chroot =</p>\n<blockquote>\n<p>启动时的Chroot目录. 所定义的目录需要是绝对路径. 如果没有设置, 则chroot不被使用.</p>\n</blockquote>\n</li>\n<li><p>chdir =</p>\n<blockquote>\n<p>设置启动目录，启动时会自动Chdir到该目录. 所定义的目录需要是绝对路径. 默认值: 当前目录，或者/目录（chroot时）</p>\n</blockquote>\n</li>\n<li><p>catch_workers_output = yes</p>\n<blockquote>\n<p>重定向运行过程中的stdout和stderr到主要的错误日志文件中. 如果没有设置, stdout 和 stderr 将会根据FastCGI的规则被重定向到 /dev/null . 默认值: 空.</p>\n</blockquote>\n</li>\n</ul>\n<p><strong>Tips</strong> 配置完成之后可以通过 php-fpm -t 来检测配置是否基本正确。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/php56/sbin/php-fpm -t</div><div class=\"line\">[25-Sep-2016 12:58:14] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>\n<h3 id=\"php-fpm管理\"><a href=\"#php-fpm管理\" class=\"headerlink\" title=\"php-fpm管理\"></a>php-fpm管理</h3><p>测试php-fpm配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php/sbin/php-fpm -t</div><div class=\"line\">/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf -t</div></pre></td></tr></table></figure></p>\n<p>启动php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php/sbin/php-fpm</div><div class=\"line\">/usr/local/php/sbin/php-fpm -c /usr/local/php/etc/php.ini -y /usr/local/php/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>\n<p>关闭php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -INT `cat /usr/local/php/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<p>重启php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置-Nginx-使其支持-PHP-应用：\"><a href=\"#配置-Nginx-使其支持-PHP-应用：\" class=\"headerlink\" title=\"配置 Nginx 使其支持 PHP 应用：\"></a>配置 Nginx 使其支持 PHP 应用：</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vim /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure>\n<p>修改默认的 location 块，使其支持 .php 文件：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">location / &#123;</div><div class=\"line\">    root   html;</div><div class=\"line\">    index  index.php index.html index.htm;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>下一步配置来保证对于 .php 文件的请求将被传送到后端的 PHP-FPM 模块， 取消默认的 PHP 配置块的注释，并修改为下面的内容：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">location ~* \\.php$ &#123;</div><div class=\"line\">    fastcgi_index   index.php;</div><div class=\"line\">    fastcgi_pass    127.0.0.1:9000;</div><div class=\"line\">    include         fastcgi_params;</div><div class=\"line\">    fastcgi_param   SCRIPT_FILENAME    $document_root$fastcgi_script_name;</div><div class=\"line\">    fastcgi_param   SCRIPT_NAME        $fastcgi_script_name;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>重启 Nginx。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/nginx/sbin/nginx -t</div><div class=\"line\">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</div><div class=\"line\">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure></p>\n<p>创建测试文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;&lt;?php  phpinfo();?&gt;&quot; &gt; /usr/local/nginx/html/index.php</div></pre></td></tr></table></figure></p>\n<p>打开浏览器，访问 <a href=\"http://ip，将会显示\">http://ip，将会显示</a> phpinfo() 。</p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>创建测试文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi mysql_conn_test.php</div></pre></td></tr></table></figure></p>\n<p>输入<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">$conn = mysql_connect(<span class=\"string\">\"localhost\"</span>, <span class=\"string\">\"root\"</span>, <span class=\"string\">\"123456\"</span>) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"connect failed\"</span> . mysql_error());  </div><div class=\"line\">$sql = sprintf(<span class=\"string\">\"SHOW DATABASES;\"</span>);  </div><div class=\"line\">$result = mysql_query($sql, $conn);  </div><div class=\"line\"><span class=\"keyword\">while</span> ($row=mysql_fetch_array($result, MYSQL_ASSOC))&#123;</div><div class=\"line\">  print_r($row);</div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p>结果如下，则说明，连接测试成功。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Array ( [Database] =&gt; information_schema ) Array ( [Database] =&gt; mysql ) Array ( [Database] =&gt; performance_schema ) Array ( [Database] =&gt; sys )</div></pre></td></tr></table></figure></p>\n<p>至此，LNMP环境算是基本配置成功。</p>\n<p>over~</p>"},{"title":"GIT使用小结","date":"2016-09-21T15:30:00.000Z","ctime":"2016-09-21T15:30:00.000Z","utime":"2016-09-23T15:30:00.000Z","modif_times":2,"_content":"\n## 概念\n在使用之前先明确两个概念。\n- 工作区（working directory）\n> 我们创建的文件夹\n\n- 版本库（Repository）\n> 一个工作区中隐藏的目录（.git）这个目录不算工作区\n版本库\n>   - stage，暂存区\n>   - master，分支\n>\n> 日常我们进行git add操作，是将文件修改添加到了暂存区，而进行git commit操作，则是将暂存区中的修改提交至当前分支。\n\n<!-- more -->\n\n## 常用操作\n1. 创建项目文件夹\n```bash\nmkdir demo\n```\n2. 进入项目目录\n```\ncd demo\ngit init（将该目录变成git可以管理的仓库（repository））\n```\n初始化后，该目录下会产生一个.git 的隐藏文件夹。\n\n3. 添加文件到仓库\n```\ngit add 文件\n```\n添加一个文件到仓库。\n其实，该操作作用是将文件添加至Stage暂存区。\n\n  常用操作\n```bash\ngit add .   #将所有文件添加至 stage\ngit add -u  #将所有文件添加至 stage ，同时将工作区中删除的文件也从仓库中删除。\n```\n4. git commit  提交到版本库\n```\ngit commit -m \"write readme file\"\n```\n-m 为对本次版本提交的说明\n\n5. git status 查看当前版本库状态\n```bash\n$ mkdir git_test\n$ cd git_test\n$ git init\n# Initialized empty Git repository in /Users/zhimiao/WWW/hexo/git_test/.git/\n$ ll -a\n# total 0\n# drwxr-xr-x   3 zhimiao  staff   102B  9 23 10:25 .\n# drwxr-xr-x   6 zhimiao  staff   204B  9 23 10:25 ..\n# drwxr-xr-x  10 zhimiao  staff   340B  9 23 10:25 .git\n$ git status\n# On branch master\n# Initial commit\n# nothing to commit (create/copy files and use \"git add\" to track)\n```\n  - git将所有的文件分为3类：已追踪的，被忽略的，和未追踪的。\n    - 已追踪的（tracked）\n > 已追踪的文件是指已经在版本库中的文件，或者是已暂存到索引中的文件。即，一个文件通过执行git add，就会被添加到暂存区，该文件就变成一个已追踪的文件。\n    - 被忽略的（ignored）\n  > 被忽略的文件是指在版本库中被明确声明为不可见或者被忽略。一般通过在工作区新建 `.gitignore` 文件来来声明。\n  > ```\n> $ cat .gitignore\n.DS_Store\nThumbs.db\ndb.json\n*.log\nnode_modules/\npublic/\n.deploy*/\n> ```\n    - 未追踪的（untracked）\n  > 未追踪的文件是指那些不在前两类中的文件。git把工作目录下的所有文件当成一个集合，减去已经追踪的文件和忽略的文件，剩下的部分就作为未追踪的文件。\n\n  ```\n$ echo \"git test\" > readme.md\n$ git status\n# On branch master\n# Initial commit\n# Untracked files:\n#   (use \"git add <file>...\" to include in what will be committed)\n# \treadme.md\n# nothing added to commit but untracked files present (use \"git add\" to track)\n$ git add readme.md\n$ git status\n# On branch master\n# Initial commit\n# Changes to be committed:\n#   (use \"git rm --cached <file>...\" to unstage)\n# \tnew file:   readme.md\n$ git commit -m \"add readme file\"\n# [master (root-commit) 81c90a0] add readme file\n#  1 file changed, 1 insertion(+)\n#  create mode 100644 readme.md\n$ git status\n#  On branch master\n#  nothing to commit, working directory clean\n```\n\n6. git diff 显示当前尚未缓存的改动记录\n```\n$ echo \"Second Line \" >> readme.md\n$ git diff\n# diff --git a/readme.md b/readme.md\n# index f6edd6e..a1e649c 100644\n# --- a/readme.md\n# +++ b/readme.md\n# @@ -1 +1,2 @@\n#  git test\n# +add new Line\n```\n在开头，原始文件被『--』符号标记起来，新文件被用『+++』标记。@@ 之间表示两个不同文件版本的上下文行，以减号（-）开始的行表示从原始文件删除该行以得到新文件。相反，以加号（+）开始的行表示从原始文件中添加该行以产生新文件，而以空格开始的行则表示两个版本都有的行。\n\n7. git log 记录每次commit的信息\n```\n$ git add readme.md\n$ git commit -m \"update\"\n$ echo \"third Lines;\" >> readme.md\n$ git add readme.md\n$ git commit -m \"update third\"\n$ git log\n# commit 2ba4ebfe3ccef91f0d34646f5a0e50e339ee6f7a\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 11:21:24 2016 +0800\n#\n#     update third\n#\n# commit ed0fe412477c8ac828e450cbc319c06ac8db0445\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 11:19:34 2016 +0800\n#\n#     update\n#\n# commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 10:42:58 2016 +0800\n#\n#     add readme file\n```\n8. git reset 修改命令\n```\ngit reset HEAD    废除本次修改，回到上次提交的状态\ngit reset -hard [commit id]\n```\n```\n$ git reset --hard HEAD^\n# HEAD is now at 7563423 update\n$ git log   \n# commit ed0fe412477c8ac828e450cbc319c06ac8db0445\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 11:19:34 2016 +0800\n#\n#     update\n#\n# commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 10:42:58 2016 +0800\n#\n#     add readme file\n#\n$ cat readme.md\n# git test\n# Second Lines;\n```\n然后我们就回到了上一次提交的版本。\n\n9. git rm 删除所有版本库记录（慎用）\n\n\n## 从远程库克隆\ngit clone 克隆一个本地库\n```\n$ git clone git@github.com:weizhimiao/git_test.git\n# Cloning into 'git_test'...\n# remote: Counting objects: 3, done.\n# remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0\n# Receiving objects: 100% (3/3), done.\n# Checking connectivity... done.\n$ ll\n# drwxr-xr-x  4 zhimiao  staff   136B  9 23 21:53 git_test\n$ cd git_test\n$ ll\n# -rw-r--r--  1 zhimiao  staff    12B  9 23 21:53 README.md\n$ git status\n# On branch master\n# Your branch is up-to-date with 'origin/master'.\n# nothing to commit, working directory clean\n```\n## 关联远程库\n> 本地仓库名：git_test\n> 远程仓库名：git_test\n> 在本地git_test仓库下执行\n\n```\n$ git remote add origin git@github.com:weizhimiao/git_test.git\n```\n> weizhimiao 是github账户名\n> origin 为远程仓库的名字，git的默认叫法\n\n将本地所有的内容推送到远程库上\n```\ngit push -u origin master 把本地master分支推送到远程库\n-u 为把本地master 分支和远程master分支关联起来，之后就可以通过以下命令进行推送了\ngit push origin master\n```\n\n## 分享与更新项目\n1. git push origin dev  提交到远程dev分支\n\n\n2. git pull origin dev  拉取远程dev分支到本地并和本地dev分支合并\n\n3. git remote add origin git@github.com:weizhimiao/git_test.git  将本地仓库推送至名为test的仓库里\n\n## 分支管理\n创建：\n```\n$ git branch dev\n$ git branch\n#   dev\n# * master\n$ git checkout dev\n# Switched to branch 'dev'\n#\n$ git branch\n# * dev\n#   master\n```\n> git branch dev 创建dev分支\n> git checkout dev  切换当前分支\n\n等价于\n```\n$ git checkout -b dev 创建并切换到dev分支\n```\n```\n# git branch 查看当前分支\n# git branch -a 查看本地和远程所有分支\n# git branch -r 常看远程分支\n# git branch -d 删除本地分支\n# git checkout master 用于dev分支完成工作后，切换回master 分支\n#\n# git merge 分支合并\n# 如当前分支是master，本地另一个分支是dev，用下面命令将dev合并到master分支\n# git merge dev\n```\n## 版本回退\n```\n# git log 查看历史纪录\n#\n# 回退到上一个版本\n# git reset -hard HEAD^\n# 或\n# git reset --hard [commit id]回退至指定版本号的版本\n#\n#\n#\n# git中\n# HEAD表示当前版本\n# HEAD^表示上一个版本\n# HEAD^^ 上上一个版本\n# HEAD~100 上100个版本\n#\n# git reflog 查看命令历史\n# 一般通过这个命令查看之前版本号\n# 例如：（前7个字符就是版本号的缩写）\n$ git reflog\nbb862b6 HEAD@{0}: merge dev: Fast-forward\n3223509 HEAD@{1}: checkout: moving from dev to master\nbb862b6 HEAD@{2}: commit: dev branch commint\n3223509 HEAD@{3}: checkout: moving from master to dev\n3223509 HEAD@{4}: checkout: moving from master to master\n3223509 HEAD@{5}: checkout: moving from dev to master\n3223509 HEAD@{6}: checkout: moving from master to dev\n3223509 HEAD@{7}: commit: add readme.md\n54906f2 HEAD@{8}: pull origin master: Merge made by the 'recursive' strategy.\n7563423 HEAD@{9}: reset: moving to HEAD^\n7865e6f HEAD@{10}: commit: update third\n7563423 HEAD@{11}: commit: update\n81c90a0 HEAD@{12}: reset: moving to HEAD^\ned0fe41 HEAD@{13}: reset: moving to HEAD^\n2ba4ebf HEAD@{14}: commit: update third\ned0fe41 HEAD@{15}: commit: update\n81c90a0 HEAD@{16}: commit (initial): add readme file\n```\n## 管理修改\n> git diff HEAD -- README.md\n\n查看工作区和版本库里最新版本的区别\n```\n$ git diff HEAD -- README.md\n# diff --git a/README.md b/README.md\n# index 9235721..62c0eaa 100644\n# --- a/README.md\n# +++ b/README.md\n# @@ -1 +1 @@\n# -First Line!\n# +branch dev line\n```\n\n## 撤销修改\n1. 修改了工作区，想直接丢弃\n```\n$ git checkout -- filename\n```\n2. 修改了工作区内容，同事添加到了暂存区\n```\n$ git reset HEAD filename\n$ git checkout -- filename\n```\n\n## 删除文件\n```\n$ git rm filename\n$ git commit 提交到版本库\n```\n","source":"_posts/GIT使用小结.md","raw":"---\ntitle: GIT使用小结\ndate: 2016-09-21 23:30:00\nctime: 2016-09-21 23:30:00\nutime: 2016-09-23 23:30:00\nmodif_times: 2\ntags:\n- git\n- 版本控制\ncategories:\n- 软件工程\n---\n\n## 概念\n在使用之前先明确两个概念。\n- 工作区（working directory）\n> 我们创建的文件夹\n\n- 版本库（Repository）\n> 一个工作区中隐藏的目录（.git）这个目录不算工作区\n版本库\n>   - stage，暂存区\n>   - master，分支\n>\n> 日常我们进行git add操作，是将文件修改添加到了暂存区，而进行git commit操作，则是将暂存区中的修改提交至当前分支。\n\n<!-- more -->\n\n## 常用操作\n1. 创建项目文件夹\n```bash\nmkdir demo\n```\n2. 进入项目目录\n```\ncd demo\ngit init（将该目录变成git可以管理的仓库（repository））\n```\n初始化后，该目录下会产生一个.git 的隐藏文件夹。\n\n3. 添加文件到仓库\n```\ngit add 文件\n```\n添加一个文件到仓库。\n其实，该操作作用是将文件添加至Stage暂存区。\n\n  常用操作\n```bash\ngit add .   #将所有文件添加至 stage\ngit add -u  #将所有文件添加至 stage ，同时将工作区中删除的文件也从仓库中删除。\n```\n4. git commit  提交到版本库\n```\ngit commit -m \"write readme file\"\n```\n-m 为对本次版本提交的说明\n\n5. git status 查看当前版本库状态\n```bash\n$ mkdir git_test\n$ cd git_test\n$ git init\n# Initialized empty Git repository in /Users/zhimiao/WWW/hexo/git_test/.git/\n$ ll -a\n# total 0\n# drwxr-xr-x   3 zhimiao  staff   102B  9 23 10:25 .\n# drwxr-xr-x   6 zhimiao  staff   204B  9 23 10:25 ..\n# drwxr-xr-x  10 zhimiao  staff   340B  9 23 10:25 .git\n$ git status\n# On branch master\n# Initial commit\n# nothing to commit (create/copy files and use \"git add\" to track)\n```\n  - git将所有的文件分为3类：已追踪的，被忽略的，和未追踪的。\n    - 已追踪的（tracked）\n > 已追踪的文件是指已经在版本库中的文件，或者是已暂存到索引中的文件。即，一个文件通过执行git add，就会被添加到暂存区，该文件就变成一个已追踪的文件。\n    - 被忽略的（ignored）\n  > 被忽略的文件是指在版本库中被明确声明为不可见或者被忽略。一般通过在工作区新建 `.gitignore` 文件来来声明。\n  > ```\n> $ cat .gitignore\n.DS_Store\nThumbs.db\ndb.json\n*.log\nnode_modules/\npublic/\n.deploy*/\n> ```\n    - 未追踪的（untracked）\n  > 未追踪的文件是指那些不在前两类中的文件。git把工作目录下的所有文件当成一个集合，减去已经追踪的文件和忽略的文件，剩下的部分就作为未追踪的文件。\n\n  ```\n$ echo \"git test\" > readme.md\n$ git status\n# On branch master\n# Initial commit\n# Untracked files:\n#   (use \"git add <file>...\" to include in what will be committed)\n# \treadme.md\n# nothing added to commit but untracked files present (use \"git add\" to track)\n$ git add readme.md\n$ git status\n# On branch master\n# Initial commit\n# Changes to be committed:\n#   (use \"git rm --cached <file>...\" to unstage)\n# \tnew file:   readme.md\n$ git commit -m \"add readme file\"\n# [master (root-commit) 81c90a0] add readme file\n#  1 file changed, 1 insertion(+)\n#  create mode 100644 readme.md\n$ git status\n#  On branch master\n#  nothing to commit, working directory clean\n```\n\n6. git diff 显示当前尚未缓存的改动记录\n```\n$ echo \"Second Line \" >> readme.md\n$ git diff\n# diff --git a/readme.md b/readme.md\n# index f6edd6e..a1e649c 100644\n# --- a/readme.md\n# +++ b/readme.md\n# @@ -1 +1,2 @@\n#  git test\n# +add new Line\n```\n在开头，原始文件被『--』符号标记起来，新文件被用『+++』标记。@@ 之间表示两个不同文件版本的上下文行，以减号（-）开始的行表示从原始文件删除该行以得到新文件。相反，以加号（+）开始的行表示从原始文件中添加该行以产生新文件，而以空格开始的行则表示两个版本都有的行。\n\n7. git log 记录每次commit的信息\n```\n$ git add readme.md\n$ git commit -m \"update\"\n$ echo \"third Lines;\" >> readme.md\n$ git add readme.md\n$ git commit -m \"update third\"\n$ git log\n# commit 2ba4ebfe3ccef91f0d34646f5a0e50e339ee6f7a\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 11:21:24 2016 +0800\n#\n#     update third\n#\n# commit ed0fe412477c8ac828e450cbc319c06ac8db0445\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 11:19:34 2016 +0800\n#\n#     update\n#\n# commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 10:42:58 2016 +0800\n#\n#     add readme file\n```\n8. git reset 修改命令\n```\ngit reset HEAD    废除本次修改，回到上次提交的状态\ngit reset -hard [commit id]\n```\n```\n$ git reset --hard HEAD^\n# HEAD is now at 7563423 update\n$ git log   \n# commit ed0fe412477c8ac828e450cbc319c06ac8db0445\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 11:19:34 2016 +0800\n#\n#     update\n#\n# commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c\n# Author: weizhimiao <532615323@qq.com>\n# Date:   Fri Sep 23 10:42:58 2016 +0800\n#\n#     add readme file\n#\n$ cat readme.md\n# git test\n# Second Lines;\n```\n然后我们就回到了上一次提交的版本。\n\n9. git rm 删除所有版本库记录（慎用）\n\n\n## 从远程库克隆\ngit clone 克隆一个本地库\n```\n$ git clone git@github.com:weizhimiao/git_test.git\n# Cloning into 'git_test'...\n# remote: Counting objects: 3, done.\n# remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0\n# Receiving objects: 100% (3/3), done.\n# Checking connectivity... done.\n$ ll\n# drwxr-xr-x  4 zhimiao  staff   136B  9 23 21:53 git_test\n$ cd git_test\n$ ll\n# -rw-r--r--  1 zhimiao  staff    12B  9 23 21:53 README.md\n$ git status\n# On branch master\n# Your branch is up-to-date with 'origin/master'.\n# nothing to commit, working directory clean\n```\n## 关联远程库\n> 本地仓库名：git_test\n> 远程仓库名：git_test\n> 在本地git_test仓库下执行\n\n```\n$ git remote add origin git@github.com:weizhimiao/git_test.git\n```\n> weizhimiao 是github账户名\n> origin 为远程仓库的名字，git的默认叫法\n\n将本地所有的内容推送到远程库上\n```\ngit push -u origin master 把本地master分支推送到远程库\n-u 为把本地master 分支和远程master分支关联起来，之后就可以通过以下命令进行推送了\ngit push origin master\n```\n\n## 分享与更新项目\n1. git push origin dev  提交到远程dev分支\n\n\n2. git pull origin dev  拉取远程dev分支到本地并和本地dev分支合并\n\n3. git remote add origin git@github.com:weizhimiao/git_test.git  将本地仓库推送至名为test的仓库里\n\n## 分支管理\n创建：\n```\n$ git branch dev\n$ git branch\n#   dev\n# * master\n$ git checkout dev\n# Switched to branch 'dev'\n#\n$ git branch\n# * dev\n#   master\n```\n> git branch dev 创建dev分支\n> git checkout dev  切换当前分支\n\n等价于\n```\n$ git checkout -b dev 创建并切换到dev分支\n```\n```\n# git branch 查看当前分支\n# git branch -a 查看本地和远程所有分支\n# git branch -r 常看远程分支\n# git branch -d 删除本地分支\n# git checkout master 用于dev分支完成工作后，切换回master 分支\n#\n# git merge 分支合并\n# 如当前分支是master，本地另一个分支是dev，用下面命令将dev合并到master分支\n# git merge dev\n```\n## 版本回退\n```\n# git log 查看历史纪录\n#\n# 回退到上一个版本\n# git reset -hard HEAD^\n# 或\n# git reset --hard [commit id]回退至指定版本号的版本\n#\n#\n#\n# git中\n# HEAD表示当前版本\n# HEAD^表示上一个版本\n# HEAD^^ 上上一个版本\n# HEAD~100 上100个版本\n#\n# git reflog 查看命令历史\n# 一般通过这个命令查看之前版本号\n# 例如：（前7个字符就是版本号的缩写）\n$ git reflog\nbb862b6 HEAD@{0}: merge dev: Fast-forward\n3223509 HEAD@{1}: checkout: moving from dev to master\nbb862b6 HEAD@{2}: commit: dev branch commint\n3223509 HEAD@{3}: checkout: moving from master to dev\n3223509 HEAD@{4}: checkout: moving from master to master\n3223509 HEAD@{5}: checkout: moving from dev to master\n3223509 HEAD@{6}: checkout: moving from master to dev\n3223509 HEAD@{7}: commit: add readme.md\n54906f2 HEAD@{8}: pull origin master: Merge made by the 'recursive' strategy.\n7563423 HEAD@{9}: reset: moving to HEAD^\n7865e6f HEAD@{10}: commit: update third\n7563423 HEAD@{11}: commit: update\n81c90a0 HEAD@{12}: reset: moving to HEAD^\ned0fe41 HEAD@{13}: reset: moving to HEAD^\n2ba4ebf HEAD@{14}: commit: update third\ned0fe41 HEAD@{15}: commit: update\n81c90a0 HEAD@{16}: commit (initial): add readme file\n```\n## 管理修改\n> git diff HEAD -- README.md\n\n查看工作区和版本库里最新版本的区别\n```\n$ git diff HEAD -- README.md\n# diff --git a/README.md b/README.md\n# index 9235721..62c0eaa 100644\n# --- a/README.md\n# +++ b/README.md\n# @@ -1 +1 @@\n# -First Line!\n# +branch dev line\n```\n\n## 撤销修改\n1. 修改了工作区，想直接丢弃\n```\n$ git checkout -- filename\n```\n2. 修改了工作区内容，同事添加到了暂存区\n```\n$ git reset HEAD filename\n$ git checkout -- filename\n```\n\n## 删除文件\n```\n$ git rm filename\n$ git commit 提交到版本库\n```\n","slug":"GIT使用小结","published":1,"updated":"2016-09-23T14:33:28.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwuy000j699fd8e5pbva","content":"<h2 id=\"概念\"><a href=\"#概念\" class=\"headerlink\" title=\"概念\"></a>概念</h2><p>在使用之前先明确两个概念。</p>\n<ul>\n<li><p>工作区（working directory）</p>\n<blockquote>\n<p>我们创建的文件夹</p>\n</blockquote>\n</li>\n<li><p>版本库（Repository）</p>\n<blockquote>\n<p>一个工作区中隐藏的目录（.git）这个目录不算工作区<br>版本库</p>\n<ul>\n<li>stage，暂存区</li>\n<li>master，分支</li>\n</ul>\n<p>日常我们进行git add操作，是将文件修改添加到了暂存区，而进行git commit操作，则是将暂存区中的修改提交至当前分支。</p>\n</blockquote>\n</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"常用操作\"><a href=\"#常用操作\" class=\"headerlink\" title=\"常用操作\"></a>常用操作</h2><ol>\n<li><p>创建项目文件夹</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mkdir demo</div></pre></td></tr></table></figure>\n</li>\n<li><p>进入项目目录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd demo</div><div class=\"line\">git init（将该目录变成git可以管理的仓库（repository））</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>初始化后，该目录下会产生一个.git 的隐藏文件夹。</p>\n<ol>\n<li>添加文件到仓库<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">git add 文件</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>添加一个文件到仓库。<br>其实，该操作作用是将文件添加至Stage暂存区。</p>\n<p>  常用操作<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">git add .   <span class=\"comment\">#将所有文件添加至 stage</span></div><div class=\"line\">git add -u  <span class=\"comment\">#将所有文件添加至 stage ，同时将工作区中删除的文件也从仓库中删除。</span></div></pre></td></tr></table></figure></p>\n<ol>\n<li>git commit  提交到版本库<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">git commit -m &quot;write readme file&quot;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>-m 为对本次版本提交的说明</p>\n<ol>\n<li><p>git status 查看当前版本库状态</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ mkdir git_<span class=\"built_in\">test</span></div><div class=\"line\">$ <span class=\"built_in\">cd</span> git_<span class=\"built_in\">test</span></div><div class=\"line\">$ git init</div><div class=\"line\"><span class=\"comment\"># Initialized empty Git repository in /Users/zhimiao/WWW/hexo/git_test/.git/</span></div><div class=\"line\">$ ll <span class=\"_\">-a</span></div><div class=\"line\"><span class=\"comment\"># total 0</span></div><div class=\"line\"><span class=\"comment\"># drwxr-xr-x   3 zhimiao  staff   102B  9 23 10:25 .</span></div><div class=\"line\"><span class=\"comment\"># drwxr-xr-x   6 zhimiao  staff   204B  9 23 10:25 ..</span></div><div class=\"line\"><span class=\"comment\"># drwxr-xr-x  10 zhimiao  staff   340B  9 23 10:25 .git</span></div><div class=\"line\">$ git status</div><div class=\"line\"><span class=\"comment\"># On branch master</span></div><div class=\"line\"><span class=\"comment\"># Initial commit</span></div><div class=\"line\"><span class=\"comment\"># nothing to commit (create/copy files and use \"git add\" to track)</span></div></pre></td></tr></table></figure>\n<ul>\n<li><p>git将所有的文件分为3类：已追踪的，被忽略的，和未追踪的。</p>\n<ul>\n<li>已追踪的（tracked）<blockquote>\n<p>已追踪的文件是指已经在版本库中的文件，或者是已暂存到索引中的文件。即，一个文件通过执行git add，就会被添加到暂存区，该文件就变成一个已追踪的文件。</p>\n</blockquote>\n</li>\n<li><p>被忽略的（ignored）</p>\n<blockquote>\n<p>被忽略的文件是指在版本库中被明确声明为不可见或者被忽略。一般通过在工作区新建 <code>.gitignore</code> 文件来来声明。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; $ cat .gitignore</div><div class=\"line\">.DS_Store</div><div class=\"line\">Thumbs.db</div><div class=\"line\">db.json</div><div class=\"line\">*.log</div><div class=\"line\">node_modules/</div><div class=\"line\">public/</div><div class=\"line\">.deploy*/</div><div class=\"line\">&gt;</div></pre></td></tr></table></figure>\n</blockquote>\n</li>\n<li><p>未追踪的（untracked）</p>\n<blockquote>\n<p>未追踪的文件是指那些不在前两类中的文件。git把工作目录下的所有文件当成一个集合，减去已经追踪的文件和忽略的文件，剩下的部分就作为未追踪的文件。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ echo &quot;git test&quot; &gt; readme.md</div><div class=\"line\">$ git status</div><div class=\"line\"># On branch master</div><div class=\"line\"># Initial commit</div><div class=\"line\"># Untracked files:</div><div class=\"line\">#   (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</div><div class=\"line\"># \treadme.md</div><div class=\"line\"># nothing added to commit but untracked files present (use &quot;git add&quot; to track)</div><div class=\"line\">$ git add readme.md</div><div class=\"line\">$ git status</div><div class=\"line\"># On branch master</div><div class=\"line\"># Initial commit</div><div class=\"line\"># Changes to be committed:</div><div class=\"line\">#   (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</div><div class=\"line\"># \tnew file:   readme.md</div><div class=\"line\">$ git commit -m &quot;add readme file&quot;</div><div class=\"line\"># [master (root-commit) 81c90a0] add readme file</div><div class=\"line\">#  1 file changed, 1 insertion(+)</div><div class=\"line\">#  create mode 100644 readme.md</div><div class=\"line\">$ git status</div><div class=\"line\">#  On branch master</div><div class=\"line\">#  nothing to commit, working directory clean</div></pre></td></tr></table></figure>\n</li>\n<li><p>git diff 显示当前尚未缓存的改动记录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ echo &quot;Second Line &quot; &gt;&gt; readme.md</div><div class=\"line\">$ git diff</div><div class=\"line\"># diff --git a/readme.md b/readme.md</div><div class=\"line\"># index f6edd6e..a1e649c 100644</div><div class=\"line\"># --- a/readme.md</div><div class=\"line\"># +++ b/readme.md</div><div class=\"line\"># @@ -1 +1,2 @@</div><div class=\"line\">#  git test</div><div class=\"line\"># +add new Line</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>在开头，原始文件被『–』符号标记起来，新文件被用『+++』标记。@@ 之间表示两个不同文件版本的上下文行，以减号（-）开始的行表示从原始文件删除该行以得到新文件。相反，以加号（+）开始的行表示从原始文件中添加该行以产生新文件，而以空格开始的行则表示两个版本都有的行。</p>\n<ol>\n<li><p>git log 记录每次commit的信息</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git add readme.md</div><div class=\"line\">$ git commit -m &quot;update&quot;</div><div class=\"line\">$ echo &quot;third Lines;&quot; &gt;&gt; readme.md</div><div class=\"line\">$ git add readme.md</div><div class=\"line\">$ git commit -m &quot;update third&quot;</div><div class=\"line\">$ git log</div><div class=\"line\"># commit 2ba4ebfe3ccef91f0d34646f5a0e50e339ee6f7a</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 11:21:24 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     update third</div><div class=\"line\">#</div><div class=\"line\"># commit ed0fe412477c8ac828e450cbc319c06ac8db0445</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 11:19:34 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     update</div><div class=\"line\">#</div><div class=\"line\"># commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 10:42:58 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     add readme file</div></pre></td></tr></table></figure>\n</li>\n<li><p>git reset 修改命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">git reset HEAD    废除本次修改，回到上次提交的状态</div><div class=\"line\">git reset -hard [commit id]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git reset --hard HEAD^</div><div class=\"line\"># HEAD is now at 7563423 update</div><div class=\"line\">$ git log   </div><div class=\"line\"># commit ed0fe412477c8ac828e450cbc319c06ac8db0445</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 11:19:34 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     update</div><div class=\"line\">#</div><div class=\"line\"># commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 10:42:58 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     add readme file</div><div class=\"line\">#</div><div class=\"line\">$ cat readme.md</div><div class=\"line\"># git test</div><div class=\"line\"># Second Lines;</div></pre></td></tr></table></figure>\n<p>然后我们就回到了上一次提交的版本。</p>\n<ol>\n<li>git rm 删除所有版本库记录（慎用）</li>\n</ol>\n<h2 id=\"从远程库克隆\"><a href=\"#从远程库克隆\" class=\"headerlink\" title=\"从远程库克隆\"></a>从远程库克隆</h2><p>git clone 克隆一个本地库<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git clone git@github.com:weizhimiao/git_test.git</div><div class=\"line\"># Cloning into &apos;git_test&apos;...</div><div class=\"line\"># remote: Counting objects: 3, done.</div><div class=\"line\"># remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0</div><div class=\"line\"># Receiving objects: 100% (3/3), done.</div><div class=\"line\"># Checking connectivity... done.</div><div class=\"line\">$ ll</div><div class=\"line\"># drwxr-xr-x  4 zhimiao  staff   136B  9 23 21:53 git_test</div><div class=\"line\">$ cd git_test</div><div class=\"line\">$ ll</div><div class=\"line\"># -rw-r--r--  1 zhimiao  staff    12B  9 23 21:53 README.md</div><div class=\"line\">$ git status</div><div class=\"line\"># On branch master</div><div class=\"line\"># Your branch is up-to-date with &apos;origin/master&apos;.</div><div class=\"line\"># nothing to commit, working directory clean</div></pre></td></tr></table></figure></p>\n<h2 id=\"关联远程库\"><a href=\"#关联远程库\" class=\"headerlink\" title=\"关联远程库\"></a>关联远程库</h2><blockquote>\n<p>本地仓库名：git_test<br>远程仓库名：git_test<br>在本地git_test仓库下执行</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git remote add origin git@github.com:weizhimiao/git_test.git</div></pre></td></tr></table></figure>\n<blockquote>\n<p>weizhimiao 是github账户名<br>origin 为远程仓库的名字，git的默认叫法</p>\n</blockquote>\n<p>将本地所有的内容推送到远程库上<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">git push -u origin master 把本地master分支推送到远程库</div><div class=\"line\">-u 为把本地master 分支和远程master分支关联起来，之后就可以通过以下命令进行推送了</div><div class=\"line\">git push origin master</div></pre></td></tr></table></figure></p>\n<h2 id=\"分享与更新项目\"><a href=\"#分享与更新项目\" class=\"headerlink\" title=\"分享与更新项目\"></a>分享与更新项目</h2><ol>\n<li>git push origin dev  提交到远程dev分支</li>\n</ol>\n<ol>\n<li><p>git pull origin dev  拉取远程dev分支到本地并和本地dev分支合并</p>\n</li>\n<li><p>git remote add origin git@github.com:weizhimiao/git_test.git  将本地仓库推送至名为test的仓库里</p>\n</li>\n</ol>\n<h2 id=\"分支管理\"><a href=\"#分支管理\" class=\"headerlink\" title=\"分支管理\"></a>分支管理</h2><p>创建：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git branch dev</div><div class=\"line\">$ git branch</div><div class=\"line\">#   dev</div><div class=\"line\"># * master</div><div class=\"line\">$ git checkout dev</div><div class=\"line\"># Switched to branch &apos;dev&apos;</div><div class=\"line\">#</div><div class=\"line\">$ git branch</div><div class=\"line\"># * dev</div><div class=\"line\">#   master</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>git branch dev 创建dev分支<br>git checkout dev  切换当前分支</p>\n</blockquote>\n<p>等价于<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git checkout -b dev 创建并切换到dev分支</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"># git branch 查看当前分支</div><div class=\"line\"># git branch -a 查看本地和远程所有分支</div><div class=\"line\"># git branch -r 常看远程分支</div><div class=\"line\"># git branch -d 删除本地分支</div><div class=\"line\"># git checkout master 用于dev分支完成工作后，切换回master 分支</div><div class=\"line\">#</div><div class=\"line\"># git merge 分支合并</div><div class=\"line\"># 如当前分支是master，本地另一个分支是dev，用下面命令将dev合并到master分支</div><div class=\"line\"># git merge dev</div></pre></td></tr></table></figure>\n<h2 id=\"版本回退\"><a href=\"#版本回退\" class=\"headerlink\" title=\"版本回退\"></a>版本回退</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\"># git log 查看历史纪录</div><div class=\"line\">#</div><div class=\"line\"># 回退到上一个版本</div><div class=\"line\"># git reset -hard HEAD^</div><div class=\"line\"># 或</div><div class=\"line\"># git reset --hard [commit id]回退至指定版本号的版本</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># git中</div><div class=\"line\"># HEAD表示当前版本</div><div class=\"line\"># HEAD^表示上一个版本</div><div class=\"line\"># HEAD^^ 上上一个版本</div><div class=\"line\"># HEAD~100 上100个版本</div><div class=\"line\">#</div><div class=\"line\"># git reflog 查看命令历史</div><div class=\"line\"># 一般通过这个命令查看之前版本号</div><div class=\"line\"># 例如：（前7个字符就是版本号的缩写）</div><div class=\"line\">$ git reflog</div><div class=\"line\">bb862b6 HEAD@&#123;0&#125;: merge dev: Fast-forward</div><div class=\"line\">3223509 HEAD@&#123;1&#125;: checkout: moving from dev to master</div><div class=\"line\">bb862b6 HEAD@&#123;2&#125;: commit: dev branch commint</div><div class=\"line\">3223509 HEAD@&#123;3&#125;: checkout: moving from master to dev</div><div class=\"line\">3223509 HEAD@&#123;4&#125;: checkout: moving from master to master</div><div class=\"line\">3223509 HEAD@&#123;5&#125;: checkout: moving from dev to master</div><div class=\"line\">3223509 HEAD@&#123;6&#125;: checkout: moving from master to dev</div><div class=\"line\">3223509 HEAD@&#123;7&#125;: commit: add readme.md</div><div class=\"line\">54906f2 HEAD@&#123;8&#125;: pull origin master: Merge made by the &apos;recursive&apos; strategy.</div><div class=\"line\">7563423 HEAD@&#123;9&#125;: reset: moving to HEAD^</div><div class=\"line\">7865e6f HEAD@&#123;10&#125;: commit: update third</div><div class=\"line\">7563423 HEAD@&#123;11&#125;: commit: update</div><div class=\"line\">81c90a0 HEAD@&#123;12&#125;: reset: moving to HEAD^</div><div class=\"line\">ed0fe41 HEAD@&#123;13&#125;: reset: moving to HEAD^</div><div class=\"line\">2ba4ebf HEAD@&#123;14&#125;: commit: update third</div><div class=\"line\">ed0fe41 HEAD@&#123;15&#125;: commit: update</div><div class=\"line\">81c90a0 HEAD@&#123;16&#125;: commit (initial): add readme file</div></pre></td></tr></table></figure>\n<h2 id=\"管理修改\"><a href=\"#管理修改\" class=\"headerlink\" title=\"管理修改\"></a>管理修改</h2><blockquote>\n<p>git diff HEAD – README.md</p>\n</blockquote>\n<p>查看工作区和版本库里最新版本的区别<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git diff HEAD -- README.md</div><div class=\"line\"># diff --git a/README.md b/README.md</div><div class=\"line\"># index 9235721..62c0eaa 100644</div><div class=\"line\"># --- a/README.md</div><div class=\"line\"># +++ b/README.md</div><div class=\"line\"># @@ -1 +1 @@</div><div class=\"line\"># -First Line!</div><div class=\"line\"># +branch dev line</div></pre></td></tr></table></figure></p>\n<h2 id=\"撤销修改\"><a href=\"#撤销修改\" class=\"headerlink\" title=\"撤销修改\"></a>撤销修改</h2><ol>\n<li><p>修改了工作区，想直接丢弃</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git checkout -- filename</div></pre></td></tr></table></figure>\n</li>\n<li><p>修改了工作区内容，同事添加到了暂存区</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git reset HEAD filename</div><div class=\"line\">$ git checkout -- filename</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"删除文件\"><a href=\"#删除文件\" class=\"headerlink\" title=\"删除文件\"></a>删除文件</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git rm filename</div><div class=\"line\">$ git commit 提交到版本库</div></pre></td></tr></table></figure>\n","excerpt":"<h2 id=\"概念\"><a href=\"#概念\" class=\"headerlink\" title=\"概念\"></a>概念</h2><p>在使用之前先明确两个概念。</p>\n<ul>\n<li><p>工作区（working directory）</p>\n<blockquote>\n<p>我们创建的文件夹</p>\n</blockquote>\n</li>\n<li><p>版本库（Repository）</p>\n<blockquote>\n<p>一个工作区中隐藏的目录（.git）这个目录不算工作区<br>版本库</p>\n<ul>\n<li>stage，暂存区</li>\n<li>master，分支</li>\n</ul>\n<p>日常我们进行git add操作，是将文件修改添加到了暂存区，而进行git commit操作，则是将暂存区中的修改提交至当前分支。</p>\n</blockquote>\n</li>\n</ul>","more":"<h2 id=\"常用操作\"><a href=\"#常用操作\" class=\"headerlink\" title=\"常用操作\"></a>常用操作</h2><ol>\n<li><p>创建项目文件夹</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mkdir demo</div></pre></td></tr></table></figure>\n</li>\n<li><p>进入项目目录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd demo</div><div class=\"line\">git init（将该目录变成git可以管理的仓库（repository））</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>初始化后，该目录下会产生一个.git 的隐藏文件夹。</p>\n<ol>\n<li>添加文件到仓库<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">git add 文件</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>添加一个文件到仓库。<br>其实，该操作作用是将文件添加至Stage暂存区。</p>\n<p>  常用操作<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">git add .   <span class=\"comment\">#将所有文件添加至 stage</span></div><div class=\"line\">git add -u  <span class=\"comment\">#将所有文件添加至 stage ，同时将工作区中删除的文件也从仓库中删除。</span></div></pre></td></tr></table></figure></p>\n<ol>\n<li>git commit  提交到版本库<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">git commit -m &quot;write readme file&quot;</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>-m 为对本次版本提交的说明</p>\n<ol>\n<li><p>git status 查看当前版本库状态</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ mkdir git_<span class=\"built_in\">test</span></div><div class=\"line\">$ <span class=\"built_in\">cd</span> git_<span class=\"built_in\">test</span></div><div class=\"line\">$ git init</div><div class=\"line\"><span class=\"comment\"># Initialized empty Git repository in /Users/zhimiao/WWW/hexo/git_test/.git/</span></div><div class=\"line\">$ ll <span class=\"_\">-a</span></div><div class=\"line\"><span class=\"comment\"># total 0</span></div><div class=\"line\"><span class=\"comment\"># drwxr-xr-x   3 zhimiao  staff   102B  9 23 10:25 .</span></div><div class=\"line\"><span class=\"comment\"># drwxr-xr-x   6 zhimiao  staff   204B  9 23 10:25 ..</span></div><div class=\"line\"><span class=\"comment\"># drwxr-xr-x  10 zhimiao  staff   340B  9 23 10:25 .git</span></div><div class=\"line\">$ git status</div><div class=\"line\"><span class=\"comment\"># On branch master</span></div><div class=\"line\"><span class=\"comment\"># Initial commit</span></div><div class=\"line\"><span class=\"comment\"># nothing to commit (create/copy files and use \"git add\" to track)</span></div></pre></td></tr></table></figure>\n<ul>\n<li><p>git将所有的文件分为3类：已追踪的，被忽略的，和未追踪的。</p>\n<ul>\n<li>已追踪的（tracked）<blockquote>\n<p>已追踪的文件是指已经在版本库中的文件，或者是已暂存到索引中的文件。即，一个文件通过执行git add，就会被添加到暂存区，该文件就变成一个已追踪的文件。</p>\n</blockquote>\n</li>\n<li><p>被忽略的（ignored）</p>\n<blockquote>\n<p>被忽略的文件是指在版本库中被明确声明为不可见或者被忽略。一般通过在工作区新建 <code>.gitignore</code> 文件来来声明。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt; $ cat .gitignore</div><div class=\"line\">.DS_Store</div><div class=\"line\">Thumbs.db</div><div class=\"line\">db.json</div><div class=\"line\">*.log</div><div class=\"line\">node_modules/</div><div class=\"line\">public/</div><div class=\"line\">.deploy*/</div><div class=\"line\">&gt;</div></pre></td></tr></table></figure>\n</blockquote>\n</li>\n<li><p>未追踪的（untracked）</p>\n<blockquote>\n<p>未追踪的文件是指那些不在前两类中的文件。git把工作目录下的所有文件当成一个集合，减去已经追踪的文件和忽略的文件，剩下的部分就作为未追踪的文件。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ echo &quot;git test&quot; &gt; readme.md</div><div class=\"line\">$ git status</div><div class=\"line\"># On branch master</div><div class=\"line\"># Initial commit</div><div class=\"line\"># Untracked files:</div><div class=\"line\">#   (use &quot;git add &lt;file&gt;...&quot; to include in what will be committed)</div><div class=\"line\"># \treadme.md</div><div class=\"line\"># nothing added to commit but untracked files present (use &quot;git add&quot; to track)</div><div class=\"line\">$ git add readme.md</div><div class=\"line\">$ git status</div><div class=\"line\"># On branch master</div><div class=\"line\"># Initial commit</div><div class=\"line\"># Changes to be committed:</div><div class=\"line\">#   (use &quot;git rm --cached &lt;file&gt;...&quot; to unstage)</div><div class=\"line\"># \tnew file:   readme.md</div><div class=\"line\">$ git commit -m &quot;add readme file&quot;</div><div class=\"line\"># [master (root-commit) 81c90a0] add readme file</div><div class=\"line\">#  1 file changed, 1 insertion(+)</div><div class=\"line\">#  create mode 100644 readme.md</div><div class=\"line\">$ git status</div><div class=\"line\">#  On branch master</div><div class=\"line\">#  nothing to commit, working directory clean</div></pre></td></tr></table></figure>\n</li>\n<li><p>git diff 显示当前尚未缓存的改动记录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ echo &quot;Second Line &quot; &gt;&gt; readme.md</div><div class=\"line\">$ git diff</div><div class=\"line\"># diff --git a/readme.md b/readme.md</div><div class=\"line\"># index f6edd6e..a1e649c 100644</div><div class=\"line\"># --- a/readme.md</div><div class=\"line\"># +++ b/readme.md</div><div class=\"line\"># @@ -1 +1,2 @@</div><div class=\"line\">#  git test</div><div class=\"line\"># +add new Line</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>在开头，原始文件被『–』符号标记起来，新文件被用『+++』标记。@@ 之间表示两个不同文件版本的上下文行，以减号（-）开始的行表示从原始文件删除该行以得到新文件。相反，以加号（+）开始的行表示从原始文件中添加该行以产生新文件，而以空格开始的行则表示两个版本都有的行。</p>\n<ol>\n<li><p>git log 记录每次commit的信息</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git add readme.md</div><div class=\"line\">$ git commit -m &quot;update&quot;</div><div class=\"line\">$ echo &quot;third Lines;&quot; &gt;&gt; readme.md</div><div class=\"line\">$ git add readme.md</div><div class=\"line\">$ git commit -m &quot;update third&quot;</div><div class=\"line\">$ git log</div><div class=\"line\"># commit 2ba4ebfe3ccef91f0d34646f5a0e50e339ee6f7a</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 11:21:24 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     update third</div><div class=\"line\">#</div><div class=\"line\"># commit ed0fe412477c8ac828e450cbc319c06ac8db0445</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 11:19:34 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     update</div><div class=\"line\">#</div><div class=\"line\"># commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 10:42:58 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     add readme file</div></pre></td></tr></table></figure>\n</li>\n<li><p>git reset 修改命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">git reset HEAD    废除本次修改，回到上次提交的状态</div><div class=\"line\">git reset -hard [commit id]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git reset --hard HEAD^</div><div class=\"line\"># HEAD is now at 7563423 update</div><div class=\"line\">$ git log   </div><div class=\"line\"># commit ed0fe412477c8ac828e450cbc319c06ac8db0445</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 11:19:34 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     update</div><div class=\"line\">#</div><div class=\"line\"># commit 81c90a01f972ef803bd16272e7983aa1b3e9fa9c</div><div class=\"line\"># Author: weizhimiao &lt;532615323@qq.com&gt;</div><div class=\"line\"># Date:   Fri Sep 23 10:42:58 2016 +0800</div><div class=\"line\">#</div><div class=\"line\">#     add readme file</div><div class=\"line\">#</div><div class=\"line\">$ cat readme.md</div><div class=\"line\"># git test</div><div class=\"line\"># Second Lines;</div></pre></td></tr></table></figure>\n<p>然后我们就回到了上一次提交的版本。</p>\n<ol>\n<li>git rm 删除所有版本库记录（慎用）</li>\n</ol>\n<h2 id=\"从远程库克隆\"><a href=\"#从远程库克隆\" class=\"headerlink\" title=\"从远程库克隆\"></a>从远程库克隆</h2><p>git clone 克隆一个本地库<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git clone git@github.com:weizhimiao/git_test.git</div><div class=\"line\"># Cloning into &apos;git_test&apos;...</div><div class=\"line\"># remote: Counting objects: 3, done.</div><div class=\"line\"># remote: Total 3 (delta 0), reused 3 (delta 0), pack-reused 0</div><div class=\"line\"># Receiving objects: 100% (3/3), done.</div><div class=\"line\"># Checking connectivity... done.</div><div class=\"line\">$ ll</div><div class=\"line\"># drwxr-xr-x  4 zhimiao  staff   136B  9 23 21:53 git_test</div><div class=\"line\">$ cd git_test</div><div class=\"line\">$ ll</div><div class=\"line\"># -rw-r--r--  1 zhimiao  staff    12B  9 23 21:53 README.md</div><div class=\"line\">$ git status</div><div class=\"line\"># On branch master</div><div class=\"line\"># Your branch is up-to-date with &apos;origin/master&apos;.</div><div class=\"line\"># nothing to commit, working directory clean</div></pre></td></tr></table></figure></p>\n<h2 id=\"关联远程库\"><a href=\"#关联远程库\" class=\"headerlink\" title=\"关联远程库\"></a>关联远程库</h2><blockquote>\n<p>本地仓库名：git_test<br>远程仓库名：git_test<br>在本地git_test仓库下执行</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git remote add origin git@github.com:weizhimiao/git_test.git</div></pre></td></tr></table></figure>\n<blockquote>\n<p>weizhimiao 是github账户名<br>origin 为远程仓库的名字，git的默认叫法</p>\n</blockquote>\n<p>将本地所有的内容推送到远程库上<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">git push -u origin master 把本地master分支推送到远程库</div><div class=\"line\">-u 为把本地master 分支和远程master分支关联起来，之后就可以通过以下命令进行推送了</div><div class=\"line\">git push origin master</div></pre></td></tr></table></figure></p>\n<h2 id=\"分享与更新项目\"><a href=\"#分享与更新项目\" class=\"headerlink\" title=\"分享与更新项目\"></a>分享与更新项目</h2><ol>\n<li>git push origin dev  提交到远程dev分支</li>\n</ol>\n<ol>\n<li><p>git pull origin dev  拉取远程dev分支到本地并和本地dev分支合并</p>\n</li>\n<li><p>git remote add origin git@github.com:weizhimiao/git_test.git  将本地仓库推送至名为test的仓库里</p>\n</li>\n</ol>\n<h2 id=\"分支管理\"><a href=\"#分支管理\" class=\"headerlink\" title=\"分支管理\"></a>分支管理</h2><p>创建：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git branch dev</div><div class=\"line\">$ git branch</div><div class=\"line\">#   dev</div><div class=\"line\"># * master</div><div class=\"line\">$ git checkout dev</div><div class=\"line\"># Switched to branch &apos;dev&apos;</div><div class=\"line\">#</div><div class=\"line\">$ git branch</div><div class=\"line\"># * dev</div><div class=\"line\">#   master</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>git branch dev 创建dev分支<br>git checkout dev  切换当前分支</p>\n</blockquote>\n<p>等价于<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git checkout -b dev 创建并切换到dev分支</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"># git branch 查看当前分支</div><div class=\"line\"># git branch -a 查看本地和远程所有分支</div><div class=\"line\"># git branch -r 常看远程分支</div><div class=\"line\"># git branch -d 删除本地分支</div><div class=\"line\"># git checkout master 用于dev分支完成工作后，切换回master 分支</div><div class=\"line\">#</div><div class=\"line\"># git merge 分支合并</div><div class=\"line\"># 如当前分支是master，本地另一个分支是dev，用下面命令将dev合并到master分支</div><div class=\"line\"># git merge dev</div></pre></td></tr></table></figure>\n<h2 id=\"版本回退\"><a href=\"#版本回退\" class=\"headerlink\" title=\"版本回退\"></a>版本回退</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\"># git log 查看历史纪录</div><div class=\"line\">#</div><div class=\"line\"># 回退到上一个版本</div><div class=\"line\"># git reset -hard HEAD^</div><div class=\"line\"># 或</div><div class=\"line\"># git reset --hard [commit id]回退至指定版本号的版本</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># git中</div><div class=\"line\"># HEAD表示当前版本</div><div class=\"line\"># HEAD^表示上一个版本</div><div class=\"line\"># HEAD^^ 上上一个版本</div><div class=\"line\"># HEAD~100 上100个版本</div><div class=\"line\">#</div><div class=\"line\"># git reflog 查看命令历史</div><div class=\"line\"># 一般通过这个命令查看之前版本号</div><div class=\"line\"># 例如：（前7个字符就是版本号的缩写）</div><div class=\"line\">$ git reflog</div><div class=\"line\">bb862b6 HEAD@&#123;0&#125;: merge dev: Fast-forward</div><div class=\"line\">3223509 HEAD@&#123;1&#125;: checkout: moving from dev to master</div><div class=\"line\">bb862b6 HEAD@&#123;2&#125;: commit: dev branch commint</div><div class=\"line\">3223509 HEAD@&#123;3&#125;: checkout: moving from master to dev</div><div class=\"line\">3223509 HEAD@&#123;4&#125;: checkout: moving from master to master</div><div class=\"line\">3223509 HEAD@&#123;5&#125;: checkout: moving from dev to master</div><div class=\"line\">3223509 HEAD@&#123;6&#125;: checkout: moving from master to dev</div><div class=\"line\">3223509 HEAD@&#123;7&#125;: commit: add readme.md</div><div class=\"line\">54906f2 HEAD@&#123;8&#125;: pull origin master: Merge made by the &apos;recursive&apos; strategy.</div><div class=\"line\">7563423 HEAD@&#123;9&#125;: reset: moving to HEAD^</div><div class=\"line\">7865e6f HEAD@&#123;10&#125;: commit: update third</div><div class=\"line\">7563423 HEAD@&#123;11&#125;: commit: update</div><div class=\"line\">81c90a0 HEAD@&#123;12&#125;: reset: moving to HEAD^</div><div class=\"line\">ed0fe41 HEAD@&#123;13&#125;: reset: moving to HEAD^</div><div class=\"line\">2ba4ebf HEAD@&#123;14&#125;: commit: update third</div><div class=\"line\">ed0fe41 HEAD@&#123;15&#125;: commit: update</div><div class=\"line\">81c90a0 HEAD@&#123;16&#125;: commit (initial): add readme file</div></pre></td></tr></table></figure>\n<h2 id=\"管理修改\"><a href=\"#管理修改\" class=\"headerlink\" title=\"管理修改\"></a>管理修改</h2><blockquote>\n<p>git diff HEAD – README.md</p>\n</blockquote>\n<p>查看工作区和版本库里最新版本的区别<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git diff HEAD -- README.md</div><div class=\"line\"># diff --git a/README.md b/README.md</div><div class=\"line\"># index 9235721..62c0eaa 100644</div><div class=\"line\"># --- a/README.md</div><div class=\"line\"># +++ b/README.md</div><div class=\"line\"># @@ -1 +1 @@</div><div class=\"line\"># -First Line!</div><div class=\"line\"># +branch dev line</div></pre></td></tr></table></figure></p>\n<h2 id=\"撤销修改\"><a href=\"#撤销修改\" class=\"headerlink\" title=\"撤销修改\"></a>撤销修改</h2><ol>\n<li><p>修改了工作区，想直接丢弃</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git checkout -- filename</div></pre></td></tr></table></figure>\n</li>\n<li><p>修改了工作区内容，同事添加到了暂存区</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git reset HEAD filename</div><div class=\"line\">$ git checkout -- filename</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"删除文件\"><a href=\"#删除文件\" class=\"headerlink\" title=\"删除文件\"></a>删除文件</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ git rm filename</div><div class=\"line\">$ git commit 提交到版本库</div></pre></td></tr></table></figure>"},{"title":"Linux中的用户和用户组管理","date":"2016-10-06T14:30:00.000Z","_content":"\n用户账号的管理主要涉及到用户账号的添加、删除和修改。\n添加用户账号就是在系统中创建一个新账号，然后为新账号分配用户号、用户组、主目录和登录Shell等。\n\n<!-- more -->\n\n## 关于用户管理的配置文件说明\n\n### 用户信息文件：\n\n```\n/etc/passwd\n```\n\n文件内容：\n\n```\nroot:x:0:0:root:/root:/bin/bash\n\n第一位：用户名\n第二位：密码位（只是一个密码标志，真实密码并不是存在这）\n第三位：UID\t用户ID\n\t\t0\t超级管理员\n\t\t1-499\t系统用户（伪用户）\n\t\t>500\t普通用户\n第四位：GID\t初始组ID\n第五位：用户说明\n第六位：家目录\n第七位：用户登录之后的权限\n```\n\n### 影子文件：\n\n```\n/etc/shadow\n```\n\n文件内容：\n\n```\nroot:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::\n```\n\n说明：\n\n```\n#\n# 第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，\n# 这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的；\n#\n# 第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的；\n#\n# 第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），\n# 您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化；\n#\n# 第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；\n# 此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义；\n#\n# 第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；\n# 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义；\n#\n# 第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；\n# 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义；\n#\n# 第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，\n# 也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用；\n#\n# 第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），\n# 如果这个字段的值为空，帐号永久可用；\n#\n# 第九字段：保留字段，目前为空，以备将来Linux发展之用；\n```\n\n\n\n### 组信息文件：\n\n```\n/etc/group\n```\n\n文件内容：\n\n```\nbin:x:1:bin,daemon\n组名：组密码位：组ID：组中的附加用户\n初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组\n附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组\n```\n\n## 添加用户\n\n```\nuseradd\t用户名\nuseradd  选项    用户名\t\t\n\t\t-g\t组名\t\t指定初始组（但最好不要手动指定）\n\t\t-G\t组名\t\t指定附加组（把用户加入组，使用附加组）\n\t\t-c\t说明\t\t添加说明\n\t\t-d\t目录\t\t手工指定家目录\n\t\t-s\t/bin/bash\t手工指定用户登录后之后的权限\n```\n\n例：\n\n```\nuseradd  -g  aa  bb   \t\t添加bb用户，同时指定初始组aa\nuseradd   -G   user1   aa\t\t添加用户aa，指定附加组为user1\n```\n\n## 设定密码\n\n```\npasswd\t用户名\npasswd\t\t改变当前用户密码（普通用户只能通过这种方式来更改自己的密码）\npasswd\troot\t更改root的密码\n```\n\n## 删除密码\n\n```\nuserdel\t-r  用户名\n\t\t    -r \t连带家目录一起删除\n```\n\n## 添加组\n\n```\ngroupadd\t组名\n```\n\n## 删除组\n\n```\ngroupdel\t组名\t\t注意：组中没有初始用户\n```\n\n## 把已经存在的用户加入组\n\n```\ngpasswd\t-a  用户名   组名\t用户加入组\ngpasswd\t-d  用户名  组名\t把用户从组中删除\n```\n\n## 查看用户相关信息\n\n```\nid   用户名\t\t显示用户的UID，初始组，和附加组\n```\n\n```\n例#id   sc   \nuid=0(root) gid=0(root) 组=0(root)\n```\n\n## 用户间的相互切换\n\n```\nsu  -  用户名\t\t切换用户身份\n  \t-\t连带环境变量一起切换\n```\n","source":"_posts/Linux中的用户和用户组管理.md","raw":"---\ntitle: Linux中的用户和用户组管理\ndate: 2016-10-06 22:30:00\ncategories:\n- Linux\n---\n\n用户账号的管理主要涉及到用户账号的添加、删除和修改。\n添加用户账号就是在系统中创建一个新账号，然后为新账号分配用户号、用户组、主目录和登录Shell等。\n\n<!-- more -->\n\n## 关于用户管理的配置文件说明\n\n### 用户信息文件：\n\n```\n/etc/passwd\n```\n\n文件内容：\n\n```\nroot:x:0:0:root:/root:/bin/bash\n\n第一位：用户名\n第二位：密码位（只是一个密码标志，真实密码并不是存在这）\n第三位：UID\t用户ID\n\t\t0\t超级管理员\n\t\t1-499\t系统用户（伪用户）\n\t\t>500\t普通用户\n第四位：GID\t初始组ID\n第五位：用户说明\n第六位：家目录\n第七位：用户登录之后的权限\n```\n\n### 影子文件：\n\n```\n/etc/shadow\n```\n\n文件内容：\n\n```\nroot:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::\n```\n\n说明：\n\n```\n#\n# 第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，\n# 这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的；\n#\n# 第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的；\n#\n# 第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），\n# 您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化；\n#\n# 第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；\n# 此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义；\n#\n# 第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；\n# 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义；\n#\n# 第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；\n# 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义；\n#\n# 第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，\n# 也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用；\n#\n# 第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），\n# 如果这个字段的值为空，帐号永久可用；\n#\n# 第九字段：保留字段，目前为空，以备将来Linux发展之用；\n```\n\n\n\n### 组信息文件：\n\n```\n/etc/group\n```\n\n文件内容：\n\n```\nbin:x:1:bin,daemon\n组名：组密码位：组ID：组中的附加用户\n初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组\n附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组\n```\n\n## 添加用户\n\n```\nuseradd\t用户名\nuseradd  选项    用户名\t\t\n\t\t-g\t组名\t\t指定初始组（但最好不要手动指定）\n\t\t-G\t组名\t\t指定附加组（把用户加入组，使用附加组）\n\t\t-c\t说明\t\t添加说明\n\t\t-d\t目录\t\t手工指定家目录\n\t\t-s\t/bin/bash\t手工指定用户登录后之后的权限\n```\n\n例：\n\n```\nuseradd  -g  aa  bb   \t\t添加bb用户，同时指定初始组aa\nuseradd   -G   user1   aa\t\t添加用户aa，指定附加组为user1\n```\n\n## 设定密码\n\n```\npasswd\t用户名\npasswd\t\t改变当前用户密码（普通用户只能通过这种方式来更改自己的密码）\npasswd\troot\t更改root的密码\n```\n\n## 删除密码\n\n```\nuserdel\t-r  用户名\n\t\t    -r \t连带家目录一起删除\n```\n\n## 添加组\n\n```\ngroupadd\t组名\n```\n\n## 删除组\n\n```\ngroupdel\t组名\t\t注意：组中没有初始用户\n```\n\n## 把已经存在的用户加入组\n\n```\ngpasswd\t-a  用户名   组名\t用户加入组\ngpasswd\t-d  用户名  组名\t把用户从组中删除\n```\n\n## 查看用户相关信息\n\n```\nid   用户名\t\t显示用户的UID，初始组，和附加组\n```\n\n```\n例#id   sc   \nuid=0(root) gid=0(root) 组=0(root)\n```\n\n## 用户间的相互切换\n\n```\nsu  -  用户名\t\t切换用户身份\n  \t-\t连带环境变量一起切换\n```\n","slug":"Linux中的用户和用户组管理","published":1,"updated":"2016-10-07T14:41:03.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwv0000n699fmd67fyzj","content":"<p>用户账号的管理主要涉及到用户账号的添加、删除和修改。<br>添加用户账号就是在系统中创建一个新账号，然后为新账号分配用户号、用户组、主目录和登录Shell等。</p>\n<a id=\"more\"></a>\n<h2 id=\"关于用户管理的配置文件说明\"><a href=\"#关于用户管理的配置文件说明\" class=\"headerlink\" title=\"关于用户管理的配置文件说明\"></a>关于用户管理的配置文件说明</h2><h3 id=\"用户信息文件：\"><a href=\"#用户信息文件：\" class=\"headerlink\" title=\"用户信息文件：\"></a>用户信息文件：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/passwd</div></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:x:0:0:root:/root:/bin/bash</div><div class=\"line\"></div><div class=\"line\">第一位：用户名</div><div class=\"line\">第二位：密码位（只是一个密码标志，真实密码并不是存在这）</div><div class=\"line\">第三位：UID\t用户ID</div><div class=\"line\">\t\t0\t超级管理员</div><div class=\"line\">\t\t1-499\t系统用户（伪用户）</div><div class=\"line\">\t\t&gt;500\t普通用户</div><div class=\"line\">第四位：GID\t初始组ID</div><div class=\"line\">第五位：用户说明</div><div class=\"line\">第六位：家目录</div><div class=\"line\">第七位：用户登录之后的权限</div></pre></td></tr></table></figure>\n<h3 id=\"影子文件：\"><a href=\"#影子文件：\" class=\"headerlink\" title=\"影子文件：\"></a>影子文件：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/shadow</div></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::</div></pre></td></tr></table></figure>\n<p>说明：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\">#</div><div class=\"line\"># 第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，</div><div class=\"line\"># 这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的；</div><div class=\"line\">#</div><div class=\"line\"># 第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的；</div><div class=\"line\">#</div><div class=\"line\"># 第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），</div><div class=\"line\"># 您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化；</div><div class=\"line\">#</div><div class=\"line\"># 第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；</div><div class=\"line\"># 此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义；</div><div class=\"line\">#</div><div class=\"line\"># 第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；</div><div class=\"line\"># 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义；</div><div class=\"line\">#</div><div class=\"line\"># 第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；</div><div class=\"line\"># 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义；</div><div class=\"line\">#</div><div class=\"line\"># 第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，</div><div class=\"line\"># 也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用；</div><div class=\"line\">#</div><div class=\"line\"># 第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），</div><div class=\"line\"># 如果这个字段的值为空，帐号永久可用；</div><div class=\"line\">#</div><div class=\"line\"># 第九字段：保留字段，目前为空，以备将来Linux发展之用；</div></pre></td></tr></table></figure>\n<h3 id=\"组信息文件：\"><a href=\"#组信息文件：\" class=\"headerlink\" title=\"组信息文件：\"></a>组信息文件：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/group</div></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">bin:x:1:bin,daemon</div><div class=\"line\">组名：组密码位：组ID：组中的附加用户</div><div class=\"line\">初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组</div><div class=\"line\">附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组</div></pre></td></tr></table></figure>\n<h2 id=\"添加用户\"><a href=\"#添加用户\" class=\"headerlink\" title=\"添加用户\"></a>添加用户</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">useradd\t用户名</div><div class=\"line\">useradd  选项    用户名\t\t</div><div class=\"line\">\t\t-g\t组名\t\t指定初始组（但最好不要手动指定）</div><div class=\"line\">\t\t-G\t组名\t\t指定附加组（把用户加入组，使用附加组）</div><div class=\"line\">\t\t-c\t说明\t\t添加说明</div><div class=\"line\">\t\t-d\t目录\t\t手工指定家目录</div><div class=\"line\">\t\t-s\t/bin/bash\t手工指定用户登录后之后的权限</div></pre></td></tr></table></figure>\n<p>例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">useradd  -g  aa  bb   \t\t添加bb用户，同时指定初始组aa</div><div class=\"line\">useradd   -G   user1   aa\t\t添加用户aa，指定附加组为user1</div></pre></td></tr></table></figure>\n<h2 id=\"设定密码\"><a href=\"#设定密码\" class=\"headerlink\" title=\"设定密码\"></a>设定密码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">passwd\t用户名</div><div class=\"line\">passwd\t\t改变当前用户密码（普通用户只能通过这种方式来更改自己的密码）</div><div class=\"line\">passwd\troot\t更改root的密码</div></pre></td></tr></table></figure>\n<h2 id=\"删除密码\"><a href=\"#删除密码\" class=\"headerlink\" title=\"删除密码\"></a>删除密码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">userdel\t-r  用户名</div><div class=\"line\">\t\t    -r \t连带家目录一起删除</div></pre></td></tr></table></figure>\n<h2 id=\"添加组\"><a href=\"#添加组\" class=\"headerlink\" title=\"添加组\"></a>添加组</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">groupadd\t组名</div></pre></td></tr></table></figure>\n<h2 id=\"删除组\"><a href=\"#删除组\" class=\"headerlink\" title=\"删除组\"></a>删除组</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">groupdel\t组名\t\t注意：组中没有初始用户</div></pre></td></tr></table></figure>\n<h2 id=\"把已经存在的用户加入组\"><a href=\"#把已经存在的用户加入组\" class=\"headerlink\" title=\"把已经存在的用户加入组\"></a>把已经存在的用户加入组</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">gpasswd\t-a  用户名   组名\t用户加入组</div><div class=\"line\">gpasswd\t-d  用户名  组名\t把用户从组中删除</div></pre></td></tr></table></figure>\n<h2 id=\"查看用户相关信息\"><a href=\"#查看用户相关信息\" class=\"headerlink\" title=\"查看用户相关信息\"></a>查看用户相关信息</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">id   用户名\t\t显示用户的UID，初始组，和附加组</div></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">例#id   sc   </div><div class=\"line\">uid=0(root) gid=0(root) 组=0(root)</div></pre></td></tr></table></figure>\n<h2 id=\"用户间的相互切换\"><a href=\"#用户间的相互切换\" class=\"headerlink\" title=\"用户间的相互切换\"></a>用户间的相互切换</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">su  -  用户名\t\t切换用户身份</div><div class=\"line\">  \t-\t连带环境变量一起切换</div></pre></td></tr></table></figure>\n","excerpt":"<p>用户账号的管理主要涉及到用户账号的添加、删除和修改。<br>添加用户账号就是在系统中创建一个新账号，然后为新账号分配用户号、用户组、主目录和登录Shell等。</p>","more":"<h2 id=\"关于用户管理的配置文件说明\"><a href=\"#关于用户管理的配置文件说明\" class=\"headerlink\" title=\"关于用户管理的配置文件说明\"></a>关于用户管理的配置文件说明</h2><h3 id=\"用户信息文件：\"><a href=\"#用户信息文件：\" class=\"headerlink\" title=\"用户信息文件：\"></a>用户信息文件：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/passwd</div></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:x:0:0:root:/root:/bin/bash</div><div class=\"line\"></div><div class=\"line\">第一位：用户名</div><div class=\"line\">第二位：密码位（只是一个密码标志，真实密码并不是存在这）</div><div class=\"line\">第三位：UID\t用户ID</div><div class=\"line\">\t\t0\t超级管理员</div><div class=\"line\">\t\t1-499\t系统用户（伪用户）</div><div class=\"line\">\t\t&gt;500\t普通用户</div><div class=\"line\">第四位：GID\t初始组ID</div><div class=\"line\">第五位：用户说明</div><div class=\"line\">第六位：家目录</div><div class=\"line\">第七位：用户登录之后的权限</div></pre></td></tr></table></figure>\n<h3 id=\"影子文件：\"><a href=\"#影子文件：\" class=\"headerlink\" title=\"影子文件：\"></a>影子文件：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/shadow</div></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::</div></pre></td></tr></table></figure>\n<p>说明：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div></pre></td><td class=\"code\"><pre><div class=\"line\">#</div><div class=\"line\"># 第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，</div><div class=\"line\"># 这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的；</div><div class=\"line\">#</div><div class=\"line\"># 第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的；</div><div class=\"line\">#</div><div class=\"line\"># 第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），</div><div class=\"line\"># 您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化；</div><div class=\"line\">#</div><div class=\"line\"># 第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；</div><div class=\"line\"># 此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义；</div><div class=\"line\">#</div><div class=\"line\"># 第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；</div><div class=\"line\"># 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义；</div><div class=\"line\">#</div><div class=\"line\"># 第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；</div><div class=\"line\"># 如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义；</div><div class=\"line\">#</div><div class=\"line\"># 第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，</div><div class=\"line\"># 也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用；</div><div class=\"line\">#</div><div class=\"line\"># 第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），</div><div class=\"line\"># 如果这个字段的值为空，帐号永久可用；</div><div class=\"line\">#</div><div class=\"line\"># 第九字段：保留字段，目前为空，以备将来Linux发展之用；</div></pre></td></tr></table></figure>\n<h3 id=\"组信息文件：\"><a href=\"#组信息文件：\" class=\"headerlink\" title=\"组信息文件：\"></a>组信息文件：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/group</div></pre></td></tr></table></figure>\n<p>文件内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">bin:x:1:bin,daemon</div><div class=\"line\">组名：组密码位：组ID：组中的附加用户</div><div class=\"line\">初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组</div><div class=\"line\">附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组</div></pre></td></tr></table></figure>\n<h2 id=\"添加用户\"><a href=\"#添加用户\" class=\"headerlink\" title=\"添加用户\"></a>添加用户</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">useradd\t用户名</div><div class=\"line\">useradd  选项    用户名\t\t</div><div class=\"line\">\t\t-g\t组名\t\t指定初始组（但最好不要手动指定）</div><div class=\"line\">\t\t-G\t组名\t\t指定附加组（把用户加入组，使用附加组）</div><div class=\"line\">\t\t-c\t说明\t\t添加说明</div><div class=\"line\">\t\t-d\t目录\t\t手工指定家目录</div><div class=\"line\">\t\t-s\t/bin/bash\t手工指定用户登录后之后的权限</div></pre></td></tr></table></figure>\n<p>例：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">useradd  -g  aa  bb   \t\t添加bb用户，同时指定初始组aa</div><div class=\"line\">useradd   -G   user1   aa\t\t添加用户aa，指定附加组为user1</div></pre></td></tr></table></figure>\n<h2 id=\"设定密码\"><a href=\"#设定密码\" class=\"headerlink\" title=\"设定密码\"></a>设定密码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">passwd\t用户名</div><div class=\"line\">passwd\t\t改变当前用户密码（普通用户只能通过这种方式来更改自己的密码）</div><div class=\"line\">passwd\troot\t更改root的密码</div></pre></td></tr></table></figure>\n<h2 id=\"删除密码\"><a href=\"#删除密码\" class=\"headerlink\" title=\"删除密码\"></a>删除密码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">userdel\t-r  用户名</div><div class=\"line\">\t\t    -r \t连带家目录一起删除</div></pre></td></tr></table></figure>\n<h2 id=\"添加组\"><a href=\"#添加组\" class=\"headerlink\" title=\"添加组\"></a>添加组</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">groupadd\t组名</div></pre></td></tr></table></figure>\n<h2 id=\"删除组\"><a href=\"#删除组\" class=\"headerlink\" title=\"删除组\"></a>删除组</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">groupdel\t组名\t\t注意：组中没有初始用户</div></pre></td></tr></table></figure>\n<h2 id=\"把已经存在的用户加入组\"><a href=\"#把已经存在的用户加入组\" class=\"headerlink\" title=\"把已经存在的用户加入组\"></a>把已经存在的用户加入组</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">gpasswd\t-a  用户名   组名\t用户加入组</div><div class=\"line\">gpasswd\t-d  用户名  组名\t把用户从组中删除</div></pre></td></tr></table></figure>\n<h2 id=\"查看用户相关信息\"><a href=\"#查看用户相关信息\" class=\"headerlink\" title=\"查看用户相关信息\"></a>查看用户相关信息</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">id   用户名\t\t显示用户的UID，初始组，和附加组</div></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">例#id   sc   </div><div class=\"line\">uid=0(root) gid=0(root) 组=0(root)</div></pre></td></tr></table></figure>\n<h2 id=\"用户间的相互切换\"><a href=\"#用户间的相互切换\" class=\"headerlink\" title=\"用户间的相互切换\"></a>用户间的相互切换</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">su  -  用户名\t\t切换用户身份</div><div class=\"line\">  \t-\t连带环境变量一起切换</div></pre></td></tr></table></figure>"},{"title":"Linux常用命令","date":"2016-10-06T14:30:00.000Z","_content":"\n## Linux命令格式\n格式：命令\t[选项]\t[参数]\n\n例如：\n```\n#ls \t-list \t显示目录下内容\n```\n> 命令操作的对象（文件、目录、用户、进程）\n> Linux中以”.”开头的文件是隐藏文件\n\n提示符：[root@localhost src]#\n> [当前登录用户@主机名 当前所在目录]#\n> #\t超级用户\n> $\t普通用户\n\n当前所在目录：\t用户家目录\n>\t管理员\t\t/root\n>\t普通用户\t\t/home/用户名\n\n**tips：**\n> ctrl +  c\t\t强制终止\n> ctrl+l\t\t\t清屏\n> ctrl+u\t\t光标删除到行首\n> ctrl+a\t\t光标移动到行首\n> ctrl+e\t\t光标移动到行尾\n\n<!-- more -->\n\n## 目录操作命令\n**切换所在目录**\n\n`cd`\n\n例：\n```\ncd  /usr/local/src\ncd   ~\t或cd\t  \t进入当前用户的家目录\ncd  -\t\t进入上次目录\ncd  ..\t\t进入上一级目录\ncd  .\t\t进入当前目录\n```\n**显示当前所在目录**\n\n`pwd`\n\n**建立目录**\n\n`mkdir`\n\n例：\n```\nmkdir  \t-p  11/22/33/44\t\t递归建立目录\n```\n**删除目录**\n```\nrmdir\t目录\t\t只能删除空目录\n\nrm\t文件名\t\t删除文件\nrm\t-rf\t目录\t\t删除文件和目录\n\t\t-f\t强制\n\t\t-r\t递归、删除目录\n```\n**显示指定目录下的所有内容的目录树**\n\ntree\t目录名\n\n例：\n```\ntree\t/var/\n```\n\n## 文件操作命令\n**创建空文件或修改文件时间**\n```\ntouch  文件名\n```\n**删除**\n```\nrm  –rf  文件名\n\t\t-f\t强制\n\t\t-r\t删除目录\n```\n**查看文件内容**\n```\ncat\t文件名\t\t（从头到尾）\n\t\t-n\t列出行号\nmore\t文件名\t\t（分屏显示文件内容）\n空格向下翻\t\tb  向上翻\t\tq  退出\nhead\t文件名\t\t（显示文件头几行）\n\thead  –n  行数\t文件名\t指定显示文件头几行\n\thead  -20  文件名\n```\n**链接文件**\n```\nln  -s  源文件   目标文件\t\t（文件名都必须写绝对路径）\n链接文件相当于windows中的快捷方式，链接文件和源文件修改一个两个都变，删除原文件，软链接打不开。\n```\n## 文件和目录都能操作的命令\n\n**删除文件或目录**\n```\nrm\n```\n\n**复制**\n```\ncp  源文件   目标文件\n\t\t-r\t复制目录\n\t\t-p\t带文件属性复制\n\t\t-d\t若源文件为链接文件，则复制链接属性\n\t\t-a\t相当于  -pdr\n例：\ncp   aa  /tmp/\t\t\t原名复制\ncp  aa  /tmp/bb\t\t\t改名复制\n```\n\n**剪切或改名**\n```\nmv\t源文件   目标位置\n剪切目录不需要加“-r”选项（特殊）\n例：\nmv  /root/aa  /tmp/\t剪切\nmv  aa  bb\t\t\t改名\n```\n## 权限管理\n\n**权限位**\n```\n-rw-r--r--   1   root root     0 08-11 01:45 aa\n```\n权限位是十位\n第一位：代表文件类型\n> \\-\t普通文件\n>\td\t目录文件\n>\tf\t链接文件\n\n常见的文件类型就有以上3种，Linux和Unix系统中共有7种文件类型，分别有\n\t-\tBlock\t\t块设备文件，如某个磁盘分区，软驱和光驱等。\n\t-\tChar\t\t字符设备，如键盘、打印机等。\n\t-\tDir\t\t目录类型，目录也是文件的一种。\n\t-\tFifo\t\t命名管道，常用于将信息从一个进程传递到另一个进程。\n\t-\tFile\t\t普通文件。\n\t-\tLink\t\t符号链接文件，即指向文件指针的指针。\n\t-\tUnknown\t未知类型\n\n其他九位：属主权限u\t\t属主权限g\t\t其他人权限o\n\t-\tr\t读\t\t4\n\t-\tw\t写\t\t2\n\t-\tx\t执行\t\t1\n\n**修改权限**\n\nchmod\n> 格式：chmod  {u,g,o }{+,-,=}{w,r,x} 文件名或目录\n\n例：\n```\nchmod  u+x  aa\nchmod u-x  aa\nchmod  g+w,o-r   aa\nchmod  u=rwx  aa\nchmod  755  aa\nchmod  644  aa\n```\n\n**权限对于文件和目录的意义**\n\n对于文件的意义\n- r：读取文件的内容。cat、more、head、tail\n- w：编辑、修改文件内容。vi、echo\n- x：可执行\n\n对于目录的意义\n- r：可以查询目录下的文件名。ls\n-\tw：具有修改目录结构的权限。比如新建文件和目录，删除此目录下文件和目录，剪切等操作。touch、mv、cp\n-\tx：可以进入目录\t。\tcd\n\n对于目录来说，r和x权限一般是一起给的，及对于目录的权限一般至少会给到6.\n\n**更改文件或目录的属主和属组命令**\n\nchown\n> 格式：chown  用户名  文件名  \n\n例\n```\nchown user1  aa\nchown  user1：user1   aa\t（更改属主的同时改变属主）\n```\n\n## 帮助命令\n**查找命令的的帮助**\n```\nman  命令名\n```\n\n**查看常见的选项**\n```\n命令  --help\n```\nTips：Linux中通配符和正则的使用原则：\n- 在搜索目录或者文件名时Linux使用的是通配符，如find.\t\t\n> Find:\t在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配\n通配符是完全匹配\n\n- 在搜索文件中的内容是，Linux使用的事正则表达式，如grep.\t\t\n> Grep：\t在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配\n正则表达是包含匹配\n\n## 查找命令\n**查找命令的命令，同时查看帮助文档的位置**\n\n```\nwhereis\n格式：whereis   命令\n```\n**搜索命令**\n```\nfind\n格式：find   查找位置   -name   文件名\n例\nfind /   -name   aabbcc    \n\t\t-user   用户名\t\t按属主用户查找文件\n\t\t-group   组名\t\t按属组组名查找文件\n\t\t-nouser\t\t\t查找没有属主的文件\n按照文件属性查找：\n\t\t-name\t\t\t按照文件名\n\t\t-size \t\t\t\t文件大小。+50k：大于50k，-50k：小雨50k，50k：等于50k\t（可用的单位有k，M）\n\t\t-type\t\t\t\t文件类型。（f:普通文件，l：链接文件，d目录文件）\n\t\t-perm\t644\t\t按文件的权限值查找。\n\t\t-iname\t\t\t文件名查找，不区分大小写\n\t\t-inum\t\t\t\t按照文件i节点查找\n在查找出的结果中，直接进行命令操作。\nfind  /var/log/   -mtime   +10  -exec   rm  -rf  {}  \\;\t查找出十天前修改的文件名删除\nfind   /root  -inum   112033   -exec  ls   -l   {}  \\;\t用文件i节点查找到文件并且显示文件的长格式。\n```\n**查找文件中的字符串**\n```\ngrep\n原理：先把命令操作的结果存在文件中，然后后面的命令去操作文件\n格式：grep  “字符串”   文件名\n例：\ngrep  -i  “root” /etc/passwd\n\t\t-i\t忽略大小写\n\t\t-v\t反向选择\n比较：\nfind：在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配。通配符是完全匹配。\ngrep：在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配，正则表达式是包含匹配\n```\n**管道符**\n```\n命令1  |  命令2  |   命令3\t\t命令1的执行结果，作为命令2执行的执行条件，以此类推。\n例：\nnetstat   -an  |  grep  ESTABLISHED  |  wc  -l\t统计正在连接的网络连接的个数\ncat  文件名  |  grep  “字符串”  \t提取含有字符串的行\nls  -l  /etc  |  more \t\t分屏显示ls内容\nll  /etc、  |  grep  my\n```\n\n## 压缩和解压缩\nLinux中常见的压缩包格式\n> .gz\t\tbz2\t\tLinux可以识别的常见压缩格式\n>.tar.gz\t.tar.bz2\t常见的压缩和打包命令\n\n**压缩打包命令**\n- 压缩同时打包\n```\ntar  -zcvf   压缩文件名\t源文件\ntar  -zcvf  aa.tar.gz   aa\n\t-z:识别.gz格式\n\t-c:压缩\n\t-v:显示压缩过程\n\t-f:指定压缩包名\n```\n- 解压缩同时解打包\n```\ntar   -zxvf  压缩文件名\n\t-x: 解压缩\n```\n- 压缩同时打包\n```\ntar  -jcvf  压缩文件名\t源文件\n\t-j：识别.tar.gz2文件格式\n```\n- 解打包同时解压缩\n```\ntar  -jxvf  aa.tar.bz2  \n```\n- 查看不解包\n```\ntar   -ztvf   aa.tar.gz\ntar  -jtvf   aa.tar.bz2\n\t-t:  只查看，不解压\n```\n- 解压到指定压缩位置\n```\ntar  -jxvf  root.tar.bz2   -C  /tmp/  \t（-C一定要写在后边）\n```\n\n## 关闭和重启命令\n\n```\nshutdown\t\t没有特殊情况建议使用此命令来关机\nshutdown  -h  now\t立刻关机\n\t-h\t关机\n\t-r \t重启\n\nreboot 重启命令\n```\n## 挂载命令\nLinux下所有的存储设备都必须挂载使用，包括硬盘\n- 挂载\n```\nmount\n设备文件：\n\t/dev/sda1\t\t第一个SCSI硬盘的第一个分区\n\t/dev/cdrom\t\t光盘（链接）\n\t/dev/hdc\t\t光盘\t\tCentOS 5.5\n\t/dev/sr0\t\t光盘\t\tCentOS6.x\nmount  -t  文件系统  设备描述文件   挂载点（已经存在的空目录）\nmount  -t iso9660  /dev/cdrom  /mnt/cdrom(-t iso9660也可省略)\nmount  /dev/cdrom  /mnt/cdrom\n\nfdisk  -l\t\t列出指定的外围设备的分区表状况\nmount  -t  vfat  /dev/sdb1  /mnt/usb\n```\n- 卸载\n```\numount\numount    /dev/cdrom  \numount   /mnt/cdrom\n强调：退出挂载目录，才能卸载\n```\n## 网络命令\nping测试网络连通性\n```\nping   -c  次数  ip \t（测试网络的通畅）\n```\nifconfig\t\t查询本机网络信息\n>\t-a\t列出所有的网卡信息（包括没启动的）\n\n## 输出重定向和多命令顺序执行\n输出重定向 把应该输出到屏幕的输出，重定向到文件。\n```\n>\t覆盖\n>>\t追加\nls  >  aa\t\t覆盖到aa\nls  >>  aa\t\t追加到aa\nls  gdlslga  2>>aa\t\t错误信息输出到aa\t\t\n强调：错误输出，不能有空格\n```\n错误信息重定向\n```\nls  >>  aa  2>&1\t\t错误和正确都输入到aa，可以追加\n\t\t2>&1\t\t把标准错误重定向到标准正确输出\n\nls  >>  aa  2>>/tmp/bb\t\t正确信息输入aa，错误信息输入bb\n```\n\n## 补充命令\ndate  查看系统时间\n```\n\tdate \t\t\n\tdate\t-s   20140701\t\t设定日期\n\tdate\t-s\t09:30:00\t\t设定时间\n```\n\ndu统计目录大小\n```\n\t\t-sh\t目录名\t\t统计目录大小\n\t\t-s\t\t和\n\t\t-h\t\t习惯单位\n```\nnetstat  \n```\nnetstat  \t\t查看网络状态的命令\n\t-t\t查看TCP端口\n\t-u\t查看UDP端口\n\t-l\t监听\n\t-n\t以IP地址和端口号显示，不用域名和服务名显示\n\t-a\t查询所有连接\n例\nnetstat  -tlun\t\t\n```\n","source":"_posts/Linux常用命令.md","raw":"---\ntitle: Linux常用命令\ndate: 2016-10-06 22:30:00\ncategories:\n- Linux\n---\n\n## Linux命令格式\n格式：命令\t[选项]\t[参数]\n\n例如：\n```\n#ls \t-list \t显示目录下内容\n```\n> 命令操作的对象（文件、目录、用户、进程）\n> Linux中以”.”开头的文件是隐藏文件\n\n提示符：[root@localhost src]#\n> [当前登录用户@主机名 当前所在目录]#\n> #\t超级用户\n> $\t普通用户\n\n当前所在目录：\t用户家目录\n>\t管理员\t\t/root\n>\t普通用户\t\t/home/用户名\n\n**tips：**\n> ctrl +  c\t\t强制终止\n> ctrl+l\t\t\t清屏\n> ctrl+u\t\t光标删除到行首\n> ctrl+a\t\t光标移动到行首\n> ctrl+e\t\t光标移动到行尾\n\n<!-- more -->\n\n## 目录操作命令\n**切换所在目录**\n\n`cd`\n\n例：\n```\ncd  /usr/local/src\ncd   ~\t或cd\t  \t进入当前用户的家目录\ncd  -\t\t进入上次目录\ncd  ..\t\t进入上一级目录\ncd  .\t\t进入当前目录\n```\n**显示当前所在目录**\n\n`pwd`\n\n**建立目录**\n\n`mkdir`\n\n例：\n```\nmkdir  \t-p  11/22/33/44\t\t递归建立目录\n```\n**删除目录**\n```\nrmdir\t目录\t\t只能删除空目录\n\nrm\t文件名\t\t删除文件\nrm\t-rf\t目录\t\t删除文件和目录\n\t\t-f\t强制\n\t\t-r\t递归、删除目录\n```\n**显示指定目录下的所有内容的目录树**\n\ntree\t目录名\n\n例：\n```\ntree\t/var/\n```\n\n## 文件操作命令\n**创建空文件或修改文件时间**\n```\ntouch  文件名\n```\n**删除**\n```\nrm  –rf  文件名\n\t\t-f\t强制\n\t\t-r\t删除目录\n```\n**查看文件内容**\n```\ncat\t文件名\t\t（从头到尾）\n\t\t-n\t列出行号\nmore\t文件名\t\t（分屏显示文件内容）\n空格向下翻\t\tb  向上翻\t\tq  退出\nhead\t文件名\t\t（显示文件头几行）\n\thead  –n  行数\t文件名\t指定显示文件头几行\n\thead  -20  文件名\n```\n**链接文件**\n```\nln  -s  源文件   目标文件\t\t（文件名都必须写绝对路径）\n链接文件相当于windows中的快捷方式，链接文件和源文件修改一个两个都变，删除原文件，软链接打不开。\n```\n## 文件和目录都能操作的命令\n\n**删除文件或目录**\n```\nrm\n```\n\n**复制**\n```\ncp  源文件   目标文件\n\t\t-r\t复制目录\n\t\t-p\t带文件属性复制\n\t\t-d\t若源文件为链接文件，则复制链接属性\n\t\t-a\t相当于  -pdr\n例：\ncp   aa  /tmp/\t\t\t原名复制\ncp  aa  /tmp/bb\t\t\t改名复制\n```\n\n**剪切或改名**\n```\nmv\t源文件   目标位置\n剪切目录不需要加“-r”选项（特殊）\n例：\nmv  /root/aa  /tmp/\t剪切\nmv  aa  bb\t\t\t改名\n```\n## 权限管理\n\n**权限位**\n```\n-rw-r--r--   1   root root     0 08-11 01:45 aa\n```\n权限位是十位\n第一位：代表文件类型\n> \\-\t普通文件\n>\td\t目录文件\n>\tf\t链接文件\n\n常见的文件类型就有以上3种，Linux和Unix系统中共有7种文件类型，分别有\n\t-\tBlock\t\t块设备文件，如某个磁盘分区，软驱和光驱等。\n\t-\tChar\t\t字符设备，如键盘、打印机等。\n\t-\tDir\t\t目录类型，目录也是文件的一种。\n\t-\tFifo\t\t命名管道，常用于将信息从一个进程传递到另一个进程。\n\t-\tFile\t\t普通文件。\n\t-\tLink\t\t符号链接文件，即指向文件指针的指针。\n\t-\tUnknown\t未知类型\n\n其他九位：属主权限u\t\t属主权限g\t\t其他人权限o\n\t-\tr\t读\t\t4\n\t-\tw\t写\t\t2\n\t-\tx\t执行\t\t1\n\n**修改权限**\n\nchmod\n> 格式：chmod  {u,g,o }{+,-,=}{w,r,x} 文件名或目录\n\n例：\n```\nchmod  u+x  aa\nchmod u-x  aa\nchmod  g+w,o-r   aa\nchmod  u=rwx  aa\nchmod  755  aa\nchmod  644  aa\n```\n\n**权限对于文件和目录的意义**\n\n对于文件的意义\n- r：读取文件的内容。cat、more、head、tail\n- w：编辑、修改文件内容。vi、echo\n- x：可执行\n\n对于目录的意义\n- r：可以查询目录下的文件名。ls\n-\tw：具有修改目录结构的权限。比如新建文件和目录，删除此目录下文件和目录，剪切等操作。touch、mv、cp\n-\tx：可以进入目录\t。\tcd\n\n对于目录来说，r和x权限一般是一起给的，及对于目录的权限一般至少会给到6.\n\n**更改文件或目录的属主和属组命令**\n\nchown\n> 格式：chown  用户名  文件名  \n\n例\n```\nchown user1  aa\nchown  user1：user1   aa\t（更改属主的同时改变属主）\n```\n\n## 帮助命令\n**查找命令的的帮助**\n```\nman  命令名\n```\n\n**查看常见的选项**\n```\n命令  --help\n```\nTips：Linux中通配符和正则的使用原则：\n- 在搜索目录或者文件名时Linux使用的是通配符，如find.\t\t\n> Find:\t在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配\n通配符是完全匹配\n\n- 在搜索文件中的内容是，Linux使用的事正则表达式，如grep.\t\t\n> Grep：\t在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配\n正则表达是包含匹配\n\n## 查找命令\n**查找命令的命令，同时查看帮助文档的位置**\n\n```\nwhereis\n格式：whereis   命令\n```\n**搜索命令**\n```\nfind\n格式：find   查找位置   -name   文件名\n例\nfind /   -name   aabbcc    \n\t\t-user   用户名\t\t按属主用户查找文件\n\t\t-group   组名\t\t按属组组名查找文件\n\t\t-nouser\t\t\t查找没有属主的文件\n按照文件属性查找：\n\t\t-name\t\t\t按照文件名\n\t\t-size \t\t\t\t文件大小。+50k：大于50k，-50k：小雨50k，50k：等于50k\t（可用的单位有k，M）\n\t\t-type\t\t\t\t文件类型。（f:普通文件，l：链接文件，d目录文件）\n\t\t-perm\t644\t\t按文件的权限值查找。\n\t\t-iname\t\t\t文件名查找，不区分大小写\n\t\t-inum\t\t\t\t按照文件i节点查找\n在查找出的结果中，直接进行命令操作。\nfind  /var/log/   -mtime   +10  -exec   rm  -rf  {}  \\;\t查找出十天前修改的文件名删除\nfind   /root  -inum   112033   -exec  ls   -l   {}  \\;\t用文件i节点查找到文件并且显示文件的长格式。\n```\n**查找文件中的字符串**\n```\ngrep\n原理：先把命令操作的结果存在文件中，然后后面的命令去操作文件\n格式：grep  “字符串”   文件名\n例：\ngrep  -i  “root” /etc/passwd\n\t\t-i\t忽略大小写\n\t\t-v\t反向选择\n比较：\nfind：在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配。通配符是完全匹配。\ngrep：在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配，正则表达式是包含匹配\n```\n**管道符**\n```\n命令1  |  命令2  |   命令3\t\t命令1的执行结果，作为命令2执行的执行条件，以此类推。\n例：\nnetstat   -an  |  grep  ESTABLISHED  |  wc  -l\t统计正在连接的网络连接的个数\ncat  文件名  |  grep  “字符串”  \t提取含有字符串的行\nls  -l  /etc  |  more \t\t分屏显示ls内容\nll  /etc、  |  grep  my\n```\n\n## 压缩和解压缩\nLinux中常见的压缩包格式\n> .gz\t\tbz2\t\tLinux可以识别的常见压缩格式\n>.tar.gz\t.tar.bz2\t常见的压缩和打包命令\n\n**压缩打包命令**\n- 压缩同时打包\n```\ntar  -zcvf   压缩文件名\t源文件\ntar  -zcvf  aa.tar.gz   aa\n\t-z:识别.gz格式\n\t-c:压缩\n\t-v:显示压缩过程\n\t-f:指定压缩包名\n```\n- 解压缩同时解打包\n```\ntar   -zxvf  压缩文件名\n\t-x: 解压缩\n```\n- 压缩同时打包\n```\ntar  -jcvf  压缩文件名\t源文件\n\t-j：识别.tar.gz2文件格式\n```\n- 解打包同时解压缩\n```\ntar  -jxvf  aa.tar.bz2  \n```\n- 查看不解包\n```\ntar   -ztvf   aa.tar.gz\ntar  -jtvf   aa.tar.bz2\n\t-t:  只查看，不解压\n```\n- 解压到指定压缩位置\n```\ntar  -jxvf  root.tar.bz2   -C  /tmp/  \t（-C一定要写在后边）\n```\n\n## 关闭和重启命令\n\n```\nshutdown\t\t没有特殊情况建议使用此命令来关机\nshutdown  -h  now\t立刻关机\n\t-h\t关机\n\t-r \t重启\n\nreboot 重启命令\n```\n## 挂载命令\nLinux下所有的存储设备都必须挂载使用，包括硬盘\n- 挂载\n```\nmount\n设备文件：\n\t/dev/sda1\t\t第一个SCSI硬盘的第一个分区\n\t/dev/cdrom\t\t光盘（链接）\n\t/dev/hdc\t\t光盘\t\tCentOS 5.5\n\t/dev/sr0\t\t光盘\t\tCentOS6.x\nmount  -t  文件系统  设备描述文件   挂载点（已经存在的空目录）\nmount  -t iso9660  /dev/cdrom  /mnt/cdrom(-t iso9660也可省略)\nmount  /dev/cdrom  /mnt/cdrom\n\nfdisk  -l\t\t列出指定的外围设备的分区表状况\nmount  -t  vfat  /dev/sdb1  /mnt/usb\n```\n- 卸载\n```\numount\numount    /dev/cdrom  \numount   /mnt/cdrom\n强调：退出挂载目录，才能卸载\n```\n## 网络命令\nping测试网络连通性\n```\nping   -c  次数  ip \t（测试网络的通畅）\n```\nifconfig\t\t查询本机网络信息\n>\t-a\t列出所有的网卡信息（包括没启动的）\n\n## 输出重定向和多命令顺序执行\n输出重定向 把应该输出到屏幕的输出，重定向到文件。\n```\n>\t覆盖\n>>\t追加\nls  >  aa\t\t覆盖到aa\nls  >>  aa\t\t追加到aa\nls  gdlslga  2>>aa\t\t错误信息输出到aa\t\t\n强调：错误输出，不能有空格\n```\n错误信息重定向\n```\nls  >>  aa  2>&1\t\t错误和正确都输入到aa，可以追加\n\t\t2>&1\t\t把标准错误重定向到标准正确输出\n\nls  >>  aa  2>>/tmp/bb\t\t正确信息输入aa，错误信息输入bb\n```\n\n## 补充命令\ndate  查看系统时间\n```\n\tdate \t\t\n\tdate\t-s   20140701\t\t设定日期\n\tdate\t-s\t09:30:00\t\t设定时间\n```\n\ndu统计目录大小\n```\n\t\t-sh\t目录名\t\t统计目录大小\n\t\t-s\t\t和\n\t\t-h\t\t习惯单位\n```\nnetstat  \n```\nnetstat  \t\t查看网络状态的命令\n\t-t\t查看TCP端口\n\t-u\t查看UDP端口\n\t-l\t监听\n\t-n\t以IP地址和端口号显示，不用域名和服务名显示\n\t-a\t查询所有连接\n例\nnetstat  -tlun\t\t\n```\n","slug":"Linux常用命令","published":1,"updated":"2016-10-07T13:34:14.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwv4000p699fdcxry85j","content":"<h2 id=\"Linux命令格式\"><a href=\"#Linux命令格式\" class=\"headerlink\" title=\"Linux命令格式\"></a>Linux命令格式</h2><p>格式：命令    [选项]    [参数]</p>\n<p>例如：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">#ls \t-list \t显示目录下内容</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>命令操作的对象（文件、目录、用户、进程）<br>Linux中以”.”开头的文件是隐藏文件</p>\n</blockquote>\n<p>提示符：[root@localhost src]#</p>\n<blockquote>\n<p>[当前登录用户@主机名 当前所在目录]#</p>\n<h1 id=\"超级用户\"><a href=\"#超级用户\" class=\"headerlink\" title=\"超级用户\"></a>超级用户</h1><p>$    普通用户</p>\n</blockquote>\n<p>当前所在目录：    用户家目录</p>\n<blockquote>\n<p>   管理员        /root<br>   普通用户        /home/用户名</p>\n</blockquote>\n<p><strong>tips：</strong></p>\n<blockquote>\n<p>ctrl +  c        强制终止<br>ctrl+l            清屏<br>ctrl+u        光标删除到行首<br>ctrl+a        光标移动到行首<br>ctrl+e        光标移动到行尾</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"目录操作命令\"><a href=\"#目录操作命令\" class=\"headerlink\" title=\"目录操作命令\"></a>目录操作命令</h2><p><strong>切换所在目录</strong></p>\n<p><code>cd</code></p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd  /usr/local/src</div><div class=\"line\">cd   ~\t或cd\t  \t进入当前用户的家目录</div><div class=\"line\">cd  -\t\t进入上次目录</div><div class=\"line\">cd  ..\t\t进入上一级目录</div><div class=\"line\">cd  .\t\t进入当前目录</div></pre></td></tr></table></figure></p>\n<p><strong>显示当前所在目录</strong></p>\n<p><code>pwd</code></p>\n<p><strong>建立目录</strong></p>\n<p><code>mkdir</code></p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mkdir  \t-p  11/22/33/44\t\t递归建立目录</div></pre></td></tr></table></figure></p>\n<p><strong>删除目录</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">rmdir\t目录\t\t只能删除空目录</div><div class=\"line\"></div><div class=\"line\">rm\t文件名\t\t删除文件</div><div class=\"line\">rm\t-rf\t目录\t\t删除文件和目录</div><div class=\"line\">\t\t-f\t强制</div><div class=\"line\">\t\t-r\t递归、删除目录</div></pre></td></tr></table></figure></p>\n<p><strong>显示指定目录下的所有内容的目录树</strong></p>\n<p>tree    目录名</p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tree\t/var/</div></pre></td></tr></table></figure></p>\n<h2 id=\"文件操作命令\"><a href=\"#文件操作命令\" class=\"headerlink\" title=\"文件操作命令\"></a>文件操作命令</h2><p><strong>创建空文件或修改文件时间</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">touch  文件名</div></pre></td></tr></table></figure></p>\n<p><strong>删除</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm  –rf  文件名</div><div class=\"line\">\t\t-f\t强制</div><div class=\"line\">\t\t-r\t删除目录</div></pre></td></tr></table></figure></p>\n<p><strong>查看文件内容</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">cat\t文件名\t\t（从头到尾）</div><div class=\"line\">\t\t-n\t列出行号</div><div class=\"line\">more\t文件名\t\t（分屏显示文件内容）</div><div class=\"line\">空格向下翻\t\tb  向上翻\t\tq  退出</div><div class=\"line\">head\t文件名\t\t（显示文件头几行）</div><div class=\"line\">\thead  –n  行数\t文件名\t指定显示文件头几行</div><div class=\"line\">\thead  -20  文件名</div></pre></td></tr></table></figure></p>\n<p><strong>链接文件</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ln  -s  源文件   目标文件\t\t（文件名都必须写绝对路径）</div><div class=\"line\">链接文件相当于windows中的快捷方式，链接文件和源文件修改一个两个都变，删除原文件，软链接打不开。</div></pre></td></tr></table></figure></p>\n<h2 id=\"文件和目录都能操作的命令\"><a href=\"#文件和目录都能操作的命令\" class=\"headerlink\" title=\"文件和目录都能操作的命令\"></a>文件和目录都能操作的命令</h2><p><strong>删除文件或目录</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm</div></pre></td></tr></table></figure></p>\n<p><strong>复制</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp  源文件   目标文件</div><div class=\"line\">\t\t-r\t复制目录</div><div class=\"line\">\t\t-p\t带文件属性复制</div><div class=\"line\">\t\t-d\t若源文件为链接文件，则复制链接属性</div><div class=\"line\">\t\t-a\t相当于  -pdr</div><div class=\"line\">例：</div><div class=\"line\">cp   aa  /tmp/\t\t\t原名复制</div><div class=\"line\">cp  aa  /tmp/bb\t\t\t改名复制</div></pre></td></tr></table></figure></p>\n<p><strong>剪切或改名</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">mv\t源文件   目标位置</div><div class=\"line\">剪切目录不需要加“-r”选项（特殊）</div><div class=\"line\">例：</div><div class=\"line\">mv  /root/aa  /tmp/\t剪切</div><div class=\"line\">mv  aa  bb\t\t\t改名</div></pre></td></tr></table></figure></p>\n<h2 id=\"权限管理\"><a href=\"#权限管理\" class=\"headerlink\" title=\"权限管理\"></a>权限管理</h2><p><strong>权限位</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">-rw-r--r--   1   root root     0 08-11 01:45 aa</div></pre></td></tr></table></figure></p>\n<p>权限位是十位<br>第一位：代表文件类型</p>\n<blockquote>\n<p>-    普通文件<br>   d    目录文件<br>   f    链接文件</p>\n</blockquote>\n<p>常见的文件类型就有以上3种，Linux和Unix系统中共有7种文件类型，分别有</p>\n<pre><code>-    Block        块设备文件，如某个磁盘分区，软驱和光驱等。\n-    Char        字符设备，如键盘、打印机等。\n-    Dir        目录类型，目录也是文件的一种。\n-    Fifo        命名管道，常用于将信息从一个进程传递到另一个进程。\n-    File        普通文件。\n-    Link        符号链接文件，即指向文件指针的指针。\n-    Unknown    未知类型\n</code></pre><p>其他九位：属主权限u        属主权限g        其他人权限o</p>\n<pre><code>-    r    读        4\n-    w    写        2\n-    x    执行        1\n</code></pre><p><strong>修改权限</strong></p>\n<p>chmod</p>\n<blockquote>\n<p>格式：chmod  {u,g,o }{+,-,=}{w,r,x} 文件名或目录</p>\n</blockquote>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">chmod  u+x  aa</div><div class=\"line\">chmod u-x  aa</div><div class=\"line\">chmod  g+w,o-r   aa</div><div class=\"line\">chmod  u=rwx  aa</div><div class=\"line\">chmod  755  aa</div><div class=\"line\">chmod  644  aa</div></pre></td></tr></table></figure></p>\n<p><strong>权限对于文件和目录的意义</strong></p>\n<p>对于文件的意义</p>\n<ul>\n<li>r：读取文件的内容。cat、more、head、tail</li>\n<li>w：编辑、修改文件内容。vi、echo</li>\n<li>x：可执行</li>\n</ul>\n<p>对于目录的意义</p>\n<ul>\n<li>r：可以查询目录下的文件名。ls</li>\n<li>w：具有修改目录结构的权限。比如新建文件和目录，删除此目录下文件和目录，剪切等操作。touch、mv、cp</li>\n<li>x：可以进入目录    。    cd</li>\n</ul>\n<p>对于目录来说，r和x权限一般是一起给的，及对于目录的权限一般至少会给到6.</p>\n<p><strong>更改文件或目录的属主和属组命令</strong></p>\n<p>chown</p>\n<blockquote>\n<p>格式：chown  用户名  文件名  </p>\n</blockquote>\n<p>例<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">chown user1  aa</div><div class=\"line\">chown  user1：user1   aa\t（更改属主的同时改变属主）</div></pre></td></tr></table></figure></p>\n<h2 id=\"帮助命令\"><a href=\"#帮助命令\" class=\"headerlink\" title=\"帮助命令\"></a>帮助命令</h2><p><strong>查找命令的的帮助</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">man  命令名</div></pre></td></tr></table></figure></p>\n<p><strong>查看常见的选项</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">命令  --help</div></pre></td></tr></table></figure></p>\n<p>Tips：Linux中通配符和正则的使用原则：</p>\n<ul>\n<li><p>在搜索目录或者文件名时Linux使用的是通配符，如find.        </p>\n<blockquote>\n<p>Find:    在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配<br>通配符是完全匹配</p>\n</blockquote>\n</li>\n<li><p>在搜索文件中的内容是，Linux使用的事正则表达式，如grep.        </p>\n<blockquote>\n<p>Grep：    在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配<br>正则表达是包含匹配</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"查找命令\"><a href=\"#查找命令\" class=\"headerlink\" title=\"查找命令\"></a>查找命令</h2><p><strong>查找命令的命令，同时查看帮助文档的位置</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">whereis</div><div class=\"line\">格式：whereis   命令</div></pre></td></tr></table></figure>\n<p><strong>搜索命令</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">find</div><div class=\"line\">格式：find   查找位置   -name   文件名</div><div class=\"line\">例</div><div class=\"line\">find /   -name   aabbcc    </div><div class=\"line\">\t\t-user   用户名\t\t按属主用户查找文件</div><div class=\"line\">\t\t-group   组名\t\t按属组组名查找文件</div><div class=\"line\">\t\t-nouser\t\t\t查找没有属主的文件</div><div class=\"line\">按照文件属性查找：</div><div class=\"line\">\t\t-name\t\t\t按照文件名</div><div class=\"line\">\t\t-size \t\t\t\t文件大小。+50k：大于50k，-50k：小雨50k，50k：等于50k\t（可用的单位有k，M）</div><div class=\"line\">\t\t-type\t\t\t\t文件类型。（f:普通文件，l：链接文件，d目录文件）</div><div class=\"line\">\t\t-perm\t644\t\t按文件的权限值查找。</div><div class=\"line\">\t\t-iname\t\t\t文件名查找，不区分大小写</div><div class=\"line\">\t\t-inum\t\t\t\t按照文件i节点查找</div><div class=\"line\">在查找出的结果中，直接进行命令操作。</div><div class=\"line\">find  /var/log/   -mtime   +10  -exec   rm  -rf  &#123;&#125;  \\;\t查找出十天前修改的文件名删除</div><div class=\"line\">find   /root  -inum   112033   -exec  ls   -l   &#123;&#125;  \\;\t用文件i节点查找到文件并且显示文件的长格式。</div></pre></td></tr></table></figure></p>\n<p><strong>查找文件中的字符串</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">grep</div><div class=\"line\">原理：先把命令操作的结果存在文件中，然后后面的命令去操作文件</div><div class=\"line\">格式：grep  “字符串”   文件名</div><div class=\"line\">例：</div><div class=\"line\">grep  -i  “root” /etc/passwd</div><div class=\"line\">\t\t-i\t忽略大小写</div><div class=\"line\">\t\t-v\t反向选择</div><div class=\"line\">比较：</div><div class=\"line\">find：在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配。通配符是完全匹配。</div><div class=\"line\">grep：在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配，正则表达式是包含匹配</div></pre></td></tr></table></figure></p>\n<p><strong>管道符</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">命令1  |  命令2  |   命令3\t\t命令1的执行结果，作为命令2执行的执行条件，以此类推。</div><div class=\"line\">例：</div><div class=\"line\">netstat   -an  |  grep  ESTABLISHED  |  wc  -l\t统计正在连接的网络连接的个数</div><div class=\"line\">cat  文件名  |  grep  “字符串”  \t提取含有字符串的行</div><div class=\"line\">ls  -l  /etc  |  more \t\t分屏显示ls内容</div><div class=\"line\">ll  /etc、  |  grep  my</div></pre></td></tr></table></figure></p>\n<h2 id=\"压缩和解压缩\"><a href=\"#压缩和解压缩\" class=\"headerlink\" title=\"压缩和解压缩\"></a>压缩和解压缩</h2><p>Linux中常见的压缩包格式</p>\n<blockquote>\n<p>.gz        bz2        Linux可以识别的常见压缩格式<br>.tar.gz    .tar.bz2    常见的压缩和打包命令</p>\n</blockquote>\n<p><strong>压缩打包命令</strong></p>\n<ul>\n<li><p>压缩同时打包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -zcvf   压缩文件名\t源文件</div><div class=\"line\">tar  -zcvf  aa.tar.gz   aa</div><div class=\"line\">\t-z:识别.gz格式</div><div class=\"line\">\t-c:压缩</div><div class=\"line\">\t-v:显示压缩过程</div><div class=\"line\">\t-f:指定压缩包名</div></pre></td></tr></table></figure>\n</li>\n<li><p>解压缩同时解打包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar   -zxvf  压缩文件名</div><div class=\"line\">\t-x: 解压缩</div></pre></td></tr></table></figure>\n</li>\n<li><p>压缩同时打包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -jcvf  压缩文件名\t源文件</div><div class=\"line\">\t-j：识别.tar.gz2文件格式</div></pre></td></tr></table></figure>\n</li>\n<li><p>解打包同时解压缩</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -jxvf  aa.tar.bz2</div></pre></td></tr></table></figure>\n</li>\n<li><p>查看不解包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar   -ztvf   aa.tar.gz</div><div class=\"line\">tar  -jtvf   aa.tar.bz2</div><div class=\"line\">\t-t:  只查看，不解压</div></pre></td></tr></table></figure>\n</li>\n<li><p>解压到指定压缩位置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -jxvf  root.tar.bz2   -C  /tmp/  \t（-C一定要写在后边）</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"关闭和重启命令\"><a href=\"#关闭和重启命令\" class=\"headerlink\" title=\"关闭和重启命令\"></a>关闭和重启命令</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">shutdown\t\t没有特殊情况建议使用此命令来关机</div><div class=\"line\">shutdown  -h  now\t立刻关机</div><div class=\"line\">\t-h\t关机</div><div class=\"line\">\t-r \t重启</div><div class=\"line\"></div><div class=\"line\">reboot 重启命令</div></pre></td></tr></table></figure>\n<h2 id=\"挂载命令\"><a href=\"#挂载命令\" class=\"headerlink\" title=\"挂载命令\"></a>挂载命令</h2><p>Linux下所有的存储设备都必须挂载使用，包括硬盘</p>\n<ul>\n<li><p>挂载</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">mount</div><div class=\"line\">设备文件：</div><div class=\"line\">\t/dev/sda1\t\t第一个SCSI硬盘的第一个分区</div><div class=\"line\">\t/dev/cdrom\t\t光盘（链接）</div><div class=\"line\">\t/dev/hdc\t\t光盘\t\tCentOS 5.5</div><div class=\"line\">\t/dev/sr0\t\t光盘\t\tCentOS6.x</div><div class=\"line\">mount  -t  文件系统  设备描述文件   挂载点（已经存在的空目录）</div><div class=\"line\">mount  -t iso9660  /dev/cdrom  /mnt/cdrom(-t iso9660也可省略)</div><div class=\"line\">mount  /dev/cdrom  /mnt/cdrom</div><div class=\"line\"></div><div class=\"line\">fdisk  -l\t\t列出指定的外围设备的分区表状况</div><div class=\"line\">mount  -t  vfat  /dev/sdb1  /mnt/usb</div></pre></td></tr></table></figure>\n</li>\n<li><p>卸载</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">umount</div><div class=\"line\">umount    /dev/cdrom  </div><div class=\"line\">umount   /mnt/cdrom</div><div class=\"line\">强调：退出挂载目录，才能卸载</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"网络命令\"><a href=\"#网络命令\" class=\"headerlink\" title=\"网络命令\"></a>网络命令</h2><p>ping测试网络连通性<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ping   -c  次数  ip \t（测试网络的通畅）</div></pre></td></tr></table></figure></p>\n<p>ifconfig        查询本机网络信息</p>\n<blockquote>\n<p>   -a    列出所有的网卡信息（包括没启动的）</p>\n</blockquote>\n<h2 id=\"输出重定向和多命令顺序执行\"><a href=\"#输出重定向和多命令顺序执行\" class=\"headerlink\" title=\"输出重定向和多命令顺序执行\"></a>输出重定向和多命令顺序执行</h2><p>输出重定向 把应该输出到屏幕的输出，重定向到文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt;\t覆盖</div><div class=\"line\">&gt;&gt;\t追加</div><div class=\"line\">ls  &gt;  aa\t\t覆盖到aa</div><div class=\"line\">ls  &gt;&gt;  aa\t\t追加到aa</div><div class=\"line\">ls  gdlslga  2&gt;&gt;aa\t\t错误信息输出到aa\t\t</div><div class=\"line\">强调：错误输出，不能有空格</div></pre></td></tr></table></figure></p>\n<p>错误信息重定向<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">ls  &gt;&gt;  aa  2&gt;&amp;1\t\t错误和正确都输入到aa，可以追加</div><div class=\"line\">\t\t2&gt;&amp;1\t\t把标准错误重定向到标准正确输出</div><div class=\"line\"></div><div class=\"line\">ls  &gt;&gt;  aa  2&gt;&gt;/tmp/bb\t\t正确信息输入aa，错误信息输入bb</div></pre></td></tr></table></figure></p>\n<h2 id=\"补充命令\"><a href=\"#补充命令\" class=\"headerlink\" title=\"补充命令\"></a>补充命令</h2><p>date  查看系统时间<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">date \t\t</div><div class=\"line\">date\t-s   20140701\t\t设定日期</div><div class=\"line\">date\t-s\t09:30:00\t\t设定时间</div></pre></td></tr></table></figure></p>\n<p>du统计目录大小<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">-sh\t目录名\t\t统计目录大小</div><div class=\"line\">-s\t\t和</div><div class=\"line\">-h\t\t习惯单位</div></pre></td></tr></table></figure></p>\n<p>netstat<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">netstat  \t\t查看网络状态的命令</div><div class=\"line\">\t-t\t查看TCP端口</div><div class=\"line\">\t-u\t查看UDP端口</div><div class=\"line\">\t-l\t监听</div><div class=\"line\">\t-n\t以IP地址和端口号显示，不用域名和服务名显示</div><div class=\"line\">\t-a\t查询所有连接</div><div class=\"line\">例</div><div class=\"line\">netstat  -tlun</div></pre></td></tr></table></figure></p>\n","excerpt":"<h2 id=\"Linux命令格式\"><a href=\"#Linux命令格式\" class=\"headerlink\" title=\"Linux命令格式\"></a>Linux命令格式</h2><p>格式：命令    [选项]    [参数]</p>\n<p>例如：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">#ls \t-list \t显示目录下内容</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>命令操作的对象（文件、目录、用户、进程）<br>Linux中以”.”开头的文件是隐藏文件</p>\n</blockquote>\n<p>提示符：[root@localhost src]#</p>\n<blockquote>\n<p>[当前登录用户@主机名 当前所在目录]#</p>\n<h1 id=\"超级用户\"><a href=\"#超级用户\" class=\"headerlink\" title=\"超级用户\"></a>超级用户</h1><p>$    普通用户</p>\n</blockquote>\n<p>当前所在目录：    用户家目录</p>\n<blockquote>\n<p>   管理员        /root<br>   普通用户        /home/用户名</p>\n</blockquote>\n<p><strong>tips：</strong></p>\n<blockquote>\n<p>ctrl +  c        强制终止<br>ctrl+l            清屏<br>ctrl+u        光标删除到行首<br>ctrl+a        光标移动到行首<br>ctrl+e        光标移动到行尾</p>\n</blockquote>","more":"<h2 id=\"目录操作命令\"><a href=\"#目录操作命令\" class=\"headerlink\" title=\"目录操作命令\"></a>目录操作命令</h2><p><strong>切换所在目录</strong></p>\n<p><code>cd</code></p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd  /usr/local/src</div><div class=\"line\">cd   ~\t或cd\t  \t进入当前用户的家目录</div><div class=\"line\">cd  -\t\t进入上次目录</div><div class=\"line\">cd  ..\t\t进入上一级目录</div><div class=\"line\">cd  .\t\t进入当前目录</div></pre></td></tr></table></figure></p>\n<p><strong>显示当前所在目录</strong></p>\n<p><code>pwd</code></p>\n<p><strong>建立目录</strong></p>\n<p><code>mkdir</code></p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mkdir  \t-p  11/22/33/44\t\t递归建立目录</div></pre></td></tr></table></figure></p>\n<p><strong>删除目录</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">rmdir\t目录\t\t只能删除空目录</div><div class=\"line\"></div><div class=\"line\">rm\t文件名\t\t删除文件</div><div class=\"line\">rm\t-rf\t目录\t\t删除文件和目录</div><div class=\"line\">\t\t-f\t强制</div><div class=\"line\">\t\t-r\t递归、删除目录</div></pre></td></tr></table></figure></p>\n<p><strong>显示指定目录下的所有内容的目录树</strong></p>\n<p>tree    目录名</p>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tree\t/var/</div></pre></td></tr></table></figure></p>\n<h2 id=\"文件操作命令\"><a href=\"#文件操作命令\" class=\"headerlink\" title=\"文件操作命令\"></a>文件操作命令</h2><p><strong>创建空文件或修改文件时间</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">touch  文件名</div></pre></td></tr></table></figure></p>\n<p><strong>删除</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm  –rf  文件名</div><div class=\"line\">\t\t-f\t强制</div><div class=\"line\">\t\t-r\t删除目录</div></pre></td></tr></table></figure></p>\n<p><strong>查看文件内容</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">cat\t文件名\t\t（从头到尾）</div><div class=\"line\">\t\t-n\t列出行号</div><div class=\"line\">more\t文件名\t\t（分屏显示文件内容）</div><div class=\"line\">空格向下翻\t\tb  向上翻\t\tq  退出</div><div class=\"line\">head\t文件名\t\t（显示文件头几行）</div><div class=\"line\">\thead  –n  行数\t文件名\t指定显示文件头几行</div><div class=\"line\">\thead  -20  文件名</div></pre></td></tr></table></figure></p>\n<p><strong>链接文件</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ln  -s  源文件   目标文件\t\t（文件名都必须写绝对路径）</div><div class=\"line\">链接文件相当于windows中的快捷方式，链接文件和源文件修改一个两个都变，删除原文件，软链接打不开。</div></pre></td></tr></table></figure></p>\n<h2 id=\"文件和目录都能操作的命令\"><a href=\"#文件和目录都能操作的命令\" class=\"headerlink\" title=\"文件和目录都能操作的命令\"></a>文件和目录都能操作的命令</h2><p><strong>删除文件或目录</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm</div></pre></td></tr></table></figure></p>\n<p><strong>复制</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp  源文件   目标文件</div><div class=\"line\">\t\t-r\t复制目录</div><div class=\"line\">\t\t-p\t带文件属性复制</div><div class=\"line\">\t\t-d\t若源文件为链接文件，则复制链接属性</div><div class=\"line\">\t\t-a\t相当于  -pdr</div><div class=\"line\">例：</div><div class=\"line\">cp   aa  /tmp/\t\t\t原名复制</div><div class=\"line\">cp  aa  /tmp/bb\t\t\t改名复制</div></pre></td></tr></table></figure></p>\n<p><strong>剪切或改名</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">mv\t源文件   目标位置</div><div class=\"line\">剪切目录不需要加“-r”选项（特殊）</div><div class=\"line\">例：</div><div class=\"line\">mv  /root/aa  /tmp/\t剪切</div><div class=\"line\">mv  aa  bb\t\t\t改名</div></pre></td></tr></table></figure></p>\n<h2 id=\"权限管理\"><a href=\"#权限管理\" class=\"headerlink\" title=\"权限管理\"></a>权限管理</h2><p><strong>权限位</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">-rw-r--r--   1   root root     0 08-11 01:45 aa</div></pre></td></tr></table></figure></p>\n<p>权限位是十位<br>第一位：代表文件类型</p>\n<blockquote>\n<p>-    普通文件<br>   d    目录文件<br>   f    链接文件</p>\n</blockquote>\n<p>常见的文件类型就有以上3种，Linux和Unix系统中共有7种文件类型，分别有</p>\n<pre><code>-    Block        块设备文件，如某个磁盘分区，软驱和光驱等。\n-    Char        字符设备，如键盘、打印机等。\n-    Dir        目录类型，目录也是文件的一种。\n-    Fifo        命名管道，常用于将信息从一个进程传递到另一个进程。\n-    File        普通文件。\n-    Link        符号链接文件，即指向文件指针的指针。\n-    Unknown    未知类型\n</code></pre><p>其他九位：属主权限u        属主权限g        其他人权限o</p>\n<pre><code>-    r    读        4\n-    w    写        2\n-    x    执行        1\n</code></pre><p><strong>修改权限</strong></p>\n<p>chmod</p>\n<blockquote>\n<p>格式：chmod  {u,g,o }{+,-,=}{w,r,x} 文件名或目录</p>\n</blockquote>\n<p>例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">chmod  u+x  aa</div><div class=\"line\">chmod u-x  aa</div><div class=\"line\">chmod  g+w,o-r   aa</div><div class=\"line\">chmod  u=rwx  aa</div><div class=\"line\">chmod  755  aa</div><div class=\"line\">chmod  644  aa</div></pre></td></tr></table></figure></p>\n<p><strong>权限对于文件和目录的意义</strong></p>\n<p>对于文件的意义</p>\n<ul>\n<li>r：读取文件的内容。cat、more、head、tail</li>\n<li>w：编辑、修改文件内容。vi、echo</li>\n<li>x：可执行</li>\n</ul>\n<p>对于目录的意义</p>\n<ul>\n<li>r：可以查询目录下的文件名。ls</li>\n<li>w：具有修改目录结构的权限。比如新建文件和目录，删除此目录下文件和目录，剪切等操作。touch、mv、cp</li>\n<li>x：可以进入目录    。    cd</li>\n</ul>\n<p>对于目录来说，r和x权限一般是一起给的，及对于目录的权限一般至少会给到6.</p>\n<p><strong>更改文件或目录的属主和属组命令</strong></p>\n<p>chown</p>\n<blockquote>\n<p>格式：chown  用户名  文件名  </p>\n</blockquote>\n<p>例<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">chown user1  aa</div><div class=\"line\">chown  user1：user1   aa\t（更改属主的同时改变属主）</div></pre></td></tr></table></figure></p>\n<h2 id=\"帮助命令\"><a href=\"#帮助命令\" class=\"headerlink\" title=\"帮助命令\"></a>帮助命令</h2><p><strong>查找命令的的帮助</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">man  命令名</div></pre></td></tr></table></figure></p>\n<p><strong>查看常见的选项</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">命令  --help</div></pre></td></tr></table></figure></p>\n<p>Tips：Linux中通配符和正则的使用原则：</p>\n<ul>\n<li><p>在搜索目录或者文件名时Linux使用的是通配符，如find.        </p>\n<blockquote>\n<p>Find:    在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配<br>通配符是完全匹配</p>\n</blockquote>\n</li>\n<li><p>在搜索文件中的内容是，Linux使用的事正则表达式，如grep.        </p>\n<blockquote>\n<p>Grep：    在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配<br>正则表达是包含匹配</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"查找命令\"><a href=\"#查找命令\" class=\"headerlink\" title=\"查找命令\"></a>查找命令</h2><p><strong>查找命令的命令，同时查看帮助文档的位置</strong></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">whereis</div><div class=\"line\">格式：whereis   命令</div></pre></td></tr></table></figure>\n<p><strong>搜索命令</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">find</div><div class=\"line\">格式：find   查找位置   -name   文件名</div><div class=\"line\">例</div><div class=\"line\">find /   -name   aabbcc    </div><div class=\"line\">\t\t-user   用户名\t\t按属主用户查找文件</div><div class=\"line\">\t\t-group   组名\t\t按属组组名查找文件</div><div class=\"line\">\t\t-nouser\t\t\t查找没有属主的文件</div><div class=\"line\">按照文件属性查找：</div><div class=\"line\">\t\t-name\t\t\t按照文件名</div><div class=\"line\">\t\t-size \t\t\t\t文件大小。+50k：大于50k，-50k：小雨50k，50k：等于50k\t（可用的单位有k，M）</div><div class=\"line\">\t\t-type\t\t\t\t文件类型。（f:普通文件，l：链接文件，d目录文件）</div><div class=\"line\">\t\t-perm\t644\t\t按文件的权限值查找。</div><div class=\"line\">\t\t-iname\t\t\t文件名查找，不区分大小写</div><div class=\"line\">\t\t-inum\t\t\t\t按照文件i节点查找</div><div class=\"line\">在查找出的结果中，直接进行命令操作。</div><div class=\"line\">find  /var/log/   -mtime   +10  -exec   rm  -rf  &#123;&#125;  \\;\t查找出十天前修改的文件名删除</div><div class=\"line\">find   /root  -inum   112033   -exec  ls   -l   &#123;&#125;  \\;\t用文件i节点查找到文件并且显示文件的长格式。</div></pre></td></tr></table></figure></p>\n<p><strong>查找文件中的字符串</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">grep</div><div class=\"line\">原理：先把命令操作的结果存在文件中，然后后面的命令去操作文件</div><div class=\"line\">格式：grep  “字符串”   文件名</div><div class=\"line\">例：</div><div class=\"line\">grep  -i  “root” /etc/passwd</div><div class=\"line\">\t\t-i\t忽略大小写</div><div class=\"line\">\t\t-v\t反向选择</div><div class=\"line\">比较：</div><div class=\"line\">find：在系统当中搜索符合条件的文件名，如果需要匹配，使用通配符匹配。通配符是完全匹配。</div><div class=\"line\">grep：在文件当中搜索符合条件的字符串，如果需要匹配，使用正则表达式匹配，正则表达式是包含匹配</div></pre></td></tr></table></figure></p>\n<p><strong>管道符</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">命令1  |  命令2  |   命令3\t\t命令1的执行结果，作为命令2执行的执行条件，以此类推。</div><div class=\"line\">例：</div><div class=\"line\">netstat   -an  |  grep  ESTABLISHED  |  wc  -l\t统计正在连接的网络连接的个数</div><div class=\"line\">cat  文件名  |  grep  “字符串”  \t提取含有字符串的行</div><div class=\"line\">ls  -l  /etc  |  more \t\t分屏显示ls内容</div><div class=\"line\">ll  /etc、  |  grep  my</div></pre></td></tr></table></figure></p>\n<h2 id=\"压缩和解压缩\"><a href=\"#压缩和解压缩\" class=\"headerlink\" title=\"压缩和解压缩\"></a>压缩和解压缩</h2><p>Linux中常见的压缩包格式</p>\n<blockquote>\n<p>.gz        bz2        Linux可以识别的常见压缩格式<br>.tar.gz    .tar.bz2    常见的压缩和打包命令</p>\n</blockquote>\n<p><strong>压缩打包命令</strong></p>\n<ul>\n<li><p>压缩同时打包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -zcvf   压缩文件名\t源文件</div><div class=\"line\">tar  -zcvf  aa.tar.gz   aa</div><div class=\"line\">\t-z:识别.gz格式</div><div class=\"line\">\t-c:压缩</div><div class=\"line\">\t-v:显示压缩过程</div><div class=\"line\">\t-f:指定压缩包名</div></pre></td></tr></table></figure>\n</li>\n<li><p>解压缩同时解打包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar   -zxvf  压缩文件名</div><div class=\"line\">\t-x: 解压缩</div></pre></td></tr></table></figure>\n</li>\n<li><p>压缩同时打包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -jcvf  压缩文件名\t源文件</div><div class=\"line\">\t-j：识别.tar.gz2文件格式</div></pre></td></tr></table></figure>\n</li>\n<li><p>解打包同时解压缩</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -jxvf  aa.tar.bz2</div></pre></td></tr></table></figure>\n</li>\n<li><p>查看不解包</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar   -ztvf   aa.tar.gz</div><div class=\"line\">tar  -jtvf   aa.tar.bz2</div><div class=\"line\">\t-t:  只查看，不解压</div></pre></td></tr></table></figure>\n</li>\n<li><p>解压到指定压缩位置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar  -jxvf  root.tar.bz2   -C  /tmp/  \t（-C一定要写在后边）</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"关闭和重启命令\"><a href=\"#关闭和重启命令\" class=\"headerlink\" title=\"关闭和重启命令\"></a>关闭和重启命令</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">shutdown\t\t没有特殊情况建议使用此命令来关机</div><div class=\"line\">shutdown  -h  now\t立刻关机</div><div class=\"line\">\t-h\t关机</div><div class=\"line\">\t-r \t重启</div><div class=\"line\"></div><div class=\"line\">reboot 重启命令</div></pre></td></tr></table></figure>\n<h2 id=\"挂载命令\"><a href=\"#挂载命令\" class=\"headerlink\" title=\"挂载命令\"></a>挂载命令</h2><p>Linux下所有的存储设备都必须挂载使用，包括硬盘</p>\n<ul>\n<li><p>挂载</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">mount</div><div class=\"line\">设备文件：</div><div class=\"line\">\t/dev/sda1\t\t第一个SCSI硬盘的第一个分区</div><div class=\"line\">\t/dev/cdrom\t\t光盘（链接）</div><div class=\"line\">\t/dev/hdc\t\t光盘\t\tCentOS 5.5</div><div class=\"line\">\t/dev/sr0\t\t光盘\t\tCentOS6.x</div><div class=\"line\">mount  -t  文件系统  设备描述文件   挂载点（已经存在的空目录）</div><div class=\"line\">mount  -t iso9660  /dev/cdrom  /mnt/cdrom(-t iso9660也可省略)</div><div class=\"line\">mount  /dev/cdrom  /mnt/cdrom</div><div class=\"line\"></div><div class=\"line\">fdisk  -l\t\t列出指定的外围设备的分区表状况</div><div class=\"line\">mount  -t  vfat  /dev/sdb1  /mnt/usb</div></pre></td></tr></table></figure>\n</li>\n<li><p>卸载</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">umount</div><div class=\"line\">umount    /dev/cdrom  </div><div class=\"line\">umount   /mnt/cdrom</div><div class=\"line\">强调：退出挂载目录，才能卸载</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"网络命令\"><a href=\"#网络命令\" class=\"headerlink\" title=\"网络命令\"></a>网络命令</h2><p>ping测试网络连通性<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ping   -c  次数  ip \t（测试网络的通畅）</div></pre></td></tr></table></figure></p>\n<p>ifconfig        查询本机网络信息</p>\n<blockquote>\n<p>   -a    列出所有的网卡信息（包括没启动的）</p>\n</blockquote>\n<h2 id=\"输出重定向和多命令顺序执行\"><a href=\"#输出重定向和多命令顺序执行\" class=\"headerlink\" title=\"输出重定向和多命令顺序执行\"></a>输出重定向和多命令顺序执行</h2><p>输出重定向 把应该输出到屏幕的输出，重定向到文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&gt;\t覆盖</div><div class=\"line\">&gt;&gt;\t追加</div><div class=\"line\">ls  &gt;  aa\t\t覆盖到aa</div><div class=\"line\">ls  &gt;&gt;  aa\t\t追加到aa</div><div class=\"line\">ls  gdlslga  2&gt;&gt;aa\t\t错误信息输出到aa\t\t</div><div class=\"line\">强调：错误输出，不能有空格</div></pre></td></tr></table></figure></p>\n<p>错误信息重定向<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">ls  &gt;&gt;  aa  2&gt;&amp;1\t\t错误和正确都输入到aa，可以追加</div><div class=\"line\">\t\t2&gt;&amp;1\t\t把标准错误重定向到标准正确输出</div><div class=\"line\"></div><div class=\"line\">ls  &gt;&gt;  aa  2&gt;&gt;/tmp/bb\t\t正确信息输入aa，错误信息输入bb</div></pre></td></tr></table></figure></p>\n<h2 id=\"补充命令\"><a href=\"#补充命令\" class=\"headerlink\" title=\"补充命令\"></a>补充命令</h2><p>date  查看系统时间<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">date \t\t</div><div class=\"line\">date\t-s   20140701\t\t设定日期</div><div class=\"line\">date\t-s\t09:30:00\t\t设定时间</div></pre></td></tr></table></figure></p>\n<p>du统计目录大小<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">-sh\t目录名\t\t统计目录大小</div><div class=\"line\">-s\t\t和</div><div class=\"line\">-h\t\t习惯单位</div></pre></td></tr></table></figure></p>\n<p>netstat<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">netstat  \t\t查看网络状态的命令</div><div class=\"line\">\t-t\t查看TCP端口</div><div class=\"line\">\t-u\t查看UDP端口</div><div class=\"line\">\t-l\t监听</div><div class=\"line\">\t-n\t以IP地址和端口号显示，不用域名和服务名显示</div><div class=\"line\">\t-a\t查询所有连接</div><div class=\"line\">例</div><div class=\"line\">netstat  -tlun</div></pre></td></tr></table></figure></p>"},{"title":"Linux常见的配置文件","date":"2016-10-06T12:00:00.000Z","_content":"\n在Linux中我们经常需要修改各种配置文件，例如，启动引导程序配置文件、系统启动文件核脚本、网络配置文件、文件系统配置文件、文件服务程序配置文件等等。\n\n<!-- more -->\n\n## /etc/passwd\t用户信息配置文件\n\n- 文件作用：保存Linux用户信息\n- 文件内容：\n```\nroot:x:0:0:root:/root:/bin/bash\n```\n\n说明：\n- 第一位：用户名\n- 第二位：密码位（只是一个密码标志，真实密码并不是存在这）\n- 第三位：UID\t用户ID\n>\t0\t超级管理员\n>\t1-499\t系统用户（伪用户）\n>\t\\>500\t普通用户\n\n- 第四位：GID\t初始组ID\n- 第五位：用户说明\n- 第六位：家目录\n- 第七位：用户登录之后的权限\n> 常见的两种权限：\n>\n>\t/bin/bash\n>\n>\t/sbin/nologin伪用户，不能进行登陆\n\n## /etc/shadow\t影子文件\n- 文件作用：保存用户密码，及密码的有效期\n- 文件内容：\n```\nroot:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::\n```\n\n说明：\n- 第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的\n\n- 第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的\n\n- 第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化\n\n- 第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义\n\n- 第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义\n\n- 第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义\n\n- 第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用\n\n- 第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），如果这个字段的值为空，帐号永久可用\n\n- 第九字段：保留字段，目前为空，以备将来Linux发展之用\n\n## /etc/group\t用户组配置文件\n- 文件作用：用户组配置\n- 文件内容：\n```\nroot:x:0:\nbin:x:1:bin,daemon\n```\n说明：\n- 组名：组密码位：组ID：组中的附加用户\n\n- 初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组\n\n- 附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组\n\n## /etc/sysconfig/network-scripts/ifcfg-eth0\t网卡信息文件\n- 文件作用：保存网卡配置\n- 文件内容：\n```\nDEVICE=eth0\t\t\t\t\t网卡设备名\nBOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP\nBROADCAST=192.168.140.255\t\t\t广播地址\nHWADDR=00:0c:29:21:80:48\t\t\tmac地址\nIPADDR=192.168.140.253\t\t\tIP地址\nIPV6INIT=yes\t\t\t\t\tIPv6开启\nIPV6_AUTOCONF=yes\t\t\t\tIPv6获取\nNETMASK=255.255.255.0\t\t\t\t掩码\nNETWORK=192.168.140.0\t\t\t\t网段\nONBOOT=yes\t\t\t\t\t网卡开机启动\nTYPE=Ethernet\t\t\t\t\t以太网\nGATEWAY=192.168.140.1\t\t\t\t网关\n```\n\n说明：\n- 如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。\n\n- 修改配置文件后，需要重启服务（如service  network  restart）。\n\n## /etc/udev/rules.d/70-persistent-net.rules\t网卡和MAC地址绑定文件\n- 文件作用：绑定网卡和MAC地址\n- 文件内容：\n```\nSUBSYSTEM==\"net\", ACTION==\"add\", DRIVERS==\"?*\", ATTR{address}==\"00:0c:29:41:c7:1f\", ATTR{type}==\"1\", KERNEL==\"eth*\", NAME=\"eth0\"\n```\n\n说明：\n- 当虚拟机网卡不通是，有时需要删除`/etc/sysconfig/network-scripts/ifcfg-eth0` 中的MAC地址行，并且要删掉此文件。\n\n## /etc/inittab\t系统默认运行级别配置文件\n- 文件作用：设置默认系统运行级别。\n- 文件内容：\n```\nid:3:initdefault:\n```\n\n说明：\n```\n运行级别可分为：\n# Default runlevel. The runlevels used are:\n#   0 - halt (Do NOT set initdefault to this)\n#   1 - Single user mode\n#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)\n#   3 - Full multiuser mode\t命令行\n#   4 - unused\n#   5 - X11\t\t\t图形界面\n#   6 - reboot (Do NOT set initdefault to this)\n```\n\n## /etc/rc.local---->/etc/rc.d/rc.local\t自启动程序配置文件\n- 文件作用：设置自启动程序，系统启动时会一次执行该文件中的命令\n- 文件内容\n```\n# This script will be executed *after* all the other init scripts.\n# You can put your own initialization stuff in here if you don't\n# want to do the full Sys V style init stuff.\ntouch /var/lock/subsys/local\nulimit -SHn 65535\n```\n\n## /etc/services\t所有系统常见端口\n- 文件作用：显示系统常见的端口及绑定的协议\n\n\n## /etc/sysconfig/network\t\t主机名配置文件\n- 文件作用：配置主机名，永久保存\n- 文件内容：\n```\nNETWORKING=yes\nHOSTNAME=localhost.localdomain\n```\n\n说明：\n- 建议不要更改。\n\n## /etc/resolv.conf\t\tDNS配置文件\n- 文件作用：设置ＤＮＳ服务器\n- 文件内容：\n```\nnameserver  202.106.0.20\n```\n\n说明：\n- 如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”\n\n## /etc/vimrc vim配置文件\n别名配置文件\n```\n~.bashrc\n```\n\n## /etc/selinux/config seLinux的配置文件\n- 文件内容\n```\n# This file controls the state of SELinux on the system.\n# SELINUX= can take one of these three values:\n#     enforcing - SELinux security policy is enforced.\n#     permissive - SELinux prints warnings instead of enforcing.\n#     disabled - No SELinux policy is loaded.\nSELINUX=disabled\n# SELINUXTYPE= can take one of these two values:\n#     targeted - Targeted processes are protected,\n#     mls - Multi Level Security protection.\nSELINUXTYPE=targeted\n```\n\n关闭seLinux\n- 将配置文件中seLinux项改为SELINUX=disabled，然后重启Linux。\n","source":"_posts/Linux常见的配置文件.md","raw":"---\ntitle: Linux常见的配置文件\ndate: 2016-10-06 20:00:00\ntags:\ncategories:\n- Linux\n---\n\n在Linux中我们经常需要修改各种配置文件，例如，启动引导程序配置文件、系统启动文件核脚本、网络配置文件、文件系统配置文件、文件服务程序配置文件等等。\n\n<!-- more -->\n\n## /etc/passwd\t用户信息配置文件\n\n- 文件作用：保存Linux用户信息\n- 文件内容：\n```\nroot:x:0:0:root:/root:/bin/bash\n```\n\n说明：\n- 第一位：用户名\n- 第二位：密码位（只是一个密码标志，真实密码并不是存在这）\n- 第三位：UID\t用户ID\n>\t0\t超级管理员\n>\t1-499\t系统用户（伪用户）\n>\t\\>500\t普通用户\n\n- 第四位：GID\t初始组ID\n- 第五位：用户说明\n- 第六位：家目录\n- 第七位：用户登录之后的权限\n> 常见的两种权限：\n>\n>\t/bin/bash\n>\n>\t/sbin/nologin伪用户，不能进行登陆\n\n## /etc/shadow\t影子文件\n- 文件作用：保存用户密码，及密码的有效期\n- 文件内容：\n```\nroot:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::\n```\n\n说明：\n- 第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的\n\n- 第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的\n\n- 第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化\n\n- 第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义\n\n- 第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义\n\n- 第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义\n\n- 第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用\n\n- 第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），如果这个字段的值为空，帐号永久可用\n\n- 第九字段：保留字段，目前为空，以备将来Linux发展之用\n\n## /etc/group\t用户组配置文件\n- 文件作用：用户组配置\n- 文件内容：\n```\nroot:x:0:\nbin:x:1:bin,daemon\n```\n说明：\n- 组名：组密码位：组ID：组中的附加用户\n\n- 初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组\n\n- 附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组\n\n## /etc/sysconfig/network-scripts/ifcfg-eth0\t网卡信息文件\n- 文件作用：保存网卡配置\n- 文件内容：\n```\nDEVICE=eth0\t\t\t\t\t网卡设备名\nBOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP\nBROADCAST=192.168.140.255\t\t\t广播地址\nHWADDR=00:0c:29:21:80:48\t\t\tmac地址\nIPADDR=192.168.140.253\t\t\tIP地址\nIPV6INIT=yes\t\t\t\t\tIPv6开启\nIPV6_AUTOCONF=yes\t\t\t\tIPv6获取\nNETMASK=255.255.255.0\t\t\t\t掩码\nNETWORK=192.168.140.0\t\t\t\t网段\nONBOOT=yes\t\t\t\t\t网卡开机启动\nTYPE=Ethernet\t\t\t\t\t以太网\nGATEWAY=192.168.140.1\t\t\t\t网关\n```\n\n说明：\n- 如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。\n\n- 修改配置文件后，需要重启服务（如service  network  restart）。\n\n## /etc/udev/rules.d/70-persistent-net.rules\t网卡和MAC地址绑定文件\n- 文件作用：绑定网卡和MAC地址\n- 文件内容：\n```\nSUBSYSTEM==\"net\", ACTION==\"add\", DRIVERS==\"?*\", ATTR{address}==\"00:0c:29:41:c7:1f\", ATTR{type}==\"1\", KERNEL==\"eth*\", NAME=\"eth0\"\n```\n\n说明：\n- 当虚拟机网卡不通是，有时需要删除`/etc/sysconfig/network-scripts/ifcfg-eth0` 中的MAC地址行，并且要删掉此文件。\n\n## /etc/inittab\t系统默认运行级别配置文件\n- 文件作用：设置默认系统运行级别。\n- 文件内容：\n```\nid:3:initdefault:\n```\n\n说明：\n```\n运行级别可分为：\n# Default runlevel. The runlevels used are:\n#   0 - halt (Do NOT set initdefault to this)\n#   1 - Single user mode\n#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)\n#   3 - Full multiuser mode\t命令行\n#   4 - unused\n#   5 - X11\t\t\t图形界面\n#   6 - reboot (Do NOT set initdefault to this)\n```\n\n## /etc/rc.local---->/etc/rc.d/rc.local\t自启动程序配置文件\n- 文件作用：设置自启动程序，系统启动时会一次执行该文件中的命令\n- 文件内容\n```\n# This script will be executed *after* all the other init scripts.\n# You can put your own initialization stuff in here if you don't\n# want to do the full Sys V style init stuff.\ntouch /var/lock/subsys/local\nulimit -SHn 65535\n```\n\n## /etc/services\t所有系统常见端口\n- 文件作用：显示系统常见的端口及绑定的协议\n\n\n## /etc/sysconfig/network\t\t主机名配置文件\n- 文件作用：配置主机名，永久保存\n- 文件内容：\n```\nNETWORKING=yes\nHOSTNAME=localhost.localdomain\n```\n\n说明：\n- 建议不要更改。\n\n## /etc/resolv.conf\t\tDNS配置文件\n- 文件作用：设置ＤＮＳ服务器\n- 文件内容：\n```\nnameserver  202.106.0.20\n```\n\n说明：\n- 如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”\n\n## /etc/vimrc vim配置文件\n别名配置文件\n```\n~.bashrc\n```\n\n## /etc/selinux/config seLinux的配置文件\n- 文件内容\n```\n# This file controls the state of SELinux on the system.\n# SELINUX= can take one of these three values:\n#     enforcing - SELinux security policy is enforced.\n#     permissive - SELinux prints warnings instead of enforcing.\n#     disabled - No SELinux policy is loaded.\nSELINUX=disabled\n# SELINUXTYPE= can take one of these two values:\n#     targeted - Targeted processes are protected,\n#     mls - Multi Level Security protection.\nSELINUXTYPE=targeted\n```\n\n关闭seLinux\n- 将配置文件中seLinux项改为SELINUX=disabled，然后重启Linux。\n","slug":"Linux常见的配置文件","published":1,"updated":"2016-10-07T14:43:46.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwv7000t699fkpy9e8pu","content":"<p>在Linux中我们经常需要修改各种配置文件，例如，启动引导程序配置文件、系统启动文件核脚本、网络配置文件、文件系统配置文件、文件服务程序配置文件等等。</p>\n<a id=\"more\"></a>\n<h2 id=\"etc-passwd-用户信息配置文件\"><a href=\"#etc-passwd-用户信息配置文件\" class=\"headerlink\" title=\"/etc/passwd    用户信息配置文件\"></a>/etc/passwd    用户信息配置文件</h2><ul>\n<li>文件作用：保存Linux用户信息</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:x:0:0:root:/root:/bin/bash</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>第一位：用户名</li>\n<li>第二位：密码位（只是一个密码标志，真实密码并不是存在这）</li>\n<li><p>第三位：UID    用户ID</p>\n<blockquote>\n<p>   0    超级管理员<br>   1-499    系统用户（伪用户）<br>   >500    普通用户</p>\n</blockquote>\n</li>\n<li><p>第四位：GID    初始组ID</p>\n</li>\n<li>第五位：用户说明</li>\n<li>第六位：家目录</li>\n<li>第七位：用户登录之后的权限<blockquote>\n<p>常见的两种权限：</p>\n<p>   /bin/bash</p>\n<p>   /sbin/nologin伪用户，不能进行登陆</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"etc-shadow-影子文件\"><a href=\"#etc-shadow-影子文件\" class=\"headerlink\" title=\"/etc/shadow    影子文件\"></a>/etc/shadow    影子文件</h2><ul>\n<li>文件作用：保存用户密码，及密码的有效期</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li><p>第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的</p>\n</li>\n<li><p>第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的</p>\n</li>\n<li><p>第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化</p>\n</li>\n<li><p>第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义</p>\n</li>\n<li><p>第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义</p>\n</li>\n<li><p>第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义</p>\n</li>\n<li><p>第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用</p>\n</li>\n<li><p>第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），如果这个字段的值为空，帐号永久可用</p>\n</li>\n<li><p>第九字段：保留字段，目前为空，以备将来Linux发展之用</p>\n</li>\n</ul>\n<h2 id=\"etc-group-用户组配置文件\"><a href=\"#etc-group-用户组配置文件\" class=\"headerlink\" title=\"/etc/group    用户组配置文件\"></a>/etc/group    用户组配置文件</h2><ul>\n<li>文件作用：用户组配置</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:x:0:</div><div class=\"line\">bin:x:1:bin,daemon</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li><p>组名：组密码位：组ID：组中的附加用户</p>\n</li>\n<li><p>初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组</p>\n</li>\n<li><p>附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组</p>\n</li>\n</ul>\n<h2 id=\"etc-sysconfig-network-scripts-ifcfg-eth0-网卡信息文件\"><a href=\"#etc-sysconfig-network-scripts-ifcfg-eth0-网卡信息文件\" class=\"headerlink\" title=\"/etc/sysconfig/network-scripts/ifcfg-eth0    网卡信息文件\"></a>/etc/sysconfig/network-scripts/ifcfg-eth0    网卡信息文件</h2><ul>\n<li>文件作用：保存网卡配置</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">DEVICE=eth0\t\t\t\t\t网卡设备名</div><div class=\"line\">BOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP</div><div class=\"line\">BROADCAST=192.168.140.255\t\t\t广播地址</div><div class=\"line\">HWADDR=00:0c:29:21:80:48\t\t\tmac地址</div><div class=\"line\">IPADDR=192.168.140.253\t\t\tIP地址</div><div class=\"line\">IPV6INIT=yes\t\t\t\t\tIPv6开启</div><div class=\"line\">IPV6_AUTOCONF=yes\t\t\t\tIPv6获取</div><div class=\"line\">NETMASK=255.255.255.0\t\t\t\t掩码</div><div class=\"line\">NETWORK=192.168.140.0\t\t\t\t网段</div><div class=\"line\">ONBOOT=yes\t\t\t\t\t网卡开机启动</div><div class=\"line\">TYPE=Ethernet\t\t\t\t\t以太网</div><div class=\"line\">GATEWAY=192.168.140.1\t\t\t\t网关</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li><p>如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。</p>\n</li>\n<li><p>修改配置文件后，需要重启服务（如service  network  restart）。</p>\n</li>\n</ul>\n<h2 id=\"etc-udev-rules-d-70-persistent-net-rules-网卡和MAC地址绑定文件\"><a href=\"#etc-udev-rules-d-70-persistent-net-rules-网卡和MAC地址绑定文件\" class=\"headerlink\" title=\"/etc/udev/rules.d/70-persistent-net.rules    网卡和MAC地址绑定文件\"></a>/etc/udev/rules.d/70-persistent-net.rules    网卡和MAC地址绑定文件</h2><ul>\n<li>文件作用：绑定网卡和MAC地址</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;address&#125;==&quot;00:0c:29:41:c7:1f&quot;, ATTR&#123;type&#125;==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>当虚拟机网卡不通是，有时需要删除<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> 中的MAC地址行，并且要删掉此文件。</li>\n</ul>\n<h2 id=\"etc-inittab-系统默认运行级别配置文件\"><a href=\"#etc-inittab-系统默认运行级别配置文件\" class=\"headerlink\" title=\"/etc/inittab    系统默认运行级别配置文件\"></a>/etc/inittab    系统默认运行级别配置文件</h2><ul>\n<li>文件作用：设置默认系统运行级别。</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">id:3:initdefault:</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">运行级别可分为：</div><div class=\"line\"># Default runlevel. The runlevels used are:</div><div class=\"line\">#   0 - halt (Do NOT set initdefault to this)</div><div class=\"line\">#   1 - Single user mode</div><div class=\"line\">#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)</div><div class=\"line\">#   3 - Full multiuser mode\t命令行</div><div class=\"line\">#   4 - unused</div><div class=\"line\">#   5 - X11\t\t\t图形界面</div><div class=\"line\">#   6 - reboot (Do NOT set initdefault to this)</div></pre></td></tr></table></figure></p>\n<h2 id=\"etc-rc-local—-gt-etc-rc-d-rc-local-自启动程序配置文件\"><a href=\"#etc-rc-local—-gt-etc-rc-d-rc-local-自启动程序配置文件\" class=\"headerlink\" title=\"/etc/rc.local—-&gt;/etc/rc.d/rc.local    自启动程序配置文件\"></a>/etc/rc.local—-&gt;/etc/rc.d/rc.local    自启动程序配置文件</h2><ul>\n<li>文件作用：设置自启动程序，系统启动时会一次执行该文件中的命令</li>\n<li>文件内容<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"># This script will be executed *after* all the other init scripts.</div><div class=\"line\"># You can put your own initialization stuff in here if you don&apos;t</div><div class=\"line\"># want to do the full Sys V style init stuff.</div><div class=\"line\">touch /var/lock/subsys/local</div><div class=\"line\">ulimit -SHn 65535</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"etc-services-所有系统常见端口\"><a href=\"#etc-services-所有系统常见端口\" class=\"headerlink\" title=\"/etc/services    所有系统常见端口\"></a>/etc/services    所有系统常见端口</h2><ul>\n<li>文件作用：显示系统常见的端口及绑定的协议</li>\n</ul>\n<h2 id=\"etc-sysconfig-network-主机名配置文件\"><a href=\"#etc-sysconfig-network-主机名配置文件\" class=\"headerlink\" title=\"/etc/sysconfig/network        主机名配置文件\"></a>/etc/sysconfig/network        主机名配置文件</h2><ul>\n<li>文件作用：配置主机名，永久保存</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">NETWORKING=yes</div><div class=\"line\">HOSTNAME=localhost.localdomain</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>建议不要更改。</li>\n</ul>\n<h2 id=\"etc-resolv-conf-DNS配置文件\"><a href=\"#etc-resolv-conf-DNS配置文件\" class=\"headerlink\" title=\"/etc/resolv.conf        DNS配置文件\"></a>/etc/resolv.conf        DNS配置文件</h2><ul>\n<li>文件作用：设置ＤＮＳ服务器</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">nameserver  202.106.0.20</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”</li>\n</ul>\n<h2 id=\"etc-vimrc-vim配置文件\"><a href=\"#etc-vimrc-vim配置文件\" class=\"headerlink\" title=\"/etc/vimrc vim配置文件\"></a>/etc/vimrc vim配置文件</h2><p>别名配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">~.bashrc</div></pre></td></tr></table></figure></p>\n<h2 id=\"etc-selinux-config-seLinux的配置文件\"><a href=\"#etc-selinux-config-seLinux的配置文件\" class=\"headerlink\" title=\"/etc/selinux/config seLinux的配置文件\"></a>/etc/selinux/config seLinux的配置文件</h2><ul>\n<li>文件内容<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"># This file controls the state of SELinux on the system.</div><div class=\"line\"># SELINUX= can take one of these three values:</div><div class=\"line\">#     enforcing - SELinux security policy is enforced.</div><div class=\"line\">#     permissive - SELinux prints warnings instead of enforcing.</div><div class=\"line\">#     disabled - No SELinux policy is loaded.</div><div class=\"line\">SELINUX=disabled</div><div class=\"line\"># SELINUXTYPE= can take one of these two values:</div><div class=\"line\">#     targeted - Targeted processes are protected,</div><div class=\"line\">#     mls - Multi Level Security protection.</div><div class=\"line\">SELINUXTYPE=targeted</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>关闭seLinux</p>\n<ul>\n<li>将配置文件中seLinux项改为SELINUX=disabled，然后重启Linux。</li>\n</ul>\n","excerpt":"<p>在Linux中我们经常需要修改各种配置文件，例如，启动引导程序配置文件、系统启动文件核脚本、网络配置文件、文件系统配置文件、文件服务程序配置文件等等。</p>","more":"<h2 id=\"etc-passwd-用户信息配置文件\"><a href=\"#etc-passwd-用户信息配置文件\" class=\"headerlink\" title=\"/etc/passwd    用户信息配置文件\"></a>/etc/passwd    用户信息配置文件</h2><ul>\n<li>文件作用：保存Linux用户信息</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:x:0:0:root:/root:/bin/bash</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>第一位：用户名</li>\n<li>第二位：密码位（只是一个密码标志，真实密码并不是存在这）</li>\n<li><p>第三位：UID    用户ID</p>\n<blockquote>\n<p>   0    超级管理员<br>   1-499    系统用户（伪用户）<br>   >500    普通用户</p>\n</blockquote>\n</li>\n<li><p>第四位：GID    初始组ID</p>\n</li>\n<li>第五位：用户说明</li>\n<li>第六位：家目录</li>\n<li>第七位：用户登录之后的权限<blockquote>\n<p>常见的两种权限：</p>\n<p>   /bin/bash</p>\n<p>   /sbin/nologin伪用户，不能进行登陆</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"etc-shadow-影子文件\"><a href=\"#etc-shadow-影子文件\" class=\"headerlink\" title=\"/etc/shadow    影子文件\"></a>/etc/shadow    影子文件</h2><ul>\n<li>文件作用：保存用户密码，及密码的有效期</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:$6$w5RBeFe7Y1bixrQR$tp0zHL1bMmAVv0SAS56LsCOyZ4KUj3V0GI0dRZ4KSlf.ggisV7dwiQ8s5xebcZghVDxwlYTjN6qKGU9zRc.En1:16247:0:99999:7:::</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li><p>第一字段：用户名（也被称为登录名），在/etc/shadow中，用户名和/etc/passwd 是相同的，这样就把passwd 和shadow中用的用户记录联系在一起；这个字段是非空的</p>\n</li>\n<li><p>第二字段：密码（已被加密），如果是有些用户在这段是x，表示这个用户不能登录到系统；这个字段是非空的</p>\n</li>\n<li><p>第三字段：上次修改口令的时间；这个时间是从1970年01月01日算起到最近一次修改口令的时间间隔（天数），您可以通过passwd 来修改用户的密码，然后查看/etc/shadow中此字段的变化</p>\n</li>\n<li><p>第四字段：两次修改口令间隔最少的天数；如果设置为0,则禁用此功能；也就是说用户必须经过多少天才能修改其口令；此项功能用处不是太大；默认值是通过/etc/login.defs文件定义中获取，PASS_MIN_DAYS 中有定义</p>\n</li>\n<li><p>第五字段：两次修改口令间隔最多的天数；这个能增强管理员管理用户口令的时效性，应该说在增强了系统的安全性；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_MAX_DAYS 中定义</p>\n</li>\n<li><p>第六字段：提前多少天警告用户口令将过期；当用户登录系统后，系统登录程序提醒用户口令将要作废；如果是系统默认值，是在添加用户时由/etc/login.defs文件定义中获取，在PASS_WARN_AGE 中定义</p>\n</li>\n<li><p>第七字段：在口令过期之后多少天禁用此用户；此字段表示用户口令作废多少天后，系统会禁用此用户，也就是说系统会不能再让此用户登录，也不会提示用户过期，是完全禁用</p>\n</li>\n<li><p>第八字段：用户过期日期；此字段指定了用户作废的天数（从1970年的1月1日开始的天数），如果这个字段的值为空，帐号永久可用</p>\n</li>\n<li><p>第九字段：保留字段，目前为空，以备将来Linux发展之用</p>\n</li>\n</ul>\n<h2 id=\"etc-group-用户组配置文件\"><a href=\"#etc-group-用户组配置文件\" class=\"headerlink\" title=\"/etc/group    用户组配置文件\"></a>/etc/group    用户组配置文件</h2><ul>\n<li>文件作用：用户组配置</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">root:x:0:</div><div class=\"line\">bin:x:1:bin,daemon</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li><p>组名：组密码位：组ID：组中的附加用户</p>\n</li>\n<li><p>初始组：每个用户初始组只能有一个，初始组只能有一个，一般都是和用户名相同的组作为初始组</p>\n</li>\n<li><p>附加组：每个用户可以属于多个附加组。要把用户加入组，都是加入附加组</p>\n</li>\n</ul>\n<h2 id=\"etc-sysconfig-network-scripts-ifcfg-eth0-网卡信息文件\"><a href=\"#etc-sysconfig-network-scripts-ifcfg-eth0-网卡信息文件\" class=\"headerlink\" title=\"/etc/sysconfig/network-scripts/ifcfg-eth0    网卡信息文件\"></a>/etc/sysconfig/network-scripts/ifcfg-eth0    网卡信息文件</h2><ul>\n<li>文件作用：保存网卡配置</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">DEVICE=eth0\t\t\t\t\t网卡设备名</div><div class=\"line\">BOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP</div><div class=\"line\">BROADCAST=192.168.140.255\t\t\t广播地址</div><div class=\"line\">HWADDR=00:0c:29:21:80:48\t\t\tmac地址</div><div class=\"line\">IPADDR=192.168.140.253\t\t\tIP地址</div><div class=\"line\">IPV6INIT=yes\t\t\t\t\tIPv6开启</div><div class=\"line\">IPV6_AUTOCONF=yes\t\t\t\tIPv6获取</div><div class=\"line\">NETMASK=255.255.255.0\t\t\t\t掩码</div><div class=\"line\">NETWORK=192.168.140.0\t\t\t\t网段</div><div class=\"line\">ONBOOT=yes\t\t\t\t\t网卡开机启动</div><div class=\"line\">TYPE=Ethernet\t\t\t\t\t以太网</div><div class=\"line\">GATEWAY=192.168.140.1\t\t\t\t网关</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li><p>如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。</p>\n</li>\n<li><p>修改配置文件后，需要重启服务（如service  network  restart）。</p>\n</li>\n</ul>\n<h2 id=\"etc-udev-rules-d-70-persistent-net-rules-网卡和MAC地址绑定文件\"><a href=\"#etc-udev-rules-d-70-persistent-net-rules-网卡和MAC地址绑定文件\" class=\"headerlink\" title=\"/etc/udev/rules.d/70-persistent-net.rules    网卡和MAC地址绑定文件\"></a>/etc/udev/rules.d/70-persistent-net.rules    网卡和MAC地址绑定文件</h2><ul>\n<li>文件作用：绑定网卡和MAC地址</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">SUBSYSTEM==&quot;net&quot;, ACTION==&quot;add&quot;, DRIVERS==&quot;?*&quot;, ATTR&#123;address&#125;==&quot;00:0c:29:41:c7:1f&quot;, ATTR&#123;type&#125;==&quot;1&quot;, KERNEL==&quot;eth*&quot;, NAME=&quot;eth0&quot;</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>当虚拟机网卡不通是，有时需要删除<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> 中的MAC地址行，并且要删掉此文件。</li>\n</ul>\n<h2 id=\"etc-inittab-系统默认运行级别配置文件\"><a href=\"#etc-inittab-系统默认运行级别配置文件\" class=\"headerlink\" title=\"/etc/inittab    系统默认运行级别配置文件\"></a>/etc/inittab    系统默认运行级别配置文件</h2><ul>\n<li>文件作用：设置默认系统运行级别。</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">id:3:initdefault:</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">运行级别可分为：</div><div class=\"line\"># Default runlevel. The runlevels used are:</div><div class=\"line\">#   0 - halt (Do NOT set initdefault to this)</div><div class=\"line\">#   1 - Single user mode</div><div class=\"line\">#   2 - Multiuser, without NFS (The same as 3, if you do not have networking)</div><div class=\"line\">#   3 - Full multiuser mode\t命令行</div><div class=\"line\">#   4 - unused</div><div class=\"line\">#   5 - X11\t\t\t图形界面</div><div class=\"line\">#   6 - reboot (Do NOT set initdefault to this)</div></pre></td></tr></table></figure></p>\n<h2 id=\"etc-rc-local—-gt-etc-rc-d-rc-local-自启动程序配置文件\"><a href=\"#etc-rc-local—-gt-etc-rc-d-rc-local-自启动程序配置文件\" class=\"headerlink\" title=\"/etc/rc.local—-&gt;/etc/rc.d/rc.local    自启动程序配置文件\"></a>/etc/rc.local—-&gt;/etc/rc.d/rc.local    自启动程序配置文件</h2><ul>\n<li>文件作用：设置自启动程序，系统启动时会一次执行该文件中的命令</li>\n<li>文件内容<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"># This script will be executed *after* all the other init scripts.</div><div class=\"line\"># You can put your own initialization stuff in here if you don&apos;t</div><div class=\"line\"># want to do the full Sys V style init stuff.</div><div class=\"line\">touch /var/lock/subsys/local</div><div class=\"line\">ulimit -SHn 65535</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"etc-services-所有系统常见端口\"><a href=\"#etc-services-所有系统常见端口\" class=\"headerlink\" title=\"/etc/services    所有系统常见端口\"></a>/etc/services    所有系统常见端口</h2><ul>\n<li>文件作用：显示系统常见的端口及绑定的协议</li>\n</ul>\n<h2 id=\"etc-sysconfig-network-主机名配置文件\"><a href=\"#etc-sysconfig-network-主机名配置文件\" class=\"headerlink\" title=\"/etc/sysconfig/network        主机名配置文件\"></a>/etc/sysconfig/network        主机名配置文件</h2><ul>\n<li>文件作用：配置主机名，永久保存</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">NETWORKING=yes</div><div class=\"line\">HOSTNAME=localhost.localdomain</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>建议不要更改。</li>\n</ul>\n<h2 id=\"etc-resolv-conf-DNS配置文件\"><a href=\"#etc-resolv-conf-DNS配置文件\" class=\"headerlink\" title=\"/etc/resolv.conf        DNS配置文件\"></a>/etc/resolv.conf        DNS配置文件</h2><ul>\n<li>文件作用：设置ＤＮＳ服务器</li>\n<li>文件内容：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">nameserver  202.106.0.20</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>说明：</p>\n<ul>\n<li>如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”</li>\n</ul>\n<h2 id=\"etc-vimrc-vim配置文件\"><a href=\"#etc-vimrc-vim配置文件\" class=\"headerlink\" title=\"/etc/vimrc vim配置文件\"></a>/etc/vimrc vim配置文件</h2><p>别名配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">~.bashrc</div></pre></td></tr></table></figure></p>\n<h2 id=\"etc-selinux-config-seLinux的配置文件\"><a href=\"#etc-selinux-config-seLinux的配置文件\" class=\"headerlink\" title=\"/etc/selinux/config seLinux的配置文件\"></a>/etc/selinux/config seLinux的配置文件</h2><ul>\n<li>文件内容<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"># This file controls the state of SELinux on the system.</div><div class=\"line\"># SELINUX= can take one of these three values:</div><div class=\"line\">#     enforcing - SELinux security policy is enforced.</div><div class=\"line\">#     permissive - SELinux prints warnings instead of enforcing.</div><div class=\"line\">#     disabled - No SELinux policy is loaded.</div><div class=\"line\">SELINUX=disabled</div><div class=\"line\"># SELINUXTYPE= can take one of these two values:</div><div class=\"line\">#     targeted - Targeted processes are protected,</div><div class=\"line\">#     mls - Multi Level Security protection.</div><div class=\"line\">SELINUXTYPE=targeted</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>关闭seLinux</p>\n<ul>\n<li>将配置文件中seLinux项改为SELINUX=disabled，然后重启Linux。</li>\n</ul>"},{"title":"Linux常用工具命令之rsync","date":"2016-10-08T14:30:00.000Z","_content":"\n\nrsync命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。\nrsync使用所谓的“rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。\nrsync是一个功能非常强大的工具，其命令也有很多功能特色选项，我们下面就对它的选项一一进行分析说明。\n\n<!-- more -->\n\n## 语法\n```\nrsync [OPTION]... SRC DEST\nrsync [OPTION]... SRC [USER@]host:DEST\nrsync [OPTION]... [USER@]HOST:SRC DEST\nrsync [OPTION]... [USER@]HOST::SRC DEST\nrsync [OPTION]... SRC [USER@]HOST::DEST\nrsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]\n```\n对应于以上六种命令格式,rsync有六种不同的工作模式:\n1. 拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号\":\"分隔符时就启动这种工作模式。如: `rsync­ -a /data /backup`\n\n2. 使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒 号\":\"分隔符时启动该模式。如: `rsync­ -avz *.c foo:src`\n\n3. 使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒 号\":\"分隔符时启动该模式。如: `rsync -­avz foo:src/bar /data`\n\n4. 从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含\"::\"分隔符时启动该模式。如: `rsync- ­av root@192.168.78.192::www /databack`\n\n5. 从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含\"::\"分隔符时启动该模式。如: `rsync­- av /databack root@192.168.78.192::www`\n\n6. 列远程机的文件列表。这类似于rsync传输,不过只要在命令中省略掉本地机信息即可。如: `rsync­ -v rsync://192.168.78.192/www`\n\n## 选项\n```\n­-v, --­­verbose 详细模式输出。\n­-q, ­­--quiet 精简输出模式。\n­-c, ­­--checksum 打开校验开关,强制对文件传输进行校验。\n­-a, ­­--archive 归档模式,表示以递归方式传输文件,并保持所有文件属性,等于­rlptgoD。 ­\n-r, ­­--recursive 对子目录以递归模式处理。\n-­R, ­­--relative 使用相对路径信息。\n­-b, ­­--backup 创建备份,也就是对于目的已经存在有同样的文件名时,将老的文件重新命名为~filename。可以使用­­ suffix选项来指定不同的备份文件前缀。\n--­­backup­-dir 将备份文件(如~filename)存放在在目录下。\n-­suffix=SUFFIX 定义备份文件前缀。\n­-u, ­­--update 仅仅进行更新,也就是跳过所有已经存在于DST,并且文件时间晚于要备份的文件,不覆盖更新的文件。 ­\n-l, ­­--links 保留软链结。\n-­L, ­­--copy-links 想对待常规文件一样处理软链结。\n­--­copy-­unsafe-­links 仅仅拷贝指向SRC路径目录树以外的链结。\n­­--safe-­links 忽略指向SRC路径目录树以外的链结。\n­-H, ­­--hard-­links 保留硬链结。\n­-p, ­­--perms 保持文件权限。\n­-o, ­­--owner 保持文件属主信息。\n­-g, ­­--group 保持文件属组信息。\n­-D, ­­--devices 保持设备文件信息。\n­-t, ­­--times 保持文件时间信息。\n­-S, ­­--sparse 对稀疏文件进行特殊处理以节省DST的空间。\n­-n, ­­--dry­-run现实哪些文件将被传输。\n­-w, ­­--whole-file 拷贝文件,不进行增量检测。\n­-x, ­­-one-file-system 不要跨越文件系统边界。\n­-B, ­­--block­-size=SIZE 检验算法使用的块尺寸,默认是700字节。\n­-e, ­­--rsh=command 指定使用rsh、ssh方式进行数据同步。\n­--­rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息。\n­-C, ­­--cvs-­exclude 使用和CVS一样的方法自动忽略文件,用来排除那些不希望传输的文件。\n­­--existing 仅仅更新那些已经存在于DST的文件,而不备份那些新创建的文件。\n­­--delete 删除那些DST中SRC没有的文件。\n­­--delete-­excluded 同样删除接收端那些被该选项指定排除的文件。\n­­--delete-after 传输结束以后再删除。\n­­--ignore-­errors 及时出现IO错误也进行删除。\n­­--max-delete=NUM 最多删除NUM个文件。\n­­--partial 保留那些因故没有完全传输的文件,以是加快随后的再次传输。\n­­--force 强制删除目录,即使不为空。\n­­--numeric-ids 不将数字的用户和组id匹配为用户名和组名。\n­­--timeout=time ip超时时间,单位为秒。\n­-I, --­­ignore-times 不跳过那些有同样的时间和长度的文件。\n­­--size-­only 当决定是否要备份文件时,仅仅察看文件大小而不考虑文件时间。\n­­--modify-­window=NUM 决定文件是否时间相同时使用的时间戳窗口,默认为0。\n­-T --­­temp-dir=DIR 在DIR中创建临时文件。\n­­--compare-­dest=DIR 同样比较DIR中的文件来决定是否需要备份。\n­-P等同于 ­--­partial。\n­­-progress 显示备份过程。\n­-z, ­--­compress 对备份的文件在传输时进行压缩处理。\n­­--exclude=PATTERN 指定排除不需要传输的文件模式。\n­­--include=PATTERN 指定不排除而需要传输的文件模式。\n­­--exclude-­from=FILE 排除FILE中指定模式的文件。\n­­--include-­from=FILE 不排除FILE指定模式匹配的文件。\n­­--version 打印版本信息。\n­­--address 绑定到特定的地址。\n­­--config=FILE 指定其他的配置文件,不使用默认的rsyncd.conf文件。\n­­--port=PORT 指定其他的rsync服务端口。\n­­--blocking-io 对远程shell使用阻塞IO。\n­--stats 给出某些文件的传输状态。\n\n­­--progress 在传输时现实传输过程。\n­­--log-­format=formAT 指定日志文件格式。\n­­--password­-file=FILE 从FILE中得到密码。\n­­--bwlimit=KBPS 限制I/O带宽,KBytes per second。\n-­h, --­­help 显示帮助信息。\n```\n\n## 实例\n\n### SSH方式\n首先在服务端启动ssh服务:\n```\nservice sshd start\n启动 sshd: [确定]\n```\n### 使用rsync进行同步\n接下来就可以在客户端使用rsync命令来备份服务端上的数据了,SSH方式是通过系统用户来进行备份的,如下:\n```\nrsync ­vzrtopg ­­progress ­e ssh ­­delete work@172.16.78.192:/www/* /databack/experiment/rsync\nwork@172.16.78.192's password:\nreceiving file list ...\n5 files to consider\ntest/\na\n0 100% 0.00kB/s 527:35:41 (1, 20.0% of 5) b\n67 100% 65.43kB/s 0:00:00 (2, 40.0% of 5) c\n0 100% 0.00kB/s 527:35:41 (3, 60.0% of 5) dd\n100663296 100% 42.22MB/s 0:00:02 (4, 80.0% of 5) sent 96 bytes received 98190 bytes 11563.06 bytes/sec total size is 100663363 speedup is 1024.19\n```\n上面的信息描述了整个的备份过程,以及总共备份数据的大小。\n\n### 后台服务方式\n启动rsync服务,编辑 /etc/xinetd.d/rsync文件,将其中的 disable=yes改为 disable=no,并重启 xinetd服务,如下:\n```\nvi /etc/xinetd.d/rsync\n#default: off\n# description: The rsync server is a good addition to an ftp server, as it \\ # allows crc checksumming etc.\nservice rsync {\ndisable = no\nsocket_type = stream\nwait = no\nuser = root\nserver = /usr/bin/rsync\nserver_args = ­­daemon\nlog_on_failure += USERID\n}\n```\n\n```\n/etc/init.d/xinetd restart\n停止 xinetd: [确定]\n启动 xinetd: [确定]\n```\n创建配置文件,默认安装好rsync程序后,并不会自动创建rsync的主配置文件,需要手工来创建,其主配置文件\n为“/etc/rsyncd.conf”,创建该文件并插入如下内容:\n```\nvi /etc/rsyncd.conf\nuid=root\ngid=root\nmax connections=4\nlog file=/var/log/rsyncd.log pid file=/var/run/rsyncd.pid lock file=/var/run/rsyncd.lock secrets file=/etc/rsyncd.passwd hosts deny=172.16.78.0/22\n[www]\ncomment= backup web path=/www\nread only = no exclude=test\nauth users=work\n```\n\n创建密码文件,采用这种方式不能使用系统用户对客户端进行认证,所以需要创建一个密码文件,其格式 为“username:password”,用户名可以和密码可以随便定义,最好不要和系统帐户一致,同时要把创建的密码文 件权限设置为600,这在前面的模块参数做了详细介绍。\n\n```\necho \"work:abc123\" > /etc/rsyncd.passwd\nchmod 600 /etc/rsyncd.passwd\n```\n备份,完成以上工作,现在就可以对数据进行备份了,如下:\n```\nrsync ­avz ­­progress ­­delete work@172.16.78.192::www /databack/experiment/rsync\nPassword:\nreceiving file list ...\n6 files to consider\n./ files...\na\n0 100% 0.00kB/s 528:20:41 (1, 50.0% of 6)\nb\n67 100% 65.43kB/s 0:00:00 (2, 66.7% of 6)\nc\n0 100% 0.00kB/s 528:20:41 (3, 83.3% of 6)\ndd\n100663296 100% 37.49MB/s 0:00:02 (4, 100.0% of 6) sent 172 bytes received 98276 bytes 17899.64 bytes/sec total size is 150995011 speedup is 1533.75\n```\n恢复,当服务器的数据出现问题时,那么这时就需要通过客户端的数据对服务端进行恢复,但前提是服务端允许客 户端有写入权限,否则也不能在客户端直接对服务端进行恢复,使用rsync对数据进行恢复的方法如下:\n```\nrsync ­avz ­­progress /databack/experiment/rsync/ work@172.16.78.192::www\nPassword:\nbuilding file list ...\n6 files to consider\n./\na\nb\n67 100% 0.00kB/s 0:00:00 (2, 66.7% of 6)\nc\nsent 258 bytes received 76 bytes 95.43 bytes/sec total size is 150995011 speedup is 452080.87\n\n```\n\n\n\n来自: http://man.linuxde.net/rsync\n","source":"_posts/Linux常用工具命令之rsync.md","raw":"---\ntitle: Linux常用工具命令之rsync\ndate: 2016-10-08 22:30:00\ntags:\n- rsync\ncategories:\n- Linux\n---\n\n\nrsync命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。\nrsync使用所谓的“rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。\nrsync是一个功能非常强大的工具，其命令也有很多功能特色选项，我们下面就对它的选项一一进行分析说明。\n\n<!-- more -->\n\n## 语法\n```\nrsync [OPTION]... SRC DEST\nrsync [OPTION]... SRC [USER@]host:DEST\nrsync [OPTION]... [USER@]HOST:SRC DEST\nrsync [OPTION]... [USER@]HOST::SRC DEST\nrsync [OPTION]... SRC [USER@]HOST::DEST\nrsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]\n```\n对应于以上六种命令格式,rsync有六种不同的工作模式:\n1. 拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号\":\"分隔符时就启动这种工作模式。如: `rsync­ -a /data /backup`\n\n2. 使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒 号\":\"分隔符时启动该模式。如: `rsync­ -avz *.c foo:src`\n\n3. 使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒 号\":\"分隔符时启动该模式。如: `rsync -­avz foo:src/bar /data`\n\n4. 从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含\"::\"分隔符时启动该模式。如: `rsync- ­av root@192.168.78.192::www /databack`\n\n5. 从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含\"::\"分隔符时启动该模式。如: `rsync­- av /databack root@192.168.78.192::www`\n\n6. 列远程机的文件列表。这类似于rsync传输,不过只要在命令中省略掉本地机信息即可。如: `rsync­ -v rsync://192.168.78.192/www`\n\n## 选项\n```\n­-v, --­­verbose 详细模式输出。\n­-q, ­­--quiet 精简输出模式。\n­-c, ­­--checksum 打开校验开关,强制对文件传输进行校验。\n­-a, ­­--archive 归档模式,表示以递归方式传输文件,并保持所有文件属性,等于­rlptgoD。 ­\n-r, ­­--recursive 对子目录以递归模式处理。\n-­R, ­­--relative 使用相对路径信息。\n­-b, ­­--backup 创建备份,也就是对于目的已经存在有同样的文件名时,将老的文件重新命名为~filename。可以使用­­ suffix选项来指定不同的备份文件前缀。\n--­­backup­-dir 将备份文件(如~filename)存放在在目录下。\n-­suffix=SUFFIX 定义备份文件前缀。\n­-u, ­­--update 仅仅进行更新,也就是跳过所有已经存在于DST,并且文件时间晚于要备份的文件,不覆盖更新的文件。 ­\n-l, ­­--links 保留软链结。\n-­L, ­­--copy-links 想对待常规文件一样处理软链结。\n­--­copy-­unsafe-­links 仅仅拷贝指向SRC路径目录树以外的链结。\n­­--safe-­links 忽略指向SRC路径目录树以外的链结。\n­-H, ­­--hard-­links 保留硬链结。\n­-p, ­­--perms 保持文件权限。\n­-o, ­­--owner 保持文件属主信息。\n­-g, ­­--group 保持文件属组信息。\n­-D, ­­--devices 保持设备文件信息。\n­-t, ­­--times 保持文件时间信息。\n­-S, ­­--sparse 对稀疏文件进行特殊处理以节省DST的空间。\n­-n, ­­--dry­-run现实哪些文件将被传输。\n­-w, ­­--whole-file 拷贝文件,不进行增量检测。\n­-x, ­­-one-file-system 不要跨越文件系统边界。\n­-B, ­­--block­-size=SIZE 检验算法使用的块尺寸,默认是700字节。\n­-e, ­­--rsh=command 指定使用rsh、ssh方式进行数据同步。\n­--­rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息。\n­-C, ­­--cvs-­exclude 使用和CVS一样的方法自动忽略文件,用来排除那些不希望传输的文件。\n­­--existing 仅仅更新那些已经存在于DST的文件,而不备份那些新创建的文件。\n­­--delete 删除那些DST中SRC没有的文件。\n­­--delete-­excluded 同样删除接收端那些被该选项指定排除的文件。\n­­--delete-after 传输结束以后再删除。\n­­--ignore-­errors 及时出现IO错误也进行删除。\n­­--max-delete=NUM 最多删除NUM个文件。\n­­--partial 保留那些因故没有完全传输的文件,以是加快随后的再次传输。\n­­--force 强制删除目录,即使不为空。\n­­--numeric-ids 不将数字的用户和组id匹配为用户名和组名。\n­­--timeout=time ip超时时间,单位为秒。\n­-I, --­­ignore-times 不跳过那些有同样的时间和长度的文件。\n­­--size-­only 当决定是否要备份文件时,仅仅察看文件大小而不考虑文件时间。\n­­--modify-­window=NUM 决定文件是否时间相同时使用的时间戳窗口,默认为0。\n­-T --­­temp-dir=DIR 在DIR中创建临时文件。\n­­--compare-­dest=DIR 同样比较DIR中的文件来决定是否需要备份。\n­-P等同于 ­--­partial。\n­­-progress 显示备份过程。\n­-z, ­--­compress 对备份的文件在传输时进行压缩处理。\n­­--exclude=PATTERN 指定排除不需要传输的文件模式。\n­­--include=PATTERN 指定不排除而需要传输的文件模式。\n­­--exclude-­from=FILE 排除FILE中指定模式的文件。\n­­--include-­from=FILE 不排除FILE指定模式匹配的文件。\n­­--version 打印版本信息。\n­­--address 绑定到特定的地址。\n­­--config=FILE 指定其他的配置文件,不使用默认的rsyncd.conf文件。\n­­--port=PORT 指定其他的rsync服务端口。\n­­--blocking-io 对远程shell使用阻塞IO。\n­--stats 给出某些文件的传输状态。\n\n­­--progress 在传输时现实传输过程。\n­­--log-­format=formAT 指定日志文件格式。\n­­--password­-file=FILE 从FILE中得到密码。\n­­--bwlimit=KBPS 限制I/O带宽,KBytes per second。\n-­h, --­­help 显示帮助信息。\n```\n\n## 实例\n\n### SSH方式\n首先在服务端启动ssh服务:\n```\nservice sshd start\n启动 sshd: [确定]\n```\n### 使用rsync进行同步\n接下来就可以在客户端使用rsync命令来备份服务端上的数据了,SSH方式是通过系统用户来进行备份的,如下:\n```\nrsync ­vzrtopg ­­progress ­e ssh ­­delete work@172.16.78.192:/www/* /databack/experiment/rsync\nwork@172.16.78.192's password:\nreceiving file list ...\n5 files to consider\ntest/\na\n0 100% 0.00kB/s 527:35:41 (1, 20.0% of 5) b\n67 100% 65.43kB/s 0:00:00 (2, 40.0% of 5) c\n0 100% 0.00kB/s 527:35:41 (3, 60.0% of 5) dd\n100663296 100% 42.22MB/s 0:00:02 (4, 80.0% of 5) sent 96 bytes received 98190 bytes 11563.06 bytes/sec total size is 100663363 speedup is 1024.19\n```\n上面的信息描述了整个的备份过程,以及总共备份数据的大小。\n\n### 后台服务方式\n启动rsync服务,编辑 /etc/xinetd.d/rsync文件,将其中的 disable=yes改为 disable=no,并重启 xinetd服务,如下:\n```\nvi /etc/xinetd.d/rsync\n#default: off\n# description: The rsync server is a good addition to an ftp server, as it \\ # allows crc checksumming etc.\nservice rsync {\ndisable = no\nsocket_type = stream\nwait = no\nuser = root\nserver = /usr/bin/rsync\nserver_args = ­­daemon\nlog_on_failure += USERID\n}\n```\n\n```\n/etc/init.d/xinetd restart\n停止 xinetd: [确定]\n启动 xinetd: [确定]\n```\n创建配置文件,默认安装好rsync程序后,并不会自动创建rsync的主配置文件,需要手工来创建,其主配置文件\n为“/etc/rsyncd.conf”,创建该文件并插入如下内容:\n```\nvi /etc/rsyncd.conf\nuid=root\ngid=root\nmax connections=4\nlog file=/var/log/rsyncd.log pid file=/var/run/rsyncd.pid lock file=/var/run/rsyncd.lock secrets file=/etc/rsyncd.passwd hosts deny=172.16.78.0/22\n[www]\ncomment= backup web path=/www\nread only = no exclude=test\nauth users=work\n```\n\n创建密码文件,采用这种方式不能使用系统用户对客户端进行认证,所以需要创建一个密码文件,其格式 为“username:password”,用户名可以和密码可以随便定义,最好不要和系统帐户一致,同时要把创建的密码文 件权限设置为600,这在前面的模块参数做了详细介绍。\n\n```\necho \"work:abc123\" > /etc/rsyncd.passwd\nchmod 600 /etc/rsyncd.passwd\n```\n备份,完成以上工作,现在就可以对数据进行备份了,如下:\n```\nrsync ­avz ­­progress ­­delete work@172.16.78.192::www /databack/experiment/rsync\nPassword:\nreceiving file list ...\n6 files to consider\n./ files...\na\n0 100% 0.00kB/s 528:20:41 (1, 50.0% of 6)\nb\n67 100% 65.43kB/s 0:00:00 (2, 66.7% of 6)\nc\n0 100% 0.00kB/s 528:20:41 (3, 83.3% of 6)\ndd\n100663296 100% 37.49MB/s 0:00:02 (4, 100.0% of 6) sent 172 bytes received 98276 bytes 17899.64 bytes/sec total size is 150995011 speedup is 1533.75\n```\n恢复,当服务器的数据出现问题时,那么这时就需要通过客户端的数据对服务端进行恢复,但前提是服务端允许客 户端有写入权限,否则也不能在客户端直接对服务端进行恢复,使用rsync对数据进行恢复的方法如下:\n```\nrsync ­avz ­­progress /databack/experiment/rsync/ work@172.16.78.192::www\nPassword:\nbuilding file list ...\n6 files to consider\n./\na\nb\n67 100% 0.00kB/s 0:00:00 (2, 66.7% of 6)\nc\nsent 258 bytes received 76 bytes 95.43 bytes/sec total size is 150995011 speedup is 452080.87\n\n```\n\n\n\n来自: http://man.linuxde.net/rsync\n","slug":"Linux常用工具命令之rsync","published":1,"updated":"2016-10-08T15:29:20.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwva000w699ffct49gfz","content":"<p>rsync命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。<br>rsync使用所谓的“rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。<br>rsync是一个功能非常强大的工具，其命令也有很多功能特色选项，我们下面就对它的选项一一进行分析说明。</p>\n<a id=\"more\"></a>\n<h2 id=\"语法\"><a href=\"#语法\" class=\"headerlink\" title=\"语法\"></a>语法</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync [OPTION]... SRC DEST</div><div class=\"line\">rsync [OPTION]... SRC [USER@]host:DEST</div><div class=\"line\">rsync [OPTION]... [USER@]HOST:SRC DEST</div><div class=\"line\">rsync [OPTION]... [USER@]HOST::SRC DEST</div><div class=\"line\">rsync [OPTION]... SRC [USER@]HOST::DEST</div><div class=\"line\">rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</div></pre></td></tr></table></figure>\n<p>对应于以上六种命令格式,rsync有六种不同的工作模式:</p>\n<ol>\n<li><p>拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号”:”分隔符时就启动这种工作模式。如: <code>rsync­ -a /data /backup</code></p>\n</li>\n<li><p>使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒 号”:”分隔符时启动该模式。如: <code>rsync­ -avz *.c foo:src</code></p>\n</li>\n<li><p>使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒 号”:”分隔符时启动该模式。如: <code>rsync -­avz foo:src/bar /data</code></p>\n</li>\n<li><p>从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含”::”分隔符时启动该模式。如: <code>rsync- ­av root@192.168.78.192::www /databack</code></p>\n</li>\n<li><p>从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含”::”分隔符时启动该模式。如: <code>rsync­- av /databack root@192.168.78.192::www</code></p>\n</li>\n<li><p>列远程机的文件列表。这类似于rsync传输,不过只要在命令中省略掉本地机信息即可。如: <code>rsync­ -v rsync://192.168.78.192/www</code></p>\n</li>\n</ol>\n<h2 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div></pre></td><td class=\"code\"><pre><div class=\"line\">­-v, --­­verbose 详细模式输出。</div><div class=\"line\">­-q, ­­--quiet 精简输出模式。</div><div class=\"line\">­-c, ­­--checksum 打开校验开关,强制对文件传输进行校验。</div><div class=\"line\">­-a, ­­--archive 归档模式,表示以递归方式传输文件,并保持所有文件属性,等于­rlptgoD。 ­</div><div class=\"line\">-r, ­­--recursive 对子目录以递归模式处理。</div><div class=\"line\">-­R, ­­--relative 使用相对路径信息。</div><div class=\"line\">­-b, ­­--backup 创建备份,也就是对于目的已经存在有同样的文件名时,将老的文件重新命名为~filename。可以使用­­ suffix选项来指定不同的备份文件前缀。</div><div class=\"line\">--­­backup­-dir 将备份文件(如~filename)存放在在目录下。</div><div class=\"line\">-­suffix=SUFFIX 定义备份文件前缀。</div><div class=\"line\">­-u, ­­--update 仅仅进行更新,也就是跳过所有已经存在于DST,并且文件时间晚于要备份的文件,不覆盖更新的文件。 ­</div><div class=\"line\">-l, ­­--links 保留软链结。</div><div class=\"line\">-­L, ­­--copy-links 想对待常规文件一样处理软链结。</div><div class=\"line\">­--­copy-­unsafe-­links 仅仅拷贝指向SRC路径目录树以外的链结。</div><div class=\"line\">­­--safe-­links 忽略指向SRC路径目录树以外的链结。</div><div class=\"line\">­-H, ­­--hard-­links 保留硬链结。</div><div class=\"line\">­-p, ­­--perms 保持文件权限。</div><div class=\"line\">­-o, ­­--owner 保持文件属主信息。</div><div class=\"line\">­-g, ­­--group 保持文件属组信息。</div><div class=\"line\">­-D, ­­--devices 保持设备文件信息。</div><div class=\"line\">­-t, ­­--times 保持文件时间信息。</div><div class=\"line\">­-S, ­­--sparse 对稀疏文件进行特殊处理以节省DST的空间。</div><div class=\"line\">­-n, ­­--dry­-run现实哪些文件将被传输。</div><div class=\"line\">­-w, ­­--whole-file 拷贝文件,不进行增量检测。</div><div class=\"line\">­-x, ­­-one-file-system 不要跨越文件系统边界。</div><div class=\"line\">­-B, ­­--block­-size=SIZE 检验算法使用的块尺寸,默认是700字节。</div><div class=\"line\">­-e, ­­--rsh=command 指定使用rsh、ssh方式进行数据同步。</div><div class=\"line\">­--­rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息。</div><div class=\"line\">­-C, ­­--cvs-­exclude 使用和CVS一样的方法自动忽略文件,用来排除那些不希望传输的文件。</div><div class=\"line\">­­--existing 仅仅更新那些已经存在于DST的文件,而不备份那些新创建的文件。</div><div class=\"line\">­­--delete 删除那些DST中SRC没有的文件。</div><div class=\"line\">­­--delete-­excluded 同样删除接收端那些被该选项指定排除的文件。</div><div class=\"line\">­­--delete-after 传输结束以后再删除。</div><div class=\"line\">­­--ignore-­errors 及时出现IO错误也进行删除。</div><div class=\"line\">­­--max-delete=NUM 最多删除NUM个文件。</div><div class=\"line\">­­--partial 保留那些因故没有完全传输的文件,以是加快随后的再次传输。</div><div class=\"line\">­­--force 强制删除目录,即使不为空。</div><div class=\"line\">­­--numeric-ids 不将数字的用户和组id匹配为用户名和组名。</div><div class=\"line\">­­--timeout=time ip超时时间,单位为秒。</div><div class=\"line\">­-I, --­­ignore-times 不跳过那些有同样的时间和长度的文件。</div><div class=\"line\">­­--size-­only 当决定是否要备份文件时,仅仅察看文件大小而不考虑文件时间。</div><div class=\"line\">­­--modify-­window=NUM 决定文件是否时间相同时使用的时间戳窗口,默认为0。</div><div class=\"line\">­-T --­­temp-dir=DIR 在DIR中创建临时文件。</div><div class=\"line\">­­--compare-­dest=DIR 同样比较DIR中的文件来决定是否需要备份。</div><div class=\"line\">­-P等同于 ­--­partial。</div><div class=\"line\">­­-progress 显示备份过程。</div><div class=\"line\">­-z, ­--­compress 对备份的文件在传输时进行压缩处理。</div><div class=\"line\">­­--exclude=PATTERN 指定排除不需要传输的文件模式。</div><div class=\"line\">­­--include=PATTERN 指定不排除而需要传输的文件模式。</div><div class=\"line\">­­--exclude-­from=FILE 排除FILE中指定模式的文件。</div><div class=\"line\">­­--include-­from=FILE 不排除FILE指定模式匹配的文件。</div><div class=\"line\">­­--version 打印版本信息。</div><div class=\"line\">­­--address 绑定到特定的地址。</div><div class=\"line\">­­--config=FILE 指定其他的配置文件,不使用默认的rsyncd.conf文件。</div><div class=\"line\">­­--port=PORT 指定其他的rsync服务端口。</div><div class=\"line\">­­--blocking-io 对远程shell使用阻塞IO。</div><div class=\"line\">­--stats 给出某些文件的传输状态。</div><div class=\"line\"></div><div class=\"line\">­­--progress 在传输时现实传输过程。</div><div class=\"line\">­­--log-­format=formAT 指定日志文件格式。</div><div class=\"line\">­­--password­-file=FILE 从FILE中得到密码。</div><div class=\"line\">­­--bwlimit=KBPS 限制I/O带宽,KBytes per second。</div><div class=\"line\">-­h, --­­help 显示帮助信息。</div></pre></td></tr></table></figure>\n<h2 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h2><h3 id=\"SSH方式\"><a href=\"#SSH方式\" class=\"headerlink\" title=\"SSH方式\"></a>SSH方式</h3><p>首先在服务端启动ssh服务:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">service sshd start</div><div class=\"line\">启动 sshd: [确定]</div></pre></td></tr></table></figure></p>\n<h3 id=\"使用rsync进行同步\"><a href=\"#使用rsync进行同步\" class=\"headerlink\" title=\"使用rsync进行同步\"></a>使用rsync进行同步</h3><p>接下来就可以在客户端使用rsync命令来备份服务端上的数据了,SSH方式是通过系统用户来进行备份的,如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync ­vzrtopg ­­progress ­e ssh ­­delete work@172.16.78.192:/www/* /databack/experiment/rsync</div><div class=\"line\">work@172.16.78.192&apos;s password:</div><div class=\"line\">receiving file list ...</div><div class=\"line\">5 files to consider</div><div class=\"line\">test/</div><div class=\"line\">a</div><div class=\"line\">0 100% 0.00kB/s 527:35:41 (1, 20.0% of 5) b</div><div class=\"line\">67 100% 65.43kB/s 0:00:00 (2, 40.0% of 5) c</div><div class=\"line\">0 100% 0.00kB/s 527:35:41 (3, 60.0% of 5) dd</div><div class=\"line\">100663296 100% 42.22MB/s 0:00:02 (4, 80.0% of 5) sent 96 bytes received 98190 bytes 11563.06 bytes/sec total size is 100663363 speedup is 1024.19</div></pre></td></tr></table></figure></p>\n<p>上面的信息描述了整个的备份过程,以及总共备份数据的大小。</p>\n<h3 id=\"后台服务方式\"><a href=\"#后台服务方式\" class=\"headerlink\" title=\"后台服务方式\"></a>后台服务方式</h3><p>启动rsync服务,编辑 /etc/xinetd.d/rsync文件,将其中的 disable=yes改为 disable=no,并重启 xinetd服务,如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/xinetd.d/rsync</div><div class=\"line\">#default: off</div><div class=\"line\"># description: The rsync server is a good addition to an ftp server, as it \\ # allows crc checksumming etc.</div><div class=\"line\">service rsync &#123;</div><div class=\"line\">disable = no</div><div class=\"line\">socket_type = stream</div><div class=\"line\">wait = no</div><div class=\"line\">user = root</div><div class=\"line\">server = /usr/bin/rsync</div><div class=\"line\">server_args = ­­daemon</div><div class=\"line\">log_on_failure += USERID</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/init.d/xinetd restart</div><div class=\"line\">停止 xinetd: [确定]</div><div class=\"line\">启动 xinetd: [确定]</div></pre></td></tr></table></figure>\n<p>创建配置文件,默认安装好rsync程序后,并不会自动创建rsync的主配置文件,需要手工来创建,其主配置文件<br>为“/etc/rsyncd.conf”,创建该文件并插入如下内容:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/rsyncd.conf</div><div class=\"line\">uid=root</div><div class=\"line\">gid=root</div><div class=\"line\">max connections=4</div><div class=\"line\">log file=/var/log/rsyncd.log pid file=/var/run/rsyncd.pid lock file=/var/run/rsyncd.lock secrets file=/etc/rsyncd.passwd hosts deny=172.16.78.0/22</div><div class=\"line\">[www]</div><div class=\"line\">comment= backup web path=/www</div><div class=\"line\">read only = no exclude=test</div><div class=\"line\">auth users=work</div></pre></td></tr></table></figure></p>\n<p>创建密码文件,采用这种方式不能使用系统用户对客户端进行认证,所以需要创建一个密码文件,其格式 为“username:password”,用户名可以和密码可以随便定义,最好不要和系统帐户一致,同时要把创建的密码文 件权限设置为600,这在前面的模块参数做了详细介绍。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;work:abc123&quot; &gt; /etc/rsyncd.passwd</div><div class=\"line\">chmod 600 /etc/rsyncd.passwd</div></pre></td></tr></table></figure>\n<p>备份,完成以上工作,现在就可以对数据进行备份了,如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync ­avz ­­progress ­­delete work@172.16.78.192::www /databack/experiment/rsync</div><div class=\"line\">Password:</div><div class=\"line\">receiving file list ...</div><div class=\"line\">6 files to consider</div><div class=\"line\">./ files...</div><div class=\"line\">a</div><div class=\"line\">0 100% 0.00kB/s 528:20:41 (1, 50.0% of 6)</div><div class=\"line\">b</div><div class=\"line\">67 100% 65.43kB/s 0:00:00 (2, 66.7% of 6)</div><div class=\"line\">c</div><div class=\"line\">0 100% 0.00kB/s 528:20:41 (3, 83.3% of 6)</div><div class=\"line\">dd</div><div class=\"line\">100663296 100% 37.49MB/s 0:00:02 (4, 100.0% of 6) sent 172 bytes received 98276 bytes 17899.64 bytes/sec total size is 150995011 speedup is 1533.75</div></pre></td></tr></table></figure></p>\n<p>恢复,当服务器的数据出现问题时,那么这时就需要通过客户端的数据对服务端进行恢复,但前提是服务端允许客 户端有写入权限,否则也不能在客户端直接对服务端进行恢复,使用rsync对数据进行恢复的方法如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync ­avz ­­progress /databack/experiment/rsync/ work@172.16.78.192::www</div><div class=\"line\">Password:</div><div class=\"line\">building file list ...</div><div class=\"line\">6 files to consider</div><div class=\"line\">./</div><div class=\"line\">a</div><div class=\"line\">b</div><div class=\"line\">67 100% 0.00kB/s 0:00:00 (2, 66.7% of 6)</div><div class=\"line\">c</div><div class=\"line\">sent 258 bytes received 76 bytes 95.43 bytes/sec total size is 150995011 speedup is 452080.87</div></pre></td></tr></table></figure></p>\n<p>来自: <a href=\"http://man.linuxde.net/rsync\" target=\"_blank\" rel=\"external\">http://man.linuxde.net/rsync</a></p>\n","excerpt":"<p>rsync命令是一个远程数据同步工具，可通过LAN/WAN快速同步多台主机间的文件。<br>rsync使用所谓的“rsync算法”来使本地和远程两个主机之间的文件达到同步，这个算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。<br>rsync是一个功能非常强大的工具，其命令也有很多功能特色选项，我们下面就对它的选项一一进行分析说明。</p>","more":"<h2 id=\"语法\"><a href=\"#语法\" class=\"headerlink\" title=\"语法\"></a>语法</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync [OPTION]... SRC DEST</div><div class=\"line\">rsync [OPTION]... SRC [USER@]host:DEST</div><div class=\"line\">rsync [OPTION]... [USER@]HOST:SRC DEST</div><div class=\"line\">rsync [OPTION]... [USER@]HOST::SRC DEST</div><div class=\"line\">rsync [OPTION]... SRC [USER@]HOST::DEST</div><div class=\"line\">rsync [OPTION]... rsync://[USER@]HOST[:PORT]/SRC [DEST]</div></pre></td></tr></table></figure>\n<p>对应于以上六种命令格式,rsync有六种不同的工作模式:</p>\n<ol>\n<li><p>拷贝本地文件。当SRC和DES路径信息都不包含有单个冒号”:”分隔符时就启动这种工作模式。如: <code>rsync­ -a /data /backup</code></p>\n</li>\n<li><p>使用一个远程shell程序(如rsh、ssh)来实现将本地机器的内容拷贝到远程机器。当DST路径地址包含单个冒 号”:”分隔符时启动该模式。如: <code>rsync­ -avz *.c foo:src</code></p>\n</li>\n<li><p>使用一个远程shell程序(如rsh、ssh)来实现将远程机器的内容拷贝到本地机器。当SRC地址路径包含单个冒 号”:”分隔符时启动该模式。如: <code>rsync -­avz foo:src/bar /data</code></p>\n</li>\n<li><p>从远程rsync服务器中拷贝文件到本地机。当SRC路径信息包含”::”分隔符时启动该模式。如: <code>rsync- ­av root@192.168.78.192::www /databack</code></p>\n</li>\n<li><p>从本地机器拷贝文件到远程rsync服务器中。当DST路径信息包含”::”分隔符时启动该模式。如: <code>rsync­- av /databack root@192.168.78.192::www</code></p>\n</li>\n<li><p>列远程机的文件列表。这类似于rsync传输,不过只要在命令中省略掉本地机信息即可。如: <code>rsync­ -v rsync://192.168.78.192/www</code></p>\n</li>\n</ol>\n<h2 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div></pre></td><td class=\"code\"><pre><div class=\"line\">­-v, --­­verbose 详细模式输出。</div><div class=\"line\">­-q, ­­--quiet 精简输出模式。</div><div class=\"line\">­-c, ­­--checksum 打开校验开关,强制对文件传输进行校验。</div><div class=\"line\">­-a, ­­--archive 归档模式,表示以递归方式传输文件,并保持所有文件属性,等于­rlptgoD。 ­</div><div class=\"line\">-r, ­­--recursive 对子目录以递归模式处理。</div><div class=\"line\">-­R, ­­--relative 使用相对路径信息。</div><div class=\"line\">­-b, ­­--backup 创建备份,也就是对于目的已经存在有同样的文件名时,将老的文件重新命名为~filename。可以使用­­ suffix选项来指定不同的备份文件前缀。</div><div class=\"line\">--­­backup­-dir 将备份文件(如~filename)存放在在目录下。</div><div class=\"line\">-­suffix=SUFFIX 定义备份文件前缀。</div><div class=\"line\">­-u, ­­--update 仅仅进行更新,也就是跳过所有已经存在于DST,并且文件时间晚于要备份的文件,不覆盖更新的文件。 ­</div><div class=\"line\">-l, ­­--links 保留软链结。</div><div class=\"line\">-­L, ­­--copy-links 想对待常规文件一样处理软链结。</div><div class=\"line\">­--­copy-­unsafe-­links 仅仅拷贝指向SRC路径目录树以外的链结。</div><div class=\"line\">­­--safe-­links 忽略指向SRC路径目录树以外的链结。</div><div class=\"line\">­-H, ­­--hard-­links 保留硬链结。</div><div class=\"line\">­-p, ­­--perms 保持文件权限。</div><div class=\"line\">­-o, ­­--owner 保持文件属主信息。</div><div class=\"line\">­-g, ­­--group 保持文件属组信息。</div><div class=\"line\">­-D, ­­--devices 保持设备文件信息。</div><div class=\"line\">­-t, ­­--times 保持文件时间信息。</div><div class=\"line\">­-S, ­­--sparse 对稀疏文件进行特殊处理以节省DST的空间。</div><div class=\"line\">­-n, ­­--dry­-run现实哪些文件将被传输。</div><div class=\"line\">­-w, ­­--whole-file 拷贝文件,不进行增量检测。</div><div class=\"line\">­-x, ­­-one-file-system 不要跨越文件系统边界。</div><div class=\"line\">­-B, ­­--block­-size=SIZE 检验算法使用的块尺寸,默认是700字节。</div><div class=\"line\">­-e, ­­--rsh=command 指定使用rsh、ssh方式进行数据同步。</div><div class=\"line\">­--­rsync-path=PATH 指定远程服务器上的rsync命令所在路径信息。</div><div class=\"line\">­-C, ­­--cvs-­exclude 使用和CVS一样的方法自动忽略文件,用来排除那些不希望传输的文件。</div><div class=\"line\">­­--existing 仅仅更新那些已经存在于DST的文件,而不备份那些新创建的文件。</div><div class=\"line\">­­--delete 删除那些DST中SRC没有的文件。</div><div class=\"line\">­­--delete-­excluded 同样删除接收端那些被该选项指定排除的文件。</div><div class=\"line\">­­--delete-after 传输结束以后再删除。</div><div class=\"line\">­­--ignore-­errors 及时出现IO错误也进行删除。</div><div class=\"line\">­­--max-delete=NUM 最多删除NUM个文件。</div><div class=\"line\">­­--partial 保留那些因故没有完全传输的文件,以是加快随后的再次传输。</div><div class=\"line\">­­--force 强制删除目录,即使不为空。</div><div class=\"line\">­­--numeric-ids 不将数字的用户和组id匹配为用户名和组名。</div><div class=\"line\">­­--timeout=time ip超时时间,单位为秒。</div><div class=\"line\">­-I, --­­ignore-times 不跳过那些有同样的时间和长度的文件。</div><div class=\"line\">­­--size-­only 当决定是否要备份文件时,仅仅察看文件大小而不考虑文件时间。</div><div class=\"line\">­­--modify-­window=NUM 决定文件是否时间相同时使用的时间戳窗口,默认为0。</div><div class=\"line\">­-T --­­temp-dir=DIR 在DIR中创建临时文件。</div><div class=\"line\">­­--compare-­dest=DIR 同样比较DIR中的文件来决定是否需要备份。</div><div class=\"line\">­-P等同于 ­--­partial。</div><div class=\"line\">­­-progress 显示备份过程。</div><div class=\"line\">­-z, ­--­compress 对备份的文件在传输时进行压缩处理。</div><div class=\"line\">­­--exclude=PATTERN 指定排除不需要传输的文件模式。</div><div class=\"line\">­­--include=PATTERN 指定不排除而需要传输的文件模式。</div><div class=\"line\">­­--exclude-­from=FILE 排除FILE中指定模式的文件。</div><div class=\"line\">­­--include-­from=FILE 不排除FILE指定模式匹配的文件。</div><div class=\"line\">­­--version 打印版本信息。</div><div class=\"line\">­­--address 绑定到特定的地址。</div><div class=\"line\">­­--config=FILE 指定其他的配置文件,不使用默认的rsyncd.conf文件。</div><div class=\"line\">­­--port=PORT 指定其他的rsync服务端口。</div><div class=\"line\">­­--blocking-io 对远程shell使用阻塞IO。</div><div class=\"line\">­--stats 给出某些文件的传输状态。</div><div class=\"line\"></div><div class=\"line\">­­--progress 在传输时现实传输过程。</div><div class=\"line\">­­--log-­format=formAT 指定日志文件格式。</div><div class=\"line\">­­--password­-file=FILE 从FILE中得到密码。</div><div class=\"line\">­­--bwlimit=KBPS 限制I/O带宽,KBytes per second。</div><div class=\"line\">-­h, --­­help 显示帮助信息。</div></pre></td></tr></table></figure>\n<h2 id=\"实例\"><a href=\"#实例\" class=\"headerlink\" title=\"实例\"></a>实例</h2><h3 id=\"SSH方式\"><a href=\"#SSH方式\" class=\"headerlink\" title=\"SSH方式\"></a>SSH方式</h3><p>首先在服务端启动ssh服务:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">service sshd start</div><div class=\"line\">启动 sshd: [确定]</div></pre></td></tr></table></figure></p>\n<h3 id=\"使用rsync进行同步\"><a href=\"#使用rsync进行同步\" class=\"headerlink\" title=\"使用rsync进行同步\"></a>使用rsync进行同步</h3><p>接下来就可以在客户端使用rsync命令来备份服务端上的数据了,SSH方式是通过系统用户来进行备份的,如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync ­vzrtopg ­­progress ­e ssh ­­delete work@172.16.78.192:/www/* /databack/experiment/rsync</div><div class=\"line\">work@172.16.78.192&apos;s password:</div><div class=\"line\">receiving file list ...</div><div class=\"line\">5 files to consider</div><div class=\"line\">test/</div><div class=\"line\">a</div><div class=\"line\">0 100% 0.00kB/s 527:35:41 (1, 20.0% of 5) b</div><div class=\"line\">67 100% 65.43kB/s 0:00:00 (2, 40.0% of 5) c</div><div class=\"line\">0 100% 0.00kB/s 527:35:41 (3, 60.0% of 5) dd</div><div class=\"line\">100663296 100% 42.22MB/s 0:00:02 (4, 80.0% of 5) sent 96 bytes received 98190 bytes 11563.06 bytes/sec total size is 100663363 speedup is 1024.19</div></pre></td></tr></table></figure></p>\n<p>上面的信息描述了整个的备份过程,以及总共备份数据的大小。</p>\n<h3 id=\"后台服务方式\"><a href=\"#后台服务方式\" class=\"headerlink\" title=\"后台服务方式\"></a>后台服务方式</h3><p>启动rsync服务,编辑 /etc/xinetd.d/rsync文件,将其中的 disable=yes改为 disable=no,并重启 xinetd服务,如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/xinetd.d/rsync</div><div class=\"line\">#default: off</div><div class=\"line\"># description: The rsync server is a good addition to an ftp server, as it \\ # allows crc checksumming etc.</div><div class=\"line\">service rsync &#123;</div><div class=\"line\">disable = no</div><div class=\"line\">socket_type = stream</div><div class=\"line\">wait = no</div><div class=\"line\">user = root</div><div class=\"line\">server = /usr/bin/rsync</div><div class=\"line\">server_args = ­­daemon</div><div class=\"line\">log_on_failure += USERID</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/init.d/xinetd restart</div><div class=\"line\">停止 xinetd: [确定]</div><div class=\"line\">启动 xinetd: [确定]</div></pre></td></tr></table></figure>\n<p>创建配置文件,默认安装好rsync程序后,并不会自动创建rsync的主配置文件,需要手工来创建,其主配置文件<br>为“/etc/rsyncd.conf”,创建该文件并插入如下内容:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/rsyncd.conf</div><div class=\"line\">uid=root</div><div class=\"line\">gid=root</div><div class=\"line\">max connections=4</div><div class=\"line\">log file=/var/log/rsyncd.log pid file=/var/run/rsyncd.pid lock file=/var/run/rsyncd.lock secrets file=/etc/rsyncd.passwd hosts deny=172.16.78.0/22</div><div class=\"line\">[www]</div><div class=\"line\">comment= backup web path=/www</div><div class=\"line\">read only = no exclude=test</div><div class=\"line\">auth users=work</div></pre></td></tr></table></figure></p>\n<p>创建密码文件,采用这种方式不能使用系统用户对客户端进行认证,所以需要创建一个密码文件,其格式 为“username:password”,用户名可以和密码可以随便定义,最好不要和系统帐户一致,同时要把创建的密码文 件权限设置为600,这在前面的模块参数做了详细介绍。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;work:abc123&quot; &gt; /etc/rsyncd.passwd</div><div class=\"line\">chmod 600 /etc/rsyncd.passwd</div></pre></td></tr></table></figure>\n<p>备份,完成以上工作,现在就可以对数据进行备份了,如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync ­avz ­­progress ­­delete work@172.16.78.192::www /databack/experiment/rsync</div><div class=\"line\">Password:</div><div class=\"line\">receiving file list ...</div><div class=\"line\">6 files to consider</div><div class=\"line\">./ files...</div><div class=\"line\">a</div><div class=\"line\">0 100% 0.00kB/s 528:20:41 (1, 50.0% of 6)</div><div class=\"line\">b</div><div class=\"line\">67 100% 65.43kB/s 0:00:00 (2, 66.7% of 6)</div><div class=\"line\">c</div><div class=\"line\">0 100% 0.00kB/s 528:20:41 (3, 83.3% of 6)</div><div class=\"line\">dd</div><div class=\"line\">100663296 100% 37.49MB/s 0:00:02 (4, 100.0% of 6) sent 172 bytes received 98276 bytes 17899.64 bytes/sec total size is 150995011 speedup is 1533.75</div></pre></td></tr></table></figure></p>\n<p>恢复,当服务器的数据出现问题时,那么这时就需要通过客户端的数据对服务端进行恢复,但前提是服务端允许客 户端有写入权限,否则也不能在客户端直接对服务端进行恢复,使用rsync对数据进行恢复的方法如下:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">rsync ­avz ­­progress /databack/experiment/rsync/ work@172.16.78.192::www</div><div class=\"line\">Password:</div><div class=\"line\">building file list ...</div><div class=\"line\">6 files to consider</div><div class=\"line\">./</div><div class=\"line\">a</div><div class=\"line\">b</div><div class=\"line\">67 100% 0.00kB/s 0:00:00 (2, 66.7% of 6)</div><div class=\"line\">c</div><div class=\"line\">sent 258 bytes received 76 bytes 95.43 bytes/sec total size is 150995011 speedup is 452080.87</div></pre></td></tr></table></figure></p>\n<p>来自: <a href=\"http://man.linuxde.net/rsync\">http://man.linuxde.net/rsync</a></p>"},{"title":"Linux文件和目录权限小结","date":"2016-10-06T14:30:00.000Z","_content":"\n\n## 普通权限\n文件的权限：\t- r  w  -  -  w  x  r  -  x\n```\n第一位：文件的类型\n    -：文件\n    d：文件夹\n    l：连接\n    c：字符设备文件\n    b：块设备\n    s：套接口文件\n第二位：所有者读权限\n第三位：所有者写权限\n第四位：所有者执行权限\n第五位：所有者组读权限\n第六位：所有者组写权限\n第七位：所有者组执行权限\n第八位：其他组读权限\n第九位：其他组写权限\n第十位：其他组执行权限\nr\t\t4\nw\t\t2\nx\t\t1\n```\n\n<!-- more -->\n\n## 特殊权限（SUID/SGID/SBIT）\n\n先来看看两个特殊的文件与目录\n```\n[root@yufei ~]# ls -l /usr/bin/passwd\n-rwsr-xr-x. 1 root root 26968 Jan 29  2010 /usr/bin/passwd\n[root@yufei ~]# ls -l /usr/bin/wall\n-r-xr-sr-x. 1 root tty 10932 Apr 27  2010 /usr/bin/wall\n[root@yufei ~]# ls -ld /tmp/\ndrwxrwxrwt. 7 root root 4096 Jan 20 11:00 /tmp/\n```\n第一个passwd命令在所有者的地方多了一个s，\n第二个wall命令在用户组的位置多了一个s，\n第三个tmp目录，多了一个t。\n\n这是为什么呢？下面我们就来具体看看，这些特殊的权限是什么意思？如何设置？\n\n### 特殊权限的介绍Set UID**\n\n当s这个标志出现在文件所有者的x权限上时，如/usr/bin/passwd这个文件的权限状态：“-rwsr-xr-x.”，此时就被称为Set UID，简称为SUID。那么这个特殊权限的特殊性的作用是什么呢？\n\n- 1、SUID权限仅对二进制程序(binary program)有效；\n- 2、执行者对于该程序需要具有x的可执行权限；\n- 3、本权限仅在执行该程序的过程中有效(run-time)；\n- 4、执行者将具有该程序拥有者(owner)的权限。\n\nSUID的目的就是：让本来没有相应权限的用户运行这个程序时，可以访问他没有权限访问的资源。passwd就是一个很鲜明的例子，下面我们就来了解一下这相passwd执行的过程。\n\n我们知道，系统中的用户密码是保存在/etc/shadow中的，而这个文件的权限是———-. （这个权限和以前版本的RHEL也有差别，以前的是-r——–）。其实有没有r权限不重要，因为我们的root用户是拥有最高的权限，什么都能干了。关键是要把密码写入到/etc/shadow中。我们知道，除了root用户能修改密码外，用户自己同样也能修改密码，为什么没有写入权限，还能修改密码，就是因为这个SUID功能。\n\n下面就是passwd这个命令的执行过程\n- 1、因为/usr/bin/passwd的权限对任何的用户都是可以执行的，所以系统中每个用户都可以执行此命令。\n- 2、而/usr/bin/passwd这个文件的权限是属于root的。\n- 3、当某个用户执行/usr/bin/passwd命令的时候，就拥有了root的权限了。\n- 4、于是某个用户就可以借助root用户的权力，来修改了/etc/shadow文件了。\n- 5、最后，把密码修改成功。\n\n注：这个SUID只能运行在二进制的程序上（系统中的一些命令），不能用在脚本上（script），因为脚本还是把很多的程序集合到一起来执行，而不是脚本自身在执行。同样，这个SUID也不能放到目录上，放上也是无效的。\n\n### Set GID\n\n我们前面讲过，当s这个标志出现在文件所有者的x权限上时，则就被称为Set UID。那么把这个s放到文件的所属用户组x位置上的话，就是SGID。如开头的/usr/bin/wall命令。\n那么SGID的功能是什么呢？和SUID一样，只是SGID是获得该程序所属用户组的权限。\n\n这相SGID有几点需要我们注意：\n- 1、SGID对二进制程序有用；\n- 2、程序执行者对于该程序来说，需具备x的权限；\n- 3、SGID主要用在目录上；\n理解了SUID，我想SGID也很容易理解。如果用户在此目录下具有w权限的话，若使用者在此目录下建立新文件，则新文件的群组与此目录的群组相同。\n\n### Sticky Bit\n\n这个就是针对others来设置的了，和上面两个一样，只是功能不同而已。\n\nSBIT（Sticky Bit）目前只针对目录有效，对于目录的作用是：当用户在该目录下建立文件或目录时，仅有自己与 root才有权力删除。\n\n最具有代表的就是/tmp目录，任何人都可以在/tmp内增加、修改文件（因为权限全是rwx），但仅有该文件/目录建立者与 root能够删除自己的目录或文件。\n\n**注：这个SBIT对文件不起作用。**\n\n### SUID/SGID/SBIT权限设置\n\n和我们前面说的rwx差不多，也有两种方式，一种是以字符，一种是以数字。\n\n- 4 为 SUID ＝ u+s\n- 2 为 SGID ＝ g+s\n- 1 为 SBIT ＝ o+t\n\n下面我们就来看看如何设置，并看看达到的效果。\n\n#### 先看SUID的作用及设置\n```\n[root@yufei ~]# cd /tmp/\n[root@yufei tmp]# cp /usr/bin/passwd ./\n[root@yufei tmp]# mkdir testdir\n```\n上面两步是在/tmp目录下创建passwd文件和testdir目录\n\n下面看看这两个的权限\n```\n[root@yufei tmp]# ls -l passwd ; ls -ld testdir/\n-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd\ndrwxr-xr-x. 2 root root 4096 Jan 20 19:25 testdir/\n```\n我们切换到yufei用户，然后修改自己的密码\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ ./passwd\nChanging password for user yufei.\nChanging password for yufei.\n(current) UNIX password:\nNew password:           \nRetype new password:\npasswd: Authentication token manipulation error\n```\n发现上面的yufei改不了自己的密码，为什么呢？就是因为没有权限把密码写入到/etc/shadow中。想让普通用户能修改/etc/shadow的话，那就需要用到SUID了。\n```\n[yufei@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod u+s passwd\n[root@yufei tmp]# ls -l passwd\n-rwsr-xr-x. 1 root root 26968 Jan 20 23:27 passwd\n```\n看到有SUID权限了，下面再来修改yufei自己的密码\n```\n[yufei@yufei tmp]$ ./passwd\nChanging password for user yufei.\nChanging password for yufei.\n(current) UNIX password:\nNew password:\nRetype new password:\npasswd: all authentication tokens updated successfully.\n```\n我们发现已经成功了。\n\n我想这一下，你对SUID的作用已经了解了吧。\n\n如果想把这个改回来（就是把SUID的权限去掉），我们用数字方式来设置\n```\n[root@yufei tmp]# chmod 0755 passwd\n[root@yufei tmp]# ls -l passwd\n-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd\n```\nOK这样就改过来了，这个数字的原理和我们前面讲的rwx是一样的，只是在最前面设置相应的数字而已。\n\n**注：在普通用户修改自己的密码是，密码要设置的复杂点，否则的话，通过不了认证，普通用户和root用户的权限是不同的。**\n\n#### 再看SGID的作用及设置\n\n我们以前面建立的/tmp/testdir为例子\n```\n[root@yufei tmp]# ls -ld testdir/\n[root@yufei tmp]# chmod 757 testdir/\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 20 19:25 testdir/\n```\n这时候，任何用户对此目录都有写入权限，那么我们就在这个目录里面创建文件与目录，并看看他们的权限如何\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/file1\n[yufei@yufei tmp]$ mkdir testdir/dir1\n[yufei@yufei tmp]$ ls -l testdir\ntotal 0\ndrw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1\n-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1\n```\n这时候的文件与目录权限都是创建者的本身\n下面我们就来看看，把这个目录加上SGID权限后，再创建文件与目录，会是什么样的效果\n```\n[yufei@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod g+s testdir/\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-srwx. 2 root root 4096 Jan 21 10:33 testdir/\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/file2\n[yufei@yufei tmp]$ mkdir testdir/dir2\n[yufei@yufei tmp]$ ls -l testdir/\ntotal 0\ndrw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1\ndrw-rw-r–. 1 yufei root  0 Jan 21 10:36 dir2\n-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1\n-rw-rw-r–. 1 yufei root  0 Jan 21 10:35 file2\n[yufei@yufei tmp]$ ls -ld testdir/\ndrwxr-srwx. 2 root root 4096 Jan 21 10:36 testdir/\n```\n这时候我们就发现，file2和dir2的用户组变成了root了，也就是他们上层目录testdir这个目录的所属用户组。\n这个应用，应用在一个项目的共同开发上，是很方便的。\n```\n[yufei@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod g-s testdir/\n[yufei@yufei tmp]$ ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 10:36 testdir/\n```\n这样就还原了\n\n#### 最后我们来看SBIT的作用及设置\n```\n[root@yufei tmp]# rm -fr testdir/*\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 11:42 testdir/\n```\n清空/tmp/testdir/目录里面的全部内容。\n\n我们切换成普通用户，然后再里面创建文件，至少需要两个普通用户来测试这个，如果没有的话，就自己建立。\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/yufei_file\n[yufei@yufei tmp]$ ls -l testdir/\ntotal 0\n-rw-rw-r– 1 yufei yufei 0 Jan 21 11:45 yufei_file\n```\n这时候我们建立了一个文件，我们换成另外一个用户\n```\n[yufei@yufei tmp]$ suopsers\nPassword:\n[opsers@yufei tmp]$ ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 11:45 testdir/\n```\n我们看到，虽然其他用户对yufei_file只有只读权限，但由于yufei_file所在的目录，对其他人是全部的权限，所以，我们换其他用户还是可以删除这个文件的，看操作\n```\n[opsers@yufei tmp]$ rm -f testdir/yufei_file\n[opsers@yufei tmp]$ ls testdir/\n```\n发现我们已经删除了这个不属于我们的权限。\n下面我们就给这个目录加上SBIT权限，再来看看效果\n```\n[opsers@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod o+t testdir\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwt. 2 root root 4096 Jan 21 11:49 testdir/\n```\n再一次切换普通用户，创建文件\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/yufei_file\n[yufei@yufei tmp]$ ls -l testdir/yufei_file\n-rw-rw-r– 1 yufei yufei 0 Jan 21 11:51 testdir/yufei_file\n```\n这个文件的权限还是和第一次创建的时候是一样的，我们再换成其他的用户，看看能不能再次删除这个文件\n```\n[yufei@yufei tmp]$ su opsers\nPassword:\n[opsers@yufei tmp]$ rm -f testdir/yufei_file\nrm: cannot remove `testdir/yufei_file’: Operation not permitted\n```\n看到提示，说权限不够了，只能由这个文件的创建者或root用户才能删除。这个我们就不演示了。\n如果要还原权限的话，\n```\n[opsers@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod o-t testdir\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 11:51 testdir/\n```\n两个需要注意的问题\n\nOK，关于SUID/SGID/SBIT这些特殊权限的应用和作用我们已经完了。但如果你仔细一点的话，会发现，我并没有用数字方式来更改这个特殊的权限，为什么呢？且看下面的分析。\n\n### question\n\n#### 问题1：用数字改变目录的特殊权限，不起作用。**\n\n我们把/tmp/下面，我们自己建立的实验文件删除\n```\n[root@yufei tmp]# rm -fr testdir/\n[root@yufei tmp]# rm -fr passwd\n```\n然后再重新创建一个文件和目录，\n```\n[root@yufei tmp]# cp /usr/bin/passwd ./\n[root@yufei tmp]# mkdir testdir\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-xr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n下面我们就来用数字方式来更改这三个特殊的权限，看看会有什么样的结果\n```\n[root@yufei tmp]# chmod 4755 passwd\n[root@yufei tmp]# chmod 3755 testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwsr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n发现用这种方式增加这三个特殊权限没有问题，那么我们再把权限改回去看看\n```\n[root@yufei tmp]# chmod 0755 passwd\n[root@yufei tmp]# chmod 0755 testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n我们发现，对文件，权限是改回去了，而对于目录，只改回去了SBIT的权限，对SUID和SGID改不回去。这是RHEL6上的实验结果，可能是出于安全性的考虑吗？这个我就不清楚了，也找不到相关的资料。\n\n所以说，建议大家还是用最明了的方式，直接用+-来更改，无论方法如何，最终能得到结果就OK了。哈哈……\n\n#### 问题2：为什么会有大写的S和T。\n\n还是用上面的文件和目录\n```\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n我们把passwd和testdir的x权限去掉\n```\n[root@yufei tmp]# chmod u-x passwd\n[root@yufei tmp]# chmod o-x testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rw-r-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr– 2 root root 4096 Jan 21 12:00 testdir/\n```\n再给他们加上SUID和SBIT权限\n```\n[root@yufei tmp]# chmod u+s passwd\n[root@yufei tmp]# chmod o+t testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwSr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-T 2 root root 4096 Jan 21 12:00 testdir/\n```\n我们看到，这时候的小s和小t已经变成了大S和大T了，为什么呢？因为他们这个位置没有了x权限，如果没有了x权限，根据我们上面讲的内容，其实，这个特殊的权限就相当于一个空的权限，没有意义。也就是说，如果你看到特殊权限位置上变成了大写的了，那么，就说明，这里有问题，需要排除。\n\n\n##\tACL权限（用来解决用户权限身份不足的问题）\n问题：只要使用ACL权限递归赋予权限，就很有可能出现权限溢出的危险（应为文件和目录的wrx权限含义是不同的）\n\n举例：\n```\n/www\n\tsc --> root\n\t61 -->  fgroup\n\to\n\t770\t\t\n```\n```\n[root@localhost ~]# mkdir /www\n[root@localhost ~]# chmod 770 /www/\n[root@localhost ~]# groupadd fgroup\n[root@localhost ~]# gpasswd -a sc fgroup\n```\n正在将用户“sc”加入到“fgroup”组中\n```\n[root@localhost ~]# gpasswd -a aa fgroup\n```\n正在将用户“aa”加入到“fgroup”组中\n```\n[root@localhost ~]# chown root:fgroup  /www\n[root@localhost ~]# ll -d  /www/\ndrwxrwx--- 2 root fgroup 4096 04-25 14:56 /www/\n```\n\n###\tgetfacl  文件名\t\t查询文件的acl权限\n\n###\tsetfacl  选项  文件名\t\t设定acl权限\n```\n\t-m\t\t\t设定权限\n\t-b\t\t\t删除权限\nsetfacl  -m  u:用户名:权限   文件名\nsetfacl  -m  g:组名：权限   文件名\nsetfacl  -m u:aa:rwx  /test\t\t给test目录赋予aa是读写执行的acl权限\n\nsetfacl -m u:cc:rx -R soft/\t\t赋予递归acl权限，只能赋予目录\n\t\t-R  递归\nsetfacl  -b  /test\t\t删除acl权限\n```\n###\tsetfacl  -m d:u:aa:rwx -R /test\tacl默认权限。\t\t\n> 注意：默认权限只能赋予目录\n>\n> 注意：如果给目录赋予acl权限，两条命令都要输入\n\n- -R 递归\n- -m  u:用户名：-R 权限\t\t只对已经存在的文件生效\n- -m  d:u:用户名：-R 权限\t\t只对未来要新建的文件生效\n","source":"_posts/Linux文件和目录权限小结.md","raw":"---\ntitle: Linux文件和目录权限小结\ndate: 2016-10-06 22:30:00\ncategories:\n- Linux\n---\n\n\n## 普通权限\n文件的权限：\t- r  w  -  -  w  x  r  -  x\n```\n第一位：文件的类型\n    -：文件\n    d：文件夹\n    l：连接\n    c：字符设备文件\n    b：块设备\n    s：套接口文件\n第二位：所有者读权限\n第三位：所有者写权限\n第四位：所有者执行权限\n第五位：所有者组读权限\n第六位：所有者组写权限\n第七位：所有者组执行权限\n第八位：其他组读权限\n第九位：其他组写权限\n第十位：其他组执行权限\nr\t\t4\nw\t\t2\nx\t\t1\n```\n\n<!-- more -->\n\n## 特殊权限（SUID/SGID/SBIT）\n\n先来看看两个特殊的文件与目录\n```\n[root@yufei ~]# ls -l /usr/bin/passwd\n-rwsr-xr-x. 1 root root 26968 Jan 29  2010 /usr/bin/passwd\n[root@yufei ~]# ls -l /usr/bin/wall\n-r-xr-sr-x. 1 root tty 10932 Apr 27  2010 /usr/bin/wall\n[root@yufei ~]# ls -ld /tmp/\ndrwxrwxrwt. 7 root root 4096 Jan 20 11:00 /tmp/\n```\n第一个passwd命令在所有者的地方多了一个s，\n第二个wall命令在用户组的位置多了一个s，\n第三个tmp目录，多了一个t。\n\n这是为什么呢？下面我们就来具体看看，这些特殊的权限是什么意思？如何设置？\n\n### 特殊权限的介绍Set UID**\n\n当s这个标志出现在文件所有者的x权限上时，如/usr/bin/passwd这个文件的权限状态：“-rwsr-xr-x.”，此时就被称为Set UID，简称为SUID。那么这个特殊权限的特殊性的作用是什么呢？\n\n- 1、SUID权限仅对二进制程序(binary program)有效；\n- 2、执行者对于该程序需要具有x的可执行权限；\n- 3、本权限仅在执行该程序的过程中有效(run-time)；\n- 4、执行者将具有该程序拥有者(owner)的权限。\n\nSUID的目的就是：让本来没有相应权限的用户运行这个程序时，可以访问他没有权限访问的资源。passwd就是一个很鲜明的例子，下面我们就来了解一下这相passwd执行的过程。\n\n我们知道，系统中的用户密码是保存在/etc/shadow中的，而这个文件的权限是———-. （这个权限和以前版本的RHEL也有差别，以前的是-r——–）。其实有没有r权限不重要，因为我们的root用户是拥有最高的权限，什么都能干了。关键是要把密码写入到/etc/shadow中。我们知道，除了root用户能修改密码外，用户自己同样也能修改密码，为什么没有写入权限，还能修改密码，就是因为这个SUID功能。\n\n下面就是passwd这个命令的执行过程\n- 1、因为/usr/bin/passwd的权限对任何的用户都是可以执行的，所以系统中每个用户都可以执行此命令。\n- 2、而/usr/bin/passwd这个文件的权限是属于root的。\n- 3、当某个用户执行/usr/bin/passwd命令的时候，就拥有了root的权限了。\n- 4、于是某个用户就可以借助root用户的权力，来修改了/etc/shadow文件了。\n- 5、最后，把密码修改成功。\n\n注：这个SUID只能运行在二进制的程序上（系统中的一些命令），不能用在脚本上（script），因为脚本还是把很多的程序集合到一起来执行，而不是脚本自身在执行。同样，这个SUID也不能放到目录上，放上也是无效的。\n\n### Set GID\n\n我们前面讲过，当s这个标志出现在文件所有者的x权限上时，则就被称为Set UID。那么把这个s放到文件的所属用户组x位置上的话，就是SGID。如开头的/usr/bin/wall命令。\n那么SGID的功能是什么呢？和SUID一样，只是SGID是获得该程序所属用户组的权限。\n\n这相SGID有几点需要我们注意：\n- 1、SGID对二进制程序有用；\n- 2、程序执行者对于该程序来说，需具备x的权限；\n- 3、SGID主要用在目录上；\n理解了SUID，我想SGID也很容易理解。如果用户在此目录下具有w权限的话，若使用者在此目录下建立新文件，则新文件的群组与此目录的群组相同。\n\n### Sticky Bit\n\n这个就是针对others来设置的了，和上面两个一样，只是功能不同而已。\n\nSBIT（Sticky Bit）目前只针对目录有效，对于目录的作用是：当用户在该目录下建立文件或目录时，仅有自己与 root才有权力删除。\n\n最具有代表的就是/tmp目录，任何人都可以在/tmp内增加、修改文件（因为权限全是rwx），但仅有该文件/目录建立者与 root能够删除自己的目录或文件。\n\n**注：这个SBIT对文件不起作用。**\n\n### SUID/SGID/SBIT权限设置\n\n和我们前面说的rwx差不多，也有两种方式，一种是以字符，一种是以数字。\n\n- 4 为 SUID ＝ u+s\n- 2 为 SGID ＝ g+s\n- 1 为 SBIT ＝ o+t\n\n下面我们就来看看如何设置，并看看达到的效果。\n\n#### 先看SUID的作用及设置\n```\n[root@yufei ~]# cd /tmp/\n[root@yufei tmp]# cp /usr/bin/passwd ./\n[root@yufei tmp]# mkdir testdir\n```\n上面两步是在/tmp目录下创建passwd文件和testdir目录\n\n下面看看这两个的权限\n```\n[root@yufei tmp]# ls -l passwd ; ls -ld testdir/\n-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd\ndrwxr-xr-x. 2 root root 4096 Jan 20 19:25 testdir/\n```\n我们切换到yufei用户，然后修改自己的密码\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ ./passwd\nChanging password for user yufei.\nChanging password for yufei.\n(current) UNIX password:\nNew password:           \nRetype new password:\npasswd: Authentication token manipulation error\n```\n发现上面的yufei改不了自己的密码，为什么呢？就是因为没有权限把密码写入到/etc/shadow中。想让普通用户能修改/etc/shadow的话，那就需要用到SUID了。\n```\n[yufei@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod u+s passwd\n[root@yufei tmp]# ls -l passwd\n-rwsr-xr-x. 1 root root 26968 Jan 20 23:27 passwd\n```\n看到有SUID权限了，下面再来修改yufei自己的密码\n```\n[yufei@yufei tmp]$ ./passwd\nChanging password for user yufei.\nChanging password for yufei.\n(current) UNIX password:\nNew password:\nRetype new password:\npasswd: all authentication tokens updated successfully.\n```\n我们发现已经成功了。\n\n我想这一下，你对SUID的作用已经了解了吧。\n\n如果想把这个改回来（就是把SUID的权限去掉），我们用数字方式来设置\n```\n[root@yufei tmp]# chmod 0755 passwd\n[root@yufei tmp]# ls -l passwd\n-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd\n```\nOK这样就改过来了，这个数字的原理和我们前面讲的rwx是一样的，只是在最前面设置相应的数字而已。\n\n**注：在普通用户修改自己的密码是，密码要设置的复杂点，否则的话，通过不了认证，普通用户和root用户的权限是不同的。**\n\n#### 再看SGID的作用及设置\n\n我们以前面建立的/tmp/testdir为例子\n```\n[root@yufei tmp]# ls -ld testdir/\n[root@yufei tmp]# chmod 757 testdir/\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 20 19:25 testdir/\n```\n这时候，任何用户对此目录都有写入权限，那么我们就在这个目录里面创建文件与目录，并看看他们的权限如何\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/file1\n[yufei@yufei tmp]$ mkdir testdir/dir1\n[yufei@yufei tmp]$ ls -l testdir\ntotal 0\ndrw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1\n-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1\n```\n这时候的文件与目录权限都是创建者的本身\n下面我们就来看看，把这个目录加上SGID权限后，再创建文件与目录，会是什么样的效果\n```\n[yufei@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod g+s testdir/\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-srwx. 2 root root 4096 Jan 21 10:33 testdir/\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/file2\n[yufei@yufei tmp]$ mkdir testdir/dir2\n[yufei@yufei tmp]$ ls -l testdir/\ntotal 0\ndrw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1\ndrw-rw-r–. 1 yufei root  0 Jan 21 10:36 dir2\n-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1\n-rw-rw-r–. 1 yufei root  0 Jan 21 10:35 file2\n[yufei@yufei tmp]$ ls -ld testdir/\ndrwxr-srwx. 2 root root 4096 Jan 21 10:36 testdir/\n```\n这时候我们就发现，file2和dir2的用户组变成了root了，也就是他们上层目录testdir这个目录的所属用户组。\n这个应用，应用在一个项目的共同开发上，是很方便的。\n```\n[yufei@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod g-s testdir/\n[yufei@yufei tmp]$ ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 10:36 testdir/\n```\n这样就还原了\n\n#### 最后我们来看SBIT的作用及设置\n```\n[root@yufei tmp]# rm -fr testdir/*\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 11:42 testdir/\n```\n清空/tmp/testdir/目录里面的全部内容。\n\n我们切换成普通用户，然后再里面创建文件，至少需要两个普通用户来测试这个，如果没有的话，就自己建立。\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/yufei_file\n[yufei@yufei tmp]$ ls -l testdir/\ntotal 0\n-rw-rw-r– 1 yufei yufei 0 Jan 21 11:45 yufei_file\n```\n这时候我们建立了一个文件，我们换成另外一个用户\n```\n[yufei@yufei tmp]$ suopsers\nPassword:\n[opsers@yufei tmp]$ ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 11:45 testdir/\n```\n我们看到，虽然其他用户对yufei_file只有只读权限，但由于yufei_file所在的目录，对其他人是全部的权限，所以，我们换其他用户还是可以删除这个文件的，看操作\n```\n[opsers@yufei tmp]$ rm -f testdir/yufei_file\n[opsers@yufei tmp]$ ls testdir/\n```\n发现我们已经删除了这个不属于我们的权限。\n下面我们就给这个目录加上SBIT权限，再来看看效果\n```\n[opsers@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod o+t testdir\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwt. 2 root root 4096 Jan 21 11:49 testdir/\n```\n再一次切换普通用户，创建文件\n```\n[root@yufei tmp]# su yufei\n[yufei@yufei tmp]$ touch testdir/yufei_file\n[yufei@yufei tmp]$ ls -l testdir/yufei_file\n-rw-rw-r– 1 yufei yufei 0 Jan 21 11:51 testdir/yufei_file\n```\n这个文件的权限还是和第一次创建的时候是一样的，我们再换成其他的用户，看看能不能再次删除这个文件\n```\n[yufei@yufei tmp]$ su opsers\nPassword:\n[opsers@yufei tmp]$ rm -f testdir/yufei_file\nrm: cannot remove `testdir/yufei_file’: Operation not permitted\n```\n看到提示，说权限不够了，只能由这个文件的创建者或root用户才能删除。这个我们就不演示了。\n如果要还原权限的话，\n```\n[opsers@yufei tmp]$ su root\nPassword:\n[root@yufei tmp]# chmod o-t testdir\n[root@yufei tmp]# ls -ld testdir/\ndrwxr-xrwx. 2 root root 4096 Jan 21 11:51 testdir/\n```\n两个需要注意的问题\n\nOK，关于SUID/SGID/SBIT这些特殊权限的应用和作用我们已经完了。但如果你仔细一点的话，会发现，我并没有用数字方式来更改这个特殊的权限，为什么呢？且看下面的分析。\n\n### question\n\n#### 问题1：用数字改变目录的特殊权限，不起作用。**\n\n我们把/tmp/下面，我们自己建立的实验文件删除\n```\n[root@yufei tmp]# rm -fr testdir/\n[root@yufei tmp]# rm -fr passwd\n```\n然后再重新创建一个文件和目录，\n```\n[root@yufei tmp]# cp /usr/bin/passwd ./\n[root@yufei tmp]# mkdir testdir\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-xr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n下面我们就来用数字方式来更改这三个特殊的权限，看看会有什么样的结果\n```\n[root@yufei tmp]# chmod 4755 passwd\n[root@yufei tmp]# chmod 3755 testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwsr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n发现用这种方式增加这三个特殊权限没有问题，那么我们再把权限改回去看看\n```\n[root@yufei tmp]# chmod 0755 passwd\n[root@yufei tmp]# chmod 0755 testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n我们发现，对文件，权限是改回去了，而对于目录，只改回去了SBIT的权限，对SUID和SGID改不回去。这是RHEL6上的实验结果，可能是出于安全性的考虑吗？这个我就不清楚了，也找不到相关的资料。\n\n所以说，建议大家还是用最明了的方式，直接用+-来更改，无论方法如何，最终能得到结果就OK了。哈哈……\n\n#### 问题2：为什么会有大写的S和T。\n\n还是用上面的文件和目录\n```\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/\n```\n我们把passwd和testdir的x权限去掉\n```\n[root@yufei tmp]# chmod u-x passwd\n[root@yufei tmp]# chmod o-x testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rw-r-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr– 2 root root 4096 Jan 21 12:00 testdir/\n```\n再给他们加上SUID和SBIT权限\n```\n[root@yufei tmp]# chmod u+s passwd\n[root@yufei tmp]# chmod o+t testdir/\n[root@yufei tmp]# ls -l passwd ;ls -ld testdir/\n-rwSr-xr-x 1 root root 26968 Jan 21 12:00 passwd\ndrwxr-sr-T 2 root root 4096 Jan 21 12:00 testdir/\n```\n我们看到，这时候的小s和小t已经变成了大S和大T了，为什么呢？因为他们这个位置没有了x权限，如果没有了x权限，根据我们上面讲的内容，其实，这个特殊的权限就相当于一个空的权限，没有意义。也就是说，如果你看到特殊权限位置上变成了大写的了，那么，就说明，这里有问题，需要排除。\n\n\n##\tACL权限（用来解决用户权限身份不足的问题）\n问题：只要使用ACL权限递归赋予权限，就很有可能出现权限溢出的危险（应为文件和目录的wrx权限含义是不同的）\n\n举例：\n```\n/www\n\tsc --> root\n\t61 -->  fgroup\n\to\n\t770\t\t\n```\n```\n[root@localhost ~]# mkdir /www\n[root@localhost ~]# chmod 770 /www/\n[root@localhost ~]# groupadd fgroup\n[root@localhost ~]# gpasswd -a sc fgroup\n```\n正在将用户“sc”加入到“fgroup”组中\n```\n[root@localhost ~]# gpasswd -a aa fgroup\n```\n正在将用户“aa”加入到“fgroup”组中\n```\n[root@localhost ~]# chown root:fgroup  /www\n[root@localhost ~]# ll -d  /www/\ndrwxrwx--- 2 root fgroup 4096 04-25 14:56 /www/\n```\n\n###\tgetfacl  文件名\t\t查询文件的acl权限\n\n###\tsetfacl  选项  文件名\t\t设定acl权限\n```\n\t-m\t\t\t设定权限\n\t-b\t\t\t删除权限\nsetfacl  -m  u:用户名:权限   文件名\nsetfacl  -m  g:组名：权限   文件名\nsetfacl  -m u:aa:rwx  /test\t\t给test目录赋予aa是读写执行的acl权限\n\nsetfacl -m u:cc:rx -R soft/\t\t赋予递归acl权限，只能赋予目录\n\t\t-R  递归\nsetfacl  -b  /test\t\t删除acl权限\n```\n###\tsetfacl  -m d:u:aa:rwx -R /test\tacl默认权限。\t\t\n> 注意：默认权限只能赋予目录\n>\n> 注意：如果给目录赋予acl权限，两条命令都要输入\n\n- -R 递归\n- -m  u:用户名：-R 权限\t\t只对已经存在的文件生效\n- -m  d:u:用户名：-R 权限\t\t只对未来要新建的文件生效\n","slug":"Linux文件和目录权限小结","published":1,"updated":"2016-10-07T14:55:11.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvd0011699fvt60wh5s","content":"<h2 id=\"普通权限\"><a href=\"#普通权限\" class=\"headerlink\" title=\"普通权限\"></a>普通权限</h2><p>文件的权限：    - r  w  -  -  w  x  r  -  x<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">第一位：文件的类型</div><div class=\"line\">    -：文件</div><div class=\"line\">    d：文件夹</div><div class=\"line\">    l：连接</div><div class=\"line\">    c：字符设备文件</div><div class=\"line\">    b：块设备</div><div class=\"line\">    s：套接口文件</div><div class=\"line\">第二位：所有者读权限</div><div class=\"line\">第三位：所有者写权限</div><div class=\"line\">第四位：所有者执行权限</div><div class=\"line\">第五位：所有者组读权限</div><div class=\"line\">第六位：所有者组写权限</div><div class=\"line\">第七位：所有者组执行权限</div><div class=\"line\">第八位：其他组读权限</div><div class=\"line\">第九位：其他组写权限</div><div class=\"line\">第十位：其他组执行权限</div><div class=\"line\">r\t\t4</div><div class=\"line\">w\t\t2</div><div class=\"line\">x\t\t1</div></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<h2 id=\"特殊权限（SUID-SGID-SBIT）\"><a href=\"#特殊权限（SUID-SGID-SBIT）\" class=\"headerlink\" title=\"特殊权限（SUID/SGID/SBIT）\"></a>特殊权限（SUID/SGID/SBIT）</h2><p>先来看看两个特殊的文件与目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei ~]# ls -l /usr/bin/passwd</div><div class=\"line\">-rwsr-xr-x. 1 root root 26968 Jan 29  2010 /usr/bin/passwd</div><div class=\"line\">[root@yufei ~]# ls -l /usr/bin/wall</div><div class=\"line\">-r-xr-sr-x. 1 root tty 10932 Apr 27  2010 /usr/bin/wall</div><div class=\"line\">[root@yufei ~]# ls -ld /tmp/</div><div class=\"line\">drwxrwxrwt. 7 root root 4096 Jan 20 11:00 /tmp/</div></pre></td></tr></table></figure></p>\n<p>第一个passwd命令在所有者的地方多了一个s，<br>第二个wall命令在用户组的位置多了一个s，<br>第三个tmp目录，多了一个t。</p>\n<p>这是为什么呢？下面我们就来具体看看，这些特殊的权限是什么意思？如何设置？</p>\n<h3 id=\"特殊权限的介绍Set-UID\"><a href=\"#特殊权限的介绍Set-UID\" class=\"headerlink\" title=\"特殊权限的介绍Set UID**\"></a>特殊权限的介绍Set UID**</h3><p>当s这个标志出现在文件所有者的x权限上时，如/usr/bin/passwd这个文件的权限状态：“-rwsr-xr-x.”，此时就被称为Set UID，简称为SUID。那么这个特殊权限的特殊性的作用是什么呢？</p>\n<ul>\n<li>1、SUID权限仅对二进制程序(binary program)有效；</li>\n<li>2、执行者对于该程序需要具有x的可执行权限；</li>\n<li>3、本权限仅在执行该程序的过程中有效(run-time)；</li>\n<li>4、执行者将具有该程序拥有者(owner)的权限。</li>\n</ul>\n<p>SUID的目的就是：让本来没有相应权限的用户运行这个程序时，可以访问他没有权限访问的资源。passwd就是一个很鲜明的例子，下面我们就来了解一下这相passwd执行的过程。</p>\n<p>我们知道，系统中的用户密码是保存在/etc/shadow中的，而这个文件的权限是———-. （这个权限和以前版本的RHEL也有差别，以前的是-r——–）。其实有没有r权限不重要，因为我们的root用户是拥有最高的权限，什么都能干了。关键是要把密码写入到/etc/shadow中。我们知道，除了root用户能修改密码外，用户自己同样也能修改密码，为什么没有写入权限，还能修改密码，就是因为这个SUID功能。</p>\n<p>下面就是passwd这个命令的执行过程</p>\n<ul>\n<li>1、因为/usr/bin/passwd的权限对任何的用户都是可以执行的，所以系统中每个用户都可以执行此命令。</li>\n<li>2、而/usr/bin/passwd这个文件的权限是属于root的。</li>\n<li>3、当某个用户执行/usr/bin/passwd命令的时候，就拥有了root的权限了。</li>\n<li>4、于是某个用户就可以借助root用户的权力，来修改了/etc/shadow文件了。</li>\n<li>5、最后，把密码修改成功。</li>\n</ul>\n<p>注：这个SUID只能运行在二进制的程序上（系统中的一些命令），不能用在脚本上（script），因为脚本还是把很多的程序集合到一起来执行，而不是脚本自身在执行。同样，这个SUID也不能放到目录上，放上也是无效的。</p>\n<h3 id=\"Set-GID\"><a href=\"#Set-GID\" class=\"headerlink\" title=\"Set GID\"></a>Set GID</h3><p>我们前面讲过，当s这个标志出现在文件所有者的x权限上时，则就被称为Set UID。那么把这个s放到文件的所属用户组x位置上的话，就是SGID。如开头的/usr/bin/wall命令。<br>那么SGID的功能是什么呢？和SUID一样，只是SGID是获得该程序所属用户组的权限。</p>\n<p>这相SGID有几点需要我们注意：</p>\n<ul>\n<li>1、SGID对二进制程序有用；</li>\n<li>2、程序执行者对于该程序来说，需具备x的权限；</li>\n<li>3、SGID主要用在目录上；<br>理解了SUID，我想SGID也很容易理解。如果用户在此目录下具有w权限的话，若使用者在此目录下建立新文件，则新文件的群组与此目录的群组相同。</li>\n</ul>\n<h3 id=\"Sticky-Bit\"><a href=\"#Sticky-Bit\" class=\"headerlink\" title=\"Sticky Bit\"></a>Sticky Bit</h3><p>这个就是针对others来设置的了，和上面两个一样，只是功能不同而已。</p>\n<p>SBIT（Sticky Bit）目前只针对目录有效，对于目录的作用是：当用户在该目录下建立文件或目录时，仅有自己与 root才有权力删除。</p>\n<p>最具有代表的就是/tmp目录，任何人都可以在/tmp内增加、修改文件（因为权限全是rwx），但仅有该文件/目录建立者与 root能够删除自己的目录或文件。</p>\n<p><strong>注：这个SBIT对文件不起作用。</strong></p>\n<h3 id=\"SUID-SGID-SBIT权限设置\"><a href=\"#SUID-SGID-SBIT权限设置\" class=\"headerlink\" title=\"SUID/SGID/SBIT权限设置\"></a>SUID/SGID/SBIT权限设置</h3><p>和我们前面说的rwx差不多，也有两种方式，一种是以字符，一种是以数字。</p>\n<ul>\n<li>4 为 SUID ＝ u+s</li>\n<li>2 为 SGID ＝ g+s</li>\n<li>1 为 SBIT ＝ o+t</li>\n</ul>\n<p>下面我们就来看看如何设置，并看看达到的效果。</p>\n<h4 id=\"先看SUID的作用及设置\"><a href=\"#先看SUID的作用及设置\" class=\"headerlink\" title=\"先看SUID的作用及设置\"></a>先看SUID的作用及设置</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei ~]# cd /tmp/</div><div class=\"line\">[root@yufei tmp]# cp /usr/bin/passwd ./</div><div class=\"line\">[root@yufei tmp]# mkdir testdir</div></pre></td></tr></table></figure>\n<p>上面两步是在/tmp目录下创建passwd文件和testdir目录</p>\n<p>下面看看这两个的权限<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# ls -l passwd ; ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd</div><div class=\"line\">drwxr-xr-x. 2 root root 4096 Jan 20 19:25 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们切换到yufei用户，然后修改自己的密码<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ ./passwd</div><div class=\"line\">Changing password for user yufei.</div><div class=\"line\">Changing password for yufei.</div><div class=\"line\">(current) UNIX password:</div><div class=\"line\">New password:           </div><div class=\"line\">Retype new password:</div><div class=\"line\">passwd: Authentication token manipulation error</div></pre></td></tr></table></figure></p>\n<p>发现上面的yufei改不了自己的密码，为什么呢？就是因为没有权限把密码写入到/etc/shadow中。想让普通用户能修改/etc/shadow的话，那就需要用到SUID了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod u+s passwd</div><div class=\"line\">[root@yufei tmp]# ls -l passwd</div><div class=\"line\">-rwsr-xr-x. 1 root root 26968 Jan 20 23:27 passwd</div></pre></td></tr></table></figure></p>\n<p>看到有SUID权限了，下面再来修改yufei自己的密码<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ ./passwd</div><div class=\"line\">Changing password for user yufei.</div><div class=\"line\">Changing password for yufei.</div><div class=\"line\">(current) UNIX password:</div><div class=\"line\">New password:</div><div class=\"line\">Retype new password:</div><div class=\"line\">passwd: all authentication tokens updated successfully.</div></pre></td></tr></table></figure></p>\n<p>我们发现已经成功了。</p>\n<p>我想这一下，你对SUID的作用已经了解了吧。</p>\n<p>如果想把这个改回来（就是把SUID的权限去掉），我们用数字方式来设置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod 0755 passwd</div><div class=\"line\">[root@yufei tmp]# ls -l passwd</div><div class=\"line\">-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd</div></pre></td></tr></table></figure></p>\n<p>OK这样就改过来了，这个数字的原理和我们前面讲的rwx是一样的，只是在最前面设置相应的数字而已。</p>\n<p><strong>注：在普通用户修改自己的密码是，密码要设置的复杂点，否则的话，通过不了认证，普通用户和root用户的权限是不同的。</strong></p>\n<h4 id=\"再看SGID的作用及设置\"><a href=\"#再看SGID的作用及设置\" class=\"headerlink\" title=\"再看SGID的作用及设置\"></a>再看SGID的作用及设置</h4><p>我们以前面建立的/tmp/testdir为例子<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">[root@yufei tmp]# chmod 757 testdir/</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 20 19:25 testdir/</div></pre></td></tr></table></figure></p>\n<p>这时候，任何用户对此目录都有写入权限，那么我们就在这个目录里面创建文件与目录，并看看他们的权限如何<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/file1</div><div class=\"line\">[yufei@yufei tmp]$ mkdir testdir/dir1</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir</div><div class=\"line\">total 0</div><div class=\"line\">drw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1</div><div class=\"line\">-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1</div></pre></td></tr></table></figure></p>\n<p>这时候的文件与目录权限都是创建者的本身<br>下面我们就来看看，把这个目录加上SGID权限后，再创建文件与目录，会是什么样的效果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod g+s testdir/</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-srwx. 2 root root 4096 Jan 21 10:33 testdir/</div><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/file2</div><div class=\"line\">[yufei@yufei tmp]$ mkdir testdir/dir2</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir/</div><div class=\"line\">total 0</div><div class=\"line\">drw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1</div><div class=\"line\">drw-rw-r–. 1 yufei root  0 Jan 21 10:36 dir2</div><div class=\"line\">-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1</div><div class=\"line\">-rw-rw-r–. 1 yufei root  0 Jan 21 10:35 file2</div><div class=\"line\">[yufei@yufei tmp]$ ls -ld testdir/</div><div class=\"line\">drwxr-srwx. 2 root root 4096 Jan 21 10:36 testdir/</div></pre></td></tr></table></figure></p>\n<p>这时候我们就发现，file2和dir2的用户组变成了root了，也就是他们上层目录testdir这个目录的所属用户组。<br>这个应用，应用在一个项目的共同开发上，是很方便的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod g-s testdir/</div><div class=\"line\">[yufei@yufei tmp]$ ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 10:36 testdir/</div></pre></td></tr></table></figure></p>\n<p>这样就还原了</p>\n<h4 id=\"最后我们来看SBIT的作用及设置\"><a href=\"#最后我们来看SBIT的作用及设置\" class=\"headerlink\" title=\"最后我们来看SBIT的作用及设置\"></a>最后我们来看SBIT的作用及设置</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# rm -fr testdir/*</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 11:42 testdir/</div></pre></td></tr></table></figure>\n<p>清空/tmp/testdir/目录里面的全部内容。</p>\n<p>我们切换成普通用户，然后再里面创建文件，至少需要两个普通用户来测试这个，如果没有的话，就自己建立。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/yufei_file</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir/</div><div class=\"line\">total 0</div><div class=\"line\">-rw-rw-r– 1 yufei yufei 0 Jan 21 11:45 yufei_file</div></pre></td></tr></table></figure></p>\n<p>这时候我们建立了一个文件，我们换成另外一个用户<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ suopsers</div><div class=\"line\">Password:</div><div class=\"line\">[opsers@yufei tmp]$ ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 11:45 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们看到，虽然其他用户对yufei_file只有只读权限，但由于yufei_file所在的目录，对其他人是全部的权限，所以，我们换其他用户还是可以删除这个文件的，看操作<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[opsers@yufei tmp]$ rm -f testdir/yufei_file</div><div class=\"line\">[opsers@yufei tmp]$ ls testdir/</div></pre></td></tr></table></figure></p>\n<p>发现我们已经删除了这个不属于我们的权限。<br>下面我们就给这个目录加上SBIT权限，再来看看效果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[opsers@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod o+t testdir</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwt. 2 root root 4096 Jan 21 11:49 testdir/</div></pre></td></tr></table></figure></p>\n<p>再一次切换普通用户，创建文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/yufei_file</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir/yufei_file</div><div class=\"line\">-rw-rw-r– 1 yufei yufei 0 Jan 21 11:51 testdir/yufei_file</div></pre></td></tr></table></figure></p>\n<p>这个文件的权限还是和第一次创建的时候是一样的，我们再换成其他的用户，看看能不能再次删除这个文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su opsers</div><div class=\"line\">Password:</div><div class=\"line\">[opsers@yufei tmp]$ rm -f testdir/yufei_file</div><div class=\"line\">rm: cannot remove `testdir/yufei_file’: Operation not permitted</div></pre></td></tr></table></figure></p>\n<p>看到提示，说权限不够了，只能由这个文件的创建者或root用户才能删除。这个我们就不演示了。<br>如果要还原权限的话，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[opsers@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod o-t testdir</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 11:51 testdir/</div></pre></td></tr></table></figure></p>\n<p>两个需要注意的问题</p>\n<p>OK，关于SUID/SGID/SBIT这些特殊权限的应用和作用我们已经完了。但如果你仔细一点的话，会发现，我并没有用数字方式来更改这个特殊的权限，为什么呢？且看下面的分析。</p>\n<h3 id=\"question\"><a href=\"#question\" class=\"headerlink\" title=\"question\"></a>question</h3><h4 id=\"问题1：用数字改变目录的特殊权限，不起作用。\"><a href=\"#问题1：用数字改变目录的特殊权限，不起作用。\" class=\"headerlink\" title=\"问题1：用数字改变目录的特殊权限，不起作用。**\"></a>问题1：用数字改变目录的特殊权限，不起作用。**</h4><p>我们把/tmp/下面，我们自己建立的实验文件删除<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# rm -fr testdir/</div><div class=\"line\">[root@yufei tmp]# rm -fr passwd</div></pre></td></tr></table></figure></p>\n<p>然后再重新创建一个文件和目录，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# cp /usr/bin/passwd ./</div><div class=\"line\">[root@yufei tmp]# mkdir testdir</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-xr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>下面我们就来用数字方式来更改这三个特殊的权限，看看会有什么样的结果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod 4755 passwd</div><div class=\"line\">[root@yufei tmp]# chmod 3755 testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwsr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>发现用这种方式增加这三个特殊权限没有问题，那么我们再把权限改回去看看<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod 0755 passwd</div><div class=\"line\">[root@yufei tmp]# chmod 0755 testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们发现，对文件，权限是改回去了，而对于目录，只改回去了SBIT的权限，对SUID和SGID改不回去。这是RHEL6上的实验结果，可能是出于安全性的考虑吗？这个我就不清楚了，也找不到相关的资料。</p>\n<p>所以说，建议大家还是用最明了的方式，直接用+-来更改，无论方法如何，最终能得到结果就OK了。哈哈……</p>\n<h4 id=\"问题2：为什么会有大写的S和T。\"><a href=\"#问题2：为什么会有大写的S和T。\" class=\"headerlink\" title=\"问题2：为什么会有大写的S和T。\"></a>问题2：为什么会有大写的S和T。</h4><p>还是用上面的文件和目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们把passwd和testdir的x权限去掉<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod u-x passwd</div><div class=\"line\">[root@yufei tmp]# chmod o-x testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rw-r-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr– 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>再给他们加上SUID和SBIT权限<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod u+s passwd</div><div class=\"line\">[root@yufei tmp]# chmod o+t testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwSr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-T 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们看到，这时候的小s和小t已经变成了大S和大T了，为什么呢？因为他们这个位置没有了x权限，如果没有了x权限，根据我们上面讲的内容，其实，这个特殊的权限就相当于一个空的权限，没有意义。也就是说，如果你看到特殊权限位置上变成了大写的了，那么，就说明，这里有问题，需要排除。</p>\n<h2 id=\"ACL权限（用来解决用户权限身份不足的问题）\"><a href=\"#ACL权限（用来解决用户权限身份不足的问题）\" class=\"headerlink\" title=\"ACL权限（用来解决用户权限身份不足的问题）\"></a>ACL权限（用来解决用户权限身份不足的问题）</h2><p>问题：只要使用ACL权限递归赋予权限，就很有可能出现权限溢出的危险（应为文件和目录的wrx权限含义是不同的）</p>\n<p>举例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">/www</div><div class=\"line\">\tsc --&gt; root</div><div class=\"line\">\t61 --&gt;  fgroup</div><div class=\"line\">\to</div><div class=\"line\">\t770</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# mkdir /www</div><div class=\"line\">[root@localhost ~]# chmod 770 /www/</div><div class=\"line\">[root@localhost ~]# groupadd fgroup</div><div class=\"line\">[root@localhost ~]# gpasswd -a sc fgroup</div></pre></td></tr></table></figure>\n<p>正在将用户“sc”加入到“fgroup”组中<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# gpasswd -a aa fgroup</div></pre></td></tr></table></figure></p>\n<p>正在将用户“aa”加入到“fgroup”组中<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# chown root:fgroup  /www</div><div class=\"line\">[root@localhost ~]# ll -d  /www/</div><div class=\"line\">drwxrwx--- 2 root fgroup 4096 04-25 14:56 /www/</div></pre></td></tr></table></figure></p>\n<h3 id=\"getfacl-文件名-查询文件的acl权限\"><a href=\"#getfacl-文件名-查询文件的acl权限\" class=\"headerlink\" title=\"getfacl  文件名        查询文件的acl权限\"></a>getfacl  文件名        查询文件的acl权限</h3><h3 id=\"setfacl-选项-文件名-设定acl权限\"><a href=\"#setfacl-选项-文件名-设定acl权限\" class=\"headerlink\" title=\"setfacl  选项  文件名        设定acl权限\"></a>setfacl  选项  文件名        设定acl权限</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">\t-m\t\t\t设定权限</div><div class=\"line\">\t-b\t\t\t删除权限</div><div class=\"line\">setfacl  -m  u:用户名:权限   文件名</div><div class=\"line\">setfacl  -m  g:组名：权限   文件名</div><div class=\"line\">setfacl  -m u:aa:rwx  /test\t\t给test目录赋予aa是读写执行的acl权限</div><div class=\"line\"></div><div class=\"line\">setfacl -m u:cc:rx -R soft/\t\t赋予递归acl权限，只能赋予目录</div><div class=\"line\">\t\t-R  递归</div><div class=\"line\">setfacl  -b  /test\t\t删除acl权限</div></pre></td></tr></table></figure>\n<h3 id=\"setfacl-m-d-u-aa-rwx-R-test-acl默认权限。\"><a href=\"#setfacl-m-d-u-aa-rwx-R-test-acl默认权限。\" class=\"headerlink\" title=\"setfacl  -m d:u:aa:rwx -R /test    acl默认权限。\"></a>setfacl  -m d:u:aa:rwx -R /test    acl默认权限。</h3><blockquote>\n<p>注意：默认权限只能赋予目录</p>\n<p>注意：如果给目录赋予acl权限，两条命令都要输入</p>\n</blockquote>\n<ul>\n<li>-R 递归</li>\n<li>-m  u:用户名：-R 权限        只对已经存在的文件生效</li>\n<li>-m  d:u:用户名：-R 权限        只对未来要新建的文件生效</li>\n</ul>\n","excerpt":"<h2 id=\"普通权限\"><a href=\"#普通权限\" class=\"headerlink\" title=\"普通权限\"></a>普通权限</h2><p>文件的权限：    - r  w  -  -  w  x  r  -  x<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">第一位：文件的类型</div><div class=\"line\">    -：文件</div><div class=\"line\">    d：文件夹</div><div class=\"line\">    l：连接</div><div class=\"line\">    c：字符设备文件</div><div class=\"line\">    b：块设备</div><div class=\"line\">    s：套接口文件</div><div class=\"line\">第二位：所有者读权限</div><div class=\"line\">第三位：所有者写权限</div><div class=\"line\">第四位：所有者执行权限</div><div class=\"line\">第五位：所有者组读权限</div><div class=\"line\">第六位：所有者组写权限</div><div class=\"line\">第七位：所有者组执行权限</div><div class=\"line\">第八位：其他组读权限</div><div class=\"line\">第九位：其他组写权限</div><div class=\"line\">第十位：其他组执行权限</div><div class=\"line\">r\t\t4</div><div class=\"line\">w\t\t2</div><div class=\"line\">x\t\t1</div></pre></td></tr></table></figure></p>","more":"<h2 id=\"特殊权限（SUID-SGID-SBIT）\"><a href=\"#特殊权限（SUID-SGID-SBIT）\" class=\"headerlink\" title=\"特殊权限（SUID/SGID/SBIT）\"></a>特殊权限（SUID/SGID/SBIT）</h2><p>先来看看两个特殊的文件与目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei ~]# ls -l /usr/bin/passwd</div><div class=\"line\">-rwsr-xr-x. 1 root root 26968 Jan 29  2010 /usr/bin/passwd</div><div class=\"line\">[root@yufei ~]# ls -l /usr/bin/wall</div><div class=\"line\">-r-xr-sr-x. 1 root tty 10932 Apr 27  2010 /usr/bin/wall</div><div class=\"line\">[root@yufei ~]# ls -ld /tmp/</div><div class=\"line\">drwxrwxrwt. 7 root root 4096 Jan 20 11:00 /tmp/</div></pre></td></tr></table></figure></p>\n<p>第一个passwd命令在所有者的地方多了一个s，<br>第二个wall命令在用户组的位置多了一个s，<br>第三个tmp目录，多了一个t。</p>\n<p>这是为什么呢？下面我们就来具体看看，这些特殊的权限是什么意思？如何设置？</p>\n<h3 id=\"特殊权限的介绍Set-UID\"><a href=\"#特殊权限的介绍Set-UID\" class=\"headerlink\" title=\"特殊权限的介绍Set UID**\"></a>特殊权限的介绍Set UID**</h3><p>当s这个标志出现在文件所有者的x权限上时，如/usr/bin/passwd这个文件的权限状态：“-rwsr-xr-x.”，此时就被称为Set UID，简称为SUID。那么这个特殊权限的特殊性的作用是什么呢？</p>\n<ul>\n<li>1、SUID权限仅对二进制程序(binary program)有效；</li>\n<li>2、执行者对于该程序需要具有x的可执行权限；</li>\n<li>3、本权限仅在执行该程序的过程中有效(run-time)；</li>\n<li>4、执行者将具有该程序拥有者(owner)的权限。</li>\n</ul>\n<p>SUID的目的就是：让本来没有相应权限的用户运行这个程序时，可以访问他没有权限访问的资源。passwd就是一个很鲜明的例子，下面我们就来了解一下这相passwd执行的过程。</p>\n<p>我们知道，系统中的用户密码是保存在/etc/shadow中的，而这个文件的权限是———-. （这个权限和以前版本的RHEL也有差别，以前的是-r——–）。其实有没有r权限不重要，因为我们的root用户是拥有最高的权限，什么都能干了。关键是要把密码写入到/etc/shadow中。我们知道，除了root用户能修改密码外，用户自己同样也能修改密码，为什么没有写入权限，还能修改密码，就是因为这个SUID功能。</p>\n<p>下面就是passwd这个命令的执行过程</p>\n<ul>\n<li>1、因为/usr/bin/passwd的权限对任何的用户都是可以执行的，所以系统中每个用户都可以执行此命令。</li>\n<li>2、而/usr/bin/passwd这个文件的权限是属于root的。</li>\n<li>3、当某个用户执行/usr/bin/passwd命令的时候，就拥有了root的权限了。</li>\n<li>4、于是某个用户就可以借助root用户的权力，来修改了/etc/shadow文件了。</li>\n<li>5、最后，把密码修改成功。</li>\n</ul>\n<p>注：这个SUID只能运行在二进制的程序上（系统中的一些命令），不能用在脚本上（script），因为脚本还是把很多的程序集合到一起来执行，而不是脚本自身在执行。同样，这个SUID也不能放到目录上，放上也是无效的。</p>\n<h3 id=\"Set-GID\"><a href=\"#Set-GID\" class=\"headerlink\" title=\"Set GID\"></a>Set GID</h3><p>我们前面讲过，当s这个标志出现在文件所有者的x权限上时，则就被称为Set UID。那么把这个s放到文件的所属用户组x位置上的话，就是SGID。如开头的/usr/bin/wall命令。<br>那么SGID的功能是什么呢？和SUID一样，只是SGID是获得该程序所属用户组的权限。</p>\n<p>这相SGID有几点需要我们注意：</p>\n<ul>\n<li>1、SGID对二进制程序有用；</li>\n<li>2、程序执行者对于该程序来说，需具备x的权限；</li>\n<li>3、SGID主要用在目录上；<br>理解了SUID，我想SGID也很容易理解。如果用户在此目录下具有w权限的话，若使用者在此目录下建立新文件，则新文件的群组与此目录的群组相同。</li>\n</ul>\n<h3 id=\"Sticky-Bit\"><a href=\"#Sticky-Bit\" class=\"headerlink\" title=\"Sticky Bit\"></a>Sticky Bit</h3><p>这个就是针对others来设置的了，和上面两个一样，只是功能不同而已。</p>\n<p>SBIT（Sticky Bit）目前只针对目录有效，对于目录的作用是：当用户在该目录下建立文件或目录时，仅有自己与 root才有权力删除。</p>\n<p>最具有代表的就是/tmp目录，任何人都可以在/tmp内增加、修改文件（因为权限全是rwx），但仅有该文件/目录建立者与 root能够删除自己的目录或文件。</p>\n<p><strong>注：这个SBIT对文件不起作用。</strong></p>\n<h3 id=\"SUID-SGID-SBIT权限设置\"><a href=\"#SUID-SGID-SBIT权限设置\" class=\"headerlink\" title=\"SUID/SGID/SBIT权限设置\"></a>SUID/SGID/SBIT权限设置</h3><p>和我们前面说的rwx差不多，也有两种方式，一种是以字符，一种是以数字。</p>\n<ul>\n<li>4 为 SUID ＝ u+s</li>\n<li>2 为 SGID ＝ g+s</li>\n<li>1 为 SBIT ＝ o+t</li>\n</ul>\n<p>下面我们就来看看如何设置，并看看达到的效果。</p>\n<h4 id=\"先看SUID的作用及设置\"><a href=\"#先看SUID的作用及设置\" class=\"headerlink\" title=\"先看SUID的作用及设置\"></a>先看SUID的作用及设置</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei ~]# cd /tmp/</div><div class=\"line\">[root@yufei tmp]# cp /usr/bin/passwd ./</div><div class=\"line\">[root@yufei tmp]# mkdir testdir</div></pre></td></tr></table></figure>\n<p>上面两步是在/tmp目录下创建passwd文件和testdir目录</p>\n<p>下面看看这两个的权限<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# ls -l passwd ; ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd</div><div class=\"line\">drwxr-xr-x. 2 root root 4096 Jan 20 19:25 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们切换到yufei用户，然后修改自己的密码<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ ./passwd</div><div class=\"line\">Changing password for user yufei.</div><div class=\"line\">Changing password for yufei.</div><div class=\"line\">(current) UNIX password:</div><div class=\"line\">New password:           </div><div class=\"line\">Retype new password:</div><div class=\"line\">passwd: Authentication token manipulation error</div></pre></td></tr></table></figure></p>\n<p>发现上面的yufei改不了自己的密码，为什么呢？就是因为没有权限把密码写入到/etc/shadow中。想让普通用户能修改/etc/shadow的话，那就需要用到SUID了。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod u+s passwd</div><div class=\"line\">[root@yufei tmp]# ls -l passwd</div><div class=\"line\">-rwsr-xr-x. 1 root root 26968 Jan 20 23:27 passwd</div></pre></td></tr></table></figure></p>\n<p>看到有SUID权限了，下面再来修改yufei自己的密码<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ ./passwd</div><div class=\"line\">Changing password for user yufei.</div><div class=\"line\">Changing password for yufei.</div><div class=\"line\">(current) UNIX password:</div><div class=\"line\">New password:</div><div class=\"line\">Retype new password:</div><div class=\"line\">passwd: all authentication tokens updated successfully.</div></pre></td></tr></table></figure></p>\n<p>我们发现已经成功了。</p>\n<p>我想这一下，你对SUID的作用已经了解了吧。</p>\n<p>如果想把这个改回来（就是把SUID的权限去掉），我们用数字方式来设置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod 0755 passwd</div><div class=\"line\">[root@yufei tmp]# ls -l passwd</div><div class=\"line\">-rwxr-xr-x. 1 root root 26968 Jan 20 23:27 passwd</div></pre></td></tr></table></figure></p>\n<p>OK这样就改过来了，这个数字的原理和我们前面讲的rwx是一样的，只是在最前面设置相应的数字而已。</p>\n<p><strong>注：在普通用户修改自己的密码是，密码要设置的复杂点，否则的话，通过不了认证，普通用户和root用户的权限是不同的。</strong></p>\n<h4 id=\"再看SGID的作用及设置\"><a href=\"#再看SGID的作用及设置\" class=\"headerlink\" title=\"再看SGID的作用及设置\"></a>再看SGID的作用及设置</h4><p>我们以前面建立的/tmp/testdir为例子<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">[root@yufei tmp]# chmod 757 testdir/</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 20 19:25 testdir/</div></pre></td></tr></table></figure></p>\n<p>这时候，任何用户对此目录都有写入权限，那么我们就在这个目录里面创建文件与目录，并看看他们的权限如何<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/file1</div><div class=\"line\">[yufei@yufei tmp]$ mkdir testdir/dir1</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir</div><div class=\"line\">total 0</div><div class=\"line\">drw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1</div><div class=\"line\">-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1</div></pre></td></tr></table></figure></p>\n<p>这时候的文件与目录权限都是创建者的本身<br>下面我们就来看看，把这个目录加上SGID权限后，再创建文件与目录，会是什么样的效果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod g+s testdir/</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-srwx. 2 root root 4096 Jan 21 10:33 testdir/</div><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/file2</div><div class=\"line\">[yufei@yufei tmp]$ mkdir testdir/dir2</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir/</div><div class=\"line\">total 0</div><div class=\"line\">drw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 dir1</div><div class=\"line\">drw-rw-r–. 1 yufei root  0 Jan 21 10:36 dir2</div><div class=\"line\">-rw-rw-r–. 1 yufei yufei 0 Jan 21 10:33 file1</div><div class=\"line\">-rw-rw-r–. 1 yufei root  0 Jan 21 10:35 file2</div><div class=\"line\">[yufei@yufei tmp]$ ls -ld testdir/</div><div class=\"line\">drwxr-srwx. 2 root root 4096 Jan 21 10:36 testdir/</div></pre></td></tr></table></figure></p>\n<p>这时候我们就发现，file2和dir2的用户组变成了root了，也就是他们上层目录testdir这个目录的所属用户组。<br>这个应用，应用在一个项目的共同开发上，是很方便的。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod g-s testdir/</div><div class=\"line\">[yufei@yufei tmp]$ ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 10:36 testdir/</div></pre></td></tr></table></figure></p>\n<p>这样就还原了</p>\n<h4 id=\"最后我们来看SBIT的作用及设置\"><a href=\"#最后我们来看SBIT的作用及设置\" class=\"headerlink\" title=\"最后我们来看SBIT的作用及设置\"></a>最后我们来看SBIT的作用及设置</h4><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# rm -fr testdir/*</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 11:42 testdir/</div></pre></td></tr></table></figure>\n<p>清空/tmp/testdir/目录里面的全部内容。</p>\n<p>我们切换成普通用户，然后再里面创建文件，至少需要两个普通用户来测试这个，如果没有的话，就自己建立。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/yufei_file</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir/</div><div class=\"line\">total 0</div><div class=\"line\">-rw-rw-r– 1 yufei yufei 0 Jan 21 11:45 yufei_file</div></pre></td></tr></table></figure></p>\n<p>这时候我们建立了一个文件，我们换成另外一个用户<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ suopsers</div><div class=\"line\">Password:</div><div class=\"line\">[opsers@yufei tmp]$ ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 11:45 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们看到，虽然其他用户对yufei_file只有只读权限，但由于yufei_file所在的目录，对其他人是全部的权限，所以，我们换其他用户还是可以删除这个文件的，看操作<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[opsers@yufei tmp]$ rm -f testdir/yufei_file</div><div class=\"line\">[opsers@yufei tmp]$ ls testdir/</div></pre></td></tr></table></figure></p>\n<p>发现我们已经删除了这个不属于我们的权限。<br>下面我们就给这个目录加上SBIT权限，再来看看效果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[opsers@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod o+t testdir</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwt. 2 root root 4096 Jan 21 11:49 testdir/</div></pre></td></tr></table></figure></p>\n<p>再一次切换普通用户，创建文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# su yufei</div><div class=\"line\">[yufei@yufei tmp]$ touch testdir/yufei_file</div><div class=\"line\">[yufei@yufei tmp]$ ls -l testdir/yufei_file</div><div class=\"line\">-rw-rw-r– 1 yufei yufei 0 Jan 21 11:51 testdir/yufei_file</div></pre></td></tr></table></figure></p>\n<p>这个文件的权限还是和第一次创建的时候是一样的，我们再换成其他的用户，看看能不能再次删除这个文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[yufei@yufei tmp]$ su opsers</div><div class=\"line\">Password:</div><div class=\"line\">[opsers@yufei tmp]$ rm -f testdir/yufei_file</div><div class=\"line\">rm: cannot remove `testdir/yufei_file’: Operation not permitted</div></pre></td></tr></table></figure></p>\n<p>看到提示，说权限不够了，只能由这个文件的创建者或root用户才能删除。这个我们就不演示了。<br>如果要还原权限的话，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[opsers@yufei tmp]$ su root</div><div class=\"line\">Password:</div><div class=\"line\">[root@yufei tmp]# chmod o-t testdir</div><div class=\"line\">[root@yufei tmp]# ls -ld testdir/</div><div class=\"line\">drwxr-xrwx. 2 root root 4096 Jan 21 11:51 testdir/</div></pre></td></tr></table></figure></p>\n<p>两个需要注意的问题</p>\n<p>OK，关于SUID/SGID/SBIT这些特殊权限的应用和作用我们已经完了。但如果你仔细一点的话，会发现，我并没有用数字方式来更改这个特殊的权限，为什么呢？且看下面的分析。</p>\n<h3 id=\"question\"><a href=\"#question\" class=\"headerlink\" title=\"question\"></a>question</h3><h4 id=\"问题1：用数字改变目录的特殊权限，不起作用。\"><a href=\"#问题1：用数字改变目录的特殊权限，不起作用。\" class=\"headerlink\" title=\"问题1：用数字改变目录的特殊权限，不起作用。**\"></a>问题1：用数字改变目录的特殊权限，不起作用。**</h4><p>我们把/tmp/下面，我们自己建立的实验文件删除<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# rm -fr testdir/</div><div class=\"line\">[root@yufei tmp]# rm -fr passwd</div></pre></td></tr></table></figure></p>\n<p>然后再重新创建一个文件和目录，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# cp /usr/bin/passwd ./</div><div class=\"line\">[root@yufei tmp]# mkdir testdir</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-xr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>下面我们就来用数字方式来更改这三个特殊的权限，看看会有什么样的结果<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod 4755 passwd</div><div class=\"line\">[root@yufei tmp]# chmod 3755 testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwsr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>发现用这种方式增加这三个特殊权限没有问题，那么我们再把权限改回去看看<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod 0755 passwd</div><div class=\"line\">[root@yufei tmp]# chmod 0755 testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们发现，对文件，权限是改回去了，而对于目录，只改回去了SBIT的权限，对SUID和SGID改不回去。这是RHEL6上的实验结果，可能是出于安全性的考虑吗？这个我就不清楚了，也找不到相关的资料。</p>\n<p>所以说，建议大家还是用最明了的方式，直接用+-来更改，无论方法如何，最终能得到结果就OK了。哈哈……</p>\n<h4 id=\"问题2：为什么会有大写的S和T。\"><a href=\"#问题2：为什么会有大写的S和T。\" class=\"headerlink\" title=\"问题2：为什么会有大写的S和T。\"></a>问题2：为什么会有大写的S和T。</h4><p>还是用上面的文件和目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwxr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-x 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们把passwd和testdir的x权限去掉<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod u-x passwd</div><div class=\"line\">[root@yufei tmp]# chmod o-x testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rw-r-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr– 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>再给他们加上SUID和SBIT权限<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@yufei tmp]# chmod u+s passwd</div><div class=\"line\">[root@yufei tmp]# chmod o+t testdir/</div><div class=\"line\">[root@yufei tmp]# ls -l passwd ;ls -ld testdir/</div><div class=\"line\">-rwSr-xr-x 1 root root 26968 Jan 21 12:00 passwd</div><div class=\"line\">drwxr-sr-T 2 root root 4096 Jan 21 12:00 testdir/</div></pre></td></tr></table></figure></p>\n<p>我们看到，这时候的小s和小t已经变成了大S和大T了，为什么呢？因为他们这个位置没有了x权限，如果没有了x权限，根据我们上面讲的内容，其实，这个特殊的权限就相当于一个空的权限，没有意义。也就是说，如果你看到特殊权限位置上变成了大写的了，那么，就说明，这里有问题，需要排除。</p>\n<h2 id=\"ACL权限（用来解决用户权限身份不足的问题）\"><a href=\"#ACL权限（用来解决用户权限身份不足的问题）\" class=\"headerlink\" title=\"ACL权限（用来解决用户权限身份不足的问题）\"></a>ACL权限（用来解决用户权限身份不足的问题）</h2><p>问题：只要使用ACL权限递归赋予权限，就很有可能出现权限溢出的危险（应为文件和目录的wrx权限含义是不同的）</p>\n<p>举例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">/www</div><div class=\"line\">\tsc --&gt; root</div><div class=\"line\">\t61 --&gt;  fgroup</div><div class=\"line\">\to</div><div class=\"line\">\t770</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# mkdir /www</div><div class=\"line\">[root@localhost ~]# chmod 770 /www/</div><div class=\"line\">[root@localhost ~]# groupadd fgroup</div><div class=\"line\">[root@localhost ~]# gpasswd -a sc fgroup</div></pre></td></tr></table></figure>\n<p>正在将用户“sc”加入到“fgroup”组中<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# gpasswd -a aa fgroup</div></pre></td></tr></table></figure></p>\n<p>正在将用户“aa”加入到“fgroup”组中<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# chown root:fgroup  /www</div><div class=\"line\">[root@localhost ~]# ll -d  /www/</div><div class=\"line\">drwxrwx--- 2 root fgroup 4096 04-25 14:56 /www/</div></pre></td></tr></table></figure></p>\n<h3 id=\"getfacl-文件名-查询文件的acl权限\"><a href=\"#getfacl-文件名-查询文件的acl权限\" class=\"headerlink\" title=\"getfacl  文件名        查询文件的acl权限\"></a>getfacl  文件名        查询文件的acl权限</h3><h3 id=\"setfacl-选项-文件名-设定acl权限\"><a href=\"#setfacl-选项-文件名-设定acl权限\" class=\"headerlink\" title=\"setfacl  选项  文件名        设定acl权限\"></a>setfacl  选项  文件名        设定acl权限</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">\t-m\t\t\t设定权限</div><div class=\"line\">\t-b\t\t\t删除权限</div><div class=\"line\">setfacl  -m  u:用户名:权限   文件名</div><div class=\"line\">setfacl  -m  g:组名：权限   文件名</div><div class=\"line\">setfacl  -m u:aa:rwx  /test\t\t给test目录赋予aa是读写执行的acl权限</div><div class=\"line\"></div><div class=\"line\">setfacl -m u:cc:rx -R soft/\t\t赋予递归acl权限，只能赋予目录</div><div class=\"line\">\t\t-R  递归</div><div class=\"line\">setfacl  -b  /test\t\t删除acl权限</div></pre></td></tr></table></figure>\n<h3 id=\"setfacl-m-d-u-aa-rwx-R-test-acl默认权限。\"><a href=\"#setfacl-m-d-u-aa-rwx-R-test-acl默认权限。\" class=\"headerlink\" title=\"setfacl  -m d:u:aa:rwx -R /test    acl默认权限。\"></a>setfacl  -m d:u:aa:rwx -R /test    acl默认权限。</h3><blockquote>\n<p>注意：默认权限只能赋予目录</p>\n<p>注意：如果给目录赋予acl权限，两条命令都要输入</p>\n</blockquote>\n<ul>\n<li>-R 递归</li>\n<li>-m  u:用户名：-R 权限        只对已经存在的文件生效</li>\n<li>-m  d:u:用户名：-R 权限        只对未来要新建的文件生效</li>\n</ul>"},{"title":"linux服务和进程管理","date":"2016-09-28T10:30:00.000Z","ctime":"2016-09-28T10:48:00.000Z","utime":"2016-09-28T10:48:00.000Z","modif_times":0,"_content":"\n![Linux服务和进程管理](http://n.sinaimg.cn/games/3ece443e/20160929/LinuxFuWuHeJinChengGuanLi.png?1)\n\n<!-- more -->\n\n## 进程管理\n进程管理的三个主要任务\n- 判断服务器的健康状态\n- 查看所有正在运行的进程\n- 强制终止进程\n\n### 进程查看\n\n#### ps aux             \n> 查看当前系统所有运行的进程（可以不加-）\n> * -a 显示前台所有进程\n> * -u 显示用户名\n> * -x 显示后台进程\n\n命令执行结果示例：\n```\nps aux\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot         1  0.0  0.3  41280  3732 ?        Ss   9月26   0:02 /usr/lib/systemd/systemd --switched-root --system\nroot         2  0.0  0.0      0     0 ?        S    9月26   0:00 [kthreadd]\nroot         3  0.0  0.0      0     0 ?        S    9月26   0:00 [ksoftirqd/0]\nroot         5  0.0  0.0      0     0 ?        S<   9月26   0:00 [kworker/0:0H]\nroot         6  0.0  0.0      0     0 ?        S    9月26   0:00 [kworker/u2:0]\nroot         7  0.0  0.0      0     0 ?        S    9月26   0:00 [migration/0]\nroot         8  0.0  0.0      0     0 ?        S    9月26   0:00 [rcu_bh]\nroot         9  0.0  0.0      0     0 ?        S    9月26   0:00 [rcuob/0]\nroot        10  0.0  0.0      0     0 ?        S    9月26   0:36 [rcu_sched]\nroot        11  0.0  0.0      0     0 ?        S    9月26   0:32 [rcuos/0]\n···\n```\n\n参数说明:\n\n参数 | 说明\n----|-----\nUSER|用户名\nPID |进程PID 1  init  系统启动的第一个进程\n%CPU|cpu占用百分比\n%MEM|内存占用百分比\nVSZ |虚拟内存占用量（KB）\nRSS |固定内存占有量\nTTY |登录终端  tty1-7 本地终端1-6 字符、 7图形） pts/0-255\nSTAT|状态 （S：睡眠 D：不可唤醒 R：运行 T：停止 Z：僵死 W：进入内存交换 X：死掉的进程 <:高优先级 N：低优先级 L：被锁进内存 s：含子进程 +：位于后台 l：多线程）\nSTART|进程触发时间\nTIME |占用cpu时间\nCOMMAND|进程本身\n\n#### pstree                    \n> * -a 查看进程树\n\n命令执行结果示例：\n```\npstree -a\nsystemd --switched-root --system --deserialize 21\n  ├─AliHids\n  │   └─4*[{AliHids}]\n  ├─AliYunDun\n  │   └─8*[{AliYunDun}]\n  ├─AliYunDunUpdate\n  │   └─3*[{AliYunDunUpdate}]\n  ├─agetty --noclear tty1 linux\n  ├─aliyun-service -d\n  ├─crond -n\n  ├─dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation\n  ├─memcached -d -m 128 -u root -p 11211\n  │   └─6*[{memcached}]\n  ├─nginx\n  │   └─nginx\n  ├─ntpd -u ntp:ntp -g\n  ├─php-fpm\n  │   ├─php-fpm\n  │   └─php-fpm\n  ├─rsyslogd -n\n  │   └─2*[{rsyslogd}]\n  ├─sshd -D\n  │   └─sshd\n  │       └─bash\n  │           └─pstree -a\n  ├─systemd-journal\n  ├─systemd-logind\n  └─systemd-udevd\n```\n\n#### top                    \n> 实时显示进程状态\n\n命令执行结果示例：\n```\ntop - 15:04:52 up 2 days,  5:25,  1 user,  load average: 0.00, 0.01, 0.05\nTasks:  70 total,   2 running,  68 sleeping,   0 stopped,   0 zombie\n%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\nKiB Mem :  1016796 total,   599400 free,    41948 used,   375448 buff/cache\nKiB Swap:        0 total,        0 free,        0 used.   838500 avail Mem\n\n  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND\n  917 root      20   0   82696   9152   5456 S  0.3  0.9   5:50.76 AliHids\n    1 root      20   0   41280   3732   2388 S  0.0  0.4   0:02.36 systemd\n    2 root      20   0       0      0      0 S  0.0  0.0   0:00.01 kthreadd\n    3 root      20   0       0      0      0 S  0.0  0.0   0:00.00 ksoftirqd/0\n    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H\n    6 root      20   0       0      0      0 S  0.0  0.0   0:00.26 kworker/u2:0\n    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0\n    ···\n```\n\n参数说明\n- 第一行：系统当前时间，系统持续时间， 登录用户，1,5,15分钟之前的平均负载\n- 第二行：进程总数\n- 第三行：CPU占用率\n- 第四行：内存使用：总共，空闲，已使用，缓存\n- 第五行：swap使用情况\n\n操作命令：\n- M,按内存占用排序\n- P,安CPU占用排序\n- q,退出\n\n\n### 终止进程\n\n#### kill 结束单个进程\n> kill命令是通过向进程发送指定的信号来结束相应进程的。在默认情况下，采用编号为15的TERM信号。TERM信号将终止所有不能捕获该信号的进程。对于那些可以捕获该信号的进程就要用编号为9的kill信号，强行“杀掉”该进程。\n>\n> 命令格式：kill 信号  PID\n\n信号，进程间的通信方式\n\n\n我们常用的信号有\n\n信号名称| 信号| 意义\n------|-----|-----\nHUP   | 1   | 终端断线\nINT   | 2   | 中断（同 Ctrl + C）\nQUIT  | 3   | 退出（同 Ctrl + \\）\nTERM  | 15  |  终止\nKILL  | 9   | 强制终止\nCONT  | 18  |  继续（与STOP相反， fg/bg命令）\nSTOP  | 19  |  暂停（同 Ctrl + Z）\n\n示例：结束 memcached 进程\n\n获取memcached进程pid（24428，即为memcached进程PID）\n```\nps -aux | grep memcache\nroot     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\nroot     24727  0.0  0.0 112664   984 pts/0    S+   15:54   0:00 grep --color=auto memcache\n#\nps -ef | grep memcache\nroot     24428     1  0 11:00 ?        00:00:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\nroot     24708 24568  0 15:49 pts/0    00:00:00 grep --color=auto memcache\n```\n或者使用pidof查看 （ pid + of ）\n```\n[root@...]# pidof memcached\n24428\n```\n终止 memcached\n```\nkill -9 24428\nps -aux | grep memcache\nroot     24729  0.0  0.0 112664   984 pts/0    S+   15:55   0:00 grep --color=auto memcache\n```\n\n#### killall   \n> 杀死指定名字的进程\n>\n> 命令格式：killall 信号  进程名\n\n示例：\n```\nkillall -9 memcached\n```\n\n#### pkill\n> 支持按照一定规则匹配来杀死进程\n>\n> 命令格式：pkill [options] <pattern>\n\n示例：杀死用户 wahaha 下的所有进程\n```\npkill -u wahaha\n```\n把某个终端登陆的用户踢出\n```\npkill -9 -t 终端号\n```\n把本地登陆终端1登陆用户踢出\n```\npkill -9 -t tty1                              \n```\n\n## 服务管理\n### Linux中服务的分类\n\n#### 系统默认安装的服务(RPM)\n- 独立的服务\n- 基于xinetd的服务，xinetd是系统超级守护进程\n> xinetd服务其本身就是一个独立的服务。\n>\n> 当程序调用xinetd服务时，它先调用的事xinetd服务，让后xinetd服务在调用索要调用的服务进行相应。\n>\n> Linux系统默认是没有安装xinetd服务的，需要进行安装后才能使用。\n\n#### 源码包安装的服务\n### 系统默认安装的服务\n#### 如何区分服务的分类\n查看服务的自启动状态\n```\nchkconfig  --list                      \n```\n运行结果：\n```\nchkconfig  --list\n注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务。SysV 配置数据可能被原生 systemd 配置覆盖。\n      如果您想列出 systemd 服务,请执行 'systemctl list-unit-files'。\n      欲查看对特定 target 启用的服务请执行\n      'systemctl list-dependencies [target]'。\naegis          \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关\nagentwatch     \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关\nnetconsole     \t0:关\t1:关\t2:关\t3:关\t4:关\t5:关\t6:关\nnetwork        \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关\n```\n\nLinux的运行级别：0-6\n\n级别| 说明\n---|-----\n0  |关机\n1  |单用户模式\n2  |不完全多用户，不包含NFS服务\n3  |完全多用户,字符界面\n4  |未分配\n5  |图形界面\n6  |重启\n\n查看当前系统的运行级别：\n```\nrunlevel\nN 3\n```\n切换系统当前的运行级别：\n\n命令 | 含义\n----|-----\ninit  0 |关机                   \ninit  5 |切换到图形界面（前提图形界面已经安装）\ninit  3 |切换到字符界面\ninit  6 |重启\n\n#### 独立的服务管理\n\n- 启动\n\n第一种方式：\n```\n/etc/rc.d/init.d/服务名 start| stop | restart | status\n# 例：\n/etc/rc.d/init.d/httpd start\n```\n第二种方式：（只支持RedHat系列的Linux）\n```\nservice 服务名 tart| stop | restart | status\n```\n***service命令其本质是当命令运行时直接在/etc/rc.d/init.d目录下查找相应的服务，并进行相应的操作。）***\n\n- 自启动\n-\n第一种方式：\n```\nchkconfig --level 2345 服务名 on|off\n```\n第二种方式：（推荐）\n```\nvi  /etc/rc.local (系统启动时会运行该文件)\n```\n修改文件内容：\n```\ntouch /var/lock/subsys/local （更新系统的开机时间）\n# 在下一行，写入自己要启动的服务名，比如我要开机自启动httpd服务：\n# 就加入/etc/rc.d/init.d/httpd start\n# 更改后文件就是：\ntouch /var/lock/subsys/local\n/etc/rc.d/init.d/httpd start\n```\n\n#### ntsysv自启动管理工具\n所有系统默认安装服务都可以使用ntsysv命令进行自启动管理。rpm包安装服务，自启动管理工具（只要rpm安装的，都可进行管理）\n\n### 源码包安装的服务\n启动\n```\n/usr/local/apache2/bin/apachectl  start\n```\n自启动\n```\nvi /etc/rc.local         \n加入\n/usr/local/apache2/bin/apachectl  start\n```\n\n\n## 计划任务\n> 首先保证crond服务时启动的（crond默认是自启动的）\n\n命令：crontab\n\n编辑格式： * * * * *  命令\n\n说明：\n- 第一个*：一小时中第几分钟  0-59\n- 第二个*：一天中第几个小时  0-23\n- 第三个*：一个月中第几天    1-31\n- 第四个*：一年第几个月      1-12\n- 第五个*：一周中星期几       0-6             \n\n例\n```\n10  *  31  *  *  命令\n10  *  *  *  *  命令\n5  4  *  5-10  *  命令\n*/10  *  *  *  *  命令\n5 4  1,15  *  *  命令  #日期和星期不要同时指定，会超出预期\n5 4 10 * 5 命令\n*/20 4 * 5 2   命令    #每隔二十分钟\n```\n\n查看系统定时任务\n```\ncrontab  -l\n```\n删除定时任务(慎用，删除之前记得备份数据)\n```\ncrontab  -r\n```\n\n**注意事项：**\n- 选项都不能为空，必须填入，不知道的值使用通配符*表示任何时间\n- 每个时间字段都可以指定多个值，不连续的值用,间隔，连续的值用-间隔\n- 间隔固定时间执行书写为*/n格式\n- 命令应该给出绝对路径\n- 星期几何第几天不能同时出现\n- 最小时间范围是分钟，最大时间范围是月\n\n\n## 查看系统启动信息\n查看系统启动信息\n```\ndmesg\n```\n系统启动信息日志\n```\ncat  /var/log/dmesg\n```\n查看eth0信息\n```\ndmesg | grep eth0                   \n```\n查看cpu信息\n```\ndmesg | grep CPU                   \n```\n","source":"_posts/Linux服务和进程管理.md","raw":"---\ntitle: linux服务和进程管理\ndate: 2016-09-28 18:30:00\nctime: 2016-09-28 18:48:00\nutime: 2016-09-28 18:48:00\nmodif_times: 0\ntags:\n- 进程管理\n- 服务管理\ncategories:\n- Linux\n---\n\n![Linux服务和进程管理](http://n.sinaimg.cn/games/3ece443e/20160929/LinuxFuWuHeJinChengGuanLi.png?1)\n\n<!-- more -->\n\n## 进程管理\n进程管理的三个主要任务\n- 判断服务器的健康状态\n- 查看所有正在运行的进程\n- 强制终止进程\n\n### 进程查看\n\n#### ps aux             \n> 查看当前系统所有运行的进程（可以不加-）\n> * -a 显示前台所有进程\n> * -u 显示用户名\n> * -x 显示后台进程\n\n命令执行结果示例：\n```\nps aux\nUSER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND\nroot         1  0.0  0.3  41280  3732 ?        Ss   9月26   0:02 /usr/lib/systemd/systemd --switched-root --system\nroot         2  0.0  0.0      0     0 ?        S    9月26   0:00 [kthreadd]\nroot         3  0.0  0.0      0     0 ?        S    9月26   0:00 [ksoftirqd/0]\nroot         5  0.0  0.0      0     0 ?        S<   9月26   0:00 [kworker/0:0H]\nroot         6  0.0  0.0      0     0 ?        S    9月26   0:00 [kworker/u2:0]\nroot         7  0.0  0.0      0     0 ?        S    9月26   0:00 [migration/0]\nroot         8  0.0  0.0      0     0 ?        S    9月26   0:00 [rcu_bh]\nroot         9  0.0  0.0      0     0 ?        S    9月26   0:00 [rcuob/0]\nroot        10  0.0  0.0      0     0 ?        S    9月26   0:36 [rcu_sched]\nroot        11  0.0  0.0      0     0 ?        S    9月26   0:32 [rcuos/0]\n···\n```\n\n参数说明:\n\n参数 | 说明\n----|-----\nUSER|用户名\nPID |进程PID 1  init  系统启动的第一个进程\n%CPU|cpu占用百分比\n%MEM|内存占用百分比\nVSZ |虚拟内存占用量（KB）\nRSS |固定内存占有量\nTTY |登录终端  tty1-7 本地终端1-6 字符、 7图形） pts/0-255\nSTAT|状态 （S：睡眠 D：不可唤醒 R：运行 T：停止 Z：僵死 W：进入内存交换 X：死掉的进程 <:高优先级 N：低优先级 L：被锁进内存 s：含子进程 +：位于后台 l：多线程）\nSTART|进程触发时间\nTIME |占用cpu时间\nCOMMAND|进程本身\n\n#### pstree                    \n> * -a 查看进程树\n\n命令执行结果示例：\n```\npstree -a\nsystemd --switched-root --system --deserialize 21\n  ├─AliHids\n  │   └─4*[{AliHids}]\n  ├─AliYunDun\n  │   └─8*[{AliYunDun}]\n  ├─AliYunDunUpdate\n  │   └─3*[{AliYunDunUpdate}]\n  ├─agetty --noclear tty1 linux\n  ├─aliyun-service -d\n  ├─crond -n\n  ├─dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation\n  ├─memcached -d -m 128 -u root -p 11211\n  │   └─6*[{memcached}]\n  ├─nginx\n  │   └─nginx\n  ├─ntpd -u ntp:ntp -g\n  ├─php-fpm\n  │   ├─php-fpm\n  │   └─php-fpm\n  ├─rsyslogd -n\n  │   └─2*[{rsyslogd}]\n  ├─sshd -D\n  │   └─sshd\n  │       └─bash\n  │           └─pstree -a\n  ├─systemd-journal\n  ├─systemd-logind\n  └─systemd-udevd\n```\n\n#### top                    \n> 实时显示进程状态\n\n命令执行结果示例：\n```\ntop - 15:04:52 up 2 days,  5:25,  1 user,  load average: 0.00, 0.01, 0.05\nTasks:  70 total,   2 running,  68 sleeping,   0 stopped,   0 zombie\n%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st\nKiB Mem :  1016796 total,   599400 free,    41948 used,   375448 buff/cache\nKiB Swap:        0 total,        0 free,        0 used.   838500 avail Mem\n\n  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND\n  917 root      20   0   82696   9152   5456 S  0.3  0.9   5:50.76 AliHids\n    1 root      20   0   41280   3732   2388 S  0.0  0.4   0:02.36 systemd\n    2 root      20   0       0      0      0 S  0.0  0.0   0:00.01 kthreadd\n    3 root      20   0       0      0      0 S  0.0  0.0   0:00.00 ksoftirqd/0\n    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H\n    6 root      20   0       0      0      0 S  0.0  0.0   0:00.26 kworker/u2:0\n    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0\n    ···\n```\n\n参数说明\n- 第一行：系统当前时间，系统持续时间， 登录用户，1,5,15分钟之前的平均负载\n- 第二行：进程总数\n- 第三行：CPU占用率\n- 第四行：内存使用：总共，空闲，已使用，缓存\n- 第五行：swap使用情况\n\n操作命令：\n- M,按内存占用排序\n- P,安CPU占用排序\n- q,退出\n\n\n### 终止进程\n\n#### kill 结束单个进程\n> kill命令是通过向进程发送指定的信号来结束相应进程的。在默认情况下，采用编号为15的TERM信号。TERM信号将终止所有不能捕获该信号的进程。对于那些可以捕获该信号的进程就要用编号为9的kill信号，强行“杀掉”该进程。\n>\n> 命令格式：kill 信号  PID\n\n信号，进程间的通信方式\n\n\n我们常用的信号有\n\n信号名称| 信号| 意义\n------|-----|-----\nHUP   | 1   | 终端断线\nINT   | 2   | 中断（同 Ctrl + C）\nQUIT  | 3   | 退出（同 Ctrl + \\）\nTERM  | 15  |  终止\nKILL  | 9   | 强制终止\nCONT  | 18  |  继续（与STOP相反， fg/bg命令）\nSTOP  | 19  |  暂停（同 Ctrl + Z）\n\n示例：结束 memcached 进程\n\n获取memcached进程pid（24428，即为memcached进程PID）\n```\nps -aux | grep memcache\nroot     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\nroot     24727  0.0  0.0 112664   984 pts/0    S+   15:54   0:00 grep --color=auto memcache\n#\nps -ef | grep memcache\nroot     24428     1  0 11:00 ?        00:00:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\nroot     24708 24568  0 15:49 pts/0    00:00:00 grep --color=auto memcache\n```\n或者使用pidof查看 （ pid + of ）\n```\n[root@...]# pidof memcached\n24428\n```\n终止 memcached\n```\nkill -9 24428\nps -aux | grep memcache\nroot     24729  0.0  0.0 112664   984 pts/0    S+   15:55   0:00 grep --color=auto memcache\n```\n\n#### killall   \n> 杀死指定名字的进程\n>\n> 命令格式：killall 信号  进程名\n\n示例：\n```\nkillall -9 memcached\n```\n\n#### pkill\n> 支持按照一定规则匹配来杀死进程\n>\n> 命令格式：pkill [options] <pattern>\n\n示例：杀死用户 wahaha 下的所有进程\n```\npkill -u wahaha\n```\n把某个终端登陆的用户踢出\n```\npkill -9 -t 终端号\n```\n把本地登陆终端1登陆用户踢出\n```\npkill -9 -t tty1                              \n```\n\n## 服务管理\n### Linux中服务的分类\n\n#### 系统默认安装的服务(RPM)\n- 独立的服务\n- 基于xinetd的服务，xinetd是系统超级守护进程\n> xinetd服务其本身就是一个独立的服务。\n>\n> 当程序调用xinetd服务时，它先调用的事xinetd服务，让后xinetd服务在调用索要调用的服务进行相应。\n>\n> Linux系统默认是没有安装xinetd服务的，需要进行安装后才能使用。\n\n#### 源码包安装的服务\n### 系统默认安装的服务\n#### 如何区分服务的分类\n查看服务的自启动状态\n```\nchkconfig  --list                      \n```\n运行结果：\n```\nchkconfig  --list\n注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务。SysV 配置数据可能被原生 systemd 配置覆盖。\n      如果您想列出 systemd 服务,请执行 'systemctl list-unit-files'。\n      欲查看对特定 target 启用的服务请执行\n      'systemctl list-dependencies [target]'。\naegis          \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关\nagentwatch     \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关\nnetconsole     \t0:关\t1:关\t2:关\t3:关\t4:关\t5:关\t6:关\nnetwork        \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关\n```\n\nLinux的运行级别：0-6\n\n级别| 说明\n---|-----\n0  |关机\n1  |单用户模式\n2  |不完全多用户，不包含NFS服务\n3  |完全多用户,字符界面\n4  |未分配\n5  |图形界面\n6  |重启\n\n查看当前系统的运行级别：\n```\nrunlevel\nN 3\n```\n切换系统当前的运行级别：\n\n命令 | 含义\n----|-----\ninit  0 |关机                   \ninit  5 |切换到图形界面（前提图形界面已经安装）\ninit  3 |切换到字符界面\ninit  6 |重启\n\n#### 独立的服务管理\n\n- 启动\n\n第一种方式：\n```\n/etc/rc.d/init.d/服务名 start| stop | restart | status\n# 例：\n/etc/rc.d/init.d/httpd start\n```\n第二种方式：（只支持RedHat系列的Linux）\n```\nservice 服务名 tart| stop | restart | status\n```\n***service命令其本质是当命令运行时直接在/etc/rc.d/init.d目录下查找相应的服务，并进行相应的操作。）***\n\n- 自启动\n-\n第一种方式：\n```\nchkconfig --level 2345 服务名 on|off\n```\n第二种方式：（推荐）\n```\nvi  /etc/rc.local (系统启动时会运行该文件)\n```\n修改文件内容：\n```\ntouch /var/lock/subsys/local （更新系统的开机时间）\n# 在下一行，写入自己要启动的服务名，比如我要开机自启动httpd服务：\n# 就加入/etc/rc.d/init.d/httpd start\n# 更改后文件就是：\ntouch /var/lock/subsys/local\n/etc/rc.d/init.d/httpd start\n```\n\n#### ntsysv自启动管理工具\n所有系统默认安装服务都可以使用ntsysv命令进行自启动管理。rpm包安装服务，自启动管理工具（只要rpm安装的，都可进行管理）\n\n### 源码包安装的服务\n启动\n```\n/usr/local/apache2/bin/apachectl  start\n```\n自启动\n```\nvi /etc/rc.local         \n加入\n/usr/local/apache2/bin/apachectl  start\n```\n\n\n## 计划任务\n> 首先保证crond服务时启动的（crond默认是自启动的）\n\n命令：crontab\n\n编辑格式： * * * * *  命令\n\n说明：\n- 第一个*：一小时中第几分钟  0-59\n- 第二个*：一天中第几个小时  0-23\n- 第三个*：一个月中第几天    1-31\n- 第四个*：一年第几个月      1-12\n- 第五个*：一周中星期几       0-6             \n\n例\n```\n10  *  31  *  *  命令\n10  *  *  *  *  命令\n5  4  *  5-10  *  命令\n*/10  *  *  *  *  命令\n5 4  1,15  *  *  命令  #日期和星期不要同时指定，会超出预期\n5 4 10 * 5 命令\n*/20 4 * 5 2   命令    #每隔二十分钟\n```\n\n查看系统定时任务\n```\ncrontab  -l\n```\n删除定时任务(慎用，删除之前记得备份数据)\n```\ncrontab  -r\n```\n\n**注意事项：**\n- 选项都不能为空，必须填入，不知道的值使用通配符*表示任何时间\n- 每个时间字段都可以指定多个值，不连续的值用,间隔，连续的值用-间隔\n- 间隔固定时间执行书写为*/n格式\n- 命令应该给出绝对路径\n- 星期几何第几天不能同时出现\n- 最小时间范围是分钟，最大时间范围是月\n\n\n## 查看系统启动信息\n查看系统启动信息\n```\ndmesg\n```\n系统启动信息日志\n```\ncat  /var/log/dmesg\n```\n查看eth0信息\n```\ndmesg | grep eth0                   \n```\n查看cpu信息\n```\ndmesg | grep CPU                   \n```\n","slug":"Linux服务和进程管理","published":1,"updated":"2016-09-29T03:17:46.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvg0014699fe92ra0mb","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160929/LinuxFuWuHeJinChengGuanLi.png?1\" alt=\"Linux服务和进程管理\"></p>\n<a id=\"more\"></a>\n<h2 id=\"进程管理\"><a href=\"#进程管理\" class=\"headerlink\" title=\"进程管理\"></a>进程管理</h2><p>进程管理的三个主要任务</p>\n<ul>\n<li>判断服务器的健康状态</li>\n<li>查看所有正在运行的进程</li>\n<li>强制终止进程</li>\n</ul>\n<h3 id=\"进程查看\"><a href=\"#进程查看\" class=\"headerlink\" title=\"进程查看\"></a>进程查看</h3><h4 id=\"ps-aux\"><a href=\"#ps-aux\" class=\"headerlink\" title=\"ps aux\"></a>ps aux</h4><blockquote>\n<p>查看当前系统所有运行的进程（可以不加-）</p>\n<ul>\n<li>-a 显示前台所有进程</li>\n<li>-u 显示用户名</li>\n<li>-x 显示后台进程</li>\n</ul>\n</blockquote>\n<p>命令执行结果示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux</div><div class=\"line\">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</div><div class=\"line\">root         1  0.0  0.3  41280  3732 ?        Ss   9月26   0:02 /usr/lib/systemd/systemd --switched-root --system</div><div class=\"line\">root         2  0.0  0.0      0     0 ?        S    9月26   0:00 [kthreadd]</div><div class=\"line\">root         3  0.0  0.0      0     0 ?        S    9月26   0:00 [ksoftirqd/0]</div><div class=\"line\">root         5  0.0  0.0      0     0 ?        S&lt;   9月26   0:00 [kworker/0:0H]</div><div class=\"line\">root         6  0.0  0.0      0     0 ?        S    9月26   0:00 [kworker/u2:0]</div><div class=\"line\">root         7  0.0  0.0      0     0 ?        S    9月26   0:00 [migration/0]</div><div class=\"line\">root         8  0.0  0.0      0     0 ?        S    9月26   0:00 [rcu_bh]</div><div class=\"line\">root         9  0.0  0.0      0     0 ?        S    9月26   0:00 [rcuob/0]</div><div class=\"line\">root        10  0.0  0.0      0     0 ?        S    9月26   0:36 [rcu_sched]</div><div class=\"line\">root        11  0.0  0.0      0     0 ?        S    9月26   0:32 [rcuos/0]</div><div class=\"line\">···</div></pre></td></tr></table></figure></p>\n<p>参数说明:</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>USER</td>\n<td>用户名</td>\n</tr>\n<tr>\n<td>PID</td>\n<td>进程PID 1  init  系统启动的第一个进程</td>\n</tr>\n<tr>\n<td>%CPU</td>\n<td>cpu占用百分比</td>\n</tr>\n<tr>\n<td>%MEM</td>\n<td>内存占用百分比</td>\n</tr>\n<tr>\n<td>VSZ</td>\n<td>虚拟内存占用量（KB）</td>\n</tr>\n<tr>\n<td>RSS</td>\n<td>固定内存占有量</td>\n</tr>\n<tr>\n<td>TTY</td>\n<td>登录终端  tty1-7 本地终端1-6 字符、 7图形） pts/0-255</td>\n</tr>\n<tr>\n<td>STAT</td>\n<td>状态 （S：睡眠 D：不可唤醒 R：运行 T：停止 Z：僵死 W：进入内存交换 X：死掉的进程 &lt;:高优先级 N：低优先级 L：被锁进内存 s：含子进程 +：位于后台 l：多线程）</td>\n</tr>\n<tr>\n<td>START</td>\n<td>进程触发时间</td>\n</tr>\n<tr>\n<td>TIME</td>\n<td>占用cpu时间</td>\n</tr>\n<tr>\n<td>COMMAND</td>\n<td>进程本身</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"pstree\"><a href=\"#pstree\" class=\"headerlink\" title=\"pstree\"></a>pstree</h4><blockquote>\n<ul>\n<li>-a 查看进程树</li>\n</ul>\n</blockquote>\n<p>命令执行结果示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\">pstree -a</div><div class=\"line\">systemd --switched-root --system --deserialize 21</div><div class=\"line\">  ├─AliHids</div><div class=\"line\">  │   └─4*[&#123;AliHids&#125;]</div><div class=\"line\">  ├─AliYunDun</div><div class=\"line\">  │   └─8*[&#123;AliYunDun&#125;]</div><div class=\"line\">  ├─AliYunDunUpdate</div><div class=\"line\">  │   └─3*[&#123;AliYunDunUpdate&#125;]</div><div class=\"line\">  ├─agetty --noclear tty1 linux</div><div class=\"line\">  ├─aliyun-service -d</div><div class=\"line\">  ├─crond -n</div><div class=\"line\">  ├─dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation</div><div class=\"line\">  ├─memcached -d -m 128 -u root -p 11211</div><div class=\"line\">  │   └─6*[&#123;memcached&#125;]</div><div class=\"line\">  ├─nginx</div><div class=\"line\">  │   └─nginx</div><div class=\"line\">  ├─ntpd -u ntp:ntp -g</div><div class=\"line\">  ├─php-fpm</div><div class=\"line\">  │   ├─php-fpm</div><div class=\"line\">  │   └─php-fpm</div><div class=\"line\">  ├─rsyslogd -n</div><div class=\"line\">  │   └─2*[&#123;rsyslogd&#125;]</div><div class=\"line\">  ├─sshd -D</div><div class=\"line\">  │   └─sshd</div><div class=\"line\">  │       └─bash</div><div class=\"line\">  │           └─pstree -a</div><div class=\"line\">  ├─systemd-journal</div><div class=\"line\">  ├─systemd-logind</div><div class=\"line\">  └─systemd-udevd</div></pre></td></tr></table></figure></p>\n<h4 id=\"top\"><a href=\"#top\" class=\"headerlink\" title=\"top\"></a>top</h4><blockquote>\n<p>实时显示进程状态</p>\n</blockquote>\n<p>命令执行结果示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">top - 15:04:52 up 2 days,  5:25,  1 user,  load average: 0.00, 0.01, 0.05</div><div class=\"line\">Tasks:  70 total,   2 running,  68 sleeping,   0 stopped,   0 zombie</div><div class=\"line\">%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</div><div class=\"line\">KiB Mem :  1016796 total,   599400 free,    41948 used,   375448 buff/cache</div><div class=\"line\">KiB Swap:        0 total,        0 free,        0 used.   838500 avail Mem</div><div class=\"line\"></div><div class=\"line\">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</div><div class=\"line\">  917 root      20   0   82696   9152   5456 S  0.3  0.9   5:50.76 AliHids</div><div class=\"line\">    1 root      20   0   41280   3732   2388 S  0.0  0.4   0:02.36 systemd</div><div class=\"line\">    2 root      20   0       0      0      0 S  0.0  0.0   0:00.01 kthreadd</div><div class=\"line\">    3 root      20   0       0      0      0 S  0.0  0.0   0:00.00 ksoftirqd/0</div><div class=\"line\">    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H</div><div class=\"line\">    6 root      20   0       0      0      0 S  0.0  0.0   0:00.26 kworker/u2:0</div><div class=\"line\">    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0</div><div class=\"line\">    ···</div></pre></td></tr></table></figure></p>\n<p>参数说明</p>\n<ul>\n<li>第一行：系统当前时间，系统持续时间， 登录用户，1,5,15分钟之前的平均负载</li>\n<li>第二行：进程总数</li>\n<li>第三行：CPU占用率</li>\n<li>第四行：内存使用：总共，空闲，已使用，缓存</li>\n<li>第五行：swap使用情况</li>\n</ul>\n<p>操作命令：</p>\n<ul>\n<li>M,按内存占用排序</li>\n<li>P,安CPU占用排序</li>\n<li>q,退出</li>\n</ul>\n<h3 id=\"终止进程\"><a href=\"#终止进程\" class=\"headerlink\" title=\"终止进程\"></a>终止进程</h3><h4 id=\"kill-结束单个进程\"><a href=\"#kill-结束单个进程\" class=\"headerlink\" title=\"kill 结束单个进程\"></a>kill 结束单个进程</h4><blockquote>\n<p>kill命令是通过向进程发送指定的信号来结束相应进程的。在默认情况下，采用编号为15的TERM信号。TERM信号将终止所有不能捕获该信号的进程。对于那些可以捕获该信号的进程就要用编号为9的kill信号，强行“杀掉”该进程。</p>\n<p>命令格式：kill 信号  PID</p>\n</blockquote>\n<p>信号，进程间的通信方式</p>\n<p>我们常用的信号有</p>\n<table>\n<thead>\n<tr>\n<th>信号名称</th>\n<th>信号</th>\n<th>意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>HUP</td>\n<td>1</td>\n<td>终端断线</td>\n</tr>\n<tr>\n<td>INT</td>\n<td>2</td>\n<td>中断（同 Ctrl + C）</td>\n</tr>\n<tr>\n<td>QUIT</td>\n<td>3</td>\n<td>退出（同 Ctrl + \\）</td>\n</tr>\n<tr>\n<td>TERM</td>\n<td>15</td>\n<td>终止</td>\n</tr>\n<tr>\n<td>KILL</td>\n<td>9</td>\n<td>强制终止</td>\n</tr>\n<tr>\n<td>CONT</td>\n<td>18</td>\n<td>继续（与STOP相反， fg/bg命令）</td>\n</tr>\n<tr>\n<td>STOP</td>\n<td>19</td>\n<td>暂停（同 Ctrl + Z）</td>\n</tr>\n</tbody>\n</table>\n<p>示例：结束 memcached 进程</p>\n<p>获取memcached进程pid（24428，即为memcached进程PID）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps -aux | grep memcache</div><div class=\"line\">root     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class=\"line\">root     24727  0.0  0.0 112664   984 pts/0    S+   15:54   0:00 grep --color=auto memcache</div><div class=\"line\">#</div><div class=\"line\">ps -ef | grep memcache</div><div class=\"line\">root     24428     1  0 11:00 ?        00:00:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class=\"line\">root     24708 24568  0 15:49 pts/0    00:00:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>\n<p>或者使用pidof查看 （ pid + of ）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@...]# pidof memcached</div><div class=\"line\">24428</div></pre></td></tr></table></figure></p>\n<p>终止 memcached<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -9 24428</div><div class=\"line\">ps -aux | grep memcache</div><div class=\"line\">root     24729  0.0  0.0 112664   984 pts/0    S+   15:55   0:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>\n<h4 id=\"killall\"><a href=\"#killall\" class=\"headerlink\" title=\"killall\"></a>killall</h4><blockquote>\n<p>杀死指定名字的进程</p>\n<p>命令格式：killall 信号  进程名</p>\n</blockquote>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">killall -9 memcached</div></pre></td></tr></table></figure></p>\n<h4 id=\"pkill\"><a href=\"#pkill\" class=\"headerlink\" title=\"pkill\"></a>pkill</h4><blockquote>\n<p>支持按照一定规则匹配来杀死进程</p>\n<p>命令格式：pkill [options] <pattern></pattern></p>\n</blockquote>\n<p>示例：杀死用户 wahaha 下的所有进程<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkill -u wahaha</div></pre></td></tr></table></figure></p>\n<p>把某个终端登陆的用户踢出<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkill -9 -t 终端号</div></pre></td></tr></table></figure></p>\n<p>把本地登陆终端1登陆用户踢出<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkill -9 -t tty1</div></pre></td></tr></table></figure></p>\n<h2 id=\"服务管理\"><a href=\"#服务管理\" class=\"headerlink\" title=\"服务管理\"></a>服务管理</h2><h3 id=\"Linux中服务的分类\"><a href=\"#Linux中服务的分类\" class=\"headerlink\" title=\"Linux中服务的分类\"></a>Linux中服务的分类</h3><h4 id=\"系统默认安装的服务-RPM\"><a href=\"#系统默认安装的服务-RPM\" class=\"headerlink\" title=\"系统默认安装的服务(RPM)\"></a>系统默认安装的服务(RPM)</h4><ul>\n<li>独立的服务</li>\n<li>基于xinetd的服务，xinetd是系统超级守护进程<blockquote>\n<p>xinetd服务其本身就是一个独立的服务。</p>\n<p>当程序调用xinetd服务时，它先调用的事xinetd服务，让后xinetd服务在调用索要调用的服务进行相应。</p>\n<p>Linux系统默认是没有安装xinetd服务的，需要进行安装后才能使用。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"源码包安装的服务\"><a href=\"#源码包安装的服务\" class=\"headerlink\" title=\"源码包安装的服务\"></a>源码包安装的服务</h4><h3 id=\"系统默认安装的服务\"><a href=\"#系统默认安装的服务\" class=\"headerlink\" title=\"系统默认安装的服务\"></a>系统默认安装的服务</h3><h4 id=\"如何区分服务的分类\"><a href=\"#如何区分服务的分类\" class=\"headerlink\" title=\"如何区分服务的分类\"></a>如何区分服务的分类</h4><p>查看服务的自启动状态<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">chkconfig  --list</div></pre></td></tr></table></figure></p>\n<p>运行结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">chkconfig  --list</div><div class=\"line\">注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务。SysV 配置数据可能被原生 systemd 配置覆盖。</div><div class=\"line\">      如果您想列出 systemd 服务,请执行 &apos;systemctl list-unit-files&apos;。</div><div class=\"line\">      欲查看对特定 target 启用的服务请执行</div><div class=\"line\">      &apos;systemctl list-dependencies [target]&apos;。</div><div class=\"line\">aegis          \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关</div><div class=\"line\">agentwatch     \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关</div><div class=\"line\">netconsole     \t0:关\t1:关\t2:关\t3:关\t4:关\t5:关\t6:关</div><div class=\"line\">network        \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关</div></pre></td></tr></table></figure></p>\n<p>Linux的运行级别：0-6</p>\n<table>\n<thead>\n<tr>\n<th>级别</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>关机</td>\n</tr>\n<tr>\n<td>1</td>\n<td>单用户模式</td>\n</tr>\n<tr>\n<td>2</td>\n<td>不完全多用户，不包含NFS服务</td>\n</tr>\n<tr>\n<td>3</td>\n<td>完全多用户,字符界面</td>\n</tr>\n<tr>\n<td>4</td>\n<td>未分配</td>\n</tr>\n<tr>\n<td>5</td>\n<td>图形界面</td>\n</tr>\n<tr>\n<td>6</td>\n<td>重启</td>\n</tr>\n</tbody>\n</table>\n<p>查看当前系统的运行级别：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">runlevel</div><div class=\"line\">N 3</div></pre></td></tr></table></figure></p>\n<p>切换系统当前的运行级别：</p>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>init  0</td>\n<td>关机                   </td>\n</tr>\n<tr>\n<td>init  5</td>\n<td>切换到图形界面（前提图形界面已经安装）</td>\n</tr>\n<tr>\n<td>init  3</td>\n<td>切换到字符界面</td>\n</tr>\n<tr>\n<td>init  6</td>\n<td>重启</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"独立的服务管理\"><a href=\"#独立的服务管理\" class=\"headerlink\" title=\"独立的服务管理\"></a>独立的服务管理</h4><ul>\n<li>启动</li>\n</ul>\n<p>第一种方式：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/rc.d/init.d/服务名 start| stop | restart | status</div><div class=\"line\"># 例：</div><div class=\"line\">/etc/rc.d/init.d/httpd start</div></pre></td></tr></table></figure></p>\n<p>第二种方式：（只支持RedHat系列的Linux）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">service 服务名 tart| stop | restart | status</div></pre></td></tr></table></figure></p>\n<p><strong><em>service命令其本质是当命令运行时直接在/etc/rc.d/init.d目录下查找相应的服务，并进行相应的操作。）</em></strong></p>\n<ul>\n<li>自启动<br>-<br>第一种方式：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">chkconfig --level 2345 服务名 on|off</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>第二种方式：（推荐）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi  /etc/rc.local (系统启动时会运行该文件)</div></pre></td></tr></table></figure></p>\n<p>修改文件内容：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">touch /var/lock/subsys/local （更新系统的开机时间）</div><div class=\"line\"># 在下一行，写入自己要启动的服务名，比如我要开机自启动httpd服务：</div><div class=\"line\"># 就加入/etc/rc.d/init.d/httpd start</div><div class=\"line\"># 更改后文件就是：</div><div class=\"line\">touch /var/lock/subsys/local</div><div class=\"line\">/etc/rc.d/init.d/httpd start</div></pre></td></tr></table></figure></p>\n<h4 id=\"ntsysv自启动管理工具\"><a href=\"#ntsysv自启动管理工具\" class=\"headerlink\" title=\"ntsysv自启动管理工具\"></a>ntsysv自启动管理工具</h4><p>所有系统默认安装服务都可以使用ntsysv命令进行自启动管理。rpm包安装服务，自启动管理工具（只要rpm安装的，都可进行管理）</p>\n<h3 id=\"源码包安装的服务-1\"><a href=\"#源码包安装的服务-1\" class=\"headerlink\" title=\"源码包安装的服务\"></a>源码包安装的服务</h3><p>启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/apache2/bin/apachectl  start</div></pre></td></tr></table></figure></p>\n<p>自启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/rc.local         </div><div class=\"line\">加入</div><div class=\"line\">/usr/local/apache2/bin/apachectl  start</div></pre></td></tr></table></figure></p>\n<h2 id=\"计划任务\"><a href=\"#计划任务\" class=\"headerlink\" title=\"计划任务\"></a>计划任务</h2><blockquote>\n<p>首先保证crond服务时启动的（crond默认是自启动的）</p>\n</blockquote>\n<p>命令：crontab</p>\n<p>编辑格式： <em> </em> <em> </em> *  命令</p>\n<p>说明：</p>\n<ul>\n<li>第一个*：一小时中第几分钟  0-59</li>\n<li>第二个*：一天中第几个小时  0-23</li>\n<li>第三个*：一个月中第几天    1-31</li>\n<li>第四个*：一年第几个月      1-12</li>\n<li>第五个*：一周中星期几       0-6             </li>\n</ul>\n<p>例<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">10  *  31  *  *  命令</div><div class=\"line\">10  *  *  *  *  命令</div><div class=\"line\">5  4  *  5-10  *  命令</div><div class=\"line\">*/10  *  *  *  *  命令</div><div class=\"line\">5 4  1,15  *  *  命令  #日期和星期不要同时指定，会超出预期</div><div class=\"line\">5 4 10 * 5 命令</div><div class=\"line\">*/20 4 * 5 2   命令    #每隔二十分钟</div></pre></td></tr></table></figure></p>\n<p>查看系统定时任务<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">crontab  -l</div></pre></td></tr></table></figure></p>\n<p>删除定时任务(慎用，删除之前记得备份数据)<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">crontab  -r</div></pre></td></tr></table></figure></p>\n<p><strong>注意事项：</strong></p>\n<ul>\n<li>选项都不能为空，必须填入，不知道的值使用通配符*表示任何时间</li>\n<li>每个时间字段都可以指定多个值，不连续的值用,间隔，连续的值用-间隔</li>\n<li>间隔固定时间执行书写为*/n格式</li>\n<li>命令应该给出绝对路径</li>\n<li>星期几何第几天不能同时出现</li>\n<li>最小时间范围是分钟，最大时间范围是月</li>\n</ul>\n<h2 id=\"查看系统启动信息\"><a href=\"#查看系统启动信息\" class=\"headerlink\" title=\"查看系统启动信息\"></a>查看系统启动信息</h2><p>查看系统启动信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dmesg</div></pre></td></tr></table></figure></p>\n<p>系统启动信息日志<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cat  /var/log/dmesg</div></pre></td></tr></table></figure></p>\n<p>查看eth0信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dmesg | grep eth0</div></pre></td></tr></table></figure></p>\n<p>查看cpu信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dmesg | grep CPU</div></pre></td></tr></table></figure></p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160929/LinuxFuWuHeJinChengGuanLi.png?1\" alt=\"Linux服务和进程管理\"></p>","more":"<h2 id=\"进程管理\"><a href=\"#进程管理\" class=\"headerlink\" title=\"进程管理\"></a>进程管理</h2><p>进程管理的三个主要任务</p>\n<ul>\n<li>判断服务器的健康状态</li>\n<li>查看所有正在运行的进程</li>\n<li>强制终止进程</li>\n</ul>\n<h3 id=\"进程查看\"><a href=\"#进程查看\" class=\"headerlink\" title=\"进程查看\"></a>进程查看</h3><h4 id=\"ps-aux\"><a href=\"#ps-aux\" class=\"headerlink\" title=\"ps aux\"></a>ps aux</h4><blockquote>\n<p>查看当前系统所有运行的进程（可以不加-）</p>\n<ul>\n<li>-a 显示前台所有进程</li>\n<li>-u 显示用户名</li>\n<li>-x 显示后台进程</li>\n</ul>\n</blockquote>\n<p>命令执行结果示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux</div><div class=\"line\">USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND</div><div class=\"line\">root         1  0.0  0.3  41280  3732 ?        Ss   9月26   0:02 /usr/lib/systemd/systemd --switched-root --system</div><div class=\"line\">root         2  0.0  0.0      0     0 ?        S    9月26   0:00 [kthreadd]</div><div class=\"line\">root         3  0.0  0.0      0     0 ?        S    9月26   0:00 [ksoftirqd/0]</div><div class=\"line\">root         5  0.0  0.0      0     0 ?        S&lt;   9月26   0:00 [kworker/0:0H]</div><div class=\"line\">root         6  0.0  0.0      0     0 ?        S    9月26   0:00 [kworker/u2:0]</div><div class=\"line\">root         7  0.0  0.0      0     0 ?        S    9月26   0:00 [migration/0]</div><div class=\"line\">root         8  0.0  0.0      0     0 ?        S    9月26   0:00 [rcu_bh]</div><div class=\"line\">root         9  0.0  0.0      0     0 ?        S    9月26   0:00 [rcuob/0]</div><div class=\"line\">root        10  0.0  0.0      0     0 ?        S    9月26   0:36 [rcu_sched]</div><div class=\"line\">root        11  0.0  0.0      0     0 ?        S    9月26   0:32 [rcuos/0]</div><div class=\"line\">···</div></pre></td></tr></table></figure></p>\n<p>参数说明:</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>USER</td>\n<td>用户名</td>\n</tr>\n<tr>\n<td>PID</td>\n<td>进程PID 1  init  系统启动的第一个进程</td>\n</tr>\n<tr>\n<td>%CPU</td>\n<td>cpu占用百分比</td>\n</tr>\n<tr>\n<td>%MEM</td>\n<td>内存占用百分比</td>\n</tr>\n<tr>\n<td>VSZ</td>\n<td>虚拟内存占用量（KB）</td>\n</tr>\n<tr>\n<td>RSS</td>\n<td>固定内存占有量</td>\n</tr>\n<tr>\n<td>TTY</td>\n<td>登录终端  tty1-7 本地终端1-6 字符、 7图形） pts/0-255</td>\n</tr>\n<tr>\n<td>STAT</td>\n<td>状态 （S：睡眠 D：不可唤醒 R：运行 T：停止 Z：僵死 W：进入内存交换 X：死掉的进程 &lt;:高优先级 N：低优先级 L：被锁进内存 s：含子进程 +：位于后台 l：多线程）</td>\n</tr>\n<tr>\n<td>START</td>\n<td>进程触发时间</td>\n</tr>\n<tr>\n<td>TIME</td>\n<td>占用cpu时间</td>\n</tr>\n<tr>\n<td>COMMAND</td>\n<td>进程本身</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"pstree\"><a href=\"#pstree\" class=\"headerlink\" title=\"pstree\"></a>pstree</h4><blockquote>\n<ul>\n<li>-a 查看进程树</li>\n</ul>\n</blockquote>\n<p>命令执行结果示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div></pre></td><td class=\"code\"><pre><div class=\"line\">pstree -a</div><div class=\"line\">systemd --switched-root --system --deserialize 21</div><div class=\"line\">  ├─AliHids</div><div class=\"line\">  │   └─4*[&#123;AliHids&#125;]</div><div class=\"line\">  ├─AliYunDun</div><div class=\"line\">  │   └─8*[&#123;AliYunDun&#125;]</div><div class=\"line\">  ├─AliYunDunUpdate</div><div class=\"line\">  │   └─3*[&#123;AliYunDunUpdate&#125;]</div><div class=\"line\">  ├─agetty --noclear tty1 linux</div><div class=\"line\">  ├─aliyun-service -d</div><div class=\"line\">  ├─crond -n</div><div class=\"line\">  ├─dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation</div><div class=\"line\">  ├─memcached -d -m 128 -u root -p 11211</div><div class=\"line\">  │   └─6*[&#123;memcached&#125;]</div><div class=\"line\">  ├─nginx</div><div class=\"line\">  │   └─nginx</div><div class=\"line\">  ├─ntpd -u ntp:ntp -g</div><div class=\"line\">  ├─php-fpm</div><div class=\"line\">  │   ├─php-fpm</div><div class=\"line\">  │   └─php-fpm</div><div class=\"line\">  ├─rsyslogd -n</div><div class=\"line\">  │   └─2*[&#123;rsyslogd&#125;]</div><div class=\"line\">  ├─sshd -D</div><div class=\"line\">  │   └─sshd</div><div class=\"line\">  │       └─bash</div><div class=\"line\">  │           └─pstree -a</div><div class=\"line\">  ├─systemd-journal</div><div class=\"line\">  ├─systemd-logind</div><div class=\"line\">  └─systemd-udevd</div></pre></td></tr></table></figure></p>\n<h4 id=\"top\"><a href=\"#top\" class=\"headerlink\" title=\"top\"></a>top</h4><blockquote>\n<p>实时显示进程状态</p>\n</blockquote>\n<p>命令执行结果示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">top - 15:04:52 up 2 days,  5:25,  1 user,  load average: 0.00, 0.01, 0.05</div><div class=\"line\">Tasks:  70 total,   2 running,  68 sleeping,   0 stopped,   0 zombie</div><div class=\"line\">%Cpu(s):  0.3 us,  0.3 sy,  0.0 ni, 99.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</div><div class=\"line\">KiB Mem :  1016796 total,   599400 free,    41948 used,   375448 buff/cache</div><div class=\"line\">KiB Swap:        0 total,        0 free,        0 used.   838500 avail Mem</div><div class=\"line\"></div><div class=\"line\">  PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</div><div class=\"line\">  917 root      20   0   82696   9152   5456 S  0.3  0.9   5:50.76 AliHids</div><div class=\"line\">    1 root      20   0   41280   3732   2388 S  0.0  0.4   0:02.36 systemd</div><div class=\"line\">    2 root      20   0       0      0      0 S  0.0  0.0   0:00.01 kthreadd</div><div class=\"line\">    3 root      20   0       0      0      0 S  0.0  0.0   0:00.00 ksoftirqd/0</div><div class=\"line\">    5 root       0 -20       0      0      0 S  0.0  0.0   0:00.00 kworker/0:0H</div><div class=\"line\">    6 root      20   0       0      0      0 S  0.0  0.0   0:00.26 kworker/u2:0</div><div class=\"line\">    7 root      rt   0       0      0      0 S  0.0  0.0   0:00.00 migration/0</div><div class=\"line\">    ···</div></pre></td></tr></table></figure></p>\n<p>参数说明</p>\n<ul>\n<li>第一行：系统当前时间，系统持续时间， 登录用户，1,5,15分钟之前的平均负载</li>\n<li>第二行：进程总数</li>\n<li>第三行：CPU占用率</li>\n<li>第四行：内存使用：总共，空闲，已使用，缓存</li>\n<li>第五行：swap使用情况</li>\n</ul>\n<p>操作命令：</p>\n<ul>\n<li>M,按内存占用排序</li>\n<li>P,安CPU占用排序</li>\n<li>q,退出</li>\n</ul>\n<h3 id=\"终止进程\"><a href=\"#终止进程\" class=\"headerlink\" title=\"终止进程\"></a>终止进程</h3><h4 id=\"kill-结束单个进程\"><a href=\"#kill-结束单个进程\" class=\"headerlink\" title=\"kill 结束单个进程\"></a>kill 结束单个进程</h4><blockquote>\n<p>kill命令是通过向进程发送指定的信号来结束相应进程的。在默认情况下，采用编号为15的TERM信号。TERM信号将终止所有不能捕获该信号的进程。对于那些可以捕获该信号的进程就要用编号为9的kill信号，强行“杀掉”该进程。</p>\n<p>命令格式：kill 信号  PID</p>\n</blockquote>\n<p>信号，进程间的通信方式</p>\n<p>我们常用的信号有</p>\n<table>\n<thead>\n<tr>\n<th>信号名称</th>\n<th>信号</th>\n<th>意义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>HUP</td>\n<td>1</td>\n<td>终端断线</td>\n</tr>\n<tr>\n<td>INT</td>\n<td>2</td>\n<td>中断（同 Ctrl + C）</td>\n</tr>\n<tr>\n<td>QUIT</td>\n<td>3</td>\n<td>退出（同 Ctrl + \\）</td>\n</tr>\n<tr>\n<td>TERM</td>\n<td>15</td>\n<td>终止</td>\n</tr>\n<tr>\n<td>KILL</td>\n<td>9</td>\n<td>强制终止</td>\n</tr>\n<tr>\n<td>CONT</td>\n<td>18</td>\n<td>继续（与STOP相反， fg/bg命令）</td>\n</tr>\n<tr>\n<td>STOP</td>\n<td>19</td>\n<td>暂停（同 Ctrl + Z）</td>\n</tr>\n</tbody>\n</table>\n<p>示例：结束 memcached 进程</p>\n<p>获取memcached进程pid（24428，即为memcached进程PID）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps -aux | grep memcache</div><div class=\"line\">root     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class=\"line\">root     24727  0.0  0.0 112664   984 pts/0    S+   15:54   0:00 grep --color=auto memcache</div><div class=\"line\">#</div><div class=\"line\">ps -ef | grep memcache</div><div class=\"line\">root     24428     1  0 11:00 ?        00:00:02 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class=\"line\">root     24708 24568  0 15:49 pts/0    00:00:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>\n<p>或者使用pidof查看 （ pid + of ）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@...]# pidof memcached</div><div class=\"line\">24428</div></pre></td></tr></table></figure></p>\n<p>终止 memcached<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -9 24428</div><div class=\"line\">ps -aux | grep memcache</div><div class=\"line\">root     24729  0.0  0.0 112664   984 pts/0    S+   15:55   0:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>\n<h4 id=\"killall\"><a href=\"#killall\" class=\"headerlink\" title=\"killall\"></a>killall</h4><blockquote>\n<p>杀死指定名字的进程</p>\n<p>命令格式：killall 信号  进程名</p>\n</blockquote>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">killall -9 memcached</div></pre></td></tr></table></figure></p>\n<h4 id=\"pkill\"><a href=\"#pkill\" class=\"headerlink\" title=\"pkill\"></a>pkill</h4><blockquote>\n<p>支持按照一定规则匹配来杀死进程</p>\n<p>命令格式：pkill [options] <pattern></p>\n</blockquote>\n<p>示例：杀死用户 wahaha 下的所有进程<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkill -u wahaha</div></pre></td></tr></table></figure></p>\n<p>把某个终端登陆的用户踢出<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkill -9 -t 终端号</div></pre></td></tr></table></figure></p>\n<p>把本地登陆终端1登陆用户踢出<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pkill -9 -t tty1</div></pre></td></tr></table></figure></p>\n<h2 id=\"服务管理\"><a href=\"#服务管理\" class=\"headerlink\" title=\"服务管理\"></a>服务管理</h2><h3 id=\"Linux中服务的分类\"><a href=\"#Linux中服务的分类\" class=\"headerlink\" title=\"Linux中服务的分类\"></a>Linux中服务的分类</h3><h4 id=\"系统默认安装的服务-RPM\"><a href=\"#系统默认安装的服务-RPM\" class=\"headerlink\" title=\"系统默认安装的服务(RPM)\"></a>系统默认安装的服务(RPM)</h4><ul>\n<li>独立的服务</li>\n<li>基于xinetd的服务，xinetd是系统超级守护进程<blockquote>\n<p>xinetd服务其本身就是一个独立的服务。</p>\n<p>当程序调用xinetd服务时，它先调用的事xinetd服务，让后xinetd服务在调用索要调用的服务进行相应。</p>\n<p>Linux系统默认是没有安装xinetd服务的，需要进行安装后才能使用。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"源码包安装的服务\"><a href=\"#源码包安装的服务\" class=\"headerlink\" title=\"源码包安装的服务\"></a>源码包安装的服务</h4><h3 id=\"系统默认安装的服务\"><a href=\"#系统默认安装的服务\" class=\"headerlink\" title=\"系统默认安装的服务\"></a>系统默认安装的服务</h3><h4 id=\"如何区分服务的分类\"><a href=\"#如何区分服务的分类\" class=\"headerlink\" title=\"如何区分服务的分类\"></a>如何区分服务的分类</h4><p>查看服务的自启动状态<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">chkconfig  --list</div></pre></td></tr></table></figure></p>\n<p>运行结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">chkconfig  --list</div><div class=\"line\">注意：该输出结果只显示 SysV 服务，并不包含原生 systemd 服务。SysV 配置数据可能被原生 systemd 配置覆盖。</div><div class=\"line\">      如果您想列出 systemd 服务,请执行 &apos;systemctl list-unit-files&apos;。</div><div class=\"line\">      欲查看对特定 target 启用的服务请执行</div><div class=\"line\">      &apos;systemctl list-dependencies [target]&apos;。</div><div class=\"line\">aegis          \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关</div><div class=\"line\">agentwatch     \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关</div><div class=\"line\">netconsole     \t0:关\t1:关\t2:关\t3:关\t4:关\t5:关\t6:关</div><div class=\"line\">network        \t0:关\t1:关\t2:开\t3:开\t4:开\t5:开\t6:关</div></pre></td></tr></table></figure></p>\n<p>Linux的运行级别：0-6</p>\n<table>\n<thead>\n<tr>\n<th>级别</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>0</td>\n<td>关机</td>\n</tr>\n<tr>\n<td>1</td>\n<td>单用户模式</td>\n</tr>\n<tr>\n<td>2</td>\n<td>不完全多用户，不包含NFS服务</td>\n</tr>\n<tr>\n<td>3</td>\n<td>完全多用户,字符界面</td>\n</tr>\n<tr>\n<td>4</td>\n<td>未分配</td>\n</tr>\n<tr>\n<td>5</td>\n<td>图形界面</td>\n</tr>\n<tr>\n<td>6</td>\n<td>重启</td>\n</tr>\n</tbody>\n</table>\n<p>查看当前系统的运行级别：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">runlevel</div><div class=\"line\">N 3</div></pre></td></tr></table></figure></p>\n<p>切换系统当前的运行级别：</p>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>含义</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>init  0</td>\n<td>关机                   </td>\n</tr>\n<tr>\n<td>init  5</td>\n<td>切换到图形界面（前提图形界面已经安装）</td>\n</tr>\n<tr>\n<td>init  3</td>\n<td>切换到字符界面</td>\n</tr>\n<tr>\n<td>init  6</td>\n<td>重启</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"独立的服务管理\"><a href=\"#独立的服务管理\" class=\"headerlink\" title=\"独立的服务管理\"></a>独立的服务管理</h4><ul>\n<li>启动</li>\n</ul>\n<p>第一种方式：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/rc.d/init.d/服务名 start| stop | restart | status</div><div class=\"line\"># 例：</div><div class=\"line\">/etc/rc.d/init.d/httpd start</div></pre></td></tr></table></figure></p>\n<p>第二种方式：（只支持RedHat系列的Linux）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">service 服务名 tart| stop | restart | status</div></pre></td></tr></table></figure></p>\n<p><strong><em>service命令其本质是当命令运行时直接在/etc/rc.d/init.d目录下查找相应的服务，并进行相应的操作。）</em></strong></p>\n<ul>\n<li>自启动<br>-<br>第一种方式：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">chkconfig --level 2345 服务名 on|off</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<p>第二种方式：（推荐）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi  /etc/rc.local (系统启动时会运行该文件)</div></pre></td></tr></table></figure></p>\n<p>修改文件内容：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">touch /var/lock/subsys/local （更新系统的开机时间）</div><div class=\"line\"># 在下一行，写入自己要启动的服务名，比如我要开机自启动httpd服务：</div><div class=\"line\"># 就加入/etc/rc.d/init.d/httpd start</div><div class=\"line\"># 更改后文件就是：</div><div class=\"line\">touch /var/lock/subsys/local</div><div class=\"line\">/etc/rc.d/init.d/httpd start</div></pre></td></tr></table></figure></p>\n<h4 id=\"ntsysv自启动管理工具\"><a href=\"#ntsysv自启动管理工具\" class=\"headerlink\" title=\"ntsysv自启动管理工具\"></a>ntsysv自启动管理工具</h4><p>所有系统默认安装服务都可以使用ntsysv命令进行自启动管理。rpm包安装服务，自启动管理工具（只要rpm安装的，都可进行管理）</p>\n<h3 id=\"源码包安装的服务-1\"><a href=\"#源码包安装的服务-1\" class=\"headerlink\" title=\"源码包安装的服务\"></a>源码包安装的服务</h3><p>启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/apache2/bin/apachectl  start</div></pre></td></tr></table></figure></p>\n<p>自启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /etc/rc.local         </div><div class=\"line\">加入</div><div class=\"line\">/usr/local/apache2/bin/apachectl  start</div></pre></td></tr></table></figure></p>\n<h2 id=\"计划任务\"><a href=\"#计划任务\" class=\"headerlink\" title=\"计划任务\"></a>计划任务</h2><blockquote>\n<p>首先保证crond服务时启动的（crond默认是自启动的）</p>\n</blockquote>\n<p>命令：crontab</p>\n<p>编辑格式： <em> </em> <em> </em> *  命令</p>\n<p>说明：</p>\n<ul>\n<li>第一个*：一小时中第几分钟  0-59</li>\n<li>第二个*：一天中第几个小时  0-23</li>\n<li>第三个*：一个月中第几天    1-31</li>\n<li>第四个*：一年第几个月      1-12</li>\n<li>第五个*：一周中星期几       0-6             </li>\n</ul>\n<p>例<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">10  *  31  *  *  命令</div><div class=\"line\">10  *  *  *  *  命令</div><div class=\"line\">5  4  *  5-10  *  命令</div><div class=\"line\">*/10  *  *  *  *  命令</div><div class=\"line\">5 4  1,15  *  *  命令  #日期和星期不要同时指定，会超出预期</div><div class=\"line\">5 4 10 * 5 命令</div><div class=\"line\">*/20 4 * 5 2   命令    #每隔二十分钟</div></pre></td></tr></table></figure></p>\n<p>查看系统定时任务<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">crontab  -l</div></pre></td></tr></table></figure></p>\n<p>删除定时任务(慎用，删除之前记得备份数据)<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">crontab  -r</div></pre></td></tr></table></figure></p>\n<p><strong>注意事项：</strong></p>\n<ul>\n<li>选项都不能为空，必须填入，不知道的值使用通配符*表示任何时间</li>\n<li>每个时间字段都可以指定多个值，不连续的值用,间隔，连续的值用-间隔</li>\n<li>间隔固定时间执行书写为*/n格式</li>\n<li>命令应该给出绝对路径</li>\n<li>星期几何第几天不能同时出现</li>\n<li>最小时间范围是分钟，最大时间范围是月</li>\n</ul>\n<h2 id=\"查看系统启动信息\"><a href=\"#查看系统启动信息\" class=\"headerlink\" title=\"查看系统启动信息\"></a>查看系统启动信息</h2><p>查看系统启动信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dmesg</div></pre></td></tr></table></figure></p>\n<p>系统启动信息日志<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cat  /var/log/dmesg</div></pre></td></tr></table></figure></p>\n<p>查看eth0信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dmesg | grep eth0</div></pre></td></tr></table></figure></p>\n<p>查看cpu信息<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dmesg | grep CPU</div></pre></td></tr></table></figure></p>"},{"title":"Linux目录结构介绍","date":"2016-10-06T14:30:00.000Z","_content":"\n![Linux目录结构](http://www.centoscn.com/uploads/allimg58981378314368.jpg)\n\n<!-- more -->\n\n## Linux常见目录\n\n```\n/\t\t根目录\n/bin\t\t命令保存目录（普通用户就可以读取的命令）\n/boot\t\t启动目录，启动相关文件\n/dev\t\t设备文件保存目录\n/etc\t\t配置文件保存目录\n/etc/rc.d\t\t主要在记录一些开关机过程中的 scripts 档案， scripts 有点像是 DOS 下的批次档（.bat檔名）\n/etc/rc.d/init.d\t所以服务预设的启动 scripts 都是放在这里的，例如要启动与关闭 iptables 的话，可以：\n/etc/rc.d/init.d/iptables start\n/etc/rc.d/init.d/iptables stop\n/etc/xinetd.d\t\t这个路径在较新的 Linux distribution 当中才有，由于早期的版本用来开启服务的档案是 inetd.conf ，但是在较新的版本中，开启服务的项目已经变成使用 xinetd.conf 这个档案，因此，你若需要启动一些额外的服务的话，在 Mandrake 9.0 或者是 Red Hat 7.0 以后就要到 /etc/xinetd.d 这个目录下了。\n/etc/X11\t这是与 X windows 有关的设定文件所在的目录，尤其里面的 XF86Config-4 更是重要呢！\n/etc/opt/\t\t/opt/的配置文件\n/etc/sgml/\t\tSGML的配置文件\n/etc/xml/\t\tXML的配置文件\n/home\t\t普通用户的家目录\n/lib\t\t系统库保存目录\n/mnt\t\t系统挂载目录（空目录）（一般建议将光盘、U盘等都关在在此目录下）\n/media\t\t挂载目录（空目录）\n/root\t\t超级用户的家目录\n/tmp\t\t临时目录\n/sbin\t\t命令保存目录（超级用户才能使用的目录）\n/proc\t\t直接写入内存的\n/proc/cpuinfo\t\t关于处理器的信息，如类型、厂家、型号和性能等\n/proc/devices\t\t当前运行内核所配置的所有设备清单\n/proc/dma\t\t当前正在使用的DMA通道。/proc/filesystems 当前运行内核所配置的文件系统\n/proc/interrupts\t\t正在使用的中断，和曾经有多少个中断\n/proc/ioports\t\t当前正在使用的I/O端口\n/sys\t\t同上\n/usr\t\t系统软件资源目录\n/usr/bin/\t\t系统命令（普通用户）\n/usr/sbin/\t\t系统命令（超级用户）\n/usr/locate/\t\t源码包安装的软件存放目录\n/usr/X11\t\t同/usr/X11R6 （/usr/X11R6的符号连接）\n/usr/X11R6\t\tX Window System存放相关档案的目录\n/usr/X11R6/bin\t\t大量的小X-WINDOWS应用程序（也可能是一些在其它子目录下大执行文件的符号连接）\n/usr/include\t\t一些套件的header檔。基本上，当我们在以 tarball 方式（ *.tar.gz 的方式安装软件）安装某些数据时，会使用到的一些函式库都在这个目录底下喔！\n/usr/lib\t\t内含许多程序与子程序所需的函式库。\n/usr/local\t\t在你安装完了 Linux 之后，基本上所有的配备你都有了，但是软件总是可以升级的，例如你要升级你的 proxy 服务，则通常软件预设的安装地方就是在 /usr/local 中（ local 是『当地』的意思），同时，安装完毕之后所得到的执行文件，为了与系统原先的执行文件有分别，因此升级后的执行档通常摆在 /usr/local/bin 这个地方。\n/usr/local/bin\t\t可能是用户安装的小的应用程序，和一些在/usr/local目录下大应用程序的符号连接\n/usr/share/doc\t\t放置一些系统说明文件的地方，例如你安装了 lilo 了，那么在该目录底下找一找，就可以查到 lilo 的说明文件了！很是便利！\n/usr/share/man\t\t放置一些程序的说明文件的地方，那是什么？呵呵！就是你使用 man 的时候，会去查询的路径呀！例如你使用 man ls 这个指令时，就会查出 /usr/share/man/man1/ls.1.bz2 这个说明档的内容啰！\n/usr/src\t\t这是放置核心原始码的预设目录，未来我们要编译核心的时候，就必须到这个目录底下呦！\n/var\t\t系统相关文档内容\n/var/log/\t系统日志位置\n/var/spool/mail/\t\t系统默认邮箱位置\n/var/lib/mysql/\t\t默认安装的mysql的库文件目录\n/ost+found /\t\t分区的复目录（当系统非正常关机时，可以进行恢复，每个分区都会有这样一个lost+found目录）系统不正常产生错误时，会将一些遗失的片段放置于此目录下，通常这个目录会自动出现在装置目录下。例如你加装一棵硬盘于 /disk 中，那在这个目录下就会自动产生一个这样的目录 /disk/lost+found\n```\n\n## /etc/目录\n特定主机系统范围内的配置文件：\n\n```\n/etc/rc /etc/rc.d\t\t启动、或改变运行级时运行的scripts或scripts的目录.\n/etc/rc*.d\n/etc/hosts\t\t\t本地域名解析文件\n/etc/sysconfig/network\tIP、掩码、网关、主机名配置\n/etc/resolv.conf\t\tDNS服务器配置\n/etc/fstab\t\t\t开机自动挂载系统，所有分区开机都会自动挂载\n/etc/inittab\t设定系统启动时Init进程将把系统设置成什么样的runlevel及加载相关的启动文件配置\n/etc/exports\t\t\t设置NFS系统用的配置文件路径\n/etc/init.d\t\t\t这个目录来存放系统启动脚本\n/etc/profile,\n/etc/csh.login,\n/etc/csh.cshrc\t\t全局系统环境配置变量\n/etc/issue\t\t\t认证前的输出信息，默认输出版本内核信息\n/etc/motd\t\t\t设置认证后的输出信息，\n/etc/mtab\t\t当前安装的文件系统列表.由scripts初始化，并由mount 命令自动更新.需要一个当前安装的文件系统的列表时使用，例如df 命令\n/etc/group\t\t\t类似/etc/passwd ，但说明的不是用户而是组.\n/etc/passwd\t\t用户数据库，其中的域给出了用户名、真实姓名、家目录、加密的口令和用户的其他信息.\n/etc/shadow\t\t在安装了影子口令软件的系统上的影子口令文件.影子口令文件将\n/etc/passwd \t\t文件中的加密口令移动到/etc/shadow 中，而后者只对root可读.这使破译口令更困难.\n/etc/sudoers\t\t\t可以sudo命令的配置文件\n/etc/syslog.conf\t\t系统日志参数配置\n/etc/login.defs\t\t设置用户帐号限制的文件\n/etc/securetty\t\t确认安全终端，即哪个终端允许root登录.一般只列出虚拟控制台，这样就不可能(至少很困难)通过modem或网络闯入系统并得到超级用户特权.\n/etc/printcap\t\t\t类似/etc/termcap ，但针对打印机.语法不同.\n/etc/shells\t\t列出可信任的shell.chsh 命令允许用户在本文件指定范围内改变登录shell.提供一台机器FTP服务的服务进程ftpd 检查用户shell是否列在 /etc/shells 文件中，如果不是将不允许该用户登录.\n/etc/xinetd.d\t\t如果服务器是通过xinetd模式运行的，它的脚本要放在这个目录下。有些系统没有这个目录，比如Slackware，有些老的版本也没有。在Redhat Fedora中比较新的版本中存在。\n/etc/opt/\t\t\t/opt/的配置文件\n/etc/X11/\t\t\tX_Window系统(版本11)的配置文件\n/etc/sgml/\t\t\tSGML的配置文件\n/etc/xml/\t\t\tXML的配置文件\n/etc/skel/\t\t\t默认创建用户时，把该目录拷贝到家目录下\n```\n\n## /usr/目录\n默认软件都会存于该目录下。用于存储只读用户数据的第二层次；包含绝大多数的用户工具和应用程序。\n## /var/目录\n/var 包括系统一般运行时要改变的数据.每个系统是特定的，即不通过网络与其他计算机共享.\n## /proc/目录\n虚拟文件系统，将内核与进程状态归档为文本文件（系统信息都存放这目录下）。\n\n例如：uptime、 network。在Linux中，对应Procfs格式挂载。该目录下文件只能看不能改（包括root）\n## /dev/目录\n设备文件分为两种：\n- 块设备文件(b)\n- 字符设备文件(c)\n","source":"_posts/Linux目录结构介绍.md","raw":"---\ntitle: Linux目录结构介绍\ndate: 2016-10-06 22:30:00\ncategories:\n- Linux\n---\n\n![Linux目录结构](http://www.centoscn.com/uploads/allimg58981378314368.jpg)\n\n<!-- more -->\n\n## Linux常见目录\n\n```\n/\t\t根目录\n/bin\t\t命令保存目录（普通用户就可以读取的命令）\n/boot\t\t启动目录，启动相关文件\n/dev\t\t设备文件保存目录\n/etc\t\t配置文件保存目录\n/etc/rc.d\t\t主要在记录一些开关机过程中的 scripts 档案， scripts 有点像是 DOS 下的批次档（.bat檔名）\n/etc/rc.d/init.d\t所以服务预设的启动 scripts 都是放在这里的，例如要启动与关闭 iptables 的话，可以：\n/etc/rc.d/init.d/iptables start\n/etc/rc.d/init.d/iptables stop\n/etc/xinetd.d\t\t这个路径在较新的 Linux distribution 当中才有，由于早期的版本用来开启服务的档案是 inetd.conf ，但是在较新的版本中，开启服务的项目已经变成使用 xinetd.conf 这个档案，因此，你若需要启动一些额外的服务的话，在 Mandrake 9.0 或者是 Red Hat 7.0 以后就要到 /etc/xinetd.d 这个目录下了。\n/etc/X11\t这是与 X windows 有关的设定文件所在的目录，尤其里面的 XF86Config-4 更是重要呢！\n/etc/opt/\t\t/opt/的配置文件\n/etc/sgml/\t\tSGML的配置文件\n/etc/xml/\t\tXML的配置文件\n/home\t\t普通用户的家目录\n/lib\t\t系统库保存目录\n/mnt\t\t系统挂载目录（空目录）（一般建议将光盘、U盘等都关在在此目录下）\n/media\t\t挂载目录（空目录）\n/root\t\t超级用户的家目录\n/tmp\t\t临时目录\n/sbin\t\t命令保存目录（超级用户才能使用的目录）\n/proc\t\t直接写入内存的\n/proc/cpuinfo\t\t关于处理器的信息，如类型、厂家、型号和性能等\n/proc/devices\t\t当前运行内核所配置的所有设备清单\n/proc/dma\t\t当前正在使用的DMA通道。/proc/filesystems 当前运行内核所配置的文件系统\n/proc/interrupts\t\t正在使用的中断，和曾经有多少个中断\n/proc/ioports\t\t当前正在使用的I/O端口\n/sys\t\t同上\n/usr\t\t系统软件资源目录\n/usr/bin/\t\t系统命令（普通用户）\n/usr/sbin/\t\t系统命令（超级用户）\n/usr/locate/\t\t源码包安装的软件存放目录\n/usr/X11\t\t同/usr/X11R6 （/usr/X11R6的符号连接）\n/usr/X11R6\t\tX Window System存放相关档案的目录\n/usr/X11R6/bin\t\t大量的小X-WINDOWS应用程序（也可能是一些在其它子目录下大执行文件的符号连接）\n/usr/include\t\t一些套件的header檔。基本上，当我们在以 tarball 方式（ *.tar.gz 的方式安装软件）安装某些数据时，会使用到的一些函式库都在这个目录底下喔！\n/usr/lib\t\t内含许多程序与子程序所需的函式库。\n/usr/local\t\t在你安装完了 Linux 之后，基本上所有的配备你都有了，但是软件总是可以升级的，例如你要升级你的 proxy 服务，则通常软件预设的安装地方就是在 /usr/local 中（ local 是『当地』的意思），同时，安装完毕之后所得到的执行文件，为了与系统原先的执行文件有分别，因此升级后的执行档通常摆在 /usr/local/bin 这个地方。\n/usr/local/bin\t\t可能是用户安装的小的应用程序，和一些在/usr/local目录下大应用程序的符号连接\n/usr/share/doc\t\t放置一些系统说明文件的地方，例如你安装了 lilo 了，那么在该目录底下找一找，就可以查到 lilo 的说明文件了！很是便利！\n/usr/share/man\t\t放置一些程序的说明文件的地方，那是什么？呵呵！就是你使用 man 的时候，会去查询的路径呀！例如你使用 man ls 这个指令时，就会查出 /usr/share/man/man1/ls.1.bz2 这个说明档的内容啰！\n/usr/src\t\t这是放置核心原始码的预设目录，未来我们要编译核心的时候，就必须到这个目录底下呦！\n/var\t\t系统相关文档内容\n/var/log/\t系统日志位置\n/var/spool/mail/\t\t系统默认邮箱位置\n/var/lib/mysql/\t\t默认安装的mysql的库文件目录\n/ost+found /\t\t分区的复目录（当系统非正常关机时，可以进行恢复，每个分区都会有这样一个lost+found目录）系统不正常产生错误时，会将一些遗失的片段放置于此目录下，通常这个目录会自动出现在装置目录下。例如你加装一棵硬盘于 /disk 中，那在这个目录下就会自动产生一个这样的目录 /disk/lost+found\n```\n\n## /etc/目录\n特定主机系统范围内的配置文件：\n\n```\n/etc/rc /etc/rc.d\t\t启动、或改变运行级时运行的scripts或scripts的目录.\n/etc/rc*.d\n/etc/hosts\t\t\t本地域名解析文件\n/etc/sysconfig/network\tIP、掩码、网关、主机名配置\n/etc/resolv.conf\t\tDNS服务器配置\n/etc/fstab\t\t\t开机自动挂载系统，所有分区开机都会自动挂载\n/etc/inittab\t设定系统启动时Init进程将把系统设置成什么样的runlevel及加载相关的启动文件配置\n/etc/exports\t\t\t设置NFS系统用的配置文件路径\n/etc/init.d\t\t\t这个目录来存放系统启动脚本\n/etc/profile,\n/etc/csh.login,\n/etc/csh.cshrc\t\t全局系统环境配置变量\n/etc/issue\t\t\t认证前的输出信息，默认输出版本内核信息\n/etc/motd\t\t\t设置认证后的输出信息，\n/etc/mtab\t\t当前安装的文件系统列表.由scripts初始化，并由mount 命令自动更新.需要一个当前安装的文件系统的列表时使用，例如df 命令\n/etc/group\t\t\t类似/etc/passwd ，但说明的不是用户而是组.\n/etc/passwd\t\t用户数据库，其中的域给出了用户名、真实姓名、家目录、加密的口令和用户的其他信息.\n/etc/shadow\t\t在安装了影子口令软件的系统上的影子口令文件.影子口令文件将\n/etc/passwd \t\t文件中的加密口令移动到/etc/shadow 中，而后者只对root可读.这使破译口令更困难.\n/etc/sudoers\t\t\t可以sudo命令的配置文件\n/etc/syslog.conf\t\t系统日志参数配置\n/etc/login.defs\t\t设置用户帐号限制的文件\n/etc/securetty\t\t确认安全终端，即哪个终端允许root登录.一般只列出虚拟控制台，这样就不可能(至少很困难)通过modem或网络闯入系统并得到超级用户特权.\n/etc/printcap\t\t\t类似/etc/termcap ，但针对打印机.语法不同.\n/etc/shells\t\t列出可信任的shell.chsh 命令允许用户在本文件指定范围内改变登录shell.提供一台机器FTP服务的服务进程ftpd 检查用户shell是否列在 /etc/shells 文件中，如果不是将不允许该用户登录.\n/etc/xinetd.d\t\t如果服务器是通过xinetd模式运行的，它的脚本要放在这个目录下。有些系统没有这个目录，比如Slackware，有些老的版本也没有。在Redhat Fedora中比较新的版本中存在。\n/etc/opt/\t\t\t/opt/的配置文件\n/etc/X11/\t\t\tX_Window系统(版本11)的配置文件\n/etc/sgml/\t\t\tSGML的配置文件\n/etc/xml/\t\t\tXML的配置文件\n/etc/skel/\t\t\t默认创建用户时，把该目录拷贝到家目录下\n```\n\n## /usr/目录\n默认软件都会存于该目录下。用于存储只读用户数据的第二层次；包含绝大多数的用户工具和应用程序。\n## /var/目录\n/var 包括系统一般运行时要改变的数据.每个系统是特定的，即不通过网络与其他计算机共享.\n## /proc/目录\n虚拟文件系统，将内核与进程状态归档为文本文件（系统信息都存放这目录下）。\n\n例如：uptime、 network。在Linux中，对应Procfs格式挂载。该目录下文件只能看不能改（包括root）\n## /dev/目录\n设备文件分为两种：\n- 块设备文件(b)\n- 字符设备文件(c)\n","slug":"Linux目录结构介绍","published":1,"updated":"2016-10-07T14:50:52.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvh0016699f6rtelue3","content":"<p><img src=\"http://www.centoscn.com/uploads/allimg58981378314368.jpg\" alt=\"Linux目录结构\"></p>\n<a id=\"more\"></a>\n<h2 id=\"Linux常见目录\"><a href=\"#Linux常见目录\" class=\"headerlink\" title=\"Linux常见目录\"></a>Linux常见目录</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\">/\t\t根目录</div><div class=\"line\">/bin\t\t命令保存目录（普通用户就可以读取的命令）</div><div class=\"line\">/boot\t\t启动目录，启动相关文件</div><div class=\"line\">/dev\t\t设备文件保存目录</div><div class=\"line\">/etc\t\t配置文件保存目录</div><div class=\"line\">/etc/rc.d\t\t主要在记录一些开关机过程中的 scripts 档案， scripts 有点像是 DOS 下的批次档（.bat檔名）</div><div class=\"line\">/etc/rc.d/init.d\t所以服务预设的启动 scripts 都是放在这里的，例如要启动与关闭 iptables 的话，可以：</div><div class=\"line\">/etc/rc.d/init.d/iptables start</div><div class=\"line\">/etc/rc.d/init.d/iptables stop</div><div class=\"line\">/etc/xinetd.d\t\t这个路径在较新的 Linux distribution 当中才有，由于早期的版本用来开启服务的档案是 inetd.conf ，但是在较新的版本中，开启服务的项目已经变成使用 xinetd.conf 这个档案，因此，你若需要启动一些额外的服务的话，在 Mandrake 9.0 或者是 Red Hat 7.0 以后就要到 /etc/xinetd.d 这个目录下了。</div><div class=\"line\">/etc/X11\t这是与 X windows 有关的设定文件所在的目录，尤其里面的 XF86Config-4 更是重要呢！</div><div class=\"line\">/etc/opt/\t\t/opt/的配置文件</div><div class=\"line\">/etc/sgml/\t\tSGML的配置文件</div><div class=\"line\">/etc/xml/\t\tXML的配置文件</div><div class=\"line\">/home\t\t普通用户的家目录</div><div class=\"line\">/lib\t\t系统库保存目录</div><div class=\"line\">/mnt\t\t系统挂载目录（空目录）（一般建议将光盘、U盘等都关在在此目录下）</div><div class=\"line\">/media\t\t挂载目录（空目录）</div><div class=\"line\">/root\t\t超级用户的家目录</div><div class=\"line\">/tmp\t\t临时目录</div><div class=\"line\">/sbin\t\t命令保存目录（超级用户才能使用的目录）</div><div class=\"line\">/proc\t\t直接写入内存的</div><div class=\"line\">/proc/cpuinfo\t\t关于处理器的信息，如类型、厂家、型号和性能等</div><div class=\"line\">/proc/devices\t\t当前运行内核所配置的所有设备清单</div><div class=\"line\">/proc/dma\t\t当前正在使用的DMA通道。/proc/filesystems 当前运行内核所配置的文件系统</div><div class=\"line\">/proc/interrupts\t\t正在使用的中断，和曾经有多少个中断</div><div class=\"line\">/proc/ioports\t\t当前正在使用的I/O端口</div><div class=\"line\">/sys\t\t同上</div><div class=\"line\">/usr\t\t系统软件资源目录</div><div class=\"line\">/usr/bin/\t\t系统命令（普通用户）</div><div class=\"line\">/usr/sbin/\t\t系统命令（超级用户）</div><div class=\"line\">/usr/locate/\t\t源码包安装的软件存放目录</div><div class=\"line\">/usr/X11\t\t同/usr/X11R6 （/usr/X11R6的符号连接）</div><div class=\"line\">/usr/X11R6\t\tX Window System存放相关档案的目录</div><div class=\"line\">/usr/X11R6/bin\t\t大量的小X-WINDOWS应用程序（也可能是一些在其它子目录下大执行文件的符号连接）</div><div class=\"line\">/usr/include\t\t一些套件的header檔。基本上，当我们在以 tarball 方式（ *.tar.gz 的方式安装软件）安装某些数据时，会使用到的一些函式库都在这个目录底下喔！</div><div class=\"line\">/usr/lib\t\t内含许多程序与子程序所需的函式库。</div><div class=\"line\">/usr/local\t\t在你安装完了 Linux 之后，基本上所有的配备你都有了，但是软件总是可以升级的，例如你要升级你的 proxy 服务，则通常软件预设的安装地方就是在 /usr/local 中（ local 是『当地』的意思），同时，安装完毕之后所得到的执行文件，为了与系统原先的执行文件有分别，因此升级后的执行档通常摆在 /usr/local/bin 这个地方。</div><div class=\"line\">/usr/local/bin\t\t可能是用户安装的小的应用程序，和一些在/usr/local目录下大应用程序的符号连接</div><div class=\"line\">/usr/share/doc\t\t放置一些系统说明文件的地方，例如你安装了 lilo 了，那么在该目录底下找一找，就可以查到 lilo 的说明文件了！很是便利！</div><div class=\"line\">/usr/share/man\t\t放置一些程序的说明文件的地方，那是什么？呵呵！就是你使用 man 的时候，会去查询的路径呀！例如你使用 man ls 这个指令时，就会查出 /usr/share/man/man1/ls.1.bz2 这个说明档的内容啰！</div><div class=\"line\">/usr/src\t\t这是放置核心原始码的预设目录，未来我们要编译核心的时候，就必须到这个目录底下呦！</div><div class=\"line\">/var\t\t系统相关文档内容</div><div class=\"line\">/var/log/\t系统日志位置</div><div class=\"line\">/var/spool/mail/\t\t系统默认邮箱位置</div><div class=\"line\">/var/lib/mysql/\t\t默认安装的mysql的库文件目录</div><div class=\"line\">/ost+found /\t\t分区的复目录（当系统非正常关机时，可以进行恢复，每个分区都会有这样一个lost+found目录）系统不正常产生错误时，会将一些遗失的片段放置于此目录下，通常这个目录会自动出现在装置目录下。例如你加装一棵硬盘于 /disk 中，那在这个目录下就会自动产生一个这样的目录 /disk/lost+found</div></pre></td></tr></table></figure>\n<h2 id=\"etc-目录\"><a href=\"#etc-目录\" class=\"headerlink\" title=\"/etc/目录\"></a>/etc/目录</h2><p>特定主机系统范围内的配置文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/rc /etc/rc.d\t\t启动、或改变运行级时运行的scripts或scripts的目录.</div><div class=\"line\">/etc/rc*.d</div><div class=\"line\">/etc/hosts\t\t\t本地域名解析文件</div><div class=\"line\">/etc/sysconfig/network\tIP、掩码、网关、主机名配置</div><div class=\"line\">/etc/resolv.conf\t\tDNS服务器配置</div><div class=\"line\">/etc/fstab\t\t\t开机自动挂载系统，所有分区开机都会自动挂载</div><div class=\"line\">/etc/inittab\t设定系统启动时Init进程将把系统设置成什么样的runlevel及加载相关的启动文件配置</div><div class=\"line\">/etc/exports\t\t\t设置NFS系统用的配置文件路径</div><div class=\"line\">/etc/init.d\t\t\t这个目录来存放系统启动脚本</div><div class=\"line\">/etc/profile,</div><div class=\"line\">/etc/csh.login,</div><div class=\"line\">/etc/csh.cshrc\t\t全局系统环境配置变量</div><div class=\"line\">/etc/issue\t\t\t认证前的输出信息，默认输出版本内核信息</div><div class=\"line\">/etc/motd\t\t\t设置认证后的输出信息，</div><div class=\"line\">/etc/mtab\t\t当前安装的文件系统列表.由scripts初始化，并由mount 命令自动更新.需要一个当前安装的文件系统的列表时使用，例如df 命令</div><div class=\"line\">/etc/group\t\t\t类似/etc/passwd ，但说明的不是用户而是组.</div><div class=\"line\">/etc/passwd\t\t用户数据库，其中的域给出了用户名、真实姓名、家目录、加密的口令和用户的其他信息.</div><div class=\"line\">/etc/shadow\t\t在安装了影子口令软件的系统上的影子口令文件.影子口令文件将</div><div class=\"line\">/etc/passwd \t\t文件中的加密口令移动到/etc/shadow 中，而后者只对root可读.这使破译口令更困难.</div><div class=\"line\">/etc/sudoers\t\t\t可以sudo命令的配置文件</div><div class=\"line\">/etc/syslog.conf\t\t系统日志参数配置</div><div class=\"line\">/etc/login.defs\t\t设置用户帐号限制的文件</div><div class=\"line\">/etc/securetty\t\t确认安全终端，即哪个终端允许root登录.一般只列出虚拟控制台，这样就不可能(至少很困难)通过modem或网络闯入系统并得到超级用户特权.</div><div class=\"line\">/etc/printcap\t\t\t类似/etc/termcap ，但针对打印机.语法不同.</div><div class=\"line\">/etc/shells\t\t列出可信任的shell.chsh 命令允许用户在本文件指定范围内改变登录shell.提供一台机器FTP服务的服务进程ftpd 检查用户shell是否列在 /etc/shells 文件中，如果不是将不允许该用户登录.</div><div class=\"line\">/etc/xinetd.d\t\t如果服务器是通过xinetd模式运行的，它的脚本要放在这个目录下。有些系统没有这个目录，比如Slackware，有些老的版本也没有。在Redhat Fedora中比较新的版本中存在。</div><div class=\"line\">/etc/opt/\t\t\t/opt/的配置文件</div><div class=\"line\">/etc/X11/\t\t\tX_Window系统(版本11)的配置文件</div><div class=\"line\">/etc/sgml/\t\t\tSGML的配置文件</div><div class=\"line\">/etc/xml/\t\t\tXML的配置文件</div><div class=\"line\">/etc/skel/\t\t\t默认创建用户时，把该目录拷贝到家目录下</div></pre></td></tr></table></figure>\n<h2 id=\"usr-目录\"><a href=\"#usr-目录\" class=\"headerlink\" title=\"/usr/目录\"></a>/usr/目录</h2><p>默认软件都会存于该目录下。用于存储只读用户数据的第二层次；包含绝大多数的用户工具和应用程序。</p>\n<h2 id=\"var-目录\"><a href=\"#var-目录\" class=\"headerlink\" title=\"/var/目录\"></a>/var/目录</h2><p>/var 包括系统一般运行时要改变的数据.每个系统是特定的，即不通过网络与其他计算机共享.</p>\n<h2 id=\"proc-目录\"><a href=\"#proc-目录\" class=\"headerlink\" title=\"/proc/目录\"></a>/proc/目录</h2><p>虚拟文件系统，将内核与进程状态归档为文本文件（系统信息都存放这目录下）。</p>\n<p>例如：uptime、 network。在Linux中，对应Procfs格式挂载。该目录下文件只能看不能改（包括root）</p>\n<h2 id=\"dev-目录\"><a href=\"#dev-目录\" class=\"headerlink\" title=\"/dev/目录\"></a>/dev/目录</h2><p>设备文件分为两种：</p>\n<ul>\n<li>块设备文件(b)</li>\n<li>字符设备文件(c)</li>\n</ul>\n","excerpt":"<p><img src=\"http://www.centoscn.com/uploads/allimg58981378314368.jpg\" alt=\"Linux目录结构\"></p>","more":"<h2 id=\"Linux常见目录\"><a href=\"#Linux常见目录\" class=\"headerlink\" title=\"Linux常见目录\"></a>Linux常见目录</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div></pre></td><td class=\"code\"><pre><div class=\"line\">/\t\t根目录</div><div class=\"line\">/bin\t\t命令保存目录（普通用户就可以读取的命令）</div><div class=\"line\">/boot\t\t启动目录，启动相关文件</div><div class=\"line\">/dev\t\t设备文件保存目录</div><div class=\"line\">/etc\t\t配置文件保存目录</div><div class=\"line\">/etc/rc.d\t\t主要在记录一些开关机过程中的 scripts 档案， scripts 有点像是 DOS 下的批次档（.bat檔名）</div><div class=\"line\">/etc/rc.d/init.d\t所以服务预设的启动 scripts 都是放在这里的，例如要启动与关闭 iptables 的话，可以：</div><div class=\"line\">/etc/rc.d/init.d/iptables start</div><div class=\"line\">/etc/rc.d/init.d/iptables stop</div><div class=\"line\">/etc/xinetd.d\t\t这个路径在较新的 Linux distribution 当中才有，由于早期的版本用来开启服务的档案是 inetd.conf ，但是在较新的版本中，开启服务的项目已经变成使用 xinetd.conf 这个档案，因此，你若需要启动一些额外的服务的话，在 Mandrake 9.0 或者是 Red Hat 7.0 以后就要到 /etc/xinetd.d 这个目录下了。</div><div class=\"line\">/etc/X11\t这是与 X windows 有关的设定文件所在的目录，尤其里面的 XF86Config-4 更是重要呢！</div><div class=\"line\">/etc/opt/\t\t/opt/的配置文件</div><div class=\"line\">/etc/sgml/\t\tSGML的配置文件</div><div class=\"line\">/etc/xml/\t\tXML的配置文件</div><div class=\"line\">/home\t\t普通用户的家目录</div><div class=\"line\">/lib\t\t系统库保存目录</div><div class=\"line\">/mnt\t\t系统挂载目录（空目录）（一般建议将光盘、U盘等都关在在此目录下）</div><div class=\"line\">/media\t\t挂载目录（空目录）</div><div class=\"line\">/root\t\t超级用户的家目录</div><div class=\"line\">/tmp\t\t临时目录</div><div class=\"line\">/sbin\t\t命令保存目录（超级用户才能使用的目录）</div><div class=\"line\">/proc\t\t直接写入内存的</div><div class=\"line\">/proc/cpuinfo\t\t关于处理器的信息，如类型、厂家、型号和性能等</div><div class=\"line\">/proc/devices\t\t当前运行内核所配置的所有设备清单</div><div class=\"line\">/proc/dma\t\t当前正在使用的DMA通道。/proc/filesystems 当前运行内核所配置的文件系统</div><div class=\"line\">/proc/interrupts\t\t正在使用的中断，和曾经有多少个中断</div><div class=\"line\">/proc/ioports\t\t当前正在使用的I/O端口</div><div class=\"line\">/sys\t\t同上</div><div class=\"line\">/usr\t\t系统软件资源目录</div><div class=\"line\">/usr/bin/\t\t系统命令（普通用户）</div><div class=\"line\">/usr/sbin/\t\t系统命令（超级用户）</div><div class=\"line\">/usr/locate/\t\t源码包安装的软件存放目录</div><div class=\"line\">/usr/X11\t\t同/usr/X11R6 （/usr/X11R6的符号连接）</div><div class=\"line\">/usr/X11R6\t\tX Window System存放相关档案的目录</div><div class=\"line\">/usr/X11R6/bin\t\t大量的小X-WINDOWS应用程序（也可能是一些在其它子目录下大执行文件的符号连接）</div><div class=\"line\">/usr/include\t\t一些套件的header檔。基本上，当我们在以 tarball 方式（ *.tar.gz 的方式安装软件）安装某些数据时，会使用到的一些函式库都在这个目录底下喔！</div><div class=\"line\">/usr/lib\t\t内含许多程序与子程序所需的函式库。</div><div class=\"line\">/usr/local\t\t在你安装完了 Linux 之后，基本上所有的配备你都有了，但是软件总是可以升级的，例如你要升级你的 proxy 服务，则通常软件预设的安装地方就是在 /usr/local 中（ local 是『当地』的意思），同时，安装完毕之后所得到的执行文件，为了与系统原先的执行文件有分别，因此升级后的执行档通常摆在 /usr/local/bin 这个地方。</div><div class=\"line\">/usr/local/bin\t\t可能是用户安装的小的应用程序，和一些在/usr/local目录下大应用程序的符号连接</div><div class=\"line\">/usr/share/doc\t\t放置一些系统说明文件的地方，例如你安装了 lilo 了，那么在该目录底下找一找，就可以查到 lilo 的说明文件了！很是便利！</div><div class=\"line\">/usr/share/man\t\t放置一些程序的说明文件的地方，那是什么？呵呵！就是你使用 man 的时候，会去查询的路径呀！例如你使用 man ls 这个指令时，就会查出 /usr/share/man/man1/ls.1.bz2 这个说明档的内容啰！</div><div class=\"line\">/usr/src\t\t这是放置核心原始码的预设目录，未来我们要编译核心的时候，就必须到这个目录底下呦！</div><div class=\"line\">/var\t\t系统相关文档内容</div><div class=\"line\">/var/log/\t系统日志位置</div><div class=\"line\">/var/spool/mail/\t\t系统默认邮箱位置</div><div class=\"line\">/var/lib/mysql/\t\t默认安装的mysql的库文件目录</div><div class=\"line\">/ost+found /\t\t分区的复目录（当系统非正常关机时，可以进行恢复，每个分区都会有这样一个lost+found目录）系统不正常产生错误时，会将一些遗失的片段放置于此目录下，通常这个目录会自动出现在装置目录下。例如你加装一棵硬盘于 /disk 中，那在这个目录下就会自动产生一个这样的目录 /disk/lost+found</div></pre></td></tr></table></figure>\n<h2 id=\"etc-目录\"><a href=\"#etc-目录\" class=\"headerlink\" title=\"/etc/目录\"></a>/etc/目录</h2><p>特定主机系统范围内的配置文件：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/rc /etc/rc.d\t\t启动、或改变运行级时运行的scripts或scripts的目录.</div><div class=\"line\">/etc/rc*.d</div><div class=\"line\">/etc/hosts\t\t\t本地域名解析文件</div><div class=\"line\">/etc/sysconfig/network\tIP、掩码、网关、主机名配置</div><div class=\"line\">/etc/resolv.conf\t\tDNS服务器配置</div><div class=\"line\">/etc/fstab\t\t\t开机自动挂载系统，所有分区开机都会自动挂载</div><div class=\"line\">/etc/inittab\t设定系统启动时Init进程将把系统设置成什么样的runlevel及加载相关的启动文件配置</div><div class=\"line\">/etc/exports\t\t\t设置NFS系统用的配置文件路径</div><div class=\"line\">/etc/init.d\t\t\t这个目录来存放系统启动脚本</div><div class=\"line\">/etc/profile,</div><div class=\"line\">/etc/csh.login,</div><div class=\"line\">/etc/csh.cshrc\t\t全局系统环境配置变量</div><div class=\"line\">/etc/issue\t\t\t认证前的输出信息，默认输出版本内核信息</div><div class=\"line\">/etc/motd\t\t\t设置认证后的输出信息，</div><div class=\"line\">/etc/mtab\t\t当前安装的文件系统列表.由scripts初始化，并由mount 命令自动更新.需要一个当前安装的文件系统的列表时使用，例如df 命令</div><div class=\"line\">/etc/group\t\t\t类似/etc/passwd ，但说明的不是用户而是组.</div><div class=\"line\">/etc/passwd\t\t用户数据库，其中的域给出了用户名、真实姓名、家目录、加密的口令和用户的其他信息.</div><div class=\"line\">/etc/shadow\t\t在安装了影子口令软件的系统上的影子口令文件.影子口令文件将</div><div class=\"line\">/etc/passwd \t\t文件中的加密口令移动到/etc/shadow 中，而后者只对root可读.这使破译口令更困难.</div><div class=\"line\">/etc/sudoers\t\t\t可以sudo命令的配置文件</div><div class=\"line\">/etc/syslog.conf\t\t系统日志参数配置</div><div class=\"line\">/etc/login.defs\t\t设置用户帐号限制的文件</div><div class=\"line\">/etc/securetty\t\t确认安全终端，即哪个终端允许root登录.一般只列出虚拟控制台，这样就不可能(至少很困难)通过modem或网络闯入系统并得到超级用户特权.</div><div class=\"line\">/etc/printcap\t\t\t类似/etc/termcap ，但针对打印机.语法不同.</div><div class=\"line\">/etc/shells\t\t列出可信任的shell.chsh 命令允许用户在本文件指定范围内改变登录shell.提供一台机器FTP服务的服务进程ftpd 检查用户shell是否列在 /etc/shells 文件中，如果不是将不允许该用户登录.</div><div class=\"line\">/etc/xinetd.d\t\t如果服务器是通过xinetd模式运行的，它的脚本要放在这个目录下。有些系统没有这个目录，比如Slackware，有些老的版本也没有。在Redhat Fedora中比较新的版本中存在。</div><div class=\"line\">/etc/opt/\t\t\t/opt/的配置文件</div><div class=\"line\">/etc/X11/\t\t\tX_Window系统(版本11)的配置文件</div><div class=\"line\">/etc/sgml/\t\t\tSGML的配置文件</div><div class=\"line\">/etc/xml/\t\t\tXML的配置文件</div><div class=\"line\">/etc/skel/\t\t\t默认创建用户时，把该目录拷贝到家目录下</div></pre></td></tr></table></figure>\n<h2 id=\"usr-目录\"><a href=\"#usr-目录\" class=\"headerlink\" title=\"/usr/目录\"></a>/usr/目录</h2><p>默认软件都会存于该目录下。用于存储只读用户数据的第二层次；包含绝大多数的用户工具和应用程序。</p>\n<h2 id=\"var-目录\"><a href=\"#var-目录\" class=\"headerlink\" title=\"/var/目录\"></a>/var/目录</h2><p>/var 包括系统一般运行时要改变的数据.每个系统是特定的，即不通过网络与其他计算机共享.</p>\n<h2 id=\"proc-目录\"><a href=\"#proc-目录\" class=\"headerlink\" title=\"/proc/目录\"></a>/proc/目录</h2><p>虚拟文件系统，将内核与进程状态归档为文本文件（系统信息都存放这目录下）。</p>\n<p>例如：uptime、 network。在Linux中，对应Procfs格式挂载。该目录下文件只能看不能改（包括root）</p>\n<h2 id=\"dev-目录\"><a href=\"#dev-目录\" class=\"headerlink\" title=\"/dev/目录\"></a>/dev/目录</h2><p>设备文件分为两种：</p>\n<ul>\n<li>块设备文件(b)</li>\n<li>字符设备文件(c)</li>\n</ul>"},{"title":"MVCC多版本并发控制","date":"2016-09-16T17:00:00.000Z","_content":"\nMySQL中大多数事务型的存储引擎都不是简单的行级锁。为了提高并发性，他们一般会采用多版本并发控制（MVCC，一种行级锁的变种）来使很多情况下在避免加锁的情况下就实现并发操作，从而是的系统开销更低。\n\nMySQL的InnoDB存储引擎的MCVV，是通过在每行记录后面保存两个隐藏的列来实现。一个保存行的创建时间，另一个保存过期时间。当然这里所说的时间并不是实际时间，是系统版本号。数据库系统在每开始一个事务，其系统版本号就会自动递增。一个事务开始时刻，事务会去当前的系统版本号作为当前事务的事务版本号，用来和查询到的每行记录的版本号做比较。\n\nid  | fields ...  | create_version  | delete_version\n----|-------------|-----------------|---------------\n1   | ....        | 1               |\n2   | ....        | 2               | 3\n\n<!-- more -->\n\n## 具体实现\nRepeatable read 隔离级别下，MVCC具体操作：\n### Select 操作：\na. InnoDB 只查找版本号小于当前事务版本号的行（即，行的系统版本号小于或者等于当前事务的系统版本号），以确保当前事务读取到的行，要么是当前事务开始之前就已经存在的行，要么就是当前事务插入或者修改过的行。\nb. 行的删除版本号要么未定义，要么大于当前事务的版本号。这样可以确保当前事务读取到行，在事务开始之前为被删除。\n\n只有同事符合上述两个条件的记录，才能被作为查询结果被返回。\n\n### Insert 操作：\nInnoDB为新插入的行保存当前事务的版本号作为行版本号。\n\n\n### Delete 操作：\nInnoDB为删除的每一行记录保存当前的事务版本号作为行删除标识。\n\n### Update 操作：\nInnoDB会插入一条新纪录，保存当前事务版本号作为改行的行版本号，同事保存当前的事务版本号到原来的行作为行删除标识版本号。\n\n\n\n## 多版本并发控制优缺点\n### 优点\n通过两个额外的版本号，能使大多数读操作都可以不用加锁，从而使得查询性能更好。\n\n### 缺点\n每行记录多需要做存储两个版本号，需要浪费额外的存储空间。\n\n**TIPS:**\nMVCC，只在Repeatable read 和read committed两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为 read uncommitted总是读取最新的行，而不是符合当前事务版本号的行，而 serializable 则会对所有读取的行都会加锁。\n","source":"_posts/MVCC-多版本并发控制整理.md","raw":"---\ntitle: MVCC多版本并发控制\ndate: 2016-09-17 01:00:00\ntags:\n- MVCC\n- 多版本并发控制\ncategories:\n- MySQL\n---\n\nMySQL中大多数事务型的存储引擎都不是简单的行级锁。为了提高并发性，他们一般会采用多版本并发控制（MVCC，一种行级锁的变种）来使很多情况下在避免加锁的情况下就实现并发操作，从而是的系统开销更低。\n\nMySQL的InnoDB存储引擎的MCVV，是通过在每行记录后面保存两个隐藏的列来实现。一个保存行的创建时间，另一个保存过期时间。当然这里所说的时间并不是实际时间，是系统版本号。数据库系统在每开始一个事务，其系统版本号就会自动递增。一个事务开始时刻，事务会去当前的系统版本号作为当前事务的事务版本号，用来和查询到的每行记录的版本号做比较。\n\nid  | fields ...  | create_version  | delete_version\n----|-------------|-----------------|---------------\n1   | ....        | 1               |\n2   | ....        | 2               | 3\n\n<!-- more -->\n\n## 具体实现\nRepeatable read 隔离级别下，MVCC具体操作：\n### Select 操作：\na. InnoDB 只查找版本号小于当前事务版本号的行（即，行的系统版本号小于或者等于当前事务的系统版本号），以确保当前事务读取到的行，要么是当前事务开始之前就已经存在的行，要么就是当前事务插入或者修改过的行。\nb. 行的删除版本号要么未定义，要么大于当前事务的版本号。这样可以确保当前事务读取到行，在事务开始之前为被删除。\n\n只有同事符合上述两个条件的记录，才能被作为查询结果被返回。\n\n### Insert 操作：\nInnoDB为新插入的行保存当前事务的版本号作为行版本号。\n\n\n### Delete 操作：\nInnoDB为删除的每一行记录保存当前的事务版本号作为行删除标识。\n\n### Update 操作：\nInnoDB会插入一条新纪录，保存当前事务版本号作为改行的行版本号，同事保存当前的事务版本号到原来的行作为行删除标识版本号。\n\n\n\n## 多版本并发控制优缺点\n### 优点\n通过两个额外的版本号，能使大多数读操作都可以不用加锁，从而使得查询性能更好。\n\n### 缺点\n每行记录多需要做存储两个版本号，需要浪费额外的存储空间。\n\n**TIPS:**\nMVCC，只在Repeatable read 和read committed两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为 read uncommitted总是读取最新的行，而不是符合当前事务版本号的行，而 serializable 则会对所有读取的行都会加锁。\n","slug":"MVCC-多版本并发控制整理","published":1,"updated":"2016-09-17T05:17:55.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvj001a699fslwbh1ic","content":"<p>MySQL中大多数事务型的存储引擎都不是简单的行级锁。为了提高并发性，他们一般会采用多版本并发控制（MVCC，一种行级锁的变种）来使很多情况下在避免加锁的情况下就实现并发操作，从而是的系统开销更低。</p>\n<p>MySQL的InnoDB存储引擎的MCVV，是通过在每行记录后面保存两个隐藏的列来实现。一个保存行的创建时间，另一个保存过期时间。当然这里所说的时间并不是实际时间，是系统版本号。数据库系统在每开始一个事务，其系统版本号就会自动递增。一个事务开始时刻，事务会去当前的系统版本号作为当前事务的事务版本号，用来和查询到的每行记录的版本号做比较。</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>fields …</th>\n<th>create_version</th>\n<th>delete_version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>….</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>….</td>\n<td>2</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>\n<a id=\"more\"></a>\n<h2 id=\"具体实现\"><a href=\"#具体实现\" class=\"headerlink\" title=\"具体实现\"></a>具体实现</h2><p>Repeatable read 隔离级别下，MVCC具体操作：</p>\n<h3 id=\"Select-操作：\"><a href=\"#Select-操作：\" class=\"headerlink\" title=\"Select 操作：\"></a>Select 操作：</h3><p>a. InnoDB 只查找版本号小于当前事务版本号的行（即，行的系统版本号小于或者等于当前事务的系统版本号），以确保当前事务读取到的行，要么是当前事务开始之前就已经存在的行，要么就是当前事务插入或者修改过的行。<br>b. 行的删除版本号要么未定义，要么大于当前事务的版本号。这样可以确保当前事务读取到行，在事务开始之前为被删除。</p>\n<p>只有同事符合上述两个条件的记录，才能被作为查询结果被返回。</p>\n<h3 id=\"Insert-操作：\"><a href=\"#Insert-操作：\" class=\"headerlink\" title=\"Insert 操作：\"></a>Insert 操作：</h3><p>InnoDB为新插入的行保存当前事务的版本号作为行版本号。</p>\n<h3 id=\"Delete-操作：\"><a href=\"#Delete-操作：\" class=\"headerlink\" title=\"Delete 操作：\"></a>Delete 操作：</h3><p>InnoDB为删除的每一行记录保存当前的事务版本号作为行删除标识。</p>\n<h3 id=\"Update-操作：\"><a href=\"#Update-操作：\" class=\"headerlink\" title=\"Update 操作：\"></a>Update 操作：</h3><p>InnoDB会插入一条新纪录，保存当前事务版本号作为改行的行版本号，同事保存当前的事务版本号到原来的行作为行删除标识版本号。</p>\n<h2 id=\"多版本并发控制优缺点\"><a href=\"#多版本并发控制优缺点\" class=\"headerlink\" title=\"多版本并发控制优缺点\"></a>多版本并发控制优缺点</h2><h3 id=\"优点\"><a href=\"#优点\" class=\"headerlink\" title=\"优点\"></a>优点</h3><p>通过两个额外的版本号，能使大多数读操作都可以不用加锁，从而使得查询性能更好。</p>\n<h3 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h3><p>每行记录多需要做存储两个版本号，需要浪费额外的存储空间。</p>\n<p><strong>TIPS:</strong><br>MVCC，只在Repeatable read 和read committed两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为 read uncommitted总是读取最新的行，而不是符合当前事务版本号的行，而 serializable 则会对所有读取的行都会加锁。</p>\n","excerpt":"<p>MySQL中大多数事务型的存储引擎都不是简单的行级锁。为了提高并发性，他们一般会采用多版本并发控制（MVCC，一种行级锁的变种）来使很多情况下在避免加锁的情况下就实现并发操作，从而是的系统开销更低。</p>\n<p>MySQL的InnoDB存储引擎的MCVV，是通过在每行记录后面保存两个隐藏的列来实现。一个保存行的创建时间，另一个保存过期时间。当然这里所说的时间并不是实际时间，是系统版本号。数据库系统在每开始一个事务，其系统版本号就会自动递增。一个事务开始时刻，事务会去当前的系统版本号作为当前事务的事务版本号，用来和查询到的每行记录的版本号做比较。</p>\n<table>\n<thead>\n<tr>\n<th>id</th>\n<th>fields …</th>\n<th>create_version</th>\n<th>delete_version</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1</td>\n<td>….</td>\n<td>1</td>\n<td></td>\n</tr>\n<tr>\n<td>2</td>\n<td>….</td>\n<td>2</td>\n<td>3</td>\n</tr>\n</tbody>\n</table>","more":"<h2 id=\"具体实现\"><a href=\"#具体实现\" class=\"headerlink\" title=\"具体实现\"></a>具体实现</h2><p>Repeatable read 隔离级别下，MVCC具体操作：</p>\n<h3 id=\"Select-操作：\"><a href=\"#Select-操作：\" class=\"headerlink\" title=\"Select 操作：\"></a>Select 操作：</h3><p>a. InnoDB 只查找版本号小于当前事务版本号的行（即，行的系统版本号小于或者等于当前事务的系统版本号），以确保当前事务读取到的行，要么是当前事务开始之前就已经存在的行，要么就是当前事务插入或者修改过的行。<br>b. 行的删除版本号要么未定义，要么大于当前事务的版本号。这样可以确保当前事务读取到行，在事务开始之前为被删除。</p>\n<p>只有同事符合上述两个条件的记录，才能被作为查询结果被返回。</p>\n<h3 id=\"Insert-操作：\"><a href=\"#Insert-操作：\" class=\"headerlink\" title=\"Insert 操作：\"></a>Insert 操作：</h3><p>InnoDB为新插入的行保存当前事务的版本号作为行版本号。</p>\n<h3 id=\"Delete-操作：\"><a href=\"#Delete-操作：\" class=\"headerlink\" title=\"Delete 操作：\"></a>Delete 操作：</h3><p>InnoDB为删除的每一行记录保存当前的事务版本号作为行删除标识。</p>\n<h3 id=\"Update-操作：\"><a href=\"#Update-操作：\" class=\"headerlink\" title=\"Update 操作：\"></a>Update 操作：</h3><p>InnoDB会插入一条新纪录，保存当前事务版本号作为改行的行版本号，同事保存当前的事务版本号到原来的行作为行删除标识版本号。</p>\n<h2 id=\"多版本并发控制优缺点\"><a href=\"#多版本并发控制优缺点\" class=\"headerlink\" title=\"多版本并发控制优缺点\"></a>多版本并发控制优缺点</h2><h3 id=\"优点\"><a href=\"#优点\" class=\"headerlink\" title=\"优点\"></a>优点</h3><p>通过两个额外的版本号，能使大多数读操作都可以不用加锁，从而使得查询性能更好。</p>\n<h3 id=\"缺点\"><a href=\"#缺点\" class=\"headerlink\" title=\"缺点\"></a>缺点</h3><p>每行记录多需要做存储两个版本号，需要浪费额外的存储空间。</p>\n<p><strong>TIPS:</strong><br>MVCC，只在Repeatable read 和read committed两个隔离级别下工作。其他两个隔离级别都和MVCC不兼容，因为 read uncommitted总是读取最新的行，而不是符合当前事务版本号的行，而 serializable 则会对所有读取的行都会加锁。</p>"},{"title":"Linux网络配置","date":"2016-10-06T14:30:00.000Z","_content":"\n![Linux网络配置](http://n.sinaimg.cn/games/3ece443e/20161007/ifconfig.png)\n\n\n<!-- more -->\n\n##虚拟机网卡的配置（IP地址的配置）\n### IP地址的配置\n给Linux配置IP\n```\nsetup  进行IP地址的设置\nservice network restart\n```\n手工启动Linux网卡\n```\nvi  /etc/sysconfig/network-scripts/ifcfg-eth0\t\t编辑网卡配置文件\n```\n配置文件内容如下：\n```\nDEVICE=eth0\nIPADDR=192.168.140.158\nGATEWAY=192.168.140.1\nNETMASK=255.255.255.0\nHWADDR=00:0c:29:41:c7:1f\nUUID=\"60bfdea1-c598-4dc8-bf93-da162ea4fb41\"\nTYPE=Ethernet\nBOOTPROTO=none\nIPV6INIT=no\nONBOOT=yes\nUSERCTL=no\n```\n修改如下配置项：\n```\nONBOOT=no\t\t改为\nONBOOT=yes\t\t（是否开机启动）\n```\n修改UUID\n> 解决虚拟机网卡不通：（需要进行如下修改）\n\n```\nvi  /etc/sysconfig/network-scripts/ifcfg-eth0\n```\n删除MAC地址行\n```\nrm –rf /etc/udev/rules.d/70-persistent-net.rules\n```\n删除网卡和MAC地址绑定文件\n重启系统\n修改虚拟机配置\n> 网卡连接方式改为桥接模式\n> 确定桥接到有线网卡上\n（桥接方式是虚拟机和真实机共享使用本机的真实物理网卡，故采用这种方式vMare0和8的这两块虚拟网卡可以同时禁掉）\n\n## Linux网络配置\n### IP地址配置（3种方法，推介使用地3种）\n1.\tsetup\n```\n  \tservice   network  restart\n```\n2.\tifconfig  eth0  ip    netmask   \t临时生效\n3.\t修改网卡配置文件\n\n**网卡信息文件：`/etc/sysconfig/network-scripts/ifcfg-eth0` 文件内容如下：**\n```\nDEVICE=eth0\t\t\t\t\t网卡设备名\nBOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP\nBROADCAST=192.168.140.255\t\t\t广播地址\nHWADDR=00:0c:29:21:80:48\t\t\tmac地址\nIPADDR=192.168.140.253\t\t\tIP地址\nIPV6INIT=yes\t\t\t\t\tIPv6开启\nIPV6_AUTOCONF=yes\t\t\t\tIPv6获取\nNETMASK=255.255.255.0\t\t\t\t掩码\nNETWORK=192.168.140.0\t\t\t\t网段\nONBOOT=yes\t\t\t\t\t网卡开机启动\nTYPE=Ethernet\t\t\t\t\t以太网\nGATEWAY=192.168.140.1\t\t\t\t网关\n```\n如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。\n修改配置文件后，需要重启服务（如service  network  restart）\n\n**主机名配置文件**\n```\n/etc/sysconfig/network\t\t永久生效，但是要重启\n```\n文件内容如下：\n```\nNETWORKING=yes\nHOSTNAME=localhost.localdomain\n```\n另外，还可以用命令进行修改，不过只能临时生效\n```\n\thostname  sc\t\t将用户名修改为sc\n\thostname\t\t查看主机名\n```\n\n**DNS配置文件**\n```\n\t\t/etc/resolv.conf\n```\n文件内容如下：\n```\nnameserver  202.106.0.20\n如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”\n```\n\n###\t网络命令\n1.\tifconfig\t\t查看网卡信息\n>\t-a \t全部（包括没有启动的）\n\n2.\tifup  eth0\t\t快速开启\n>\tifdown    eth0\t\t快速关闭\n\n3.\tnetstat   -an\t\t查看所有网络连接\n> netstat  -tlun\t\t查看TCP和UDP协议监听的端口\n>\n>\tnetstat   -rn\t\t查看路由default：默认路由（网关）\n\n4.\troute\t\t查看路由\n>\troute  add   default   gw    192.168.140.1 \t手工设定网关，临时生效\n>\troute  del    default   gw  192.168.190.6   \t删除网关\n\n5.\tping\tIP\t探测网络畅通\n\n6.\ttraceroute    ip或域名\t\t探测到目的地址的路径（Linux命令）\n>\ttracert   ip   \t（windows命令）\n\n7.\ttcpdump\n>\ttcpdump -i eth0 -nnX port 21\t\t抓取eth0网卡  21端口的传输信息\n","source":"_posts/Linux网络配置.md","raw":"---\ntitle: Linux网络配置\ndate: 2016-10-06 22:30:00\ncategories:\n- Linux\n---\n\n![Linux网络配置](http://n.sinaimg.cn/games/3ece443e/20161007/ifconfig.png)\n\n\n<!-- more -->\n\n##虚拟机网卡的配置（IP地址的配置）\n### IP地址的配置\n给Linux配置IP\n```\nsetup  进行IP地址的设置\nservice network restart\n```\n手工启动Linux网卡\n```\nvi  /etc/sysconfig/network-scripts/ifcfg-eth0\t\t编辑网卡配置文件\n```\n配置文件内容如下：\n```\nDEVICE=eth0\nIPADDR=192.168.140.158\nGATEWAY=192.168.140.1\nNETMASK=255.255.255.0\nHWADDR=00:0c:29:41:c7:1f\nUUID=\"60bfdea1-c598-4dc8-bf93-da162ea4fb41\"\nTYPE=Ethernet\nBOOTPROTO=none\nIPV6INIT=no\nONBOOT=yes\nUSERCTL=no\n```\n修改如下配置项：\n```\nONBOOT=no\t\t改为\nONBOOT=yes\t\t（是否开机启动）\n```\n修改UUID\n> 解决虚拟机网卡不通：（需要进行如下修改）\n\n```\nvi  /etc/sysconfig/network-scripts/ifcfg-eth0\n```\n删除MAC地址行\n```\nrm –rf /etc/udev/rules.d/70-persistent-net.rules\n```\n删除网卡和MAC地址绑定文件\n重启系统\n修改虚拟机配置\n> 网卡连接方式改为桥接模式\n> 确定桥接到有线网卡上\n（桥接方式是虚拟机和真实机共享使用本机的真实物理网卡，故采用这种方式vMare0和8的这两块虚拟网卡可以同时禁掉）\n\n## Linux网络配置\n### IP地址配置（3种方法，推介使用地3种）\n1.\tsetup\n```\n  \tservice   network  restart\n```\n2.\tifconfig  eth0  ip    netmask   \t临时生效\n3.\t修改网卡配置文件\n\n**网卡信息文件：`/etc/sysconfig/network-scripts/ifcfg-eth0` 文件内容如下：**\n```\nDEVICE=eth0\t\t\t\t\t网卡设备名\nBOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP\nBROADCAST=192.168.140.255\t\t\t广播地址\nHWADDR=00:0c:29:21:80:48\t\t\tmac地址\nIPADDR=192.168.140.253\t\t\tIP地址\nIPV6INIT=yes\t\t\t\t\tIPv6开启\nIPV6_AUTOCONF=yes\t\t\t\tIPv6获取\nNETMASK=255.255.255.0\t\t\t\t掩码\nNETWORK=192.168.140.0\t\t\t\t网段\nONBOOT=yes\t\t\t\t\t网卡开机启动\nTYPE=Ethernet\t\t\t\t\t以太网\nGATEWAY=192.168.140.1\t\t\t\t网关\n```\n如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。\n修改配置文件后，需要重启服务（如service  network  restart）\n\n**主机名配置文件**\n```\n/etc/sysconfig/network\t\t永久生效，但是要重启\n```\n文件内容如下：\n```\nNETWORKING=yes\nHOSTNAME=localhost.localdomain\n```\n另外，还可以用命令进行修改，不过只能临时生效\n```\n\thostname  sc\t\t将用户名修改为sc\n\thostname\t\t查看主机名\n```\n\n**DNS配置文件**\n```\n\t\t/etc/resolv.conf\n```\n文件内容如下：\n```\nnameserver  202.106.0.20\n如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”\n```\n\n###\t网络命令\n1.\tifconfig\t\t查看网卡信息\n>\t-a \t全部（包括没有启动的）\n\n2.\tifup  eth0\t\t快速开启\n>\tifdown    eth0\t\t快速关闭\n\n3.\tnetstat   -an\t\t查看所有网络连接\n> netstat  -tlun\t\t查看TCP和UDP协议监听的端口\n>\n>\tnetstat   -rn\t\t查看路由default：默认路由（网关）\n\n4.\troute\t\t查看路由\n>\troute  add   default   gw    192.168.140.1 \t手工设定网关，临时生效\n>\troute  del    default   gw  192.168.190.6   \t删除网关\n\n5.\tping\tIP\t探测网络畅通\n\n6.\ttraceroute    ip或域名\t\t探测到目的地址的路径（Linux命令）\n>\ttracert   ip   \t（windows命令）\n\n7.\ttcpdump\n>\ttcpdump -i eth0 -nnX port 21\t\t抓取eth0网卡  21端口的传输信息\n","slug":"Linux网络配置","published":1,"updated":"2016-10-07T13:59:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvl001d699fgre2tn6e","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161007/ifconfig.png\" alt=\"Linux网络配置\"></p>\n<a id=\"more\"></a>\n<p>##虚拟机网卡的配置（IP地址的配置）</p>\n<h3 id=\"IP地址的配置\"><a href=\"#IP地址的配置\" class=\"headerlink\" title=\"IP地址的配置\"></a>IP地址的配置</h3><p>给Linux配置IP<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">setup  进行IP地址的设置</div><div class=\"line\">service network restart</div></pre></td></tr></table></figure></p>\n<p>手工启动Linux网卡<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi  /etc/sysconfig/network-scripts/ifcfg-eth0\t\t编辑网卡配置文件</div></pre></td></tr></table></figure></p>\n<p>配置文件内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">DEVICE=eth0</div><div class=\"line\">IPADDR=192.168.140.158</div><div class=\"line\">GATEWAY=192.168.140.1</div><div class=\"line\">NETMASK=255.255.255.0</div><div class=\"line\">HWADDR=00:0c:29:41:c7:1f</div><div class=\"line\">UUID=&quot;60bfdea1-c598-4dc8-bf93-da162ea4fb41&quot;</div><div class=\"line\">TYPE=Ethernet</div><div class=\"line\">BOOTPROTO=none</div><div class=\"line\">IPV6INIT=no</div><div class=\"line\">ONBOOT=yes</div><div class=\"line\">USERCTL=no</div></pre></td></tr></table></figure></p>\n<p>修改如下配置项：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ONBOOT=no\t\t改为</div><div class=\"line\">ONBOOT=yes\t\t（是否开机启动）</div></pre></td></tr></table></figure></p>\n<p>修改UUID</p>\n<blockquote>\n<p>解决虚拟机网卡不通：（需要进行如下修改）</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi  /etc/sysconfig/network-scripts/ifcfg-eth0</div></pre></td></tr></table></figure>\n<p>删除MAC地址行<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm –rf /etc/udev/rules.d/70-persistent-net.rules</div></pre></td></tr></table></figure></p>\n<p>删除网卡和MAC地址绑定文件<br>重启系统<br>修改虚拟机配置</p>\n<blockquote>\n<p>网卡连接方式改为桥接模式<br>确定桥接到有线网卡上<br>（桥接方式是虚拟机和真实机共享使用本机的真实物理网卡，故采用这种方式vMare0和8的这两块虚拟网卡可以同时禁掉）</p>\n</blockquote>\n<h2 id=\"Linux网络配置\"><a href=\"#Linux网络配置\" class=\"headerlink\" title=\"Linux网络配置\"></a>Linux网络配置</h2><h3 id=\"IP地址配置（3种方法，推介使用地3种）\"><a href=\"#IP地址配置（3种方法，推介使用地3种）\" class=\"headerlink\" title=\"IP地址配置（3种方法，推介使用地3种）\"></a>IP地址配置（3种方法，推介使用地3种）</h3><ol>\n<li><p>setup</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">service   network  restart</div></pre></td></tr></table></figure>\n</li>\n<li><p>ifconfig  eth0  ip    netmask       临时生效</p>\n</li>\n<li>修改网卡配置文件</li>\n</ol>\n<p><strong>网卡信息文件：<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> 文件内容如下：</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">DEVICE=eth0\t\t\t\t\t网卡设备名</div><div class=\"line\">BOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP</div><div class=\"line\">BROADCAST=192.168.140.255\t\t\t广播地址</div><div class=\"line\">HWADDR=00:0c:29:21:80:48\t\t\tmac地址</div><div class=\"line\">IPADDR=192.168.140.253\t\t\tIP地址</div><div class=\"line\">IPV6INIT=yes\t\t\t\t\tIPv6开启</div><div class=\"line\">IPV6_AUTOCONF=yes\t\t\t\tIPv6获取</div><div class=\"line\">NETMASK=255.255.255.0\t\t\t\t掩码</div><div class=\"line\">NETWORK=192.168.140.0\t\t\t\t网段</div><div class=\"line\">ONBOOT=yes\t\t\t\t\t网卡开机启动</div><div class=\"line\">TYPE=Ethernet\t\t\t\t\t以太网</div><div class=\"line\">GATEWAY=192.168.140.1\t\t\t\t网关</div></pre></td></tr></table></figure></p>\n<p>如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。<br>修改配置文件后，需要重启服务（如service  network  restart）</p>\n<p><strong>主机名配置文件</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/sysconfig/network\t\t永久生效，但是要重启</div></pre></td></tr></table></figure></p>\n<p>文件内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">NETWORKING=yes</div><div class=\"line\">HOSTNAME=localhost.localdomain</div></pre></td></tr></table></figure></p>\n<p>另外，还可以用命令进行修改，不过只能临时生效<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">hostname  sc\t\t将用户名修改为sc</div><div class=\"line\">hostname\t\t查看主机名</div></pre></td></tr></table></figure></p>\n<p><strong>DNS配置文件</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/resolv.conf</div></pre></td></tr></table></figure></p>\n<p>文件内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">nameserver  202.106.0.20</div><div class=\"line\">如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”</div></pre></td></tr></table></figure></p>\n<h3 id=\"网络命令\"><a href=\"#网络命令\" class=\"headerlink\" title=\"网络命令\"></a>网络命令</h3><ol>\n<li><p>ifconfig        查看网卡信息</p>\n<blockquote>\n<p>   -a     全部（包括没有启动的）</p>\n</blockquote>\n</li>\n<li><p>ifup  eth0        快速开启</p>\n<blockquote>\n<p>   ifdown    eth0        快速关闭</p>\n</blockquote>\n</li>\n<li><p>netstat   -an        查看所有网络连接</p>\n<blockquote>\n<p>netstat  -tlun        查看TCP和UDP协议监听的端口</p>\n<p>   netstat   -rn        查看路由default：默认路由（网关）</p>\n</blockquote>\n</li>\n<li><p>route        查看路由</p>\n<blockquote>\n<p>   route  add   default   gw    192.168.140.1     手工设定网关，临时生效<br>   route  del    default   gw  192.168.190.6       删除网关</p>\n</blockquote>\n</li>\n<li><p>ping    IP    探测网络畅通</p>\n</li>\n<li><p>traceroute    ip或域名        探测到目的地址的路径（Linux命令）</p>\n<blockquote>\n<p>   tracert   ip       （windows命令）</p>\n</blockquote>\n</li>\n<li><p>tcpdump</p>\n<blockquote>\n<p>   tcpdump -i eth0 -nnX port 21        抓取eth0网卡  21端口的传输信息</p>\n</blockquote>\n</li>\n</ol>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161007/ifconfig.png\" alt=\"Linux网络配置\"></p>","more":"<p>##虚拟机网卡的配置（IP地址的配置）</p>\n<h3 id=\"IP地址的配置\"><a href=\"#IP地址的配置\" class=\"headerlink\" title=\"IP地址的配置\"></a>IP地址的配置</h3><p>给Linux配置IP<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">setup  进行IP地址的设置</div><div class=\"line\">service network restart</div></pre></td></tr></table></figure></p>\n<p>手工启动Linux网卡<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi  /etc/sysconfig/network-scripts/ifcfg-eth0\t\t编辑网卡配置文件</div></pre></td></tr></table></figure></p>\n<p>配置文件内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">DEVICE=eth0</div><div class=\"line\">IPADDR=192.168.140.158</div><div class=\"line\">GATEWAY=192.168.140.1</div><div class=\"line\">NETMASK=255.255.255.0</div><div class=\"line\">HWADDR=00:0c:29:41:c7:1f</div><div class=\"line\">UUID=&quot;60bfdea1-c598-4dc8-bf93-da162ea4fb41&quot;</div><div class=\"line\">TYPE=Ethernet</div><div class=\"line\">BOOTPROTO=none</div><div class=\"line\">IPV6INIT=no</div><div class=\"line\">ONBOOT=yes</div><div class=\"line\">USERCTL=no</div></pre></td></tr></table></figure></p>\n<p>修改如下配置项：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ONBOOT=no\t\t改为</div><div class=\"line\">ONBOOT=yes\t\t（是否开机启动）</div></pre></td></tr></table></figure></p>\n<p>修改UUID</p>\n<blockquote>\n<p>解决虚拟机网卡不通：（需要进行如下修改）</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi  /etc/sysconfig/network-scripts/ifcfg-eth0</div></pre></td></tr></table></figure>\n<p>删除MAC地址行<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">rm –rf /etc/udev/rules.d/70-persistent-net.rules</div></pre></td></tr></table></figure></p>\n<p>删除网卡和MAC地址绑定文件<br>重启系统<br>修改虚拟机配置</p>\n<blockquote>\n<p>网卡连接方式改为桥接模式<br>确定桥接到有线网卡上<br>（桥接方式是虚拟机和真实机共享使用本机的真实物理网卡，故采用这种方式vMare0和8的这两块虚拟网卡可以同时禁掉）</p>\n</blockquote>\n<h2 id=\"Linux网络配置\"><a href=\"#Linux网络配置\" class=\"headerlink\" title=\"Linux网络配置\"></a>Linux网络配置</h2><h3 id=\"IP地址配置（3种方法，推介使用地3种）\"><a href=\"#IP地址配置（3种方法，推介使用地3种）\" class=\"headerlink\" title=\"IP地址配置（3种方法，推介使用地3种）\"></a>IP地址配置（3种方法，推介使用地3种）</h3><ol>\n<li><p>setup</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">service   network  restart</div></pre></td></tr></table></figure>\n</li>\n<li><p>ifconfig  eth0  ip    netmask       临时生效</p>\n</li>\n<li>修改网卡配置文件</li>\n</ol>\n<p><strong>网卡信息文件：<code>/etc/sysconfig/network-scripts/ifcfg-eth0</code> 文件内容如下：</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">DEVICE=eth0\t\t\t\t\t网卡设备名</div><div class=\"line\">BOOTPROTO=none\t\t\t\t是否自动获取IP。none：不生效\t\t\t\t\tstatic：手动\t\tdhcp：动态获取IP</div><div class=\"line\">BROADCAST=192.168.140.255\t\t\t广播地址</div><div class=\"line\">HWADDR=00:0c:29:21:80:48\t\t\tmac地址</div><div class=\"line\">IPADDR=192.168.140.253\t\t\tIP地址</div><div class=\"line\">IPV6INIT=yes\t\t\t\t\tIPv6开启</div><div class=\"line\">IPV6_AUTOCONF=yes\t\t\t\tIPv6获取</div><div class=\"line\">NETMASK=255.255.255.0\t\t\t\t掩码</div><div class=\"line\">NETWORK=192.168.140.0\t\t\t\t网段</div><div class=\"line\">ONBOOT=yes\t\t\t\t\t网卡开机启动</div><div class=\"line\">TYPE=Ethernet\t\t\t\t\t以太网</div><div class=\"line\">GATEWAY=192.168.140.1\t\t\t\t网关</div></pre></td></tr></table></figure></p>\n<p>如果是采用DHCP方式获取IP信息，则可以只填写上述用橙色标记的配置项即可。<br>修改配置文件后，需要重启服务（如service  network  restart）</p>\n<p><strong>主机名配置文件</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/sysconfig/network\t\t永久生效，但是要重启</div></pre></td></tr></table></figure></p>\n<p>文件内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">NETWORKING=yes</div><div class=\"line\">HOSTNAME=localhost.localdomain</div></pre></td></tr></table></figure></p>\n<p>另外，还可以用命令进行修改，不过只能临时生效<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">hostname  sc\t\t将用户名修改为sc</div><div class=\"line\">hostname\t\t查看主机名</div></pre></td></tr></table></figure></p>\n<p><strong>DNS配置文件</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/etc/resolv.conf</div></pre></td></tr></table></figure></p>\n<p>文件内容如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">nameserver  202.106.0.20</div><div class=\"line\">如有多个DNS服务器地址，可在IP地址后面直接加，并以“，”分割，或者再起下一行写入“nameserver  xx.xx.xx.xx”</div></pre></td></tr></table></figure></p>\n<h3 id=\"网络命令\"><a href=\"#网络命令\" class=\"headerlink\" title=\"网络命令\"></a>网络命令</h3><ol>\n<li><p>ifconfig        查看网卡信息</p>\n<blockquote>\n<p>   -a     全部（包括没有启动的）</p>\n</blockquote>\n</li>\n<li><p>ifup  eth0        快速开启</p>\n<blockquote>\n<p>   ifdown    eth0        快速关闭</p>\n</blockquote>\n</li>\n<li><p>netstat   -an        查看所有网络连接</p>\n<blockquote>\n<p>netstat  -tlun        查看TCP和UDP协议监听的端口</p>\n<p>   netstat   -rn        查看路由default：默认路由（网关）</p>\n</blockquote>\n</li>\n<li><p>route        查看路由</p>\n<blockquote>\n<p>   route  add   default   gw    192.168.140.1     手工设定网关，临时生效<br>   route  del    default   gw  192.168.190.6       删除网关</p>\n</blockquote>\n</li>\n<li><p>ping    IP    探测网络畅通</p>\n</li>\n<li><p>traceroute    ip或域名        探测到目的地址的路径（Linux命令）</p>\n<blockquote>\n<p>   tracert   ip       （windows命令）</p>\n</blockquote>\n</li>\n<li><p>tcpdump</p>\n<blockquote>\n<p>   tcpdump -i eth0 -nnX port 21        抓取eth0网卡  21端口的传输信息</p>\n</blockquote>\n</li>\n</ol>"},{"title":"Linux系统的简介和安装","date":"2016-10-06T14:30:00.000Z","_content":"\n## Linux简介\n### Unix发展史\n1965年，美国麻省理工学院（MIT）、通用电气公司（GE）及AT&T的贝尔实验室联合开发Multics工程计划，其目标是开发一种交互式的具有多道程序处理能力的分时操作系统，但因Multics追求的目标过于庞大复杂，项目进度远远落后于计划，最后贝尔实验室宣布退出。\n\n1969年，美国贝尔实验室的肯.汤普森在DEC PDP-7机器上开发出了UNIX系统\n\n1971年，肯.汤普森的同事丹尼斯.里奇发明了C语言；1973年，UNIX系统的绝大部分源代码用C语言重写，这为提高UNIX系统的可移植性打下基础\n\n<!-- more -->\n\n### 常见的Unix\n- AIX\t\tIBM\n- HP-UX\t\tHP\n- Solaris\t\tSUN\n\n### Linux的发展史\n由Andrew S. Tanenbaum（谭宁邦）发明。MINIX最初发布于1987年，开放全部源代码给大学教学和研究工作。2000年重新改为BSD授权，成为自由和开放源码软件。\nLinus Torvalds（李纳斯.托瓦兹），1991年，他在芬兰的赫尔辛基大学用Minix操作平台建立了一个新的操作系统的内核，他把它叫做Linux。\n\n### 常见的Linux\n\nLinux的各种版本多大上千种，主要可以分为两大类：\n- 一类是Red Hat系列，主要有Fedora、RHEL、CentOS、SUSE、gentoo、红旗、Mandriva、turboLinux、REHL enterprise。\n\n- 还有一类是以debian和ubuntu为代表的系列\n\n### Linux特点\n- 开源、免费\n- 稳定\n- 安全\n\n### Linux的应用领域：\n- 基于Linux的网站服务器\n- 电影娱乐业（特别是在特效制作上）\n- 嵌入式领域\n- 手机、平板电脑\n- 其他嵌入式领域\n\n## Linux安装\nLinux安装步骤：\n> - 分区：把大硬盘分为小的逻辑分区\n>\n> - 格式化：写入文件系统\n>\n> - 分区设备文件名：给每个分区定义设备文件名\n>\n> - 挂载：给每个分区分配挂载点\n\n### Linux磁盘分区：\n分区类型\n- 主分区，由于硬盘的限制，一个硬盘最多只能有4个主分区。\n- 扩展分区，一个硬盘上最多只能有一个扩展分区，主分区和扩展分区加起来一个硬盘也最多有4个，且扩展分区当中不能直接写入数据，只能包含逻辑分区。\n- 逻辑分区，逻辑分区只能建立在扩展分区之上。逻辑分区可以有多个。\n\nLinux分区表示：\n- /dev/hda1\n>\thd:\tIDE硬盘\tsd：\tSCSI硬盘或者SATA硬盘\n>\ta：\t第一块硬盘\n>\t1：\t第一个分区\n\n### Linux分区格式化（写入文件系统）\n文件系统类型\n- Windows系统一般有一下文件系统：\n  - FAT16\n  - FAT32\n  - NTFS\n\n\n- Linux系统有一下几种文件系统：\n  - EXT2\n  - EXT3\n  - EXT4\n\nInode\t\ti节点（每个文件都有一个唯一的数字标识来唯一标识该文件）\n> 注意：每个i节点可以表示的硬盘空间的大小有限，一个小文件可能用一个i节点就可表示，但当一个文件非常大时，就可能对应着好多个i节点。\n\nBlock\t\t数据存储的最小单元（一般大小为4Kb）\n\n格式化又称为逻辑格式化，它是指根据用户选定的文件系统，在磁盘的特定区域写入特定数据，在分区中画出一片用于存放文件分配表、目录表等用于文件管理的磁盘空间。\n","source":"_posts/Linux简介.md","raw":"---\ntitle: Linux系统的简介和安装\ndate: 2016-10-06 22:30:00\ncategories:\n- Linux\n---\n\n## Linux简介\n### Unix发展史\n1965年，美国麻省理工学院（MIT）、通用电气公司（GE）及AT&T的贝尔实验室联合开发Multics工程计划，其目标是开发一种交互式的具有多道程序处理能力的分时操作系统，但因Multics追求的目标过于庞大复杂，项目进度远远落后于计划，最后贝尔实验室宣布退出。\n\n1969年，美国贝尔实验室的肯.汤普森在DEC PDP-7机器上开发出了UNIX系统\n\n1971年，肯.汤普森的同事丹尼斯.里奇发明了C语言；1973年，UNIX系统的绝大部分源代码用C语言重写，这为提高UNIX系统的可移植性打下基础\n\n<!-- more -->\n\n### 常见的Unix\n- AIX\t\tIBM\n- HP-UX\t\tHP\n- Solaris\t\tSUN\n\n### Linux的发展史\n由Andrew S. Tanenbaum（谭宁邦）发明。MINIX最初发布于1987年，开放全部源代码给大学教学和研究工作。2000年重新改为BSD授权，成为自由和开放源码软件。\nLinus Torvalds（李纳斯.托瓦兹），1991年，他在芬兰的赫尔辛基大学用Minix操作平台建立了一个新的操作系统的内核，他把它叫做Linux。\n\n### 常见的Linux\n\nLinux的各种版本多大上千种，主要可以分为两大类：\n- 一类是Red Hat系列，主要有Fedora、RHEL、CentOS、SUSE、gentoo、红旗、Mandriva、turboLinux、REHL enterprise。\n\n- 还有一类是以debian和ubuntu为代表的系列\n\n### Linux特点\n- 开源、免费\n- 稳定\n- 安全\n\n### Linux的应用领域：\n- 基于Linux的网站服务器\n- 电影娱乐业（特别是在特效制作上）\n- 嵌入式领域\n- 手机、平板电脑\n- 其他嵌入式领域\n\n## Linux安装\nLinux安装步骤：\n> - 分区：把大硬盘分为小的逻辑分区\n>\n> - 格式化：写入文件系统\n>\n> - 分区设备文件名：给每个分区定义设备文件名\n>\n> - 挂载：给每个分区分配挂载点\n\n### Linux磁盘分区：\n分区类型\n- 主分区，由于硬盘的限制，一个硬盘最多只能有4个主分区。\n- 扩展分区，一个硬盘上最多只能有一个扩展分区，主分区和扩展分区加起来一个硬盘也最多有4个，且扩展分区当中不能直接写入数据，只能包含逻辑分区。\n- 逻辑分区，逻辑分区只能建立在扩展分区之上。逻辑分区可以有多个。\n\nLinux分区表示：\n- /dev/hda1\n>\thd:\tIDE硬盘\tsd：\tSCSI硬盘或者SATA硬盘\n>\ta：\t第一块硬盘\n>\t1：\t第一个分区\n\n### Linux分区格式化（写入文件系统）\n文件系统类型\n- Windows系统一般有一下文件系统：\n  - FAT16\n  - FAT32\n  - NTFS\n\n\n- Linux系统有一下几种文件系统：\n  - EXT2\n  - EXT3\n  - EXT4\n\nInode\t\ti节点（每个文件都有一个唯一的数字标识来唯一标识该文件）\n> 注意：每个i节点可以表示的硬盘空间的大小有限，一个小文件可能用一个i节点就可表示，但当一个文件非常大时，就可能对应着好多个i节点。\n\nBlock\t\t数据存储的最小单元（一般大小为4Kb）\n\n格式化又称为逻辑格式化，它是指根据用户选定的文件系统，在磁盘的特定区域写入特定数据，在分区中画出一片用于存放文件分配表、目录表等用于文件管理的磁盘空间。\n","slug":"Linux简介","published":1,"updated":"2016-10-07T13:39:11.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvo001h699fipq3m50e","content":"<h2 id=\"Linux简介\"><a href=\"#Linux简介\" class=\"headerlink\" title=\"Linux简介\"></a>Linux简介</h2><h3 id=\"Unix发展史\"><a href=\"#Unix发展史\" class=\"headerlink\" title=\"Unix发展史\"></a>Unix发展史</h3><p>1965年，美国麻省理工学院（MIT）、通用电气公司（GE）及AT&amp;T的贝尔实验室联合开发Multics工程计划，其目标是开发一种交互式的具有多道程序处理能力的分时操作系统，但因Multics追求的目标过于庞大复杂，项目进度远远落后于计划，最后贝尔实验室宣布退出。</p>\n<p>1969年，美国贝尔实验室的肯.汤普森在DEC PDP-7机器上开发出了UNIX系统</p>\n<p>1971年，肯.汤普森的同事丹尼斯.里奇发明了C语言；1973年，UNIX系统的绝大部分源代码用C语言重写，这为提高UNIX系统的可移植性打下基础</p>\n<a id=\"more\"></a>\n<h3 id=\"常见的Unix\"><a href=\"#常见的Unix\" class=\"headerlink\" title=\"常见的Unix\"></a>常见的Unix</h3><ul>\n<li>AIX        IBM</li>\n<li>HP-UX        HP</li>\n<li>Solaris        SUN</li>\n</ul>\n<h3 id=\"Linux的发展史\"><a href=\"#Linux的发展史\" class=\"headerlink\" title=\"Linux的发展史\"></a>Linux的发展史</h3><p>由Andrew S. Tanenbaum（谭宁邦）发明。MINIX最初发布于1987年，开放全部源代码给大学教学和研究工作。2000年重新改为BSD授权，成为自由和开放源码软件。<br>Linus Torvalds（李纳斯.托瓦兹），1991年，他在芬兰的赫尔辛基大学用Minix操作平台建立了一个新的操作系统的内核，他把它叫做Linux。</p>\n<h3 id=\"常见的Linux\"><a href=\"#常见的Linux\" class=\"headerlink\" title=\"常见的Linux\"></a>常见的Linux</h3><p>Linux的各种版本多大上千种，主要可以分为两大类：</p>\n<ul>\n<li><p>一类是Red Hat系列，主要有Fedora、RHEL、CentOS、SUSE、gentoo、红旗、Mandriva、turboLinux、REHL enterprise。</p>\n</li>\n<li><p>还有一类是以debian和ubuntu为代表的系列</p>\n</li>\n</ul>\n<h3 id=\"Linux特点\"><a href=\"#Linux特点\" class=\"headerlink\" title=\"Linux特点\"></a>Linux特点</h3><ul>\n<li>开源、免费</li>\n<li>稳定</li>\n<li>安全</li>\n</ul>\n<h3 id=\"Linux的应用领域：\"><a href=\"#Linux的应用领域：\" class=\"headerlink\" title=\"Linux的应用领域：\"></a>Linux的应用领域：</h3><ul>\n<li>基于Linux的网站服务器</li>\n<li>电影娱乐业（特别是在特效制作上）</li>\n<li>嵌入式领域</li>\n<li>手机、平板电脑</li>\n<li>其他嵌入式领域</li>\n</ul>\n<h2 id=\"Linux安装\"><a href=\"#Linux安装\" class=\"headerlink\" title=\"Linux安装\"></a>Linux安装</h2><p>Linux安装步骤：</p>\n<blockquote>\n<ul>\n<li><p>分区：把大硬盘分为小的逻辑分区</p>\n</li>\n<li><p>格式化：写入文件系统</p>\n</li>\n<li><p>分区设备文件名：给每个分区定义设备文件名</p>\n</li>\n<li><p>挂载：给每个分区分配挂载点</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"Linux磁盘分区：\"><a href=\"#Linux磁盘分区：\" class=\"headerlink\" title=\"Linux磁盘分区：\"></a>Linux磁盘分区：</h3><p>分区类型</p>\n<ul>\n<li>主分区，由于硬盘的限制，一个硬盘最多只能有4个主分区。</li>\n<li>扩展分区，一个硬盘上最多只能有一个扩展分区，主分区和扩展分区加起来一个硬盘也最多有4个，且扩展分区当中不能直接写入数据，只能包含逻辑分区。</li>\n<li>逻辑分区，逻辑分区只能建立在扩展分区之上。逻辑分区可以有多个。</li>\n</ul>\n<p>Linux分区表示：</p>\n<ul>\n<li>/dev/hda1<blockquote>\n<p>   hd:    IDE硬盘    sd：    SCSI硬盘或者SATA硬盘<br>   a：    第一块硬盘<br>   1：    第一个分区</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"Linux分区格式化（写入文件系统）\"><a href=\"#Linux分区格式化（写入文件系统）\" class=\"headerlink\" title=\"Linux分区格式化（写入文件系统）\"></a>Linux分区格式化（写入文件系统）</h3><p>文件系统类型</p>\n<ul>\n<li>Windows系统一般有一下文件系统：<ul>\n<li>FAT16</li>\n<li>FAT32</li>\n<li>NTFS</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>Linux系统有一下几种文件系统：<ul>\n<li>EXT2</li>\n<li>EXT3</li>\n<li>EXT4</li>\n</ul>\n</li>\n</ul>\n<p>Inode        i节点（每个文件都有一个唯一的数字标识来唯一标识该文件）</p>\n<blockquote>\n<p>注意：每个i节点可以表示的硬盘空间的大小有限，一个小文件可能用一个i节点就可表示，但当一个文件非常大时，就可能对应着好多个i节点。</p>\n</blockquote>\n<p>Block        数据存储的最小单元（一般大小为4Kb）</p>\n<p>格式化又称为逻辑格式化，它是指根据用户选定的文件系统，在磁盘的特定区域写入特定数据，在分区中画出一片用于存放文件分配表、目录表等用于文件管理的磁盘空间。</p>\n","excerpt":"<h2 id=\"Linux简介\"><a href=\"#Linux简介\" class=\"headerlink\" title=\"Linux简介\"></a>Linux简介</h2><h3 id=\"Unix发展史\"><a href=\"#Unix发展史\" class=\"headerlink\" title=\"Unix发展史\"></a>Unix发展史</h3><p>1965年，美国麻省理工学院（MIT）、通用电气公司（GE）及AT&amp;T的贝尔实验室联合开发Multics工程计划，其目标是开发一种交互式的具有多道程序处理能力的分时操作系统，但因Multics追求的目标过于庞大复杂，项目进度远远落后于计划，最后贝尔实验室宣布退出。</p>\n<p>1969年，美国贝尔实验室的肯.汤普森在DEC PDP-7机器上开发出了UNIX系统</p>\n<p>1971年，肯.汤普森的同事丹尼斯.里奇发明了C语言；1973年，UNIX系统的绝大部分源代码用C语言重写，这为提高UNIX系统的可移植性打下基础</p>","more":"<h3 id=\"常见的Unix\"><a href=\"#常见的Unix\" class=\"headerlink\" title=\"常见的Unix\"></a>常见的Unix</h3><ul>\n<li>AIX        IBM</li>\n<li>HP-UX        HP</li>\n<li>Solaris        SUN</li>\n</ul>\n<h3 id=\"Linux的发展史\"><a href=\"#Linux的发展史\" class=\"headerlink\" title=\"Linux的发展史\"></a>Linux的发展史</h3><p>由Andrew S. Tanenbaum（谭宁邦）发明。MINIX最初发布于1987年，开放全部源代码给大学教学和研究工作。2000年重新改为BSD授权，成为自由和开放源码软件。<br>Linus Torvalds（李纳斯.托瓦兹），1991年，他在芬兰的赫尔辛基大学用Minix操作平台建立了一个新的操作系统的内核，他把它叫做Linux。</p>\n<h3 id=\"常见的Linux\"><a href=\"#常见的Linux\" class=\"headerlink\" title=\"常见的Linux\"></a>常见的Linux</h3><p>Linux的各种版本多大上千种，主要可以分为两大类：</p>\n<ul>\n<li><p>一类是Red Hat系列，主要有Fedora、RHEL、CentOS、SUSE、gentoo、红旗、Mandriva、turboLinux、REHL enterprise。</p>\n</li>\n<li><p>还有一类是以debian和ubuntu为代表的系列</p>\n</li>\n</ul>\n<h3 id=\"Linux特点\"><a href=\"#Linux特点\" class=\"headerlink\" title=\"Linux特点\"></a>Linux特点</h3><ul>\n<li>开源、免费</li>\n<li>稳定</li>\n<li>安全</li>\n</ul>\n<h3 id=\"Linux的应用领域：\"><a href=\"#Linux的应用领域：\" class=\"headerlink\" title=\"Linux的应用领域：\"></a>Linux的应用领域：</h3><ul>\n<li>基于Linux的网站服务器</li>\n<li>电影娱乐业（特别是在特效制作上）</li>\n<li>嵌入式领域</li>\n<li>手机、平板电脑</li>\n<li>其他嵌入式领域</li>\n</ul>\n<h2 id=\"Linux安装\"><a href=\"#Linux安装\" class=\"headerlink\" title=\"Linux安装\"></a>Linux安装</h2><p>Linux安装步骤：</p>\n<blockquote>\n<ul>\n<li><p>分区：把大硬盘分为小的逻辑分区</p>\n</li>\n<li><p>格式化：写入文件系统</p>\n</li>\n<li><p>分区设备文件名：给每个分区定义设备文件名</p>\n</li>\n<li><p>挂载：给每个分区分配挂载点</p>\n</li>\n</ul>\n</blockquote>\n<h3 id=\"Linux磁盘分区：\"><a href=\"#Linux磁盘分区：\" class=\"headerlink\" title=\"Linux磁盘分区：\"></a>Linux磁盘分区：</h3><p>分区类型</p>\n<ul>\n<li>主分区，由于硬盘的限制，一个硬盘最多只能有4个主分区。</li>\n<li>扩展分区，一个硬盘上最多只能有一个扩展分区，主分区和扩展分区加起来一个硬盘也最多有4个，且扩展分区当中不能直接写入数据，只能包含逻辑分区。</li>\n<li>逻辑分区，逻辑分区只能建立在扩展分区之上。逻辑分区可以有多个。</li>\n</ul>\n<p>Linux分区表示：</p>\n<ul>\n<li>/dev/hda1<blockquote>\n<p>   hd:    IDE硬盘    sd：    SCSI硬盘或者SATA硬盘<br>   a：    第一块硬盘<br>   1：    第一个分区</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"Linux分区格式化（写入文件系统）\"><a href=\"#Linux分区格式化（写入文件系统）\" class=\"headerlink\" title=\"Linux分区格式化（写入文件系统）\"></a>Linux分区格式化（写入文件系统）</h3><p>文件系统类型</p>\n<ul>\n<li>Windows系统一般有一下文件系统：<ul>\n<li>FAT16</li>\n<li>FAT32</li>\n<li>NTFS</li>\n</ul>\n</li>\n</ul>\n<ul>\n<li>Linux系统有一下几种文件系统：<ul>\n<li>EXT2</li>\n<li>EXT3</li>\n<li>EXT4</li>\n</ul>\n</li>\n</ul>\n<p>Inode        i节点（每个文件都有一个唯一的数字标识来唯一标识该文件）</p>\n<blockquote>\n<p>注意：每个i节点可以表示的硬盘空间的大小有限，一个小文件可能用一个i节点就可表示，但当一个文件非常大时，就可能对应着好多个i节点。</p>\n</blockquote>\n<p>Block        数据存储的最小单元（一般大小为4Kb）</p>\n<p>格式化又称为逻辑格式化，它是指根据用户选定的文件系统，在磁盘的特定区域写入特定数据，在分区中画出一片用于存放文件分配表、目录表等用于文件管理的磁盘空间。</p>"},{"title":"Mac下包管理工具homebrew","date":"2016-09-20T15:30:00.000Z","ctime":"2016-09-20T15:30:00.000Z","utime":"2016-09-20T15:30:00.000Z","modif_times":0,"_content":"\n## Homebrew\n\nhomebrew,一个在Mac OS上的软件包管理工具。是一款有Ruby开发的智能包管理系统.\n\n[官网地址](http://brew.sh)\n\n- 安装：\n```bash\n/usr/bin/ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\"\n```\n- 功能：\n> 软件包管理。homebrew会将套件安装到独立目录，并将文件软连接链接到/usr/local\n\n- 命令格式\n```\n$ brew -h\nExample usage:\n  brew search [TEXT|/REGEX/]\n  brew (info|home|options) [FORMULA...]\n  brew install FORMULA...\n  brew update\n  brew upgrade [FORMULA...]\n  brew uninstall FORMULA...\n  brew list [FORMULA...]\nTroubleshooting:\n  brew config\n  brew doctor\n  brew install -vd FORMULA\nBrewing:\n  brew create [URL [--no-fetch]]\n  brew edit [FORMULA...]\n  https://github.com/Homebrew/brew/blob/master/share/doc/homebrew/Formula-Cookbook.md\nFurther help:\n  man brew\n  brew help [COMMAND]\n  brew home\n```\n\n- 示例\n```\n$ brew install wget\n```\n\n\n## brew-cask\n\nbrew-cask,是一套建立在homebrew之上的Mac软件安装命令行工具。其与brew的区别是，后者侧重与软件套件和软件环境的配置安装。\n\n[官网](http://caskrom.github.io)\n\n- 安装：\n```\n$ brew install brew-cask\n```\n\n- 命令格式\n```\n$ brew cask -h\nbrew-cask provides a friendly homebrew-style CLI workflow for the\nadministration of macOS applications distributed as binaries.\nCommands:\n    audit                  verifies installability of Casks\n    cat                    dump raw source of the given Cask to the standard output\n    cleanup                cleans up cached downloads and tracker symlinks\n    create                 creates the given Cask and opens it in an editor\n    doctor                 checks for configuration issues\n    edit                   edits the given Cask\n    fetch                  downloads remote application files to local cache\n    home                   opens the homepage of the given Cask\n    info                   displays information about the given Cask\n    install                installs the given Cask\n    list                   with no args, lists installed Casks; given installed Casks, lists staged files\n    search                 searches all known Casks\n    style                  checks Cask style using RuboCop\n    uninstall              uninstalls the given Cask\n    update                 a synonym for 'brew update'\n    zap                    zaps all files associated with the given Cask\nSee also \"man brew-cask\"\n```\n\n- 示例\n```\n$ brew cask install iterm2\n```\n","source":"_posts/Mac下包管理工具homebrew.md","raw":"---\ntitle: Mac下包管理工具homebrew\ndate: 2016-09-20 23:30:00\nctime: 2016-09-20 23:30:00\nutime: 2016-09-20 23:30:00\nmodif_times: 0\ntags:\n- Mac\n- homebrew\ncategories:\n- Mac\n---\n\n## Homebrew\n\nhomebrew,一个在Mac OS上的软件包管理工具。是一款有Ruby开发的智能包管理系统.\n\n[官网地址](http://brew.sh)\n\n- 安装：\n```bash\n/usr/bin/ruby -e \"$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)\"\n```\n- 功能：\n> 软件包管理。homebrew会将套件安装到独立目录，并将文件软连接链接到/usr/local\n\n- 命令格式\n```\n$ brew -h\nExample usage:\n  brew search [TEXT|/REGEX/]\n  brew (info|home|options) [FORMULA...]\n  brew install FORMULA...\n  brew update\n  brew upgrade [FORMULA...]\n  brew uninstall FORMULA...\n  brew list [FORMULA...]\nTroubleshooting:\n  brew config\n  brew doctor\n  brew install -vd FORMULA\nBrewing:\n  brew create [URL [--no-fetch]]\n  brew edit [FORMULA...]\n  https://github.com/Homebrew/brew/blob/master/share/doc/homebrew/Formula-Cookbook.md\nFurther help:\n  man brew\n  brew help [COMMAND]\n  brew home\n```\n\n- 示例\n```\n$ brew install wget\n```\n\n\n## brew-cask\n\nbrew-cask,是一套建立在homebrew之上的Mac软件安装命令行工具。其与brew的区别是，后者侧重与软件套件和软件环境的配置安装。\n\n[官网](http://caskrom.github.io)\n\n- 安装：\n```\n$ brew install brew-cask\n```\n\n- 命令格式\n```\n$ brew cask -h\nbrew-cask provides a friendly homebrew-style CLI workflow for the\nadministration of macOS applications distributed as binaries.\nCommands:\n    audit                  verifies installability of Casks\n    cat                    dump raw source of the given Cask to the standard output\n    cleanup                cleans up cached downloads and tracker symlinks\n    create                 creates the given Cask and opens it in an editor\n    doctor                 checks for configuration issues\n    edit                   edits the given Cask\n    fetch                  downloads remote application files to local cache\n    home                   opens the homepage of the given Cask\n    info                   displays information about the given Cask\n    install                installs the given Cask\n    list                   with no args, lists installed Casks; given installed Casks, lists staged files\n    search                 searches all known Casks\n    style                  checks Cask style using RuboCop\n    uninstall              uninstalls the given Cask\n    update                 a synonym for 'brew update'\n    zap                    zaps all files associated with the given Cask\nSee also \"man brew-cask\"\n```\n\n- 示例\n```\n$ brew cask install iterm2\n```\n","slug":"Mac下包管理工具homebrew","published":1,"updated":"2016-09-20T15:09:18.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvq001k699fmv3xluce","content":"<h2 id=\"Homebrew\"><a href=\"#Homebrew\" class=\"headerlink\" title=\"Homebrew\"></a>Homebrew</h2><p>homebrew,一个在Mac OS上的软件包管理工具。是一款有Ruby开发的智能包管理系统.</p>\n<p><a href=\"http://brew.sh\" target=\"_blank\" rel=\"external\">官网地址</a></p>\n<ul>\n<li><p>安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/bin/ruby <span class=\"_\">-e</span> <span class=\"string\">\"<span class=\"variable\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>\"</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>功能：</p>\n<blockquote>\n<p>软件包管理。homebrew会将套件安装到独立目录，并将文件软连接链接到/usr/local</p>\n</blockquote>\n</li>\n<li><p>命令格式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew -h</div><div class=\"line\">Example usage:</div><div class=\"line\">  brew search [TEXT|/REGEX/]</div><div class=\"line\">  brew (info|home|options) [FORMULA...]</div><div class=\"line\">  brew install FORMULA...</div><div class=\"line\">  brew update</div><div class=\"line\">  brew upgrade [FORMULA...]</div><div class=\"line\">  brew uninstall FORMULA...</div><div class=\"line\">  brew list [FORMULA...]</div><div class=\"line\">Troubleshooting:</div><div class=\"line\">  brew config</div><div class=\"line\">  brew doctor</div><div class=\"line\">  brew install -vd FORMULA</div><div class=\"line\">Brewing:</div><div class=\"line\">  brew create [URL [--no-fetch]]</div><div class=\"line\">  brew edit [FORMULA...]</div><div class=\"line\">  https://github.com/Homebrew/brew/blob/master/share/doc/homebrew/Formula-Cookbook.md</div><div class=\"line\">Further help:</div><div class=\"line\">  man brew</div><div class=\"line\">  brew help [COMMAND]</div><div class=\"line\">  brew home</div></pre></td></tr></table></figure>\n</li>\n<li><p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew install wget</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"brew-cask\"><a href=\"#brew-cask\" class=\"headerlink\" title=\"brew-cask\"></a>brew-cask</h2><p>brew-cask,是一套建立在homebrew之上的Mac软件安装命令行工具。其与brew的区别是，后者侧重与软件套件和软件环境的配置安装。</p>\n<p><a href=\"http://caskrom.github.io\" target=\"_blank\" rel=\"external\">官网</a></p>\n<ul>\n<li><p>安装：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew install brew-cask</div></pre></td></tr></table></figure>\n</li>\n<li><p>命令格式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew cask -h</div><div class=\"line\">brew-cask provides a friendly homebrew-style CLI workflow for the</div><div class=\"line\">administration of macOS applications distributed as binaries.</div><div class=\"line\">Commands:</div><div class=\"line\">    audit                  verifies installability of Casks</div><div class=\"line\">    cat                    dump raw source of the given Cask to the standard output</div><div class=\"line\">    cleanup                cleans up cached downloads and tracker symlinks</div><div class=\"line\">    create                 creates the given Cask and opens it in an editor</div><div class=\"line\">    doctor                 checks for configuration issues</div><div class=\"line\">    edit                   edits the given Cask</div><div class=\"line\">    fetch                  downloads remote application files to local cache</div><div class=\"line\">    home                   opens the homepage of the given Cask</div><div class=\"line\">    info                   displays information about the given Cask</div><div class=\"line\">    install                installs the given Cask</div><div class=\"line\">    list                   with no args, lists installed Casks; given installed Casks, lists staged files</div><div class=\"line\">    search                 searches all known Casks</div><div class=\"line\">    style                  checks Cask style using RuboCop</div><div class=\"line\">    uninstall              uninstalls the given Cask</div><div class=\"line\">    update                 a synonym for &apos;brew update&apos;</div><div class=\"line\">    zap                    zaps all files associated with the given Cask</div><div class=\"line\">See also &quot;man brew-cask&quot;</div></pre></td></tr></table></figure>\n</li>\n<li><p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew cask install iterm2</div></pre></td></tr></table></figure>\n</li>\n</ul>\n","excerpt":"","more":"<h2 id=\"Homebrew\"><a href=\"#Homebrew\" class=\"headerlink\" title=\"Homebrew\"></a>Homebrew</h2><p>homebrew,一个在Mac OS上的软件包管理工具。是一款有Ruby开发的智能包管理系统.</p>\n<p><a href=\"http://brew.sh\">官网地址</a></p>\n<ul>\n<li><p>安装：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/bin/ruby <span class=\"_\">-e</span> <span class=\"string\">\"<span class=\"variable\">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>\"</span></div></pre></td></tr></table></figure>\n</li>\n<li><p>功能：</p>\n<blockquote>\n<p>软件包管理。homebrew会将套件安装到独立目录，并将文件软连接链接到/usr/local</p>\n</blockquote>\n</li>\n<li><p>命令格式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew -h</div><div class=\"line\">Example usage:</div><div class=\"line\">  brew search [TEXT|/REGEX/]</div><div class=\"line\">  brew (info|home|options) [FORMULA...]</div><div class=\"line\">  brew install FORMULA...</div><div class=\"line\">  brew update</div><div class=\"line\">  brew upgrade [FORMULA...]</div><div class=\"line\">  brew uninstall FORMULA...</div><div class=\"line\">  brew list [FORMULA...]</div><div class=\"line\">Troubleshooting:</div><div class=\"line\">  brew config</div><div class=\"line\">  brew doctor</div><div class=\"line\">  brew install -vd FORMULA</div><div class=\"line\">Brewing:</div><div class=\"line\">  brew create [URL [--no-fetch]]</div><div class=\"line\">  brew edit [FORMULA...]</div><div class=\"line\">  https://github.com/Homebrew/brew/blob/master/share/doc/homebrew/Formula-Cookbook.md</div><div class=\"line\">Further help:</div><div class=\"line\">  man brew</div><div class=\"line\">  brew help [COMMAND]</div><div class=\"line\">  brew home</div></pre></td></tr></table></figure>\n</li>\n<li><p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew install wget</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<h2 id=\"brew-cask\"><a href=\"#brew-cask\" class=\"headerlink\" title=\"brew-cask\"></a>brew-cask</h2><p>brew-cask,是一套建立在homebrew之上的Mac软件安装命令行工具。其与brew的区别是，后者侧重与软件套件和软件环境的配置安装。</p>\n<p><a href=\"http://caskrom.github.io\">官网</a></p>\n<ul>\n<li><p>安装：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew install brew-cask</div></pre></td></tr></table></figure>\n</li>\n<li><p>命令格式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew cask -h</div><div class=\"line\">brew-cask provides a friendly homebrew-style CLI workflow for the</div><div class=\"line\">administration of macOS applications distributed as binaries.</div><div class=\"line\">Commands:</div><div class=\"line\">    audit                  verifies installability of Casks</div><div class=\"line\">    cat                    dump raw source of the given Cask to the standard output</div><div class=\"line\">    cleanup                cleans up cached downloads and tracker symlinks</div><div class=\"line\">    create                 creates the given Cask and opens it in an editor</div><div class=\"line\">    doctor                 checks for configuration issues</div><div class=\"line\">    edit                   edits the given Cask</div><div class=\"line\">    fetch                  downloads remote application files to local cache</div><div class=\"line\">    home                   opens the homepage of the given Cask</div><div class=\"line\">    info                   displays information about the given Cask</div><div class=\"line\">    install                installs the given Cask</div><div class=\"line\">    list                   with no args, lists installed Casks; given installed Casks, lists staged files</div><div class=\"line\">    search                 searches all known Casks</div><div class=\"line\">    style                  checks Cask style using RuboCop</div><div class=\"line\">    uninstall              uninstalls the given Cask</div><div class=\"line\">    update                 a synonym for &apos;brew update&apos;</div><div class=\"line\">    zap                    zaps all files associated with the given Cask</div><div class=\"line\">See also &quot;man brew-cask&quot;</div></pre></td></tr></table></figure>\n</li>\n<li><p>示例</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ brew cask install iterm2</div></pre></td></tr></table></figure>\n</li>\n</ul>\n"},{"title":"如何查看表的相关信息","date":"2016-09-17T14:00:00.000Z","_content":"\n在文件系统中，MySQL将每个数据库（也被称为schema）保存为数据目录下的一个子目录。在创建表的时候，MySQL会在数据库子目录下创建一个和表同名的 .frm 文件对表的定义。例如，创建一个名为 mytable 的表，MySQL会在 mytable.frm 文件中保存对该表的定义。\n\n通常，我们可以使用 show table status 命令来显示表的相关信息。（MySQL 5.0 + 的版本，也可以查看 INFOMATION_SCHEMA 中对应的表的信息）。\n例如，对于MySQL数据库中的 user 表：\n```sql\nmysql> show table status like 'user' \\G;\n*************************** 1. row ***************************\n           Name: user\n         Engine: MyISAM\n        Version: 10\n     Row_format: Dynamic\n           Rows: 14\n Avg_row_length: 63\n    Data_length: 952\nMax_data_length: 281474976710655\n   Index_length: 2048\n      Data_free: 64\n Auto_increment: NULL\n    Create_time: 2012-12-25 14:23:08\n    Update_time: 2015-08-11 11:17:42\n     Check_time: NULL\n      Collation: utf8_bin\n       Checksum: NULL\n Create_options:\n        Comment: Users and global privileges\n1 row in set (0.01 sec)\n```\n<!-- more -->\n\n下面简单介绍一下每行的含义：\n- Name\n> 表名。\n\n- Engine\n> 表的存储引擎。\n\n- Row_format\n> 行的格式，对于MyISAM表，可选的值为Dynamic、Fixed、Compressed。\n  - Dynamic，表示行的长度是可变的，一般包含可变长度的字段，如varchar、blob等。\n  - Fixed，行的长度是固定的，只包含固定长短的列。\n  - Compressed，只在压缩表中出现，表示是被压缩的。\n\n- Rrows\n> 表中行数，对于MyISAM和其他的一些存储引擎该值是精确的，但对于InnoDB该值只是一个大概值。\n\n- Avg_row_length\n> 平均每行包含的字节数\n\n- Data_length\n> 表数据的大小(单位：字节)\n\n- Max_data_length\n> 表数据的最大容量，该值和存储引擎有关。\n\n- Index_length\n> 索引的大小(单位：字节)\n\n- Data_free\n> 对于MyISAM表示已经分配但是目前没有被使用的空间。这部分空间包括之前删除的行，以及后续可以被Insert利用的行。\n\n- Auto_increment\n> 下一个Auto_increment的值。\n\n- Create_time\n> 表的创建时间。\n\n- Update_time\n> 表数据的最后修改时间。\n\n- Check_time\n> 使用check table命令或者muisamchk 工具最后一次检查表的时间。\n\n- Collation\n> 表的默认字符集和字符列排序规则。\n\n- Checksum\n> 如果启用，保存的是整个表的实时校验和。\n\n- Create_options\n> 创建表时指定的其他选项。\n\n- Comment\n> 该列包含了一些其他的额外信息。对于MyISAM表，保存的是在表创建的时候附带的注释。对于InnoDB表，该值保存的是InnoDB表空间的剩余空间信息。如果是一个视图，该列将会包含『VIEW』字样。\n","source":"_posts/MySQL如何查看表的相关信息.md","raw":"---\ntitle: 如何查看表的相关信息\ndate: 2016-09-17 22:00:00\ntags:\ncategories:\n- MySQL\n---\n\n在文件系统中，MySQL将每个数据库（也被称为schema）保存为数据目录下的一个子目录。在创建表的时候，MySQL会在数据库子目录下创建一个和表同名的 .frm 文件对表的定义。例如，创建一个名为 mytable 的表，MySQL会在 mytable.frm 文件中保存对该表的定义。\n\n通常，我们可以使用 show table status 命令来显示表的相关信息。（MySQL 5.0 + 的版本，也可以查看 INFOMATION_SCHEMA 中对应的表的信息）。\n例如，对于MySQL数据库中的 user 表：\n```sql\nmysql> show table status like 'user' \\G;\n*************************** 1. row ***************************\n           Name: user\n         Engine: MyISAM\n        Version: 10\n     Row_format: Dynamic\n           Rows: 14\n Avg_row_length: 63\n    Data_length: 952\nMax_data_length: 281474976710655\n   Index_length: 2048\n      Data_free: 64\n Auto_increment: NULL\n    Create_time: 2012-12-25 14:23:08\n    Update_time: 2015-08-11 11:17:42\n     Check_time: NULL\n      Collation: utf8_bin\n       Checksum: NULL\n Create_options:\n        Comment: Users and global privileges\n1 row in set (0.01 sec)\n```\n<!-- more -->\n\n下面简单介绍一下每行的含义：\n- Name\n> 表名。\n\n- Engine\n> 表的存储引擎。\n\n- Row_format\n> 行的格式，对于MyISAM表，可选的值为Dynamic、Fixed、Compressed。\n  - Dynamic，表示行的长度是可变的，一般包含可变长度的字段，如varchar、blob等。\n  - Fixed，行的长度是固定的，只包含固定长短的列。\n  - Compressed，只在压缩表中出现，表示是被压缩的。\n\n- Rrows\n> 表中行数，对于MyISAM和其他的一些存储引擎该值是精确的，但对于InnoDB该值只是一个大概值。\n\n- Avg_row_length\n> 平均每行包含的字节数\n\n- Data_length\n> 表数据的大小(单位：字节)\n\n- Max_data_length\n> 表数据的最大容量，该值和存储引擎有关。\n\n- Index_length\n> 索引的大小(单位：字节)\n\n- Data_free\n> 对于MyISAM表示已经分配但是目前没有被使用的空间。这部分空间包括之前删除的行，以及后续可以被Insert利用的行。\n\n- Auto_increment\n> 下一个Auto_increment的值。\n\n- Create_time\n> 表的创建时间。\n\n- Update_time\n> 表数据的最后修改时间。\n\n- Check_time\n> 使用check table命令或者muisamchk 工具最后一次检查表的时间。\n\n- Collation\n> 表的默认字符集和字符列排序规则。\n\n- Checksum\n> 如果启用，保存的是整个表的实时校验和。\n\n- Create_options\n> 创建表时指定的其他选项。\n\n- Comment\n> 该列包含了一些其他的额外信息。对于MyISAM表，保存的是在表创建的时候附带的注释。对于InnoDB表，该值保存的是InnoDB表空间的剩余空间信息。如果是一个视图，该列将会包含『VIEW』字样。\n","slug":"MySQL如何查看表的相关信息","published":1,"updated":"2016-09-17T08:42:49.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvt001n699f71bcaqf2","content":"<p>在文件系统中，MySQL将每个数据库（也被称为schema）保存为数据目录下的一个子目录。在创建表的时候，MySQL会在数据库子目录下创建一个和表同名的 .frm 文件对表的定义。例如，创建一个名为 mytable 的表，MySQL会在 mytable.frm 文件中保存对该表的定义。</p>\n<p>通常，我们可以使用 show table status 命令来显示表的相关信息。（MySQL 5.0 + 的版本，也可以查看 INFOMATION_SCHEMA 中对应的表的信息）。<br>例如，对于MySQL数据库中的 user 表：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt; show table status like 'user' \\G;</div><div class=\"line\">*************************** 1. row ***************************</div><div class=\"line\">           Name: user</div><div class=\"line\">         Engine: MyISAM</div><div class=\"line\">        Version: 10</div><div class=\"line\">     Row_format: Dynamic</div><div class=\"line\">           Rows: 14</div><div class=\"line\"> Avg_row_length: 63</div><div class=\"line\">    Data_length: 952</div><div class=\"line\">Max_data_length: 281474976710655</div><div class=\"line\">   Index_length: 2048</div><div class=\"line\">      Data_free: 64</div><div class=\"line\"> Auto_increment: NULL</div><div class=\"line\">    Create_time: 2012-12-25 14:23:08</div><div class=\"line\">    Update_time: 2015-08-11 11:17:42</div><div class=\"line\">     Check_time: NULL</div><div class=\"line\">      Collation: utf8_bin</div><div class=\"line\">       Checksum: NULL</div><div class=\"line\"> Create_options:</div><div class=\"line\">        Comment: Users and global privileges</div><div class=\"line\">1 row in set (0.01 sec)</div></pre></td></tr></table></figure></p>\n<a id=\"more\"></a>\n<p>下面简单介绍一下每行的含义：</p>\n<ul>\n<li><p>Name</p>\n<blockquote>\n<p>表名。</p>\n</blockquote>\n</li>\n<li><p>Engine</p>\n<blockquote>\n<p>表的存储引擎。</p>\n</blockquote>\n</li>\n<li><p>Row_format</p>\n<blockquote>\n<p>行的格式，对于MyISAM表，可选的值为Dynamic、Fixed、Compressed。</p>\n<ul>\n<li>Dynamic，表示行的长度是可变的，一般包含可变长度的字段，如varchar、blob等。</li>\n<li>Fixed，行的长度是固定的，只包含固定长短的列。</li>\n<li>Compressed，只在压缩表中出现，表示是被压缩的。</li>\n</ul>\n</blockquote>\n</li>\n<li><p>Rrows</p>\n<blockquote>\n<p>表中行数，对于MyISAM和其他的一些存储引擎该值是精确的，但对于InnoDB该值只是一个大概值。</p>\n</blockquote>\n</li>\n<li><p>Avg_row_length</p>\n<blockquote>\n<p>平均每行包含的字节数</p>\n</blockquote>\n</li>\n<li><p>Data_length</p>\n<blockquote>\n<p>表数据的大小(单位：字节)</p>\n</blockquote>\n</li>\n<li><p>Max_data_length</p>\n<blockquote>\n<p>表数据的最大容量，该值和存储引擎有关。</p>\n</blockquote>\n</li>\n<li><p>Index_length</p>\n<blockquote>\n<p>索引的大小(单位：字节)</p>\n</blockquote>\n</li>\n<li><p>Data_free</p>\n<blockquote>\n<p>对于MyISAM表示已经分配但是目前没有被使用的空间。这部分空间包括之前删除的行，以及后续可以被Insert利用的行。</p>\n</blockquote>\n</li>\n<li><p>Auto_increment</p>\n<blockquote>\n<p>下一个Auto_increment的值。</p>\n</blockquote>\n</li>\n<li><p>Create_time</p>\n<blockquote>\n<p>表的创建时间。</p>\n</blockquote>\n</li>\n<li><p>Update_time</p>\n<blockquote>\n<p>表数据的最后修改时间。</p>\n</blockquote>\n</li>\n<li><p>Check_time</p>\n<blockquote>\n<p>使用check table命令或者muisamchk 工具最后一次检查表的时间。</p>\n</blockquote>\n</li>\n<li><p>Collation</p>\n<blockquote>\n<p>表的默认字符集和字符列排序规则。</p>\n</blockquote>\n</li>\n<li><p>Checksum</p>\n<blockquote>\n<p>如果启用，保存的是整个表的实时校验和。</p>\n</blockquote>\n</li>\n<li><p>Create_options</p>\n<blockquote>\n<p>创建表时指定的其他选项。</p>\n</blockquote>\n</li>\n<li><p>Comment</p>\n<blockquote>\n<p>该列包含了一些其他的额外信息。对于MyISAM表，保存的是在表创建的时候附带的注释。对于InnoDB表，该值保存的是InnoDB表空间的剩余空间信息。如果是一个视图，该列将会包含『VIEW』字样。</p>\n</blockquote>\n</li>\n</ul>\n","excerpt":"<p>在文件系统中，MySQL将每个数据库（也被称为schema）保存为数据目录下的一个子目录。在创建表的时候，MySQL会在数据库子目录下创建一个和表同名的 .frm 文件对表的定义。例如，创建一个名为 mytable 的表，MySQL会在 mytable.frm 文件中保存对该表的定义。</p>\n<p>通常，我们可以使用 show table status 命令来显示表的相关信息。（MySQL 5.0 + 的版本，也可以查看 INFOMATION_SCHEMA 中对应的表的信息）。<br>例如，对于MySQL数据库中的 user 表：<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt; show table status like 'user' \\G;</div><div class=\"line\">*************************** 1. row ***************************</div><div class=\"line\">           Name: user</div><div class=\"line\">         Engine: MyISAM</div><div class=\"line\">        Version: 10</div><div class=\"line\">     Row_format: Dynamic</div><div class=\"line\">           Rows: 14</div><div class=\"line\"> Avg_row_length: 63</div><div class=\"line\">    Data_length: 952</div><div class=\"line\">Max_data_length: 281474976710655</div><div class=\"line\">   Index_length: 2048</div><div class=\"line\">      Data_free: 64</div><div class=\"line\"> Auto_increment: NULL</div><div class=\"line\">    Create_time: 2012-12-25 14:23:08</div><div class=\"line\">    Update_time: 2015-08-11 11:17:42</div><div class=\"line\">     Check_time: NULL</div><div class=\"line\">      Collation: utf8_bin</div><div class=\"line\">       Checksum: NULL</div><div class=\"line\"> Create_options:</div><div class=\"line\">        Comment: Users and global privileges</div><div class=\"line\">1 row in set (0.01 sec)</div></pre></td></tr></table></figure></p>","more":"<p>下面简单介绍一下每行的含义：</p>\n<ul>\n<li><p>Name</p>\n<blockquote>\n<p>表名。</p>\n</blockquote>\n</li>\n<li><p>Engine</p>\n<blockquote>\n<p>表的存储引擎。</p>\n</blockquote>\n</li>\n<li><p>Row_format</p>\n<blockquote>\n<p>行的格式，对于MyISAM表，可选的值为Dynamic、Fixed、Compressed。</p>\n<ul>\n<li>Dynamic，表示行的长度是可变的，一般包含可变长度的字段，如varchar、blob等。</li>\n<li>Fixed，行的长度是固定的，只包含固定长短的列。</li>\n<li>Compressed，只在压缩表中出现，表示是被压缩的。</li>\n</ul>\n</blockquote>\n</li>\n<li><p>Rrows</p>\n<blockquote>\n<p>表中行数，对于MyISAM和其他的一些存储引擎该值是精确的，但对于InnoDB该值只是一个大概值。</p>\n</blockquote>\n</li>\n<li><p>Avg_row_length</p>\n<blockquote>\n<p>平均每行包含的字节数</p>\n</blockquote>\n</li>\n<li><p>Data_length</p>\n<blockquote>\n<p>表数据的大小(单位：字节)</p>\n</blockquote>\n</li>\n<li><p>Max_data_length</p>\n<blockquote>\n<p>表数据的最大容量，该值和存储引擎有关。</p>\n</blockquote>\n</li>\n<li><p>Index_length</p>\n<blockquote>\n<p>索引的大小(单位：字节)</p>\n</blockquote>\n</li>\n<li><p>Data_free</p>\n<blockquote>\n<p>对于MyISAM表示已经分配但是目前没有被使用的空间。这部分空间包括之前删除的行，以及后续可以被Insert利用的行。</p>\n</blockquote>\n</li>\n<li><p>Auto_increment</p>\n<blockquote>\n<p>下一个Auto_increment的值。</p>\n</blockquote>\n</li>\n<li><p>Create_time</p>\n<blockquote>\n<p>表的创建时间。</p>\n</blockquote>\n</li>\n<li><p>Update_time</p>\n<blockquote>\n<p>表数据的最后修改时间。</p>\n</blockquote>\n</li>\n<li><p>Check_time</p>\n<blockquote>\n<p>使用check table命令或者muisamchk 工具最后一次检查表的时间。</p>\n</blockquote>\n</li>\n<li><p>Collation</p>\n<blockquote>\n<p>表的默认字符集和字符列排序规则。</p>\n</blockquote>\n</li>\n<li><p>Checksum</p>\n<blockquote>\n<p>如果启用，保存的是整个表的实时校验和。</p>\n</blockquote>\n</li>\n<li><p>Create_options</p>\n<blockquote>\n<p>创建表时指定的其他选项。</p>\n</blockquote>\n</li>\n<li><p>Comment</p>\n<blockquote>\n<p>该列包含了一些其他的额外信息。对于MyISAM表，保存的是在表创建的时候附带的注释。对于InnoDB表，该值保存的是InnoDB表空间的剩余空间信息。如果是一个视图，该列将会包含『VIEW』字样。</p>\n</blockquote>\n</li>\n</ul>"},{"title":"MySQL存储引擎概述","date":"2016-09-17T15:00:00.000Z","_content":"\n基于存储引擎在MySQL架构中的地位，在学习和使用MySQL时我们需要对MySQL的各种存储引擎有一个大概的了解。\n并且知道在实际项目中如何选择适合的存储引擎，以及如何实现不同存储引擎的相互切换。\n\n<!-- more -->\n\n## 存储引擎分类\n\n### InnoDB\nInnoDB，是MySQL的默认事务型引擎，也是做重要、使用最广泛的存储引擎。它的性能和自动崩溃恢复特性，使得它在非事务行存储的需求中也很流行。所以除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。并且InnoDB作为事务型存储引擎，它通过一些机制和工具可以支持真正的热备份，而MySQL其他的存储引擎则不支持热备份。\n\n### MyISAM\n在MySQL 5.1 及之前的版本，MyISAM是MySQL默认的存储引擎。MyISAM提供大量的特性，包括全文索引、压缩、空间函数（GIS）等，但是MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是崩溃后无法安全恢复。尽管MyISAM不支持事务、不支持崩溃后的安全恢复，但是对于一些只读的数据，或者表比较小，可以忍受repair（修复）操作，则依然可以继续使用MyISAM。**但请不要默认使用MyISAM，而是应当默认使用InnoDB**\n\n### Archive\nArchive 存储引擎只支持INSERT 和SELECT 操作，在MySQL 5.1之前还不支持索引。Archive会缓存所有的写并利用zlib对插入的行进行压缩，所以比MyISAM表的磁盘I/O更少。但是每次select操作都需要对全表进行扫描，所以Archive表适合日志和数据采集类应用，或者一些需要更快速insert操作的场合下使用。总之，MyISAM是一个针对告诉插入和压缩做了优化的简单引擎。\n\n### Blackhole\nBlackhole引擎没有实现任何的存储机制，他会丢弃所有的插入的数据，不做任何的保存。但是服务器会记录Blackhole表的日志，所以可以用于复制数据库到备库，或者只是简单地记录到日志。这种特殊的存储引擎可以在一些特殊的复制架构和日志审核时发挥所用。\n\n### CSV\nCSV引擎可以将普通的CSV文件作为MySQL的表来处理，但这种表不支持索引。CSV引擎可以在数据运行是拷入或者烤出文件。可以将Excel等电子表格中的数据存储为CSV文件，然后复制到MySQL数据目录下，然后就能在MySQL中打开使用。因此，CSV引擎可以作为一种数据交换的机制，非常有用。\n\n### Federated\nFederated引擎是访问其他MySQL服务器的一个代理，他会创建一个到远程MySQL服务器的的客户端连接，并将查询传输到远程服务器执行，然后提取或者发送需要的数据。但是尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题。因此默认是禁用的。\n\n### Memory\nMemory表所有的数据都保存在内存中，因此Memory表的访问速度非常的快（至少要比MyISAM快一个数量级），并且不需要磁盘的I/O操作。但是Memory表在系统重启后虽然表结构会保留，但是数据会丢失。\n\nMemory表支持Hash索引，因此查询操作非常快。但是MySQL表采用的表级锁，因此并发写入的性能较低。\n\nMemory表的应用场景：\n- 用于查找（lookup）或者映射（mapping）表。\n- 用于缓存周期性聚合数据的结果。\n- 用于保存数据分析中产生的中间问题。\n\n**Tips：**\n如果MySQL在执行查询的过程中需要使用临时表来保存中间结果，内部使用的临时表就是Memory表。如果中间结果大大超出了Memory表的限制，或者有大量的BLOB或TEXT字段，则临时表会转换成MyISAM表。\n\n### Merge\nMerge引擎是MyISAM的一种变种。Merge表是由多个MyISAM表合并而来的虚拟表。\n\n### NDB\nMySQL服务器、NDB集群引擎、以及分布式的、share-nothing的、容灾的、高可用的NDB数据库组合，被称之为MySQL集群（MySQL Cluster）。\n\n### 其他的第三方存储引擎\nMySQL从07年开始提供了插件式的存储引擎API，从此出现了一系列为不同目的而设计的存储引擎。其中一些已经合并到MySQL服务器，但大多数还是第三方产品或者开源项目。比较有名的有：\n- OLTP类引擎\n- 面向列的存储引擎\n- 社区存储引擎\n\n## 选择合适的存储引擎的考虑因素\n\n不同的应用可能会根据不同的需求而采用不同的存储引擎。那么我们再为应用选择存储引擎时，通常会考虑以下几点：\n- 事务\n引用是否需要事务支持。如果需要，那么InnoDB是目前最稳定且经过验证的选择。如果不需要，并且主要是select和insert操作，那么MyISAM是不错的选择。\n\n- 备份\n如果可以定期的通过关闭服务器来执行备份，那么备份因素就可以忽略。反之，如果需要支持在线热备份，那么选择InnoDB就是基本的要求。\n\n- 崩溃恢复\n相对而言，MyISAM崩溃后发生的数据毁坏的概率要比InnoDB高的多，并且恢复速度也要慢的多。所以，即使不需要事务支持，很多人也会选择InnoDB引擎。\n\n- 特有的特性\n有些应用可能需要一些存储引擎锁独有的特性或者优化，比如依赖聚簇索引的优化，或者需要对地理空间的搜索。\n\n**总之，如无特殊的需求和例外，统统建议选择InnoDB存储引擎。**\n\n## 如何转换表的存储引擎\n有很多中方法可以转换，一般我们会使用以下三种方法：\n### ALTER TABLE\n```sql\nmysql>alter table mytable engine=innodb;\n```\n上述语法可以适应与任何存储引擎。但是当表数据很大时，这种方法将会执行很长时间。MySQL会按行将数据从原表复制到一张新的表中。所以，在繁忙的表上执行此操作要非常小心。\n\n### 导入/导出\n使用mysqldump工具将数据到出到文件，然后修改文件中create table 语句中的存储引擎的选项，（同时注意修改表名，避免在导入的时候将原表删除，造成数据丢失）。然后导入文件到数据库，这样就得到了一个原表的一个全量复制表。\n\n### 创建与查询\n综合第一种方法的高效和第二种的安全。不需要导出整张表的数据，而是先创建一个新的存储引擎的表，然后利用 insert...select语法来导数据。\n```\nmysql>create table innodb_table like myisam_table;\nmysql>alter table innodb_table engine=innodb;\nmysql>insert into innodb_table select * from myisam_table;\n```\n如果数据量大的话，可以考虑分批处理，并使用事务进行提交操作；\n```\nmysql>start transaction;\nmysql>insert into innodb_table select * from myisam_table where id between x and y;\nmysql>commit;\n```\n如果有必要，在操作的时候可以对原表加锁，以确保新表和原表数据一致。\n这样操作之后也会得到一个对原表的全量复制的表，如果需要还可以删除原表。\n\n\n**Tips：**\nPersona Toolkit 提供了一个 pt-online-schema-change的工具（基于Facebook的在线变更技术），可以比较简单、方便的执行上述过程，避免收工操作可能会带来的错误是繁琐。。。。。。\n","source":"_posts/MySQL存储引擎概述.md","raw":"---\ntitle: MySQL存储引擎概述\ndate: 2016-09-17 23:00:00\ntags:\n- 存储引擎\ncategories:\n- MySQL\n---\n\n基于存储引擎在MySQL架构中的地位，在学习和使用MySQL时我们需要对MySQL的各种存储引擎有一个大概的了解。\n并且知道在实际项目中如何选择适合的存储引擎，以及如何实现不同存储引擎的相互切换。\n\n<!-- more -->\n\n## 存储引擎分类\n\n### InnoDB\nInnoDB，是MySQL的默认事务型引擎，也是做重要、使用最广泛的存储引擎。它的性能和自动崩溃恢复特性，使得它在非事务行存储的需求中也很流行。所以除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。并且InnoDB作为事务型存储引擎，它通过一些机制和工具可以支持真正的热备份，而MySQL其他的存储引擎则不支持热备份。\n\n### MyISAM\n在MySQL 5.1 及之前的版本，MyISAM是MySQL默认的存储引擎。MyISAM提供大量的特性，包括全文索引、压缩、空间函数（GIS）等，但是MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是崩溃后无法安全恢复。尽管MyISAM不支持事务、不支持崩溃后的安全恢复，但是对于一些只读的数据，或者表比较小，可以忍受repair（修复）操作，则依然可以继续使用MyISAM。**但请不要默认使用MyISAM，而是应当默认使用InnoDB**\n\n### Archive\nArchive 存储引擎只支持INSERT 和SELECT 操作，在MySQL 5.1之前还不支持索引。Archive会缓存所有的写并利用zlib对插入的行进行压缩，所以比MyISAM表的磁盘I/O更少。但是每次select操作都需要对全表进行扫描，所以Archive表适合日志和数据采集类应用，或者一些需要更快速insert操作的场合下使用。总之，MyISAM是一个针对告诉插入和压缩做了优化的简单引擎。\n\n### Blackhole\nBlackhole引擎没有实现任何的存储机制，他会丢弃所有的插入的数据，不做任何的保存。但是服务器会记录Blackhole表的日志，所以可以用于复制数据库到备库，或者只是简单地记录到日志。这种特殊的存储引擎可以在一些特殊的复制架构和日志审核时发挥所用。\n\n### CSV\nCSV引擎可以将普通的CSV文件作为MySQL的表来处理，但这种表不支持索引。CSV引擎可以在数据运行是拷入或者烤出文件。可以将Excel等电子表格中的数据存储为CSV文件，然后复制到MySQL数据目录下，然后就能在MySQL中打开使用。因此，CSV引擎可以作为一种数据交换的机制，非常有用。\n\n### Federated\nFederated引擎是访问其他MySQL服务器的一个代理，他会创建一个到远程MySQL服务器的的客户端连接，并将查询传输到远程服务器执行，然后提取或者发送需要的数据。但是尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题。因此默认是禁用的。\n\n### Memory\nMemory表所有的数据都保存在内存中，因此Memory表的访问速度非常的快（至少要比MyISAM快一个数量级），并且不需要磁盘的I/O操作。但是Memory表在系统重启后虽然表结构会保留，但是数据会丢失。\n\nMemory表支持Hash索引，因此查询操作非常快。但是MySQL表采用的表级锁，因此并发写入的性能较低。\n\nMemory表的应用场景：\n- 用于查找（lookup）或者映射（mapping）表。\n- 用于缓存周期性聚合数据的结果。\n- 用于保存数据分析中产生的中间问题。\n\n**Tips：**\n如果MySQL在执行查询的过程中需要使用临时表来保存中间结果，内部使用的临时表就是Memory表。如果中间结果大大超出了Memory表的限制，或者有大量的BLOB或TEXT字段，则临时表会转换成MyISAM表。\n\n### Merge\nMerge引擎是MyISAM的一种变种。Merge表是由多个MyISAM表合并而来的虚拟表。\n\n### NDB\nMySQL服务器、NDB集群引擎、以及分布式的、share-nothing的、容灾的、高可用的NDB数据库组合，被称之为MySQL集群（MySQL Cluster）。\n\n### 其他的第三方存储引擎\nMySQL从07年开始提供了插件式的存储引擎API，从此出现了一系列为不同目的而设计的存储引擎。其中一些已经合并到MySQL服务器，但大多数还是第三方产品或者开源项目。比较有名的有：\n- OLTP类引擎\n- 面向列的存储引擎\n- 社区存储引擎\n\n## 选择合适的存储引擎的考虑因素\n\n不同的应用可能会根据不同的需求而采用不同的存储引擎。那么我们再为应用选择存储引擎时，通常会考虑以下几点：\n- 事务\n引用是否需要事务支持。如果需要，那么InnoDB是目前最稳定且经过验证的选择。如果不需要，并且主要是select和insert操作，那么MyISAM是不错的选择。\n\n- 备份\n如果可以定期的通过关闭服务器来执行备份，那么备份因素就可以忽略。反之，如果需要支持在线热备份，那么选择InnoDB就是基本的要求。\n\n- 崩溃恢复\n相对而言，MyISAM崩溃后发生的数据毁坏的概率要比InnoDB高的多，并且恢复速度也要慢的多。所以，即使不需要事务支持，很多人也会选择InnoDB引擎。\n\n- 特有的特性\n有些应用可能需要一些存储引擎锁独有的特性或者优化，比如依赖聚簇索引的优化，或者需要对地理空间的搜索。\n\n**总之，如无特殊的需求和例外，统统建议选择InnoDB存储引擎。**\n\n## 如何转换表的存储引擎\n有很多中方法可以转换，一般我们会使用以下三种方法：\n### ALTER TABLE\n```sql\nmysql>alter table mytable engine=innodb;\n```\n上述语法可以适应与任何存储引擎。但是当表数据很大时，这种方法将会执行很长时间。MySQL会按行将数据从原表复制到一张新的表中。所以，在繁忙的表上执行此操作要非常小心。\n\n### 导入/导出\n使用mysqldump工具将数据到出到文件，然后修改文件中create table 语句中的存储引擎的选项，（同时注意修改表名，避免在导入的时候将原表删除，造成数据丢失）。然后导入文件到数据库，这样就得到了一个原表的一个全量复制表。\n\n### 创建与查询\n综合第一种方法的高效和第二种的安全。不需要导出整张表的数据，而是先创建一个新的存储引擎的表，然后利用 insert...select语法来导数据。\n```\nmysql>create table innodb_table like myisam_table;\nmysql>alter table innodb_table engine=innodb;\nmysql>insert into innodb_table select * from myisam_table;\n```\n如果数据量大的话，可以考虑分批处理，并使用事务进行提交操作；\n```\nmysql>start transaction;\nmysql>insert into innodb_table select * from myisam_table where id between x and y;\nmysql>commit;\n```\n如果有必要，在操作的时候可以对原表加锁，以确保新表和原表数据一致。\n这样操作之后也会得到一个对原表的全量复制的表，如果需要还可以删除原表。\n\n\n**Tips：**\nPersona Toolkit 提供了一个 pt-online-schema-change的工具（基于Facebook的在线变更技术），可以比较简单、方便的执行上述过程，避免收工操作可能会带来的错误是繁琐。。。。。。\n","slug":"MySQL存储引擎概述","published":1,"updated":"2016-09-17T15:06:38.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvx001q699figec8pkq","content":"<p>基于存储引擎在MySQL架构中的地位，在学习和使用MySQL时我们需要对MySQL的各种存储引擎有一个大概的了解。<br>并且知道在实际项目中如何选择适合的存储引擎，以及如何实现不同存储引擎的相互切换。</p>\n<a id=\"more\"></a>\n<h2 id=\"存储引擎分类\"><a href=\"#存储引擎分类\" class=\"headerlink\" title=\"存储引擎分类\"></a>存储引擎分类</h2><h3 id=\"InnoDB\"><a href=\"#InnoDB\" class=\"headerlink\" title=\"InnoDB\"></a>InnoDB</h3><p>InnoDB，是MySQL的默认事务型引擎，也是做重要、使用最广泛的存储引擎。它的性能和自动崩溃恢复特性，使得它在非事务行存储的需求中也很流行。所以除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。并且InnoDB作为事务型存储引擎，它通过一些机制和工具可以支持真正的热备份，而MySQL其他的存储引擎则不支持热备份。</p>\n<h3 id=\"MyISAM\"><a href=\"#MyISAM\" class=\"headerlink\" title=\"MyISAM\"></a>MyISAM</h3><p>在MySQL 5.1 及之前的版本，MyISAM是MySQL默认的存储引擎。MyISAM提供大量的特性，包括全文索引、压缩、空间函数（GIS）等，但是MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是崩溃后无法安全恢复。尽管MyISAM不支持事务、不支持崩溃后的安全恢复，但是对于一些只读的数据，或者表比较小，可以忍受repair（修复）操作，则依然可以继续使用MyISAM。<strong>但请不要默认使用MyISAM，而是应当默认使用InnoDB</strong></p>\n<h3 id=\"Archive\"><a href=\"#Archive\" class=\"headerlink\" title=\"Archive\"></a>Archive</h3><p>Archive 存储引擎只支持INSERT 和SELECT 操作，在MySQL 5.1之前还不支持索引。Archive会缓存所有的写并利用zlib对插入的行进行压缩，所以比MyISAM表的磁盘I/O更少。但是每次select操作都需要对全表进行扫描，所以Archive表适合日志和数据采集类应用，或者一些需要更快速insert操作的场合下使用。总之，MyISAM是一个针对告诉插入和压缩做了优化的简单引擎。</p>\n<h3 id=\"Blackhole\"><a href=\"#Blackhole\" class=\"headerlink\" title=\"Blackhole\"></a>Blackhole</h3><p>Blackhole引擎没有实现任何的存储机制，他会丢弃所有的插入的数据，不做任何的保存。但是服务器会记录Blackhole表的日志，所以可以用于复制数据库到备库，或者只是简单地记录到日志。这种特殊的存储引擎可以在一些特殊的复制架构和日志审核时发挥所用。</p>\n<h3 id=\"CSV\"><a href=\"#CSV\" class=\"headerlink\" title=\"CSV\"></a>CSV</h3><p>CSV引擎可以将普通的CSV文件作为MySQL的表来处理，但这种表不支持索引。CSV引擎可以在数据运行是拷入或者烤出文件。可以将Excel等电子表格中的数据存储为CSV文件，然后复制到MySQL数据目录下，然后就能在MySQL中打开使用。因此，CSV引擎可以作为一种数据交换的机制，非常有用。</p>\n<h3 id=\"Federated\"><a href=\"#Federated\" class=\"headerlink\" title=\"Federated\"></a>Federated</h3><p>Federated引擎是访问其他MySQL服务器的一个代理，他会创建一个到远程MySQL服务器的的客户端连接，并将查询传输到远程服务器执行，然后提取或者发送需要的数据。但是尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题。因此默认是禁用的。</p>\n<h3 id=\"Memory\"><a href=\"#Memory\" class=\"headerlink\" title=\"Memory\"></a>Memory</h3><p>Memory表所有的数据都保存在内存中，因此Memory表的访问速度非常的快（至少要比MyISAM快一个数量级），并且不需要磁盘的I/O操作。但是Memory表在系统重启后虽然表结构会保留，但是数据会丢失。</p>\n<p>Memory表支持Hash索引，因此查询操作非常快。但是MySQL表采用的表级锁，因此并发写入的性能较低。</p>\n<p>Memory表的应用场景：</p>\n<ul>\n<li>用于查找（lookup）或者映射（mapping）表。</li>\n<li>用于缓存周期性聚合数据的结果。</li>\n<li>用于保存数据分析中产生的中间问题。</li>\n</ul>\n<p><strong>Tips：</strong><br>如果MySQL在执行查询的过程中需要使用临时表来保存中间结果，内部使用的临时表就是Memory表。如果中间结果大大超出了Memory表的限制，或者有大量的BLOB或TEXT字段，则临时表会转换成MyISAM表。</p>\n<h3 id=\"Merge\"><a href=\"#Merge\" class=\"headerlink\" title=\"Merge\"></a>Merge</h3><p>Merge引擎是MyISAM的一种变种。Merge表是由多个MyISAM表合并而来的虚拟表。</p>\n<h3 id=\"NDB\"><a href=\"#NDB\" class=\"headerlink\" title=\"NDB\"></a>NDB</h3><p>MySQL服务器、NDB集群引擎、以及分布式的、share-nothing的、容灾的、高可用的NDB数据库组合，被称之为MySQL集群（MySQL Cluster）。</p>\n<h3 id=\"其他的第三方存储引擎\"><a href=\"#其他的第三方存储引擎\" class=\"headerlink\" title=\"其他的第三方存储引擎\"></a>其他的第三方存储引擎</h3><p>MySQL从07年开始提供了插件式的存储引擎API，从此出现了一系列为不同目的而设计的存储引擎。其中一些已经合并到MySQL服务器，但大多数还是第三方产品或者开源项目。比较有名的有：</p>\n<ul>\n<li>OLTP类引擎</li>\n<li>面向列的存储引擎</li>\n<li>社区存储引擎</li>\n</ul>\n<h2 id=\"选择合适的存储引擎的考虑因素\"><a href=\"#选择合适的存储引擎的考虑因素\" class=\"headerlink\" title=\"选择合适的存储引擎的考虑因素\"></a>选择合适的存储引擎的考虑因素</h2><p>不同的应用可能会根据不同的需求而采用不同的存储引擎。那么我们再为应用选择存储引擎时，通常会考虑以下几点：</p>\n<ul>\n<li><p>事务<br>引用是否需要事务支持。如果需要，那么InnoDB是目前最稳定且经过验证的选择。如果不需要，并且主要是select和insert操作，那么MyISAM是不错的选择。</p>\n</li>\n<li><p>备份<br>如果可以定期的通过关闭服务器来执行备份，那么备份因素就可以忽略。反之，如果需要支持在线热备份，那么选择InnoDB就是基本的要求。</p>\n</li>\n<li><p>崩溃恢复<br>相对而言，MyISAM崩溃后发生的数据毁坏的概率要比InnoDB高的多，并且恢复速度也要慢的多。所以，即使不需要事务支持，很多人也会选择InnoDB引擎。</p>\n</li>\n<li><p>特有的特性<br>有些应用可能需要一些存储引擎锁独有的特性或者优化，比如依赖聚簇索引的优化，或者需要对地理空间的搜索。</p>\n</li>\n</ul>\n<p><strong>总之，如无特殊的需求和例外，统统建议选择InnoDB存储引擎。</strong></p>\n<h2 id=\"如何转换表的存储引擎\"><a href=\"#如何转换表的存储引擎\" class=\"headerlink\" title=\"如何转换表的存储引擎\"></a>如何转换表的存储引擎</h2><p>有很多中方法可以转换，一般我们会使用以下三种方法：</p>\n<h3 id=\"ALTER-TABLE\"><a href=\"#ALTER-TABLE\" class=\"headerlink\" title=\"ALTER TABLE\"></a>ALTER TABLE</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt;alter table mytable engine=innodb;</div></pre></td></tr></table></figure>\n<p>上述语法可以适应与任何存储引擎。但是当表数据很大时，这种方法将会执行很长时间。MySQL会按行将数据从原表复制到一张新的表中。所以，在繁忙的表上执行此操作要非常小心。</p>\n<h3 id=\"导入-导出\"><a href=\"#导入-导出\" class=\"headerlink\" title=\"导入/导出\"></a>导入/导出</h3><p>使用mysqldump工具将数据到出到文件，然后修改文件中create table 语句中的存储引擎的选项，（同时注意修改表名，避免在导入的时候将原表删除，造成数据丢失）。然后导入文件到数据库，这样就得到了一个原表的一个全量复制表。</p>\n<h3 id=\"创建与查询\"><a href=\"#创建与查询\" class=\"headerlink\" title=\"创建与查询\"></a>创建与查询</h3><p>综合第一种方法的高效和第二种的安全。不需要导出整张表的数据，而是先创建一个新的存储引擎的表，然后利用 insert…select语法来导数据。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt;create table innodb_table like myisam_table;</div><div class=\"line\">mysql&gt;alter table innodb_table engine=innodb;</div><div class=\"line\">mysql&gt;insert into innodb_table select * from myisam_table;</div></pre></td></tr></table></figure></p>\n<p>如果数据量大的话，可以考虑分批处理，并使用事务进行提交操作；<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt;start transaction;</div><div class=\"line\">mysql&gt;insert into innodb_table select * from myisam_table where id between x and y;</div><div class=\"line\">mysql&gt;commit;</div></pre></td></tr></table></figure></p>\n<p>如果有必要，在操作的时候可以对原表加锁，以确保新表和原表数据一致。<br>这样操作之后也会得到一个对原表的全量复制的表，如果需要还可以删除原表。</p>\n<p><strong>Tips：</strong><br>Persona Toolkit 提供了一个 pt-online-schema-change的工具（基于Facebook的在线变更技术），可以比较简单、方便的执行上述过程，避免收工操作可能会带来的错误是繁琐。。。。。。</p>\n","excerpt":"<p>基于存储引擎在MySQL架构中的地位，在学习和使用MySQL时我们需要对MySQL的各种存储引擎有一个大概的了解。<br>并且知道在实际项目中如何选择适合的存储引擎，以及如何实现不同存储引擎的相互切换。</p>","more":"<h2 id=\"存储引擎分类\"><a href=\"#存储引擎分类\" class=\"headerlink\" title=\"存储引擎分类\"></a>存储引擎分类</h2><h3 id=\"InnoDB\"><a href=\"#InnoDB\" class=\"headerlink\" title=\"InnoDB\"></a>InnoDB</h3><p>InnoDB，是MySQL的默认事务型引擎，也是做重要、使用最广泛的存储引擎。它的性能和自动崩溃恢复特性，使得它在非事务行存储的需求中也很流行。所以除非有非常特别的原因需要使用其他的存储引擎，否则应该优先考虑InnoDB引擎。并且InnoDB作为事务型存储引擎，它通过一些机制和工具可以支持真正的热备份，而MySQL其他的存储引擎则不支持热备份。</p>\n<h3 id=\"MyISAM\"><a href=\"#MyISAM\" class=\"headerlink\" title=\"MyISAM\"></a>MyISAM</h3><p>在MySQL 5.1 及之前的版本，MyISAM是MySQL默认的存储引擎。MyISAM提供大量的特性，包括全文索引、压缩、空间函数（GIS）等，但是MyISAM不支持事务和行级锁，而且有一个毫无疑问的缺陷就是崩溃后无法安全恢复。尽管MyISAM不支持事务、不支持崩溃后的安全恢复，但是对于一些只读的数据，或者表比较小，可以忍受repair（修复）操作，则依然可以继续使用MyISAM。<strong>但请不要默认使用MyISAM，而是应当默认使用InnoDB</strong></p>\n<h3 id=\"Archive\"><a href=\"#Archive\" class=\"headerlink\" title=\"Archive\"></a>Archive</h3><p>Archive 存储引擎只支持INSERT 和SELECT 操作，在MySQL 5.1之前还不支持索引。Archive会缓存所有的写并利用zlib对插入的行进行压缩，所以比MyISAM表的磁盘I/O更少。但是每次select操作都需要对全表进行扫描，所以Archive表适合日志和数据采集类应用，或者一些需要更快速insert操作的场合下使用。总之，MyISAM是一个针对告诉插入和压缩做了优化的简单引擎。</p>\n<h3 id=\"Blackhole\"><a href=\"#Blackhole\" class=\"headerlink\" title=\"Blackhole\"></a>Blackhole</h3><p>Blackhole引擎没有实现任何的存储机制，他会丢弃所有的插入的数据，不做任何的保存。但是服务器会记录Blackhole表的日志，所以可以用于复制数据库到备库，或者只是简单地记录到日志。这种特殊的存储引擎可以在一些特殊的复制架构和日志审核时发挥所用。</p>\n<h3 id=\"CSV\"><a href=\"#CSV\" class=\"headerlink\" title=\"CSV\"></a>CSV</h3><p>CSV引擎可以将普通的CSV文件作为MySQL的表来处理，但这种表不支持索引。CSV引擎可以在数据运行是拷入或者烤出文件。可以将Excel等电子表格中的数据存储为CSV文件，然后复制到MySQL数据目录下，然后就能在MySQL中打开使用。因此，CSV引擎可以作为一种数据交换的机制，非常有用。</p>\n<h3 id=\"Federated\"><a href=\"#Federated\" class=\"headerlink\" title=\"Federated\"></a>Federated</h3><p>Federated引擎是访问其他MySQL服务器的一个代理，他会创建一个到远程MySQL服务器的的客户端连接，并将查询传输到远程服务器执行，然后提取或者发送需要的数据。但是尽管该引擎看起来提供了一种很好的跨服务器的灵活性，但也经常带来问题。因此默认是禁用的。</p>\n<h3 id=\"Memory\"><a href=\"#Memory\" class=\"headerlink\" title=\"Memory\"></a>Memory</h3><p>Memory表所有的数据都保存在内存中，因此Memory表的访问速度非常的快（至少要比MyISAM快一个数量级），并且不需要磁盘的I/O操作。但是Memory表在系统重启后虽然表结构会保留，但是数据会丢失。</p>\n<p>Memory表支持Hash索引，因此查询操作非常快。但是MySQL表采用的表级锁，因此并发写入的性能较低。</p>\n<p>Memory表的应用场景：</p>\n<ul>\n<li>用于查找（lookup）或者映射（mapping）表。</li>\n<li>用于缓存周期性聚合数据的结果。</li>\n<li>用于保存数据分析中产生的中间问题。</li>\n</ul>\n<p><strong>Tips：</strong><br>如果MySQL在执行查询的过程中需要使用临时表来保存中间结果，内部使用的临时表就是Memory表。如果中间结果大大超出了Memory表的限制，或者有大量的BLOB或TEXT字段，则临时表会转换成MyISAM表。</p>\n<h3 id=\"Merge\"><a href=\"#Merge\" class=\"headerlink\" title=\"Merge\"></a>Merge</h3><p>Merge引擎是MyISAM的一种变种。Merge表是由多个MyISAM表合并而来的虚拟表。</p>\n<h3 id=\"NDB\"><a href=\"#NDB\" class=\"headerlink\" title=\"NDB\"></a>NDB</h3><p>MySQL服务器、NDB集群引擎、以及分布式的、share-nothing的、容灾的、高可用的NDB数据库组合，被称之为MySQL集群（MySQL Cluster）。</p>\n<h3 id=\"其他的第三方存储引擎\"><a href=\"#其他的第三方存储引擎\" class=\"headerlink\" title=\"其他的第三方存储引擎\"></a>其他的第三方存储引擎</h3><p>MySQL从07年开始提供了插件式的存储引擎API，从此出现了一系列为不同目的而设计的存储引擎。其中一些已经合并到MySQL服务器，但大多数还是第三方产品或者开源项目。比较有名的有：</p>\n<ul>\n<li>OLTP类引擎</li>\n<li>面向列的存储引擎</li>\n<li>社区存储引擎</li>\n</ul>\n<h2 id=\"选择合适的存储引擎的考虑因素\"><a href=\"#选择合适的存储引擎的考虑因素\" class=\"headerlink\" title=\"选择合适的存储引擎的考虑因素\"></a>选择合适的存储引擎的考虑因素</h2><p>不同的应用可能会根据不同的需求而采用不同的存储引擎。那么我们再为应用选择存储引擎时，通常会考虑以下几点：</p>\n<ul>\n<li><p>事务<br>引用是否需要事务支持。如果需要，那么InnoDB是目前最稳定且经过验证的选择。如果不需要，并且主要是select和insert操作，那么MyISAM是不错的选择。</p>\n</li>\n<li><p>备份<br>如果可以定期的通过关闭服务器来执行备份，那么备份因素就可以忽略。反之，如果需要支持在线热备份，那么选择InnoDB就是基本的要求。</p>\n</li>\n<li><p>崩溃恢复<br>相对而言，MyISAM崩溃后发生的数据毁坏的概率要比InnoDB高的多，并且恢复速度也要慢的多。所以，即使不需要事务支持，很多人也会选择InnoDB引擎。</p>\n</li>\n<li><p>特有的特性<br>有些应用可能需要一些存储引擎锁独有的特性或者优化，比如依赖聚簇索引的优化，或者需要对地理空间的搜索。</p>\n</li>\n</ul>\n<p><strong>总之，如无特殊的需求和例外，统统建议选择InnoDB存储引擎。</strong></p>\n<h2 id=\"如何转换表的存储引擎\"><a href=\"#如何转换表的存储引擎\" class=\"headerlink\" title=\"如何转换表的存储引擎\"></a>如何转换表的存储引擎</h2><p>有很多中方法可以转换，一般我们会使用以下三种方法：</p>\n<h3 id=\"ALTER-TABLE\"><a href=\"#ALTER-TABLE\" class=\"headerlink\" title=\"ALTER TABLE\"></a>ALTER TABLE</h3><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt;alter table mytable engine=innodb;</div></pre></td></tr></table></figure>\n<p>上述语法可以适应与任何存储引擎。但是当表数据很大时，这种方法将会执行很长时间。MySQL会按行将数据从原表复制到一张新的表中。所以，在繁忙的表上执行此操作要非常小心。</p>\n<h3 id=\"导入-导出\"><a href=\"#导入-导出\" class=\"headerlink\" title=\"导入/导出\"></a>导入/导出</h3><p>使用mysqldump工具将数据到出到文件，然后修改文件中create table 语句中的存储引擎的选项，（同时注意修改表名，避免在导入的时候将原表删除，造成数据丢失）。然后导入文件到数据库，这样就得到了一个原表的一个全量复制表。</p>\n<h3 id=\"创建与查询\"><a href=\"#创建与查询\" class=\"headerlink\" title=\"创建与查询\"></a>创建与查询</h3><p>综合第一种方法的高效和第二种的安全。不需要导出整张表的数据，而是先创建一个新的存储引擎的表，然后利用 insert…select语法来导数据。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt;create table innodb_table like myisam_table;</div><div class=\"line\">mysql&gt;alter table innodb_table engine=innodb;</div><div class=\"line\">mysql&gt;insert into innodb_table select * from myisam_table;</div></pre></td></tr></table></figure></p>\n<p>如果数据量大的话，可以考虑分批处理，并使用事务进行提交操作；<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt;start transaction;</div><div class=\"line\">mysql&gt;insert into innodb_table select * from myisam_table where id between x and y;</div><div class=\"line\">mysql&gt;commit;</div></pre></td></tr></table></figure></p>\n<p>如果有必要，在操作的时候可以对原表加锁，以确保新表和原表数据一致。<br>这样操作之后也会得到一个对原表的全量复制的表，如果需要还可以删除原表。</p>\n<p><strong>Tips：</strong><br>Persona Toolkit 提供了一个 pt-online-schema-change的工具（基于Facebook的在线变更技术），可以比较简单、方便的执行上述过程，避免收工操作可能会带来的错误是繁琐。。。。。。</p>"},{"title":"Memcached分布式部署算法整理","date":"2016-10-01T12:00:00.000Z","ctime":"2016-10-01T12:00:00.000Z","utime":"2016-10-01T12:00:00.000Z","modif_times":0,"_content":"虽然memcached是一个高性能的缓存服务器，但是单台服务器对于目前大型的web应用来说还是满足不了需求的。那么就需要布置多台的memcached服务器进行分布式部署。那么一个数据应该存储到哪一台服务器就需要一个分布算法来确定。\n\n常见的分布方案有两种，\n> - 普通Hash分布\n> - 一致性Hash分布\n\n<!-- more -->\n\n## 普通Hash分布\n> 俗称哈希取模法，优点是实现简单，但缺点是缺乏灵活性（比如增加一台服务器，那么之前存储的数据的键值和具体的物理机之间的关系就被完全打乱了，即之前存储的数据就完全失效了）。\n\n### 原理：\nH(key) = hash(key)mod K;\n> 假设有K台物理机，对于key为键值的记录，H(key)值即为存储数据的物理机编号。通过这种方式，就将全部数据分配到K台物理机上，而查找某条记录时，使用同样的Hash函数就可以找到对应的物理机。\n\n### 实现(PHP)：\n```php\n<?php\n  $servers = array(\n    array(\"host\" => \"192.168.1.1\",\"port\" => \"11211\"),\n    array(\"host\" => \"192.168.1.2\",\"port\" => \"11211\"),\n  );\n  $key = \"userDatakey\";\n  $value = \"userDataValue\";\n  $mc_ser = new $servers[mhash($key)%2];\n  $mc = new Memcache($servers);\n  $mc->set($key, $value);\n  var_dump($mc->get($key));\n\n  /**\n   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]\n   * @param  {[type]} $key [description]\n   * @return {[type]}      [description]\n   */\n  function mhash($key){\n    $md5 = substr(md5($key), 0, 8);\n    $seed = 31;\n    $hash = 0;\n    for($i=0;$i<8;$i++){\n      $hash = $hash*$seed + ord($md5{$i});\n    }\n    return $hash & 0x7FFFFFFF;\n  }\n```\n通过Hash函数把key转化成整数后，利用这个整数与服务器数量取模，得到其中一台的服务器配置。然后利用这个配置完成memcached服务器的连接操作。这样就完成了对数据的分布式存储。\n\n## 一致性Hash分布\n> 一致性hash分布是算法，是P2P网络和分布式存储中常用到一项技术。是一种当服务器有增删时，对数据影响最小的一种部署方案。\n\n一致性Hash算法实现：\n### 将一个32位整数（0~2^32-1）想象成一个闭环。\n如图，\n![将32位整数想象成一个闭环](http://n.sinaimg.cn/games/3ece443e/20161001/hash_1.png)\n### 通过Hash函数将key处理成整数\n```\n$key1 = mhash(\"key1\");\n$key2 = mhash(\"key2\");\n$key3 = mhash(\"key3\");\n$key4 = mhash(\"key4\");\n```\n将key通过mhash函数处理成整数，让后就可以将之对应到闭环上。如图，\n![4个key通过mhash处理成整数对应到闭环上](http://n.sinaimg.cn/games/3ece443e/20161001/hash_2.png)\n### 将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\n例如，有三台服务器，IP分别是192.168.1.1、192.168.1.2、192.168.1.3\n```\n$server1 = mhash(\"192.168.1.1\");\n$server2 = mhash(\"192.168.1.2\");\n$server3 = mhash(\"192.168.1.3\");\n```\n如图，\n![将服务器也映射到环上](http://n.sinaimg.cn/games/3ece443e/20161001/hash_server.png)\n\n### 把数据映射到服务器上\n**映射方法：**\n沿着圆环的顺时针方向的key出发，直到遇上一个服务器，将key对应的数据存储到这个服务器上。\n\n如图，\n![把数据映射到服务器上](http://n.sinaimg.cn/games/3ece443e/20161001/hash_3.png)\n\n### 移除服务器\n假设服务器 server2 崩溃了，那么受影响的仅是哪些hash映射值在server1到server2的值。\n\n如图，受影响的只有key2，它将会重新映射到server3服务器上。\n![移除服务器](http://n.sinaimg.cn/games/3ece443e/20161001/hash_4.png)\n\n### 添加服务器\n如果现在需要新添加一台服务器，其IP地址为（192.168.1.4）\n```\n$server4 = mhash(\"192.168.1.4\");\n```\n其在闭环上的映射位置位于如图的位置，那么受影响是hash映射值在其当前的位置和server2的位置之间的key。\n\n如图，受影响的仅为key3，其将会重新映射到server4上。\n![添加服务器](http://n.sinaimg.cn/games/3ece443e/20161001/hash_5.png)\n\n### 实现（PHP）\n```php\n<?php\nclass FlexiHash{\n  private $serverList = array();\n  private $isSorted = false;\n\n  /**\n   * [addServer 通过hash函数计算除服务器的Hash值，通过此hash值定位服务器列表的某个位置，然后将服务器排序标识置为false]\n   * @param {[type]} $server [description]\n   */\n  function addServer($server){\n    $hash = $this->mhash($server);\n\n    if(!isset($this->serverList[$hash])){\n      $this->serverList[$hash] = $server;\n    }\n\n    $this->isSorted = false;\n    return true;\n  }\n\n  /**\n   * [removeServer 跟addServer实现差不多，将server删除，并将排序标识置为false]\n   * @param  {[type]} $server [description]\n   * @return {[type]}         [description]\n   */\n  function removeServer($server){\n    $hash = $this->mhash($server);\n\n    if(!isset($this->serverList[$hash])){\n      unset($this->serverList[$hash]);\n    }\n\n    $this->isSorted = false;\n    return true;\n  }\n\n  /**\n   * [lookup 先计算除key的hash值，然后判断serverList是排序过，如果没有，就先对服务器列表进行倒序排序操作。倒序排序的作用是把服务器列表转换成一个逆时针的圆环。然后遍历服务器列表，找到一个合适的服务器返回]\n   * @param  {[type]} $key [description]\n   * @return {[type]}      [description]\n   */\n  function lookup($key){\n    $hash = $this->mhash($key);\n\n    if(!$this->isSorted){\n      ksort($this->serverList, SORT_NUMERIC);\n      $this->isSorted = true;\n    }\n\n    foreach($this->serverList as $pos => $server){\n      if($hash >= $pos){\n        return $server;\n      }\n    }\n\n    return $this->serverList[count($this->serverList) - 1];\n  }\n\n  /**\n   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]\n   * @param  {[type]} $key [description]\n   * @return {[type]}      [description]\n   */\n  function mhash($key){\n    $md5 = substr(md5($key), 0, 8);\n    $seed = 31;\n    $hash = 0;\n    for($i=0;$i<8;$i++){\n      $hash = $hash*$seed + ord($md5{$i});\n    }\n    return $hash & 0x7FFFFFFF;\n  }\n\n}\n\n```\n测试\n```php\n<?php\n  $hserver = new FlexiHash();\n\n  $hserver->addServer(\"192.168.1.1\");\n  $hserver->addServer(\"192.168.1.2\");\n  $hserver->addServer(\"192.168.1.3\");\n  $hserver->addServer(\"192.168.1.4\");\n  $hserver->addServer(\"192.168.1.5\");\n\n  echo \"save key1 in server:\".$hserver->lookup(\"key1\");\n  echo \"save key2 in server:\".$hserver->lookup(\"key2\");\n  echo \"==============================================;\n\n  $hserver->removeServer(\"192.168.1.4\");\n  echo \"save key1 in server:\".$hserver->lookup(\"key1\");\n  echo \"save key2 in server:\".$hserver->lookup(\"key2\");\n  echo \"==============================================;\n\n  $hserver->addServer(\"192.168.1.6\");\n  echo \"save key1 in server:\".$hserver->lookup(\"key1\");\n  echo \"save key2 in server:\".$hserver->lookup(\"key2\");\n  echo \"==============================================;  \n?>\n```\n通过测试结果可以看出，在增加或者减少memcached服务器的时候，一致性hash算法只会改变很少的一部分数据的存储服务器，从而能够实现最大限度的减少数据丢失的情况。\n\n## 实际应用（PHP）\n在实际应用当中，PHP提供了两种的关于Memcached的扩展，memcache和memcached。两种扩展中都可以设置采用哪种分布方式，我们只需要选择我们要采用的策略并修改配置即可，而不需要我们自己来实现具体的分布算法。\n\n**memcache扩展配置**\n\n控制key到服务器的映射（分布式）策略。 php.ini 配置\n```ini\n[Memcache]\nMemcache.allow_failover = 1\nmemcache.max_failover_attempts = 2\nMemcache.hash_strategy =consistent\nMemcache.hash_function =crc32\n\n```\nMemcache.allow_failover\n> 是否在发生错误时（对用户）透明的转移到其他服务器。\n\nmemcache.max_failover_attempts\n> 定义在写入和获取数据时最多尝试的服务器次数（即：故障转移最大尝试数），仅和 memcache.allow_failover结合使用。\n\nMemcache.hash_strategy\n> 控制key到服务器的映射（分布式）策略。\n\n- consistent，采用一致性hash分布策略实现映射\n- standard，采用普通hash分布策略实现映射\n\nmemcache.hash_function\n> 控制在key-server映射时使用哪个hash函数crc32 标明使用标准CRC32进行hash，fnv则说明使用FNV-1a。\n\n\n**memcached扩展配置**\n```\n<?php\n  $mem = new memcached();\n  $mem->setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);\n  $mem->setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);\n```\n\nMemcached::OPT_DISTRIBUTION\n> 指定元素key分布到各个服务器的方法。当前支持的方法有余数分步法合一致性hash算法两种。一致性hash算法提供 了更好的分配策略并且在添加服务器到集群时可以最小化缓存丢失。\n>类型: integer, 默认: Memcached::DISTRIBUTION_MODULA.\n\nMemcached::DISTRIBUTION_MODULA\n> 余数分布算法。\n\nMemcached::DISTRIBUTION_CONSISTENT\n> 一致性分布算法(基于libketama).\n\nMemcached::OPT_LIBKETAMA_COMPATIBLE\n> 开启或关闭兼容的libketama类行为。当开启此选项后，元素key的hash算法将会被设置为md5并且分布算法将会 采用带有权重的一致性hash分布。这一点非常有用因为其他基于libketama的客户端（比如python，urby）在同样 的服务端配置下可以透明的访问key。\n>\n> **Note:**\n> 如果你要使用一致性hash算法强烈建议开启此选项，并且这个选项可能在未来的发布版中被设置为默认开启。\n类型: boolean, 默认: FALSE.\n","source":"_posts/Memcached分布式部署算法整理.md","raw":"---\ntitle: Memcached分布式部署算法整理\ndate: 2016-10-01 20:00:00\nctime: 2016-10-01 20:00:00\nutime: 2016-10-01 20:00:00\nmodif_times: 0\ntags:\n- 分布式部署算法\ncategories:\n- Linux\n---\n虽然memcached是一个高性能的缓存服务器，但是单台服务器对于目前大型的web应用来说还是满足不了需求的。那么就需要布置多台的memcached服务器进行分布式部署。那么一个数据应该存储到哪一台服务器就需要一个分布算法来确定。\n\n常见的分布方案有两种，\n> - 普通Hash分布\n> - 一致性Hash分布\n\n<!-- more -->\n\n## 普通Hash分布\n> 俗称哈希取模法，优点是实现简单，但缺点是缺乏灵活性（比如增加一台服务器，那么之前存储的数据的键值和具体的物理机之间的关系就被完全打乱了，即之前存储的数据就完全失效了）。\n\n### 原理：\nH(key) = hash(key)mod K;\n> 假设有K台物理机，对于key为键值的记录，H(key)值即为存储数据的物理机编号。通过这种方式，就将全部数据分配到K台物理机上，而查找某条记录时，使用同样的Hash函数就可以找到对应的物理机。\n\n### 实现(PHP)：\n```php\n<?php\n  $servers = array(\n    array(\"host\" => \"192.168.1.1\",\"port\" => \"11211\"),\n    array(\"host\" => \"192.168.1.2\",\"port\" => \"11211\"),\n  );\n  $key = \"userDatakey\";\n  $value = \"userDataValue\";\n  $mc_ser = new $servers[mhash($key)%2];\n  $mc = new Memcache($servers);\n  $mc->set($key, $value);\n  var_dump($mc->get($key));\n\n  /**\n   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]\n   * @param  {[type]} $key [description]\n   * @return {[type]}      [description]\n   */\n  function mhash($key){\n    $md5 = substr(md5($key), 0, 8);\n    $seed = 31;\n    $hash = 0;\n    for($i=0;$i<8;$i++){\n      $hash = $hash*$seed + ord($md5{$i});\n    }\n    return $hash & 0x7FFFFFFF;\n  }\n```\n通过Hash函数把key转化成整数后，利用这个整数与服务器数量取模，得到其中一台的服务器配置。然后利用这个配置完成memcached服务器的连接操作。这样就完成了对数据的分布式存储。\n\n## 一致性Hash分布\n> 一致性hash分布是算法，是P2P网络和分布式存储中常用到一项技术。是一种当服务器有增删时，对数据影响最小的一种部署方案。\n\n一致性Hash算法实现：\n### 将一个32位整数（0~2^32-1）想象成一个闭环。\n如图，\n![将32位整数想象成一个闭环](http://n.sinaimg.cn/games/3ece443e/20161001/hash_1.png)\n### 通过Hash函数将key处理成整数\n```\n$key1 = mhash(\"key1\");\n$key2 = mhash(\"key2\");\n$key3 = mhash(\"key3\");\n$key4 = mhash(\"key4\");\n```\n将key通过mhash函数处理成整数，让后就可以将之对应到闭环上。如图，\n![4个key通过mhash处理成整数对应到闭环上](http://n.sinaimg.cn/games/3ece443e/20161001/hash_2.png)\n### 将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\n例如，有三台服务器，IP分别是192.168.1.1、192.168.1.2、192.168.1.3\n```\n$server1 = mhash(\"192.168.1.1\");\n$server2 = mhash(\"192.168.1.2\");\n$server3 = mhash(\"192.168.1.3\");\n```\n如图，\n![将服务器也映射到环上](http://n.sinaimg.cn/games/3ece443e/20161001/hash_server.png)\n\n### 把数据映射到服务器上\n**映射方法：**\n沿着圆环的顺时针方向的key出发，直到遇上一个服务器，将key对应的数据存储到这个服务器上。\n\n如图，\n![把数据映射到服务器上](http://n.sinaimg.cn/games/3ece443e/20161001/hash_3.png)\n\n### 移除服务器\n假设服务器 server2 崩溃了，那么受影响的仅是哪些hash映射值在server1到server2的值。\n\n如图，受影响的只有key2，它将会重新映射到server3服务器上。\n![移除服务器](http://n.sinaimg.cn/games/3ece443e/20161001/hash_4.png)\n\n### 添加服务器\n如果现在需要新添加一台服务器，其IP地址为（192.168.1.4）\n```\n$server4 = mhash(\"192.168.1.4\");\n```\n其在闭环上的映射位置位于如图的位置，那么受影响是hash映射值在其当前的位置和server2的位置之间的key。\n\n如图，受影响的仅为key3，其将会重新映射到server4上。\n![添加服务器](http://n.sinaimg.cn/games/3ece443e/20161001/hash_5.png)\n\n### 实现（PHP）\n```php\n<?php\nclass FlexiHash{\n  private $serverList = array();\n  private $isSorted = false;\n\n  /**\n   * [addServer 通过hash函数计算除服务器的Hash值，通过此hash值定位服务器列表的某个位置，然后将服务器排序标识置为false]\n   * @param {[type]} $server [description]\n   */\n  function addServer($server){\n    $hash = $this->mhash($server);\n\n    if(!isset($this->serverList[$hash])){\n      $this->serverList[$hash] = $server;\n    }\n\n    $this->isSorted = false;\n    return true;\n  }\n\n  /**\n   * [removeServer 跟addServer实现差不多，将server删除，并将排序标识置为false]\n   * @param  {[type]} $server [description]\n   * @return {[type]}         [description]\n   */\n  function removeServer($server){\n    $hash = $this->mhash($server);\n\n    if(!isset($this->serverList[$hash])){\n      unset($this->serverList[$hash]);\n    }\n\n    $this->isSorted = false;\n    return true;\n  }\n\n  /**\n   * [lookup 先计算除key的hash值，然后判断serverList是排序过，如果没有，就先对服务器列表进行倒序排序操作。倒序排序的作用是把服务器列表转换成一个逆时针的圆环。然后遍历服务器列表，找到一个合适的服务器返回]\n   * @param  {[type]} $key [description]\n   * @return {[type]}      [description]\n   */\n  function lookup($key){\n    $hash = $this->mhash($key);\n\n    if(!$this->isSorted){\n      ksort($this->serverList, SORT_NUMERIC);\n      $this->isSorted = true;\n    }\n\n    foreach($this->serverList as $pos => $server){\n      if($hash >= $pos){\n        return $server;\n      }\n    }\n\n    return $this->serverList[count($this->serverList) - 1];\n  }\n\n  /**\n   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]\n   * @param  {[type]} $key [description]\n   * @return {[type]}      [description]\n   */\n  function mhash($key){\n    $md5 = substr(md5($key), 0, 8);\n    $seed = 31;\n    $hash = 0;\n    for($i=0;$i<8;$i++){\n      $hash = $hash*$seed + ord($md5{$i});\n    }\n    return $hash & 0x7FFFFFFF;\n  }\n\n}\n\n```\n测试\n```php\n<?php\n  $hserver = new FlexiHash();\n\n  $hserver->addServer(\"192.168.1.1\");\n  $hserver->addServer(\"192.168.1.2\");\n  $hserver->addServer(\"192.168.1.3\");\n  $hserver->addServer(\"192.168.1.4\");\n  $hserver->addServer(\"192.168.1.5\");\n\n  echo \"save key1 in server:\".$hserver->lookup(\"key1\");\n  echo \"save key2 in server:\".$hserver->lookup(\"key2\");\n  echo \"==============================================;\n\n  $hserver->removeServer(\"192.168.1.4\");\n  echo \"save key1 in server:\".$hserver->lookup(\"key1\");\n  echo \"save key2 in server:\".$hserver->lookup(\"key2\");\n  echo \"==============================================;\n\n  $hserver->addServer(\"192.168.1.6\");\n  echo \"save key1 in server:\".$hserver->lookup(\"key1\");\n  echo \"save key2 in server:\".$hserver->lookup(\"key2\");\n  echo \"==============================================;  \n?>\n```\n通过测试结果可以看出，在增加或者减少memcached服务器的时候，一致性hash算法只会改变很少的一部分数据的存储服务器，从而能够实现最大限度的减少数据丢失的情况。\n\n## 实际应用（PHP）\n在实际应用当中，PHP提供了两种的关于Memcached的扩展，memcache和memcached。两种扩展中都可以设置采用哪种分布方式，我们只需要选择我们要采用的策略并修改配置即可，而不需要我们自己来实现具体的分布算法。\n\n**memcache扩展配置**\n\n控制key到服务器的映射（分布式）策略。 php.ini 配置\n```ini\n[Memcache]\nMemcache.allow_failover = 1\nmemcache.max_failover_attempts = 2\nMemcache.hash_strategy =consistent\nMemcache.hash_function =crc32\n\n```\nMemcache.allow_failover\n> 是否在发生错误时（对用户）透明的转移到其他服务器。\n\nmemcache.max_failover_attempts\n> 定义在写入和获取数据时最多尝试的服务器次数（即：故障转移最大尝试数），仅和 memcache.allow_failover结合使用。\n\nMemcache.hash_strategy\n> 控制key到服务器的映射（分布式）策略。\n\n- consistent，采用一致性hash分布策略实现映射\n- standard，采用普通hash分布策略实现映射\n\nmemcache.hash_function\n> 控制在key-server映射时使用哪个hash函数crc32 标明使用标准CRC32进行hash，fnv则说明使用FNV-1a。\n\n\n**memcached扩展配置**\n```\n<?php\n  $mem = new memcached();\n  $mem->setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);\n  $mem->setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);\n```\n\nMemcached::OPT_DISTRIBUTION\n> 指定元素key分布到各个服务器的方法。当前支持的方法有余数分步法合一致性hash算法两种。一致性hash算法提供 了更好的分配策略并且在添加服务器到集群时可以最小化缓存丢失。\n>类型: integer, 默认: Memcached::DISTRIBUTION_MODULA.\n\nMemcached::DISTRIBUTION_MODULA\n> 余数分布算法。\n\nMemcached::DISTRIBUTION_CONSISTENT\n> 一致性分布算法(基于libketama).\n\nMemcached::OPT_LIBKETAMA_COMPATIBLE\n> 开启或关闭兼容的libketama类行为。当开启此选项后，元素key的hash算法将会被设置为md5并且分布算法将会 采用带有权重的一致性hash分布。这一点非常有用因为其他基于libketama的客户端（比如python，urby）在同样 的服务端配置下可以透明的访问key。\n>\n> **Note:**\n> 如果你要使用一致性hash算法强烈建议开启此选项，并且这个选项可能在未来的发布版中被设置为默认开启。\n类型: boolean, 默认: FALSE.\n","slug":"Memcached分布式部署算法整理","published":1,"updated":"2016-10-01T10:05:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwvz001t699fws52jihw","content":"<p>虽然memcached是一个高性能的缓存服务器，但是单台服务器对于目前大型的web应用来说还是满足不了需求的。那么就需要布置多台的memcached服务器进行分布式部署。那么一个数据应该存储到哪一台服务器就需要一个分布算法来确定。</p>\n<p>常见的分布方案有两种，</p>\n<blockquote>\n<ul>\n<li>普通Hash分布</li>\n<li>一致性Hash分布</li>\n</ul>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"普通Hash分布\"><a href=\"#普通Hash分布\" class=\"headerlink\" title=\"普通Hash分布\"></a>普通Hash分布</h2><blockquote>\n<p>俗称哈希取模法，优点是实现简单，但缺点是缺乏灵活性（比如增加一台服务器，那么之前存储的数据的键值和具体的物理机之间的关系就被完全打乱了，即之前存储的数据就完全失效了）。</p>\n</blockquote>\n<h3 id=\"原理：\"><a href=\"#原理：\" class=\"headerlink\" title=\"原理：\"></a>原理：</h3><p>H(key) = hash(key)mod K;</p>\n<blockquote>\n<p>假设有K台物理机，对于key为键值的记录，H(key)值即为存储数据的物理机编号。通过这种方式，就将全部数据分配到K台物理机上，而查找某条记录时，使用同样的Hash函数就可以找到对应的物理机。</p>\n</blockquote>\n<h3 id=\"实现-PHP-：\"><a href=\"#实现-PHP-：\" class=\"headerlink\" title=\"实现(PHP)：\"></a>实现(PHP)：</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  $servers = <span class=\"keyword\">array</span>(</div><div class=\"line\">    <span class=\"keyword\">array</span>(<span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.1\"</span>,<span class=\"string\">\"port\"</span> =&gt; <span class=\"string\">\"11211\"</span>),</div><div class=\"line\">    <span class=\"keyword\">array</span>(<span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.2\"</span>,<span class=\"string\">\"port\"</span> =&gt; <span class=\"string\">\"11211\"</span>),</div><div class=\"line\">  );</div><div class=\"line\">  $key = <span class=\"string\">\"userDatakey\"</span>;</div><div class=\"line\">  $value = <span class=\"string\">\"userDataValue\"</span>;</div><div class=\"line\">  $mc_ser = <span class=\"keyword\">new</span> $servers[mhash($key)%<span class=\"number\">2</span>];</div><div class=\"line\">  $mc = <span class=\"keyword\">new</span> Memcache($servers);</div><div class=\"line\">  $mc-&gt;set($key, $value);</div><div class=\"line\">  var_dump($mc-&gt;get($key));</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</span></div><div class=\"line\">   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $key [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;      [description]</div><div class=\"line\">   */</div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mhash</span><span class=\"params\">($key)</span></span>&#123;</div><div class=\"line\">    $md5 = substr(md5($key), <span class=\"number\">0</span>, <span class=\"number\">8</span>);</div><div class=\"line\">    $seed = <span class=\"number\">31</span>;</div><div class=\"line\">    $hash = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">8</span>;$i++)&#123;</div><div class=\"line\">      $hash = $hash*$seed + ord($md5&#123;$i&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> $hash &amp; <span class=\"number\">0x7FFFFFFF</span>;</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure>\n<p>通过Hash函数把key转化成整数后，利用这个整数与服务器数量取模，得到其中一台的服务器配置。然后利用这个配置完成memcached服务器的连接操作。这样就完成了对数据的分布式存储。</p>\n<h2 id=\"一致性Hash分布\"><a href=\"#一致性Hash分布\" class=\"headerlink\" title=\"一致性Hash分布\"></a>一致性Hash分布</h2><blockquote>\n<p>一致性hash分布是算法，是P2P网络和分布式存储中常用到一项技术。是一种当服务器有增删时，对数据影响最小的一种部署方案。</p>\n</blockquote>\n<p>一致性Hash算法实现：</p>\n<h3 id=\"将一个32位整数（0-2-32-1）想象成一个闭环。\"><a href=\"#将一个32位整数（0-2-32-1）想象成一个闭环。\" class=\"headerlink\" title=\"将一个32位整数（0~2^32-1）想象成一个闭环。\"></a>将一个32位整数（0~2^32-1）想象成一个闭环。</h3><p>如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_1.png\" alt=\"将32位整数想象成一个闭环\"></p>\n<h3 id=\"通过Hash函数将key处理成整数\"><a href=\"#通过Hash函数将key处理成整数\" class=\"headerlink\" title=\"通过Hash函数将key处理成整数\"></a>通过Hash函数将key处理成整数</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$key1 = mhash(&quot;key1&quot;);</div><div class=\"line\">$key2 = mhash(&quot;key2&quot;);</div><div class=\"line\">$key3 = mhash(&quot;key3&quot;);</div><div class=\"line\">$key4 = mhash(&quot;key4&quot;);</div></pre></td></tr></table></figure>\n<p>将key通过mhash函数处理成整数，让后就可以将之对应到闭环上。如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_2.png\" alt=\"4个key通过mhash处理成整数对应到闭环上\"></p>\n<h3 id=\"将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\"><a href=\"#将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\" class=\"headerlink\" title=\"将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\"></a>将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。</h3><p>例如，有三台服务器，IP分别是192.168.1.1、192.168.1.2、192.168.1.3<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$server1 = mhash(&quot;192.168.1.1&quot;);</div><div class=\"line\">$server2 = mhash(&quot;192.168.1.2&quot;);</div><div class=\"line\">$server3 = mhash(&quot;192.168.1.3&quot;);</div></pre></td></tr></table></figure></p>\n<p>如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_server.png\" alt=\"将服务器也映射到环上\"></p>\n<h3 id=\"把数据映射到服务器上\"><a href=\"#把数据映射到服务器上\" class=\"headerlink\" title=\"把数据映射到服务器上\"></a>把数据映射到服务器上</h3><p><strong>映射方法：</strong><br>沿着圆环的顺时针方向的key出发，直到遇上一个服务器，将key对应的数据存储到这个服务器上。</p>\n<p>如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_3.png\" alt=\"把数据映射到服务器上\"></p>\n<h3 id=\"移除服务器\"><a href=\"#移除服务器\" class=\"headerlink\" title=\"移除服务器\"></a>移除服务器</h3><p>假设服务器 server2 崩溃了，那么受影响的仅是哪些hash映射值在server1到server2的值。</p>\n<p>如图，受影响的只有key2，它将会重新映射到server3服务器上。<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_4.png\" alt=\"移除服务器\"></p>\n<h3 id=\"添加服务器\"><a href=\"#添加服务器\" class=\"headerlink\" title=\"添加服务器\"></a>添加服务器</h3><p>如果现在需要新添加一台服务器，其IP地址为（192.168.1.4）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$server4 = mhash(&quot;192.168.1.4&quot;);</div></pre></td></tr></table></figure></p>\n<p>其在闭环上的映射位置位于如图的位置，那么受影响是hash映射值在其当前的位置和server2的位置之间的key。</p>\n<p>如图，受影响的仅为key3，其将会重新映射到server4上。<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_5.png\" alt=\"添加服务器\"></p>\n<h3 id=\"实现（PHP）\"><a href=\"#实现（PHP）\" class=\"headerlink\" title=\"实现（PHP）\"></a>实现（PHP）</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlexiHash</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">private</span> $serverList = <span class=\"keyword\">array</span>();</div><div class=\"line\">  <span class=\"keyword\">private</span> $isSorted = <span class=\"keyword\">false</span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</span></div><div class=\"line\">   * [addServer 通过hash函数计算除服务器的Hash值，通过此hash值定位服务器列表的某个位置，然后将服务器排序标识置为false]</div><div class=\"line\">   * <span class=\"doctag\">@param</span> &#123;[type]&#125; $server [description]</div><div class=\"line\">   */</div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addServer</span><span class=\"params\">($server)</span></span>&#123;</div><div class=\"line\">    $hash = <span class=\"keyword\">$this</span>-&gt;mhash($server);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;serverList[$hash]))&#123;</div><div class=\"line\">      <span class=\"keyword\">$this</span>-&gt;serverList[$hash] = $server;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">$this</span>-&gt;isSorted = <span class=\"keyword\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</span></div><div class=\"line\">   * [removeServer 跟addServer实现差不多，将server删除，并将排序标识置为false]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $server [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;         [description]</div><div class=\"line\">   */</div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">removeServer</span><span class=\"params\">($server)</span></span>&#123;</div><div class=\"line\">    $hash = <span class=\"keyword\">$this</span>-&gt;mhash($server);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;serverList[$hash]))&#123;</div><div class=\"line\">      <span class=\"keyword\">unset</span>(<span class=\"keyword\">$this</span>-&gt;serverList[$hash]);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">$this</span>-&gt;isSorted = <span class=\"keyword\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</span></div><div class=\"line\">   * [lookup 先计算除key的hash值，然后判断serverList是排序过，如果没有，就先对服务器列表进行倒序排序操作。倒序排序的作用是把服务器列表转换成一个逆时针的圆环。然后遍历服务器列表，找到一个合适的服务器返回]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $key [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;      [description]</div><div class=\"line\">   */</div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lookup</span><span class=\"params\">($key)</span></span>&#123;</div><div class=\"line\">    $hash = <span class=\"keyword\">$this</span>-&gt;mhash($key);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;isSorted)&#123;</div><div class=\"line\">      ksort(<span class=\"keyword\">$this</span>-&gt;serverList, SORT_NUMERIC);</div><div class=\"line\">      <span class=\"keyword\">$this</span>-&gt;isSorted = <span class=\"keyword\">true</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">foreach</span>(<span class=\"keyword\">$this</span>-&gt;serverList <span class=\"keyword\">as</span> $pos =&gt; $server)&#123;</div><div class=\"line\">      <span class=\"keyword\">if</span>($hash &gt;= $pos)&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> $server;</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;serverList[count(<span class=\"keyword\">$this</span>-&gt;serverList) - <span class=\"number\">1</span>];</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</span></div><div class=\"line\">   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $key [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;      [description]</div><div class=\"line\">   */</div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mhash</span><span class=\"params\">($key)</span></span>&#123;</div><div class=\"line\">    $md5 = substr(md5($key), <span class=\"number\">0</span>, <span class=\"number\">8</span>);</div><div class=\"line\">    $seed = <span class=\"number\">31</span>;</div><div class=\"line\">    $hash = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">8</span>;$i++)&#123;</div><div class=\"line\">      $hash = $hash*$seed + ord($md5&#123;$i&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> $hash &amp; <span class=\"number\">0x7FFFFFFF</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>测试<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  $hserver = <span class=\"keyword\">new</span> FlexiHash();</div><div class=\"line\"></div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.1\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.2\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.3\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.4\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.5\"</span>);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key1 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key1\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key2 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key2\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"==============================================;</span></div><div class=\"line\"></div><div class=\"line\">  $hserver-&gt;removeServer(\"<span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.4</span><span class=\"string\">\");</span></div><div class=\"line\">  echo \"save key1 in server:<span class=\"string\">\".$hserver-&gt;lookup(\"</span>key1<span class=\"string\">\");</span></div><div class=\"line\">  echo \"save key2 in server:<span class=\"string\">\".$hserver-&gt;lookup(\"</span>key2<span class=\"string\">\");</span></div><div class=\"line\">  echo \"==============================================;</div><div class=\"line\"></div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.6\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key1 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key1\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key2 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key2\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"==============================================;  </span></div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure></p>\n<p>通过测试结果可以看出，在增加或者减少memcached服务器的时候，一致性hash算法只会改变很少的一部分数据的存储服务器，从而能够实现最大限度的减少数据丢失的情况。</p>\n<h2 id=\"实际应用（PHP）\"><a href=\"#实际应用（PHP）\" class=\"headerlink\" title=\"实际应用（PHP）\"></a>实际应用（PHP）</h2><p>在实际应用当中，PHP提供了两种的关于Memcached的扩展，memcache和memcached。两种扩展中都可以设置采用哪种分布方式，我们只需要选择我们要采用的策略并修改配置即可，而不需要我们自己来实现具体的分布算法。</p>\n<p><strong>memcache扩展配置</strong></p>\n<p>控制key到服务器的映射（分布式）策略。 php.ini 配置<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[Memcache]</div><div class=\"line\">Memcache.allow_failover = 1</div><div class=\"line\">memcache.max_failover_attempts = 2</div><div class=\"line\">Memcache.hash_strategy =consistent</div><div class=\"line\">Memcache.hash_function =crc32</div></pre></td></tr></table></figure></p>\n<p>Memcache.allow_failover</p>\n<blockquote>\n<p>是否在发生错误时（对用户）透明的转移到其他服务器。</p>\n</blockquote>\n<p>memcache.max_failover_attempts</p>\n<blockquote>\n<p>定义在写入和获取数据时最多尝试的服务器次数（即：故障转移最大尝试数），仅和 memcache.allow_failover结合使用。</p>\n</blockquote>\n<p>Memcache.hash_strategy</p>\n<blockquote>\n<p>控制key到服务器的映射（分布式）策略。</p>\n</blockquote>\n<ul>\n<li>consistent，采用一致性hash分布策略实现映射</li>\n<li>standard，采用普通hash分布策略实现映射</li>\n</ul>\n<p>memcache.hash_function</p>\n<blockquote>\n<p>控制在key-server映射时使用哪个hash函数crc32 标明使用标准CRC32进行hash，fnv则说明使用FNV-1a。</p>\n</blockquote>\n<p><strong>memcached扩展配置</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">  $mem = new memcached();</div><div class=\"line\">  $mem-&gt;setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);</div><div class=\"line\">  $mem-&gt;setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);</div></pre></td></tr></table></figure></p>\n<p>Memcached::OPT_DISTRIBUTION</p>\n<blockquote>\n<p>指定元素key分布到各个服务器的方法。当前支持的方法有余数分步法合一致性hash算法两种。一致性hash算法提供 了更好的分配策略并且在添加服务器到集群时可以最小化缓存丢失。<br>类型: integer, 默认: Memcached::DISTRIBUTION_MODULA.</p>\n</blockquote>\n<p>Memcached::DISTRIBUTION_MODULA</p>\n<blockquote>\n<p>余数分布算法。</p>\n</blockquote>\n<p>Memcached::DISTRIBUTION_CONSISTENT</p>\n<blockquote>\n<p>一致性分布算法(基于libketama).</p>\n</blockquote>\n<p>Memcached::OPT_LIBKETAMA_COMPATIBLE</p>\n<blockquote>\n<p>开启或关闭兼容的libketama类行为。当开启此选项后，元素key的hash算法将会被设置为md5并且分布算法将会 采用带有权重的一致性hash分布。这一点非常有用因为其他基于libketama的客户端（比如python，urby）在同样 的服务端配置下可以透明的访问key。</p>\n<p><strong>Note:</strong><br>如果你要使用一致性hash算法强烈建议开启此选项，并且这个选项可能在未来的发布版中被设置为默认开启。<br>类型: boolean, 默认: FALSE.</p>\n</blockquote>\n","excerpt":"<p>虽然memcached是一个高性能的缓存服务器，但是单台服务器对于目前大型的web应用来说还是满足不了需求的。那么就需要布置多台的memcached服务器进行分布式部署。那么一个数据应该存储到哪一台服务器就需要一个分布算法来确定。</p>\n<p>常见的分布方案有两种，</p>\n<blockquote>\n<ul>\n<li>普通Hash分布</li>\n<li>一致性Hash分布</li>\n</ul>\n</blockquote>","more":"<h2 id=\"普通Hash分布\"><a href=\"#普通Hash分布\" class=\"headerlink\" title=\"普通Hash分布\"></a>普通Hash分布</h2><blockquote>\n<p>俗称哈希取模法，优点是实现简单，但缺点是缺乏灵活性（比如增加一台服务器，那么之前存储的数据的键值和具体的物理机之间的关系就被完全打乱了，即之前存储的数据就完全失效了）。</p>\n</blockquote>\n<h3 id=\"原理：\"><a href=\"#原理：\" class=\"headerlink\" title=\"原理：\"></a>原理：</h3><p>H(key) = hash(key)mod K;</p>\n<blockquote>\n<p>假设有K台物理机，对于key为键值的记录，H(key)值即为存储数据的物理机编号。通过这种方式，就将全部数据分配到K台物理机上，而查找某条记录时，使用同样的Hash函数就可以找到对应的物理机。</p>\n</blockquote>\n<h3 id=\"实现-PHP-：\"><a href=\"#实现-PHP-：\" class=\"headerlink\" title=\"实现(PHP)：\"></a>实现(PHP)：</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  $servers = <span class=\"keyword\">array</span>(</div><div class=\"line\">    <span class=\"keyword\">array</span>(<span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.1\"</span>,<span class=\"string\">\"port\"</span> =&gt; <span class=\"string\">\"11211\"</span>),</div><div class=\"line\">    <span class=\"keyword\">array</span>(<span class=\"string\">\"host\"</span> =&gt; <span class=\"string\">\"192.168.1.2\"</span>,<span class=\"string\">\"port\"</span> =&gt; <span class=\"string\">\"11211\"</span>),</div><div class=\"line\">  );</div><div class=\"line\">  $key = <span class=\"string\">\"userDatakey\"</span>;</div><div class=\"line\">  $value = <span class=\"string\">\"userDataValue\"</span>;</div><div class=\"line\">  $mc_ser = <span class=\"keyword\">new</span> $servers[mhash($key)%<span class=\"number\">2</span>];</div><div class=\"line\">  $mc = <span class=\"keyword\">new</span> Memcache($servers);</div><div class=\"line\">  $mc-&gt;set($key, $value);</div><div class=\"line\">  var_dump($mc-&gt;get($key));</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</div><div class=\"line\">   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $key [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;      [description]</div><div class=\"line\">   */</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mhash</span><span class=\"params\">($key)</span></span>&#123;</div><div class=\"line\">    $md5 = substr(md5($key), <span class=\"number\">0</span>, <span class=\"number\">8</span>);</div><div class=\"line\">    $seed = <span class=\"number\">31</span>;</div><div class=\"line\">    $hash = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">8</span>;$i++)&#123;</div><div class=\"line\">      $hash = $hash*$seed + ord($md5&#123;$i&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> $hash &amp; <span class=\"number\">0x7FFFFFFF</span>;</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure>\n<p>通过Hash函数把key转化成整数后，利用这个整数与服务器数量取模，得到其中一台的服务器配置。然后利用这个配置完成memcached服务器的连接操作。这样就完成了对数据的分布式存储。</p>\n<h2 id=\"一致性Hash分布\"><a href=\"#一致性Hash分布\" class=\"headerlink\" title=\"一致性Hash分布\"></a>一致性Hash分布</h2><blockquote>\n<p>一致性hash分布是算法，是P2P网络和分布式存储中常用到一项技术。是一种当服务器有增删时，对数据影响最小的一种部署方案。</p>\n</blockquote>\n<p>一致性Hash算法实现：</p>\n<h3 id=\"将一个32位整数（0-2-32-1）想象成一个闭环。\"><a href=\"#将一个32位整数（0-2-32-1）想象成一个闭环。\" class=\"headerlink\" title=\"将一个32位整数（0~2^32-1）想象成一个闭环。\"></a>将一个32位整数（0~2^32-1）想象成一个闭环。</h3><p>如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_1.png\" alt=\"将32位整数想象成一个闭环\"></p>\n<h3 id=\"通过Hash函数将key处理成整数\"><a href=\"#通过Hash函数将key处理成整数\" class=\"headerlink\" title=\"通过Hash函数将key处理成整数\"></a>通过Hash函数将key处理成整数</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$key1 = mhash(&quot;key1&quot;);</div><div class=\"line\">$key2 = mhash(&quot;key2&quot;);</div><div class=\"line\">$key3 = mhash(&quot;key3&quot;);</div><div class=\"line\">$key4 = mhash(&quot;key4&quot;);</div></pre></td></tr></table></figure>\n<p>将key通过mhash函数处理成整数，让后就可以将之对应到闭环上。如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_2.png\" alt=\"4个key通过mhash处理成整数对应到闭环上\"></p>\n<h3 id=\"将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\"><a href=\"#将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\" class=\"headerlink\" title=\"将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。\"></a>将memcached服务器，通过hash服务器所使用的IP地址，也对应到闭环上。</h3><p>例如，有三台服务器，IP分别是192.168.1.1、192.168.1.2、192.168.1.3<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$server1 = mhash(&quot;192.168.1.1&quot;);</div><div class=\"line\">$server2 = mhash(&quot;192.168.1.2&quot;);</div><div class=\"line\">$server3 = mhash(&quot;192.168.1.3&quot;);</div></pre></td></tr></table></figure></p>\n<p>如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_server.png\" alt=\"将服务器也映射到环上\"></p>\n<h3 id=\"把数据映射到服务器上\"><a href=\"#把数据映射到服务器上\" class=\"headerlink\" title=\"把数据映射到服务器上\"></a>把数据映射到服务器上</h3><p><strong>映射方法：</strong><br>沿着圆环的顺时针方向的key出发，直到遇上一个服务器，将key对应的数据存储到这个服务器上。</p>\n<p>如图，<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_3.png\" alt=\"把数据映射到服务器上\"></p>\n<h3 id=\"移除服务器\"><a href=\"#移除服务器\" class=\"headerlink\" title=\"移除服务器\"></a>移除服务器</h3><p>假设服务器 server2 崩溃了，那么受影响的仅是哪些hash映射值在server1到server2的值。</p>\n<p>如图，受影响的只有key2，它将会重新映射到server3服务器上。<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_4.png\" alt=\"移除服务器\"></p>\n<h3 id=\"添加服务器\"><a href=\"#添加服务器\" class=\"headerlink\" title=\"添加服务器\"></a>添加服务器</h3><p>如果现在需要新添加一台服务器，其IP地址为（192.168.1.4）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$server4 = mhash(&quot;192.168.1.4&quot;);</div></pre></td></tr></table></figure></p>\n<p>其在闭环上的映射位置位于如图的位置，那么受影响是hash映射值在其当前的位置和server2的位置之间的key。</p>\n<p>如图，受影响的仅为key3，其将会重新映射到server4上。<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161001/hash_5.png\" alt=\"添加服务器\"></p>\n<h3 id=\"实现（PHP）\"><a href=\"#实现（PHP）\" class=\"headerlink\" title=\"实现（PHP）\"></a>实现（PHP）</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">FlexiHash</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">private</span> $serverList = <span class=\"keyword\">array</span>();</div><div class=\"line\">  <span class=\"keyword\">private</span> $isSorted = <span class=\"keyword\">false</span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</div><div class=\"line\">   * [addServer 通过hash函数计算除服务器的Hash值，通过此hash值定位服务器列表的某个位置，然后将服务器排序标识置为false]</div><div class=\"line\">   * <span class=\"doctag\">@param</span> &#123;[type]&#125; $server [description]</div><div class=\"line\">   */</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">addServer</span><span class=\"params\">($server)</span></span>&#123;</div><div class=\"line\">    $hash = <span class=\"keyword\">$this</span>-&gt;mhash($server);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;serverList[$hash]))&#123;</div><div class=\"line\">      <span class=\"keyword\">$this</span>-&gt;serverList[$hash] = $server;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">$this</span>-&gt;isSorted = <span class=\"keyword\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</div><div class=\"line\">   * [removeServer 跟addServer实现差不多，将server删除，并将排序标识置为false]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $server [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;         [description]</div><div class=\"line\">   */</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">removeServer</span><span class=\"params\">($server)</span></span>&#123;</div><div class=\"line\">    $hash = <span class=\"keyword\">$this</span>-&gt;mhash($server);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>(<span class=\"keyword\">$this</span>-&gt;serverList[$hash]))&#123;</div><div class=\"line\">      <span class=\"keyword\">unset</span>(<span class=\"keyword\">$this</span>-&gt;serverList[$hash]);</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">$this</span>-&gt;isSorted = <span class=\"keyword\">false</span>;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</div><div class=\"line\">   * [lookup 先计算除key的hash值，然后判断serverList是排序过，如果没有，就先对服务器列表进行倒序排序操作。倒序排序的作用是把服务器列表转换成一个逆时针的圆环。然后遍历服务器列表，找到一个合适的服务器返回]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $key [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;      [description]</div><div class=\"line\">   */</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">lookup</span><span class=\"params\">($key)</span></span>&#123;</div><div class=\"line\">    $hash = <span class=\"keyword\">$this</span>-&gt;mhash($key);</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">$this</span>-&gt;isSorted)&#123;</div><div class=\"line\">      ksort(<span class=\"keyword\">$this</span>-&gt;serverList, SORT_NUMERIC);</div><div class=\"line\">      <span class=\"keyword\">$this</span>-&gt;isSorted = <span class=\"keyword\">true</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">foreach</span>(<span class=\"keyword\">$this</span>-&gt;serverList <span class=\"keyword\">as</span> $pos =&gt; $server)&#123;</div><div class=\"line\">      <span class=\"keyword\">if</span>($hash &gt;= $pos)&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> $server;</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">$this</span>-&gt;serverList[count(<span class=\"keyword\">$this</span>-&gt;serverList) - <span class=\"number\">1</span>];</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">/**</div><div class=\"line\">   * [mhash 首先通过md5把key处理成一个32位的字符串，取其前8个字符。在经过hash算法处理成一个整数并返回。]</div><div class=\"line\">   * <span class=\"doctag\">@param</span>  &#123;[type]&#125; $key [description]</div><div class=\"line\">   * <span class=\"doctag\">@return</span> &#123;[type]&#125;      [description]</div><div class=\"line\">   */</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mhash</span><span class=\"params\">($key)</span></span>&#123;</div><div class=\"line\">    $md5 = substr(md5($key), <span class=\"number\">0</span>, <span class=\"number\">8</span>);</div><div class=\"line\">    $seed = <span class=\"number\">31</span>;</div><div class=\"line\">    $hash = <span class=\"number\">0</span>;</div><div class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">8</span>;$i++)&#123;</div><div class=\"line\">      $hash = $hash*$seed + ord($md5&#123;$i&#125;);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> $hash &amp; <span class=\"number\">0x7FFFFFFF</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>测试<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  $hserver = <span class=\"keyword\">new</span> FlexiHash();</div><div class=\"line\"></div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.1\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.2\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.3\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.4\"</span>);</div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.5\"</span>);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key1 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key1\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key2 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key2\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"==============================================;</div><div class=\"line\"></div><div class=\"line\">  $hserver-&gt;removeServer(\"</span><span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.4</span><span class=\"string\">\");</div><div class=\"line\">  echo \"</span>save key1 in server:<span class=\"string\">\".$hserver-&gt;lookup(\"</span>key1<span class=\"string\">\");</div><div class=\"line\">  echo \"</span>save key2 in server:<span class=\"string\">\".$hserver-&gt;lookup(\"</span>key2<span class=\"string\">\");</div><div class=\"line\">  echo \"</span>==============================================;</div><div class=\"line\"></div><div class=\"line\">  $hserver-&gt;addServer(<span class=\"string\">\"192.168.1.6\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key1 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key1\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"save key2 in server:\"</span>.$hserver-&gt;lookup(<span class=\"string\">\"key2\"</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"==============================================;  </div><div class=\"line\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p>通过测试结果可以看出，在增加或者减少memcached服务器的时候，一致性hash算法只会改变很少的一部分数据的存储服务器，从而能够实现最大限度的减少数据丢失的情况。</p>\n<h2 id=\"实际应用（PHP）\"><a href=\"#实际应用（PHP）\" class=\"headerlink\" title=\"实际应用（PHP）\"></a>实际应用（PHP）</h2><p>在实际应用当中，PHP提供了两种的关于Memcached的扩展，memcache和memcached。两种扩展中都可以设置采用哪种分布方式，我们只需要选择我们要采用的策略并修改配置即可，而不需要我们自己来实现具体的分布算法。</p>\n<p><strong>memcache扩展配置</strong></p>\n<p>控制key到服务器的映射（分布式）策略。 php.ini 配置<br><figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[Memcache]</div><div class=\"line\">Memcache.allow_failover = 1</div><div class=\"line\">memcache.max_failover_attempts = 2</div><div class=\"line\">Memcache.hash_strategy =consistent</div><div class=\"line\">Memcache.hash_function =crc32</div></pre></td></tr></table></figure></p>\n<p>Memcache.allow_failover</p>\n<blockquote>\n<p>是否在发生错误时（对用户）透明的转移到其他服务器。</p>\n</blockquote>\n<p>memcache.max_failover_attempts</p>\n<blockquote>\n<p>定义在写入和获取数据时最多尝试的服务器次数（即：故障转移最大尝试数），仅和 memcache.allow_failover结合使用。</p>\n</blockquote>\n<p>Memcache.hash_strategy</p>\n<blockquote>\n<p>控制key到服务器的映射（分布式）策略。</p>\n</blockquote>\n<ul>\n<li>consistent，采用一致性hash分布策略实现映射</li>\n<li>standard，采用普通hash分布策略实现映射</li>\n</ul>\n<p>memcache.hash_function</p>\n<blockquote>\n<p>控制在key-server映射时使用哪个hash函数crc32 标明使用标准CRC32进行hash，fnv则说明使用FNV-1a。</p>\n</blockquote>\n<p><strong>memcached扩展配置</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">  $mem = new memcached();</div><div class=\"line\">  $mem-&gt;setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);</div><div class=\"line\">  $mem-&gt;setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);</div></pre></td></tr></table></figure></p>\n<p>Memcached::OPT_DISTRIBUTION</p>\n<blockquote>\n<p>指定元素key分布到各个服务器的方法。当前支持的方法有余数分步法合一致性hash算法两种。一致性hash算法提供 了更好的分配策略并且在添加服务器到集群时可以最小化缓存丢失。<br>类型: integer, 默认: Memcached::DISTRIBUTION_MODULA.</p>\n</blockquote>\n<p>Memcached::DISTRIBUTION_MODULA</p>\n<blockquote>\n<p>余数分布算法。</p>\n</blockquote>\n<p>Memcached::DISTRIBUTION_CONSISTENT</p>\n<blockquote>\n<p>一致性分布算法(基于libketama).</p>\n</blockquote>\n<p>Memcached::OPT_LIBKETAMA_COMPATIBLE</p>\n<blockquote>\n<p>开启或关闭兼容的libketama类行为。当开启此选项后，元素key的hash算法将会被设置为md5并且分布算法将会 采用带有权重的一致性hash分布。这一点非常有用因为其他基于libketama的客户端（比如python，urby）在同样 的服务端配置下可以透明的访问key。</p>\n<p><strong>Note:</strong><br>如果你要使用一致性hash算法强烈建议开启此选项，并且这个选项可能在未来的发布版中被设置为默认开启。<br>类型: boolean, 默认: FALSE.</p>\n</blockquote>"},{"title":"MySQL编译安装","date":"2016-09-25T12:30:00.000Z","ctime":"2016-09-25T12:30:00.000Z","utime":"2016-09-25T12:30:00.000Z","modif_times":0,"_content":"\n![MySQL](http://n.sinaimg.cn/games/3ece443e/20160925/mysql_log.png)\n<!-- more -->\n\n## 环境\nOS：CentOS 7.2 64\n\nMySQL：[mysql-5.7.15](http://dev.mysql.com/downloads/mysql/)\n\n## 编译环境准备\n```\n# yum -y install make gcc-c++ cmake bison-devel ncurses-devel\n```\n> make，Linux下非常重要的编译工具，最主要也是最基本的功能就是通过makefile文件来描述源程序之间的相互关系并自动维护编译工作。\n> gcc-c++，C++ 编译器（gcc，C编译器）\n> cmake，一个跨平台的编译自动配置工具，（作用生成makefile 文件）\n> bison-devel 一个语法分析器生成器\n> ncurses-devel，Ncurses介绍摘要:Ncurses是一个能提供功能键定义(快捷键),屏幕绘制以及基于文本终端.\n\n### ncurses\nNcurses 提供字符终端处理库，包括面板和菜单。它提供了一套控制光标，建立窗口，改变前景背景颜色以及处理鼠标操作的函数。使用户在字符终端下编写应用程序时绕过了那些恼人的底层机制。简而言之，他是一个可以使应用程序直接控制终端屏幕显示的函数库。\n1、yum安装\n```\nyum -y install ncurses-devel\n```\n注：如果报错，包找不到，是*通配符没有识别，给文件名加双引号  “ncurses*”\n\n2、源代码编译:\n```\n下载解压\ncd ncurses-5.9\n./configure --with-shared --without-debug --without-ada --enable-overwrite\nmake\nmake install\n```\n* 若不安装ncurses编译MySQL时会报错\n* --without-ada 参数为设定不编译为ada绑定，因进入chroot环境不能使用ada ；--enable-overwrite参数为定义把头文件安装到/tools/include下而不是/tools/include/ncurses目录\n* --with-shared 生成共享库\n\n### 安装cmake和bison\nmysql在5.5以后，不再使用./configure工具，进行编译安装。而使用cmake工具替代了./configure工具。cmake的具体用法参考文档cmake说明。\n\nbison是一个自由软件，用于自动生成语法分析器程序，可用于所有常见的操作系统\n```\nyum -y install cmake\nyum -y install bison\n```\n\n## 编译\n\n解压源码包\n```\ntar -zxvf mysql-5.7.15.tar.gz\n```\n进入源码包目录\n```\ncd mysql-5.7.15\n```\n编译\n```\ncmake  \\\n-DDEFAULT_CHARSET=utf8 \\\n-DDEFAULT_COLLATION=utf8_general_ci \\\n-DWITH_INNOBASE_STORAGE_ENGINE=1 \\\n-DENABLED_LOCAL_INFILE=1 \\\n-DWITH_BOOST=/usr/local/boost\n```\nBoost，是为C++语言标准库提供扩展的一些C++程序库的总称，，由Boost社区组织开发、维护。\n最后一行配置，是配置boost库的，如果没有boost包，编译会报错。\n如果之前没有安装过，可以单独安装，也可在mysql安装的时候直接下载安装，这样的话，最后一行配置修改如下：\n```\n-DDOWNLOAD_BOOST=1 -DWITH_BOOST=/usr/local/boost #直接下载并安装\n```\n```\nmake && make install\n```\n\n## 配置\n\n### 创建MySQL运行用户和用户组\n查看mysql用户及用户组\n```\ncat /etc/passwd     查看用户列表\ncat /etc/group      查看用户组列表\n```\n如果没有就创建\n```\ngroupadd mysql\nuseradd -g mysql mysql\n```\n修改/usr/local/mysql权限\n```\nchown -R mysql:mysql /usr/local/mysql\n```\n初始化配置\n```\ncd /usr/local/mysql\ncp support-files/my-default.cnf /etc/my.cnf\n```\n注：在启动MySQL服务时，会按照一定次序搜索my.cnf，先在/etc目录下找，找不到则会在安装目录下面找，在本例中就是 /usr/local/mysql/my.cnf，这是新版MySQL的配置文件的默认位置。\n\n### 初始化数据库并生成初始密码\n```\n/usr/local/mysql/bin/mysqld --initialize --user=mysql\n```\n会生成一个初始密码\n```\n# A temporary password is generated for root@localhost: -qeFRRlHV0jf\n```\n密码：-qeFRRlHV0jf\n\n### 设置环境变量（使得mysql服务可以全局访问）\n```\nvi ~/.bash_profile\n```\n在修改PATH=$PATH:$HOME/bin为：\n```\nPATH=$PATH:$HOME/bin:/usr/local/mysql/bin:/usr/local/mysql/lib\n```\n重新加载环境变量\n```\n[root@root ~]# source /root/.bash_profile    \n```\n## 管理\n### 启动mysql\n\n方法一：\n```\n# 将mysql的启动服务添加到系统服务中\n# cp support-files/mysql.server /etc/init.d/mysql\n# service mysql start\n```\n方法二：\n```\n/usr/local/mysql/bin/mysqld_safe --user=mysql &\n```\n\n### 设置开机自启动\n方法一：\n\n通过chkconfig实现。\n\n方法二：直接修改 rc.local 文件\n```\necho \"/usr/local/mysql/bin/mysqld_safe --user=mysql &\" >> /etc/rc.local\n```\n\n### 修改密码\n登录并修改初始密码（不修改密码不让你操作，就是这么任性）\n```\n# mysql -uroot -hlocalhost -p\nEnter password:-qeFRRlHV0jf（初始密码）\n# mysql> SET PASSWORD FOR 'root'@'localhost' = PASSWORD('xxxxxxx');\n```\n\n重新登录\n```\n#  mysql> exit\n#  mysql -u root -p\nEnter password:\n```\n能够登录进去，则说明MySQL安装成功。over~\n","source":"_posts/MySQL安装编译.md","raw":"---\ntitle: MySQL编译安装\ndate: 2016-09-25 20:30:00\nctime: 2016-09-25 20:30:00\nutime: 2016-09-25 20:30:00\nmodif_times: 0\ntags:\n- \ncategories:\n- MySQL\n---\n\n![MySQL](http://n.sinaimg.cn/games/3ece443e/20160925/mysql_log.png)\n<!-- more -->\n\n## 环境\nOS：CentOS 7.2 64\n\nMySQL：[mysql-5.7.15](http://dev.mysql.com/downloads/mysql/)\n\n## 编译环境准备\n```\n# yum -y install make gcc-c++ cmake bison-devel ncurses-devel\n```\n> make，Linux下非常重要的编译工具，最主要也是最基本的功能就是通过makefile文件来描述源程序之间的相互关系并自动维护编译工作。\n> gcc-c++，C++ 编译器（gcc，C编译器）\n> cmake，一个跨平台的编译自动配置工具，（作用生成makefile 文件）\n> bison-devel 一个语法分析器生成器\n> ncurses-devel，Ncurses介绍摘要:Ncurses是一个能提供功能键定义(快捷键),屏幕绘制以及基于文本终端.\n\n### ncurses\nNcurses 提供字符终端处理库，包括面板和菜单。它提供了一套控制光标，建立窗口，改变前景背景颜色以及处理鼠标操作的函数。使用户在字符终端下编写应用程序时绕过了那些恼人的底层机制。简而言之，他是一个可以使应用程序直接控制终端屏幕显示的函数库。\n1、yum安装\n```\nyum -y install ncurses-devel\n```\n注：如果报错，包找不到，是*通配符没有识别，给文件名加双引号  “ncurses*”\n\n2、源代码编译:\n```\n下载解压\ncd ncurses-5.9\n./configure --with-shared --without-debug --without-ada --enable-overwrite\nmake\nmake install\n```\n* 若不安装ncurses编译MySQL时会报错\n* --without-ada 参数为设定不编译为ada绑定，因进入chroot环境不能使用ada ；--enable-overwrite参数为定义把头文件安装到/tools/include下而不是/tools/include/ncurses目录\n* --with-shared 生成共享库\n\n### 安装cmake和bison\nmysql在5.5以后，不再使用./configure工具，进行编译安装。而使用cmake工具替代了./configure工具。cmake的具体用法参考文档cmake说明。\n\nbison是一个自由软件，用于自动生成语法分析器程序，可用于所有常见的操作系统\n```\nyum -y install cmake\nyum -y install bison\n```\n\n## 编译\n\n解压源码包\n```\ntar -zxvf mysql-5.7.15.tar.gz\n```\n进入源码包目录\n```\ncd mysql-5.7.15\n```\n编译\n```\ncmake  \\\n-DDEFAULT_CHARSET=utf8 \\\n-DDEFAULT_COLLATION=utf8_general_ci \\\n-DWITH_INNOBASE_STORAGE_ENGINE=1 \\\n-DENABLED_LOCAL_INFILE=1 \\\n-DWITH_BOOST=/usr/local/boost\n```\nBoost，是为C++语言标准库提供扩展的一些C++程序库的总称，，由Boost社区组织开发、维护。\n最后一行配置，是配置boost库的，如果没有boost包，编译会报错。\n如果之前没有安装过，可以单独安装，也可在mysql安装的时候直接下载安装，这样的话，最后一行配置修改如下：\n```\n-DDOWNLOAD_BOOST=1 -DWITH_BOOST=/usr/local/boost #直接下载并安装\n```\n```\nmake && make install\n```\n\n## 配置\n\n### 创建MySQL运行用户和用户组\n查看mysql用户及用户组\n```\ncat /etc/passwd     查看用户列表\ncat /etc/group      查看用户组列表\n```\n如果没有就创建\n```\ngroupadd mysql\nuseradd -g mysql mysql\n```\n修改/usr/local/mysql权限\n```\nchown -R mysql:mysql /usr/local/mysql\n```\n初始化配置\n```\ncd /usr/local/mysql\ncp support-files/my-default.cnf /etc/my.cnf\n```\n注：在启动MySQL服务时，会按照一定次序搜索my.cnf，先在/etc目录下找，找不到则会在安装目录下面找，在本例中就是 /usr/local/mysql/my.cnf，这是新版MySQL的配置文件的默认位置。\n\n### 初始化数据库并生成初始密码\n```\n/usr/local/mysql/bin/mysqld --initialize --user=mysql\n```\n会生成一个初始密码\n```\n# A temporary password is generated for root@localhost: -qeFRRlHV0jf\n```\n密码：-qeFRRlHV0jf\n\n### 设置环境变量（使得mysql服务可以全局访问）\n```\nvi ~/.bash_profile\n```\n在修改PATH=$PATH:$HOME/bin为：\n```\nPATH=$PATH:$HOME/bin:/usr/local/mysql/bin:/usr/local/mysql/lib\n```\n重新加载环境变量\n```\n[root@root ~]# source /root/.bash_profile    \n```\n## 管理\n### 启动mysql\n\n方法一：\n```\n# 将mysql的启动服务添加到系统服务中\n# cp support-files/mysql.server /etc/init.d/mysql\n# service mysql start\n```\n方法二：\n```\n/usr/local/mysql/bin/mysqld_safe --user=mysql &\n```\n\n### 设置开机自启动\n方法一：\n\n通过chkconfig实现。\n\n方法二：直接修改 rc.local 文件\n```\necho \"/usr/local/mysql/bin/mysqld_safe --user=mysql &\" >> /etc/rc.local\n```\n\n### 修改密码\n登录并修改初始密码（不修改密码不让你操作，就是这么任性）\n```\n# mysql -uroot -hlocalhost -p\nEnter password:-qeFRRlHV0jf（初始密码）\n# mysql> SET PASSWORD FOR 'root'@'localhost' = PASSWORD('xxxxxxx');\n```\n\n重新登录\n```\n#  mysql> exit\n#  mysql -u root -p\nEnter password:\n```\n能够登录进去，则说明MySQL安装成功。over~\n","slug":"MySQL安装编译","published":1,"updated":"2016-09-25T10:46:14.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbww1001w699fdp6sr4e3","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/mysql_log.png\" alt=\"MySQL\"><br><a id=\"more\"></a></p>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>OS：CentOS 7.2 64</p>\n<p>MySQL：<a href=\"http://dev.mysql.com/downloads/mysql/\" target=\"_blank\" rel=\"external\">mysql-5.7.15</a></p>\n<h2 id=\"编译环境准备\"><a href=\"#编译环境准备\" class=\"headerlink\" title=\"编译环境准备\"></a>编译环境准备</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># yum -y install make gcc-c++ cmake bison-devel ncurses-devel</div></pre></td></tr></table></figure>\n<blockquote>\n<p>make，Linux下非常重要的编译工具，最主要也是最基本的功能就是通过makefile文件来描述源程序之间的相互关系并自动维护编译工作。<br>gcc-c++，C++ 编译器（gcc，C编译器）<br>cmake，一个跨平台的编译自动配置工具，（作用生成makefile 文件）<br>bison-devel 一个语法分析器生成器<br>ncurses-devel，Ncurses介绍摘要:Ncurses是一个能提供功能键定义(快捷键),屏幕绘制以及基于文本终端.</p>\n</blockquote>\n<h3 id=\"ncurses\"><a href=\"#ncurses\" class=\"headerlink\" title=\"ncurses\"></a>ncurses</h3><p>Ncurses 提供字符终端处理库，包括面板和菜单。它提供了一套控制光标，建立窗口，改变前景背景颜色以及处理鼠标操作的函数。使用户在字符终端下编写应用程序时绕过了那些恼人的底层机制。简而言之，他是一个可以使应用程序直接控制终端屏幕显示的函数库。<br>1、yum安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install ncurses-devel</div></pre></td></tr></table></figure></p>\n<p>注：如果报错，包找不到，是<em>通配符没有识别，给文件名加双引号  “ncurses</em>”</p>\n<p>2、源代码编译:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">下载解压</div><div class=\"line\">cd ncurses-5.9</div><div class=\"line\">./configure --with-shared --without-debug --without-ada --enable-overwrite</div><div class=\"line\">make</div><div class=\"line\">make install</div></pre></td></tr></table></figure></p>\n<ul>\n<li>若不安装ncurses编译MySQL时会报错</li>\n<li>–without-ada 参数为设定不编译为ada绑定，因进入chroot环境不能使用ada ；–enable-overwrite参数为定义把头文件安装到/tools/include下而不是/tools/include/ncurses目录</li>\n<li>–with-shared 生成共享库</li>\n</ul>\n<h3 id=\"安装cmake和bison\"><a href=\"#安装cmake和bison\" class=\"headerlink\" title=\"安装cmake和bison\"></a>安装cmake和bison</h3><p>mysql在5.5以后，不再使用./configure工具，进行编译安装。而使用cmake工具替代了./configure工具。cmake的具体用法参考文档cmake说明。</p>\n<p>bison是一个自由软件，用于自动生成语法分析器程序，可用于所有常见的操作系统<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install cmake</div><div class=\"line\">yum -y install bison</div></pre></td></tr></table></figure></p>\n<h2 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h2><p>解压源码包<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar -zxvf mysql-5.7.15.tar.gz</div></pre></td></tr></table></figure></p>\n<p>进入源码包目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd mysql-5.7.15</div></pre></td></tr></table></figure></p>\n<p>编译<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">cmake  \\</div><div class=\"line\">-DDEFAULT_CHARSET=utf8 \\</div><div class=\"line\">-DDEFAULT_COLLATION=utf8_general_ci \\</div><div class=\"line\">-DWITH_INNOBASE_STORAGE_ENGINE=1 \\</div><div class=\"line\">-DENABLED_LOCAL_INFILE=1 \\</div><div class=\"line\">-DWITH_BOOST=/usr/local/boost</div></pre></td></tr></table></figure></p>\n<p>Boost，是为C++语言标准库提供扩展的一些C++程序库的总称，，由Boost社区组织开发、维护。<br>最后一行配置，是配置boost库的，如果没有boost包，编译会报错。<br>如果之前没有安装过，可以单独安装，也可在mysql安装的时候直接下载安装，这样的话，最后一行配置修改如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">-DDOWNLOAD_BOOST=1 -DWITH_BOOST=/usr/local/boost #直接下载并安装</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><h3 id=\"创建MySQL运行用户和用户组\"><a href=\"#创建MySQL运行用户和用户组\" class=\"headerlink\" title=\"创建MySQL运行用户和用户组\"></a>创建MySQL运行用户和用户组</h3><p>查看mysql用户及用户组<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cat /etc/passwd     查看用户列表</div><div class=\"line\">cat /etc/group      查看用户组列表</div></pre></td></tr></table></figure></p>\n<p>如果没有就创建<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">groupadd mysql</div><div class=\"line\">useradd -g mysql mysql</div></pre></td></tr></table></figure></p>\n<p>修改/usr/local/mysql权限<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">chown -R mysql:mysql /usr/local/mysql</div></pre></td></tr></table></figure></p>\n<p>初始化配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/mysql</div><div class=\"line\">cp support-files/my-default.cnf /etc/my.cnf</div></pre></td></tr></table></figure></p>\n<p>注：在启动MySQL服务时，会按照一定次序搜索my.cnf，先在/etc目录下找，找不到则会在安装目录下面找，在本例中就是 /usr/local/mysql/my.cnf，这是新版MySQL的配置文件的默认位置。</p>\n<h3 id=\"初始化数据库并生成初始密码\"><a href=\"#初始化数据库并生成初始密码\" class=\"headerlink\" title=\"初始化数据库并生成初始密码\"></a>初始化数据库并生成初始密码</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/mysql/bin/mysqld --initialize --user=mysql</div></pre></td></tr></table></figure>\n<p>会生成一个初始密码<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># A temporary password is generated for root@localhost: -qeFRRlHV0jf</div></pre></td></tr></table></figure></p>\n<p>密码：-qeFRRlHV0jf</p>\n<h3 id=\"设置环境变量（使得mysql服务可以全局访问）\"><a href=\"#设置环境变量（使得mysql服务可以全局访问）\" class=\"headerlink\" title=\"设置环境变量（使得mysql服务可以全局访问）\"></a>设置环境变量（使得mysql服务可以全局访问）</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ~/.bash_profile</div></pre></td></tr></table></figure>\n<p>在修改PATH=$PATH:$HOME/bin为：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">PATH=$PATH:$HOME/bin:/usr/local/mysql/bin:/usr/local/mysql/lib</div></pre></td></tr></table></figure></p>\n<p>重新加载环境变量<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@root ~]# source /root/.bash_profile</div></pre></td></tr></table></figure></p>\n<h2 id=\"管理\"><a href=\"#管理\" class=\"headerlink\" title=\"管理\"></a>管理</h2><h3 id=\"启动mysql\"><a href=\"#启动mysql\" class=\"headerlink\" title=\"启动mysql\"></a>启动mysql</h3><p>方法一：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># 将mysql的启动服务添加到系统服务中</div><div class=\"line\"># cp support-files/mysql.server /etc/init.d/mysql</div><div class=\"line\"># service mysql start</div></pre></td></tr></table></figure></p>\n<p>方法二：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/mysql/bin/mysqld_safe --user=mysql &amp;</div></pre></td></tr></table></figure></p>\n<h3 id=\"设置开机自启动\"><a href=\"#设置开机自启动\" class=\"headerlink\" title=\"设置开机自启动\"></a>设置开机自启动</h3><p>方法一：</p>\n<p>通过chkconfig实现。</p>\n<p>方法二：直接修改 rc.local 文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;/usr/local/mysql/bin/mysqld_safe --user=mysql &amp;&quot; &gt;&gt; /etc/rc.local</div></pre></td></tr></table></figure></p>\n<h3 id=\"修改密码\"><a href=\"#修改密码\" class=\"headerlink\" title=\"修改密码\"></a>修改密码</h3><p>登录并修改初始密码（不修改密码不让你操作，就是这么任性）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># mysql -uroot -hlocalhost -p</div><div class=\"line\">Enter password:-qeFRRlHV0jf（初始密码）</div><div class=\"line\"># mysql&gt; SET PASSWORD FOR &apos;root&apos;@&apos;localhost&apos; = PASSWORD(&apos;xxxxxxx&apos;);</div></pre></td></tr></table></figure></p>\n<p>重新登录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">#  mysql&gt; exit</div><div class=\"line\">#  mysql -u root -p</div><div class=\"line\">Enter password:</div></pre></td></tr></table></figure></p>\n<p>能够登录进去，则说明MySQL安装成功。over~</p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/mysql_log.png\" alt=\"MySQL\"><br>","more":"</p>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>OS：CentOS 7.2 64</p>\n<p>MySQL：<a href=\"http://dev.mysql.com/downloads/mysql/\">mysql-5.7.15</a></p>\n<h2 id=\"编译环境准备\"><a href=\"#编译环境准备\" class=\"headerlink\" title=\"编译环境准备\"></a>编译环境准备</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># yum -y install make gcc-c++ cmake bison-devel ncurses-devel</div></pre></td></tr></table></figure>\n<blockquote>\n<p>make，Linux下非常重要的编译工具，最主要也是最基本的功能就是通过makefile文件来描述源程序之间的相互关系并自动维护编译工作。<br>gcc-c++，C++ 编译器（gcc，C编译器）<br>cmake，一个跨平台的编译自动配置工具，（作用生成makefile 文件）<br>bison-devel 一个语法分析器生成器<br>ncurses-devel，Ncurses介绍摘要:Ncurses是一个能提供功能键定义(快捷键),屏幕绘制以及基于文本终端.</p>\n</blockquote>\n<h3 id=\"ncurses\"><a href=\"#ncurses\" class=\"headerlink\" title=\"ncurses\"></a>ncurses</h3><p>Ncurses 提供字符终端处理库，包括面板和菜单。它提供了一套控制光标，建立窗口，改变前景背景颜色以及处理鼠标操作的函数。使用户在字符终端下编写应用程序时绕过了那些恼人的底层机制。简而言之，他是一个可以使应用程序直接控制终端屏幕显示的函数库。<br>1、yum安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install ncurses-devel</div></pre></td></tr></table></figure></p>\n<p>注：如果报错，包找不到，是<em>通配符没有识别，给文件名加双引号  “ncurses</em>”</p>\n<p>2、源代码编译:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">下载解压</div><div class=\"line\">cd ncurses-5.9</div><div class=\"line\">./configure --with-shared --without-debug --without-ada --enable-overwrite</div><div class=\"line\">make</div><div class=\"line\">make install</div></pre></td></tr></table></figure></p>\n<ul>\n<li>若不安装ncurses编译MySQL时会报错</li>\n<li>–without-ada 参数为设定不编译为ada绑定，因进入chroot环境不能使用ada ；–enable-overwrite参数为定义把头文件安装到/tools/include下而不是/tools/include/ncurses目录</li>\n<li>–with-shared 生成共享库</li>\n</ul>\n<h3 id=\"安装cmake和bison\"><a href=\"#安装cmake和bison\" class=\"headerlink\" title=\"安装cmake和bison\"></a>安装cmake和bison</h3><p>mysql在5.5以后，不再使用./configure工具，进行编译安装。而使用cmake工具替代了./configure工具。cmake的具体用法参考文档cmake说明。</p>\n<p>bison是一个自由软件，用于自动生成语法分析器程序，可用于所有常见的操作系统<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install cmake</div><div class=\"line\">yum -y install bison</div></pre></td></tr></table></figure></p>\n<h2 id=\"编译\"><a href=\"#编译\" class=\"headerlink\" title=\"编译\"></a>编译</h2><p>解压源码包<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar -zxvf mysql-5.7.15.tar.gz</div></pre></td></tr></table></figure></p>\n<p>进入源码包目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd mysql-5.7.15</div></pre></td></tr></table></figure></p>\n<p>编译<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">cmake  \\</div><div class=\"line\">-DDEFAULT_CHARSET=utf8 \\</div><div class=\"line\">-DDEFAULT_COLLATION=utf8_general_ci \\</div><div class=\"line\">-DWITH_INNOBASE_STORAGE_ENGINE=1 \\</div><div class=\"line\">-DENABLED_LOCAL_INFILE=1 \\</div><div class=\"line\">-DWITH_BOOST=/usr/local/boost</div></pre></td></tr></table></figure></p>\n<p>Boost，是为C++语言标准库提供扩展的一些C++程序库的总称，，由Boost社区组织开发、维护。<br>最后一行配置，是配置boost库的，如果没有boost包，编译会报错。<br>如果之前没有安装过，可以单独安装，也可在mysql安装的时候直接下载安装，这样的话，最后一行配置修改如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">-DDOWNLOAD_BOOST=1 -DWITH_BOOST=/usr/local/boost #直接下载并安装</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><h3 id=\"创建MySQL运行用户和用户组\"><a href=\"#创建MySQL运行用户和用户组\" class=\"headerlink\" title=\"创建MySQL运行用户和用户组\"></a>创建MySQL运行用户和用户组</h3><p>查看mysql用户及用户组<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cat /etc/passwd     查看用户列表</div><div class=\"line\">cat /etc/group      查看用户组列表</div></pre></td></tr></table></figure></p>\n<p>如果没有就创建<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">groupadd mysql</div><div class=\"line\">useradd -g mysql mysql</div></pre></td></tr></table></figure></p>\n<p>修改/usr/local/mysql权限<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">chown -R mysql:mysql /usr/local/mysql</div></pre></td></tr></table></figure></p>\n<p>初始化配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/mysql</div><div class=\"line\">cp support-files/my-default.cnf /etc/my.cnf</div></pre></td></tr></table></figure></p>\n<p>注：在启动MySQL服务时，会按照一定次序搜索my.cnf，先在/etc目录下找，找不到则会在安装目录下面找，在本例中就是 /usr/local/mysql/my.cnf，这是新版MySQL的配置文件的默认位置。</p>\n<h3 id=\"初始化数据库并生成初始密码\"><a href=\"#初始化数据库并生成初始密码\" class=\"headerlink\" title=\"初始化数据库并生成初始密码\"></a>初始化数据库并生成初始密码</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/mysql/bin/mysqld --initialize --user=mysql</div></pre></td></tr></table></figure>\n<p>会生成一个初始密码<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># A temporary password is generated for root@localhost: -qeFRRlHV0jf</div></pre></td></tr></table></figure></p>\n<p>密码：-qeFRRlHV0jf</p>\n<h3 id=\"设置环境变量（使得mysql服务可以全局访问）\"><a href=\"#设置环境变量（使得mysql服务可以全局访问）\" class=\"headerlink\" title=\"设置环境变量（使得mysql服务可以全局访问）\"></a>设置环境变量（使得mysql服务可以全局访问）</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ~/.bash_profile</div></pre></td></tr></table></figure>\n<p>在修改PATH=$PATH:$HOME/bin为：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">PATH=$PATH:$HOME/bin:/usr/local/mysql/bin:/usr/local/mysql/lib</div></pre></td></tr></table></figure></p>\n<p>重新加载环境变量<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@root ~]# source /root/.bash_profile</div></pre></td></tr></table></figure></p>\n<h2 id=\"管理\"><a href=\"#管理\" class=\"headerlink\" title=\"管理\"></a>管理</h2><h3 id=\"启动mysql\"><a href=\"#启动mysql\" class=\"headerlink\" title=\"启动mysql\"></a>启动mysql</h3><p>方法一：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># 将mysql的启动服务添加到系统服务中</div><div class=\"line\"># cp support-files/mysql.server /etc/init.d/mysql</div><div class=\"line\"># service mysql start</div></pre></td></tr></table></figure></p>\n<p>方法二：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/mysql/bin/mysqld_safe --user=mysql &amp;</div></pre></td></tr></table></figure></p>\n<h3 id=\"设置开机自启动\"><a href=\"#设置开机自启动\" class=\"headerlink\" title=\"设置开机自启动\"></a>设置开机自启动</h3><p>方法一：</p>\n<p>通过chkconfig实现。</p>\n<p>方法二：直接修改 rc.local 文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;/usr/local/mysql/bin/mysqld_safe --user=mysql &amp;&quot; &gt;&gt; /etc/rc.local</div></pre></td></tr></table></figure></p>\n<h3 id=\"修改密码\"><a href=\"#修改密码\" class=\"headerlink\" title=\"修改密码\"></a>修改密码</h3><p>登录并修改初始密码（不修改密码不让你操作，就是这么任性）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># mysql -uroot -hlocalhost -p</div><div class=\"line\">Enter password:-qeFRRlHV0jf（初始密码）</div><div class=\"line\"># mysql&gt; SET PASSWORD FOR &apos;root&apos;@&apos;localhost&apos; = PASSWORD(&apos;xxxxxxx&apos;);</div></pre></td></tr></table></figure></p>\n<p>重新登录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">#  mysql&gt; exit</div><div class=\"line\">#  mysql -u root -p</div><div class=\"line\">Enter password:</div></pre></td></tr></table></figure></p>\n<p>能够登录进去，则说明MySQL安装成功。over~</p>"},{"title":"MySQL并发控制整理","date":"2016-09-16T13:00:00.000Z","_content":"\n根据控制的不同层次，MySQL的并发控制可以分为：\n- 服务器层\n- 存储引擎层\n\n实现并发控制的方法策略：***锁机制***\n- 共享锁（shared lock）<======> 读锁（read lock）\n- 排它锁（exclusive lock） <======> 写锁（write lock）\n\n如何选择适合的锁？***锁策略***\n- 锁的粒度越小，系统的并发性越高\n- 所得操作越多，系统的开销越大\n> 所以所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡。\n\n<!-- more -->\n\n## MySQL中锁策略类型\nMySQL不同的存储引擎中用到的锁策略基本有两种。一种是表级锁，另一种是行级锁。\n- 表锁，一种开销最小的锁策略。\n> 一个用户对表进行写操作时，需要先获得写锁，这是其他用户读该表进行的读写操作都会进行阻塞。只有当前写操作被释放之后，其他人才能活的读锁。当当前表有读锁时，其他人也可以继续获得读锁。读锁是共享性的不同的读锁之间是互相不阻塞的。\n> 另外，写锁的优先级高于读锁。所以当有多个锁请求存在是，读锁的请求会被优先插入到锁队列的前边。\n\n- 行锁，最大程度支持并发处理，同时也是锁开销最大的锁策略。\n> 顾名思义，行级锁只在将要修改的记录行上进行锁操作，对其他的行的操作没有影响。\n\n尽管我们一般提到的锁，都处于存储引擎这一层，但是MySQL本身在某些情况下，也会对锁策略进行控制。比如表的alter table操作，会对表本身使用表锁，而直接忽略存储引擎的锁机制。\n\n## MySQL中死锁问题解决方法\n> 死锁，即两个或者多个事务在同一资源上相互占用，并请求占用对方已经占用的资源的情况。\n\n既然有锁存在，当然就会有死锁的情况发生。那么MySQL中是如何处理死锁问题的呢？\n死锁的通常解决方案有两种，即：\n- 死锁检测机制\n- 超时机制\n\nInnoDB存储引擎在检测到有死锁发生的处理方法是，将当前持有最少的行级锁的事务进行回滚。待打破死锁后，重新执行因为死锁而回滚的事务。\n","source":"_posts/MySQL的并发控制整理.md","raw":"---\ntitle: MySQL并发控制整理\ndate: 2016-09-16 21:00:00\ntags:\n- 并发控制\ncategories:\n- MySQL\n---\n\n根据控制的不同层次，MySQL的并发控制可以分为：\n- 服务器层\n- 存储引擎层\n\n实现并发控制的方法策略：***锁机制***\n- 共享锁（shared lock）<======> 读锁（read lock）\n- 排它锁（exclusive lock） <======> 写锁（write lock）\n\n如何选择适合的锁？***锁策略***\n- 锁的粒度越小，系统的并发性越高\n- 所得操作越多，系统的开销越大\n> 所以所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡。\n\n<!-- more -->\n\n## MySQL中锁策略类型\nMySQL不同的存储引擎中用到的锁策略基本有两种。一种是表级锁，另一种是行级锁。\n- 表锁，一种开销最小的锁策略。\n> 一个用户对表进行写操作时，需要先获得写锁，这是其他用户读该表进行的读写操作都会进行阻塞。只有当前写操作被释放之后，其他人才能活的读锁。当当前表有读锁时，其他人也可以继续获得读锁。读锁是共享性的不同的读锁之间是互相不阻塞的。\n> 另外，写锁的优先级高于读锁。所以当有多个锁请求存在是，读锁的请求会被优先插入到锁队列的前边。\n\n- 行锁，最大程度支持并发处理，同时也是锁开销最大的锁策略。\n> 顾名思义，行级锁只在将要修改的记录行上进行锁操作，对其他的行的操作没有影响。\n\n尽管我们一般提到的锁，都处于存储引擎这一层，但是MySQL本身在某些情况下，也会对锁策略进行控制。比如表的alter table操作，会对表本身使用表锁，而直接忽略存储引擎的锁机制。\n\n## MySQL中死锁问题解决方法\n> 死锁，即两个或者多个事务在同一资源上相互占用，并请求占用对方已经占用的资源的情况。\n\n既然有锁存在，当然就会有死锁的情况发生。那么MySQL中是如何处理死锁问题的呢？\n死锁的通常解决方案有两种，即：\n- 死锁检测机制\n- 超时机制\n\nInnoDB存储引擎在检测到有死锁发生的处理方法是，将当前持有最少的行级锁的事务进行回滚。待打破死锁后，重新执行因为死锁而回滚的事务。\n","slug":"MySQL的并发控制整理","published":1,"updated":"2016-09-16T18:06:35.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbww4001z699fi2s17xrp","content":"<p>根据控制的不同层次，MySQL的并发控制可以分为：</p>\n<ul>\n<li>服务器层</li>\n<li>存储引擎层</li>\n</ul>\n<p>实现并发控制的方法策略：<strong><em>锁机制</em></strong></p>\n<ul>\n<li>共享锁（shared lock）&lt;======&gt; 读锁（read lock）</li>\n<li>排它锁（exclusive lock） &lt;======&gt; 写锁（write lock）</li>\n</ul>\n<p>如何选择适合的锁？<strong><em>锁策略</em></strong></p>\n<ul>\n<li>锁的粒度越小，系统的并发性越高</li>\n<li>所得操作越多，系统的开销越大<blockquote>\n<p>所以所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡。</p>\n</blockquote>\n</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"MySQL中锁策略类型\"><a href=\"#MySQL中锁策略类型\" class=\"headerlink\" title=\"MySQL中锁策略类型\"></a>MySQL中锁策略类型</h2><p>MySQL不同的存储引擎中用到的锁策略基本有两种。一种是表级锁，另一种是行级锁。</p>\n<ul>\n<li><p>表锁，一种开销最小的锁策略。</p>\n<blockquote>\n<p>一个用户对表进行写操作时，需要先获得写锁，这是其他用户读该表进行的读写操作都会进行阻塞。只有当前写操作被释放之后，其他人才能活的读锁。当当前表有读锁时，其他人也可以继续获得读锁。读锁是共享性的不同的读锁之间是互相不阻塞的。<br>另外，写锁的优先级高于读锁。所以当有多个锁请求存在是，读锁的请求会被优先插入到锁队列的前边。</p>\n</blockquote>\n</li>\n<li><p>行锁，最大程度支持并发处理，同时也是锁开销最大的锁策略。</p>\n<blockquote>\n<p>顾名思义，行级锁只在将要修改的记录行上进行锁操作，对其他的行的操作没有影响。</p>\n</blockquote>\n</li>\n</ul>\n<p>尽管我们一般提到的锁，都处于存储引擎这一层，但是MySQL本身在某些情况下，也会对锁策略进行控制。比如表的alter table操作，会对表本身使用表锁，而直接忽略存储引擎的锁机制。</p>\n<h2 id=\"MySQL中死锁问题解决方法\"><a href=\"#MySQL中死锁问题解决方法\" class=\"headerlink\" title=\"MySQL中死锁问题解决方法\"></a>MySQL中死锁问题解决方法</h2><blockquote>\n<p>死锁，即两个或者多个事务在同一资源上相互占用，并请求占用对方已经占用的资源的情况。</p>\n</blockquote>\n<p>既然有锁存在，当然就会有死锁的情况发生。那么MySQL中是如何处理死锁问题的呢？<br>死锁的通常解决方案有两种，即：</p>\n<ul>\n<li>死锁检测机制</li>\n<li>超时机制</li>\n</ul>\n<p>InnoDB存储引擎在检测到有死锁发生的处理方法是，将当前持有最少的行级锁的事务进行回滚。待打破死锁后，重新执行因为死锁而回滚的事务。</p>\n","excerpt":"<p>根据控制的不同层次，MySQL的并发控制可以分为：</p>\n<ul>\n<li>服务器层</li>\n<li>存储引擎层</li>\n</ul>\n<p>实现并发控制的方法策略：<strong><em>锁机制</em></strong></p>\n<ul>\n<li>共享锁（shared lock）&lt;======&gt; 读锁（read lock）</li>\n<li>排它锁（exclusive lock） &lt;======&gt; 写锁（write lock）</li>\n</ul>\n<p>如何选择适合的锁？<strong><em>锁策略</em></strong></p>\n<ul>\n<li>锁的粒度越小，系统的并发性越高</li>\n<li>所得操作越多，系统的开销越大<blockquote>\n<p>所以所谓的锁策略，就是在锁的开销和数据的安全性之间寻求平衡。</p>\n</blockquote>\n</li>\n</ul>","more":"<h2 id=\"MySQL中锁策略类型\"><a href=\"#MySQL中锁策略类型\" class=\"headerlink\" title=\"MySQL中锁策略类型\"></a>MySQL中锁策略类型</h2><p>MySQL不同的存储引擎中用到的锁策略基本有两种。一种是表级锁，另一种是行级锁。</p>\n<ul>\n<li><p>表锁，一种开销最小的锁策略。</p>\n<blockquote>\n<p>一个用户对表进行写操作时，需要先获得写锁，这是其他用户读该表进行的读写操作都会进行阻塞。只有当前写操作被释放之后，其他人才能活的读锁。当当前表有读锁时，其他人也可以继续获得读锁。读锁是共享性的不同的读锁之间是互相不阻塞的。<br>另外，写锁的优先级高于读锁。所以当有多个锁请求存在是，读锁的请求会被优先插入到锁队列的前边。</p>\n</blockquote>\n</li>\n<li><p>行锁，最大程度支持并发处理，同时也是锁开销最大的锁策略。</p>\n<blockquote>\n<p>顾名思义，行级锁只在将要修改的记录行上进行锁操作，对其他的行的操作没有影响。</p>\n</blockquote>\n</li>\n</ul>\n<p>尽管我们一般提到的锁，都处于存储引擎这一层，但是MySQL本身在某些情况下，也会对锁策略进行控制。比如表的alter table操作，会对表本身使用表锁，而直接忽略存储引擎的锁机制。</p>\n<h2 id=\"MySQL中死锁问题解决方法\"><a href=\"#MySQL中死锁问题解决方法\" class=\"headerlink\" title=\"MySQL中死锁问题解决方法\"></a>MySQL中死锁问题解决方法</h2><blockquote>\n<p>死锁，即两个或者多个事务在同一资源上相互占用，并请求占用对方已经占用的资源的情况。</p>\n</blockquote>\n<p>既然有锁存在，当然就会有死锁的情况发生。那么MySQL中是如何处理死锁问题的呢？<br>死锁的通常解决方案有两种，即：</p>\n<ul>\n<li>死锁检测机制</li>\n<li>超时机制</li>\n</ul>\n<p>InnoDB存储引擎在检测到有死锁发生的处理方法是，将当前持有最少的行级锁的事务进行回滚。待打破死锁后，重新执行因为死锁而回滚的事务。</p>"},{"title":"Nginx服务器https配置","date":"2016-10-04T13:30:00.000Z","ctime":"2016-10-04T13:30:00.000Z","utime":"2016-10-04T13:30:00.000Z","modif_times":0,"_content":"\n![Nginx服务器https配置](http://n.sinaimg.cn/games/3ece443e/20161004/https.png)\n\n<!-- more -->\n\n## 准备\n\nLinux：Linux version 3.10.0-123.9.3.el7.x86_64\nNginx：nginx/1.6.3\nopenssl：1.0.1e\n\n\n## 申请证书\n目前网上有不少机构提供个人免费 ssl 证书，有效期几个月到几年不等。以 [StartSSL :https://www.startssl.com](https://www.startssl.com) 为例, 申请成功后有效期 3 年，到期后可免费续租。\n具体申请过程也很简单。\n注册登录以后选择 Certificates Wizard >> \tDV SSL Certificate 申请一个免费的 ssl 证书。\n\n通过邮件验证域名之后，然后在自己服务器中生成 SSL 证书的 csr ，**记住生成输入的秘密**，之后要用到：\n```\nopenssl req -newkey rsa:2048 -keyout weizhimiao.cn.key -out weizhimiao.cn.csr\n```\n将生成的证书，放到指定的存放证书的目录，如 `/data/secret/` 。查看证书 `weizhimiao.csr` 内容，将内容复制到页面中的 Certificate Signing Request (CSR)部分，提交页面。\n\n下载生成好的证书,选择对应的web服务器（Nginx，1_weizhimiao.cn_bundle.crt），这样私钥和公钥我们就都有了。\n- 1_weizhimiao.cn_bundle.crt（公钥）\n- weizhimiao.cn.key（私钥）\n\n## nginx配置（为指定域名增加https）\nnginx.conf当前配置\n```\n...\nhttp {\n    ...\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        ...\n    }\n}\n```\n\n./conf.d/weizhimiao.cn.conf中加入\n```\n\nserver{\n    listen 443 ssl;\n    server_name weizhimiao.cn;\n\n    ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;\n    ssl_certificate_key /data/secret/weizhimiao.cn.key;\n    ssl_prefer_server_ciphers on;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n\n    ssl_ciphers 'kEECDH+ECDSA+AES128 kEECDH+ECDSA+AES256 kEECDH+AES128 kEECDH+AES256 kEDH+AES128 kEDH+AES256 DES-CBC3-SHA +SHA !aNULL !eNULL !LOW !MD5 !EXP !DSS !PSK !SRP !kECDH !CAMELLIA !RC4 !SEED';\n\n    add_header Strict-Transport-Security 'max-age=31536000; preload';\n    add_header X-Frame-Options DENY;\n    ssl_session_cache   shared:SSL:10m;\n    ssl_session_timeout 10m;\n    keepalive_timeout 70;\n    ssl_dhparam /data/secret/dhparam.pem;\n\n    add_header X-Content-Type-Options nosniff;\n\n    add_header X-Xss-Protection 1;\n\n    root /data/www/weizhimiao.cn;\n    index index.html;\n\n    location / {\n\n    }\n}\n\n```\n**注：**\n配置中用到一个 `/data/secret/dhparam.pem` 文件，该文件是一个PEM格式的密钥文件，用于TLS会话中。用来加强ssl的安全性。生成该文件方法，\n```\ncd /data/secret/\nopenssl dhparam 2048 -out dhparam.pem\n```\n\n将原来80端口的访问，重定向。./conf.d/weizhimiao.cn.conf中加入\n```\nserver{\n    listen 80;\n    server_name  weizhimiao.cn;\n    return 301 https://weizhimiao.cn$request_uri;\n}\n\n```\n\n## 测试\n检测配置文件是否有语法错误，需要输入之前生成公钥时输入的密码。\n```\nnginx -t\nEnter PEM pass phrase:\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n```\n重启Nginx(切记，reload不起作用)\n```\nnginx -s stop\nEnter PEM pass phrase:\nnginx\nEnter PEM pass phrase:\n```\n浏览器访问 weizhimiao.cn ,是否生效。\n\n另，Nginx配置了安全证书之后，nginx每次的reload、stop等操作都需要输入密码。\n可以通过生成一个解密的key文件，替代原来key文件。\n```\ncd /data/secret/\nopenssl rsa -in weizhimiao.cn.key -out weizhimiao.cn.key.unsecure\n```\n替换 `weizhimiao.cn.conf` 中的 `weizhimiao.cn.key` 文件.\n```\nserver {\n  ...\n  ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;\n  ssl_certificate_key /data/secret/weizhimiao.cn.key.unsecure;\n  ...\n}\n```\n之后每次在reload时，就不需要在输入密码了。\n\n\n最后，用 [SSLLABS](https://www.ssllabs.com/ssltest/index.html) 来进行一下测试。\n![ssllabs](http://n.sinaimg.cn/games/3ece443e/20161004/ssllabs.png)\n结果\n![ssllabs](http://n.sinaimg.cn/games/3ece443e/20161004/ssllabsres.png)\n\n\n\n\nover~\n","source":"_posts/Nginx服务器https配置.md","raw":"---\ntitle: Nginx服务器https配置\ndate: 2016-10-04 21:30:00\nctime: 2016-10-04 21:30:00\nutime: 2016-10-04 21:30:00\nmodif_times: 0\ntags:\n- https\ncategories:\n- Nginx\n---\n\n![Nginx服务器https配置](http://n.sinaimg.cn/games/3ece443e/20161004/https.png)\n\n<!-- more -->\n\n## 准备\n\nLinux：Linux version 3.10.0-123.9.3.el7.x86_64\nNginx：nginx/1.6.3\nopenssl：1.0.1e\n\n\n## 申请证书\n目前网上有不少机构提供个人免费 ssl 证书，有效期几个月到几年不等。以 [StartSSL :https://www.startssl.com](https://www.startssl.com) 为例, 申请成功后有效期 3 年，到期后可免费续租。\n具体申请过程也很简单。\n注册登录以后选择 Certificates Wizard >> \tDV SSL Certificate 申请一个免费的 ssl 证书。\n\n通过邮件验证域名之后，然后在自己服务器中生成 SSL 证书的 csr ，**记住生成输入的秘密**，之后要用到：\n```\nopenssl req -newkey rsa:2048 -keyout weizhimiao.cn.key -out weizhimiao.cn.csr\n```\n将生成的证书，放到指定的存放证书的目录，如 `/data/secret/` 。查看证书 `weizhimiao.csr` 内容，将内容复制到页面中的 Certificate Signing Request (CSR)部分，提交页面。\n\n下载生成好的证书,选择对应的web服务器（Nginx，1_weizhimiao.cn_bundle.crt），这样私钥和公钥我们就都有了。\n- 1_weizhimiao.cn_bundle.crt（公钥）\n- weizhimiao.cn.key（私钥）\n\n## nginx配置（为指定域名增加https）\nnginx.conf当前配置\n```\n...\nhttp {\n    ...\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        ...\n    }\n}\n```\n\n./conf.d/weizhimiao.cn.conf中加入\n```\n\nserver{\n    listen 443 ssl;\n    server_name weizhimiao.cn;\n\n    ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;\n    ssl_certificate_key /data/secret/weizhimiao.cn.key;\n    ssl_prefer_server_ciphers on;\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;\n\n    ssl_ciphers 'kEECDH+ECDSA+AES128 kEECDH+ECDSA+AES256 kEECDH+AES128 kEECDH+AES256 kEDH+AES128 kEDH+AES256 DES-CBC3-SHA +SHA !aNULL !eNULL !LOW !MD5 !EXP !DSS !PSK !SRP !kECDH !CAMELLIA !RC4 !SEED';\n\n    add_header Strict-Transport-Security 'max-age=31536000; preload';\n    add_header X-Frame-Options DENY;\n    ssl_session_cache   shared:SSL:10m;\n    ssl_session_timeout 10m;\n    keepalive_timeout 70;\n    ssl_dhparam /data/secret/dhparam.pem;\n\n    add_header X-Content-Type-Options nosniff;\n\n    add_header X-Xss-Protection 1;\n\n    root /data/www/weizhimiao.cn;\n    index index.html;\n\n    location / {\n\n    }\n}\n\n```\n**注：**\n配置中用到一个 `/data/secret/dhparam.pem` 文件，该文件是一个PEM格式的密钥文件，用于TLS会话中。用来加强ssl的安全性。生成该文件方法，\n```\ncd /data/secret/\nopenssl dhparam 2048 -out dhparam.pem\n```\n\n将原来80端口的访问，重定向。./conf.d/weizhimiao.cn.conf中加入\n```\nserver{\n    listen 80;\n    server_name  weizhimiao.cn;\n    return 301 https://weizhimiao.cn$request_uri;\n}\n\n```\n\n## 测试\n检测配置文件是否有语法错误，需要输入之前生成公钥时输入的密码。\n```\nnginx -t\nEnter PEM pass phrase:\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n\n```\n重启Nginx(切记，reload不起作用)\n```\nnginx -s stop\nEnter PEM pass phrase:\nnginx\nEnter PEM pass phrase:\n```\n浏览器访问 weizhimiao.cn ,是否生效。\n\n另，Nginx配置了安全证书之后，nginx每次的reload、stop等操作都需要输入密码。\n可以通过生成一个解密的key文件，替代原来key文件。\n```\ncd /data/secret/\nopenssl rsa -in weizhimiao.cn.key -out weizhimiao.cn.key.unsecure\n```\n替换 `weizhimiao.cn.conf` 中的 `weizhimiao.cn.key` 文件.\n```\nserver {\n  ...\n  ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;\n  ssl_certificate_key /data/secret/weizhimiao.cn.key.unsecure;\n  ...\n}\n```\n之后每次在reload时，就不需要在输入密码了。\n\n\n最后，用 [SSLLABS](https://www.ssllabs.com/ssltest/index.html) 来进行一下测试。\n![ssllabs](http://n.sinaimg.cn/games/3ece443e/20161004/ssllabs.png)\n结果\n![ssllabs](http://n.sinaimg.cn/games/3ece443e/20161004/ssllabsres.png)\n\n\n\n\nover~\n","slug":"Nginx服务器https配置","published":1,"updated":"2016-10-04T14:38:23.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbww60023699f4dr2lpov","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/https.png\" alt=\"Nginx服务器https配置\"></p>\n<a id=\"more\"></a>\n<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><p>Linux：Linux version 3.10.0-123.9.3.el7.x86_64<br>Nginx：nginx/1.6.3<br>openssl：1.0.1e</p>\n<h2 id=\"申请证书\"><a href=\"#申请证书\" class=\"headerlink\" title=\"申请证书\"></a>申请证书</h2><p>目前网上有不少机构提供个人免费 ssl 证书，有效期几个月到几年不等。以 <a href=\"https://www.startssl.com\" target=\"_blank\" rel=\"external\">StartSSL :https://www.startssl.com</a> 为例, 申请成功后有效期 3 年，到期后可免费续租。<br>具体申请过程也很简单。<br>注册登录以后选择 Certificates Wizard &gt;&gt;     DV SSL Certificate 申请一个免费的 ssl 证书。</p>\n<p>通过邮件验证域名之后，然后在自己服务器中生成 SSL 证书的 csr ，<strong>记住生成输入的秘密</strong>，之后要用到：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">openssl req -newkey rsa:2048 -keyout weizhimiao.cn.key -out weizhimiao.cn.csr</div></pre></td></tr></table></figure></p>\n<p>将生成的证书，放到指定的存放证书的目录，如 <code>/data/secret/</code> 。查看证书 <code>weizhimiao.csr</code> 内容，将内容复制到页面中的 Certificate Signing Request (CSR)部分，提交页面。</p>\n<p>下载生成好的证书,选择对应的web服务器（Nginx，1_weizhimiao.cn_bundle.crt），这样私钥和公钥我们就都有了。</p>\n<ul>\n<li>1_weizhimiao.cn_bundle.crt（公钥）</li>\n<li>weizhimiao.cn.key（私钥）</li>\n</ul>\n<h2 id=\"nginx配置（为指定域名增加https）\"><a href=\"#nginx配置（为指定域名增加https）\" class=\"headerlink\" title=\"nginx配置（为指定域名增加https）\"></a>nginx配置（为指定域名增加https）</h2><p>nginx.conf当前配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">...</div><div class=\"line\">http &#123;</div><div class=\"line\">    ...</div><div class=\"line\">    include /etc/nginx/conf.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">    server &#123;</div><div class=\"line\">        ...</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>./conf.d/weizhimiao.cn.conf中加入<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">server&#123;</div><div class=\"line\">    listen 443 ssl;</div><div class=\"line\">    server_name weizhimiao.cn;</div><div class=\"line\"></div><div class=\"line\">    ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;</div><div class=\"line\">    ssl_certificate_key /data/secret/weizhimiao.cn.key;</div><div class=\"line\">    ssl_prefer_server_ciphers on;</div><div class=\"line\">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class=\"line\"></div><div class=\"line\">    ssl_ciphers &apos;kEECDH+ECDSA+AES128 kEECDH+ECDSA+AES256 kEECDH+AES128 kEECDH+AES256 kEDH+AES128 kEDH+AES256 DES-CBC3-SHA +SHA !aNULL !eNULL !LOW !MD5 !EXP !DSS !PSK !SRP !kECDH !CAMELLIA !RC4 !SEED&apos;;</div><div class=\"line\"></div><div class=\"line\">    add_header Strict-Transport-Security &apos;max-age=31536000; preload&apos;;</div><div class=\"line\">    add_header X-Frame-Options DENY;</div><div class=\"line\">    ssl_session_cache   shared:SSL:10m;</div><div class=\"line\">    ssl_session_timeout 10m;</div><div class=\"line\">    keepalive_timeout 70;</div><div class=\"line\">    ssl_dhparam /data/secret/dhparam.pem;</div><div class=\"line\"></div><div class=\"line\">    add_header X-Content-Type-Options nosniff;</div><div class=\"line\"></div><div class=\"line\">    add_header X-Xss-Protection 1;</div><div class=\"line\"></div><div class=\"line\">    root /data/www/weizhimiao.cn;</div><div class=\"line\">    index index.html;</div><div class=\"line\"></div><div class=\"line\">    location / &#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>注：</strong><br>配置中用到一个 <code>/data/secret/dhparam.pem</code> 文件，该文件是一个PEM格式的密钥文件，用于TLS会话中。用来加强ssl的安全性。生成该文件方法，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/secret/</div><div class=\"line\">openssl dhparam 2048 -out dhparam.pem</div></pre></td></tr></table></figure></p>\n<p>将原来80端口的访问，重定向。./conf.d/weizhimiao.cn.conf中加入<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">server&#123;</div><div class=\"line\">    listen 80;</div><div class=\"line\">    server_name  weizhimiao.cn;</div><div class=\"line\">    return 301 https://weizhimiao.cn$request_uri;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>检测配置文件是否有语法错误，需要输入之前生成公钥时输入的密码。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -t</div><div class=\"line\">Enter PEM pass phrase:</div><div class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>重启Nginx(切记，reload不起作用)<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -s stop</div><div class=\"line\">Enter PEM pass phrase:</div><div class=\"line\">nginx</div><div class=\"line\">Enter PEM pass phrase:</div></pre></td></tr></table></figure></p>\n<p>浏览器访问 weizhimiao.cn ,是否生效。</p>\n<p>另，Nginx配置了安全证书之后，nginx每次的reload、stop等操作都需要输入密码。<br>可以通过生成一个解密的key文件，替代原来key文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/secret/</div><div class=\"line\">openssl rsa -in weizhimiao.cn.key -out weizhimiao.cn.key.unsecure</div></pre></td></tr></table></figure></p>\n<p>替换 <code>weizhimiao.cn.conf</code> 中的 <code>weizhimiao.cn.key</code> 文件.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">  ...</div><div class=\"line\">  ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;</div><div class=\"line\">  ssl_certificate_key /data/secret/weizhimiao.cn.key.unsecure;</div><div class=\"line\">  ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>之后每次在reload时，就不需要在输入密码了。</p>\n<p>最后，用 <a href=\"https://www.ssllabs.com/ssltest/index.html\" target=\"_blank\" rel=\"external\">SSLLABS</a> 来进行一下测试。<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/ssllabs.png\" alt=\"ssllabs\"><br>结果<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/ssllabsres.png\" alt=\"ssllabs\"></p>\n<p>over~</p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/https.png\" alt=\"Nginx服务器https配置\"></p>","more":"<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><p>Linux：Linux version 3.10.0-123.9.3.el7.x86_64<br>Nginx：nginx/1.6.3<br>openssl：1.0.1e</p>\n<h2 id=\"申请证书\"><a href=\"#申请证书\" class=\"headerlink\" title=\"申请证书\"></a>申请证书</h2><p>目前网上有不少机构提供个人免费 ssl 证书，有效期几个月到几年不等。以 <a href=\"https://www.startssl.com\">StartSSL :https://www.startssl.com</a> 为例, 申请成功后有效期 3 年，到期后可免费续租。<br>具体申请过程也很简单。<br>注册登录以后选择 Certificates Wizard &gt;&gt;     DV SSL Certificate 申请一个免费的 ssl 证书。</p>\n<p>通过邮件验证域名之后，然后在自己服务器中生成 SSL 证书的 csr ，<strong>记住生成输入的秘密</strong>，之后要用到：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">openssl req -newkey rsa:2048 -keyout weizhimiao.cn.key -out weizhimiao.cn.csr</div></pre></td></tr></table></figure></p>\n<p>将生成的证书，放到指定的存放证书的目录，如 <code>/data/secret/</code> 。查看证书 <code>weizhimiao.csr</code> 内容，将内容复制到页面中的 Certificate Signing Request (CSR)部分，提交页面。</p>\n<p>下载生成好的证书,选择对应的web服务器（Nginx，1_weizhimiao.cn_bundle.crt），这样私钥和公钥我们就都有了。</p>\n<ul>\n<li>1_weizhimiao.cn_bundle.crt（公钥）</li>\n<li>weizhimiao.cn.key（私钥）</li>\n</ul>\n<h2 id=\"nginx配置（为指定域名增加https）\"><a href=\"#nginx配置（为指定域名增加https）\" class=\"headerlink\" title=\"nginx配置（为指定域名增加https）\"></a>nginx配置（为指定域名增加https）</h2><p>nginx.conf当前配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">...</div><div class=\"line\">http &#123;</div><div class=\"line\">    ...</div><div class=\"line\">    include /etc/nginx/conf.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">    server &#123;</div><div class=\"line\">        ...</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>./conf.d/weizhimiao.cn.conf中加入<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"></div><div class=\"line\">server&#123;</div><div class=\"line\">    listen 443 ssl;</div><div class=\"line\">    server_name weizhimiao.cn;</div><div class=\"line\"></div><div class=\"line\">    ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;</div><div class=\"line\">    ssl_certificate_key /data/secret/weizhimiao.cn.key;</div><div class=\"line\">    ssl_prefer_server_ciphers on;</div><div class=\"line\">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class=\"line\"></div><div class=\"line\">    ssl_ciphers &apos;kEECDH+ECDSA+AES128 kEECDH+ECDSA+AES256 kEECDH+AES128 kEECDH+AES256 kEDH+AES128 kEDH+AES256 DES-CBC3-SHA +SHA !aNULL !eNULL !LOW !MD5 !EXP !DSS !PSK !SRP !kECDH !CAMELLIA !RC4 !SEED&apos;;</div><div class=\"line\"></div><div class=\"line\">    add_header Strict-Transport-Security &apos;max-age=31536000; preload&apos;;</div><div class=\"line\">    add_header X-Frame-Options DENY;</div><div class=\"line\">    ssl_session_cache   shared:SSL:10m;</div><div class=\"line\">    ssl_session_timeout 10m;</div><div class=\"line\">    keepalive_timeout 70;</div><div class=\"line\">    ssl_dhparam /data/secret/dhparam.pem;</div><div class=\"line\"></div><div class=\"line\">    add_header X-Content-Type-Options nosniff;</div><div class=\"line\"></div><div class=\"line\">    add_header X-Xss-Protection 1;</div><div class=\"line\"></div><div class=\"line\">    root /data/www/weizhimiao.cn;</div><div class=\"line\">    index index.html;</div><div class=\"line\"></div><div class=\"line\">    location / &#123;</div><div class=\"line\"></div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>注：</strong><br>配置中用到一个 <code>/data/secret/dhparam.pem</code> 文件，该文件是一个PEM格式的密钥文件，用于TLS会话中。用来加强ssl的安全性。生成该文件方法，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/secret/</div><div class=\"line\">openssl dhparam 2048 -out dhparam.pem</div></pre></td></tr></table></figure></p>\n<p>将原来80端口的访问，重定向。./conf.d/weizhimiao.cn.conf中加入<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">server&#123;</div><div class=\"line\">    listen 80;</div><div class=\"line\">    server_name  weizhimiao.cn;</div><div class=\"line\">    return 301 https://weizhimiao.cn$request_uri;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>检测配置文件是否有语法错误，需要输入之前生成公钥时输入的密码。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -t</div><div class=\"line\">Enter PEM pass phrase:</div><div class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>重启Nginx(切记，reload不起作用)<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -s stop</div><div class=\"line\">Enter PEM pass phrase:</div><div class=\"line\">nginx</div><div class=\"line\">Enter PEM pass phrase:</div></pre></td></tr></table></figure></p>\n<p>浏览器访问 weizhimiao.cn ,是否生效。</p>\n<p>另，Nginx配置了安全证书之后，nginx每次的reload、stop等操作都需要输入密码。<br>可以通过生成一个解密的key文件，替代原来key文件。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/secret/</div><div class=\"line\">openssl rsa -in weizhimiao.cn.key -out weizhimiao.cn.key.unsecure</div></pre></td></tr></table></figure></p>\n<p>替换 <code>weizhimiao.cn.conf</code> 中的 <code>weizhimiao.cn.key</code> 文件.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">  ...</div><div class=\"line\">  ssl_certificate /data/secret/1_weizhimiao.cn_bundle.crt;</div><div class=\"line\">  ssl_certificate_key /data/secret/weizhimiao.cn.key.unsecure;</div><div class=\"line\">  ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>之后每次在reload时，就不需要在输入密码了。</p>\n<p>最后，用 <a href=\"https://www.ssllabs.com/ssltest/index.html\">SSLLABS</a> 来进行一下测试。<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/ssllabs.png\" alt=\"ssllabs\"><br>结果<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/ssllabsres.png\" alt=\"ssllabs\"></p>\n<p>over~</p>"},{"title":"MySQL逻辑架构设计","date":"2016-09-16T12:00:00.000Z","_content":"\n通常MySQL架构有两种划分，一种划为两层架构，另一种划为三层。\n两层架构划为MySQL服务器层和存储引擎层，三层架构则把MySQL层又划为两层。\n\n![MySQL架构图](http://n.sinaimg.cn/games/3ece443e/20160916/MySQLJiaGouTu1.png)\n\n<!-- more -->\n\n## 三层架构说明\n- 第一层，用于连接处理、授权认证、安全认证等等。大多数基于客户端/服务器端的工具或者服务器都有类似架构。\n\n- 第二层，是MySQL架构的核心部分。MySQL的大部分核心服务功能大都在这一层。包括查询解析、分析、优化、缓存以及所有的内置函数的实现，还有所有的跨存储引擎的功能都在这一层实现：存储过程、触发器、试图等。\n\n- 第三层，存储引擎层。存储引擎负责MySQL中数据的存储和读取。每个存储引擎都有自己的优势和劣势。MySQL服务器层通过API与存储引擎进行通信。存储引擎本身是不会解析SQL，且不同的存储引擎之间也是不会相互通信。\n\n## MySQL服务器接收/处理一个查询请求的过程\n\n1. 当MySQL服务器接收到一个查询请求，首先会对当前的连接请求进行认证，认证其用户名和密码信息。\n\n2. 连接成功之后，会继续验证该连接是否具有执行某个特定查询的权限。\n\n3. 所有的验证都通过，如果是 select 操作，MySQL会先检查查询缓存中是否存在该缓存，如果存在直接返回结果。不存在继续下一步。\n\n4. 解析查询，并创建内部数据结构（生成 解析树），然后对解析树进行各种优化（包括，重写查询，决定表的读取顺序、选择合适的索引等等）。\n\n5. 通过存储引擎存储或者提取结果。\n\n6. 如果是select操作，生成查询缓存。\n\n7. 返回结果。\n\nover~\n","source":"_posts/MySQL逻辑架构实现小结.md","raw":"---\ntitle: MySQL逻辑架构设计\ndate: 2016-09-16 20:00:00\ntags:\n- MySQL逻辑架构\ncategories:\n- MySQL\n---\n\n通常MySQL架构有两种划分，一种划为两层架构，另一种划为三层。\n两层架构划为MySQL服务器层和存储引擎层，三层架构则把MySQL层又划为两层。\n\n![MySQL架构图](http://n.sinaimg.cn/games/3ece443e/20160916/MySQLJiaGouTu1.png)\n\n<!-- more -->\n\n## 三层架构说明\n- 第一层，用于连接处理、授权认证、安全认证等等。大多数基于客户端/服务器端的工具或者服务器都有类似架构。\n\n- 第二层，是MySQL架构的核心部分。MySQL的大部分核心服务功能大都在这一层。包括查询解析、分析、优化、缓存以及所有的内置函数的实现，还有所有的跨存储引擎的功能都在这一层实现：存储过程、触发器、试图等。\n\n- 第三层，存储引擎层。存储引擎负责MySQL中数据的存储和读取。每个存储引擎都有自己的优势和劣势。MySQL服务器层通过API与存储引擎进行通信。存储引擎本身是不会解析SQL，且不同的存储引擎之间也是不会相互通信。\n\n## MySQL服务器接收/处理一个查询请求的过程\n\n1. 当MySQL服务器接收到一个查询请求，首先会对当前的连接请求进行认证，认证其用户名和密码信息。\n\n2. 连接成功之后，会继续验证该连接是否具有执行某个特定查询的权限。\n\n3. 所有的验证都通过，如果是 select 操作，MySQL会先检查查询缓存中是否存在该缓存，如果存在直接返回结果。不存在继续下一步。\n\n4. 解析查询，并创建内部数据结构（生成 解析树），然后对解析树进行各种优化（包括，重写查询，决定表的读取顺序、选择合适的索引等等）。\n\n5. 通过存储引擎存储或者提取结果。\n\n6. 如果是select操作，生成查询缓存。\n\n7. 返回结果。\n\nover~\n","slug":"MySQL逻辑架构实现小结","published":1,"updated":"2016-09-16T08:42:10.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbww90025699fbc1yc3yl","content":"<p>通常MySQL架构有两种划分，一种划为两层架构，另一种划为三层。<br>两层架构划为MySQL服务器层和存储引擎层，三层架构则把MySQL层又划为两层。</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160916/MySQLJiaGouTu1.png\" alt=\"MySQL架构图\"></p>\n<a id=\"more\"></a>\n<h2 id=\"三层架构说明\"><a href=\"#三层架构说明\" class=\"headerlink\" title=\"三层架构说明\"></a>三层架构说明</h2><ul>\n<li><p>第一层，用于连接处理、授权认证、安全认证等等。大多数基于客户端/服务器端的工具或者服务器都有类似架构。</p>\n</li>\n<li><p>第二层，是MySQL架构的核心部分。MySQL的大部分核心服务功能大都在这一层。包括查询解析、分析、优化、缓存以及所有的内置函数的实现，还有所有的跨存储引擎的功能都在这一层实现：存储过程、触发器、试图等。</p>\n</li>\n<li><p>第三层，存储引擎层。存储引擎负责MySQL中数据的存储和读取。每个存储引擎都有自己的优势和劣势。MySQL服务器层通过API与存储引擎进行通信。存储引擎本身是不会解析SQL，且不同的存储引擎之间也是不会相互通信。</p>\n</li>\n</ul>\n<h2 id=\"MySQL服务器接收-处理一个查询请求的过程\"><a href=\"#MySQL服务器接收-处理一个查询请求的过程\" class=\"headerlink\" title=\"MySQL服务器接收/处理一个查询请求的过程\"></a>MySQL服务器接收/处理一个查询请求的过程</h2><ol>\n<li><p>当MySQL服务器接收到一个查询请求，首先会对当前的连接请求进行认证，认证其用户名和密码信息。</p>\n</li>\n<li><p>连接成功之后，会继续验证该连接是否具有执行某个特定查询的权限。</p>\n</li>\n<li><p>所有的验证都通过，如果是 select 操作，MySQL会先检查查询缓存中是否存在该缓存，如果存在直接返回结果。不存在继续下一步。</p>\n</li>\n<li><p>解析查询，并创建内部数据结构（生成 解析树），然后对解析树进行各种优化（包括，重写查询，决定表的读取顺序、选择合适的索引等等）。</p>\n</li>\n<li><p>通过存储引擎存储或者提取结果。</p>\n</li>\n<li><p>如果是select操作，生成查询缓存。</p>\n</li>\n<li><p>返回结果。</p>\n</li>\n</ol>\n<p>over~</p>\n","excerpt":"<p>通常MySQL架构有两种划分，一种划为两层架构，另一种划为三层。<br>两层架构划为MySQL服务器层和存储引擎层，三层架构则把MySQL层又划为两层。</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160916/MySQLJiaGouTu1.png\" alt=\"MySQL架构图\"></p>","more":"<h2 id=\"三层架构说明\"><a href=\"#三层架构说明\" class=\"headerlink\" title=\"三层架构说明\"></a>三层架构说明</h2><ul>\n<li><p>第一层，用于连接处理、授权认证、安全认证等等。大多数基于客户端/服务器端的工具或者服务器都有类似架构。</p>\n</li>\n<li><p>第二层，是MySQL架构的核心部分。MySQL的大部分核心服务功能大都在这一层。包括查询解析、分析、优化、缓存以及所有的内置函数的实现，还有所有的跨存储引擎的功能都在这一层实现：存储过程、触发器、试图等。</p>\n</li>\n<li><p>第三层，存储引擎层。存储引擎负责MySQL中数据的存储和读取。每个存储引擎都有自己的优势和劣势。MySQL服务器层通过API与存储引擎进行通信。存储引擎本身是不会解析SQL，且不同的存储引擎之间也是不会相互通信。</p>\n</li>\n</ul>\n<h2 id=\"MySQL服务器接收-处理一个查询请求的过程\"><a href=\"#MySQL服务器接收-处理一个查询请求的过程\" class=\"headerlink\" title=\"MySQL服务器接收/处理一个查询请求的过程\"></a>MySQL服务器接收/处理一个查询请求的过程</h2><ol>\n<li><p>当MySQL服务器接收到一个查询请求，首先会对当前的连接请求进行认证，认证其用户名和密码信息。</p>\n</li>\n<li><p>连接成功之后，会继续验证该连接是否具有执行某个特定查询的权限。</p>\n</li>\n<li><p>所有的验证都通过，如果是 select 操作，MySQL会先检查查询缓存中是否存在该缓存，如果存在直接返回结果。不存在继续下一步。</p>\n</li>\n<li><p>解析查询，并创建内部数据结构（生成 解析树），然后对解析树进行各种优化（包括，重写查询，决定表的读取顺序、选择合适的索引等等）。</p>\n</li>\n<li><p>通过存储引擎存储或者提取结果。</p>\n</li>\n<li><p>如果是select操作，生成查询缓存。</p>\n</li>\n<li><p>返回结果。</p>\n</li>\n</ol>\n<p>over~</p>"},{"title":"Nginx虚拟主机配置","date":"2016-10-04T12:30:00.000Z","ctime":"2016-10-04T12:30:00.000Z","utime":"2016-10-04T12:30:00.000Z","modif_times":0,"_content":"\n![virtual Host](http://n.sinaimg.cn/games/3ece443e/20161004/VirtualHost.png)\n\n<!-- more -->\n\n## 准备\n\nLinux：Linux version 3.10.0-123.9.3.el7.x86_64\n\nNginx: nginx/1.6.3\n\n配置文件目录结构\n```\n$ tree\n.\n├── conf.d\n├── default.d\n├── fastcgi.conf\n├── fastcgi.conf.default\n├── fastcgi_params\n├── fastcgi_params.default\n├── koi-utf\n├── koi-win\n├── mime.types\n├── mime.types.default\n├── nginx.conf\n├── nginx.conf.default\n├── scgi_params\n├── scgi_params.default\n├── uwsgi_params\n├── uwsgi_params.default\n└── win-utf\n```\n\n## 配置\n将 site1.cn 和site2.cn基于域名进行配置\n\n### 准备\n分别创建两个域名的配置文件和web根目录。\n\n./conf.d/下\n```\ncd conf.d/\ntouch site1.cn.conf\ntouch site2.cn.conf\n```\n分别创建web根目录\n```\nmkdri -p /data/www\ncd  /data/www\nmkdir site1.cn\nmkdir site2.cn\n```\n\n### 修改主配置文件nginx.conf\n```\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n}\n```\n确保在http的context中的server部分前面要有\n```\ninclude /etc/nginx/conf.d/*.conf;\n```\n通常情况下主配置文件中的server部分，将会是默认的server（通过添加default_server来声明），当一个请求过来，目录/etc/nginx/conf.d/中的所有server部分都匹配不了，那么这个请求将会被猪配置文件中的server来进行处理.\n\n### site1.cn\n修改配置文件\n```\nvi ./conf.d/site1.cn.conf\n```\n```\nserver {\n\tlisten\t\t80;\n\tserver_name\tsite1.cn;\n\n\terror_page  404  /404.html;\n\n\terror_page   500 503 504  /50x.html;\n\terror_log\t/var/log/nginx/debug.log debug;\n\tindex\tindex.html index.htm;\n\troot /data/www/site1.cn;\n\n\tlocation / {\n\t\tindex index.html;\n\t}\n\n  location = /favicon.ico {\n  \ttry_files $uri $uri/favicon.ico /data/www/site1.cn/favicon.ico =404;\n  }\n\n  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).\n  location ~ /\\. {\n      deny all;\n  }\n\n\tlocation = /50x.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n\n\tlocation = /404.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n}\n```\n添加测试页面\n```\ncd /data/www/site1.cn\necho \"site1.cn index.html\" >> index.html\n```\n\n### site2.cn\n修改配置文件\n```\nvi ./conf.d/site2.cn.conf\n```\n```\nserver {\n\tlisten\t\t80;\n\tserver_name\tsite2.cn;\n\n\terror_page  404  /404.html;\n\n\terror_page   500 503 504  /50x.html;\n\terror_log\t/var/log/nginx/debug.log debug;\n\tindex\tindex.html index.htm;\n\troot /data/www/site2.cn;\n\n\tlocation / {\n\t\tindex index.html;\n\t}\n\n  location = /favicon.ico {\n  \ttry_files $uri $uri/favicon.ico /data/www/site2.cn/favicon.ico =404;\n  }\n\n  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).\n  location ~ /\\. {\n      deny all;\n  }\n\n\tlocation = /50x.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n\n\tlocation = /404.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n}\n```\n添加测试页面\n```\ncd /data/www/site2.cn\necho \"site2.cn index.html\" >> index.html\n```\n\n### 重启Nginx\n重启之前，需要先进行配置文件语法检测\n```\nnginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n```\n确定语法无问题之后，重启Nginx\n```\nnginx -s reload\n```\n\n### 测试\nvi /etc/hosts\n添加\n```\nsite1.cn 127.0.0.1\nsite2.cn 127.0.0.1\n```\n分别访问 site1.cn和site2.cn ,查看是否输出对应内容\n```\nwget  site1.cn\ncat index.html\n#site1.cn index.html\n\nwget site2.cn\ncat index.html.2\n#site2.cn index.html\n```\n\n关于nginx学习的一个网站:http://nglua.com\n\nover~\n","source":"_posts/Nginx虚拟主机设置.md","raw":"---\ntitle: Nginx虚拟主机配置\ndate: 2016-10-04 20:30:00\nctime: 2016-10-04 20:30:00\nutime: 2016-10-04 20:30:00\nmodif_times: 0\ntags:\n- 虚拟主机\ncategories:\n- Nginx\n---\n\n![virtual Host](http://n.sinaimg.cn/games/3ece443e/20161004/VirtualHost.png)\n\n<!-- more -->\n\n## 准备\n\nLinux：Linux version 3.10.0-123.9.3.el7.x86_64\n\nNginx: nginx/1.6.3\n\n配置文件目录结构\n```\n$ tree\n.\n├── conf.d\n├── default.d\n├── fastcgi.conf\n├── fastcgi.conf.default\n├── fastcgi_params\n├── fastcgi_params.default\n├── koi-utf\n├── koi-win\n├── mime.types\n├── mime.types.default\n├── nginx.conf\n├── nginx.conf.default\n├── scgi_params\n├── scgi_params.default\n├── uwsgi_params\n├── uwsgi_params.default\n└── win-utf\n```\n\n## 配置\n将 site1.cn 和site2.cn基于域名进行配置\n\n### 准备\n分别创建两个域名的配置文件和web根目录。\n\n./conf.d/下\n```\ncd conf.d/\ntouch site1.cn.conf\ntouch site2.cn.conf\n```\n分别创建web根目录\n```\nmkdri -p /data/www\ncd  /data/www\nmkdir site1.cn\nmkdir site2.cn\n```\n\n### 修改主配置文件nginx.conf\n```\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n}\n```\n确保在http的context中的server部分前面要有\n```\ninclude /etc/nginx/conf.d/*.conf;\n```\n通常情况下主配置文件中的server部分，将会是默认的server（通过添加default_server来声明），当一个请求过来，目录/etc/nginx/conf.d/中的所有server部分都匹配不了，那么这个请求将会被猪配置文件中的server来进行处理.\n\n### site1.cn\n修改配置文件\n```\nvi ./conf.d/site1.cn.conf\n```\n```\nserver {\n\tlisten\t\t80;\n\tserver_name\tsite1.cn;\n\n\terror_page  404  /404.html;\n\n\terror_page   500 503 504  /50x.html;\n\terror_log\t/var/log/nginx/debug.log debug;\n\tindex\tindex.html index.htm;\n\troot /data/www/site1.cn;\n\n\tlocation / {\n\t\tindex index.html;\n\t}\n\n  location = /favicon.ico {\n  \ttry_files $uri $uri/favicon.ico /data/www/site1.cn/favicon.ico =404;\n  }\n\n  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).\n  location ~ /\\. {\n      deny all;\n  }\n\n\tlocation = /50x.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n\n\tlocation = /404.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n}\n```\n添加测试页面\n```\ncd /data/www/site1.cn\necho \"site1.cn index.html\" >> index.html\n```\n\n### site2.cn\n修改配置文件\n```\nvi ./conf.d/site2.cn.conf\n```\n```\nserver {\n\tlisten\t\t80;\n\tserver_name\tsite2.cn;\n\n\terror_page  404  /404.html;\n\n\terror_page   500 503 504  /50x.html;\n\terror_log\t/var/log/nginx/debug.log debug;\n\tindex\tindex.html index.htm;\n\troot /data/www/site2.cn;\n\n\tlocation / {\n\t\tindex index.html;\n\t}\n\n  location = /favicon.ico {\n  \ttry_files $uri $uri/favicon.ico /data/www/site2.cn/favicon.ico =404;\n  }\n\n  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).\n  location ~ /\\. {\n      deny all;\n  }\n\n\tlocation = /50x.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n\n\tlocation = /404.html {\n\t\troot   /usr/share/nginx/html;\n\t}\n}\n```\n添加测试页面\n```\ncd /data/www/site2.cn\necho \"site2.cn index.html\" >> index.html\n```\n\n### 重启Nginx\n重启之前，需要先进行配置文件语法检测\n```\nnginx -t\nnginx: the configuration file /etc/nginx/nginx.conf syntax is ok\nnginx: configuration file /etc/nginx/nginx.conf test is successful\n```\n确定语法无问题之后，重启Nginx\n```\nnginx -s reload\n```\n\n### 测试\nvi /etc/hosts\n添加\n```\nsite1.cn 127.0.0.1\nsite2.cn 127.0.0.1\n```\n分别访问 site1.cn和site2.cn ,查看是否输出对应内容\n```\nwget  site1.cn\ncat index.html\n#site1.cn index.html\n\nwget site2.cn\ncat index.html.2\n#site2.cn index.html\n```\n\n关于nginx学习的一个网站:http://nglua.com\n\nover~\n","slug":"Nginx虚拟主机设置","published":1,"updated":"2016-10-04T14:46:59.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwc0029699f65feno6a","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/VirtualHost.png\" alt=\"virtual Host\"></p>\n<a id=\"more\"></a>\n<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><p>Linux：Linux version 3.10.0-123.9.3.el7.x86_64</p>\n<p>Nginx: nginx/1.6.3</p>\n<p>配置文件目录结构<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ tree</div><div class=\"line\">.</div><div class=\"line\">├── conf.d</div><div class=\"line\">├── default.d</div><div class=\"line\">├── fastcgi.conf</div><div class=\"line\">├── fastcgi.conf.default</div><div class=\"line\">├── fastcgi_params</div><div class=\"line\">├── fastcgi_params.default</div><div class=\"line\">├── koi-utf</div><div class=\"line\">├── koi-win</div><div class=\"line\">├── mime.types</div><div class=\"line\">├── mime.types.default</div><div class=\"line\">├── nginx.conf</div><div class=\"line\">├── nginx.conf.default</div><div class=\"line\">├── scgi_params</div><div class=\"line\">├── scgi_params.default</div><div class=\"line\">├── uwsgi_params</div><div class=\"line\">├── uwsgi_params.default</div><div class=\"line\">└── win-utf</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><p>将 site1.cn 和site2.cn基于域名进行配置</p>\n<h3 id=\"准备-1\"><a href=\"#准备-1\" class=\"headerlink\" title=\"准备\"></a>准备</h3><p>分别创建两个域名的配置文件和web根目录。</p>\n<p>./conf.d/下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd conf.d/</div><div class=\"line\">touch site1.cn.conf</div><div class=\"line\">touch site2.cn.conf</div></pre></td></tr></table></figure></p>\n<p>分别创建web根目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">mkdri -p /data/www</div><div class=\"line\">cd  /data/www</div><div class=\"line\">mkdir site1.cn</div><div class=\"line\">mkdir site2.cn</div></pre></td></tr></table></figure></p>\n<h3 id=\"修改主配置文件nginx-conf\"><a href=\"#修改主配置文件nginx-conf\" class=\"headerlink\" title=\"修改主配置文件nginx.conf\"></a>修改主配置文件nginx.conf</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div></pre></td><td class=\"code\"><pre><div class=\"line\">user nginx;</div><div class=\"line\">worker_processes auto;</div><div class=\"line\">error_log /var/log/nginx/error.log;</div><div class=\"line\">pid /run/nginx.pid;</div><div class=\"line\"></div><div class=\"line\">events &#123;</div><div class=\"line\">    worker_connections 1024;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">http &#123;</div><div class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class=\"line\"></div><div class=\"line\">    access_log  /var/log/nginx/access.log  main;</div><div class=\"line\"></div><div class=\"line\">    sendfile            on;</div><div class=\"line\">    tcp_nopush          on;</div><div class=\"line\">    tcp_nodelay         on;</div><div class=\"line\">    keepalive_timeout   65;</div><div class=\"line\">    types_hash_max_size 2048;</div><div class=\"line\"></div><div class=\"line\">    include             /etc/nginx/mime.types;</div><div class=\"line\">    default_type        application/octet-stream;</div><div class=\"line\"></div><div class=\"line\">    # Load modular configuration files from the /etc/nginx/conf.d directory.</div><div class=\"line\">    # See http://nginx.org/en/docs/ngx_core_module.html#include</div><div class=\"line\">    # for more information.</div><div class=\"line\">    include /etc/nginx/conf.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">    server &#123;</div><div class=\"line\">        listen       80 default_server;</div><div class=\"line\">        listen       [::]:80 default_server;</div><div class=\"line\">        server_name  _;</div><div class=\"line\">        root         /usr/share/nginx/html;</div><div class=\"line\"></div><div class=\"line\">        # Load configuration files for the default server block.</div><div class=\"line\">        include /etc/nginx/default.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">        location / &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 404 /404.html;</div><div class=\"line\">            location = /40x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 500 502 503 504 /50x.html;</div><div class=\"line\">            location = /50x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>确保在http的context中的server部分前面要有<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">include /etc/nginx/conf.d/*.conf;</div></pre></td></tr></table></figure></p>\n<p>通常情况下主配置文件中的server部分，将会是默认的server（通过添加default_server来声明），当一个请求过来，目录/etc/nginx/conf.d/中的所有server部分都匹配不了，那么这个请求将会被猪配置文件中的server来进行处理.</p>\n<h3 id=\"site1-cn\"><a href=\"#site1-cn\" class=\"headerlink\" title=\"site1.cn\"></a>site1.cn</h3><p>修改配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ./conf.d/site1.cn.conf</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">\tlisten\t\t80;</div><div class=\"line\">\tserver_name\tsite1.cn;</div><div class=\"line\"></div><div class=\"line\">\terror_page  404  /404.html;</div><div class=\"line\"></div><div class=\"line\">\terror_page   500 503 504  /50x.html;</div><div class=\"line\">\terror_log\t/var/log/nginx/debug.log debug;</div><div class=\"line\">\tindex\tindex.html index.htm;</div><div class=\"line\">\troot /data/www/site1.cn;</div><div class=\"line\"></div><div class=\"line\">\tlocation / &#123;</div><div class=\"line\">\t\tindex index.html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">  location = /favicon.ico &#123;</div><div class=\"line\">  \ttry_files $uri $uri/favicon.ico /data/www/site1.cn/favicon.ico =404;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).</div><div class=\"line\">  location ~ /\\. &#123;</div><div class=\"line\">      deny all;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /50x.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /404.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>添加测试页面<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/www/site1.cn</div><div class=\"line\">echo &quot;site1.cn index.html&quot; &gt;&gt; index.html</div></pre></td></tr></table></figure></p>\n<h3 id=\"site2-cn\"><a href=\"#site2-cn\" class=\"headerlink\" title=\"site2.cn\"></a>site2.cn</h3><p>修改配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ./conf.d/site2.cn.conf</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">\tlisten\t\t80;</div><div class=\"line\">\tserver_name\tsite2.cn;</div><div class=\"line\"></div><div class=\"line\">\terror_page  404  /404.html;</div><div class=\"line\"></div><div class=\"line\">\terror_page   500 503 504  /50x.html;</div><div class=\"line\">\terror_log\t/var/log/nginx/debug.log debug;</div><div class=\"line\">\tindex\tindex.html index.htm;</div><div class=\"line\">\troot /data/www/site2.cn;</div><div class=\"line\"></div><div class=\"line\">\tlocation / &#123;</div><div class=\"line\">\t\tindex index.html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">  location = /favicon.ico &#123;</div><div class=\"line\">  \ttry_files $uri $uri/favicon.ico /data/www/site2.cn/favicon.ico =404;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).</div><div class=\"line\">  location ~ /\\. &#123;</div><div class=\"line\">      deny all;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /50x.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /404.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>添加测试页面<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/www/site2.cn</div><div class=\"line\">echo &quot;site2.cn index.html&quot; &gt;&gt; index.html</div></pre></td></tr></table></figure></p>\n<h3 id=\"重启Nginx\"><a href=\"#重启Nginx\" class=\"headerlink\" title=\"重启Nginx\"></a>重启Nginx</h3><p>重启之前，需要先进行配置文件语法检测<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -t</div><div class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>确定语法无问题之后，重启Nginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -s reload</div></pre></td></tr></table></figure></p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>vi /etc/hosts<br>添加<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">site1.cn 127.0.0.1</div><div class=\"line\">site2.cn 127.0.0.1</div></pre></td></tr></table></figure></p>\n<p>分别访问 site1.cn和site2.cn ,查看是否输出对应内容<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget  site1.cn</div><div class=\"line\">cat index.html</div><div class=\"line\">#site1.cn index.html</div><div class=\"line\"></div><div class=\"line\">wget site2.cn</div><div class=\"line\">cat index.html.2</div><div class=\"line\">#site2.cn index.html</div></pre></td></tr></table></figure></p>\n<p>关于nginx学习的一个网站:<a href=\"http://nglua.com\" target=\"_blank\" rel=\"external\">http://nglua.com</a></p>\n<p>over~</p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161004/VirtualHost.png\" alt=\"virtual Host\"></p>","more":"<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><p>Linux：Linux version 3.10.0-123.9.3.el7.x86_64</p>\n<p>Nginx: nginx/1.6.3</p>\n<p>配置文件目录结构<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ tree</div><div class=\"line\">.</div><div class=\"line\">├── conf.d</div><div class=\"line\">├── default.d</div><div class=\"line\">├── fastcgi.conf</div><div class=\"line\">├── fastcgi.conf.default</div><div class=\"line\">├── fastcgi_params</div><div class=\"line\">├── fastcgi_params.default</div><div class=\"line\">├── koi-utf</div><div class=\"line\">├── koi-win</div><div class=\"line\">├── mime.types</div><div class=\"line\">├── mime.types.default</div><div class=\"line\">├── nginx.conf</div><div class=\"line\">├── nginx.conf.default</div><div class=\"line\">├── scgi_params</div><div class=\"line\">├── scgi_params.default</div><div class=\"line\">├── uwsgi_params</div><div class=\"line\">├── uwsgi_params.default</div><div class=\"line\">└── win-utf</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置\"><a href=\"#配置\" class=\"headerlink\" title=\"配置\"></a>配置</h2><p>将 site1.cn 和site2.cn基于域名进行配置</p>\n<h3 id=\"准备-1\"><a href=\"#准备-1\" class=\"headerlink\" title=\"准备\"></a>准备</h3><p>分别创建两个域名的配置文件和web根目录。</p>\n<p>./conf.d/下<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd conf.d/</div><div class=\"line\">touch site1.cn.conf</div><div class=\"line\">touch site2.cn.conf</div></pre></td></tr></table></figure></p>\n<p>分别创建web根目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">mkdri -p /data/www</div><div class=\"line\">cd  /data/www</div><div class=\"line\">mkdir site1.cn</div><div class=\"line\">mkdir site2.cn</div></pre></td></tr></table></figure></p>\n<h3 id=\"修改主配置文件nginx-conf\"><a href=\"#修改主配置文件nginx-conf\" class=\"headerlink\" title=\"修改主配置文件nginx.conf\"></a>修改主配置文件nginx.conf</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div></pre></td><td class=\"code\"><pre><div class=\"line\">user nginx;</div><div class=\"line\">worker_processes auto;</div><div class=\"line\">error_log /var/log/nginx/error.log;</div><div class=\"line\">pid /run/nginx.pid;</div><div class=\"line\"></div><div class=\"line\">events &#123;</div><div class=\"line\">    worker_connections 1024;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">http &#123;</div><div class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class=\"line\"></div><div class=\"line\">    access_log  /var/log/nginx/access.log  main;</div><div class=\"line\"></div><div class=\"line\">    sendfile            on;</div><div class=\"line\">    tcp_nopush          on;</div><div class=\"line\">    tcp_nodelay         on;</div><div class=\"line\">    keepalive_timeout   65;</div><div class=\"line\">    types_hash_max_size 2048;</div><div class=\"line\"></div><div class=\"line\">    include             /etc/nginx/mime.types;</div><div class=\"line\">    default_type        application/octet-stream;</div><div class=\"line\"></div><div class=\"line\">    # Load modular configuration files from the /etc/nginx/conf.d directory.</div><div class=\"line\">    # See http://nginx.org/en/docs/ngx_core_module.html#include</div><div class=\"line\">    # for more information.</div><div class=\"line\">    include /etc/nginx/conf.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">    server &#123;</div><div class=\"line\">        listen       80 default_server;</div><div class=\"line\">        listen       [::]:80 default_server;</div><div class=\"line\">        server_name  _;</div><div class=\"line\">        root         /usr/share/nginx/html;</div><div class=\"line\"></div><div class=\"line\">        # Load configuration files for the default server block.</div><div class=\"line\">        include /etc/nginx/default.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">        location / &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 404 /404.html;</div><div class=\"line\">            location = /40x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 500 502 503 504 /50x.html;</div><div class=\"line\">            location = /50x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>确保在http的context中的server部分前面要有<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">include /etc/nginx/conf.d/*.conf;</div></pre></td></tr></table></figure></p>\n<p>通常情况下主配置文件中的server部分，将会是默认的server（通过添加default_server来声明），当一个请求过来，目录/etc/nginx/conf.d/中的所有server部分都匹配不了，那么这个请求将会被猪配置文件中的server来进行处理.</p>\n<h3 id=\"site1-cn\"><a href=\"#site1-cn\" class=\"headerlink\" title=\"site1.cn\"></a>site1.cn</h3><p>修改配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ./conf.d/site1.cn.conf</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">\tlisten\t\t80;</div><div class=\"line\">\tserver_name\tsite1.cn;</div><div class=\"line\"></div><div class=\"line\">\terror_page  404  /404.html;</div><div class=\"line\"></div><div class=\"line\">\terror_page   500 503 504  /50x.html;</div><div class=\"line\">\terror_log\t/var/log/nginx/debug.log debug;</div><div class=\"line\">\tindex\tindex.html index.htm;</div><div class=\"line\">\troot /data/www/site1.cn;</div><div class=\"line\"></div><div class=\"line\">\tlocation / &#123;</div><div class=\"line\">\t\tindex index.html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">  location = /favicon.ico &#123;</div><div class=\"line\">  \ttry_files $uri $uri/favicon.ico /data/www/site1.cn/favicon.ico =404;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).</div><div class=\"line\">  location ~ /\\. &#123;</div><div class=\"line\">      deny all;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /50x.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /404.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>添加测试页面<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/www/site1.cn</div><div class=\"line\">echo &quot;site1.cn index.html&quot; &gt;&gt; index.html</div></pre></td></tr></table></figure></p>\n<h3 id=\"site2-cn\"><a href=\"#site2-cn\" class=\"headerlink\" title=\"site2.cn\"></a>site2.cn</h3><p>修改配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ./conf.d/site2.cn.conf</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div></pre></td><td class=\"code\"><pre><div class=\"line\">server &#123;</div><div class=\"line\">\tlisten\t\t80;</div><div class=\"line\">\tserver_name\tsite2.cn;</div><div class=\"line\"></div><div class=\"line\">\terror_page  404  /404.html;</div><div class=\"line\"></div><div class=\"line\">\terror_page   500 503 504  /50x.html;</div><div class=\"line\">\terror_log\t/var/log/nginx/debug.log debug;</div><div class=\"line\">\tindex\tindex.html index.htm;</div><div class=\"line\">\troot /data/www/site2.cn;</div><div class=\"line\"></div><div class=\"line\">\tlocation / &#123;</div><div class=\"line\">\t\tindex index.html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">  location = /favicon.ico &#123;</div><div class=\"line\">  \ttry_files $uri $uri/favicon.ico /data/www/site2.cn/favicon.ico =404;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  # Deny all attempts to access hidden files such as .htaccess, .htpasswd, .DS_Store(Mac).</div><div class=\"line\">  location ~ /\\. &#123;</div><div class=\"line\">      deny all;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /50x.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\tlocation = /404.html &#123;</div><div class=\"line\">\t\troot   /usr/share/nginx/html;</div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>添加测试页面<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /data/www/site2.cn</div><div class=\"line\">echo &quot;site2.cn index.html&quot; &gt;&gt; index.html</div></pre></td></tr></table></figure></p>\n<h3 id=\"重启Nginx\"><a href=\"#重启Nginx\" class=\"headerlink\" title=\"重启Nginx\"></a>重启Nginx</h3><p>重启之前，需要先进行配置文件语法检测<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -t</div><div class=\"line\">nginx: the configuration file /etc/nginx/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /etc/nginx/nginx.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>确定语法无问题之后，重启Nginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">nginx -s reload</div></pre></td></tr></table></figure></p>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><p>vi /etc/hosts<br>添加<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">site1.cn 127.0.0.1</div><div class=\"line\">site2.cn 127.0.0.1</div></pre></td></tr></table></figure></p>\n<p>分别访问 site1.cn和site2.cn ,查看是否输出对应内容<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget  site1.cn</div><div class=\"line\">cat index.html</div><div class=\"line\">#site1.cn index.html</div><div class=\"line\"></div><div class=\"line\">wget site2.cn</div><div class=\"line\">cat index.html.2</div><div class=\"line\">#site2.cn index.html</div></pre></td></tr></table></figure></p>\n<p>关于nginx学习的一个网站:<a href=\"http://nglua.com\">http://nglua.com</a></p>\n<p>over~</p>"},{"title":"PHP-FPM运行状态监控","date":"2016-09-27T13:30:00.000Z","_content":"PHP-FPM内置了一个运行状态页，开启后便可查看PHP-FPM的详细运行状态，可以给我们在优化PHP-FPM时带来帮助。\n\n<!-- more -->\n\n## php-fpm配置\n查看php-fpm配置文件\n```\n$ /usr/local/php56/sbin/php-fpm -t\n[27-Sep-2016 14:59:06] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful\n```\n开启php-fpm的status配置\n```\nvi /usr/local/php56/etc/php-fpm.conf\n```\n修改加入：\n```\npm.status_path = /phpfpm_status\n```\n配置文件中相关的说明\n```\n; The URI to view the FPM status page. If this value is not set, no URI will be\n; recognized as a status page. It shows the following informations:\n;   pool                 - the name of the pool;\n;   process manager      - static, dynamic or ondemand;\n;   start time           - the date and time FPM has started;\n;   start since          - number of seconds since FPM has started;\n;   accepted conn        - the number of request accepted by the pool;\n;   listen queue         - the number of request in the queue of pending\n;                          connections (see backlog in listen(2));\n;   max listen queue     - the maximum number of requests in the queue\n;                          of pending connections since FPM has started;\n;   listen queue len     - the size of the socket queue of pending connections;\n;   idle processes       - the number of idle processes;\n;   active processes     - the number of active processes;\n;   total processes      - the number of idle + active processes;\n;   max active processes - the maximum number of active processes since FPM\n;                          has started;\n;   max children reached - number of times, the process limit has been reached,\n;                          when pm tries to start more children (works only for\n;                          pm 'dynamic' and 'ondemand');\n; Value are updated in real time.\n; Value are updated in real time.\n; Example output:\n;   pool:                 www\n;   process manager:      static\n;   start time:           01/Jul/2011:17:53:49 +0200\n;   start since:          62636\n;   accepted conn:        190460\n;   listen queue:         0\n;   max listen queue:     1\n;   listen queue len:     42\n;   idle processes:       4\n;   active processes:     11\n;   total processes:      15\n;   max active processes: 12\n;   max children reached: 0\n;\n; By default the status page output is formatted as text/plain. Passing either\n; 'html', 'xml' or 'json' in the query string will return the corresponding\n; output syntax. Example:\n;   http://www.foo.bar/status\n;   http://www.foo.bar/status?json\n;   http://www.foo.bar/status?html\n;   http://www.foo.bar/status?xml\n;\n; By default the status page only outputs short status. Passing 'full' in the\n; query string will also return status for each pool process.\n; Example:\n;   http://www.foo.bar/status?full\n;   http://www.foo.bar/status?json&full\n;   http://www.foo.bar/status?html&full\n;   http://www.foo.bar/status?xml&full\n; The Full status returns for each process:\n; The Full status returns for each process:\n;   pid                  - the PID of the process;\n;   state                - the state of the process (Idle, Running, ...);\n;   start time           - the date and time the process has started;\n;   start since          - the number of seconds since the process has started;\n;   requests             - the number of requests the process has served;\n;   request duration     - the duration in µs of the requests;\n;   request method       - the request method (GET, POST, ...);\n;   request URI          - the request URI with the query string;\n;   content length       - the content length of the request (only with POST);\n;   user                 - the user (PHP_AUTH_USER) (or '-' if not set);\n;   script               - the main script called (or '-' if not set);\n;   last request cpu     - the %cpu the last request consumed\n;                          it's always 0 if the process is not in Idle state\n;                          because CPU calculation is done when the request\n;                          processing has terminated;\n;   last request memory  - the max amount of memory the last request consumed\n;                          it's always 0 if the process is not in Idle state\n;                          because memory calculation is done when the request\n;                          processing has terminated;\n; If the process is in Idle state, then informations are related to the\n; last request the process has served. Otherwise informations are related to\n; the current request being served.\n; Example output:\n;   ************************\n;   pid:                  31330\n;   state:                Running\n;   start time:           01/Jul/2011:17:53:49 +0200\n;   start since:          63087\n;   requests:             12808\n;   request duration:     1250261\n;   request method:       GET\n;   request URI:          /test_mem.php?N=10000\n;   content length:       0\n;   user:                 -\n;   script:               /home/fat/web/docs/php/test_mem.php\n;   last request cpu:     0.00\n;   last request memory:  0\n;\n; Note: There is a real-time FPM status monitoring sample web page available\n;       It's available in: /usr/local/php56/share/php/fpm/status.html\n;\n; Note: The value must start with a leading slash (/). The value can be\n;       anything, but it may not be a good idea to use the .php extension or it\n;       may conflict with a real PHP file.\n; Default Value: not set\npm.status_path = /phpfpm_status\n```\n## 重启PHP-FPM\n```\nkill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`\n```\n\n## 配置nginx代理\n查看nginx配置文件\n```\n/usr/local/nginx/sbin/nginx -t\nnginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful\n```\n\n修改配置\n```\nvi /usr/local/nginx/conf/nginx.conf\n```\n加入：\n```\nlocation /phpfpm_status {\n        fastcgi_pass  127.0.0.1:9000;\n        include fastcgi_params;\n        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;\n}\n```\n\n重启nginx\n```\n/usr/local/nginx/sbin/nginx -s reload\n```\n\n## 测试\n浏览器或者通过curl访问\n\n[http://you-server-ip/phpfpm_status](http://127.0.0.1/phpfpm_status)\n\n```\n[root@iZwz9g8nzni5lj69dhlesoZ ~]# curl 127.0.0.1/phpfpm_status\npool:                 www\nprocess manager:      dynamic\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          385\naccepted conn:        3\nlisten queue:         0\nmax listen queue:     0\nlisten queue len:     128\nidle processes:       1\nactive processes:     1\ntotal processes:      2\nmax active processes: 1\nmax children reached: 0\nslow requests:        0\n```\n\n- 参数说明：\n\n参数| 说明\n----|-----\npool | fpm池子名称，大多数为www\nprocess manager | 进程管理方式,值：static, dynamic or ondemand. dynamic\nstart time | 启动日期,如果reload了php-fpm，时间会更新\nstart since | 运行时长\naccepted conn | 当前池子接受的请求数\nlisten queue | 请求等待队列，如果这个值不为0，那么要增加FPM的进程数量\nmax listen queue | 请求等待队列最高的数量\nlisten queue len | socket等待队列长度\nidle processes | 空闲进程数量\nactive processes | 活跃进程数量\ntotal processes | 总进程数量\nmax active processes | 最大的活跃进程数量（FPM启动开始算）\nmax children reached | 大道进程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量太小了，请改大一点。\nslow requests | 启用了php-fpm slow-log，缓慢请求的数量\n\n- php-fpm还提供不同格式的输入，方便我们查看和与其他监控系统对接。\n\n```\nhttp://www.foo.bar/status       #默认纯文本\nhttp://www.foo.bar/status?json  #json格式\nhttp://www.foo.bar/status?html  #html\nhttp://www.foo.bar/status?xml   #xml\n```\n\n- 通过增加full参数，php-fpm还提供查看所有进程的运行状况\n\n```\nhttp://www.foo.bar/status?full        #默认纯文本\nhttp://www.foo.bar/status?json&full   #json格式\nhttp://www.foo.bar/status?html&full   #html\nhttp://www.foo.bar/status?xml&full    #xml\n```\n\n示例：\n```\ncurl 'http://127.0.0.1/phpfpm_status?full'\npool:                 www\nprocess manager:      dynamic\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          1546\naccepted conn:        14\nlisten queue:         0\nmax listen queue:     0\nlisten queue len:     128\nidle processes:       1\nactive processes:     1\ntotal processes:      2\nmax active processes: 1\nmax children reached: 0\nslow requests:        0\n************************\npid:                  12132\nstate:                Running\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          1546\nrequests:             7\nrequest duration:     117\nrequest method:       GET\nrequest URI:          /phpfpm_status?full\ncontent length:       0\nuser:                 -\nscript:               /phpfpm_status\nlast request cpu:     0.00\nlast request memory:  0\n************************\npid:                  12133\nstate:                Idle\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          1546\nrequests:             7\nrequest duration:     132\nrequest method:       GET\nrequest URI:          /phpfpm_status?html&full\ncontent length:       0\nuser:                 -\nscript:               /phpfpm_status\nlast request cpu:     0.00\nlast request memory:  262144\n```\n\n具体进程参数说明\n\n参数 | 说明\n----|-----\npid | 进程号\nstate | 状态（Idle - 闲置， Running - 运行， ...）\nstart time | 进程开始运行时间\nstart since | 进程开始持续时间（单位：秒）\nrequests | 进程已经处理的请求数\nrequest duration | µs的请求数量\nrequest method | 请求方式（GET, POST, ...）\nrequest URI | 请求URI\ncontent length | 请求内容长度（仅限POST请求）\nuser | PHP_AUTH_USER （'-'， 表示没有限制）\nscript | 请求文件\nlast request cpu | 最后一次请求占用CPU百分比（如果进程不是处于 `Idle - 闲置` 状态，该值总是0，因为当请求处理终止时，CPU计算已经完成）\nlast request memory | 最后一次请求占用内存（如果进程不是处于 `Idle - 闲置` 状态，该值总是0，因为当请求处理终止时，memory计算已经完成）\n\n**Tips:**\n如果进程处于 idle 状态，所显示的信息就是基于最后一次请求给出的状态，否则就是基于本次请求的状态。\n","source":"_posts/PHP-FPM运行状态监控.md","raw":"---\ntitle: PHP-FPM运行状态监控\ndate: 2016-09-27 21:30:00\ntags:\n- PHP-FPM\n- 监控\ncategories:\n- PHP\n---\nPHP-FPM内置了一个运行状态页，开启后便可查看PHP-FPM的详细运行状态，可以给我们在优化PHP-FPM时带来帮助。\n\n<!-- more -->\n\n## php-fpm配置\n查看php-fpm配置文件\n```\n$ /usr/local/php56/sbin/php-fpm -t\n[27-Sep-2016 14:59:06] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful\n```\n开启php-fpm的status配置\n```\nvi /usr/local/php56/etc/php-fpm.conf\n```\n修改加入：\n```\npm.status_path = /phpfpm_status\n```\n配置文件中相关的说明\n```\n; The URI to view the FPM status page. If this value is not set, no URI will be\n; recognized as a status page. It shows the following informations:\n;   pool                 - the name of the pool;\n;   process manager      - static, dynamic or ondemand;\n;   start time           - the date and time FPM has started;\n;   start since          - number of seconds since FPM has started;\n;   accepted conn        - the number of request accepted by the pool;\n;   listen queue         - the number of request in the queue of pending\n;                          connections (see backlog in listen(2));\n;   max listen queue     - the maximum number of requests in the queue\n;                          of pending connections since FPM has started;\n;   listen queue len     - the size of the socket queue of pending connections;\n;   idle processes       - the number of idle processes;\n;   active processes     - the number of active processes;\n;   total processes      - the number of idle + active processes;\n;   max active processes - the maximum number of active processes since FPM\n;                          has started;\n;   max children reached - number of times, the process limit has been reached,\n;                          when pm tries to start more children (works only for\n;                          pm 'dynamic' and 'ondemand');\n; Value are updated in real time.\n; Value are updated in real time.\n; Example output:\n;   pool:                 www\n;   process manager:      static\n;   start time:           01/Jul/2011:17:53:49 +0200\n;   start since:          62636\n;   accepted conn:        190460\n;   listen queue:         0\n;   max listen queue:     1\n;   listen queue len:     42\n;   idle processes:       4\n;   active processes:     11\n;   total processes:      15\n;   max active processes: 12\n;   max children reached: 0\n;\n; By default the status page output is formatted as text/plain. Passing either\n; 'html', 'xml' or 'json' in the query string will return the corresponding\n; output syntax. Example:\n;   http://www.foo.bar/status\n;   http://www.foo.bar/status?json\n;   http://www.foo.bar/status?html\n;   http://www.foo.bar/status?xml\n;\n; By default the status page only outputs short status. Passing 'full' in the\n; query string will also return status for each pool process.\n; Example:\n;   http://www.foo.bar/status?full\n;   http://www.foo.bar/status?json&full\n;   http://www.foo.bar/status?html&full\n;   http://www.foo.bar/status?xml&full\n; The Full status returns for each process:\n; The Full status returns for each process:\n;   pid                  - the PID of the process;\n;   state                - the state of the process (Idle, Running, ...);\n;   start time           - the date and time the process has started;\n;   start since          - the number of seconds since the process has started;\n;   requests             - the number of requests the process has served;\n;   request duration     - the duration in µs of the requests;\n;   request method       - the request method (GET, POST, ...);\n;   request URI          - the request URI with the query string;\n;   content length       - the content length of the request (only with POST);\n;   user                 - the user (PHP_AUTH_USER) (or '-' if not set);\n;   script               - the main script called (or '-' if not set);\n;   last request cpu     - the %cpu the last request consumed\n;                          it's always 0 if the process is not in Idle state\n;                          because CPU calculation is done when the request\n;                          processing has terminated;\n;   last request memory  - the max amount of memory the last request consumed\n;                          it's always 0 if the process is not in Idle state\n;                          because memory calculation is done when the request\n;                          processing has terminated;\n; If the process is in Idle state, then informations are related to the\n; last request the process has served. Otherwise informations are related to\n; the current request being served.\n; Example output:\n;   ************************\n;   pid:                  31330\n;   state:                Running\n;   start time:           01/Jul/2011:17:53:49 +0200\n;   start since:          63087\n;   requests:             12808\n;   request duration:     1250261\n;   request method:       GET\n;   request URI:          /test_mem.php?N=10000\n;   content length:       0\n;   user:                 -\n;   script:               /home/fat/web/docs/php/test_mem.php\n;   last request cpu:     0.00\n;   last request memory:  0\n;\n; Note: There is a real-time FPM status monitoring sample web page available\n;       It's available in: /usr/local/php56/share/php/fpm/status.html\n;\n; Note: The value must start with a leading slash (/). The value can be\n;       anything, but it may not be a good idea to use the .php extension or it\n;       may conflict with a real PHP file.\n; Default Value: not set\npm.status_path = /phpfpm_status\n```\n## 重启PHP-FPM\n```\nkill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`\n```\n\n## 配置nginx代理\n查看nginx配置文件\n```\n/usr/local/nginx/sbin/nginx -t\nnginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok\nnginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful\n```\n\n修改配置\n```\nvi /usr/local/nginx/conf/nginx.conf\n```\n加入：\n```\nlocation /phpfpm_status {\n        fastcgi_pass  127.0.0.1:9000;\n        include fastcgi_params;\n        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;\n}\n```\n\n重启nginx\n```\n/usr/local/nginx/sbin/nginx -s reload\n```\n\n## 测试\n浏览器或者通过curl访问\n\n[http://you-server-ip/phpfpm_status](http://127.0.0.1/phpfpm_status)\n\n```\n[root@iZwz9g8nzni5lj69dhlesoZ ~]# curl 127.0.0.1/phpfpm_status\npool:                 www\nprocess manager:      dynamic\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          385\naccepted conn:        3\nlisten queue:         0\nmax listen queue:     0\nlisten queue len:     128\nidle processes:       1\nactive processes:     1\ntotal processes:      2\nmax active processes: 1\nmax children reached: 0\nslow requests:        0\n```\n\n- 参数说明：\n\n参数| 说明\n----|-----\npool | fpm池子名称，大多数为www\nprocess manager | 进程管理方式,值：static, dynamic or ondemand. dynamic\nstart time | 启动日期,如果reload了php-fpm，时间会更新\nstart since | 运行时长\naccepted conn | 当前池子接受的请求数\nlisten queue | 请求等待队列，如果这个值不为0，那么要增加FPM的进程数量\nmax listen queue | 请求等待队列最高的数量\nlisten queue len | socket等待队列长度\nidle processes | 空闲进程数量\nactive processes | 活跃进程数量\ntotal processes | 总进程数量\nmax active processes | 最大的活跃进程数量（FPM启动开始算）\nmax children reached | 大道进程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量太小了，请改大一点。\nslow requests | 启用了php-fpm slow-log，缓慢请求的数量\n\n- php-fpm还提供不同格式的输入，方便我们查看和与其他监控系统对接。\n\n```\nhttp://www.foo.bar/status       #默认纯文本\nhttp://www.foo.bar/status?json  #json格式\nhttp://www.foo.bar/status?html  #html\nhttp://www.foo.bar/status?xml   #xml\n```\n\n- 通过增加full参数，php-fpm还提供查看所有进程的运行状况\n\n```\nhttp://www.foo.bar/status?full        #默认纯文本\nhttp://www.foo.bar/status?json&full   #json格式\nhttp://www.foo.bar/status?html&full   #html\nhttp://www.foo.bar/status?xml&full    #xml\n```\n\n示例：\n```\ncurl 'http://127.0.0.1/phpfpm_status?full'\npool:                 www\nprocess manager:      dynamic\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          1546\naccepted conn:        14\nlisten queue:         0\nmax listen queue:     0\nlisten queue len:     128\nidle processes:       1\nactive processes:     1\ntotal processes:      2\nmax active processes: 1\nmax children reached: 0\nslow requests:        0\n************************\npid:                  12132\nstate:                Running\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          1546\nrequests:             7\nrequest duration:     117\nrequest method:       GET\nrequest URI:          /phpfpm_status?full\ncontent length:       0\nuser:                 -\nscript:               /phpfpm_status\nlast request cpu:     0.00\nlast request memory:  0\n************************\npid:                  12133\nstate:                Idle\nstart time:           27/Sep/2016:15:08:57 +0800\nstart since:          1546\nrequests:             7\nrequest duration:     132\nrequest method:       GET\nrequest URI:          /phpfpm_status?html&full\ncontent length:       0\nuser:                 -\nscript:               /phpfpm_status\nlast request cpu:     0.00\nlast request memory:  262144\n```\n\n具体进程参数说明\n\n参数 | 说明\n----|-----\npid | 进程号\nstate | 状态（Idle - 闲置， Running - 运行， ...）\nstart time | 进程开始运行时间\nstart since | 进程开始持续时间（单位：秒）\nrequests | 进程已经处理的请求数\nrequest duration | µs的请求数量\nrequest method | 请求方式（GET, POST, ...）\nrequest URI | 请求URI\ncontent length | 请求内容长度（仅限POST请求）\nuser | PHP_AUTH_USER （'-'， 表示没有限制）\nscript | 请求文件\nlast request cpu | 最后一次请求占用CPU百分比（如果进程不是处于 `Idle - 闲置` 状态，该值总是0，因为当请求处理终止时，CPU计算已经完成）\nlast request memory | 最后一次请求占用内存（如果进程不是处于 `Idle - 闲置` 状态，该值总是0，因为当请求处理终止时，memory计算已经完成）\n\n**Tips:**\n如果进程处于 idle 状态，所显示的信息就是基于最后一次请求给出的状态，否则就是基于本次请求的状态。\n","slug":"PHP-FPM运行状态监控","published":1,"updated":"2016-09-27T09:29:18.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwe002c699fx5osx7dz","content":"<p>PHP-FPM内置了一个运行状态页，开启后便可查看PHP-FPM的详细运行状态，可以给我们在优化PHP-FPM时带来帮助。</p>\n<a id=\"more\"></a>\n<h2 id=\"php-fpm配置\"><a href=\"#php-fpm配置\" class=\"headerlink\" title=\"php-fpm配置\"></a>php-fpm配置</h2><p>查看php-fpm配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ /usr/local/php56/sbin/php-fpm -t</div><div class=\"line\">[27-Sep-2016 14:59:06] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>开启php-fpm的status配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>\n<p>修改加入：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pm.status_path = /phpfpm_status</div></pre></td></tr></table></figure></p>\n<p>配置文件中相关的说明<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div></pre></td><td class=\"code\"><pre><div class=\"line\">; The URI to view the FPM status page. If this value is not set, no URI will be</div><div class=\"line\">; recognized as a status page. It shows the following informations:</div><div class=\"line\">;   pool                 - the name of the pool;</div><div class=\"line\">;   process manager      - static, dynamic or ondemand;</div><div class=\"line\">;   start time           - the date and time FPM has started;</div><div class=\"line\">;   start since          - number of seconds since FPM has started;</div><div class=\"line\">;   accepted conn        - the number of request accepted by the pool;</div><div class=\"line\">;   listen queue         - the number of request in the queue of pending</div><div class=\"line\">;                          connections (see backlog in listen(2));</div><div class=\"line\">;   max listen queue     - the maximum number of requests in the queue</div><div class=\"line\">;                          of pending connections since FPM has started;</div><div class=\"line\">;   listen queue len     - the size of the socket queue of pending connections;</div><div class=\"line\">;   idle processes       - the number of idle processes;</div><div class=\"line\">;   active processes     - the number of active processes;</div><div class=\"line\">;   total processes      - the number of idle + active processes;</div><div class=\"line\">;   max active processes - the maximum number of active processes since FPM</div><div class=\"line\">;                          has started;</div><div class=\"line\">;   max children reached - number of times, the process limit has been reached,</div><div class=\"line\">;                          when pm tries to start more children (works only for</div><div class=\"line\">;                          pm &apos;dynamic&apos; and &apos;ondemand&apos;);</div><div class=\"line\">; Value are updated in real time.</div><div class=\"line\">; Value are updated in real time.</div><div class=\"line\">; Example output:</div><div class=\"line\">;   pool:                 www</div><div class=\"line\">;   process manager:      static</div><div class=\"line\">;   start time:           01/Jul/2011:17:53:49 +0200</div><div class=\"line\">;   start since:          62636</div><div class=\"line\">;   accepted conn:        190460</div><div class=\"line\">;   listen queue:         0</div><div class=\"line\">;   max listen queue:     1</div><div class=\"line\">;   listen queue len:     42</div><div class=\"line\">;   idle processes:       4</div><div class=\"line\">;   active processes:     11</div><div class=\"line\">;   total processes:      15</div><div class=\"line\">;   max active processes: 12</div><div class=\"line\">;   max children reached: 0</div><div class=\"line\">;</div><div class=\"line\">; By default the status page output is formatted as text/plain. Passing either</div><div class=\"line\">; &apos;html&apos;, &apos;xml&apos; or &apos;json&apos; in the query string will return the corresponding</div><div class=\"line\">; output syntax. Example:</div><div class=\"line\">;   http://www.foo.bar/status</div><div class=\"line\">;   http://www.foo.bar/status?json</div><div class=\"line\">;   http://www.foo.bar/status?html</div><div class=\"line\">;   http://www.foo.bar/status?xml</div><div class=\"line\">;</div><div class=\"line\">; By default the status page only outputs short status. Passing &apos;full&apos; in the</div><div class=\"line\">; query string will also return status for each pool process.</div><div class=\"line\">; Example:</div><div class=\"line\">;   http://www.foo.bar/status?full</div><div class=\"line\">;   http://www.foo.bar/status?json&amp;full</div><div class=\"line\">;   http://www.foo.bar/status?html&amp;full</div><div class=\"line\">;   http://www.foo.bar/status?xml&amp;full</div><div class=\"line\">; The Full status returns for each process:</div><div class=\"line\">; The Full status returns for each process:</div><div class=\"line\">;   pid                  - the PID of the process;</div><div class=\"line\">;   state                - the state of the process (Idle, Running, ...);</div><div class=\"line\">;   start time           - the date and time the process has started;</div><div class=\"line\">;   start since          - the number of seconds since the process has started;</div><div class=\"line\">;   requests             - the number of requests the process has served;</div><div class=\"line\">;   request duration     - the duration in µs of the requests;</div><div class=\"line\">;   request method       - the request method (GET, POST, ...);</div><div class=\"line\">;   request URI          - the request URI with the query string;</div><div class=\"line\">;   content length       - the content length of the request (only with POST);</div><div class=\"line\">;   user                 - the user (PHP_AUTH_USER) (or &apos;-&apos; if not set);</div><div class=\"line\">;   script               - the main script called (or &apos;-&apos; if not set);</div><div class=\"line\">;   last request cpu     - the %cpu the last request consumed</div><div class=\"line\">;                          it&apos;s always 0 if the process is not in Idle state</div><div class=\"line\">;                          because CPU calculation is done when the request</div><div class=\"line\">;                          processing has terminated;</div><div class=\"line\">;   last request memory  - the max amount of memory the last request consumed</div><div class=\"line\">;                          it&apos;s always 0 if the process is not in Idle state</div><div class=\"line\">;                          because memory calculation is done when the request</div><div class=\"line\">;                          processing has terminated;</div><div class=\"line\">; If the process is in Idle state, then informations are related to the</div><div class=\"line\">; last request the process has served. Otherwise informations are related to</div><div class=\"line\">; the current request being served.</div><div class=\"line\">; Example output:</div><div class=\"line\">;   ************************</div><div class=\"line\">;   pid:                  31330</div><div class=\"line\">;   state:                Running</div><div class=\"line\">;   start time:           01/Jul/2011:17:53:49 +0200</div><div class=\"line\">;   start since:          63087</div><div class=\"line\">;   requests:             12808</div><div class=\"line\">;   request duration:     1250261</div><div class=\"line\">;   request method:       GET</div><div class=\"line\">;   request URI:          /test_mem.php?N=10000</div><div class=\"line\">;   content length:       0</div><div class=\"line\">;   user:                 -</div><div class=\"line\">;   script:               /home/fat/web/docs/php/test_mem.php</div><div class=\"line\">;   last request cpu:     0.00</div><div class=\"line\">;   last request memory:  0</div><div class=\"line\">;</div><div class=\"line\">; Note: There is a real-time FPM status monitoring sample web page available</div><div class=\"line\">;       It&apos;s available in: /usr/local/php56/share/php/fpm/status.html</div><div class=\"line\">;</div><div class=\"line\">; Note: The value must start with a leading slash (/). The value can be</div><div class=\"line\">;       anything, but it may not be a good idea to use the .php extension or it</div><div class=\"line\">;       may conflict with a real PHP file.</div><div class=\"line\">; Default Value: not set</div><div class=\"line\">pm.status_path = /phpfpm_status</div></pre></td></tr></table></figure></p>\n<h2 id=\"重启PHP-FPM\"><a href=\"#重启PHP-FPM\" class=\"headerlink\" title=\"重启PHP-FPM\"></a>重启PHP-FPM</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure>\n<h2 id=\"配置nginx代理\"><a href=\"#配置nginx代理\" class=\"headerlink\" title=\"配置nginx代理\"></a>配置nginx代理</h2><p>查看nginx配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -t</div><div class=\"line\">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>修改配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure></p>\n<p>加入：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">location /phpfpm_status &#123;</div><div class=\"line\">        fastcgi_pass  127.0.0.1:9000;</div><div class=\"line\">        include fastcgi_params;</div><div class=\"line\">        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>重启nginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>浏览器或者通过curl访问</p>\n<p><a href=\"http://127.0.0.1/phpfpm_status\" target=\"_blank\" rel=\"external\">http://you-server-ip/phpfpm_status</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZwz9g8nzni5lj69dhlesoZ ~]# curl 127.0.0.1/phpfpm_status</div><div class=\"line\">pool:                 www</div><div class=\"line\">process manager:      dynamic</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          385</div><div class=\"line\">accepted conn:        3</div><div class=\"line\">listen queue:         0</div><div class=\"line\">max listen queue:     0</div><div class=\"line\">listen queue len:     128</div><div class=\"line\">idle processes:       1</div><div class=\"line\">active processes:     1</div><div class=\"line\">total processes:      2</div><div class=\"line\">max active processes: 1</div><div class=\"line\">max children reached: 0</div><div class=\"line\">slow requests:        0</div></pre></td></tr></table></figure>\n<ul>\n<li>参数说明：</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pool</td>\n<td>fpm池子名称，大多数为www</td>\n</tr>\n<tr>\n<td>process manager</td>\n<td>进程管理方式,值：static, dynamic or ondemand. dynamic</td>\n</tr>\n<tr>\n<td>start time</td>\n<td>启动日期,如果reload了php-fpm，时间会更新</td>\n</tr>\n<tr>\n<td>start since</td>\n<td>运行时长</td>\n</tr>\n<tr>\n<td>accepted conn</td>\n<td>当前池子接受的请求数</td>\n</tr>\n<tr>\n<td>listen queue</td>\n<td>请求等待队列，如果这个值不为0，那么要增加FPM的进程数量</td>\n</tr>\n<tr>\n<td>max listen queue</td>\n<td>请求等待队列最高的数量</td>\n</tr>\n<tr>\n<td>listen queue len</td>\n<td>socket等待队列长度</td>\n</tr>\n<tr>\n<td>idle processes</td>\n<td>空闲进程数量</td>\n</tr>\n<tr>\n<td>active processes</td>\n<td>活跃进程数量</td>\n</tr>\n<tr>\n<td>total processes</td>\n<td>总进程数量</td>\n</tr>\n<tr>\n<td>max active processes</td>\n<td>最大的活跃进程数量（FPM启动开始算）</td>\n</tr>\n<tr>\n<td>max children reached</td>\n<td>大道进程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量太小了，请改大一点。</td>\n</tr>\n<tr>\n<td>slow requests</td>\n<td>启用了php-fpm slow-log，缓慢请求的数量</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>php-fpm还提供不同格式的输入，方便我们查看和与其他监控系统对接。</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">http://www.foo.bar/status       #默认纯文本</div><div class=\"line\">http://www.foo.bar/status?json  #json格式</div><div class=\"line\">http://www.foo.bar/status?html  #html</div><div class=\"line\">http://www.foo.bar/status?xml   #xml</div></pre></td></tr></table></figure>\n<ul>\n<li>通过增加full参数，php-fpm还提供查看所有进程的运行状况</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">http://www.foo.bar/status?full        #默认纯文本</div><div class=\"line\">http://www.foo.bar/status?json&amp;full   #json格式</div><div class=\"line\">http://www.foo.bar/status?html&amp;full   #html</div><div class=\"line\">http://www.foo.bar/status?xml&amp;full    #xml</div></pre></td></tr></table></figure>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div></pre></td><td class=\"code\"><pre><div class=\"line\">curl &apos;http://127.0.0.1/phpfpm_status?full&apos;</div><div class=\"line\">pool:                 www</div><div class=\"line\">process manager:      dynamic</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          1546</div><div class=\"line\">accepted conn:        14</div><div class=\"line\">listen queue:         0</div><div class=\"line\">max listen queue:     0</div><div class=\"line\">listen queue len:     128</div><div class=\"line\">idle processes:       1</div><div class=\"line\">active processes:     1</div><div class=\"line\">total processes:      2</div><div class=\"line\">max active processes: 1</div><div class=\"line\">max children reached: 0</div><div class=\"line\">slow requests:        0</div><div class=\"line\">************************</div><div class=\"line\">pid:                  12132</div><div class=\"line\">state:                Running</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          1546</div><div class=\"line\">requests:             7</div><div class=\"line\">request duration:     117</div><div class=\"line\">request method:       GET</div><div class=\"line\">request URI:          /phpfpm_status?full</div><div class=\"line\">content length:       0</div><div class=\"line\">user:                 -</div><div class=\"line\">script:               /phpfpm_status</div><div class=\"line\">last request cpu:     0.00</div><div class=\"line\">last request memory:  0</div><div class=\"line\">************************</div><div class=\"line\">pid:                  12133</div><div class=\"line\">state:                Idle</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          1546</div><div class=\"line\">requests:             7</div><div class=\"line\">request duration:     132</div><div class=\"line\">request method:       GET</div><div class=\"line\">request URI:          /phpfpm_status?html&amp;full</div><div class=\"line\">content length:       0</div><div class=\"line\">user:                 -</div><div class=\"line\">script:               /phpfpm_status</div><div class=\"line\">last request cpu:     0.00</div><div class=\"line\">last request memory:  262144</div></pre></td></tr></table></figure></p>\n<p>具体进程参数说明</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pid</td>\n<td>进程号</td>\n</tr>\n<tr>\n<td>state</td>\n<td>状态（Idle - 闲置， Running - 运行， …）</td>\n</tr>\n<tr>\n<td>start time</td>\n<td>进程开始运行时间</td>\n</tr>\n<tr>\n<td>start since</td>\n<td>进程开始持续时间（单位：秒）</td>\n</tr>\n<tr>\n<td>requests</td>\n<td>进程已经处理的请求数</td>\n</tr>\n<tr>\n<td>request duration</td>\n<td>µs的请求数量</td>\n</tr>\n<tr>\n<td>request method</td>\n<td>请求方式（GET, POST, …）</td>\n</tr>\n<tr>\n<td>request URI</td>\n<td>请求URI</td>\n</tr>\n<tr>\n<td>content length</td>\n<td>请求内容长度（仅限POST请求）</td>\n</tr>\n<tr>\n<td>user</td>\n<td>PHP_AUTH_USER （’-‘， 表示没有限制）</td>\n</tr>\n<tr>\n<td>script</td>\n<td>请求文件</td>\n</tr>\n<tr>\n<td>last request cpu</td>\n<td>最后一次请求占用CPU百分比（如果进程不是处于 <code>Idle - 闲置</code> 状态，该值总是0，因为当请求处理终止时，CPU计算已经完成）</td>\n</tr>\n<tr>\n<td>last request memory</td>\n<td>最后一次请求占用内存（如果进程不是处于 <code>Idle - 闲置</code> 状态，该值总是0，因为当请求处理终止时，memory计算已经完成）</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Tips:</strong><br>如果进程处于 idle 状态，所显示的信息就是基于最后一次请求给出的状态，否则就是基于本次请求的状态。</p>\n","excerpt":"<p>PHP-FPM内置了一个运行状态页，开启后便可查看PHP-FPM的详细运行状态，可以给我们在优化PHP-FPM时带来帮助。</p>","more":"<h2 id=\"php-fpm配置\"><a href=\"#php-fpm配置\" class=\"headerlink\" title=\"php-fpm配置\"></a>php-fpm配置</h2><p>查看php-fpm配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ /usr/local/php56/sbin/php-fpm -t</div><div class=\"line\">[27-Sep-2016 14:59:06] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>开启php-fpm的status配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>\n<p>修改加入：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">pm.status_path = /phpfpm_status</div></pre></td></tr></table></figure></p>\n<p>配置文件中相关的说明<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div></pre></td><td class=\"code\"><pre><div class=\"line\">; The URI to view the FPM status page. If this value is not set, no URI will be</div><div class=\"line\">; recognized as a status page. It shows the following informations:</div><div class=\"line\">;   pool                 - the name of the pool;</div><div class=\"line\">;   process manager      - static, dynamic or ondemand;</div><div class=\"line\">;   start time           - the date and time FPM has started;</div><div class=\"line\">;   start since          - number of seconds since FPM has started;</div><div class=\"line\">;   accepted conn        - the number of request accepted by the pool;</div><div class=\"line\">;   listen queue         - the number of request in the queue of pending</div><div class=\"line\">;                          connections (see backlog in listen(2));</div><div class=\"line\">;   max listen queue     - the maximum number of requests in the queue</div><div class=\"line\">;                          of pending connections since FPM has started;</div><div class=\"line\">;   listen queue len     - the size of the socket queue of pending connections;</div><div class=\"line\">;   idle processes       - the number of idle processes;</div><div class=\"line\">;   active processes     - the number of active processes;</div><div class=\"line\">;   total processes      - the number of idle + active processes;</div><div class=\"line\">;   max active processes - the maximum number of active processes since FPM</div><div class=\"line\">;                          has started;</div><div class=\"line\">;   max children reached - number of times, the process limit has been reached,</div><div class=\"line\">;                          when pm tries to start more children (works only for</div><div class=\"line\">;                          pm &apos;dynamic&apos; and &apos;ondemand&apos;);</div><div class=\"line\">; Value are updated in real time.</div><div class=\"line\">; Value are updated in real time.</div><div class=\"line\">; Example output:</div><div class=\"line\">;   pool:                 www</div><div class=\"line\">;   process manager:      static</div><div class=\"line\">;   start time:           01/Jul/2011:17:53:49 +0200</div><div class=\"line\">;   start since:          62636</div><div class=\"line\">;   accepted conn:        190460</div><div class=\"line\">;   listen queue:         0</div><div class=\"line\">;   max listen queue:     1</div><div class=\"line\">;   listen queue len:     42</div><div class=\"line\">;   idle processes:       4</div><div class=\"line\">;   active processes:     11</div><div class=\"line\">;   total processes:      15</div><div class=\"line\">;   max active processes: 12</div><div class=\"line\">;   max children reached: 0</div><div class=\"line\">;</div><div class=\"line\">; By default the status page output is formatted as text/plain. Passing either</div><div class=\"line\">; &apos;html&apos;, &apos;xml&apos; or &apos;json&apos; in the query string will return the corresponding</div><div class=\"line\">; output syntax. Example:</div><div class=\"line\">;   http://www.foo.bar/status</div><div class=\"line\">;   http://www.foo.bar/status?json</div><div class=\"line\">;   http://www.foo.bar/status?html</div><div class=\"line\">;   http://www.foo.bar/status?xml</div><div class=\"line\">;</div><div class=\"line\">; By default the status page only outputs short status. Passing &apos;full&apos; in the</div><div class=\"line\">; query string will also return status for each pool process.</div><div class=\"line\">; Example:</div><div class=\"line\">;   http://www.foo.bar/status?full</div><div class=\"line\">;   http://www.foo.bar/status?json&amp;full</div><div class=\"line\">;   http://www.foo.bar/status?html&amp;full</div><div class=\"line\">;   http://www.foo.bar/status?xml&amp;full</div><div class=\"line\">; The Full status returns for each process:</div><div class=\"line\">; The Full status returns for each process:</div><div class=\"line\">;   pid                  - the PID of the process;</div><div class=\"line\">;   state                - the state of the process (Idle, Running, ...);</div><div class=\"line\">;   start time           - the date and time the process has started;</div><div class=\"line\">;   start since          - the number of seconds since the process has started;</div><div class=\"line\">;   requests             - the number of requests the process has served;</div><div class=\"line\">;   request duration     - the duration in µs of the requests;</div><div class=\"line\">;   request method       - the request method (GET, POST, ...);</div><div class=\"line\">;   request URI          - the request URI with the query string;</div><div class=\"line\">;   content length       - the content length of the request (only with POST);</div><div class=\"line\">;   user                 - the user (PHP_AUTH_USER) (or &apos;-&apos; if not set);</div><div class=\"line\">;   script               - the main script called (or &apos;-&apos; if not set);</div><div class=\"line\">;   last request cpu     - the %cpu the last request consumed</div><div class=\"line\">;                          it&apos;s always 0 if the process is not in Idle state</div><div class=\"line\">;                          because CPU calculation is done when the request</div><div class=\"line\">;                          processing has terminated;</div><div class=\"line\">;   last request memory  - the max amount of memory the last request consumed</div><div class=\"line\">;                          it&apos;s always 0 if the process is not in Idle state</div><div class=\"line\">;                          because memory calculation is done when the request</div><div class=\"line\">;                          processing has terminated;</div><div class=\"line\">; If the process is in Idle state, then informations are related to the</div><div class=\"line\">; last request the process has served. Otherwise informations are related to</div><div class=\"line\">; the current request being served.</div><div class=\"line\">; Example output:</div><div class=\"line\">;   ************************</div><div class=\"line\">;   pid:                  31330</div><div class=\"line\">;   state:                Running</div><div class=\"line\">;   start time:           01/Jul/2011:17:53:49 +0200</div><div class=\"line\">;   start since:          63087</div><div class=\"line\">;   requests:             12808</div><div class=\"line\">;   request duration:     1250261</div><div class=\"line\">;   request method:       GET</div><div class=\"line\">;   request URI:          /test_mem.php?N=10000</div><div class=\"line\">;   content length:       0</div><div class=\"line\">;   user:                 -</div><div class=\"line\">;   script:               /home/fat/web/docs/php/test_mem.php</div><div class=\"line\">;   last request cpu:     0.00</div><div class=\"line\">;   last request memory:  0</div><div class=\"line\">;</div><div class=\"line\">; Note: There is a real-time FPM status monitoring sample web page available</div><div class=\"line\">;       It&apos;s available in: /usr/local/php56/share/php/fpm/status.html</div><div class=\"line\">;</div><div class=\"line\">; Note: The value must start with a leading slash (/). The value can be</div><div class=\"line\">;       anything, but it may not be a good idea to use the .php extension or it</div><div class=\"line\">;       may conflict with a real PHP file.</div><div class=\"line\">; Default Value: not set</div><div class=\"line\">pm.status_path = /phpfpm_status</div></pre></td></tr></table></figure></p>\n<h2 id=\"重启PHP-FPM\"><a href=\"#重启PHP-FPM\" class=\"headerlink\" title=\"重启PHP-FPM\"></a>重启PHP-FPM</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure>\n<h2 id=\"配置nginx代理\"><a href=\"#配置nginx代理\" class=\"headerlink\" title=\"配置nginx代理\"></a>配置nginx代理</h2><p>查看nginx配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -t</div><div class=\"line\">nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok</div><div class=\"line\">nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>修改配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure></p>\n<p>加入：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">location /phpfpm_status &#123;</div><div class=\"line\">        fastcgi_pass  127.0.0.1:9000;</div><div class=\"line\">        include fastcgi_params;</div><div class=\"line\">        fastcgi_param SCRIPT_FILENAME $fastcgi_script_name;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>重启nginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>浏览器或者通过curl访问</p>\n<p><a href=\"http://127.0.0.1/phpfpm_status\">http://you-server-ip/phpfpm_status</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZwz9g8nzni5lj69dhlesoZ ~]# curl 127.0.0.1/phpfpm_status</div><div class=\"line\">pool:                 www</div><div class=\"line\">process manager:      dynamic</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          385</div><div class=\"line\">accepted conn:        3</div><div class=\"line\">listen queue:         0</div><div class=\"line\">max listen queue:     0</div><div class=\"line\">listen queue len:     128</div><div class=\"line\">idle processes:       1</div><div class=\"line\">active processes:     1</div><div class=\"line\">total processes:      2</div><div class=\"line\">max active processes: 1</div><div class=\"line\">max children reached: 0</div><div class=\"line\">slow requests:        0</div></pre></td></tr></table></figure>\n<ul>\n<li>参数说明：</li>\n</ul>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pool</td>\n<td>fpm池子名称，大多数为www</td>\n</tr>\n<tr>\n<td>process manager</td>\n<td>进程管理方式,值：static, dynamic or ondemand. dynamic</td>\n</tr>\n<tr>\n<td>start time</td>\n<td>启动日期,如果reload了php-fpm，时间会更新</td>\n</tr>\n<tr>\n<td>start since</td>\n<td>运行时长</td>\n</tr>\n<tr>\n<td>accepted conn</td>\n<td>当前池子接受的请求数</td>\n</tr>\n<tr>\n<td>listen queue</td>\n<td>请求等待队列，如果这个值不为0，那么要增加FPM的进程数量</td>\n</tr>\n<tr>\n<td>max listen queue</td>\n<td>请求等待队列最高的数量</td>\n</tr>\n<tr>\n<td>listen queue len</td>\n<td>socket等待队列长度</td>\n</tr>\n<tr>\n<td>idle processes</td>\n<td>空闲进程数量</td>\n</tr>\n<tr>\n<td>active processes</td>\n<td>活跃进程数量</td>\n</tr>\n<tr>\n<td>total processes</td>\n<td>总进程数量</td>\n</tr>\n<tr>\n<td>max active processes</td>\n<td>最大的活跃进程数量（FPM启动开始算）</td>\n</tr>\n<tr>\n<td>max children reached</td>\n<td>大道进程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量太小了，请改大一点。</td>\n</tr>\n<tr>\n<td>slow requests</td>\n<td>启用了php-fpm slow-log，缓慢请求的数量</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li>php-fpm还提供不同格式的输入，方便我们查看和与其他监控系统对接。</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">http://www.foo.bar/status       #默认纯文本</div><div class=\"line\">http://www.foo.bar/status?json  #json格式</div><div class=\"line\">http://www.foo.bar/status?html  #html</div><div class=\"line\">http://www.foo.bar/status?xml   #xml</div></pre></td></tr></table></figure>\n<ul>\n<li>通过增加full参数，php-fpm还提供查看所有进程的运行状况</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">http://www.foo.bar/status?full        #默认纯文本</div><div class=\"line\">http://www.foo.bar/status?json&amp;full   #json格式</div><div class=\"line\">http://www.foo.bar/status?html&amp;full   #html</div><div class=\"line\">http://www.foo.bar/status?xml&amp;full    #xml</div></pre></td></tr></table></figure>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div></pre></td><td class=\"code\"><pre><div class=\"line\">curl &apos;http://127.0.0.1/phpfpm_status?full&apos;</div><div class=\"line\">pool:                 www</div><div class=\"line\">process manager:      dynamic</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          1546</div><div class=\"line\">accepted conn:        14</div><div class=\"line\">listen queue:         0</div><div class=\"line\">max listen queue:     0</div><div class=\"line\">listen queue len:     128</div><div class=\"line\">idle processes:       1</div><div class=\"line\">active processes:     1</div><div class=\"line\">total processes:      2</div><div class=\"line\">max active processes: 1</div><div class=\"line\">max children reached: 0</div><div class=\"line\">slow requests:        0</div><div class=\"line\">************************</div><div class=\"line\">pid:                  12132</div><div class=\"line\">state:                Running</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          1546</div><div class=\"line\">requests:             7</div><div class=\"line\">request duration:     117</div><div class=\"line\">request method:       GET</div><div class=\"line\">request URI:          /phpfpm_status?full</div><div class=\"line\">content length:       0</div><div class=\"line\">user:                 -</div><div class=\"line\">script:               /phpfpm_status</div><div class=\"line\">last request cpu:     0.00</div><div class=\"line\">last request memory:  0</div><div class=\"line\">************************</div><div class=\"line\">pid:                  12133</div><div class=\"line\">state:                Idle</div><div class=\"line\">start time:           27/Sep/2016:15:08:57 +0800</div><div class=\"line\">start since:          1546</div><div class=\"line\">requests:             7</div><div class=\"line\">request duration:     132</div><div class=\"line\">request method:       GET</div><div class=\"line\">request URI:          /phpfpm_status?html&amp;full</div><div class=\"line\">content length:       0</div><div class=\"line\">user:                 -</div><div class=\"line\">script:               /phpfpm_status</div><div class=\"line\">last request cpu:     0.00</div><div class=\"line\">last request memory:  262144</div></pre></td></tr></table></figure></p>\n<p>具体进程参数说明</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pid</td>\n<td>进程号</td>\n</tr>\n<tr>\n<td>state</td>\n<td>状态（Idle - 闲置， Running - 运行， …）</td>\n</tr>\n<tr>\n<td>start time</td>\n<td>进程开始运行时间</td>\n</tr>\n<tr>\n<td>start since</td>\n<td>进程开始持续时间（单位：秒）</td>\n</tr>\n<tr>\n<td>requests</td>\n<td>进程已经处理的请求数</td>\n</tr>\n<tr>\n<td>request duration</td>\n<td>µs的请求数量</td>\n</tr>\n<tr>\n<td>request method</td>\n<td>请求方式（GET, POST, …）</td>\n</tr>\n<tr>\n<td>request URI</td>\n<td>请求URI</td>\n</tr>\n<tr>\n<td>content length</td>\n<td>请求内容长度（仅限POST请求）</td>\n</tr>\n<tr>\n<td>user</td>\n<td>PHP_AUTH_USER （’-‘， 表示没有限制）</td>\n</tr>\n<tr>\n<td>script</td>\n<td>请求文件</td>\n</tr>\n<tr>\n<td>last request cpu</td>\n<td>最后一次请求占用CPU百分比（如果进程不是处于 <code>Idle - 闲置</code> 状态，该值总是0，因为当请求处理终止时，CPU计算已经完成）</td>\n</tr>\n<tr>\n<td>last request memory</td>\n<td>最后一次请求占用内存（如果进程不是处于 <code>Idle - 闲置</code> 状态，该值总是0，因为当请求处理终止时，memory计算已经完成）</td>\n</tr>\n</tbody>\n</table>\n<p><strong>Tips:</strong><br>如果进程处于 idle 状态，所显示的信息就是基于最后一次请求给出的状态，否则就是基于本次请求的状态。</p>"},{"title":"Nginx运行状态监控","date":"2016-09-27T14:30:00.000Z","_content":"\nNginx可以通过stub_status模块来查看服务器的状态信息。\n\n<!-- more -->\n## 安装stub_status模块\n查看服务器当前是否已经编译安装过stub_status模块\n```\n/usr/local/nginx/sbin/nginx -V\nnginx version: nginx/1.11.4\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)\nconfigure arguments: --prefix=/usr/local/nginx\n```\n安装 stub_status 模块\n\n解压相应版本的nginx源码包，\n```\ncd nginx-1.11.4\n```\n配置\n```\n./configure --prefix=/usr/local/nginx --with-http_stub_status_module\n```\n编译（不执行make install操作）\n```\nmake\n```\n手动替换 nginx 执行文件\n```\nmv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak\ncp ./objs/nginx /usr/local/nginx/sbin/\n```\n查看是否安装成功\n```\n/usr/local/nginx/sbin/nginx -V\nnginx version: nginx/1.11.4\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)\nconfigure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module\n```\n\n## 启用nginx status配置\n\n修改配置\n```\nvi /usr/local/nginx/conf/nginx.conf\n```\n加入配置\n```\nlocation /ngx_status\n{\n    stub_status on;\n    access_log off;\n    allow all;\n    #deny all;\n}\n```\n重启nginx\n```\n# /usr/local/nginx/sbin/nginx -s reload 可能或有问题，所以先停止当前nginx进程，然后在重启。\n/usr/local/nginx/sbin/nginx -s stop\n/usr/local/nginx/sbin/nginx\n```\n\n## 测试\n\n浏览器或者curl访问\n\nhttp://120.76.250.101/ngx_status\n或\n```\ncurl 127.0.0.1/ngx_status\nActive connections: 1\nserver accepts handled requests\n 2 2 2\nReading: 0 Writing: 1 Waiting: 0\n```\n\n参数说明\n\n参数 | 说明\n----|-----\nActive connections | 活跃的连接数量\nserver accepts handled requests | 2 2 2 表示总共处理了2个连接 , 成功创建2次握手, 总共处理了2个请求\nreading | 读取客户端的连接数.\nwriting | 响应数据到客户端的数量\nwaiting | 开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.\n\nover~\n","source":"_posts/Nginx运行状态监控.md","raw":"---\ntitle: Nginx运行状态监控\ndate: 2016-09-27 22:30:00\ntags:\n- 监控\ncategories:\n- Nginx\n---\n\nNginx可以通过stub_status模块来查看服务器的状态信息。\n\n<!-- more -->\n## 安装stub_status模块\n查看服务器当前是否已经编译安装过stub_status模块\n```\n/usr/local/nginx/sbin/nginx -V\nnginx version: nginx/1.11.4\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)\nconfigure arguments: --prefix=/usr/local/nginx\n```\n安装 stub_status 模块\n\n解压相应版本的nginx源码包，\n```\ncd nginx-1.11.4\n```\n配置\n```\n./configure --prefix=/usr/local/nginx --with-http_stub_status_module\n```\n编译（不执行make install操作）\n```\nmake\n```\n手动替换 nginx 执行文件\n```\nmv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak\ncp ./objs/nginx /usr/local/nginx/sbin/\n```\n查看是否安装成功\n```\n/usr/local/nginx/sbin/nginx -V\nnginx version: nginx/1.11.4\nbuilt by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)\nconfigure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module\n```\n\n## 启用nginx status配置\n\n修改配置\n```\nvi /usr/local/nginx/conf/nginx.conf\n```\n加入配置\n```\nlocation /ngx_status\n{\n    stub_status on;\n    access_log off;\n    allow all;\n    #deny all;\n}\n```\n重启nginx\n```\n# /usr/local/nginx/sbin/nginx -s reload 可能或有问题，所以先停止当前nginx进程，然后在重启。\n/usr/local/nginx/sbin/nginx -s stop\n/usr/local/nginx/sbin/nginx\n```\n\n## 测试\n\n浏览器或者curl访问\n\nhttp://120.76.250.101/ngx_status\n或\n```\ncurl 127.0.0.1/ngx_status\nActive connections: 1\nserver accepts handled requests\n 2 2 2\nReading: 0 Writing: 1 Waiting: 0\n```\n\n参数说明\n\n参数 | 说明\n----|-----\nActive connections | 活跃的连接数量\nserver accepts handled requests | 2 2 2 表示总共处理了2个连接 , 成功创建2次握手, 总共处理了2个请求\nreading | 读取客户端的连接数.\nwriting | 响应数据到客户端的数量\nwaiting | 开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.\n\nover~\n","slug":"Nginx运行状态监控","published":1,"updated":"2016-09-27T09:41:45.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwf002f699feqybhswy","content":"<p>Nginx可以通过stub_status模块来查看服务器的状态信息。</p>\n<a id=\"more\"></a>\n<h2 id=\"安装stub-status模块\"><a href=\"#安装stub-status模块\" class=\"headerlink\" title=\"安装stub_status模块\"></a>安装stub_status模块</h2><p>查看服务器当前是否已经编译安装过stub_status模块<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -V</div><div class=\"line\">nginx version: nginx/1.11.4</div><div class=\"line\">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)</div><div class=\"line\">configure arguments: --prefix=/usr/local/nginx</div></pre></td></tr></table></figure></p>\n<p>安装 stub_status 模块</p>\n<p>解压相应版本的nginx源码包，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd nginx-1.11.4</div></pre></td></tr></table></figure></p>\n<p>配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/nginx --with-http_stub_status_module</div></pre></td></tr></table></figure></p>\n<p>编译（不执行make install操作）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">make</div></pre></td></tr></table></figure></p>\n<p>手动替换 nginx 执行文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</div><div class=\"line\">cp ./objs/nginx /usr/local/nginx/sbin/</div></pre></td></tr></table></figure></p>\n<p>查看是否安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -V</div><div class=\"line\">nginx version: nginx/1.11.4</div><div class=\"line\">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)</div><div class=\"line\">configure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module</div></pre></td></tr></table></figure></p>\n<h2 id=\"启用nginx-status配置\"><a href=\"#启用nginx-status配置\" class=\"headerlink\" title=\"启用nginx status配置\"></a>启用nginx status配置</h2><p>修改配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure></p>\n<p>加入配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">location /ngx_status</div><div class=\"line\">&#123;</div><div class=\"line\">    stub_status on;</div><div class=\"line\">    access_log off;</div><div class=\"line\">    allow all;</div><div class=\"line\">    #deny all;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>重启nginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/nginx/sbin/nginx -s reload 可能或有问题，所以先停止当前nginx进程，然后在重启。</div><div class=\"line\">/usr/local/nginx/sbin/nginx -s stop</div><div class=\"line\">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>浏览器或者curl访问</p>\n<p><a href=\"http://120.76.250.101/ngx_status\" target=\"_blank\" rel=\"external\">http://120.76.250.101/ngx_status</a><br>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">curl 127.0.0.1/ngx_status</div><div class=\"line\">Active connections: 1</div><div class=\"line\">server accepts handled requests</div><div class=\"line\"> 2 2 2</div><div class=\"line\">Reading: 0 Writing: 1 Waiting: 0</div></pre></td></tr></table></figure></p>\n<p>参数说明</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Active connections</td>\n<td>活跃的连接数量</td>\n</tr>\n<tr>\n<td>server accepts handled requests</td>\n<td>2 2 2 表示总共处理了2个连接 , 成功创建2次握手, 总共处理了2个请求</td>\n</tr>\n<tr>\n<td>reading</td>\n<td>读取客户端的连接数.</td>\n</tr>\n<tr>\n<td>writing</td>\n<td>响应数据到客户端的数量</td>\n</tr>\n<tr>\n<td>waiting</td>\n<td>开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.</td>\n</tr>\n</tbody>\n</table>\n<p>over~</p>\n","excerpt":"<p>Nginx可以通过stub_status模块来查看服务器的状态信息。</p>","more":"<h2 id=\"安装stub-status模块\"><a href=\"#安装stub-status模块\" class=\"headerlink\" title=\"安装stub_status模块\"></a>安装stub_status模块</h2><p>查看服务器当前是否已经编译安装过stub_status模块<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -V</div><div class=\"line\">nginx version: nginx/1.11.4</div><div class=\"line\">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)</div><div class=\"line\">configure arguments: --prefix=/usr/local/nginx</div></pre></td></tr></table></figure></p>\n<p>安装 stub_status 模块</p>\n<p>解压相应版本的nginx源码包，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd nginx-1.11.4</div></pre></td></tr></table></figure></p>\n<p>配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/nginx --with-http_stub_status_module</div></pre></td></tr></table></figure></p>\n<p>编译（不执行make install操作）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">make</div></pre></td></tr></table></figure></p>\n<p>手动替换 nginx 执行文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.bak</div><div class=\"line\">cp ./objs/nginx /usr/local/nginx/sbin/</div></pre></td></tr></table></figure></p>\n<p>查看是否安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -V</div><div class=\"line\">nginx version: nginx/1.11.4</div><div class=\"line\">built by gcc 4.8.5 20150623 (Red Hat 4.8.5-4) (GCC)</div><div class=\"line\">configure arguments: --prefix=/usr/local/nginx --with-http_stub_status_module</div></pre></td></tr></table></figure></p>\n<h2 id=\"启用nginx-status配置\"><a href=\"#启用nginx-status配置\" class=\"headerlink\" title=\"启用nginx status配置\"></a>启用nginx status配置</h2><p>修改配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/nginx/conf/nginx.conf</div></pre></td></tr></table></figure></p>\n<p>加入配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">location /ngx_status</div><div class=\"line\">&#123;</div><div class=\"line\">    stub_status on;</div><div class=\"line\">    access_log off;</div><div class=\"line\">    allow all;</div><div class=\"line\">    #deny all;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>重启nginx<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/nginx/sbin/nginx -s reload 可能或有问题，所以先停止当前nginx进程，然后在重启。</div><div class=\"line\">/usr/local/nginx/sbin/nginx -s stop</div><div class=\"line\">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>浏览器或者curl访问</p>\n<p><a href=\"http://120.76.250.101/ngx_status\">http://120.76.250.101/ngx_status</a><br>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">curl 127.0.0.1/ngx_status</div><div class=\"line\">Active connections: 1</div><div class=\"line\">server accepts handled requests</div><div class=\"line\"> 2 2 2</div><div class=\"line\">Reading: 0 Writing: 1 Waiting: 0</div></pre></td></tr></table></figure></p>\n<p>参数说明</p>\n<table>\n<thead>\n<tr>\n<th>参数</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Active connections</td>\n<td>活跃的连接数量</td>\n</tr>\n<tr>\n<td>server accepts handled requests</td>\n<td>2 2 2 表示总共处理了2个连接 , 成功创建2次握手, 总共处理了2个请求</td>\n</tr>\n<tr>\n<td>reading</td>\n<td>读取客户端的连接数.</td>\n</tr>\n<tr>\n<td>writing</td>\n<td>响应数据到客户端的数量</td>\n</tr>\n<tr>\n<td>waiting</td>\n<td>开启 keep-alive 的情况下,这个值等于 active – (reading+writing), 意思就是 Nginx 已经处理完正在等候下一次请求指令的驻留连接.</td>\n</tr>\n</tbody>\n</table>\n<p>over~</p>"},{"title":"Nginx配置整理","date":"2016-10-03T14:30:00.000Z","ctime":"2016-10-03T14:30:00.000Z","utime":"2016-10-03T14:30:00.000Z","modif_times":0,"_content":"\nNginx配置主要分成四部分：main、server、upstream 和 location，每部分包含若干个指令。\nmain(全局设置)\n> 该部分设置的指令将影响其它所有部分的设置；\n\nserver(主机设置)\n> 该部分的指令主要用于指定虚拟主机域名、IP和端口；\n\nupstream(上游服务器设置)\n> 该部分的指令用于设置一系列的后端服务器，设置反向代理及后端服务器的负载均衡；\n\nlocation(URL匹配特定位置后的设置)\n> 该部分用于匹配网页位置（比如，根目录“/”,“/images”,等等）。\n\nNginx本身是模块化设计。全局的配置区段负责全局的各个方面，对于不同的协议可以单独划分成一个部分。我们可以通过在这些单独的协议配置中（http或mail）指定server来定义每一个请求应该被如何处理，以便请求被路由到特定的IP地址或端口上。在http区段中，使用location来匹配URI请求，这些location又可以嵌套使用或者按照一定顺序使用，以确保请求被路由到正确的文件系统区域或者其他地方。\n\n**他们之间的关系式：** server继承main，location继承server；upstream既不会继承指令也不会被继承。它有自己的特殊指令，不需要在其他地方的应用。\n\n<!-- more -->\n\n## 基本配置格式\nNginx的配置文件由若干部分组成。但每一部分都是通过下列的方法定义。\n```conf\n<section> {\n  <directive><parameters>\n}\n```\n**Tips:**\n- 每一个指令行都由分号结束（;），这标志着一行结束。\n- 大括号（{}）实际上表示一个新上下文（context），常称为『节，部分（section）』\n\n## Nginx的全局配置\n全局配置顾名思义就是对整个server都有效的参数。全局配置部分可能包含配置指令（如，user、worker_processes），也包括『节、部分（section）（如，events）』。这部分配置一般放在 nginx.conf 文件的顶部。\n\n示例：\n```\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    use epoll   #使用网络IO模型，epoll模型比select模型效率高很多\n    worker_connections 1024;    #每个worker能够处理的最大连接数，最大值取决于ulimit -n的值\n}\n```\n\n主要配置指令及含义\n\n配置指令|说明\n-------|----\nuser   |配置worker进程运行的用户和用户组，第一个参数为user，第二个为group（如果忽略了group，那么group与user同名）\nworker_processes|指定worker进程启动的数量。这些进程用于处理客户的连接。通常该值会设置成CPU处理器核心数相同的数量。默认值是\"auto\"，也是按照这样去设置数量\nerror_log|设置错误日志文件位置。如果在其他的区段中没有设置其他的error_log,那么这个日志文件将会记录所有的错误。该指令的第二个参数指定了被记录的错误信息级别（debug[注，debug级别的错误只有在nginx编译的时候配置了 --with-debug选项才可以使用]、info、notice、warn、error、crit、alert、emsg）\npid   |设置记录主进程ID的文件地址。通常设置该值来方便我们对nginx的管理\nuse   |该指令指示我们使用什么样的连接方式。该指令需要写在 events 区段里面。\nworker_connections|配置一个工作进程能够接受并发连接的最大数。这个连接包括，客户连接和向上游服务器的连接，但也不仅限于此。通常该配置同use一样写在events里面\n\n## include指令\n在Nginx配置文件中可以使用include指令将其他位置存放的配置文件加载进来，来方便配置管理和增强配置文件的可读性。\n\n**Tips：**\n使用include文件，要确保被包含的文件自身符合nginx配置语法。\n```\ninclude /etc/nginx/default.d/*.conf;\n```\n路径中出现通配符表示可以匹配多个文件。\nnginx配置文件的语法错误可以通过nginx的 -t 选项来进行测试。\n```\n/path/to/nginx -t -c <path-to-nginx.conf>\n```\n**注：** 该命令只能检查语法错误，具体到某个功能性的测试还需要我们自己有针对性的去测。\n\n\n## Http的server部分\n通常我们提到的server部分，具体指的是Http的server部分。所以，其在Http配置的context是可用的。该部分用于处理http连接，因此该模块下提供了相当数量的指令。\n\n### 客户端指令\n> 用于处理客户端连接本身的各个方面，以及不同类型的客户端\n\n指令|说明\n---|-----\nchunked_transfer_encoding|在发给客户端的响应中允许禁用http/1.1标准的块传输编码\nclient_body_buffer_size|为了阻止临时文件写到磁盘，可以通过该指令为客户端请求体设置缓存大小，默认的缓存大小为两个内存页面\nclient_body_in_file_only|用于调试或者是进一步处理客户端请求体。该指令能够将客户端请求体强制写入到磁盘文件\nclient_body_in_single_buffer|为了减少拷贝的操作，使用该指令强制Nginx将整个客户端请求体保存到单个缓存中\nclient_body_temp_path|定义一个命令路径用于保存客户端请求体\nclent_body_timeout|指定客户端成功读取的两个操作之间的时间间隔\nclient_header_buffer_size|为客户端请求头指定一个缓存大小，当请求头大于1kB时会用到这个设置。\nclient_header_timeout|读取整个客户端头的超时时间\nclient_max_body_size|定义允许最大的客户端请求头，如果大于该值，那么客户端将会是413（request entity too large）错误\nkeepalive_disable|对某些类型的客户端禁用keep-alive请求功能。\nkeepalive_requests|定义在一个keep-alive关闭之前可以接收多少个请求\nkeepalive_timeout|指定keep-alive连接持续多久。第二个参数用于在响应头中这只\"Keep-Alive\"头\nlarge_client_header_buffers|定义最大数量和最大客户端请求头的大小\nmsie_padding|为了填充响应的大小至512字节，对于MSIE客户端，大于400的状态码会被添加注释以便满足512字节，通过启用该命令可以阻止这种行为\nmsie_refresh|对于MSIE客户端，可启用发送一个refresh头\n\n### 文件I/O指令\n> 用于控制Nginx如何投递静态文件。\n\n指令|说明\n---|----\naio|启用异步文件I/O。FreeBSD系统下，该值可能被用于sendfile预加载数据。Linux下需要directio指令，自动禁用sendfile\ndirectio|用于启用操作系统特定的标识或者功能提供大于给定参数的文件。Linux下使用aio时需要使用该指令。\ndirectio_alignment|设置directio算法。默认值是512，通常已经足够，但是在Linux的XFS下推荐增加至4K\nopen_file_cache|配置一个缓存用于存放打开的文件描述符、目录查询和文件查询错误\nopen_file_cache_errors|按照open_file_cache，启用文件查询错误缓存\nopen_file_cache_min_uses|open_file_cache缓存的文件描述符保留在缓存中，使用该指令配置最少使用文件描述符的次数\nopen_file_cache_valid|指定对open_file_cache缓存有效性检查的时间间隔\npostpone_output|指定Nginx发送给客户端最小的数值，如果可能的话，没有数据会发送，直到达到此值\nread_ahead|如果可能的话，内核将预读文件到设定的参数大小\nsendfile|使用sendfile（2）直接复制数据从一个到另一个文件描述符\nsendfile_max_chunk|设置在一个sendfile(2)拷贝中最大数据的大小，这是为了阻止worker\"贪婪\"\n\n\n\n### Hash指令\n> 控制Nginx 分配给某些变量多大的静态文件\n\n指令| 说明\n---|-----\nserver_names_hash_bucket_size|指定用于保存server_name哈希表大小的\"桶\"\nserver_names_hash_max_size|指定的server_name哈希表的最大值的大小\ntypes_hash_bucket_size|指定用于存放哈希表的\"桶\"的大小\ntypes_hash_max_size|指定哈希类型表的最大值的大小\nvariables_hash_bucket_size|指定用于存放保留变量\"桶\"的大小\nvariables_hash_max_size|指定存放保留变量最大哈希值的大小\n\n\n### Socket指令\n> 描述Nginx如何设置创建TCP套接字的变量选项\n\n指令|说明\n---|-----\nlingering_close|指定如何保持客户端的连接，以便用于更多数据的传输\nlingering_time|在使用lingering_close指令的连接中，使用该指令指定客户端连接为了处理更多的数据需要保持打开连接的时间\nlingering_timeout|结合lingering_close，该指令显示Nginx在关闭客户端连接之前，为获得更多数据会等待多久\nreset_timeout_connection|使用这个指令之后，超时的连接会被立即关闭，释放相关的内存。默认的状态是处于FIN_WAIT1，这种状态将会一直保持连接\nsend_lowat|如果非零，Nginx将会在客户端套接字尝试减少发送操作\nsend_timeout|在两次成功的客户端接收响应的写操作之间设置一个超时时间\ntcp_nodelay|启用或禁用TCP_NODELAY选项，用于keep-alive连接\ntcp_nopush|仅依赖于sendfile的使用。它能够使Nginx在一个数据包中尝试发送响应头，以及在数据包中发送一个完整的文件\n\n\n### server部分\n\n示例：\n```\nhttp {\n    ...\n    server {\n        listen       80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n    ...\n}\n```\n一个虚拟服务器由listen和server_name指令组合定义。\n\n**listen**\n> 指令定义一个IP地址/端口组合或者UNIX套接字路径。示例\n> - listen address[:port];\n> - listen port;\n> - listen unix:path;\n\n示例：\n```\nlisten     127.0.0.1:80;\nlisten     localhost:80;\nlisten     127.0.0.1:8080;\nlisten     localhost:8080;\nlisten     192.168.3.105:80;\nlisten     192.168.3.105:8080;\nlisten     80;\nlisten     *:80;\nlisten     8080;\nlisten     *:8080;\nlisten     12.34.56.77:80;\nlisten     12.34.56.78:80;\nlisten     12.34.56.79:80;\n```\n\n另外，listen还有其他的一些可选参数。常用到的有\ndefault_server，表示定义这样的一个组合：（address:port）默认的请求被绑定于此\nssl，表明该端口仅接受Https的连接\n\n\n**server_name**\n> 用来指定域名。\n\n示例：\n```\nserver_name   nginx.cn;\nserver_name   nginx.cn www.nginx.cn;\nserver_name   *.nginx.cn;\nserver_name   .nginx.cn;\nserver_name   nginx.*;\nserver_name   nginx.cng bucknell.net brackley.org;\nserver_name   localhost litchfield bleddington;\nserver_name   \"\";\n\n```\n\n除了普通字符串外，Nginx也接受通配符作为Server_name的参数。\n- 使用通配符替代部分子域名： \\*.example.com\n- 代替顶级域部分： www.example.*\n- 匹配子域和域本身： .example.com 能匹配 \\*.example.com 和example.com\n\n另外，在域名前加上（~），正则表达式也可应用于 server_name.\n```\nserver_name ~^www\\.example\\.com$\nserver_name ~^www(\\d+).example\\.(com)$\n```\n对于后一种方式是利用捕获，可以在以后的引用中进一步配置（用$1,$2等）指令中使用。\n\n\n\n\n## location部分\nlocation指令可以用在虚拟服务器server部分，并且意味着提供来自客户端的URI或者内部的重定向访问。\n\nlocation定义：\n```\nlocation [modifier] uri {...}\n```\n或者是命名location\n```\nlocation @name {...}\n```\n> 命名location仅对内部访问重定向，在进入一个location之前他会保留被请求的URI部分。且命名location只能存在与server级别的定义。\n\n示例\n```\nlocation / { }\nlocation /images/ { }\nlocation /blog/ { }\nlocation /planet/ { }\nlocation /planet/blog/ { }\n\nlocation ~ IndexPage.php$ { }\nlocation ~ ^/BlogPlanet(/|/index.php)$ { }\n\nlocation ~* .(pl|cgi|perl|prl)$ { }\nlocation ~* .(md|mdwn|txt|mkdn)$ { }\n\nlocation ^~ /images/IndexPage/ { }\nlocation ^~ /blog/BlogPlanet/ { }\n\nlocation = / { }\n```\n\n当一个请求进入时，URI将会被检测匹配一个最佳的location。\n- 没有正则表达式的location被认为是最佳的匹配，独立于含有正则表达式的location。\n- 在配置文件中按照查找顺序进行正则匹配，在查到第一个正则表达式匹配时结束查找，将请求交由这个location处理。\n**Tips：**\n这里匹配的解码URI，如在URL中的\"%20\",将会匹配location中的\"\"(空格)。\n\nlocation常见的修饰符\n\n修饰符|说明\n----|----\n=   |使用精确匹配并且终止搜索\n~   |区分大小写的正则表达式匹配\n~*  |不去分大小写的正则表达式匹配\n^~  |如果该location是最佳的匹配，那么对于匹配这个location的字符串不在进行正则表达式检测。\n\n仅用于location中的指令\n\n指令| 说明\n---|----\nalias|定义location的其他名字，在文件系统中能够找到。\ninternal|指定一个仅用于内部请求的location（其他指定定义的重定向，rewrite请求，error请求等）\nlimit_except|限定一个location可以执行的Http操作（如，GET或HEAD）\n\n\n\n命名location的使用（一般与try_files配合使用）\n示例：\n```\nlocation / {\n  try_files $uri $uri/ $mongrel;\n}\n\nlocation @mongrel {\n  proxy_pass http://appserver;\n}\n```\n上面一段配置表示，如果给定的URI作为一个文件没有被找到，那么处理将会通过代理被传递到appserver\n\nlocation的嵌套使用：\n```\nroot /var/www\n\nlocation / {\n  location ^~ /css {\n    location ~* /css.*\\.css$ {\n      ...\n    }\n    ...\n  }\n  ...\n}\n```\n**实践表明正则表达式location被嵌套在基于字符串的location是最佳的配置方式**\n\n## 完整的配置文件示例\n\n```\n# For more information on configuration, see:\n#   * Official English Documentation: http://nginx.org/en/docs/\n#   * Official Russian Documentation: http://nginx.org/ru/docs/\n\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n}\n```\n","source":"_posts/Nginx配置整理.md","raw":"---\ntitle: Nginx配置整理\ndate: 2016-10-03 22:30:00\nctime: 2016-10-03 22:30:00\nutime: 2016-10-03 22:30:00\nmodif_times: 0\ntags:\n-\ncategories:\n- Nginx\n---\n\nNginx配置主要分成四部分：main、server、upstream 和 location，每部分包含若干个指令。\nmain(全局设置)\n> 该部分设置的指令将影响其它所有部分的设置；\n\nserver(主机设置)\n> 该部分的指令主要用于指定虚拟主机域名、IP和端口；\n\nupstream(上游服务器设置)\n> 该部分的指令用于设置一系列的后端服务器，设置反向代理及后端服务器的负载均衡；\n\nlocation(URL匹配特定位置后的设置)\n> 该部分用于匹配网页位置（比如，根目录“/”,“/images”,等等）。\n\nNginx本身是模块化设计。全局的配置区段负责全局的各个方面，对于不同的协议可以单独划分成一个部分。我们可以通过在这些单独的协议配置中（http或mail）指定server来定义每一个请求应该被如何处理，以便请求被路由到特定的IP地址或端口上。在http区段中，使用location来匹配URI请求，这些location又可以嵌套使用或者按照一定顺序使用，以确保请求被路由到正确的文件系统区域或者其他地方。\n\n**他们之间的关系式：** server继承main，location继承server；upstream既不会继承指令也不会被继承。它有自己的特殊指令，不需要在其他地方的应用。\n\n<!-- more -->\n\n## 基本配置格式\nNginx的配置文件由若干部分组成。但每一部分都是通过下列的方法定义。\n```conf\n<section> {\n  <directive><parameters>\n}\n```\n**Tips:**\n- 每一个指令行都由分号结束（;），这标志着一行结束。\n- 大括号（{}）实际上表示一个新上下文（context），常称为『节，部分（section）』\n\n## Nginx的全局配置\n全局配置顾名思义就是对整个server都有效的参数。全局配置部分可能包含配置指令（如，user、worker_processes），也包括『节、部分（section）（如，events）』。这部分配置一般放在 nginx.conf 文件的顶部。\n\n示例：\n```\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    use epoll   #使用网络IO模型，epoll模型比select模型效率高很多\n    worker_connections 1024;    #每个worker能够处理的最大连接数，最大值取决于ulimit -n的值\n}\n```\n\n主要配置指令及含义\n\n配置指令|说明\n-------|----\nuser   |配置worker进程运行的用户和用户组，第一个参数为user，第二个为group（如果忽略了group，那么group与user同名）\nworker_processes|指定worker进程启动的数量。这些进程用于处理客户的连接。通常该值会设置成CPU处理器核心数相同的数量。默认值是\"auto\"，也是按照这样去设置数量\nerror_log|设置错误日志文件位置。如果在其他的区段中没有设置其他的error_log,那么这个日志文件将会记录所有的错误。该指令的第二个参数指定了被记录的错误信息级别（debug[注，debug级别的错误只有在nginx编译的时候配置了 --with-debug选项才可以使用]、info、notice、warn、error、crit、alert、emsg）\npid   |设置记录主进程ID的文件地址。通常设置该值来方便我们对nginx的管理\nuse   |该指令指示我们使用什么样的连接方式。该指令需要写在 events 区段里面。\nworker_connections|配置一个工作进程能够接受并发连接的最大数。这个连接包括，客户连接和向上游服务器的连接，但也不仅限于此。通常该配置同use一样写在events里面\n\n## include指令\n在Nginx配置文件中可以使用include指令将其他位置存放的配置文件加载进来，来方便配置管理和增强配置文件的可读性。\n\n**Tips：**\n使用include文件，要确保被包含的文件自身符合nginx配置语法。\n```\ninclude /etc/nginx/default.d/*.conf;\n```\n路径中出现通配符表示可以匹配多个文件。\nnginx配置文件的语法错误可以通过nginx的 -t 选项来进行测试。\n```\n/path/to/nginx -t -c <path-to-nginx.conf>\n```\n**注：** 该命令只能检查语法错误，具体到某个功能性的测试还需要我们自己有针对性的去测。\n\n\n## Http的server部分\n通常我们提到的server部分，具体指的是Http的server部分。所以，其在Http配置的context是可用的。该部分用于处理http连接，因此该模块下提供了相当数量的指令。\n\n### 客户端指令\n> 用于处理客户端连接本身的各个方面，以及不同类型的客户端\n\n指令|说明\n---|-----\nchunked_transfer_encoding|在发给客户端的响应中允许禁用http/1.1标准的块传输编码\nclient_body_buffer_size|为了阻止临时文件写到磁盘，可以通过该指令为客户端请求体设置缓存大小，默认的缓存大小为两个内存页面\nclient_body_in_file_only|用于调试或者是进一步处理客户端请求体。该指令能够将客户端请求体强制写入到磁盘文件\nclient_body_in_single_buffer|为了减少拷贝的操作，使用该指令强制Nginx将整个客户端请求体保存到单个缓存中\nclient_body_temp_path|定义一个命令路径用于保存客户端请求体\nclent_body_timeout|指定客户端成功读取的两个操作之间的时间间隔\nclient_header_buffer_size|为客户端请求头指定一个缓存大小，当请求头大于1kB时会用到这个设置。\nclient_header_timeout|读取整个客户端头的超时时间\nclient_max_body_size|定义允许最大的客户端请求头，如果大于该值，那么客户端将会是413（request entity too large）错误\nkeepalive_disable|对某些类型的客户端禁用keep-alive请求功能。\nkeepalive_requests|定义在一个keep-alive关闭之前可以接收多少个请求\nkeepalive_timeout|指定keep-alive连接持续多久。第二个参数用于在响应头中这只\"Keep-Alive\"头\nlarge_client_header_buffers|定义最大数量和最大客户端请求头的大小\nmsie_padding|为了填充响应的大小至512字节，对于MSIE客户端，大于400的状态码会被添加注释以便满足512字节，通过启用该命令可以阻止这种行为\nmsie_refresh|对于MSIE客户端，可启用发送一个refresh头\n\n### 文件I/O指令\n> 用于控制Nginx如何投递静态文件。\n\n指令|说明\n---|----\naio|启用异步文件I/O。FreeBSD系统下，该值可能被用于sendfile预加载数据。Linux下需要directio指令，自动禁用sendfile\ndirectio|用于启用操作系统特定的标识或者功能提供大于给定参数的文件。Linux下使用aio时需要使用该指令。\ndirectio_alignment|设置directio算法。默认值是512，通常已经足够，但是在Linux的XFS下推荐增加至4K\nopen_file_cache|配置一个缓存用于存放打开的文件描述符、目录查询和文件查询错误\nopen_file_cache_errors|按照open_file_cache，启用文件查询错误缓存\nopen_file_cache_min_uses|open_file_cache缓存的文件描述符保留在缓存中，使用该指令配置最少使用文件描述符的次数\nopen_file_cache_valid|指定对open_file_cache缓存有效性检查的时间间隔\npostpone_output|指定Nginx发送给客户端最小的数值，如果可能的话，没有数据会发送，直到达到此值\nread_ahead|如果可能的话，内核将预读文件到设定的参数大小\nsendfile|使用sendfile（2）直接复制数据从一个到另一个文件描述符\nsendfile_max_chunk|设置在一个sendfile(2)拷贝中最大数据的大小，这是为了阻止worker\"贪婪\"\n\n\n\n### Hash指令\n> 控制Nginx 分配给某些变量多大的静态文件\n\n指令| 说明\n---|-----\nserver_names_hash_bucket_size|指定用于保存server_name哈希表大小的\"桶\"\nserver_names_hash_max_size|指定的server_name哈希表的最大值的大小\ntypes_hash_bucket_size|指定用于存放哈希表的\"桶\"的大小\ntypes_hash_max_size|指定哈希类型表的最大值的大小\nvariables_hash_bucket_size|指定用于存放保留变量\"桶\"的大小\nvariables_hash_max_size|指定存放保留变量最大哈希值的大小\n\n\n### Socket指令\n> 描述Nginx如何设置创建TCP套接字的变量选项\n\n指令|说明\n---|-----\nlingering_close|指定如何保持客户端的连接，以便用于更多数据的传输\nlingering_time|在使用lingering_close指令的连接中，使用该指令指定客户端连接为了处理更多的数据需要保持打开连接的时间\nlingering_timeout|结合lingering_close，该指令显示Nginx在关闭客户端连接之前，为获得更多数据会等待多久\nreset_timeout_connection|使用这个指令之后，超时的连接会被立即关闭，释放相关的内存。默认的状态是处于FIN_WAIT1，这种状态将会一直保持连接\nsend_lowat|如果非零，Nginx将会在客户端套接字尝试减少发送操作\nsend_timeout|在两次成功的客户端接收响应的写操作之间设置一个超时时间\ntcp_nodelay|启用或禁用TCP_NODELAY选项，用于keep-alive连接\ntcp_nopush|仅依赖于sendfile的使用。它能够使Nginx在一个数据包中尝试发送响应头，以及在数据包中发送一个完整的文件\n\n\n### server部分\n\n示例：\n```\nhttp {\n    ...\n    server {\n        listen       80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n    ...\n}\n```\n一个虚拟服务器由listen和server_name指令组合定义。\n\n**listen**\n> 指令定义一个IP地址/端口组合或者UNIX套接字路径。示例\n> - listen address[:port];\n> - listen port;\n> - listen unix:path;\n\n示例：\n```\nlisten     127.0.0.1:80;\nlisten     localhost:80;\nlisten     127.0.0.1:8080;\nlisten     localhost:8080;\nlisten     192.168.3.105:80;\nlisten     192.168.3.105:8080;\nlisten     80;\nlisten     *:80;\nlisten     8080;\nlisten     *:8080;\nlisten     12.34.56.77:80;\nlisten     12.34.56.78:80;\nlisten     12.34.56.79:80;\n```\n\n另外，listen还有其他的一些可选参数。常用到的有\ndefault_server，表示定义这样的一个组合：（address:port）默认的请求被绑定于此\nssl，表明该端口仅接受Https的连接\n\n\n**server_name**\n> 用来指定域名。\n\n示例：\n```\nserver_name   nginx.cn;\nserver_name   nginx.cn www.nginx.cn;\nserver_name   *.nginx.cn;\nserver_name   .nginx.cn;\nserver_name   nginx.*;\nserver_name   nginx.cng bucknell.net brackley.org;\nserver_name   localhost litchfield bleddington;\nserver_name   \"\";\n\n```\n\n除了普通字符串外，Nginx也接受通配符作为Server_name的参数。\n- 使用通配符替代部分子域名： \\*.example.com\n- 代替顶级域部分： www.example.*\n- 匹配子域和域本身： .example.com 能匹配 \\*.example.com 和example.com\n\n另外，在域名前加上（~），正则表达式也可应用于 server_name.\n```\nserver_name ~^www\\.example\\.com$\nserver_name ~^www(\\d+).example\\.(com)$\n```\n对于后一种方式是利用捕获，可以在以后的引用中进一步配置（用$1,$2等）指令中使用。\n\n\n\n\n## location部分\nlocation指令可以用在虚拟服务器server部分，并且意味着提供来自客户端的URI或者内部的重定向访问。\n\nlocation定义：\n```\nlocation [modifier] uri {...}\n```\n或者是命名location\n```\nlocation @name {...}\n```\n> 命名location仅对内部访问重定向，在进入一个location之前他会保留被请求的URI部分。且命名location只能存在与server级别的定义。\n\n示例\n```\nlocation / { }\nlocation /images/ { }\nlocation /blog/ { }\nlocation /planet/ { }\nlocation /planet/blog/ { }\n\nlocation ~ IndexPage.php$ { }\nlocation ~ ^/BlogPlanet(/|/index.php)$ { }\n\nlocation ~* .(pl|cgi|perl|prl)$ { }\nlocation ~* .(md|mdwn|txt|mkdn)$ { }\n\nlocation ^~ /images/IndexPage/ { }\nlocation ^~ /blog/BlogPlanet/ { }\n\nlocation = / { }\n```\n\n当一个请求进入时，URI将会被检测匹配一个最佳的location。\n- 没有正则表达式的location被认为是最佳的匹配，独立于含有正则表达式的location。\n- 在配置文件中按照查找顺序进行正则匹配，在查到第一个正则表达式匹配时结束查找，将请求交由这个location处理。\n**Tips：**\n这里匹配的解码URI，如在URL中的\"%20\",将会匹配location中的\"\"(空格)。\n\nlocation常见的修饰符\n\n修饰符|说明\n----|----\n=   |使用精确匹配并且终止搜索\n~   |区分大小写的正则表达式匹配\n~*  |不去分大小写的正则表达式匹配\n^~  |如果该location是最佳的匹配，那么对于匹配这个location的字符串不在进行正则表达式检测。\n\n仅用于location中的指令\n\n指令| 说明\n---|----\nalias|定义location的其他名字，在文件系统中能够找到。\ninternal|指定一个仅用于内部请求的location（其他指定定义的重定向，rewrite请求，error请求等）\nlimit_except|限定一个location可以执行的Http操作（如，GET或HEAD）\n\n\n\n命名location的使用（一般与try_files配合使用）\n示例：\n```\nlocation / {\n  try_files $uri $uri/ $mongrel;\n}\n\nlocation @mongrel {\n  proxy_pass http://appserver;\n}\n```\n上面一段配置表示，如果给定的URI作为一个文件没有被找到，那么处理将会通过代理被传递到appserver\n\nlocation的嵌套使用：\n```\nroot /var/www\n\nlocation / {\n  location ^~ /css {\n    location ~* /css.*\\.css$ {\n      ...\n    }\n    ...\n  }\n  ...\n}\n```\n**实践表明正则表达式location被嵌套在基于字符串的location是最佳的配置方式**\n\n## 完整的配置文件示例\n\n```\n# For more information on configuration, see:\n#   * Official English Documentation: http://nginx.org/en/docs/\n#   * Official Russian Documentation: http://nginx.org/ru/docs/\n\nuser nginx;\nworker_processes auto;\nerror_log /var/log/nginx/error.log;\npid /run/nginx.pid;\n\nevents {\n    worker_connections 1024;\n}\n\nhttp {\n    log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '\n                      '$status $body_bytes_sent \"$http_referer\" '\n                      '\"$http_user_agent\" \"$http_x_forwarded_for\"';\n\n    access_log  /var/log/nginx/access.log  main;\n\n    sendfile            on;\n    tcp_nopush          on;\n    tcp_nodelay         on;\n    keepalive_timeout   65;\n    types_hash_max_size 2048;\n\n    include             /etc/nginx/mime.types;\n    default_type        application/octet-stream;\n\n    # Load modular configuration files from the /etc/nginx/conf.d directory.\n    # See http://nginx.org/en/docs/ngx_core_module.html#include\n    # for more information.\n    include /etc/nginx/conf.d/*.conf;\n\n    server {\n        listen       80 default_server;\n        listen       [::]:80 default_server;\n        server_name  _;\n        root         /usr/share/nginx/html;\n\n        # Load configuration files for the default server block.\n        include /etc/nginx/default.d/*.conf;\n\n        location / {\n        }\n\n        error_page 404 /404.html;\n            location = /40x.html {\n        }\n\n        error_page 500 502 503 504 /50x.html;\n            location = /50x.html {\n        }\n    }\n}\n```\n","slug":"Nginx配置整理","published":1,"updated":"2016-10-04T10:36:46.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwg002j699fx9xav86r","content":"<p>Nginx配置主要分成四部分：main、server、upstream 和 location，每部分包含若干个指令。<br>main(全局设置)</p>\n<blockquote>\n<p>该部分设置的指令将影响其它所有部分的设置；</p>\n</blockquote>\n<p>server(主机设置)</p>\n<blockquote>\n<p>该部分的指令主要用于指定虚拟主机域名、IP和端口；</p>\n</blockquote>\n<p>upstream(上游服务器设置)</p>\n<blockquote>\n<p>该部分的指令用于设置一系列的后端服务器，设置反向代理及后端服务器的负载均衡；</p>\n</blockquote>\n<p>location(URL匹配特定位置后的设置)</p>\n<blockquote>\n<p>该部分用于匹配网页位置（比如，根目录“/”,“/images”,等等）。</p>\n</blockquote>\n<p>Nginx本身是模块化设计。全局的配置区段负责全局的各个方面，对于不同的协议可以单独划分成一个部分。我们可以通过在这些单独的协议配置中（http或mail）指定server来定义每一个请求应该被如何处理，以便请求被路由到特定的IP地址或端口上。在http区段中，使用location来匹配URI请求，这些location又可以嵌套使用或者按照一定顺序使用，以确保请求被路由到正确的文件系统区域或者其他地方。</p>\n<p><strong>他们之间的关系式：</strong> server继承main，location继承server；upstream既不会继承指令也不会被继承。它有自己的特殊指令，不需要在其他地方的应用。</p>\n<a id=\"more\"></a>\n<h2 id=\"基本配置格式\"><a href=\"#基本配置格式\" class=\"headerlink\" title=\"基本配置格式\"></a>基本配置格式</h2><p>Nginx的配置文件由若干部分组成。但每一部分都是通过下列的方法定义。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;section&gt; &#123;</div><div class=\"line\">  &lt;directive&gt;&lt;parameters&gt;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>Tips:</strong></p>\n<ul>\n<li>每一个指令行都由分号结束（;），这标志着一行结束。</li>\n<li>大括号（{}）实际上表示一个新上下文（context），常称为『节，部分（section）』</li>\n</ul>\n<h2 id=\"Nginx的全局配置\"><a href=\"#Nginx的全局配置\" class=\"headerlink\" title=\"Nginx的全局配置\"></a>Nginx的全局配置</h2><p>全局配置顾名思义就是对整个server都有效的参数。全局配置部分可能包含配置指令（如，user、worker_processes），也包括『节、部分（section）（如，events）』。这部分配置一般放在 nginx.conf 文件的顶部。</p>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">user nginx;</div><div class=\"line\">worker_processes auto;</div><div class=\"line\">error_log /var/log/nginx/error.log;</div><div class=\"line\">pid /run/nginx.pid;</div><div class=\"line\"></div><div class=\"line\">events &#123;</div><div class=\"line\">    use epoll   #使用网络IO模型，epoll模型比select模型效率高很多</div><div class=\"line\">    worker_connections 1024;    #每个worker能够处理的最大连接数，最大值取决于ulimit -n的值</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>主要配置指令及含义</p>\n<table>\n<thead>\n<tr>\n<th>配置指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>user</td>\n<td>配置worker进程运行的用户和用户组，第一个参数为user，第二个为group（如果忽略了group，那么group与user同名）</td>\n</tr>\n<tr>\n<td>worker_processes</td>\n<td>指定worker进程启动的数量。这些进程用于处理客户的连接。通常该值会设置成CPU处理器核心数相同的数量。默认值是”auto”，也是按照这样去设置数量</td>\n</tr>\n<tr>\n<td>error_log</td>\n<td>设置错误日志文件位置。如果在其他的区段中没有设置其他的error_log,那么这个日志文件将会记录所有的错误。该指令的第二个参数指定了被记录的错误信息级别（debug[注，debug级别的错误只有在nginx编译的时候配置了 –with-debug选项才可以使用]、info、notice、warn、error、crit、alert、emsg）</td>\n</tr>\n<tr>\n<td>pid</td>\n<td>设置记录主进程ID的文件地址。通常设置该值来方便我们对nginx的管理</td>\n</tr>\n<tr>\n<td>use</td>\n<td>该指令指示我们使用什么样的连接方式。该指令需要写在 events 区段里面。</td>\n</tr>\n<tr>\n<td>worker_connections</td>\n<td>配置一个工作进程能够接受并发连接的最大数。这个连接包括，客户连接和向上游服务器的连接，但也不仅限于此。通常该配置同use一样写在events里面</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"include指令\"><a href=\"#include指令\" class=\"headerlink\" title=\"include指令\"></a>include指令</h2><p>在Nginx配置文件中可以使用include指令将其他位置存放的配置文件加载进来，来方便配置管理和增强配置文件的可读性。</p>\n<p><strong>Tips：</strong><br>使用include文件，要确保被包含的文件自身符合nginx配置语法。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">include /etc/nginx/default.d/*.conf;</div></pre></td></tr></table></figure></p>\n<p>路径中出现通配符表示可以匹配多个文件。<br>nginx配置文件的语法错误可以通过nginx的 -t 选项来进行测试。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/path/to/nginx -t -c &lt;path-to-nginx.conf&gt;</div></pre></td></tr></table></figure></p>\n<p><strong>注：</strong> 该命令只能检查语法错误，具体到某个功能性的测试还需要我们自己有针对性的去测。</p>\n<h2 id=\"Http的server部分\"><a href=\"#Http的server部分\" class=\"headerlink\" title=\"Http的server部分\"></a>Http的server部分</h2><p>通常我们提到的server部分，具体指的是Http的server部分。所以，其在Http配置的context是可用的。该部分用于处理http连接，因此该模块下提供了相当数量的指令。</p>\n<h3 id=\"客户端指令\"><a href=\"#客户端指令\" class=\"headerlink\" title=\"客户端指令\"></a>客户端指令</h3><blockquote>\n<p>用于处理客户端连接本身的各个方面，以及不同类型的客户端</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>chunked_transfer_encoding</td>\n<td>在发给客户端的响应中允许禁用http/1.1标准的块传输编码</td>\n</tr>\n<tr>\n<td>client_body_buffer_size</td>\n<td>为了阻止临时文件写到磁盘，可以通过该指令为客户端请求体设置缓存大小，默认的缓存大小为两个内存页面</td>\n</tr>\n<tr>\n<td>client_body_in_file_only</td>\n<td>用于调试或者是进一步处理客户端请求体。该指令能够将客户端请求体强制写入到磁盘文件</td>\n</tr>\n<tr>\n<td>client_body_in_single_buffer</td>\n<td>为了减少拷贝的操作，使用该指令强制Nginx将整个客户端请求体保存到单个缓存中</td>\n</tr>\n<tr>\n<td>client_body_temp_path</td>\n<td>定义一个命令路径用于保存客户端请求体</td>\n</tr>\n<tr>\n<td>clent_body_timeout</td>\n<td>指定客户端成功读取的两个操作之间的时间间隔</td>\n</tr>\n<tr>\n<td>client_header_buffer_size</td>\n<td>为客户端请求头指定一个缓存大小，当请求头大于1kB时会用到这个设置。</td>\n</tr>\n<tr>\n<td>client_header_timeout</td>\n<td>读取整个客户端头的超时时间</td>\n</tr>\n<tr>\n<td>client_max_body_size</td>\n<td>定义允许最大的客户端请求头，如果大于该值，那么客户端将会是413（request entity too large）错误</td>\n</tr>\n<tr>\n<td>keepalive_disable</td>\n<td>对某些类型的客户端禁用keep-alive请求功能。</td>\n</tr>\n<tr>\n<td>keepalive_requests</td>\n<td>定义在一个keep-alive关闭之前可以接收多少个请求</td>\n</tr>\n<tr>\n<td>keepalive_timeout</td>\n<td>指定keep-alive连接持续多久。第二个参数用于在响应头中这只”Keep-Alive”头</td>\n</tr>\n<tr>\n<td>large_client_header_buffers</td>\n<td>定义最大数量和最大客户端请求头的大小</td>\n</tr>\n<tr>\n<td>msie_padding</td>\n<td>为了填充响应的大小至512字节，对于MSIE客户端，大于400的状态码会被添加注释以便满足512字节，通过启用该命令可以阻止这种行为</td>\n</tr>\n<tr>\n<td>msie_refresh</td>\n<td>对于MSIE客户端，可启用发送一个refresh头</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"文件I-O指令\"><a href=\"#文件I-O指令\" class=\"headerlink\" title=\"文件I/O指令\"></a>文件I/O指令</h3><blockquote>\n<p>用于控制Nginx如何投递静态文件。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>aio</td>\n<td>启用异步文件I/O。FreeBSD系统下，该值可能被用于sendfile预加载数据。Linux下需要directio指令，自动禁用sendfile</td>\n</tr>\n<tr>\n<td>directio</td>\n<td>用于启用操作系统特定的标识或者功能提供大于给定参数的文件。Linux下使用aio时需要使用该指令。</td>\n</tr>\n<tr>\n<td>directio_alignment</td>\n<td>设置directio算法。默认值是512，通常已经足够，但是在Linux的XFS下推荐增加至4K</td>\n</tr>\n<tr>\n<td>open_file_cache</td>\n<td>配置一个缓存用于存放打开的文件描述符、目录查询和文件查询错误</td>\n</tr>\n<tr>\n<td>open_file_cache_errors</td>\n<td>按照open_file_cache，启用文件查询错误缓存</td>\n</tr>\n<tr>\n<td>open_file_cache_min_uses</td>\n<td>open_file_cache缓存的文件描述符保留在缓存中，使用该指令配置最少使用文件描述符的次数</td>\n</tr>\n<tr>\n<td>open_file_cache_valid</td>\n<td>指定对open_file_cache缓存有效性检查的时间间隔</td>\n</tr>\n<tr>\n<td>postpone_output</td>\n<td>指定Nginx发送给客户端最小的数值，如果可能的话，没有数据会发送，直到达到此值</td>\n</tr>\n<tr>\n<td>read_ahead</td>\n<td>如果可能的话，内核将预读文件到设定的参数大小</td>\n</tr>\n<tr>\n<td>sendfile</td>\n<td>使用sendfile（2）直接复制数据从一个到另一个文件描述符</td>\n</tr>\n<tr>\n<td>sendfile_max_chunk</td>\n<td>设置在一个sendfile(2)拷贝中最大数据的大小，这是为了阻止worker”贪婪”</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Hash指令\"><a href=\"#Hash指令\" class=\"headerlink\" title=\"Hash指令\"></a>Hash指令</h3><blockquote>\n<p>控制Nginx 分配给某些变量多大的静态文件</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>server_names_hash_bucket_size</td>\n<td>指定用于保存server_name哈希表大小的”桶”</td>\n</tr>\n<tr>\n<td>server_names_hash_max_size</td>\n<td>指定的server_name哈希表的最大值的大小</td>\n</tr>\n<tr>\n<td>types_hash_bucket_size</td>\n<td>指定用于存放哈希表的”桶”的大小</td>\n</tr>\n<tr>\n<td>types_hash_max_size</td>\n<td>指定哈希类型表的最大值的大小</td>\n</tr>\n<tr>\n<td>variables_hash_bucket_size</td>\n<td>指定用于存放保留变量”桶”的大小</td>\n</tr>\n<tr>\n<td>variables_hash_max_size</td>\n<td>指定存放保留变量最大哈希值的大小</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Socket指令\"><a href=\"#Socket指令\" class=\"headerlink\" title=\"Socket指令\"></a>Socket指令</h3><blockquote>\n<p>描述Nginx如何设置创建TCP套接字的变量选项</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lingering_close</td>\n<td>指定如何保持客户端的连接，以便用于更多数据的传输</td>\n</tr>\n<tr>\n<td>lingering_time</td>\n<td>在使用lingering_close指令的连接中，使用该指令指定客户端连接为了处理更多的数据需要保持打开连接的时间</td>\n</tr>\n<tr>\n<td>lingering_timeout</td>\n<td>结合lingering_close，该指令显示Nginx在关闭客户端连接之前，为获得更多数据会等待多久</td>\n</tr>\n<tr>\n<td>reset_timeout_connection</td>\n<td>使用这个指令之后，超时的连接会被立即关闭，释放相关的内存。默认的状态是处于FIN_WAIT1，这种状态将会一直保持连接</td>\n</tr>\n<tr>\n<td>send_lowat</td>\n<td>如果非零，Nginx将会在客户端套接字尝试减少发送操作</td>\n</tr>\n<tr>\n<td>send_timeout</td>\n<td>在两次成功的客户端接收响应的写操作之间设置一个超时时间</td>\n</tr>\n<tr>\n<td>tcp_nodelay</td>\n<td>启用或禁用TCP_NODELAY选项，用于keep-alive连接</td>\n</tr>\n<tr>\n<td>tcp_nopush</td>\n<td>仅依赖于sendfile的使用。它能够使Nginx在一个数据包中尝试发送响应头，以及在数据包中发送一个完整的文件</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"server部分\"><a href=\"#server部分\" class=\"headerlink\" title=\"server部分\"></a>server部分</h3><p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">http &#123;</div><div class=\"line\">    ...</div><div class=\"line\">    server &#123;</div><div class=\"line\">        listen       80 default_server;</div><div class=\"line\">        server_name  _;</div><div class=\"line\">        root         /usr/share/nginx/html;</div><div class=\"line\"></div><div class=\"line\">        # Load configuration files for the default server block.</div><div class=\"line\">        include /etc/nginx/default.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">        location / &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 404 /404.html;</div><div class=\"line\">            location = /40x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 500 502 503 504 /50x.html;</div><div class=\"line\">            location = /50x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>一个虚拟服务器由listen和server_name指令组合定义。</p>\n<p><strong>listen</strong></p>\n<blockquote>\n<p>指令定义一个IP地址/端口组合或者UNIX套接字路径。示例</p>\n<ul>\n<li>listen address[:port];</li>\n<li>listen port;</li>\n<li>listen unix:path;</li>\n</ul>\n</blockquote>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">listen     127.0.0.1:80;</div><div class=\"line\">listen     localhost:80;</div><div class=\"line\">listen     127.0.0.1:8080;</div><div class=\"line\">listen     localhost:8080;</div><div class=\"line\">listen     192.168.3.105:80;</div><div class=\"line\">listen     192.168.3.105:8080;</div><div class=\"line\">listen     80;</div><div class=\"line\">listen     *:80;</div><div class=\"line\">listen     8080;</div><div class=\"line\">listen     *:8080;</div><div class=\"line\">listen     12.34.56.77:80;</div><div class=\"line\">listen     12.34.56.78:80;</div><div class=\"line\">listen     12.34.56.79:80;</div></pre></td></tr></table></figure></p>\n<p>另外，listen还有其他的一些可选参数。常用到的有<br>default_server，表示定义这样的一个组合：（address:port）默认的请求被绑定于此<br>ssl，表明该端口仅接受Https的连接</p>\n<p><strong>server_name</strong></p>\n<blockquote>\n<p>用来指定域名。</p>\n</blockquote>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">server_name   nginx.cn;</div><div class=\"line\">server_name   nginx.cn www.nginx.cn;</div><div class=\"line\">server_name   *.nginx.cn;</div><div class=\"line\">server_name   .nginx.cn;</div><div class=\"line\">server_name   nginx.*;</div><div class=\"line\">server_name   nginx.cng bucknell.net brackley.org;</div><div class=\"line\">server_name   localhost litchfield bleddington;</div><div class=\"line\">server_name   &quot;&quot;;</div></pre></td></tr></table></figure></p>\n<p>除了普通字符串外，Nginx也接受通配符作为Server_name的参数。</p>\n<ul>\n<li>使用通配符替代部分子域名： *.example.com</li>\n<li>代替顶级域部分： www.example.*</li>\n<li>匹配子域和域本身： .example.com 能匹配 *.example.com 和example.com</li>\n</ul>\n<p>另外，在域名前加上（~），正则表达式也可应用于 server_name.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">server_name ~^www\\.example\\.com$</div><div class=\"line\">server_name ~^www(\\d+).example\\.(com)$</div></pre></td></tr></table></figure></p>\n<p>对于后一种方式是利用捕获，可以在以后的引用中进一步配置（用$1,$2等）指令中使用。</p>\n<h2 id=\"location部分\"><a href=\"#location部分\" class=\"headerlink\" title=\"location部分\"></a>location部分</h2><p>location指令可以用在虚拟服务器server部分，并且意味着提供来自客户端的URI或者内部的重定向访问。</p>\n<p>location定义：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">location [modifier] uri &#123;...&#125;</div></pre></td></tr></table></figure></p>\n<p>或者是命名location<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">location @name &#123;...&#125;</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>命名location仅对内部访问重定向，在进入一个location之前他会保留被请求的URI部分。且命名location只能存在与server级别的定义。</p>\n</blockquote>\n<p>示例<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">location / &#123; &#125;</div><div class=\"line\">location /images/ &#123; &#125;</div><div class=\"line\">location /blog/ &#123; &#125;</div><div class=\"line\">location /planet/ &#123; &#125;</div><div class=\"line\">location /planet/blog/ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location ~ IndexPage.php$ &#123; &#125;</div><div class=\"line\">location ~ ^/BlogPlanet(/|/index.php)$ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location ~* .(pl|cgi|perl|prl)$ &#123; &#125;</div><div class=\"line\">location ~* .(md|mdwn|txt|mkdn)$ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location ^~ /images/IndexPage/ &#123; &#125;</div><div class=\"line\">location ^~ /blog/BlogPlanet/ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location = / &#123; &#125;</div></pre></td></tr></table></figure></p>\n<p>当一个请求进入时，URI将会被检测匹配一个最佳的location。</p>\n<ul>\n<li>没有正则表达式的location被认为是最佳的匹配，独立于含有正则表达式的location。</li>\n<li>在配置文件中按照查找顺序进行正则匹配，在查到第一个正则表达式匹配时结束查找，将请求交由这个location处理。<br><strong>Tips：</strong><br>这里匹配的解码URI，如在URL中的”%20”,将会匹配location中的””(空格)。</li>\n</ul>\n<p>location常见的修饰符</p>\n<table>\n<thead>\n<tr>\n<th>修饰符</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>=</td>\n<td>使用精确匹配并且终止搜索</td>\n</tr>\n<tr>\n<td>~</td>\n<td>区分大小写的正则表达式匹配</td>\n</tr>\n<tr>\n<td>~*</td>\n<td>不去分大小写的正则表达式匹配</td>\n</tr>\n<tr>\n<td>^~</td>\n<td>如果该location是最佳的匹配，那么对于匹配这个location的字符串不在进行正则表达式检测。</td>\n</tr>\n</tbody>\n</table>\n<p>仅用于location中的指令</p>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>alias</td>\n<td>定义location的其他名字，在文件系统中能够找到。</td>\n</tr>\n<tr>\n<td>internal</td>\n<td>指定一个仅用于内部请求的location（其他指定定义的重定向，rewrite请求，error请求等）</td>\n</tr>\n<tr>\n<td>limit_except</td>\n<td>限定一个location可以执行的Http操作（如，GET或HEAD）</td>\n</tr>\n</tbody>\n</table>\n<p>命名location的使用（一般与try_files配合使用）<br>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">location / &#123;</div><div class=\"line\">  try_files $uri $uri/ $mongrel;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">location @mongrel &#123;</div><div class=\"line\">  proxy_pass http://appserver;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>上面一段配置表示，如果给定的URI作为一个文件没有被找到，那么处理将会通过代理被传递到appserver</p>\n<p>location的嵌套使用：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">root /var/www</div><div class=\"line\"></div><div class=\"line\">location / &#123;</div><div class=\"line\">  location ^~ /css &#123;</div><div class=\"line\">    location ~* /css.*\\.css$ &#123;</div><div class=\"line\">      ...</div><div class=\"line\">    &#125;</div><div class=\"line\">    ...</div><div class=\"line\">  &#125;</div><div class=\"line\">  ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>实践表明正则表达式location被嵌套在基于字符串的location是最佳的配置方式</strong></p>\n<h2 id=\"完整的配置文件示例\"><a href=\"#完整的配置文件示例\" class=\"headerlink\" title=\"完整的配置文件示例\"></a>完整的配置文件示例</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"># For more information on configuration, see:</div><div class=\"line\">#   * Official English Documentation: http://nginx.org/en/docs/</div><div class=\"line\">#   * Official Russian Documentation: http://nginx.org/ru/docs/</div><div class=\"line\"></div><div class=\"line\">user nginx;</div><div class=\"line\">worker_processes auto;</div><div class=\"line\">error_log /var/log/nginx/error.log;</div><div class=\"line\">pid /run/nginx.pid;</div><div class=\"line\"></div><div class=\"line\">events &#123;</div><div class=\"line\">    worker_connections 1024;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">http &#123;</div><div class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class=\"line\"></div><div class=\"line\">    access_log  /var/log/nginx/access.log  main;</div><div class=\"line\"></div><div class=\"line\">    sendfile            on;</div><div class=\"line\">    tcp_nopush          on;</div><div class=\"line\">    tcp_nodelay         on;</div><div class=\"line\">    keepalive_timeout   65;</div><div class=\"line\">    types_hash_max_size 2048;</div><div class=\"line\"></div><div class=\"line\">    include             /etc/nginx/mime.types;</div><div class=\"line\">    default_type        application/octet-stream;</div><div class=\"line\"></div><div class=\"line\">    # Load modular configuration files from the /etc/nginx/conf.d directory.</div><div class=\"line\">    # See http://nginx.org/en/docs/ngx_core_module.html#include</div><div class=\"line\">    # for more information.</div><div class=\"line\">    include /etc/nginx/conf.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">    server &#123;</div><div class=\"line\">        listen       80 default_server;</div><div class=\"line\">        listen       [::]:80 default_server;</div><div class=\"line\">        server_name  _;</div><div class=\"line\">        root         /usr/share/nginx/html;</div><div class=\"line\"></div><div class=\"line\">        # Load configuration files for the default server block.</div><div class=\"line\">        include /etc/nginx/default.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">        location / &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 404 /404.html;</div><div class=\"line\">            location = /40x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 500 502 503 504 /50x.html;</div><div class=\"line\">            location = /50x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n","excerpt":"<p>Nginx配置主要分成四部分：main、server、upstream 和 location，每部分包含若干个指令。<br>main(全局设置)</p>\n<blockquote>\n<p>该部分设置的指令将影响其它所有部分的设置；</p>\n</blockquote>\n<p>server(主机设置)</p>\n<blockquote>\n<p>该部分的指令主要用于指定虚拟主机域名、IP和端口；</p>\n</blockquote>\n<p>upstream(上游服务器设置)</p>\n<blockquote>\n<p>该部分的指令用于设置一系列的后端服务器，设置反向代理及后端服务器的负载均衡；</p>\n</blockquote>\n<p>location(URL匹配特定位置后的设置)</p>\n<blockquote>\n<p>该部分用于匹配网页位置（比如，根目录“/”,“/images”,等等）。</p>\n</blockquote>\n<p>Nginx本身是模块化设计。全局的配置区段负责全局的各个方面，对于不同的协议可以单独划分成一个部分。我们可以通过在这些单独的协议配置中（http或mail）指定server来定义每一个请求应该被如何处理，以便请求被路由到特定的IP地址或端口上。在http区段中，使用location来匹配URI请求，这些location又可以嵌套使用或者按照一定顺序使用，以确保请求被路由到正确的文件系统区域或者其他地方。</p>\n<p><strong>他们之间的关系式：</strong> server继承main，location继承server；upstream既不会继承指令也不会被继承。它有自己的特殊指令，不需要在其他地方的应用。</p>","more":"<h2 id=\"基本配置格式\"><a href=\"#基本配置格式\" class=\"headerlink\" title=\"基本配置格式\"></a>基本配置格式</h2><p>Nginx的配置文件由若干部分组成。但每一部分都是通过下列的方法定义。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;section&gt; &#123;</div><div class=\"line\">  &lt;directive&gt;&lt;parameters&gt;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>Tips:</strong></p>\n<ul>\n<li>每一个指令行都由分号结束（;），这标志着一行结束。</li>\n<li>大括号（{}）实际上表示一个新上下文（context），常称为『节，部分（section）』</li>\n</ul>\n<h2 id=\"Nginx的全局配置\"><a href=\"#Nginx的全局配置\" class=\"headerlink\" title=\"Nginx的全局配置\"></a>Nginx的全局配置</h2><p>全局配置顾名思义就是对整个server都有效的参数。全局配置部分可能包含配置指令（如，user、worker_processes），也包括『节、部分（section）（如，events）』。这部分配置一般放在 nginx.conf 文件的顶部。</p>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">user nginx;</div><div class=\"line\">worker_processes auto;</div><div class=\"line\">error_log /var/log/nginx/error.log;</div><div class=\"line\">pid /run/nginx.pid;</div><div class=\"line\"></div><div class=\"line\">events &#123;</div><div class=\"line\">    use epoll   #使用网络IO模型，epoll模型比select模型效率高很多</div><div class=\"line\">    worker_connections 1024;    #每个worker能够处理的最大连接数，最大值取决于ulimit -n的值</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>主要配置指令及含义</p>\n<table>\n<thead>\n<tr>\n<th>配置指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>user</td>\n<td>配置worker进程运行的用户和用户组，第一个参数为user，第二个为group（如果忽略了group，那么group与user同名）</td>\n</tr>\n<tr>\n<td>worker_processes</td>\n<td>指定worker进程启动的数量。这些进程用于处理客户的连接。通常该值会设置成CPU处理器核心数相同的数量。默认值是”auto”，也是按照这样去设置数量</td>\n</tr>\n<tr>\n<td>error_log</td>\n<td>设置错误日志文件位置。如果在其他的区段中没有设置其他的error_log,那么这个日志文件将会记录所有的错误。该指令的第二个参数指定了被记录的错误信息级别（debug[注，debug级别的错误只有在nginx编译的时候配置了 –with-debug选项才可以使用]、info、notice、warn、error、crit、alert、emsg）</td>\n</tr>\n<tr>\n<td>pid</td>\n<td>设置记录主进程ID的文件地址。通常设置该值来方便我们对nginx的管理</td>\n</tr>\n<tr>\n<td>use</td>\n<td>该指令指示我们使用什么样的连接方式。该指令需要写在 events 区段里面。</td>\n</tr>\n<tr>\n<td>worker_connections</td>\n<td>配置一个工作进程能够接受并发连接的最大数。这个连接包括，客户连接和向上游服务器的连接，但也不仅限于此。通常该配置同use一样写在events里面</td>\n</tr>\n</tbody>\n</table>\n<h2 id=\"include指令\"><a href=\"#include指令\" class=\"headerlink\" title=\"include指令\"></a>include指令</h2><p>在Nginx配置文件中可以使用include指令将其他位置存放的配置文件加载进来，来方便配置管理和增强配置文件的可读性。</p>\n<p><strong>Tips：</strong><br>使用include文件，要确保被包含的文件自身符合nginx配置语法。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">include /etc/nginx/default.d/*.conf;</div></pre></td></tr></table></figure></p>\n<p>路径中出现通配符表示可以匹配多个文件。<br>nginx配置文件的语法错误可以通过nginx的 -t 选项来进行测试。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/path/to/nginx -t -c &lt;path-to-nginx.conf&gt;</div></pre></td></tr></table></figure></p>\n<p><strong>注：</strong> 该命令只能检查语法错误，具体到某个功能性的测试还需要我们自己有针对性的去测。</p>\n<h2 id=\"Http的server部分\"><a href=\"#Http的server部分\" class=\"headerlink\" title=\"Http的server部分\"></a>Http的server部分</h2><p>通常我们提到的server部分，具体指的是Http的server部分。所以，其在Http配置的context是可用的。该部分用于处理http连接，因此该模块下提供了相当数量的指令。</p>\n<h3 id=\"客户端指令\"><a href=\"#客户端指令\" class=\"headerlink\" title=\"客户端指令\"></a>客户端指令</h3><blockquote>\n<p>用于处理客户端连接本身的各个方面，以及不同类型的客户端</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>chunked_transfer_encoding</td>\n<td>在发给客户端的响应中允许禁用http/1.1标准的块传输编码</td>\n</tr>\n<tr>\n<td>client_body_buffer_size</td>\n<td>为了阻止临时文件写到磁盘，可以通过该指令为客户端请求体设置缓存大小，默认的缓存大小为两个内存页面</td>\n</tr>\n<tr>\n<td>client_body_in_file_only</td>\n<td>用于调试或者是进一步处理客户端请求体。该指令能够将客户端请求体强制写入到磁盘文件</td>\n</tr>\n<tr>\n<td>client_body_in_single_buffer</td>\n<td>为了减少拷贝的操作，使用该指令强制Nginx将整个客户端请求体保存到单个缓存中</td>\n</tr>\n<tr>\n<td>client_body_temp_path</td>\n<td>定义一个命令路径用于保存客户端请求体</td>\n</tr>\n<tr>\n<td>clent_body_timeout</td>\n<td>指定客户端成功读取的两个操作之间的时间间隔</td>\n</tr>\n<tr>\n<td>client_header_buffer_size</td>\n<td>为客户端请求头指定一个缓存大小，当请求头大于1kB时会用到这个设置。</td>\n</tr>\n<tr>\n<td>client_header_timeout</td>\n<td>读取整个客户端头的超时时间</td>\n</tr>\n<tr>\n<td>client_max_body_size</td>\n<td>定义允许最大的客户端请求头，如果大于该值，那么客户端将会是413（request entity too large）错误</td>\n</tr>\n<tr>\n<td>keepalive_disable</td>\n<td>对某些类型的客户端禁用keep-alive请求功能。</td>\n</tr>\n<tr>\n<td>keepalive_requests</td>\n<td>定义在一个keep-alive关闭之前可以接收多少个请求</td>\n</tr>\n<tr>\n<td>keepalive_timeout</td>\n<td>指定keep-alive连接持续多久。第二个参数用于在响应头中这只”Keep-Alive”头</td>\n</tr>\n<tr>\n<td>large_client_header_buffers</td>\n<td>定义最大数量和最大客户端请求头的大小</td>\n</tr>\n<tr>\n<td>msie_padding</td>\n<td>为了填充响应的大小至512字节，对于MSIE客户端，大于400的状态码会被添加注释以便满足512字节，通过启用该命令可以阻止这种行为</td>\n</tr>\n<tr>\n<td>msie_refresh</td>\n<td>对于MSIE客户端，可启用发送一个refresh头</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"文件I-O指令\"><a href=\"#文件I-O指令\" class=\"headerlink\" title=\"文件I/O指令\"></a>文件I/O指令</h3><blockquote>\n<p>用于控制Nginx如何投递静态文件。</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>aio</td>\n<td>启用异步文件I/O。FreeBSD系统下，该值可能被用于sendfile预加载数据。Linux下需要directio指令，自动禁用sendfile</td>\n</tr>\n<tr>\n<td>directio</td>\n<td>用于启用操作系统特定的标识或者功能提供大于给定参数的文件。Linux下使用aio时需要使用该指令。</td>\n</tr>\n<tr>\n<td>directio_alignment</td>\n<td>设置directio算法。默认值是512，通常已经足够，但是在Linux的XFS下推荐增加至4K</td>\n</tr>\n<tr>\n<td>open_file_cache</td>\n<td>配置一个缓存用于存放打开的文件描述符、目录查询和文件查询错误</td>\n</tr>\n<tr>\n<td>open_file_cache_errors</td>\n<td>按照open_file_cache，启用文件查询错误缓存</td>\n</tr>\n<tr>\n<td>open_file_cache_min_uses</td>\n<td>open_file_cache缓存的文件描述符保留在缓存中，使用该指令配置最少使用文件描述符的次数</td>\n</tr>\n<tr>\n<td>open_file_cache_valid</td>\n<td>指定对open_file_cache缓存有效性检查的时间间隔</td>\n</tr>\n<tr>\n<td>postpone_output</td>\n<td>指定Nginx发送给客户端最小的数值，如果可能的话，没有数据会发送，直到达到此值</td>\n</tr>\n<tr>\n<td>read_ahead</td>\n<td>如果可能的话，内核将预读文件到设定的参数大小</td>\n</tr>\n<tr>\n<td>sendfile</td>\n<td>使用sendfile（2）直接复制数据从一个到另一个文件描述符</td>\n</tr>\n<tr>\n<td>sendfile_max_chunk</td>\n<td>设置在一个sendfile(2)拷贝中最大数据的大小，这是为了阻止worker”贪婪”</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Hash指令\"><a href=\"#Hash指令\" class=\"headerlink\" title=\"Hash指令\"></a>Hash指令</h3><blockquote>\n<p>控制Nginx 分配给某些变量多大的静态文件</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>server_names_hash_bucket_size</td>\n<td>指定用于保存server_name哈希表大小的”桶”</td>\n</tr>\n<tr>\n<td>server_names_hash_max_size</td>\n<td>指定的server_name哈希表的最大值的大小</td>\n</tr>\n<tr>\n<td>types_hash_bucket_size</td>\n<td>指定用于存放哈希表的”桶”的大小</td>\n</tr>\n<tr>\n<td>types_hash_max_size</td>\n<td>指定哈希类型表的最大值的大小</td>\n</tr>\n<tr>\n<td>variables_hash_bucket_size</td>\n<td>指定用于存放保留变量”桶”的大小</td>\n</tr>\n<tr>\n<td>variables_hash_max_size</td>\n<td>指定存放保留变量最大哈希值的大小</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"Socket指令\"><a href=\"#Socket指令\" class=\"headerlink\" title=\"Socket指令\"></a>Socket指令</h3><blockquote>\n<p>描述Nginx如何设置创建TCP套接字的变量选项</p>\n</blockquote>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lingering_close</td>\n<td>指定如何保持客户端的连接，以便用于更多数据的传输</td>\n</tr>\n<tr>\n<td>lingering_time</td>\n<td>在使用lingering_close指令的连接中，使用该指令指定客户端连接为了处理更多的数据需要保持打开连接的时间</td>\n</tr>\n<tr>\n<td>lingering_timeout</td>\n<td>结合lingering_close，该指令显示Nginx在关闭客户端连接之前，为获得更多数据会等待多久</td>\n</tr>\n<tr>\n<td>reset_timeout_connection</td>\n<td>使用这个指令之后，超时的连接会被立即关闭，释放相关的内存。默认的状态是处于FIN_WAIT1，这种状态将会一直保持连接</td>\n</tr>\n<tr>\n<td>send_lowat</td>\n<td>如果非零，Nginx将会在客户端套接字尝试减少发送操作</td>\n</tr>\n<tr>\n<td>send_timeout</td>\n<td>在两次成功的客户端接收响应的写操作之间设置一个超时时间</td>\n</tr>\n<tr>\n<td>tcp_nodelay</td>\n<td>启用或禁用TCP_NODELAY选项，用于keep-alive连接</td>\n</tr>\n<tr>\n<td>tcp_nopush</td>\n<td>仅依赖于sendfile的使用。它能够使Nginx在一个数据包中尝试发送响应头，以及在数据包中发送一个完整的文件</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"server部分\"><a href=\"#server部分\" class=\"headerlink\" title=\"server部分\"></a>server部分</h3><p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div></pre></td><td class=\"code\"><pre><div class=\"line\">http &#123;</div><div class=\"line\">    ...</div><div class=\"line\">    server &#123;</div><div class=\"line\">        listen       80 default_server;</div><div class=\"line\">        server_name  _;</div><div class=\"line\">        root         /usr/share/nginx/html;</div><div class=\"line\"></div><div class=\"line\">        # Load configuration files for the default server block.</div><div class=\"line\">        include /etc/nginx/default.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">        location / &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 404 /404.html;</div><div class=\"line\">            location = /40x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 500 502 503 504 /50x.html;</div><div class=\"line\">            location = /50x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>一个虚拟服务器由listen和server_name指令组合定义。</p>\n<p><strong>listen</strong></p>\n<blockquote>\n<p>指令定义一个IP地址/端口组合或者UNIX套接字路径。示例</p>\n<ul>\n<li>listen address[:port];</li>\n<li>listen port;</li>\n<li>listen unix:path;</li>\n</ul>\n</blockquote>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">listen     127.0.0.1:80;</div><div class=\"line\">listen     localhost:80;</div><div class=\"line\">listen     127.0.0.1:8080;</div><div class=\"line\">listen     localhost:8080;</div><div class=\"line\">listen     192.168.3.105:80;</div><div class=\"line\">listen     192.168.3.105:8080;</div><div class=\"line\">listen     80;</div><div class=\"line\">listen     *:80;</div><div class=\"line\">listen     8080;</div><div class=\"line\">listen     *:8080;</div><div class=\"line\">listen     12.34.56.77:80;</div><div class=\"line\">listen     12.34.56.78:80;</div><div class=\"line\">listen     12.34.56.79:80;</div></pre></td></tr></table></figure></p>\n<p>另外，listen还有其他的一些可选参数。常用到的有<br>default_server，表示定义这样的一个组合：（address:port）默认的请求被绑定于此<br>ssl，表明该端口仅接受Https的连接</p>\n<p><strong>server_name</strong></p>\n<blockquote>\n<p>用来指定域名。</p>\n</blockquote>\n<p>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">server_name   nginx.cn;</div><div class=\"line\">server_name   nginx.cn www.nginx.cn;</div><div class=\"line\">server_name   *.nginx.cn;</div><div class=\"line\">server_name   .nginx.cn;</div><div class=\"line\">server_name   nginx.*;</div><div class=\"line\">server_name   nginx.cng bucknell.net brackley.org;</div><div class=\"line\">server_name   localhost litchfield bleddington;</div><div class=\"line\">server_name   &quot;&quot;;</div></pre></td></tr></table></figure></p>\n<p>除了普通字符串外，Nginx也接受通配符作为Server_name的参数。</p>\n<ul>\n<li>使用通配符替代部分子域名： *.example.com</li>\n<li>代替顶级域部分： www.example.*</li>\n<li>匹配子域和域本身： .example.com 能匹配 *.example.com 和example.com</li>\n</ul>\n<p>另外，在域名前加上（~），正则表达式也可应用于 server_name.<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">server_name ~^www\\.example\\.com$</div><div class=\"line\">server_name ~^www(\\d+).example\\.(com)$</div></pre></td></tr></table></figure></p>\n<p>对于后一种方式是利用捕获，可以在以后的引用中进一步配置（用$1,$2等）指令中使用。</p>\n<h2 id=\"location部分\"><a href=\"#location部分\" class=\"headerlink\" title=\"location部分\"></a>location部分</h2><p>location指令可以用在虚拟服务器server部分，并且意味着提供来自客户端的URI或者内部的重定向访问。</p>\n<p>location定义：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">location [modifier] uri &#123;...&#125;</div></pre></td></tr></table></figure></p>\n<p>或者是命名location<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">location @name &#123;...&#125;</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>命名location仅对内部访问重定向，在进入一个location之前他会保留被请求的URI部分。且命名location只能存在与server级别的定义。</p>\n</blockquote>\n<p>示例<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">location / &#123; &#125;</div><div class=\"line\">location /images/ &#123; &#125;</div><div class=\"line\">location /blog/ &#123; &#125;</div><div class=\"line\">location /planet/ &#123; &#125;</div><div class=\"line\">location /planet/blog/ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location ~ IndexPage.php$ &#123; &#125;</div><div class=\"line\">location ~ ^/BlogPlanet(/|/index.php)$ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location ~* .(pl|cgi|perl|prl)$ &#123; &#125;</div><div class=\"line\">location ~* .(md|mdwn|txt|mkdn)$ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location ^~ /images/IndexPage/ &#123; &#125;</div><div class=\"line\">location ^~ /blog/BlogPlanet/ &#123; &#125;</div><div class=\"line\"></div><div class=\"line\">location = / &#123; &#125;</div></pre></td></tr></table></figure></p>\n<p>当一个请求进入时，URI将会被检测匹配一个最佳的location。</p>\n<ul>\n<li>没有正则表达式的location被认为是最佳的匹配，独立于含有正则表达式的location。</li>\n<li>在配置文件中按照查找顺序进行正则匹配，在查到第一个正则表达式匹配时结束查找，将请求交由这个location处理。<br><strong>Tips：</strong><br>这里匹配的解码URI，如在URL中的”%20”,将会匹配location中的””(空格)。</li>\n</ul>\n<p>location常见的修饰符</p>\n<table>\n<thead>\n<tr>\n<th>修饰符</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>=</td>\n<td>使用精确匹配并且终止搜索</td>\n</tr>\n<tr>\n<td>~</td>\n<td>区分大小写的正则表达式匹配</td>\n</tr>\n<tr>\n<td>~*</td>\n<td>不去分大小写的正则表达式匹配</td>\n</tr>\n<tr>\n<td>^~</td>\n<td>如果该location是最佳的匹配，那么对于匹配这个location的字符串不在进行正则表达式检测。</td>\n</tr>\n</tbody>\n</table>\n<p>仅用于location中的指令</p>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>alias</td>\n<td>定义location的其他名字，在文件系统中能够找到。</td>\n</tr>\n<tr>\n<td>internal</td>\n<td>指定一个仅用于内部请求的location（其他指定定义的重定向，rewrite请求，error请求等）</td>\n</tr>\n<tr>\n<td>limit_except</td>\n<td>限定一个location可以执行的Http操作（如，GET或HEAD）</td>\n</tr>\n</tbody>\n</table>\n<p>命名location的使用（一般与try_files配合使用）<br>示例：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">location / &#123;</div><div class=\"line\">  try_files $uri $uri/ $mongrel;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">location @mongrel &#123;</div><div class=\"line\">  proxy_pass http://appserver;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>上面一段配置表示，如果给定的URI作为一个文件没有被找到，那么处理将会通过代理被传递到appserver</p>\n<p>location的嵌套使用：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">root /var/www</div><div class=\"line\"></div><div class=\"line\">location / &#123;</div><div class=\"line\">  location ^~ /css &#123;</div><div class=\"line\">    location ~* /css.*\\.css$ &#123;</div><div class=\"line\">      ...</div><div class=\"line\">    &#125;</div><div class=\"line\">    ...</div><div class=\"line\">  &#125;</div><div class=\"line\">  ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>实践表明正则表达式location被嵌套在基于字符串的location是最佳的配置方式</strong></p>\n<h2 id=\"完整的配置文件示例\"><a href=\"#完整的配置文件示例\" class=\"headerlink\" title=\"完整的配置文件示例\"></a>完整的配置文件示例</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div></pre></td><td class=\"code\"><pre><div class=\"line\"># For more information on configuration, see:</div><div class=\"line\">#   * Official English Documentation: http://nginx.org/en/docs/</div><div class=\"line\">#   * Official Russian Documentation: http://nginx.org/ru/docs/</div><div class=\"line\"></div><div class=\"line\">user nginx;</div><div class=\"line\">worker_processes auto;</div><div class=\"line\">error_log /var/log/nginx/error.log;</div><div class=\"line\">pid /run/nginx.pid;</div><div class=\"line\"></div><div class=\"line\">events &#123;</div><div class=\"line\">    worker_connections 1024;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\">http &#123;</div><div class=\"line\">    log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class=\"line\">                      &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class=\"line\">                      &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class=\"line\"></div><div class=\"line\">    access_log  /var/log/nginx/access.log  main;</div><div class=\"line\"></div><div class=\"line\">    sendfile            on;</div><div class=\"line\">    tcp_nopush          on;</div><div class=\"line\">    tcp_nodelay         on;</div><div class=\"line\">    keepalive_timeout   65;</div><div class=\"line\">    types_hash_max_size 2048;</div><div class=\"line\"></div><div class=\"line\">    include             /etc/nginx/mime.types;</div><div class=\"line\">    default_type        application/octet-stream;</div><div class=\"line\"></div><div class=\"line\">    # Load modular configuration files from the /etc/nginx/conf.d directory.</div><div class=\"line\">    # See http://nginx.org/en/docs/ngx_core_module.html#include</div><div class=\"line\">    # for more information.</div><div class=\"line\">    include /etc/nginx/conf.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">    server &#123;</div><div class=\"line\">        listen       80 default_server;</div><div class=\"line\">        listen       [::]:80 default_server;</div><div class=\"line\">        server_name  _;</div><div class=\"line\">        root         /usr/share/nginx/html;</div><div class=\"line\"></div><div class=\"line\">        # Load configuration files for the default server block.</div><div class=\"line\">        include /etc/nginx/default.d/*.conf;</div><div class=\"line\"></div><div class=\"line\">        location / &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 404 /404.html;</div><div class=\"line\">            location = /40x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\"></div><div class=\"line\">        error_page 500 502 503 504 /50x.html;</div><div class=\"line\">            location = /50x.html &#123;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>"},{"title":"PHP常见设计模式之单例模式","date":"2016-10-14T12:00:00.000Z","_content":"\n## 什么是单例模式\n当我们实例化一个对象时，他可以确保我们实例化的这个类将仅有一个实例，并且我们在我们的代码中的任何地方都可以轻易的召回相同的对象。\n\n就是说，当我们使用单例模式第一次调用对象时，他就会被实例化，之后每一次调用都将会返回同一个对象。\n\n单例模式通常用于对象，它代表在应用程序不同部分被再三使用的资源，而且始终为同一对象。\n\n常见的示例包括数据库连接和配置信息。\n\n<!-- more -->\n\n## 为什么要使用单例模式\n单例模式最重要的方面就是在于对创建示例的限制能力。如果不这样做的话，应用程序中同一个对象可能会被创建多个实例，可能会造成资源的浪费。\n\n## 实现方式\n通过创建私有的构造器来实现限制对象创建实例的能力。示例，\n```php\n<?php\nclass Database extend PDO{\n\n  //私有静态变量，用来保存单例实例\n  private static $_instance = null;\n\n  //私有构造函数，保证这个类只能被本省的静态发放实例化\n  private function _contruct(){\n\n    //调用PDO的构造函数\n    parent::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);\n  }\n\n  //获得单例实例的方法。如果实例已经存在，则直接返回；否则先构造一个，然后返回；\n  public static function getInstance(){\n    if(!(self::$_instance instanceof Database)){\n      self::$_instance = new Database();\n    }\n    return self::$_instance;\n  }\n\n}\n```\n\n实现单例的三个关键点：\n- 使用一个静态成员来保持一个单例实例。在这个例子中，我们有一个私有的DB::$\\_instance属性。\n- 然后，一个私有的构造函数将决定这个类只能被本身所包含的静态方法实例化。\n- DB::getInstance()静态方法将用于数据库类。当他被调用时，DB::getInstance()将实例化一个Database类的对象并将这个对象指定给DB::$\\_instance属性，然后返回这个对象，或只返回先前已经实例化的对象。\n\n我们之所以使用单例模式，是因为静态方法可以在全局范围内被访问，无论哪里，当我们需要一个数据库连接时，只需要调用DB::getInstance()即可。\n\n## 使用单例模式的问题\n**尽管单例思想很伟大，但当我们确实需要多个实例的时候，其局限性就显而易见。**\n> 比如，我们拆分了数据库之后，就需要在不同的服务器上进行读写操作。而这时单例就满足不了我们的需求了。\n\n所以单例模式不恰当的使用就会抑制自身的发展和重用。所以当想通过一个类创建两个实例，我们可以考虑通过注册表模式来实现。\n","source":"_posts/PHP常见设计模式之单例模式.md","raw":"---\ntitle: PHP常见设计模式之单例模式\ndate: 2016-10-14 20:00:00\ntags:\n- 设计模式\n- 单例模式\ncategories:\n- PHP\n---\n\n## 什么是单例模式\n当我们实例化一个对象时，他可以确保我们实例化的这个类将仅有一个实例，并且我们在我们的代码中的任何地方都可以轻易的召回相同的对象。\n\n就是说，当我们使用单例模式第一次调用对象时，他就会被实例化，之后每一次调用都将会返回同一个对象。\n\n单例模式通常用于对象，它代表在应用程序不同部分被再三使用的资源，而且始终为同一对象。\n\n常见的示例包括数据库连接和配置信息。\n\n<!-- more -->\n\n## 为什么要使用单例模式\n单例模式最重要的方面就是在于对创建示例的限制能力。如果不这样做的话，应用程序中同一个对象可能会被创建多个实例，可能会造成资源的浪费。\n\n## 实现方式\n通过创建私有的构造器来实现限制对象创建实例的能力。示例，\n```php\n<?php\nclass Database extend PDO{\n\n  //私有静态变量，用来保存单例实例\n  private static $_instance = null;\n\n  //私有构造函数，保证这个类只能被本省的静态发放实例化\n  private function _contruct(){\n\n    //调用PDO的构造函数\n    parent::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);\n  }\n\n  //获得单例实例的方法。如果实例已经存在，则直接返回；否则先构造一个，然后返回；\n  public static function getInstance(){\n    if(!(self::$_instance instanceof Database)){\n      self::$_instance = new Database();\n    }\n    return self::$_instance;\n  }\n\n}\n```\n\n实现单例的三个关键点：\n- 使用一个静态成员来保持一个单例实例。在这个例子中，我们有一个私有的DB::$\\_instance属性。\n- 然后，一个私有的构造函数将决定这个类只能被本身所包含的静态方法实例化。\n- DB::getInstance()静态方法将用于数据库类。当他被调用时，DB::getInstance()将实例化一个Database类的对象并将这个对象指定给DB::$\\_instance属性，然后返回这个对象，或只返回先前已经实例化的对象。\n\n我们之所以使用单例模式，是因为静态方法可以在全局范围内被访问，无论哪里，当我们需要一个数据库连接时，只需要调用DB::getInstance()即可。\n\n## 使用单例模式的问题\n**尽管单例思想很伟大，但当我们确实需要多个实例的时候，其局限性就显而易见。**\n> 比如，我们拆分了数据库之后，就需要在不同的服务器上进行读写操作。而这时单例就满足不了我们的需求了。\n\n所以单例模式不恰当的使用就会抑制自身的发展和重用。所以当想通过一个类创建两个实例，我们可以考虑通过注册表模式来实现。\n","slug":"PHP常见设计模式之单例模式","published":1,"updated":"2016-10-14T08:02:28.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwk002m699f9rwfw7hv","content":"<h2 id=\"什么是单例模式\"><a href=\"#什么是单例模式\" class=\"headerlink\" title=\"什么是单例模式\"></a>什么是单例模式</h2><p>当我们实例化一个对象时，他可以确保我们实例化的这个类将仅有一个实例，并且我们在我们的代码中的任何地方都可以轻易的召回相同的对象。</p>\n<p>就是说，当我们使用单例模式第一次调用对象时，他就会被实例化，之后每一次调用都将会返回同一个对象。</p>\n<p>单例模式通常用于对象，它代表在应用程序不同部分被再三使用的资源，而且始终为同一对象。</p>\n<p>常见的示例包括数据库连接和配置信息。</p>\n<a id=\"more\"></a>\n<h2 id=\"为什么要使用单例模式\"><a href=\"#为什么要使用单例模式\" class=\"headerlink\" title=\"为什么要使用单例模式\"></a>为什么要使用单例模式</h2><p>单例模式最重要的方面就是在于对创建示例的限制能力。如果不这样做的话，应用程序中同一个对象可能会被创建多个实例，可能会造成资源的浪费。</p>\n<h2 id=\"实现方式\"><a href=\"#实现方式\" class=\"headerlink\" title=\"实现方式\"></a>实现方式</h2><p>通过创建私有的构造器来实现限制对象创建实例的能力。示例，<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Database</span> <span class=\"title\">extend</span> <span class=\"title\">PDO</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//私有静态变量，用来保存单例实例</span></div><div class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//私有构造函数，保证这个类只能被本省的静态发放实例化</span></div><div class=\"line\">  <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_contruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">//调用PDO的构造函数</span></div><div class=\"line\">    <span class=\"keyword\">parent</span>::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//获得单例实例的方法。如果实例已经存在，则直接返回；否则先构造一个，然后返回；</span></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(!(<span class=\"keyword\">self</span>::$_instance <span class=\"keyword\">instanceof</span> Database))&#123;</div><div class=\"line\">      <span class=\"keyword\">self</span>::$_instance = <span class=\"keyword\">new</span> Database();</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_instance;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>实现单例的三个关键点：</p>\n<ul>\n<li>使用一个静态成员来保持一个单例实例。在这个例子中，我们有一个私有的DB::$_instance属性。</li>\n<li>然后，一个私有的构造函数将决定这个类只能被本身所包含的静态方法实例化。</li>\n<li>DB::getInstance()静态方法将用于数据库类。当他被调用时，DB::getInstance()将实例化一个Database类的对象并将这个对象指定给DB::$_instance属性，然后返回这个对象，或只返回先前已经实例化的对象。</li>\n</ul>\n<p>我们之所以使用单例模式，是因为静态方法可以在全局范围内被访问，无论哪里，当我们需要一个数据库连接时，只需要调用DB::getInstance()即可。</p>\n<h2 id=\"使用单例模式的问题\"><a href=\"#使用单例模式的问题\" class=\"headerlink\" title=\"使用单例模式的问题\"></a>使用单例模式的问题</h2><p><strong>尽管单例思想很伟大，但当我们确实需要多个实例的时候，其局限性就显而易见。</strong></p>\n<blockquote>\n<p>比如，我们拆分了数据库之后，就需要在不同的服务器上进行读写操作。而这时单例就满足不了我们的需求了。</p>\n</blockquote>\n<p>所以单例模式不恰当的使用就会抑制自身的发展和重用。所以当想通过一个类创建两个实例，我们可以考虑通过注册表模式来实现。</p>\n","excerpt":"<h2 id=\"什么是单例模式\"><a href=\"#什么是单例模式\" class=\"headerlink\" title=\"什么是单例模式\"></a>什么是单例模式</h2><p>当我们实例化一个对象时，他可以确保我们实例化的这个类将仅有一个实例，并且我们在我们的代码中的任何地方都可以轻易的召回相同的对象。</p>\n<p>就是说，当我们使用单例模式第一次调用对象时，他就会被实例化，之后每一次调用都将会返回同一个对象。</p>\n<p>单例模式通常用于对象，它代表在应用程序不同部分被再三使用的资源，而且始终为同一对象。</p>\n<p>常见的示例包括数据库连接和配置信息。</p>","more":"<h2 id=\"为什么要使用单例模式\"><a href=\"#为什么要使用单例模式\" class=\"headerlink\" title=\"为什么要使用单例模式\"></a>为什么要使用单例模式</h2><p>单例模式最重要的方面就是在于对创建示例的限制能力。如果不这样做的话，应用程序中同一个对象可能会被创建多个实例，可能会造成资源的浪费。</p>\n<h2 id=\"实现方式\"><a href=\"#实现方式\" class=\"headerlink\" title=\"实现方式\"></a>实现方式</h2><p>通过创建私有的构造器来实现限制对象创建实例的能力。示例，<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Database</span> <span class=\"title\">extend</span> <span class=\"title\">PDO</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//私有静态变量，用来保存单例实例</span></div><div class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_instance = <span class=\"keyword\">null</span>;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//私有构造函数，保证这个类只能被本省的静态发放实例化</span></div><div class=\"line\">  <span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">_contruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"comment\">//调用PDO的构造函数</span></div><div class=\"line\">    <span class=\"keyword\">parent</span>::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//获得单例实例的方法。如果实例已经存在，则直接返回；否则先构造一个，然后返回；</span></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(!(<span class=\"keyword\">self</span>::$_instance <span class=\"keyword\">instanceof</span> Database))&#123;</div><div class=\"line\">      <span class=\"keyword\">self</span>::$_instance = <span class=\"keyword\">new</span> Database();</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_instance;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>实现单例的三个关键点：</p>\n<ul>\n<li>使用一个静态成员来保持一个单例实例。在这个例子中，我们有一个私有的DB::$_instance属性。</li>\n<li>然后，一个私有的构造函数将决定这个类只能被本身所包含的静态方法实例化。</li>\n<li>DB::getInstance()静态方法将用于数据库类。当他被调用时，DB::getInstance()将实例化一个Database类的对象并将这个对象指定给DB::$_instance属性，然后返回这个对象，或只返回先前已经实例化的对象。</li>\n</ul>\n<p>我们之所以使用单例模式，是因为静态方法可以在全局范围内被访问，无论哪里，当我们需要一个数据库连接时，只需要调用DB::getInstance()即可。</p>\n<h2 id=\"使用单例模式的问题\"><a href=\"#使用单例模式的问题\" class=\"headerlink\" title=\"使用单例模式的问题\"></a>使用单例模式的问题</h2><p><strong>尽管单例思想很伟大，但当我们确实需要多个实例的时候，其局限性就显而易见。</strong></p>\n<blockquote>\n<p>比如，我们拆分了数据库之后，就需要在不同的服务器上进行读写操作。而这时单例就满足不了我们的需求了。</p>\n</blockquote>\n<p>所以单例模式不恰当的使用就会抑制自身的发展和重用。所以当想通过一个类创建两个实例，我们可以考虑通过注册表模式来实现。</p>"},{"title":"PHP常见设计模式之工厂模式","date":"2016-10-14T13:00:00.000Z","_content":"\n## 什么是工厂模式\n工厂模式是我们最常用的实例化对象模式了，顾名思义工厂设计模式，就是用于制造对象的一种设计模式，是一种用来代替new操作的一种模式。\n\n其的最大价值在于它可以将多个对象设置封装成单一、简单的方法调用。\n\n对外提供获取某个对象的新实例的接口，同时使调用代码避免确定实际实例化基类的步骤。\n\n<!-- more -->\n\n## 工厂模式的应用和使用场景\n通常情况下，虽然我们很少使用工厂模式，但它仍然最适合初始化基于驱动安装的许多变种中的一种。例如，不同的配置、会话或缓存存储引擎。例如，当我们设置一个日志对象时，我们需要设置日志类型（如，基于文本、MySQL或者其他）、日志的位置、以及类似于凭证条目。\n\n## 工厂模式的实现\n### UML设计\n\n![UML设计图](http://n.sinaimg.cn/games/3ece443e/20161014/GongChangMoShiUMLTu.png)\n\n说明：\n- 三个基类Log_File、Log_Mysql、Log_Sqlite,都具有名为dosomething()的公用方法，该方法采用他们各自独特的方式执行具体的逻辑。且其返回类型也应该完全相同。\n- Log_factory类用于创建下面三个任意一个基类的实例，并将其返回至代码流。\n\n### 代码实现\n工厂类Log_factory实现\n```php\n<?php\n\nclass Log_factory{\n\n  public function getLog($type = 'file', array $options){\n    $type = strtolower($type);\n\n    $class = \"Log_\".unfirst($type);\n    require_once str_replace('_', DIRECTORY_SEPARATOR, $class).'.php';\n\n    $log = new $class($options);\n    switch($type){\n      case 'file':\n        $log->setPath($options['location']);\n        break;\n      case 'mysql':\n        $log->setUser($options['username']);\n        $log->setPassword($options['password']);\n        $log->setDBname($options['location']);\n        break;\n      case 'sqlite':\n        $log->setDBPath($options['location']);\n        break;\n    }\n\n    return $log;\n  }\n}\n```\n\n\n**Tips:**\n在实际应用中，我们可以把getLog()方法生成的对象添加到Registry，这样就不用一遍又一遍的实例化这些对象。\n","source":"_posts/PHP常见设计模式之工厂模式.md","raw":"---\ntitle: PHP常见设计模式之工厂模式\ndate: 2016-10-14 21:00:00\ntags:\n- 设计模式\n- 工厂模式\ncategories:\n- PHP\n---\n\n## 什么是工厂模式\n工厂模式是我们最常用的实例化对象模式了，顾名思义工厂设计模式，就是用于制造对象的一种设计模式，是一种用来代替new操作的一种模式。\n\n其的最大价值在于它可以将多个对象设置封装成单一、简单的方法调用。\n\n对外提供获取某个对象的新实例的接口，同时使调用代码避免确定实际实例化基类的步骤。\n\n<!-- more -->\n\n## 工厂模式的应用和使用场景\n通常情况下，虽然我们很少使用工厂模式，但它仍然最适合初始化基于驱动安装的许多变种中的一种。例如，不同的配置、会话或缓存存储引擎。例如，当我们设置一个日志对象时，我们需要设置日志类型（如，基于文本、MySQL或者其他）、日志的位置、以及类似于凭证条目。\n\n## 工厂模式的实现\n### UML设计\n\n![UML设计图](http://n.sinaimg.cn/games/3ece443e/20161014/GongChangMoShiUMLTu.png)\n\n说明：\n- 三个基类Log_File、Log_Mysql、Log_Sqlite,都具有名为dosomething()的公用方法，该方法采用他们各自独特的方式执行具体的逻辑。且其返回类型也应该完全相同。\n- Log_factory类用于创建下面三个任意一个基类的实例，并将其返回至代码流。\n\n### 代码实现\n工厂类Log_factory实现\n```php\n<?php\n\nclass Log_factory{\n\n  public function getLog($type = 'file', array $options){\n    $type = strtolower($type);\n\n    $class = \"Log_\".unfirst($type);\n    require_once str_replace('_', DIRECTORY_SEPARATOR, $class).'.php';\n\n    $log = new $class($options);\n    switch($type){\n      case 'file':\n        $log->setPath($options['location']);\n        break;\n      case 'mysql':\n        $log->setUser($options['username']);\n        $log->setPassword($options['password']);\n        $log->setDBname($options['location']);\n        break;\n      case 'sqlite':\n        $log->setDBPath($options['location']);\n        break;\n    }\n\n    return $log;\n  }\n}\n```\n\n\n**Tips:**\n在实际应用中，我们可以把getLog()方法生成的对象添加到Registry，这样就不用一遍又一遍的实例化这些对象。\n","slug":"PHP常见设计模式之工厂模式","published":1,"updated":"2016-10-14T09:41:06.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwm002o699f8j3ashue","content":"<h2 id=\"什么是工厂模式\"><a href=\"#什么是工厂模式\" class=\"headerlink\" title=\"什么是工厂模式\"></a>什么是工厂模式</h2><p>工厂模式是我们最常用的实例化对象模式了，顾名思义工厂设计模式，就是用于制造对象的一种设计模式，是一种用来代替new操作的一种模式。</p>\n<p>其的最大价值在于它可以将多个对象设置封装成单一、简单的方法调用。</p>\n<p>对外提供获取某个对象的新实例的接口，同时使调用代码避免确定实际实例化基类的步骤。</p>\n<a id=\"more\"></a>\n<h2 id=\"工厂模式的应用和使用场景\"><a href=\"#工厂模式的应用和使用场景\" class=\"headerlink\" title=\"工厂模式的应用和使用场景\"></a>工厂模式的应用和使用场景</h2><p>通常情况下，虽然我们很少使用工厂模式，但它仍然最适合初始化基于驱动安装的许多变种中的一种。例如，不同的配置、会话或缓存存储引擎。例如，当我们设置一个日志对象时，我们需要设置日志类型（如，基于文本、MySQL或者其他）、日志的位置、以及类似于凭证条目。</p>\n<h2 id=\"工厂模式的实现\"><a href=\"#工厂模式的实现\" class=\"headerlink\" title=\"工厂模式的实现\"></a>工厂模式的实现</h2><h3 id=\"UML设计\"><a href=\"#UML设计\" class=\"headerlink\" title=\"UML设计\"></a>UML设计</h3><p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161014/GongChangMoShiUMLTu.png\" alt=\"UML设计图\"></p>\n<p>说明：</p>\n<ul>\n<li>三个基类Log_File、Log_Mysql、Log_Sqlite,都具有名为dosomething()的公用方法，该方法采用他们各自独特的方式执行具体的逻辑。且其返回类型也应该完全相同。</li>\n<li>Log_factory类用于创建下面三个任意一个基类的实例，并将其返回至代码流。</li>\n</ul>\n<h3 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><p>工厂类Log_factory实现<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Log_factory</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getLog</span><span class=\"params\">($type = <span class=\"string\">'file'</span>, array $options)</span></span>&#123;</div><div class=\"line\">    $type = strtolower($type);</div><div class=\"line\"></div><div class=\"line\">    $class = <span class=\"string\">\"Log_\"</span>.unfirst($type);</div><div class=\"line\">    <span class=\"keyword\">require_once</span> str_replace(<span class=\"string\">'_'</span>, DIRECTORY_SEPARATOR, $class).<span class=\"string\">'.php'</span>;</div><div class=\"line\"></div><div class=\"line\">    $log = <span class=\"keyword\">new</span> $class($options);</div><div class=\"line\">    <span class=\"keyword\">switch</span>($type)&#123;</div><div class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">'file'</span>:</div><div class=\"line\">        $log-&gt;setPath($options[<span class=\"string\">'location'</span>]);</div><div class=\"line\">        <span class=\"keyword\">break</span>;</div><div class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">'mysql'</span>:</div><div class=\"line\">        $log-&gt;setUser($options[<span class=\"string\">'username'</span>]);</div><div class=\"line\">        $log-&gt;setPassword($options[<span class=\"string\">'password'</span>]);</div><div class=\"line\">        $log-&gt;setDBname($options[<span class=\"string\">'location'</span>]);</div><div class=\"line\">        <span class=\"keyword\">break</span>;</div><div class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">'sqlite'</span>:</div><div class=\"line\">        $log-&gt;setDBPath($options[<span class=\"string\">'location'</span>]);</div><div class=\"line\">        <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> $log;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>Tips:</strong><br>在实际应用中，我们可以把getLog()方法生成的对象添加到Registry，这样就不用一遍又一遍的实例化这些对象。</p>\n","excerpt":"<h2 id=\"什么是工厂模式\"><a href=\"#什么是工厂模式\" class=\"headerlink\" title=\"什么是工厂模式\"></a>什么是工厂模式</h2><p>工厂模式是我们最常用的实例化对象模式了，顾名思义工厂设计模式，就是用于制造对象的一种设计模式，是一种用来代替new操作的一种模式。</p>\n<p>其的最大价值在于它可以将多个对象设置封装成单一、简单的方法调用。</p>\n<p>对外提供获取某个对象的新实例的接口，同时使调用代码避免确定实际实例化基类的步骤。</p>","more":"<h2 id=\"工厂模式的应用和使用场景\"><a href=\"#工厂模式的应用和使用场景\" class=\"headerlink\" title=\"工厂模式的应用和使用场景\"></a>工厂模式的应用和使用场景</h2><p>通常情况下，虽然我们很少使用工厂模式，但它仍然最适合初始化基于驱动安装的许多变种中的一种。例如，不同的配置、会话或缓存存储引擎。例如，当我们设置一个日志对象时，我们需要设置日志类型（如，基于文本、MySQL或者其他）、日志的位置、以及类似于凭证条目。</p>\n<h2 id=\"工厂模式的实现\"><a href=\"#工厂模式的实现\" class=\"headerlink\" title=\"工厂模式的实现\"></a>工厂模式的实现</h2><h3 id=\"UML设计\"><a href=\"#UML设计\" class=\"headerlink\" title=\"UML设计\"></a>UML设计</h3><p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161014/GongChangMoShiUMLTu.png\" alt=\"UML设计图\"></p>\n<p>说明：</p>\n<ul>\n<li>三个基类Log_File、Log_Mysql、Log_Sqlite,都具有名为dosomething()的公用方法，该方法采用他们各自独特的方式执行具体的逻辑。且其返回类型也应该完全相同。</li>\n<li>Log_factory类用于创建下面三个任意一个基类的实例，并将其返回至代码流。</li>\n</ul>\n<h3 id=\"代码实现\"><a href=\"#代码实现\" class=\"headerlink\" title=\"代码实现\"></a>代码实现</h3><p>工厂类Log_factory实现<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Log_factory</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getLog</span><span class=\"params\">($type = <span class=\"string\">'file'</span>, array $options)</span></span>&#123;</div><div class=\"line\">    $type = strtolower($type);</div><div class=\"line\"></div><div class=\"line\">    $class = <span class=\"string\">\"Log_\"</span>.unfirst($type);</div><div class=\"line\">    <span class=\"keyword\">require_once</span> str_replace(<span class=\"string\">'_'</span>, DIRECTORY_SEPARATOR, $class).<span class=\"string\">'.php'</span>;</div><div class=\"line\"></div><div class=\"line\">    $log = <span class=\"keyword\">new</span> $class($options);</div><div class=\"line\">    <span class=\"keyword\">switch</span>($type)&#123;</div><div class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">'file'</span>:</div><div class=\"line\">        $log-&gt;setPath($options[<span class=\"string\">'location'</span>]);</div><div class=\"line\">        <span class=\"keyword\">break</span>;</div><div class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">'mysql'</span>:</div><div class=\"line\">        $log-&gt;setUser($options[<span class=\"string\">'username'</span>]);</div><div class=\"line\">        $log-&gt;setPassword($options[<span class=\"string\">'password'</span>]);</div><div class=\"line\">        $log-&gt;setDBname($options[<span class=\"string\">'location'</span>]);</div><div class=\"line\">        <span class=\"keyword\">break</span>;</div><div class=\"line\">      <span class=\"keyword\">case</span> <span class=\"string\">'sqlite'</span>:</div><div class=\"line\">        $log-&gt;setDBPath($options[<span class=\"string\">'location'</span>]);</div><div class=\"line\">        <span class=\"keyword\">break</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\"></div><div class=\"line\">    <span class=\"keyword\">return</span> $log;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p><strong>Tips:</strong><br>在实际应用中，我们可以把getLog()方法生成的对象添加到Registry，这样就不用一遍又一遍的实例化这些对象。</p>"},{"title":"PHP安装","date":"2016-09-25T14:30:00.000Z","ctime":"2016-09-25T14:30:00.000Z","utime":"2016-09-25T14:30:00.000Z","modif_times":0,"_content":"\n![php](http://n.sinaimg.cn/games/3ece443e/20160925/php_log.png)\n\n<!-- more -->\n\n## 环境\n\nOS：CentOS 7.2 64\n\nPHP：[php-5.6.25](http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz)\n\n\n## 编译前准备\n```\nyum -y install libxml2 libxml2-devel\n```\nlibxml2,是个C语言的XML程式库，能简单方便的提供对XML文件的各种操作，并且支持XPATH查询，及部分的支持XSLT转换等功能。\n\n## 编译安装\n解压源码包\n```\ntar zxvf php-5.6.25.tar.gz\n```\n进入源码包目录\n```\ncd php-5.6.25\n```\n编译、安装\n```\n./configure --prefix=/usr/local/php56 --enable-fpm --with-mysql\nmake && make install\nInstalling shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\nInstalling PHP CLI binary:        /usr/local/php56/bin/\nInstalling PHP CLI man page:      /usr/local/php56/php/man/man1/\nInstalling PHP FPM binary:        /usr/local/php56/sbin/\nInstalling PHP FPM config:        /usr/local/php56/etc/\nInstalling PHP FPM man page:      /usr/local/php56/php/man/man8/\nInstalling PHP FPM status page:   /usr/local/php56/php/php/fpm/\nInstalling PHP CGI binary:        /usr/local/php56/bin/\nInstalling PHP CGI man page:      /usr/local/php56/php/man/man1/\nInstalling build environment:     /usr/local/php56/lib/php/build/\nInstalling header files:           /usr/local/php56/include/php/\nInstalling helper programs:       /usr/local/php56/bin/\n  program: phpize\n  program: php-config\nInstalling man pages:             /usr/local/php56/php/man/man1/\n  page: phpize.1\n  page: php-config.1\nInstalling PEAR environment:      /usr/local/php56/lib/php/\n[PEAR] Archive_Tar    - installed: 1.4.0\n[PEAR] Console_Getopt - installed: 1.4.1\n[PEAR] Structures_Graph- installed: 1.1.1\n[PEAR] XML_Util       - installed: 1.3.0\n[PEAR] PEAR           - installed: 1.10.1\nWrote PEAR system config file at: /usr/local/php56/etc/pear.conf\nYou may want to add: /usr/local/php56/lib/php to your php.ini include_path\n/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php56/bin\nln -s -f phar.phar /usr/local/php56/bin/phar\nInstalling PDO headers:           /usr/local/php56/include/php/ext/pdo/\n```\n生成配置文件\n```\ncp php.ini-development /usr/local/php56/lib/php.ini\ncp /usr/local/php56/etc/php-fpm.conf.default /usr/local/php56/etc/php-fpm.conf\n```\n\n查看配置文件是否已生效。\n```\n$ /usr/local/php56/bin/php -r \"phpinfo();\"\n如果看到以下输出，则表示配置文件加载成功。\nConfiguration File (php.ini) Path => /usr/local/php56/lib\nLoaded Configuration File => /usr/local/php56/lib/php.ini\n```\n\n将php加入到PATH中\n```\nvi ~/.bash_profile\n#在export PATH前一行插入\nPATH=$PATH:/usr/local/php56/bin:/usr/local/php56/lib\n```\n重新加载环境变量\n```\nsource /root/.bash_profile\n```\n\n## 测试\n```\n[root@iZwz97v8o84q253plfkxvfZ php56]# php -version\nPHP 5.6.25 (cli) (built: Sep 24 2016 23:30:43)\nCopyright (c) 1997-2016 The PHP Group\nZend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies\n```\n\n**Tips:**\n如何确定PHP当前使用的配置文件的位置？\n\nphp：\n```\n$ /usr/local/php56/bin/php -r \"phpinfo();\"\n如果看到以下输出，则表示配置文件加载成功。\nConfiguration File (php.ini) Path => /usr/local/php56/lib\nLoaded Configuration File => /usr/local/php56/lib/php.ini\n```\nphp-fpm:\n```\n/usr/local/php56/sbin/php-fpm -t\n[25-Sep-2016 18:01:40] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful\n```\nover~\n","source":"_posts/PHP安装.md","raw":"---\ntitle: PHP安装\ndate: 2016-09-25 22:30:00\nctime: 2016-09-25 22:30:00\nutime: 2016-09-25 22:30:00\nmodif_times: 0\ntags:\n- PHP-FPM\ncategories:\n- PHP\n---\n\n![php](http://n.sinaimg.cn/games/3ece443e/20160925/php_log.png)\n\n<!-- more -->\n\n## 环境\n\nOS：CentOS 7.2 64\n\nPHP：[php-5.6.25](http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz)\n\n\n## 编译前准备\n```\nyum -y install libxml2 libxml2-devel\n```\nlibxml2,是个C语言的XML程式库，能简单方便的提供对XML文件的各种操作，并且支持XPATH查询，及部分的支持XSLT转换等功能。\n\n## 编译安装\n解压源码包\n```\ntar zxvf php-5.6.25.tar.gz\n```\n进入源码包目录\n```\ncd php-5.6.25\n```\n编译、安装\n```\n./configure --prefix=/usr/local/php56 --enable-fpm --with-mysql\nmake && make install\nInstalling shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\nInstalling PHP CLI binary:        /usr/local/php56/bin/\nInstalling PHP CLI man page:      /usr/local/php56/php/man/man1/\nInstalling PHP FPM binary:        /usr/local/php56/sbin/\nInstalling PHP FPM config:        /usr/local/php56/etc/\nInstalling PHP FPM man page:      /usr/local/php56/php/man/man8/\nInstalling PHP FPM status page:   /usr/local/php56/php/php/fpm/\nInstalling PHP CGI binary:        /usr/local/php56/bin/\nInstalling PHP CGI man page:      /usr/local/php56/php/man/man1/\nInstalling build environment:     /usr/local/php56/lib/php/build/\nInstalling header files:           /usr/local/php56/include/php/\nInstalling helper programs:       /usr/local/php56/bin/\n  program: phpize\n  program: php-config\nInstalling man pages:             /usr/local/php56/php/man/man1/\n  page: phpize.1\n  page: php-config.1\nInstalling PEAR environment:      /usr/local/php56/lib/php/\n[PEAR] Archive_Tar    - installed: 1.4.0\n[PEAR] Console_Getopt - installed: 1.4.1\n[PEAR] Structures_Graph- installed: 1.1.1\n[PEAR] XML_Util       - installed: 1.3.0\n[PEAR] PEAR           - installed: 1.10.1\nWrote PEAR system config file at: /usr/local/php56/etc/pear.conf\nYou may want to add: /usr/local/php56/lib/php to your php.ini include_path\n/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php56/bin\nln -s -f phar.phar /usr/local/php56/bin/phar\nInstalling PDO headers:           /usr/local/php56/include/php/ext/pdo/\n```\n生成配置文件\n```\ncp php.ini-development /usr/local/php56/lib/php.ini\ncp /usr/local/php56/etc/php-fpm.conf.default /usr/local/php56/etc/php-fpm.conf\n```\n\n查看配置文件是否已生效。\n```\n$ /usr/local/php56/bin/php -r \"phpinfo();\"\n如果看到以下输出，则表示配置文件加载成功。\nConfiguration File (php.ini) Path => /usr/local/php56/lib\nLoaded Configuration File => /usr/local/php56/lib/php.ini\n```\n\n将php加入到PATH中\n```\nvi ~/.bash_profile\n#在export PATH前一行插入\nPATH=$PATH:/usr/local/php56/bin:/usr/local/php56/lib\n```\n重新加载环境变量\n```\nsource /root/.bash_profile\n```\n\n## 测试\n```\n[root@iZwz97v8o84q253plfkxvfZ php56]# php -version\nPHP 5.6.25 (cli) (built: Sep 24 2016 23:30:43)\nCopyright (c) 1997-2016 The PHP Group\nZend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies\n```\n\n**Tips:**\n如何确定PHP当前使用的配置文件的位置？\n\nphp：\n```\n$ /usr/local/php56/bin/php -r \"phpinfo();\"\n如果看到以下输出，则表示配置文件加载成功。\nConfiguration File (php.ini) Path => /usr/local/php56/lib\nLoaded Configuration File => /usr/local/php56/lib/php.ini\n```\nphp-fpm:\n```\n/usr/local/php56/sbin/php-fpm -t\n[25-Sep-2016 18:01:40] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful\n```\nover~\n","slug":"PHP安装","published":1,"updated":"2016-09-25T10:43:48.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwn002q699f7ksyelrm","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/php_log.png\" alt=\"php\"></p>\n<a id=\"more\"></a>\n<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>OS：CentOS 7.2 64</p>\n<p>PHP：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz\" target=\"_blank\" rel=\"external\">php-5.6.25</a></p>\n<h2 id=\"编译前准备\"><a href=\"#编译前准备\" class=\"headerlink\" title=\"编译前准备\"></a>编译前准备</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install libxml2 libxml2-devel</div></pre></td></tr></table></figure>\n<p>libxml2,是个C语言的XML程式库，能简单方便的提供对XML文件的各种操作，并且支持XPATH查询，及部分的支持XSLT转换等功能。</p>\n<h2 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h2><p>解压源码包<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar zxvf php-5.6.25.tar.gz</div></pre></td></tr></table></figure></p>\n<p>进入源码包目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd php-5.6.25</div></pre></td></tr></table></figure></p>\n<p>编译、安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/php56 --enable-fpm --with-mysql</div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">Installing PHP CLI binary:        /usr/local/php56/bin/</div><div class=\"line\">Installing PHP CLI man page:      /usr/local/php56/php/man/man1/</div><div class=\"line\">Installing PHP FPM binary:        /usr/local/php56/sbin/</div><div class=\"line\">Installing PHP FPM config:        /usr/local/php56/etc/</div><div class=\"line\">Installing PHP FPM man page:      /usr/local/php56/php/man/man8/</div><div class=\"line\">Installing PHP FPM status page:   /usr/local/php56/php/php/fpm/</div><div class=\"line\">Installing PHP CGI binary:        /usr/local/php56/bin/</div><div class=\"line\">Installing PHP CGI man page:      /usr/local/php56/php/man/man1/</div><div class=\"line\">Installing build environment:     /usr/local/php56/lib/php/build/</div><div class=\"line\">Installing header files:           /usr/local/php56/include/php/</div><div class=\"line\">Installing helper programs:       /usr/local/php56/bin/</div><div class=\"line\">  program: phpize</div><div class=\"line\">  program: php-config</div><div class=\"line\">Installing man pages:             /usr/local/php56/php/man/man1/</div><div class=\"line\">  page: phpize.1</div><div class=\"line\">  page: php-config.1</div><div class=\"line\">Installing PEAR environment:      /usr/local/php56/lib/php/</div><div class=\"line\">[PEAR] Archive_Tar    - installed: 1.4.0</div><div class=\"line\">[PEAR] Console_Getopt - installed: 1.4.1</div><div class=\"line\">[PEAR] Structures_Graph- installed: 1.1.1</div><div class=\"line\">[PEAR] XML_Util       - installed: 1.3.0</div><div class=\"line\">[PEAR] PEAR           - installed: 1.10.1</div><div class=\"line\">Wrote PEAR system config file at: /usr/local/php56/etc/pear.conf</div><div class=\"line\">You may want to add: /usr/local/php56/lib/php to your php.ini include_path</div><div class=\"line\">/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php56/bin</div><div class=\"line\">ln -s -f phar.phar /usr/local/php56/bin/phar</div><div class=\"line\">Installing PDO headers:           /usr/local/php56/include/php/ext/pdo/</div></pre></td></tr></table></figure></p>\n<p>生成配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp php.ini-development /usr/local/php56/lib/php.ini</div><div class=\"line\">cp /usr/local/php56/etc/php-fpm.conf.default /usr/local/php56/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>\n<p>查看配置文件是否已生效。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ /usr/local/php56/bin/php -r &quot;phpinfo();&quot;</div><div class=\"line\">如果看到以下输出，则表示配置文件加载成功。</div><div class=\"line\">Configuration File (php.ini) Path =&gt; /usr/local/php56/lib</div><div class=\"line\">Loaded Configuration File =&gt; /usr/local/php56/lib/php.ini</div></pre></td></tr></table></figure></p>\n<p>将php加入到PATH中<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ~/.bash_profile</div><div class=\"line\">#在export PATH前一行插入</div><div class=\"line\">PATH=$PATH:/usr/local/php56/bin:/usr/local/php56/lib</div></pre></td></tr></table></figure></p>\n<p>重新加载环境变量<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">source /root/.bash_profile</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZwz97v8o84q253plfkxvfZ php56]# php -version</div><div class=\"line\">PHP 5.6.25 (cli) (built: Sep 24 2016 23:30:43)</div><div class=\"line\">Copyright (c) 1997-2016 The PHP Group</div><div class=\"line\">Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies</div></pre></td></tr></table></figure>\n<p><strong>Tips:</strong><br>如何确定PHP当前使用的配置文件的位置？</p>\n<p>php：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ /usr/local/php56/bin/php -r &quot;phpinfo();&quot;</div><div class=\"line\">如果看到以下输出，则表示配置文件加载成功。</div><div class=\"line\">Configuration File (php.ini) Path =&gt; /usr/local/php56/lib</div><div class=\"line\">Loaded Configuration File =&gt; /usr/local/php56/lib/php.ini</div></pre></td></tr></table></figure></p>\n<p>php-fpm:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php56/sbin/php-fpm -t</div><div class=\"line\">[25-Sep-2016 18:01:40] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>over~</p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/php_log.png\" alt=\"php\"></p>","more":"<h2 id=\"环境\"><a href=\"#环境\" class=\"headerlink\" title=\"环境\"></a>环境</h2><p>OS：CentOS 7.2 64</p>\n<p>PHP：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/php-5.6.25.tar.gz\">php-5.6.25</a></p>\n<h2 id=\"编译前准备\"><a href=\"#编译前准备\" class=\"headerlink\" title=\"编译前准备\"></a>编译前准备</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install libxml2 libxml2-devel</div></pre></td></tr></table></figure>\n<p>libxml2,是个C语言的XML程式库，能简单方便的提供对XML文件的各种操作，并且支持XPATH查询，及部分的支持XSLT转换等功能。</p>\n<h2 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h2><p>解压源码包<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar zxvf php-5.6.25.tar.gz</div></pre></td></tr></table></figure></p>\n<p>进入源码包目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd php-5.6.25</div></pre></td></tr></table></figure></p>\n<p>编译、安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local/php56 --enable-fpm --with-mysql</div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">Installing PHP CLI binary:        /usr/local/php56/bin/</div><div class=\"line\">Installing PHP CLI man page:      /usr/local/php56/php/man/man1/</div><div class=\"line\">Installing PHP FPM binary:        /usr/local/php56/sbin/</div><div class=\"line\">Installing PHP FPM config:        /usr/local/php56/etc/</div><div class=\"line\">Installing PHP FPM man page:      /usr/local/php56/php/man/man8/</div><div class=\"line\">Installing PHP FPM status page:   /usr/local/php56/php/php/fpm/</div><div class=\"line\">Installing PHP CGI binary:        /usr/local/php56/bin/</div><div class=\"line\">Installing PHP CGI man page:      /usr/local/php56/php/man/man1/</div><div class=\"line\">Installing build environment:     /usr/local/php56/lib/php/build/</div><div class=\"line\">Installing header files:           /usr/local/php56/include/php/</div><div class=\"line\">Installing helper programs:       /usr/local/php56/bin/</div><div class=\"line\">  program: phpize</div><div class=\"line\">  program: php-config</div><div class=\"line\">Installing man pages:             /usr/local/php56/php/man/man1/</div><div class=\"line\">  page: phpize.1</div><div class=\"line\">  page: php-config.1</div><div class=\"line\">Installing PEAR environment:      /usr/local/php56/lib/php/</div><div class=\"line\">[PEAR] Archive_Tar    - installed: 1.4.0</div><div class=\"line\">[PEAR] Console_Getopt - installed: 1.4.1</div><div class=\"line\">[PEAR] Structures_Graph- installed: 1.1.1</div><div class=\"line\">[PEAR] XML_Util       - installed: 1.3.0</div><div class=\"line\">[PEAR] PEAR           - installed: 1.10.1</div><div class=\"line\">Wrote PEAR system config file at: /usr/local/php56/etc/pear.conf</div><div class=\"line\">You may want to add: /usr/local/php56/lib/php to your php.ini include_path</div><div class=\"line\">/root/php-5.6.25/build/shtool install -c ext/phar/phar.phar /usr/local/php56/bin</div><div class=\"line\">ln -s -f phar.phar /usr/local/php56/bin/phar</div><div class=\"line\">Installing PDO headers:           /usr/local/php56/include/php/ext/pdo/</div></pre></td></tr></table></figure></p>\n<p>生成配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">cp php.ini-development /usr/local/php56/lib/php.ini</div><div class=\"line\">cp /usr/local/php56/etc/php-fpm.conf.default /usr/local/php56/etc/php-fpm.conf</div></pre></td></tr></table></figure></p>\n<p>查看配置文件是否已生效。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ /usr/local/php56/bin/php -r &quot;phpinfo();&quot;</div><div class=\"line\">如果看到以下输出，则表示配置文件加载成功。</div><div class=\"line\">Configuration File (php.ini) Path =&gt; /usr/local/php56/lib</div><div class=\"line\">Loaded Configuration File =&gt; /usr/local/php56/lib/php.ini</div></pre></td></tr></table></figure></p>\n<p>将php加入到PATH中<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi ~/.bash_profile</div><div class=\"line\">#在export PATH前一行插入</div><div class=\"line\">PATH=$PATH:/usr/local/php56/bin:/usr/local/php56/lib</div></pre></td></tr></table></figure></p>\n<p>重新加载环境变量<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">source /root/.bash_profile</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@iZwz97v8o84q253plfkxvfZ php56]# php -version</div><div class=\"line\">PHP 5.6.25 (cli) (built: Sep 24 2016 23:30:43)</div><div class=\"line\">Copyright (c) 1997-2016 The PHP Group</div><div class=\"line\">Zend Engine v2.6.0, Copyright (c) 1998-2016 Zend Technologies</div></pre></td></tr></table></figure>\n<p><strong>Tips:</strong><br>如何确定PHP当前使用的配置文件的位置？</p>\n<p>php：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ /usr/local/php56/bin/php -r &quot;phpinfo();&quot;</div><div class=\"line\">如果看到以下输出，则表示配置文件加载成功。</div><div class=\"line\">Configuration File (php.ini) Path =&gt; /usr/local/php56/lib</div><div class=\"line\">Loaded Configuration File =&gt; /usr/local/php56/lib/php.ini</div></pre></td></tr></table></figure></p>\n<p>php-fpm:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php56/sbin/php-fpm -t</div><div class=\"line\">[25-Sep-2016 18:01:40] NOTICE: configuration file /usr/local/php56/etc/php-fpm.conf test is successful</div></pre></td></tr></table></figure></p>\n<p>over~</p>"},{"title":"instanceof运算符的运用","date":"2016-09-22T13:30:00.000Z","_content":"\n\n在PHP5中，通过方法传递变量的类型有不确定性。我们很难判断，一些操作是否可以运行。\n使用instanceof运算符，可以判断当前实例是否可以有这样的一个形态。当前实例使用 instanceof与当前类，父类（向上无限追溯），已经实现的接口比较时，返回真。\n\n代码格式：实例名 instanceof 类名\n\n<!-- more -->\n\n### instanceof 运算符的运用\n如下例子可以运行。\n\n没用instanceof运算符判断就会报错，示例代码如下：\n\n```\n<?php\n   class User{\n     private $name=\"zhenlw\";\n     public function  getName(){\n       return \"UserName is \".$this->name;\n     }\n  }\n  class NormalUser extends User {\n    private $age = 99;\n    public function getAge(){\n      return \"age is \".$this->age;\n    }\n  }\n  class UserAdmin{    //操作.\n    public static function  getUserInfo(User $user){\n      echo $user->getAge();\n    }\n  }\n  $User = new User();\n  UserAdmin::getUserInfo($User);\n?>\n```\n运行后报如下错误：\n```\nFatal error: Call to undefined method User::getAge() in D:\\xampp\\htdocs\\test\\8\\test.php on line 20\n```\n因为你传入的对象参数根本没有getAge方法，如果是NormalUser的对象的话就可以正常运行了，这个时候我们运用instanceof运算符来进行判断，修改后的示例代码如下：\n\n```\n<?php\n  class User{\n    private $name=\"zhenlw\";\n    public function  getName(){\n      return \"UserName is \".$this->name;\n    }\n  }\n  class NormalUser extends User {\n    private $age = 99;\n    public function getAge(){\n      return \"age is \".$this->age;\n    }\n  }\n  class UserAdmin{  //操作.\n    public static function  getUserInfo(User $user){\n      if($user instanceof NormalUser){\n        echo $user->getAge();\n      } elseif($user instanceof User){\n        echo $user->getName();\n      }\n    }\n  }\n  $User = new User(); // 这里是User的对象.\n  UserAdmin::getUserInfo($User);\n  echo \"<br>\";\n  $normaluser = new NormalUser(); // 这里是NormalUser的对象.\n  UserAdmin::getUserInfo($normaluser);\n?>\n```\n运行结果：\n```\nUserName is zhenlw\nage is 99\n```\n看到运行结果就知道了吧，运用instanceof判断数据类型后就可以保证代码的健壮性，不论你传入的是哪个对象，都可以正确的对此对象进行处理。\n\n\n转自：http://blog.sina.com.cn/s/blog_4ce69a220100ksds.html\n","source":"_posts/PHP中InstanceOf运算符.md","raw":"---\ntitle: instanceof运算符的运用\ndate: 2016-09-22 21:30:00\ncategories:\n- PHP\n---\n\n\n在PHP5中，通过方法传递变量的类型有不确定性。我们很难判断，一些操作是否可以运行。\n使用instanceof运算符，可以判断当前实例是否可以有这样的一个形态。当前实例使用 instanceof与当前类，父类（向上无限追溯），已经实现的接口比较时，返回真。\n\n代码格式：实例名 instanceof 类名\n\n<!-- more -->\n\n### instanceof 运算符的运用\n如下例子可以运行。\n\n没用instanceof运算符判断就会报错，示例代码如下：\n\n```\n<?php\n   class User{\n     private $name=\"zhenlw\";\n     public function  getName(){\n       return \"UserName is \".$this->name;\n     }\n  }\n  class NormalUser extends User {\n    private $age = 99;\n    public function getAge(){\n      return \"age is \".$this->age;\n    }\n  }\n  class UserAdmin{    //操作.\n    public static function  getUserInfo(User $user){\n      echo $user->getAge();\n    }\n  }\n  $User = new User();\n  UserAdmin::getUserInfo($User);\n?>\n```\n运行后报如下错误：\n```\nFatal error: Call to undefined method User::getAge() in D:\\xampp\\htdocs\\test\\8\\test.php on line 20\n```\n因为你传入的对象参数根本没有getAge方法，如果是NormalUser的对象的话就可以正常运行了，这个时候我们运用instanceof运算符来进行判断，修改后的示例代码如下：\n\n```\n<?php\n  class User{\n    private $name=\"zhenlw\";\n    public function  getName(){\n      return \"UserName is \".$this->name;\n    }\n  }\n  class NormalUser extends User {\n    private $age = 99;\n    public function getAge(){\n      return \"age is \".$this->age;\n    }\n  }\n  class UserAdmin{  //操作.\n    public static function  getUserInfo(User $user){\n      if($user instanceof NormalUser){\n        echo $user->getAge();\n      } elseif($user instanceof User){\n        echo $user->getName();\n      }\n    }\n  }\n  $User = new User(); // 这里是User的对象.\n  UserAdmin::getUserInfo($User);\n  echo \"<br>\";\n  $normaluser = new NormalUser(); // 这里是NormalUser的对象.\n  UserAdmin::getUserInfo($normaluser);\n?>\n```\n运行结果：\n```\nUserName is zhenlw\nage is 99\n```\n看到运行结果就知道了吧，运用instanceof判断数据类型后就可以保证代码的健壮性，不论你传入的是哪个对象，都可以正确的对此对象进行处理。\n\n\n转自：http://blog.sina.com.cn/s/blog_4ce69a220100ksds.html\n","slug":"PHP中InstanceOf运算符","published":1,"updated":"2016-10-08T15:27:21.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwp002u699f42f3wevw","content":"<p>在PHP5中，通过方法传递变量的类型有不确定性。我们很难判断，一些操作是否可以运行。<br>使用instanceof运算符，可以判断当前实例是否可以有这样的一个形态。当前实例使用 instanceof与当前类，父类（向上无限追溯），已经实现的接口比较时，返回真。</p>\n<p>代码格式：实例名 instanceof 类名</p>\n<a id=\"more\"></a>\n<h3 id=\"instanceof-运算符的运用\"><a href=\"#instanceof-运算符的运用\" class=\"headerlink\" title=\"instanceof 运算符的运用\"></a>instanceof 运算符的运用</h3><p>如下例子可以运行。</p>\n<p>没用instanceof运算符判断就会报错，示例代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">   class User&#123;</div><div class=\"line\">     private $name=&quot;zhenlw&quot;;</div><div class=\"line\">     public function  getName()&#123;</div><div class=\"line\">       return &quot;UserName is &quot;.$this-&gt;name;</div><div class=\"line\">     &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class NormalUser extends User &#123;</div><div class=\"line\">    private $age = 99;</div><div class=\"line\">    public function getAge()&#123;</div><div class=\"line\">      return &quot;age is &quot;.$this-&gt;age;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class UserAdmin&#123;    //操作.</div><div class=\"line\">    public static function  getUserInfo(User $user)&#123;</div><div class=\"line\">      echo $user-&gt;getAge();</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  $User = new User();</div><div class=\"line\">  UserAdmin::getUserInfo($User);</div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure>\n<p>运行后报如下错误：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Fatal error: Call to undefined method User::getAge() in D:\\xampp\\htdocs\\test\\8\\test.php on line 20</div></pre></td></tr></table></figure></p>\n<p>因为你传入的对象参数根本没有getAge方法，如果是NormalUser的对象的话就可以正常运行了，这个时候我们运用instanceof运算符来进行判断，修改后的示例代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">  class User&#123;</div><div class=\"line\">    private $name=&quot;zhenlw&quot;;</div><div class=\"line\">    public function  getName()&#123;</div><div class=\"line\">      return &quot;UserName is &quot;.$this-&gt;name;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class NormalUser extends User &#123;</div><div class=\"line\">    private $age = 99;</div><div class=\"line\">    public function getAge()&#123;</div><div class=\"line\">      return &quot;age is &quot;.$this-&gt;age;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class UserAdmin&#123;  //操作.</div><div class=\"line\">    public static function  getUserInfo(User $user)&#123;</div><div class=\"line\">      if($user instanceof NormalUser)&#123;</div><div class=\"line\">        echo $user-&gt;getAge();</div><div class=\"line\">      &#125; elseif($user instanceof User)&#123;</div><div class=\"line\">        echo $user-&gt;getName();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  $User = new User(); // 这里是User的对象.</div><div class=\"line\">  UserAdmin::getUserInfo($User);</div><div class=\"line\">  echo &quot;&lt;br&gt;&quot;;</div><div class=\"line\">  $normaluser = new NormalUser(); // 这里是NormalUser的对象.</div><div class=\"line\">  UserAdmin::getUserInfo($normaluser);</div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure>\n<p>运行结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">UserName is zhenlw</div><div class=\"line\">age is 99</div></pre></td></tr></table></figure></p>\n<p>看到运行结果就知道了吧，运用instanceof判断数据类型后就可以保证代码的健壮性，不论你传入的是哪个对象，都可以正确的对此对象进行处理。</p>\n<p>转自：<a href=\"http://blog.sina.com.cn/s/blog_4ce69a220100ksds.html\" target=\"_blank\" rel=\"external\">http://blog.sina.com.cn/s/blog_4ce69a220100ksds.html</a></p>\n","excerpt":"<p>在PHP5中，通过方法传递变量的类型有不确定性。我们很难判断，一些操作是否可以运行。<br>使用instanceof运算符，可以判断当前实例是否可以有这样的一个形态。当前实例使用 instanceof与当前类，父类（向上无限追溯），已经实现的接口比较时，返回真。</p>\n<p>代码格式：实例名 instanceof 类名</p>","more":"<h3 id=\"instanceof-运算符的运用\"><a href=\"#instanceof-运算符的运用\" class=\"headerlink\" title=\"instanceof 运算符的运用\"></a>instanceof 运算符的运用</h3><p>如下例子可以运行。</p>\n<p>没用instanceof运算符判断就会报错，示例代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">   class User&#123;</div><div class=\"line\">     private $name=&quot;zhenlw&quot;;</div><div class=\"line\">     public function  getName()&#123;</div><div class=\"line\">       return &quot;UserName is &quot;.$this-&gt;name;</div><div class=\"line\">     &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class NormalUser extends User &#123;</div><div class=\"line\">    private $age = 99;</div><div class=\"line\">    public function getAge()&#123;</div><div class=\"line\">      return &quot;age is &quot;.$this-&gt;age;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class UserAdmin&#123;    //操作.</div><div class=\"line\">    public static function  getUserInfo(User $user)&#123;</div><div class=\"line\">      echo $user-&gt;getAge();</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  $User = new User();</div><div class=\"line\">  UserAdmin::getUserInfo($User);</div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure>\n<p>运行后报如下错误：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Fatal error: Call to undefined method User::getAge() in D:\\xampp\\htdocs\\test\\8\\test.php on line 20</div></pre></td></tr></table></figure></p>\n<p>因为你传入的对象参数根本没有getAge方法，如果是NormalUser的对象的话就可以正常运行了，这个时候我们运用instanceof运算符来进行判断，修改后的示例代码如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">  class User&#123;</div><div class=\"line\">    private $name=&quot;zhenlw&quot;;</div><div class=\"line\">    public function  getName()&#123;</div><div class=\"line\">      return &quot;UserName is &quot;.$this-&gt;name;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class NormalUser extends User &#123;</div><div class=\"line\">    private $age = 99;</div><div class=\"line\">    public function getAge()&#123;</div><div class=\"line\">      return &quot;age is &quot;.$this-&gt;age;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  class UserAdmin&#123;  //操作.</div><div class=\"line\">    public static function  getUserInfo(User $user)&#123;</div><div class=\"line\">      if($user instanceof NormalUser)&#123;</div><div class=\"line\">        echo $user-&gt;getAge();</div><div class=\"line\">      &#125; elseif($user instanceof User)&#123;</div><div class=\"line\">        echo $user-&gt;getName();</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div><div class=\"line\">  $User = new User(); // 这里是User的对象.</div><div class=\"line\">  UserAdmin::getUserInfo($User);</div><div class=\"line\">  echo &quot;&lt;br&gt;&quot;;</div><div class=\"line\">  $normaluser = new NormalUser(); // 这里是NormalUser的对象.</div><div class=\"line\">  UserAdmin::getUserInfo($normaluser);</div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure>\n<p>运行结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">UserName is zhenlw</div><div class=\"line\">age is 99</div></pre></td></tr></table></figure></p>\n<p>看到运行结果就知道了吧，运用instanceof判断数据类型后就可以保证代码的健壮性，不论你传入的是哪个对象，都可以正确的对此对象进行处理。</p>\n<p>转自：<a href=\"http://blog.sina.com.cn/s/blog_4ce69a220100ksds.html\">http://blog.sina.com.cn/s/blog_4ce69a220100ksds.html</a></p>"},{"title":"PHP常见设计模式之注册表模式","date":"2016-10-14T12:40:00.000Z","_content":"\n## 什么是注册表模式\n注册表（registry）模式仅是一个单独的全局类，在我们需要时允许代码检索一个对象的相同实例，也可以在我们需要的时候创建另一个实例。\n\n注册表就像是一个对象库，只要我们随时签入或者签出对象，而不必担心因为将这些对象保留太久而引起功能障碍。\n\n我们认为注册表模式中最简单的方式就是键/值存储，键作为一个对象的实例，而值就是实例本身。当我们需要管理键/值对的数组时，这个模式便开始发挥功效，存储最早实例化的实例，并且返回一个引用到请求中的同一个实例。\n\n## 注册表模式和单例模式的关系\n相同点：\n> 和单例模式一样，注册表模式也是用于访问全局可重用的对象；\n\n区别：\n> 注册表模式不负责创建对象，纯粹用于保持全局存储，可以容纳任何数量的相同类的实例。这使得它非常适合类似于数据库连接和配置对象等的采用单例模式满足不了其需求的情况。\n\n<!-- more -->\n\n## 注册表模式的实现\n示例，\n```php\n<?php\nclass Registry{\n\n  private static $_store = array();\n\n  public static function add($object, $name = null){\n    $name = (!is_null($name)) ? $name : get_class($object);\n    $name = strtolower($name);\n\n    $return = null;\n    if(isset(self::$_store[$name])){\n      $return = self::$_store[$name];\n    } else{\n      self::$_store[$name] = $object;\n      $return = self::$_store[$name];\n    }\n    return $return;\n  }\n\n  public static function get($name){\n    if(!self::contains($name)){\n      throw new Exception(\"object does not exist in registry\");\n    }\n    return self::$_store[$name];\n  }\n\n  public static function contains($name){\n    if(!isset(self::$_store[$name])){\n      return false;\n    }\n    return true;\n  }\n\n  public static function remove($name){\n    if(self::contains($name)){\n      unset(self::$_store[$name]);\n    }\n  }  \n}\n```\n\n注册表模式的4个实现方法：\n- Registry::set(),添加一个对象到注册表，你可以指定一个名称（为多个实例）或者使用默认的类名（为单例，与行为类似）\n- Registry::get(),从注册表的名字中检索一个对象\n- Registry::contains(),在注册表中检查一个对象是否存在\n- Registry::unset(),通过对象名在注册表中删除一个对象\n\n\n## 注册表模式的应用\n创建了Registry类之后，我们可以通过两种方式来使用它。\n- 外部\n- 内部\n\n\n示例，两种方式的数据库连接代码。\n\n### 外部\n```php\n<?php\n  $read = new DBReadConnection();\n  Registry::add($read);\n\n  $write = new DBWriteConnection();\n  Registry::add($wite);\n\n  //在之后的任何代码中，我们可以通过以下方式获得对应实例\n  $read = Registry::get('DBReadConnection');\n  $write = Registry::get('DBWriteConnection');\n```\n\n在这个示例中，我们没有传入实例名称，而是通过使用类名从注册表中提取对象。\n在Registry类能访问到的任何地方该对象都可用。\n\n### 内部\n```php\n<?php\nabstract class DBConnection extend PDO{\n  public statuc function getInstance($name = null){\n    $class = get_called_class();\n\n    $name = (!is_null($name)) ? $name : $class;\n    $name = strtolower($name);\n    if(!Registry::contains($name)){\n      $instance = new $class();\n      Registry::add($instance, $name);\n    }\n    return Registry::get($name);\n  }\n}\n\nclass DBWriteConnection extend DBConnection{\n  public function __contruct(){\n    parent::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);\n  }\n}\n\nclass DBReadConnection extend DBConnection{\n  public function __contruct(){\n    parent::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);\n  }\n}\n```\n要使用这些代码，我们只需在任一读或者写连接类中调用DBConnection::getInstance()即可，就像\n```php\n<?php\n  //获得一个读实例\n  $read_db = DBReadConnection::getInstance();\n  //获得一个写实例\n  $write_db  = DBWriteConnection::getInstance();\n\n  //获得另一个读实例\n  $another_read_db = DBReadConnection::getInstance(\"another_db\");\n```\n在某些方面，这是一个单例模式和工厂模式的混合物。\n\n## 注册的若干问题\n对于外部注册表，你不能延迟加载；也就是说，在我们使用之前，必须初始化注册表中的每一个对象。如果操作顺序变得更为复杂，我们可能就会错过某个对象而产生预料之外的错误。\n","source":"_posts/PHP常见设计模式之注册表模式.md","raw":"---\ntitle: PHP常见设计模式之注册表模式\ndate: 2016-10-14 20:40:00\ntags:\n- 设计模式\n- 注册表模式\ncategories:\n- PHP\n---\n\n## 什么是注册表模式\n注册表（registry）模式仅是一个单独的全局类，在我们需要时允许代码检索一个对象的相同实例，也可以在我们需要的时候创建另一个实例。\n\n注册表就像是一个对象库，只要我们随时签入或者签出对象，而不必担心因为将这些对象保留太久而引起功能障碍。\n\n我们认为注册表模式中最简单的方式就是键/值存储，键作为一个对象的实例，而值就是实例本身。当我们需要管理键/值对的数组时，这个模式便开始发挥功效，存储最早实例化的实例，并且返回一个引用到请求中的同一个实例。\n\n## 注册表模式和单例模式的关系\n相同点：\n> 和单例模式一样，注册表模式也是用于访问全局可重用的对象；\n\n区别：\n> 注册表模式不负责创建对象，纯粹用于保持全局存储，可以容纳任何数量的相同类的实例。这使得它非常适合类似于数据库连接和配置对象等的采用单例模式满足不了其需求的情况。\n\n<!-- more -->\n\n## 注册表模式的实现\n示例，\n```php\n<?php\nclass Registry{\n\n  private static $_store = array();\n\n  public static function add($object, $name = null){\n    $name = (!is_null($name)) ? $name : get_class($object);\n    $name = strtolower($name);\n\n    $return = null;\n    if(isset(self::$_store[$name])){\n      $return = self::$_store[$name];\n    } else{\n      self::$_store[$name] = $object;\n      $return = self::$_store[$name];\n    }\n    return $return;\n  }\n\n  public static function get($name){\n    if(!self::contains($name)){\n      throw new Exception(\"object does not exist in registry\");\n    }\n    return self::$_store[$name];\n  }\n\n  public static function contains($name){\n    if(!isset(self::$_store[$name])){\n      return false;\n    }\n    return true;\n  }\n\n  public static function remove($name){\n    if(self::contains($name)){\n      unset(self::$_store[$name]);\n    }\n  }  \n}\n```\n\n注册表模式的4个实现方法：\n- Registry::set(),添加一个对象到注册表，你可以指定一个名称（为多个实例）或者使用默认的类名（为单例，与行为类似）\n- Registry::get(),从注册表的名字中检索一个对象\n- Registry::contains(),在注册表中检查一个对象是否存在\n- Registry::unset(),通过对象名在注册表中删除一个对象\n\n\n## 注册表模式的应用\n创建了Registry类之后，我们可以通过两种方式来使用它。\n- 外部\n- 内部\n\n\n示例，两种方式的数据库连接代码。\n\n### 外部\n```php\n<?php\n  $read = new DBReadConnection();\n  Registry::add($read);\n\n  $write = new DBWriteConnection();\n  Registry::add($wite);\n\n  //在之后的任何代码中，我们可以通过以下方式获得对应实例\n  $read = Registry::get('DBReadConnection');\n  $write = Registry::get('DBWriteConnection');\n```\n\n在这个示例中，我们没有传入实例名称，而是通过使用类名从注册表中提取对象。\n在Registry类能访问到的任何地方该对象都可用。\n\n### 内部\n```php\n<?php\nabstract class DBConnection extend PDO{\n  public statuc function getInstance($name = null){\n    $class = get_called_class();\n\n    $name = (!is_null($name)) ? $name : $class;\n    $name = strtolower($name);\n    if(!Registry::contains($name)){\n      $instance = new $class();\n      Registry::add($instance, $name);\n    }\n    return Registry::get($name);\n  }\n}\n\nclass DBWriteConnection extend DBConnection{\n  public function __contruct(){\n    parent::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);\n  }\n}\n\nclass DBReadConnection extend DBConnection{\n  public function __contruct(){\n    parent::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);\n  }\n}\n```\n要使用这些代码，我们只需在任一读或者写连接类中调用DBConnection::getInstance()即可，就像\n```php\n<?php\n  //获得一个读实例\n  $read_db = DBReadConnection::getInstance();\n  //获得一个写实例\n  $write_db  = DBWriteConnection::getInstance();\n\n  //获得另一个读实例\n  $another_read_db = DBReadConnection::getInstance(\"another_db\");\n```\n在某些方面，这是一个单例模式和工厂模式的混合物。\n\n## 注册的若干问题\n对于外部注册表，你不能延迟加载；也就是说，在我们使用之前，必须初始化注册表中的每一个对象。如果操作顺序变得更为复杂，我们可能就会错过某个对象而产生预料之外的错误。\n","slug":"PHP常见设计模式之注册表模式","published":1,"updated":"2016-10-14T08:03:27.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwq002x699fudwdv3mw","content":"<h2 id=\"什么是注册表模式\"><a href=\"#什么是注册表模式\" class=\"headerlink\" title=\"什么是注册表模式\"></a>什么是注册表模式</h2><p>注册表（registry）模式仅是一个单独的全局类，在我们需要时允许代码检索一个对象的相同实例，也可以在我们需要的时候创建另一个实例。</p>\n<p>注册表就像是一个对象库，只要我们随时签入或者签出对象，而不必担心因为将这些对象保留太久而引起功能障碍。</p>\n<p>我们认为注册表模式中最简单的方式就是键/值存储，键作为一个对象的实例，而值就是实例本身。当我们需要管理键/值对的数组时，这个模式便开始发挥功效，存储最早实例化的实例，并且返回一个引用到请求中的同一个实例。</p>\n<h2 id=\"注册表模式和单例模式的关系\"><a href=\"#注册表模式和单例模式的关系\" class=\"headerlink\" title=\"注册表模式和单例模式的关系\"></a>注册表模式和单例模式的关系</h2><p>相同点：</p>\n<blockquote>\n<p>和单例模式一样，注册表模式也是用于访问全局可重用的对象；</p>\n</blockquote>\n<p>区别：</p>\n<blockquote>\n<p>注册表模式不负责创建对象，纯粹用于保持全局存储，可以容纳任何数量的相同类的实例。这使得它非常适合类似于数据库连接和配置对象等的采用单例模式满足不了其需求的情况。</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"注册表模式的实现\"><a href=\"#注册表模式的实现\" class=\"headerlink\" title=\"注册表模式的实现\"></a>注册表模式的实现</h2><p>示例，<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Registry</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_store = <span class=\"keyword\">array</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span><span class=\"params\">($object, $name = null)</span></span>&#123;</div><div class=\"line\">    $name = (!is_null($name)) ? $name : get_class($object);</div><div class=\"line\">    $name = strtolower($name);</div><div class=\"line\"></div><div class=\"line\">    $return = <span class=\"keyword\">null</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">self</span>::$_store[$name]))&#123;</div><div class=\"line\">      $return = <span class=\"keyword\">self</span>::$_store[$name];</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span>&#123;</div><div class=\"line\">      <span class=\"keyword\">self</span>::$_store[$name] = $object;</div><div class=\"line\">      $return = <span class=\"keyword\">self</span>::$_store[$name];</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> $return;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get</span><span class=\"params\">($name)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">self</span>::contains($name))&#123;</div><div class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">\"object does not exist in registry\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_store[$name];</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">contains</span><span class=\"params\">($name)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>(<span class=\"keyword\">self</span>::$_store[$name]))&#123;</div><div class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">remove</span><span class=\"params\">($name)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">self</span>::contains($name))&#123;</div><div class=\"line\">      <span class=\"keyword\">unset</span>(<span class=\"keyword\">self</span>::$_store[$name]);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;  </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>注册表模式的4个实现方法：</p>\n<ul>\n<li>Registry::set(),添加一个对象到注册表，你可以指定一个名称（为多个实例）或者使用默认的类名（为单例，与行为类似）</li>\n<li>Registry::get(),从注册表的名字中检索一个对象</li>\n<li>Registry::contains(),在注册表中检查一个对象是否存在</li>\n<li>Registry::unset(),通过对象名在注册表中删除一个对象</li>\n</ul>\n<h2 id=\"注册表模式的应用\"><a href=\"#注册表模式的应用\" class=\"headerlink\" title=\"注册表模式的应用\"></a>注册表模式的应用</h2><p>创建了Registry类之后，我们可以通过两种方式来使用它。</p>\n<ul>\n<li>外部</li>\n<li>内部</li>\n</ul>\n<p>示例，两种方式的数据库连接代码。</p>\n<h3 id=\"外部\"><a href=\"#外部\" class=\"headerlink\" title=\"外部\"></a>外部</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  $read = <span class=\"keyword\">new</span> DBReadConnection();</div><div class=\"line\">  Registry::add($read);</div><div class=\"line\"></div><div class=\"line\">  $write = <span class=\"keyword\">new</span> DBWriteConnection();</div><div class=\"line\">  Registry::add($wite);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//在之后的任何代码中，我们可以通过以下方式获得对应实例</span></div><div class=\"line\">  $read = Registry::get(<span class=\"string\">'DBReadConnection'</span>);</div><div class=\"line\">  $write = Registry::get(<span class=\"string\">'DBWriteConnection'</span>);</div></pre></td></tr></table></figure>\n<p>在这个示例中，我们没有传入实例名称，而是通过使用类名从注册表中提取对象。<br>在Registry类能访问到的任何地方该对象都可用。</p>\n<h3 id=\"内部\"><a href=\"#内部\" class=\"headerlink\" title=\"内部\"></a>内部</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DBConnection</span> <span class=\"title\">extend</span> <span class=\"title\">PDO</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">public</span> statuc <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">($name = null)</span></span>&#123;</div><div class=\"line\">    $class = get_called_class();</div><div class=\"line\"></div><div class=\"line\">    $name = (!is_null($name)) ? $name : $class;</div><div class=\"line\">    $name = strtolower($name);</div><div class=\"line\">    <span class=\"keyword\">if</span>(!Registry::contains($name))&#123;</div><div class=\"line\">      $instance = <span class=\"keyword\">new</span> $class();</div><div class=\"line\">      Registry::add($instance, $name);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> Registry::get($name);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DBWriteConnection</span> <span class=\"title\">extend</span> <span class=\"title\">DBConnection</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__contruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">parent</span>::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DBReadConnection</span> <span class=\"title\">extend</span> <span class=\"title\">DBConnection</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__contruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">parent</span>::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>要使用这些代码，我们只需在任一读或者写连接类中调用DBConnection::getInstance()即可，就像<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"comment\">//获得一个读实例</span></div><div class=\"line\">  $read_db = DBReadConnection::getInstance();</div><div class=\"line\">  <span class=\"comment\">//获得一个写实例</span></div><div class=\"line\">  $write_db  = DBWriteConnection::getInstance();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//获得另一个读实例</span></div><div class=\"line\">  $another_read_db = DBReadConnection::getInstance(<span class=\"string\">\"another_db\"</span>);</div></pre></td></tr></table></figure></p>\n<p>在某些方面，这是一个单例模式和工厂模式的混合物。</p>\n<h2 id=\"注册的若干问题\"><a href=\"#注册的若干问题\" class=\"headerlink\" title=\"注册的若干问题\"></a>注册的若干问题</h2><p>对于外部注册表，你不能延迟加载；也就是说，在我们使用之前，必须初始化注册表中的每一个对象。如果操作顺序变得更为复杂，我们可能就会错过某个对象而产生预料之外的错误。</p>\n","excerpt":"<h2 id=\"什么是注册表模式\"><a href=\"#什么是注册表模式\" class=\"headerlink\" title=\"什么是注册表模式\"></a>什么是注册表模式</h2><p>注册表（registry）模式仅是一个单独的全局类，在我们需要时允许代码检索一个对象的相同实例，也可以在我们需要的时候创建另一个实例。</p>\n<p>注册表就像是一个对象库，只要我们随时签入或者签出对象，而不必担心因为将这些对象保留太久而引起功能障碍。</p>\n<p>我们认为注册表模式中最简单的方式就是键/值存储，键作为一个对象的实例，而值就是实例本身。当我们需要管理键/值对的数组时，这个模式便开始发挥功效，存储最早实例化的实例，并且返回一个引用到请求中的同一个实例。</p>\n<h2 id=\"注册表模式和单例模式的关系\"><a href=\"#注册表模式和单例模式的关系\" class=\"headerlink\" title=\"注册表模式和单例模式的关系\"></a>注册表模式和单例模式的关系</h2><p>相同点：</p>\n<blockquote>\n<p>和单例模式一样，注册表模式也是用于访问全局可重用的对象；</p>\n</blockquote>\n<p>区别：</p>\n<blockquote>\n<p>注册表模式不负责创建对象，纯粹用于保持全局存储，可以容纳任何数量的相同类的实例。这使得它非常适合类似于数据库连接和配置对象等的采用单例模式满足不了其需求的情况。</p>\n</blockquote>","more":"<h2 id=\"注册表模式的实现\"><a href=\"#注册表模式的实现\" class=\"headerlink\" title=\"注册表模式的实现\"></a>注册表模式的实现</h2><p>示例，<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Registry</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> $_store = <span class=\"keyword\">array</span>();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span><span class=\"params\">($object, $name = null)</span></span>&#123;</div><div class=\"line\">    $name = (!is_null($name)) ? $name : get_class($object);</div><div class=\"line\">    $name = strtolower($name);</div><div class=\"line\"></div><div class=\"line\">    $return = <span class=\"keyword\">null</span>;</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"keyword\">self</span>::$_store[$name]))&#123;</div><div class=\"line\">      $return = <span class=\"keyword\">self</span>::$_store[$name];</div><div class=\"line\">    &#125; <span class=\"keyword\">else</span>&#123;</div><div class=\"line\">      <span class=\"keyword\">self</span>::$_store[$name] = $object;</div><div class=\"line\">      $return = <span class=\"keyword\">self</span>::$_store[$name];</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> $return;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get</span><span class=\"params\">($name)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">self</span>::contains($name))&#123;</div><div class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">\"object does not exist in registry\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$_store[$name];</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">contains</span><span class=\"params\">($name)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(!<span class=\"keyword\">isset</span>(<span class=\"keyword\">self</span>::$_store[$name]))&#123;</div><div class=\"line\">      <span class=\"keyword\">return</span> <span class=\"keyword\">false</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">true</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">remove</span><span class=\"params\">($name)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">self</span>::contains($name))&#123;</div><div class=\"line\">      <span class=\"keyword\">unset</span>(<span class=\"keyword\">self</span>::$_store[$name]);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;  </div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>注册表模式的4个实现方法：</p>\n<ul>\n<li>Registry::set(),添加一个对象到注册表，你可以指定一个名称（为多个实例）或者使用默认的类名（为单例，与行为类似）</li>\n<li>Registry::get(),从注册表的名字中检索一个对象</li>\n<li>Registry::contains(),在注册表中检查一个对象是否存在</li>\n<li>Registry::unset(),通过对象名在注册表中删除一个对象</li>\n</ul>\n<h2 id=\"注册表模式的应用\"><a href=\"#注册表模式的应用\" class=\"headerlink\" title=\"注册表模式的应用\"></a>注册表模式的应用</h2><p>创建了Registry类之后，我们可以通过两种方式来使用它。</p>\n<ul>\n<li>外部</li>\n<li>内部</li>\n</ul>\n<p>示例，两种方式的数据库连接代码。</p>\n<h3 id=\"外部\"><a href=\"#外部\" class=\"headerlink\" title=\"外部\"></a>外部</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  $read = <span class=\"keyword\">new</span> DBReadConnection();</div><div class=\"line\">  Registry::add($read);</div><div class=\"line\"></div><div class=\"line\">  $write = <span class=\"keyword\">new</span> DBWriteConnection();</div><div class=\"line\">  Registry::add($wite);</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//在之后的任何代码中，我们可以通过以下方式获得对应实例</span></div><div class=\"line\">  $read = Registry::get(<span class=\"string\">'DBReadConnection'</span>);</div><div class=\"line\">  $write = Registry::get(<span class=\"string\">'DBWriteConnection'</span>);</div></pre></td></tr></table></figure>\n<p>在这个示例中，我们没有传入实例名称，而是通过使用类名从注册表中提取对象。<br>在Registry类能访问到的任何地方该对象都可用。</p>\n<h3 id=\"内部\"><a href=\"#内部\" class=\"headerlink\" title=\"内部\"></a>内部</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DBConnection</span> <span class=\"title\">extend</span> <span class=\"title\">PDO</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">public</span> statuc <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getInstance</span><span class=\"params\">($name = null)</span></span>&#123;</div><div class=\"line\">    $class = get_called_class();</div><div class=\"line\"></div><div class=\"line\">    $name = (!is_null($name)) ? $name : $class;</div><div class=\"line\">    $name = strtolower($name);</div><div class=\"line\">    <span class=\"keyword\">if</span>(!Registry::contains($name))&#123;</div><div class=\"line\">      $instance = <span class=\"keyword\">new</span> $class();</div><div class=\"line\">      Registry::add($instance, $name);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> Registry::get($name);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DBWriteConnection</span> <span class=\"title\">extend</span> <span class=\"title\">DBConnection</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__contruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">parent</span>::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div><div class=\"line\"></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">DBReadConnection</span> <span class=\"title\">extend</span> <span class=\"title\">DBConnection</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__contruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">parent</span>::_contruct(APP_DB_DSN, APP_DB_USER, APP_DB_PWD);</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>要使用这些代码，我们只需在任一读或者写连接类中调用DBConnection::getInstance()即可，就像<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"comment\">//获得一个读实例</span></div><div class=\"line\">  $read_db = DBReadConnection::getInstance();</div><div class=\"line\">  <span class=\"comment\">//获得一个写实例</span></div><div class=\"line\">  $write_db  = DBWriteConnection::getInstance();</div><div class=\"line\"></div><div class=\"line\">  <span class=\"comment\">//获得另一个读实例</span></div><div class=\"line\">  $another_read_db = DBReadConnection::getInstance(<span class=\"string\">\"another_db\"</span>);</div></pre></td></tr></table></figure></p>\n<p>在某些方面，这是一个单例模式和工厂模式的混合物。</p>\n<h2 id=\"注册的若干问题\"><a href=\"#注册的若干问题\" class=\"headerlink\" title=\"注册的若干问题\"></a>注册的若干问题</h2><p>对于外部注册表，你不能延迟加载；也就是说，在我们使用之前，必须初始化注册表中的每一个对象。如果操作顺序变得更为复杂，我们可能就会错过某个对象而产生预料之外的错误。</p>"},{"title":"PHP扩展与应用库(PEAR)","date":"2016-10-12T12:30:00.000Z","_content":"\nPEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。\n\n官网：\n\nhttp://pear.php.net\n\n<!-- more -->\n\n## PEAR安装和使用\n\n在官网上有说明详细的安装信息，这里作简单说明。\nhttp://pear.php.net/manual/en/about-pear.php\n\n### 下载\n#curl -o go-pear.php  http://pear.php.net/go-pear\n```\n$ curl -o go-pear.php  http://pear.php.net/go-pear\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100 88959  100 88959    0     0  43329      0  0:00:02  0:00:02 --:--:-- 43352\n\n```\n\n### 运行go-pear.php\n```\n# /usr/local/php5/bin/php go-pear.php\n```\n\n### 利用PEAR安装PHPDOC\n```\n$ pear install phpdoc/phpDocumentor-alpha\nAttempting to discover channel \"phpdoc\"...\nAttempting fallback to https instead of http on channel \"phpdoc\"...\nunknown channel \"phpdoc\" in \"phpdoc/phpDocumentor-alpha\"\ninvalid package name/package file \"phpdoc/phpDocumentor-alpha\"\ninstall failed\n```\n如出现上面错误，需要我们增加一个phpDocumentor pear渠道\n```\n$ pear channel-discover pear.phpdoc.org\nAdding Channel \"pear.phpdoc.org\" succeeded\nDiscovery of channel \"pear.phpdoc.org\" succeeded\n```\n重新安装\n```\n$ pear install phpdoc/phpDocumentor-alpha\ndownloading phpDocumentor-2.8.5.tgz ...\nStarting to download phpDocumentor-2.8.5.tgz (8,184,822 bytes)\n.................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................done: 8,184,822 bytes\ninstall ok: channel://pear.phpdoc.org/phpDocumentor-2.8.5\n```\n查看是否安装成功\n```\n$ phpdoc -V\nphpDocumentor version 2.8.5\n```\n\n\n## PEAR常用功能及命令\n```\n$ phpdoc --help\nUsage:\n project:run [-t|--target[=\"...\"]] [--cache-folder[=\"...\"]] [-f|--filename[=\"...\"]] [-d|--directory[=\"...\"]] [--encoding[=\"...\"]] [-e|--extensions[=\"...\"]] [-i|--ignore[=\"...\"]] [--ignore-tags[=\"...\"]] [--hidden] [--ignore-symlinks] [-m|--markers[=\"...\"]] [--title[=\"...\"]] [--force] [--validate] [--visibility[=\"...\"]] [--defaultpackagename[=\"...\"]] [--sourcecode] [-p|--progressbar] [--template[=\"...\"]] [--parseprivate] [--log[=\"...\"]]\n\nAliases: run\nOptions:\n --target (-t)         模板文件生成路径\n --cache-folder        缓存文件路径\n --filename (-f)       要解析的文件的逗号分隔列表。 通配符？ 和*（支持多个值）\n --directory (-d)      逗号分隔的目录列表（递归）解析（允许多个值）\n --encoding            编码用于解释源文件\n --extensions (-e)     以逗号分隔的解析扩展列表，默认为php，php3和phtml（允许多个值）\n --ignore (-i)         以逗号分隔的将被忽略的文件和目录（相对于源代码目录）列表。 通配符*和？ 支持（允许多个值）\n --ignore-tags         将忽略的逗号分隔的标签列表，默认为none。 package，subpackage和ignore不能被忽略。 （允许多个值）\n --hidden              使用此选项可以告诉phpDocumentor解析以句点（。）开头的文件和目录，默认情况下这些被忽略\n --ignore-symlinks     忽略到其他文件或目录的符号链接，默认值为on\n --markers (-m)        要过滤的标记/标记的逗号分隔列表（允许多个值）\n --title               设置此项目的标题; 默认是phpDocumentor标志\n --force               强制完整构建文档，不会增加现有文档\n --validate            使用PHP Lint验证每个处理的文件，成本很高的性能\n --visibility          指定应在文档中显示的解析可见性（逗号分隔，例如“public，protected”）（允许多个值）\n --defaultpackagename  用于默认软件包的名称。(default: \"Default\")\n --sourcecode          是否包含语法高亮的源代码\n --progressbar (-p)    是否显示进度条; 将自动静默记录到stdout\n --template            要使用的模板的名称（可选）（允许多个值）\n --parseprivate        是否解析标记有@internal标签的DocBlocks\n --log                 要写入的日志文件\n --help (-h)           显示此帮助消息\n --quiet (-q)          不输出任何消息\n --verbose (-v|vv|vvv) 增加消息的详细程度：1用于正常输出，2用于更详细的输出，3用于调试\n --version (-V)        显示此应用程序版本\n --ansi                强制ANSI输出\n --no-ansi             禁用ANSI输出\n --no-interaction (-n) 不要问任何互动问题\n --config (-c)         自定义配置文件的位置\n\nHelp:\n  phpDocumentor从PHP源文件创建文档。 最简单的方法\n  使用它是：\n\n     $ phpdoc run -d [directory to parse] -t [output directory]\n\n 这将解析在<directory to parse>中以.php，.php3和.phtml结尾的每个文件，然后在<output directory>中输出一个包含易于阅读的文档的HTML网站。\n\n phpDocumentor will try to look for a phpdoc.dist.xml or phpdoc.xml file in your\n current working directory and use that to override the default settings if\n present. In the configuration file can you specify the same settings (and\n more) as the command line provides.\n\nphpDocumentor将尝试在当前工作目录中查找phpdoc.dist.xml或phpdoc.xml文件，\n并使用该文件覆盖默认设置（如果存在）。 在配置文件中，您可以指定与命令行提供的相同的设置（和更多）。\n\n\n\n Other commands\n 除了这个命令phpDocumentor还支持附加命令：\n\n Available commands:\n   help\n   list\n   parse\n   run\n   transform\n project\n   project:parse\n   project:run\n   project:transform\n template\n   template:generate\n   template:list\n   template:package\n\n您可以使用list命令获取更详细的命令列表，并通过在命令名前添加help来获取帮助。\n```\n\n\n## 常用的PEAR模块简介\n\n\n\n- Benchmark/Timer 测试你的一段php代码的运行效率  \n\n- Benchmark/Benchmark_Iterate 测试你某个函数循环执行时的性能  \n\n- Cache/Output 可以将你的php脚本的输出进行缓存，可以使用多种方式缓存（存在文件，数据库或者是共享内存中）,如果使用这个模块有可能增大服务器的负载，所以，如果你想通过动态脚本的缓存来提供效率，不妨使用Zend optimize,这个模块未必适合  \n\n- Cache/Graphics 可以将你需要动态输出的图片进行缓存  \n\n- Console/Getopt 命令行参数的处理模块  \n\n- CMD 一个虚拟的shell，可以用它来运行一些系统的命令  \n\n- Crypt/CBC 实现Perl Crypt::CBC 模块的仿真  \n\n- Crypt/HCEMD5 实现Perl Crypt::HCE_MD5 模块的功能  \n\n- Date/Calc 实现日期的相关操作  \n\n- Date/Human Human历法的转换  \n\n- DB 提供统一的、抽象的数据库操作层，后端支持多种数据库  \n\n- File/Find 文件查找  \n\n- File/Passwd 操纵password类的文件，如password,httppass,cvspassword  \n\n- File/SearchReplace 在文件中查找替换字符串  \n\n- HTML/Form 可以在html中快速地创建form  \n\n- HTML/IT 实现模板定制，动态生成页面的功能，类似phplib中的模板功能，但是要简单易用  \n\n- HTML/ITX 实现对IT的扩展功能，可以更加灵活地定制你的模板，实现更复杂的操作  \n\n- HTML/Processor XML_Parser的扩展，使之可以应用于html文件的操作  \n\n- HTTP/Compress 用于Php 输出缓冲机制的一个包装类，同时可以对缓冲的内容进行压缩存储  \n\n- Image/Remote 无需把整个图片都下载到本地就可以获取远端系统的图片的信息，  \n\n- Log/composite Horde对log抽象类做的一个扩展，可以使多个日志处理对象能够获得同一个日志事件。注意，Log目录下面的模块都是Horde项目的一部分，大部分都是抽象的超类  \n\n- Log/file 将日志信息写入文件  \n\n- Log/mcal 将信息发送到本地或远端的日程管理软件-mcal的数据库中  \n\n- Log/observer Horder中Observer的一个超类  \n\n- Log/sql 将日志信息发送到sql数据库中  \n\n- Log/syslog 将信息发送到syslog中  \n\n- Mail/RFC822 检查一个email地址是否是合法的rf822 email地址  \n\n- Mail/sendmail 使用sendmail来发送信件  \n\n- Mail/smtp 使用smtp服务器来发送信件  \n\n- Math/Fraction 处理分形的数学计算  \n\n- Math/Util 计算最大公约数  \n\n- NET/Curl 对php的Curl扩展所作的面向对象的包装  \n\n- NET/Dig 操纵dig，进行dns相关的查询操作  \n\n- NET/SMTP 使用NET/Socket实现SMTP协议  \n\n- NET/Socket 通用的Socket类，实现了常用的socket操作的包装  \n\n- Numbers/Roman 阿拉伯数字和罗马数字的相互转换  \n\n- Payment/Verisign 实现和Verisign支付网关的交互  \n\n- Pear 提供Pear模块的2个基本类，PEAR 和PEARError类  \n\n- PEAR/Installer pear的安装类，提供Perl中的CPAN模块类似的功能  \n\n- PHPDoc 从php代码中自动生成API文档  \n\n- Schedule/at 和Unix 上的AT守护进程进行交互  \n\n- XML/Parser 基于php的xml扩展所作的xml的解析器  \n\n- XML/Render 将xml文档生成其它的格式（html,pdf),这只是一个抽象类，在最新的pear cvs代码中已经有了html的实现  \n\n- XML/RPC 用php实现xml-rpc的一个抽象类，在最新的pear cvs代码中已经有了xml/RPC/Server的实现  \n\n\n## PEAR与PECL关系\n\n\nPEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。\n\nPECL（PHP Extension Community Library），PHP的扩展库。它提供了一系列已知的扩展库，由C、C++等其他语言编写而成，以.so形式出现，.so 为共享库,是shared object,用于动态连接的,和dll差不多，为比PEAR更快，但是与PEAR不同的是，PECL需要在服务器上配置并被注册到主机中。\n\n基于他们的实现方式不同，在使用时候也有不同。\n\nPear：是PHP的扩展代码包，所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。\n\nPecl：是PHP的标准扩展，可以补充实际开发中所需的功能，所有的扩展都需要安装，在Windows下面以Dll的形式出现，在linux下面，需要单独进行编译，它的表现形式为根据PHP官方的标准用C语言写成，尽管源码开放但是一般人无法随意更改源码。\n\n**最直接的表述：Pear是PHP的上层扩展，Pecl是PHP的底层扩展。**\n","source":"_posts/PHP扩展与应用库(PEAR).md","raw":"---\ntitle: PHP扩展与应用库(PEAR)\ndate: 2016-10-12 20:30:00\ntags:\n- PEAR\ncategories:\n- PHP\n---\n\nPEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。\n\n官网：\n\nhttp://pear.php.net\n\n<!-- more -->\n\n## PEAR安装和使用\n\n在官网上有说明详细的安装信息，这里作简单说明。\nhttp://pear.php.net/manual/en/about-pear.php\n\n### 下载\n#curl -o go-pear.php  http://pear.php.net/go-pear\n```\n$ curl -o go-pear.php  http://pear.php.net/go-pear\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100 88959  100 88959    0     0  43329      0  0:00:02  0:00:02 --:--:-- 43352\n\n```\n\n### 运行go-pear.php\n```\n# /usr/local/php5/bin/php go-pear.php\n```\n\n### 利用PEAR安装PHPDOC\n```\n$ pear install phpdoc/phpDocumentor-alpha\nAttempting to discover channel \"phpdoc\"...\nAttempting fallback to https instead of http on channel \"phpdoc\"...\nunknown channel \"phpdoc\" in \"phpdoc/phpDocumentor-alpha\"\ninvalid package name/package file \"phpdoc/phpDocumentor-alpha\"\ninstall failed\n```\n如出现上面错误，需要我们增加一个phpDocumentor pear渠道\n```\n$ pear channel-discover pear.phpdoc.org\nAdding Channel \"pear.phpdoc.org\" succeeded\nDiscovery of channel \"pear.phpdoc.org\" succeeded\n```\n重新安装\n```\n$ pear install phpdoc/phpDocumentor-alpha\ndownloading phpDocumentor-2.8.5.tgz ...\nStarting to download phpDocumentor-2.8.5.tgz (8,184,822 bytes)\n.................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................done: 8,184,822 bytes\ninstall ok: channel://pear.phpdoc.org/phpDocumentor-2.8.5\n```\n查看是否安装成功\n```\n$ phpdoc -V\nphpDocumentor version 2.8.5\n```\n\n\n## PEAR常用功能及命令\n```\n$ phpdoc --help\nUsage:\n project:run [-t|--target[=\"...\"]] [--cache-folder[=\"...\"]] [-f|--filename[=\"...\"]] [-d|--directory[=\"...\"]] [--encoding[=\"...\"]] [-e|--extensions[=\"...\"]] [-i|--ignore[=\"...\"]] [--ignore-tags[=\"...\"]] [--hidden] [--ignore-symlinks] [-m|--markers[=\"...\"]] [--title[=\"...\"]] [--force] [--validate] [--visibility[=\"...\"]] [--defaultpackagename[=\"...\"]] [--sourcecode] [-p|--progressbar] [--template[=\"...\"]] [--parseprivate] [--log[=\"...\"]]\n\nAliases: run\nOptions:\n --target (-t)         模板文件生成路径\n --cache-folder        缓存文件路径\n --filename (-f)       要解析的文件的逗号分隔列表。 通配符？ 和*（支持多个值）\n --directory (-d)      逗号分隔的目录列表（递归）解析（允许多个值）\n --encoding            编码用于解释源文件\n --extensions (-e)     以逗号分隔的解析扩展列表，默认为php，php3和phtml（允许多个值）\n --ignore (-i)         以逗号分隔的将被忽略的文件和目录（相对于源代码目录）列表。 通配符*和？ 支持（允许多个值）\n --ignore-tags         将忽略的逗号分隔的标签列表，默认为none。 package，subpackage和ignore不能被忽略。 （允许多个值）\n --hidden              使用此选项可以告诉phpDocumentor解析以句点（。）开头的文件和目录，默认情况下这些被忽略\n --ignore-symlinks     忽略到其他文件或目录的符号链接，默认值为on\n --markers (-m)        要过滤的标记/标记的逗号分隔列表（允许多个值）\n --title               设置此项目的标题; 默认是phpDocumentor标志\n --force               强制完整构建文档，不会增加现有文档\n --validate            使用PHP Lint验证每个处理的文件，成本很高的性能\n --visibility          指定应在文档中显示的解析可见性（逗号分隔，例如“public，protected”）（允许多个值）\n --defaultpackagename  用于默认软件包的名称。(default: \"Default\")\n --sourcecode          是否包含语法高亮的源代码\n --progressbar (-p)    是否显示进度条; 将自动静默记录到stdout\n --template            要使用的模板的名称（可选）（允许多个值）\n --parseprivate        是否解析标记有@internal标签的DocBlocks\n --log                 要写入的日志文件\n --help (-h)           显示此帮助消息\n --quiet (-q)          不输出任何消息\n --verbose (-v|vv|vvv) 增加消息的详细程度：1用于正常输出，2用于更详细的输出，3用于调试\n --version (-V)        显示此应用程序版本\n --ansi                强制ANSI输出\n --no-ansi             禁用ANSI输出\n --no-interaction (-n) 不要问任何互动问题\n --config (-c)         自定义配置文件的位置\n\nHelp:\n  phpDocumentor从PHP源文件创建文档。 最简单的方法\n  使用它是：\n\n     $ phpdoc run -d [directory to parse] -t [output directory]\n\n 这将解析在<directory to parse>中以.php，.php3和.phtml结尾的每个文件，然后在<output directory>中输出一个包含易于阅读的文档的HTML网站。\n\n phpDocumentor will try to look for a phpdoc.dist.xml or phpdoc.xml file in your\n current working directory and use that to override the default settings if\n present. In the configuration file can you specify the same settings (and\n more) as the command line provides.\n\nphpDocumentor将尝试在当前工作目录中查找phpdoc.dist.xml或phpdoc.xml文件，\n并使用该文件覆盖默认设置（如果存在）。 在配置文件中，您可以指定与命令行提供的相同的设置（和更多）。\n\n\n\n Other commands\n 除了这个命令phpDocumentor还支持附加命令：\n\n Available commands:\n   help\n   list\n   parse\n   run\n   transform\n project\n   project:parse\n   project:run\n   project:transform\n template\n   template:generate\n   template:list\n   template:package\n\n您可以使用list命令获取更详细的命令列表，并通过在命令名前添加help来获取帮助。\n```\n\n\n## 常用的PEAR模块简介\n\n\n\n- Benchmark/Timer 测试你的一段php代码的运行效率  \n\n- Benchmark/Benchmark_Iterate 测试你某个函数循环执行时的性能  \n\n- Cache/Output 可以将你的php脚本的输出进行缓存，可以使用多种方式缓存（存在文件，数据库或者是共享内存中）,如果使用这个模块有可能增大服务器的负载，所以，如果你想通过动态脚本的缓存来提供效率，不妨使用Zend optimize,这个模块未必适合  \n\n- Cache/Graphics 可以将你需要动态输出的图片进行缓存  \n\n- Console/Getopt 命令行参数的处理模块  \n\n- CMD 一个虚拟的shell，可以用它来运行一些系统的命令  \n\n- Crypt/CBC 实现Perl Crypt::CBC 模块的仿真  \n\n- Crypt/HCEMD5 实现Perl Crypt::HCE_MD5 模块的功能  \n\n- Date/Calc 实现日期的相关操作  \n\n- Date/Human Human历法的转换  \n\n- DB 提供统一的、抽象的数据库操作层，后端支持多种数据库  \n\n- File/Find 文件查找  \n\n- File/Passwd 操纵password类的文件，如password,httppass,cvspassword  \n\n- File/SearchReplace 在文件中查找替换字符串  \n\n- HTML/Form 可以在html中快速地创建form  \n\n- HTML/IT 实现模板定制，动态生成页面的功能，类似phplib中的模板功能，但是要简单易用  \n\n- HTML/ITX 实现对IT的扩展功能，可以更加灵活地定制你的模板，实现更复杂的操作  \n\n- HTML/Processor XML_Parser的扩展，使之可以应用于html文件的操作  \n\n- HTTP/Compress 用于Php 输出缓冲机制的一个包装类，同时可以对缓冲的内容进行压缩存储  \n\n- Image/Remote 无需把整个图片都下载到本地就可以获取远端系统的图片的信息，  \n\n- Log/composite Horde对log抽象类做的一个扩展，可以使多个日志处理对象能够获得同一个日志事件。注意，Log目录下面的模块都是Horde项目的一部分，大部分都是抽象的超类  \n\n- Log/file 将日志信息写入文件  \n\n- Log/mcal 将信息发送到本地或远端的日程管理软件-mcal的数据库中  \n\n- Log/observer Horder中Observer的一个超类  \n\n- Log/sql 将日志信息发送到sql数据库中  \n\n- Log/syslog 将信息发送到syslog中  \n\n- Mail/RFC822 检查一个email地址是否是合法的rf822 email地址  \n\n- Mail/sendmail 使用sendmail来发送信件  \n\n- Mail/smtp 使用smtp服务器来发送信件  \n\n- Math/Fraction 处理分形的数学计算  \n\n- Math/Util 计算最大公约数  \n\n- NET/Curl 对php的Curl扩展所作的面向对象的包装  \n\n- NET/Dig 操纵dig，进行dns相关的查询操作  \n\n- NET/SMTP 使用NET/Socket实现SMTP协议  \n\n- NET/Socket 通用的Socket类，实现了常用的socket操作的包装  \n\n- Numbers/Roman 阿拉伯数字和罗马数字的相互转换  \n\n- Payment/Verisign 实现和Verisign支付网关的交互  \n\n- Pear 提供Pear模块的2个基本类，PEAR 和PEARError类  \n\n- PEAR/Installer pear的安装类，提供Perl中的CPAN模块类似的功能  \n\n- PHPDoc 从php代码中自动生成API文档  \n\n- Schedule/at 和Unix 上的AT守护进程进行交互  \n\n- XML/Parser 基于php的xml扩展所作的xml的解析器  \n\n- XML/Render 将xml文档生成其它的格式（html,pdf),这只是一个抽象类，在最新的pear cvs代码中已经有了html的实现  \n\n- XML/RPC 用php实现xml-rpc的一个抽象类，在最新的pear cvs代码中已经有了xml/RPC/Server的实现  \n\n\n## PEAR与PECL关系\n\n\nPEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。\n\nPECL（PHP Extension Community Library），PHP的扩展库。它提供了一系列已知的扩展库，由C、C++等其他语言编写而成，以.so形式出现，.so 为共享库,是shared object,用于动态连接的,和dll差不多，为比PEAR更快，但是与PEAR不同的是，PECL需要在服务器上配置并被注册到主机中。\n\n基于他们的实现方式不同，在使用时候也有不同。\n\nPear：是PHP的扩展代码包，所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。\n\nPecl：是PHP的标准扩展，可以补充实际开发中所需的功能，所有的扩展都需要安装，在Windows下面以Dll的形式出现，在linux下面，需要单独进行编译，它的表现形式为根据PHP官方的标准用C语言写成，尽管源码开放但是一般人无法随意更改源码。\n\n**最直接的表述：Pear是PHP的上层扩展，Pecl是PHP的底层扩展。**\n","slug":"PHP扩展与应用库(PEAR)","published":1,"updated":"2016-10-13T03:04:02.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwws0030699ff39hmkdu","content":"<p>PEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。</p>\n<p>官网：</p>\n<p><a href=\"http://pear.php.net\" target=\"_blank\" rel=\"external\">http://pear.php.net</a></p>\n<a id=\"more\"></a>\n<h2 id=\"PEAR安装和使用\"><a href=\"#PEAR安装和使用\" class=\"headerlink\" title=\"PEAR安装和使用\"></a>PEAR安装和使用</h2><p>在官网上有说明详细的安装信息，这里作简单说明。<br><a href=\"http://pear.php.net/manual/en/about-pear.php\" target=\"_blank\" rel=\"external\">http://pear.php.net/manual/en/about-pear.php</a></p>\n<h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p>#curl -o go-pear.php  <a href=\"http://pear.php.net/go-pear\" target=\"_blank\" rel=\"external\">http://pear.php.net/go-pear</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ curl -o go-pear.php  http://pear.php.net/go-pear</div><div class=\"line\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class=\"line\">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class=\"line\">100 88959  100 88959    0     0  43329      0  0:00:02  0:00:02 --:--:-- 43352</div></pre></td></tr></table></figure></p>\n<h3 id=\"运行go-pear-php\"><a href=\"#运行go-pear-php\" class=\"headerlink\" title=\"运行go-pear.php\"></a>运行go-pear.php</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/php5/bin/php go-pear.php</div></pre></td></tr></table></figure>\n<h3 id=\"利用PEAR安装PHPDOC\"><a href=\"#利用PEAR安装PHPDOC\" class=\"headerlink\" title=\"利用PEAR安装PHPDOC\"></a>利用PEAR安装PHPDOC</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pear install phpdoc/phpDocumentor-alpha</div><div class=\"line\">Attempting to discover channel &quot;phpdoc&quot;...</div><div class=\"line\">Attempting fallback to https instead of http on channel &quot;phpdoc&quot;...</div><div class=\"line\">unknown channel &quot;phpdoc&quot; in &quot;phpdoc/phpDocumentor-alpha&quot;</div><div class=\"line\">invalid package name/package file &quot;phpdoc/phpDocumentor-alpha&quot;</div><div class=\"line\">install failed</div></pre></td></tr></table></figure>\n<p>如出现上面错误，需要我们增加一个phpDocumentor pear渠道<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pear channel-discover pear.phpdoc.org</div><div class=\"line\">Adding Channel &quot;pear.phpdoc.org&quot; succeeded</div><div class=\"line\">Discovery of channel &quot;pear.phpdoc.org&quot; succeeded</div></pre></td></tr></table></figure></p>\n<p>重新安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pear install phpdoc/phpDocumentor-alpha</div><div class=\"line\">downloading phpDocumentor-2.8.5.tgz ...</div><div class=\"line\">Starting to download phpDocumentor-2.8.5.tgz (8,184,822 bytes)</div><div class=\"line\">.................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................done: 8,184,822 bytes</div><div class=\"line\">install ok: channel://pear.phpdoc.org/phpDocumentor-2.8.5</div></pre></td></tr></table></figure></p>\n<p>查看是否安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ phpdoc -V</div><div class=\"line\">phpDocumentor version 2.8.5</div></pre></td></tr></table></figure></p>\n<h2 id=\"PEAR常用功能及命令\"><a href=\"#PEAR常用功能及命令\" class=\"headerlink\" title=\"PEAR常用功能及命令\"></a>PEAR常用功能及命令</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ phpdoc --help</div><div class=\"line\">Usage:</div><div class=\"line\"> project:run [-t|--target[=&quot;...&quot;]] [--cache-folder[=&quot;...&quot;]] [-f|--filename[=&quot;...&quot;]] [-d|--directory[=&quot;...&quot;]] [--encoding[=&quot;...&quot;]] [-e|--extensions[=&quot;...&quot;]] [-i|--ignore[=&quot;...&quot;]] [--ignore-tags[=&quot;...&quot;]] [--hidden] [--ignore-symlinks] [-m|--markers[=&quot;...&quot;]] [--title[=&quot;...&quot;]] [--force] [--validate] [--visibility[=&quot;...&quot;]] [--defaultpackagename[=&quot;...&quot;]] [--sourcecode] [-p|--progressbar] [--template[=&quot;...&quot;]] [--parseprivate] [--log[=&quot;...&quot;]]</div><div class=\"line\"></div><div class=\"line\">Aliases: run</div><div class=\"line\">Options:</div><div class=\"line\"> --target (-t)         模板文件生成路径</div><div class=\"line\"> --cache-folder        缓存文件路径</div><div class=\"line\"> --filename (-f)       要解析的文件的逗号分隔列表。 通配符？ 和*（支持多个值）</div><div class=\"line\"> --directory (-d)      逗号分隔的目录列表（递归）解析（允许多个值）</div><div class=\"line\"> --encoding            编码用于解释源文件</div><div class=\"line\"> --extensions (-e)     以逗号分隔的解析扩展列表，默认为php，php3和phtml（允许多个值）</div><div class=\"line\"> --ignore (-i)         以逗号分隔的将被忽略的文件和目录（相对于源代码目录）列表。 通配符*和？ 支持（允许多个值）</div><div class=\"line\"> --ignore-tags         将忽略的逗号分隔的标签列表，默认为none。 package，subpackage和ignore不能被忽略。 （允许多个值）</div><div class=\"line\"> --hidden              使用此选项可以告诉phpDocumentor解析以句点（。）开头的文件和目录，默认情况下这些被忽略</div><div class=\"line\"> --ignore-symlinks     忽略到其他文件或目录的符号链接，默认值为on</div><div class=\"line\"> --markers (-m)        要过滤的标记/标记的逗号分隔列表（允许多个值）</div><div class=\"line\"> --title               设置此项目的标题; 默认是phpDocumentor标志</div><div class=\"line\"> --force               强制完整构建文档，不会增加现有文档</div><div class=\"line\"> --validate            使用PHP Lint验证每个处理的文件，成本很高的性能</div><div class=\"line\"> --visibility          指定应在文档中显示的解析可见性（逗号分隔，例如“public，protected”）（允许多个值）</div><div class=\"line\"> --defaultpackagename  用于默认软件包的名称。(default: &quot;Default&quot;)</div><div class=\"line\"> --sourcecode          是否包含语法高亮的源代码</div><div class=\"line\"> --progressbar (-p)    是否显示进度条; 将自动静默记录到stdout</div><div class=\"line\"> --template            要使用的模板的名称（可选）（允许多个值）</div><div class=\"line\"> --parseprivate        是否解析标记有@internal标签的DocBlocks</div><div class=\"line\"> --log                 要写入的日志文件</div><div class=\"line\"> --help (-h)           显示此帮助消息</div><div class=\"line\"> --quiet (-q)          不输出任何消息</div><div class=\"line\"> --verbose (-v|vv|vvv) 增加消息的详细程度：1用于正常输出，2用于更详细的输出，3用于调试</div><div class=\"line\"> --version (-V)        显示此应用程序版本</div><div class=\"line\"> --ansi                强制ANSI输出</div><div class=\"line\"> --no-ansi             禁用ANSI输出</div><div class=\"line\"> --no-interaction (-n) 不要问任何互动问题</div><div class=\"line\"> --config (-c)         自定义配置文件的位置</div><div class=\"line\"></div><div class=\"line\">Help:</div><div class=\"line\">  phpDocumentor从PHP源文件创建文档。 最简单的方法</div><div class=\"line\">  使用它是：</div><div class=\"line\"></div><div class=\"line\">     $ phpdoc run -d [directory to parse] -t [output directory]</div><div class=\"line\"></div><div class=\"line\"> 这将解析在&lt;directory to parse&gt;中以.php，.php3和.phtml结尾的每个文件，然后在&lt;output directory&gt;中输出一个包含易于阅读的文档的HTML网站。</div><div class=\"line\"></div><div class=\"line\"> phpDocumentor will try to look for a phpdoc.dist.xml or phpdoc.xml file in your</div><div class=\"line\"> current working directory and use that to override the default settings if</div><div class=\"line\"> present. In the configuration file can you specify the same settings (and</div><div class=\"line\"> more) as the command line provides.</div><div class=\"line\"></div><div class=\"line\">phpDocumentor将尝试在当前工作目录中查找phpdoc.dist.xml或phpdoc.xml文件，</div><div class=\"line\">并使用该文件覆盖默认设置（如果存在）。 在配置文件中，您可以指定与命令行提供的相同的设置（和更多）。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"> Other commands</div><div class=\"line\"> 除了这个命令phpDocumentor还支持附加命令：</div><div class=\"line\"></div><div class=\"line\"> Available commands:</div><div class=\"line\">   help</div><div class=\"line\">   list</div><div class=\"line\">   parse</div><div class=\"line\">   run</div><div class=\"line\">   transform</div><div class=\"line\"> project</div><div class=\"line\">   project:parse</div><div class=\"line\">   project:run</div><div class=\"line\">   project:transform</div><div class=\"line\"> template</div><div class=\"line\">   template:generate</div><div class=\"line\">   template:list</div><div class=\"line\">   template:package</div><div class=\"line\"></div><div class=\"line\">您可以使用list命令获取更详细的命令列表，并通过在命令名前添加help来获取帮助。</div></pre></td></tr></table></figure>\n<h2 id=\"常用的PEAR模块简介\"><a href=\"#常用的PEAR模块简介\" class=\"headerlink\" title=\"常用的PEAR模块简介\"></a>常用的PEAR模块简介</h2><ul>\n<li><p>Benchmark/Timer 测试你的一段php代码的运行效率  </p>\n</li>\n<li><p>Benchmark/Benchmark_Iterate 测试你某个函数循环执行时的性能  </p>\n</li>\n<li><p>Cache/Output 可以将你的php脚本的输出进行缓存，可以使用多种方式缓存（存在文件，数据库或者是共享内存中）,如果使用这个模块有可能增大服务器的负载，所以，如果你想通过动态脚本的缓存来提供效率，不妨使用Zend optimize,这个模块未必适合  </p>\n</li>\n<li><p>Cache/Graphics 可以将你需要动态输出的图片进行缓存  </p>\n</li>\n<li><p>Console/Getopt 命令行参数的处理模块  </p>\n</li>\n<li><p>CMD 一个虚拟的shell，可以用它来运行一些系统的命令  </p>\n</li>\n<li><p>Crypt/CBC 实现Perl Crypt::CBC 模块的仿真  </p>\n</li>\n<li><p>Crypt/HCEMD5 实现Perl Crypt::HCE_MD5 模块的功能  </p>\n</li>\n<li><p>Date/Calc 实现日期的相关操作  </p>\n</li>\n<li><p>Date/Human Human历法的转换  </p>\n</li>\n<li><p>DB 提供统一的、抽象的数据库操作层，后端支持多种数据库  </p>\n</li>\n<li><p>File/Find 文件查找  </p>\n</li>\n<li><p>File/Passwd 操纵password类的文件，如password,httppass,cvspassword  </p>\n</li>\n<li><p>File/SearchReplace 在文件中查找替换字符串  </p>\n</li>\n<li><p>HTML/Form 可以在html中快速地创建form  </p>\n</li>\n<li><p>HTML/IT 实现模板定制，动态生成页面的功能，类似phplib中的模板功能，但是要简单易用  </p>\n</li>\n<li><p>HTML/ITX 实现对IT的扩展功能，可以更加灵活地定制你的模板，实现更复杂的操作  </p>\n</li>\n<li><p>HTML/Processor XML_Parser的扩展，使之可以应用于html文件的操作  </p>\n</li>\n<li><p>HTTP/Compress 用于Php 输出缓冲机制的一个包装类，同时可以对缓冲的内容进行压缩存储  </p>\n</li>\n<li><p>Image/Remote 无需把整个图片都下载到本地就可以获取远端系统的图片的信息，  </p>\n</li>\n<li><p>Log/composite Horde对log抽象类做的一个扩展，可以使多个日志处理对象能够获得同一个日志事件。注意，Log目录下面的模块都是Horde项目的一部分，大部分都是抽象的超类  </p>\n</li>\n<li><p>Log/file 将日志信息写入文件  </p>\n</li>\n<li><p>Log/mcal 将信息发送到本地或远端的日程管理软件-mcal的数据库中  </p>\n</li>\n<li><p>Log/observer Horder中Observer的一个超类  </p>\n</li>\n<li><p>Log/sql 将日志信息发送到sql数据库中  </p>\n</li>\n<li><p>Log/syslog 将信息发送到syslog中  </p>\n</li>\n<li><p>Mail/RFC822 检查一个email地址是否是合法的rf822 email地址  </p>\n</li>\n<li><p>Mail/sendmail 使用sendmail来发送信件  </p>\n</li>\n<li><p>Mail/smtp 使用smtp服务器来发送信件  </p>\n</li>\n<li><p>Math/Fraction 处理分形的数学计算  </p>\n</li>\n<li><p>Math/Util 计算最大公约数  </p>\n</li>\n<li><p>NET/Curl 对php的Curl扩展所作的面向对象的包装  </p>\n</li>\n<li><p>NET/Dig 操纵dig，进行dns相关的查询操作  </p>\n</li>\n<li><p>NET/SMTP 使用NET/Socket实现SMTP协议  </p>\n</li>\n<li><p>NET/Socket 通用的Socket类，实现了常用的socket操作的包装  </p>\n</li>\n<li><p>Numbers/Roman 阿拉伯数字和罗马数字的相互转换  </p>\n</li>\n<li><p>Payment/Verisign 实现和Verisign支付网关的交互  </p>\n</li>\n<li><p>Pear 提供Pear模块的2个基本类，PEAR 和PEARError类  </p>\n</li>\n<li><p>PEAR/Installer pear的安装类，提供Perl中的CPAN模块类似的功能  </p>\n</li>\n<li><p>PHPDoc 从php代码中自动生成API文档  </p>\n</li>\n<li><p>Schedule/at 和Unix 上的AT守护进程进行交互  </p>\n</li>\n<li><p>XML/Parser 基于php的xml扩展所作的xml的解析器  </p>\n</li>\n<li><p>XML/Render 将xml文档生成其它的格式（html,pdf),这只是一个抽象类，在最新的pear cvs代码中已经有了html的实现  </p>\n</li>\n<li><p>XML/RPC 用php实现xml-rpc的一个抽象类，在最新的pear cvs代码中已经有了xml/RPC/Server的实现  </p>\n</li>\n</ul>\n<h2 id=\"PEAR与PECL关系\"><a href=\"#PEAR与PECL关系\" class=\"headerlink\" title=\"PEAR与PECL关系\"></a>PEAR与PECL关系</h2><p>PEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。</p>\n<p>PECL（PHP Extension Community Library），PHP的扩展库。它提供了一系列已知的扩展库，由C、C++等其他语言编写而成，以.so形式出现，.so 为共享库,是shared object,用于动态连接的,和dll差不多，为比PEAR更快，但是与PEAR不同的是，PECL需要在服务器上配置并被注册到主机中。</p>\n<p>基于他们的实现方式不同，在使用时候也有不同。</p>\n<p>Pear：是PHP的扩展代码包，所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。</p>\n<p>Pecl：是PHP的标准扩展，可以补充实际开发中所需的功能，所有的扩展都需要安装，在Windows下面以Dll的形式出现，在linux下面，需要单独进行编译，它的表现形式为根据PHP官方的标准用C语言写成，尽管源码开放但是一般人无法随意更改源码。</p>\n<p><strong>最直接的表述：Pear是PHP的上层扩展，Pecl是PHP的底层扩展。</strong></p>\n","excerpt":"<p>PEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。</p>\n<p>官网：</p>\n<p><a href=\"http://pear.php.net\">http://pear.php.net</a></p>","more":"<h2 id=\"PEAR安装和使用\"><a href=\"#PEAR安装和使用\" class=\"headerlink\" title=\"PEAR安装和使用\"></a>PEAR安装和使用</h2><p>在官网上有说明详细的安装信息，这里作简单说明。<br><a href=\"http://pear.php.net/manual/en/about-pear.php\">http://pear.php.net/manual/en/about-pear.php</a></p>\n<h3 id=\"下载\"><a href=\"#下载\" class=\"headerlink\" title=\"下载\"></a>下载</h3><p>#curl -o go-pear.php  <a href=\"http://pear.php.net/go-pear\">http://pear.php.net/go-pear</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ curl -o go-pear.php  http://pear.php.net/go-pear</div><div class=\"line\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class=\"line\">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class=\"line\">100 88959  100 88959    0     0  43329      0  0:00:02  0:00:02 --:--:-- 43352</div></pre></td></tr></table></figure></p>\n<h3 id=\"运行go-pear-php\"><a href=\"#运行go-pear-php\" class=\"headerlink\" title=\"运行go-pear.php\"></a>运行go-pear.php</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /usr/local/php5/bin/php go-pear.php</div></pre></td></tr></table></figure>\n<h3 id=\"利用PEAR安装PHPDOC\"><a href=\"#利用PEAR安装PHPDOC\" class=\"headerlink\" title=\"利用PEAR安装PHPDOC\"></a>利用PEAR安装PHPDOC</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pear install phpdoc/phpDocumentor-alpha</div><div class=\"line\">Attempting to discover channel &quot;phpdoc&quot;...</div><div class=\"line\">Attempting fallback to https instead of http on channel &quot;phpdoc&quot;...</div><div class=\"line\">unknown channel &quot;phpdoc&quot; in &quot;phpdoc/phpDocumentor-alpha&quot;</div><div class=\"line\">invalid package name/package file &quot;phpdoc/phpDocumentor-alpha&quot;</div><div class=\"line\">install failed</div></pre></td></tr></table></figure>\n<p>如出现上面错误，需要我们增加一个phpDocumentor pear渠道<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pear channel-discover pear.phpdoc.org</div><div class=\"line\">Adding Channel &quot;pear.phpdoc.org&quot; succeeded</div><div class=\"line\">Discovery of channel &quot;pear.phpdoc.org&quot; succeeded</div></pre></td></tr></table></figure></p>\n<p>重新安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ pear install phpdoc/phpDocumentor-alpha</div><div class=\"line\">downloading phpDocumentor-2.8.5.tgz ...</div><div class=\"line\">Starting to download phpDocumentor-2.8.5.tgz (8,184,822 bytes)</div><div class=\"line\">.................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................done: 8,184,822 bytes</div><div class=\"line\">install ok: channel://pear.phpdoc.org/phpDocumentor-2.8.5</div></pre></td></tr></table></figure></p>\n<p>查看是否安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ phpdoc -V</div><div class=\"line\">phpDocumentor version 2.8.5</div></pre></td></tr></table></figure></p>\n<h2 id=\"PEAR常用功能及命令\"><a href=\"#PEAR常用功能及命令\" class=\"headerlink\" title=\"PEAR常用功能及命令\"></a>PEAR常用功能及命令</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ phpdoc --help</div><div class=\"line\">Usage:</div><div class=\"line\"> project:run [-t|--target[=&quot;...&quot;]] [--cache-folder[=&quot;...&quot;]] [-f|--filename[=&quot;...&quot;]] [-d|--directory[=&quot;...&quot;]] [--encoding[=&quot;...&quot;]] [-e|--extensions[=&quot;...&quot;]] [-i|--ignore[=&quot;...&quot;]] [--ignore-tags[=&quot;...&quot;]] [--hidden] [--ignore-symlinks] [-m|--markers[=&quot;...&quot;]] [--title[=&quot;...&quot;]] [--force] [--validate] [--visibility[=&quot;...&quot;]] [--defaultpackagename[=&quot;...&quot;]] [--sourcecode] [-p|--progressbar] [--template[=&quot;...&quot;]] [--parseprivate] [--log[=&quot;...&quot;]]</div><div class=\"line\"></div><div class=\"line\">Aliases: run</div><div class=\"line\">Options:</div><div class=\"line\"> --target (-t)         模板文件生成路径</div><div class=\"line\"> --cache-folder        缓存文件路径</div><div class=\"line\"> --filename (-f)       要解析的文件的逗号分隔列表。 通配符？ 和*（支持多个值）</div><div class=\"line\"> --directory (-d)      逗号分隔的目录列表（递归）解析（允许多个值）</div><div class=\"line\"> --encoding            编码用于解释源文件</div><div class=\"line\"> --extensions (-e)     以逗号分隔的解析扩展列表，默认为php，php3和phtml（允许多个值）</div><div class=\"line\"> --ignore (-i)         以逗号分隔的将被忽略的文件和目录（相对于源代码目录）列表。 通配符*和？ 支持（允许多个值）</div><div class=\"line\"> --ignore-tags         将忽略的逗号分隔的标签列表，默认为none。 package，subpackage和ignore不能被忽略。 （允许多个值）</div><div class=\"line\"> --hidden              使用此选项可以告诉phpDocumentor解析以句点（。）开头的文件和目录，默认情况下这些被忽略</div><div class=\"line\"> --ignore-symlinks     忽略到其他文件或目录的符号链接，默认值为on</div><div class=\"line\"> --markers (-m)        要过滤的标记/标记的逗号分隔列表（允许多个值）</div><div class=\"line\"> --title               设置此项目的标题; 默认是phpDocumentor标志</div><div class=\"line\"> --force               强制完整构建文档，不会增加现有文档</div><div class=\"line\"> --validate            使用PHP Lint验证每个处理的文件，成本很高的性能</div><div class=\"line\"> --visibility          指定应在文档中显示的解析可见性（逗号分隔，例如“public，protected”）（允许多个值）</div><div class=\"line\"> --defaultpackagename  用于默认软件包的名称。(default: &quot;Default&quot;)</div><div class=\"line\"> --sourcecode          是否包含语法高亮的源代码</div><div class=\"line\"> --progressbar (-p)    是否显示进度条; 将自动静默记录到stdout</div><div class=\"line\"> --template            要使用的模板的名称（可选）（允许多个值）</div><div class=\"line\"> --parseprivate        是否解析标记有@internal标签的DocBlocks</div><div class=\"line\"> --log                 要写入的日志文件</div><div class=\"line\"> --help (-h)           显示此帮助消息</div><div class=\"line\"> --quiet (-q)          不输出任何消息</div><div class=\"line\"> --verbose (-v|vv|vvv) 增加消息的详细程度：1用于正常输出，2用于更详细的输出，3用于调试</div><div class=\"line\"> --version (-V)        显示此应用程序版本</div><div class=\"line\"> --ansi                强制ANSI输出</div><div class=\"line\"> --no-ansi             禁用ANSI输出</div><div class=\"line\"> --no-interaction (-n) 不要问任何互动问题</div><div class=\"line\"> --config (-c)         自定义配置文件的位置</div><div class=\"line\"></div><div class=\"line\">Help:</div><div class=\"line\">  phpDocumentor从PHP源文件创建文档。 最简单的方法</div><div class=\"line\">  使用它是：</div><div class=\"line\"></div><div class=\"line\">     $ phpdoc run -d [directory to parse] -t [output directory]</div><div class=\"line\"></div><div class=\"line\"> 这将解析在&lt;directory to parse&gt;中以.php，.php3和.phtml结尾的每个文件，然后在&lt;output directory&gt;中输出一个包含易于阅读的文档的HTML网站。</div><div class=\"line\"></div><div class=\"line\"> phpDocumentor will try to look for a phpdoc.dist.xml or phpdoc.xml file in your</div><div class=\"line\"> current working directory and use that to override the default settings if</div><div class=\"line\"> present. In the configuration file can you specify the same settings (and</div><div class=\"line\"> more) as the command line provides.</div><div class=\"line\"></div><div class=\"line\">phpDocumentor将尝试在当前工作目录中查找phpdoc.dist.xml或phpdoc.xml文件，</div><div class=\"line\">并使用该文件覆盖默认设置（如果存在）。 在配置文件中，您可以指定与命令行提供的相同的设置（和更多）。</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\"> Other commands</div><div class=\"line\"> 除了这个命令phpDocumentor还支持附加命令：</div><div class=\"line\"></div><div class=\"line\"> Available commands:</div><div class=\"line\">   help</div><div class=\"line\">   list</div><div class=\"line\">   parse</div><div class=\"line\">   run</div><div class=\"line\">   transform</div><div class=\"line\"> project</div><div class=\"line\">   project:parse</div><div class=\"line\">   project:run</div><div class=\"line\">   project:transform</div><div class=\"line\"> template</div><div class=\"line\">   template:generate</div><div class=\"line\">   template:list</div><div class=\"line\">   template:package</div><div class=\"line\"></div><div class=\"line\">您可以使用list命令获取更详细的命令列表，并通过在命令名前添加help来获取帮助。</div></pre></td></tr></table></figure>\n<h2 id=\"常用的PEAR模块简介\"><a href=\"#常用的PEAR模块简介\" class=\"headerlink\" title=\"常用的PEAR模块简介\"></a>常用的PEAR模块简介</h2><ul>\n<li><p>Benchmark/Timer 测试你的一段php代码的运行效率  </p>\n</li>\n<li><p>Benchmark/Benchmark_Iterate 测试你某个函数循环执行时的性能  </p>\n</li>\n<li><p>Cache/Output 可以将你的php脚本的输出进行缓存，可以使用多种方式缓存（存在文件，数据库或者是共享内存中）,如果使用这个模块有可能增大服务器的负载，所以，如果你想通过动态脚本的缓存来提供效率，不妨使用Zend optimize,这个模块未必适合  </p>\n</li>\n<li><p>Cache/Graphics 可以将你需要动态输出的图片进行缓存  </p>\n</li>\n<li><p>Console/Getopt 命令行参数的处理模块  </p>\n</li>\n<li><p>CMD 一个虚拟的shell，可以用它来运行一些系统的命令  </p>\n</li>\n<li><p>Crypt/CBC 实现Perl Crypt::CBC 模块的仿真  </p>\n</li>\n<li><p>Crypt/HCEMD5 实现Perl Crypt::HCE_MD5 模块的功能  </p>\n</li>\n<li><p>Date/Calc 实现日期的相关操作  </p>\n</li>\n<li><p>Date/Human Human历法的转换  </p>\n</li>\n<li><p>DB 提供统一的、抽象的数据库操作层，后端支持多种数据库  </p>\n</li>\n<li><p>File/Find 文件查找  </p>\n</li>\n<li><p>File/Passwd 操纵password类的文件，如password,httppass,cvspassword  </p>\n</li>\n<li><p>File/SearchReplace 在文件中查找替换字符串  </p>\n</li>\n<li><p>HTML/Form 可以在html中快速地创建form  </p>\n</li>\n<li><p>HTML/IT 实现模板定制，动态生成页面的功能，类似phplib中的模板功能，但是要简单易用  </p>\n</li>\n<li><p>HTML/ITX 实现对IT的扩展功能，可以更加灵活地定制你的模板，实现更复杂的操作  </p>\n</li>\n<li><p>HTML/Processor XML_Parser的扩展，使之可以应用于html文件的操作  </p>\n</li>\n<li><p>HTTP/Compress 用于Php 输出缓冲机制的一个包装类，同时可以对缓冲的内容进行压缩存储  </p>\n</li>\n<li><p>Image/Remote 无需把整个图片都下载到本地就可以获取远端系统的图片的信息，  </p>\n</li>\n<li><p>Log/composite Horde对log抽象类做的一个扩展，可以使多个日志处理对象能够获得同一个日志事件。注意，Log目录下面的模块都是Horde项目的一部分，大部分都是抽象的超类  </p>\n</li>\n<li><p>Log/file 将日志信息写入文件  </p>\n</li>\n<li><p>Log/mcal 将信息发送到本地或远端的日程管理软件-mcal的数据库中  </p>\n</li>\n<li><p>Log/observer Horder中Observer的一个超类  </p>\n</li>\n<li><p>Log/sql 将日志信息发送到sql数据库中  </p>\n</li>\n<li><p>Log/syslog 将信息发送到syslog中  </p>\n</li>\n<li><p>Mail/RFC822 检查一个email地址是否是合法的rf822 email地址  </p>\n</li>\n<li><p>Mail/sendmail 使用sendmail来发送信件  </p>\n</li>\n<li><p>Mail/smtp 使用smtp服务器来发送信件  </p>\n</li>\n<li><p>Math/Fraction 处理分形的数学计算  </p>\n</li>\n<li><p>Math/Util 计算最大公约数  </p>\n</li>\n<li><p>NET/Curl 对php的Curl扩展所作的面向对象的包装  </p>\n</li>\n<li><p>NET/Dig 操纵dig，进行dns相关的查询操作  </p>\n</li>\n<li><p>NET/SMTP 使用NET/Socket实现SMTP协议  </p>\n</li>\n<li><p>NET/Socket 通用的Socket类，实现了常用的socket操作的包装  </p>\n</li>\n<li><p>Numbers/Roman 阿拉伯数字和罗马数字的相互转换  </p>\n</li>\n<li><p>Payment/Verisign 实现和Verisign支付网关的交互  </p>\n</li>\n<li><p>Pear 提供Pear模块的2个基本类，PEAR 和PEARError类  </p>\n</li>\n<li><p>PEAR/Installer pear的安装类，提供Perl中的CPAN模块类似的功能  </p>\n</li>\n<li><p>PHPDoc 从php代码中自动生成API文档  </p>\n</li>\n<li><p>Schedule/at 和Unix 上的AT守护进程进行交互  </p>\n</li>\n<li><p>XML/Parser 基于php的xml扩展所作的xml的解析器  </p>\n</li>\n<li><p>XML/Render 将xml文档生成其它的格式（html,pdf),这只是一个抽象类，在最新的pear cvs代码中已经有了html的实现  </p>\n</li>\n<li><p>XML/RPC 用php实现xml-rpc的一个抽象类，在最新的pear cvs代码中已经有了xml/RPC/Server的实现  </p>\n</li>\n</ul>\n<h2 id=\"PEAR与PECL关系\"><a href=\"#PEAR与PECL关系\" class=\"headerlink\" title=\"PEAR与PECL关系\"></a>PEAR与PECL关系</h2><p>PEAR（the PHP Extension and Application Repository），PHP扩展与应用库。它是一个PHP扩展及应用的一个代码仓库。</p>\n<p>PECL（PHP Extension Community Library），PHP的扩展库。它提供了一系列已知的扩展库，由C、C++等其他语言编写而成，以.so形式出现，.so 为共享库,是shared object,用于动态连接的,和dll差不多，为比PEAR更快，但是与PEAR不同的是，PECL需要在服务器上配置并被注册到主机中。</p>\n<p>基于他们的实现方式不同，在使用时候也有不同。</p>\n<p>Pear：是PHP的扩展代码包，所有的扩展均以PHP代码的形式出现，功能强大，安装简单，甚至可以改改就用。使用的时候，要在代码中进行Include才能够使用。</p>\n<p>Pecl：是PHP的标准扩展，可以补充实际开发中所需的功能，所有的扩展都需要安装，在Windows下面以Dll的形式出现，在linux下面，需要单独进行编译，它的表现形式为根据PHP官方的标准用C语言写成，尽管源码开放但是一般人无法随意更改源码。</p>\n<p><strong>最直接的表述：Pear是PHP的上层扩展，Pecl是PHP的底层扩展。</strong></p>"},{"title":"PHP异常和错误处理","date":"2016-09-30T15:10:00.000Z","_content":"首先，需要明确以下这两个概念\n- 异常(exception)\n> PHP中的异常，是程序运行中不符合预期的情况及与正常流程不同的状况。\n> 是属于逻辑和业务流程的一种中断，而不是语法错误。\n\n- 错误(error)\n> PHP中的错误则属于自身的问题，是一种非法的语法或者环境问题导致的、让编译器无法通过检查甚至无法运行的情况。\n\n<!-- more -->\n\n## 异常处理\n\nPHP中玉带任何自身问题都会触发一个错误，而不是抛出异常。所以，如果想使用异常处理来处理不可预知的问题，这是PHP办不到的。但在处理一些可以预知的错误，PHP的异常处理机制还是能够帮我们解决一些问题的。例如：\n- 代码冗余复杂，到处充斥着if...else\n- 代码可读性差\n\n而异常处理，其主要作用是将『正常执行过程的代码』和『处理问题怎么处理的代码』进行分离。\n\n### PHP常见的异常类\n#### Exception\n> 所有异常的基类。\n\n类摘要\n```php\n<?php\n  Exception {\n    /* 属性 */\n    protected string $message ;     //异常消息内容\n    protected int $code ;           //异常代码\n    protected string $file ;        //抛出异常的文件名\n    protected int $line ;           //抛出异常在该文件中的行号\n    /* 方法 */\n    public __construct ([ string $message = \"\" [, int $code = 0 [, Exception $previous = NULL ]]] )           //异常构造函数\n    final public string getMessage ( void )    //获取异常消息内容\n    final public Exception getPrevious ( void )//返回异常链中的前一个异常\n    final public int getCode ( void )          //获取异常代码\n    final public string getFile ( void )       //获取发生异常的程序文件名称\n    final public int getLine ( void )          //获取发生异常的代码在文件中的行号\n    final public array getTrace ( void )       //获取异常追踪信息\n    final public string getTraceAsString ( void )//获取字符串类型的异常追踪信息\n    public string __toString ( void )            //将异常对象转换为字符串\n    final private void __clone ( void )          //异常克隆\n  }\n```\n\n#### 错误异常类\n\n类摘要\n```php\n<?php\n  ErrorException extends Exception {\n      /* 属性 */\n      protected int $severity ;     //异常级别\n      /* 方法 */\n      public __construct ([ string $message = \"\" [, int $code = 0 [, int $severity = 1 [, string $filename = __FILE__ [, int $lineno = __LINE__ [, Exception $previous = NULL ]]]]]] )   //异常构造函数\n      final public int getSeverity ( void )             // 获取异常的严重程度\n      /* 继承的方法 */\n      final public string Exception::getMessage ( void )\n      final public Exception Exception::getPrevious ( void )\n      final public int Exception::getCode ( void )\n      final public string Exception::getFile ( void )\n      final public int Exception::getLine ( void )\n      final public array Exception::getTrace ( void )\n      final public string Exception::getTraceAsString ( void )\n      public string Exception::__toString ( void )\n      final private void Exception::__clone ( void )\n  }\n```\n常见使用方式（使用set_error_handle()函数讲错误信息托管至ErrorException）\n```php\n<?php\nfunction exception_error_handler($errno, $errstr, $errfile, $errline ) {\n    throw new ErrorException($errstr, 0, $errno, $errfile, $errline);\n}\nset_error_handler(\"exception_error_handler\");\n/* Trigger exception 抛出异常 */\nstrpos();\n?>\n```\n\n#### 自定义异常类\n\n```php\n<?php\n/**\n * 自定义一个异常处理类\n */\nclass MyException extends Exception\n{\n    // 重定义构造器使 message 变为必须被指定的属性\n    public function __construct($message, $code = 0, Exception $previous = null) {\n        // 自定义的代码\n\n        // 确保所有变量都被正确赋值\n        parent::__construct($message, $code, $previous);\n    }\n    // 自定义字符串输出的样式\n    public function __toString() {\n        return __CLASS__ . \": [{$this->code}]: {$this->message}\\n\";\n    }\n    public function customFunction() {\n        echo \"A custom function for this type of exception\\n\";\n    }\n}\n```\n\n### PHP中异常用法\n>\n\n首先我们需要知道，***在PHP中只有手动抛出异常后才能捕获异常，对于抛出的异常只有进行捕获并作出相应的操作抛出异常才有意义，否则没有任何意义。***\n\n抛出异常\n```php\n<?php\n  function check($n){\n    if(empty($n)){\n      throw new Exception(\"参数错误\");\n    }\n  }\n```\n\n#### try...catch\n示例：关于上传操作的异常处理\n\n方式一：异常发生时立即捕获\n```php\n<?php\n  try{\n    //可能出现错误的代码\n    if(文件上传不成功)\n      throw (上传异常)；\n    if(更新数据库不成功)\n      throw (数据库异常操作)；\n  } catch(异常){\n    //必须的补救措施，例如删除文件、删除数据库记录\n    ...\n  }\n```\n方式二：分散抛出，集中捕获\n```php\n<?php\n  上传{\n    if(文件上传不成功) throw (上传异常)；\n    if(更新数据库不成功)  throw (数据库异常)；\n  }\n  其他{\n    if(其他操作失败) throw （其他操作异常）；\n  }\n  //其他代码...\n  try{\n      上传；\n      其他；\n  } catch(上传异常){\n      //上传异常处理、例如删除文件\n  } catch(数据库异常){\n      //数据库异常处理、比如删除数据库记录等\n  } catch(其他异常){\n      //其他异常处理，比如记录异常日志等\n  }\n```\n\n**需要注意，exception作为超类应该放在最后捕获**\n\n\n#### try...catch...finally\n示例：\n```php\n<?php\n  function inverse($x) {\n      if (!$x) {\n          throw new Exception('Division by zero.');\n      }\n      return 1/$x;\n  }\n  //\n  try {\n      echo inverse(5) . \"\\n\";\n  } catch (Exception $e) {\n      echo 'Caught exception: ',  $e->getMessage(), \"\\n\";\n  } finally {\n      echo \"First finally.\\n\";\n  }\n  //\n  try {\n      echo inverse(0) . \"\\n\";\n  } catch (Exception $e) {\n      echo 'Caught exception: ',  $e->getMessage(), \"\\n\";\n  } finally {\n      echo \"Second finally.\\n\";\n  }\n  //\n  // Continue execution\n  echo \"Hello World\\n\";\n?>\n\n```\n\n### PHP异常处理使用场景\n#### 对程序的悲观预测\n即当一个操作可能会由于一些不可控的因素（比如网络问题等），可能会出现执行不成功的情况。那么在种情况下就可以抛出异常，然后进行捕获，对异常情况进行细致的处理。\n#### 程序的需要和对业务的需要\n需要强调的是，异常是业务处理中必不可少的环节，我们不能对异常视而不见。\n需要用到异常处理的情况\n- 不希望业务代码中充斥着大量的打印、调试等处理；\n- 业务中自定义的异常，对现实生活中各种业务进行补充；\n- 对数据一致性有要求的业务操作中；\n\n异常处理机制可以把每一件事当做事务来考虑，还可以把异常处理当做成一种内建的恢复系统。\n\n\n\n#### 语言级别的健壮性要求\n我们都知道PHP在健壮性这一点是不足的。对很多异常是没有强制性限制的。所以很多异常需要我们自己来做。\n\n通过try...catch处理，我们可以把异常造成的逻辑中断破坏降低到最小的范围，并且经过补救处理后不影响业务逻辑的完整性；乱抛异常和只抛不捕获，或者捕获而不补救，都会导致数据混乱。\n\n\n\n\n## 错误处理\n### PHP中的错误级别\nPHP的错误有很多类，包括warning、notice、deprecated、fatal error等。\n\n常用到的错误级别\n- deprecated，是最低级别的错误，表示不推荐、不建议。其虽不影响PHP正常的业务流程，但一般情况下建议修正；\n- notice，通知级别错误。表示你语法中存在不恰当的地方。常见的是 使用未定义的变量就会报此错误。这种错误也影响PHP正常流程；\n- warning，警告级别错误，是比较高级别的错误，表示在语法中出现很不恰当的地方，比如函数参数不匹配。这种级别的错误可能会导致出现不可预期的结果，所以建议修正；\n- fetal error，致命错误。直接导致PHP流程终结，后面代码不在执行。\n- prase error，语法解析错误。导致PHP代码无法通过语法检查。\n\n错误信息显示控制\n方式一：\nphp.ini\n```\nerror_reporting = E_ALL | E_STRICT  #指定显示错误级别\ndisplay_errors = On                 #错误信息显示控制\n```\n方式二：PHP代码中\n1. error_reporting(0),表示屏蔽所有错误信息。正式部署时采用这样的策略，来防止错误信息泄露敏感信息。\n2. @mysql_connect(),抑制错误信息输出。\n\n\n\n### PHP错误处理机制\n\n#### trigger_error\n该方法用于主动抛出一个错误。示例\n```php\n<?php\n  if(mt_rand(0,1) == 1){\n    triggererror(\"random no eq 0\",E_USER_ERROR);\n  }\n\n```\n\n#### set_error_handler\nPHP中提供了set_error_handler（）函数可以用来接管PHP错误处理。\n\n**set_error_handler(error_function, error_type);**\n- error_function,规定发生错误时运行的函数。（必须）\n- error_types,规定在哪个错误级别报告级别会显示用户定义的错误，（可选，默认『E_ALL』）\n\n示例：\n```php\n<?php\n  function customError($errNo, $errStr, $errFile, $errLine){\n    echo \"<b>错误代码：</b>[$errNo]{$errStr}\\r\\n\";\n    echo \"错误所在的代码行：{$errLine},文件:{$errFile}\\r\\n\";\n    echo \"PHP 版本 ，\".PHP_VERSION.\"(\".PHP_OS.\")\\r\\n\";\n    die();  //如果有必要，用户自定义的错误处理程序必须终止（die（）；）当前脚本。\n  }\n\n  set_error_handler(\"custonError\", E_ALL | E_STRICT);\n  $a = array('o' => 2,3,4,8);\n  echo $a[o]\n```\n\n自定义的错误处理函数一定要有这四个输入变量$errno, $errstr, $errfile, $errline.\n- errno,代表错误等级的一组常量。比如 E_WARNING 其二进制掩码为4，表示告警信息。\n\n**注意：** 自定义的错误处理函数并不能托管所有种类的错误，比如E_ERROR, E_PARSE, E_CORE_ERROR, E_CORE_WARNING, E_COMPILE_ERROR, E_COMPILE_WARNING,以及E_STRICT中的部分。\n\n**注意：** 如果使用自定义的 set_error_handler 接管PHP的错误处理，先前代码里的错误抑制 @ 也将会失效，这是这种错误也会被显示。\n\n#### restore_error_handler\n该函数可以取消 set_error_handler 的错误接管.\n\n\n## 结合PHP错误处理主动抛出异常\n\n结合PHP的错误处理机制和异常处理机制，通过组合也可以实现同时捕获异常和非致命错误。\n示例\n```php\n<?php\n  function customError($errNo, $errStr, $errFile, $errLine){\n    //自定义错误处理时，可以手动抛出异常\n    throw new Exception($level.\"|\".$errStr);\n  }\n  set_error_handler(\"custonError\", E_ALL | E_STRICT);\n  try{\n    $a = 5/0;\n  } catch(Exception $e){\n      echo \"错误信息\".$e->getMessage();\n  }\n```\n通过上面示例可以捕获到异常和非致命错误，但对于 fetal error 这样的错误却捕获不到。但是通过其他的一些方法，我们还是可以做一些处理。 register_shutdown_function 该函数会在程序终止或die时触发一个函数，我们可以利用该触发函数做一些最后的收尾操作。\n\n调用时机\n- 当页面被用户强制停止时\n- 当程序代码运行超时时\n- 当ＰＨＰ代码执行完成时，代码执行存在异常和错误、警告\n\nvoid register_shutdown_function ( callable $callback [, mixed $parameter [, mixed $... ]] )\n\n示例\n```php\n<?php\n  function shutdown()\n  {\n      // This is our shutdown function, in\n      // here we can do any last operations\n      // before the script is complete.\n      echo 'Script executed with success', PHP_EOL;\n  }\n  register_shutdown_function('shutdown');\n?>\n```\n\n对于 prase error 级别的错误，PHP层面就没有办法做什么了。我们只能通过开启错误日志，来记录这些错误。\n\nphp.ini设置\n```\nlog_errors = On\nerror_log = /usr/log/log.log\n```\n","source":"_posts/PHP异常和错误处理.md","raw":"---\ntitle: PHP异常和错误处理\ndate: 2016-09-30 23:10:00\ntags:\n- 异常处理\n- 错误处理\ncategories:\n- PHP\n---\n首先，需要明确以下这两个概念\n- 异常(exception)\n> PHP中的异常，是程序运行中不符合预期的情况及与正常流程不同的状况。\n> 是属于逻辑和业务流程的一种中断，而不是语法错误。\n\n- 错误(error)\n> PHP中的错误则属于自身的问题，是一种非法的语法或者环境问题导致的、让编译器无法通过检查甚至无法运行的情况。\n\n<!-- more -->\n\n## 异常处理\n\nPHP中玉带任何自身问题都会触发一个错误，而不是抛出异常。所以，如果想使用异常处理来处理不可预知的问题，这是PHP办不到的。但在处理一些可以预知的错误，PHP的异常处理机制还是能够帮我们解决一些问题的。例如：\n- 代码冗余复杂，到处充斥着if...else\n- 代码可读性差\n\n而异常处理，其主要作用是将『正常执行过程的代码』和『处理问题怎么处理的代码』进行分离。\n\n### PHP常见的异常类\n#### Exception\n> 所有异常的基类。\n\n类摘要\n```php\n<?php\n  Exception {\n    /* 属性 */\n    protected string $message ;     //异常消息内容\n    protected int $code ;           //异常代码\n    protected string $file ;        //抛出异常的文件名\n    protected int $line ;           //抛出异常在该文件中的行号\n    /* 方法 */\n    public __construct ([ string $message = \"\" [, int $code = 0 [, Exception $previous = NULL ]]] )           //异常构造函数\n    final public string getMessage ( void )    //获取异常消息内容\n    final public Exception getPrevious ( void )//返回异常链中的前一个异常\n    final public int getCode ( void )          //获取异常代码\n    final public string getFile ( void )       //获取发生异常的程序文件名称\n    final public int getLine ( void )          //获取发生异常的代码在文件中的行号\n    final public array getTrace ( void )       //获取异常追踪信息\n    final public string getTraceAsString ( void )//获取字符串类型的异常追踪信息\n    public string __toString ( void )            //将异常对象转换为字符串\n    final private void __clone ( void )          //异常克隆\n  }\n```\n\n#### 错误异常类\n\n类摘要\n```php\n<?php\n  ErrorException extends Exception {\n      /* 属性 */\n      protected int $severity ;     //异常级别\n      /* 方法 */\n      public __construct ([ string $message = \"\" [, int $code = 0 [, int $severity = 1 [, string $filename = __FILE__ [, int $lineno = __LINE__ [, Exception $previous = NULL ]]]]]] )   //异常构造函数\n      final public int getSeverity ( void )             // 获取异常的严重程度\n      /* 继承的方法 */\n      final public string Exception::getMessage ( void )\n      final public Exception Exception::getPrevious ( void )\n      final public int Exception::getCode ( void )\n      final public string Exception::getFile ( void )\n      final public int Exception::getLine ( void )\n      final public array Exception::getTrace ( void )\n      final public string Exception::getTraceAsString ( void )\n      public string Exception::__toString ( void )\n      final private void Exception::__clone ( void )\n  }\n```\n常见使用方式（使用set_error_handle()函数讲错误信息托管至ErrorException）\n```php\n<?php\nfunction exception_error_handler($errno, $errstr, $errfile, $errline ) {\n    throw new ErrorException($errstr, 0, $errno, $errfile, $errline);\n}\nset_error_handler(\"exception_error_handler\");\n/* Trigger exception 抛出异常 */\nstrpos();\n?>\n```\n\n#### 自定义异常类\n\n```php\n<?php\n/**\n * 自定义一个异常处理类\n */\nclass MyException extends Exception\n{\n    // 重定义构造器使 message 变为必须被指定的属性\n    public function __construct($message, $code = 0, Exception $previous = null) {\n        // 自定义的代码\n\n        // 确保所有变量都被正确赋值\n        parent::__construct($message, $code, $previous);\n    }\n    // 自定义字符串输出的样式\n    public function __toString() {\n        return __CLASS__ . \": [{$this->code}]: {$this->message}\\n\";\n    }\n    public function customFunction() {\n        echo \"A custom function for this type of exception\\n\";\n    }\n}\n```\n\n### PHP中异常用法\n>\n\n首先我们需要知道，***在PHP中只有手动抛出异常后才能捕获异常，对于抛出的异常只有进行捕获并作出相应的操作抛出异常才有意义，否则没有任何意义。***\n\n抛出异常\n```php\n<?php\n  function check($n){\n    if(empty($n)){\n      throw new Exception(\"参数错误\");\n    }\n  }\n```\n\n#### try...catch\n示例：关于上传操作的异常处理\n\n方式一：异常发生时立即捕获\n```php\n<?php\n  try{\n    //可能出现错误的代码\n    if(文件上传不成功)\n      throw (上传异常)；\n    if(更新数据库不成功)\n      throw (数据库异常操作)；\n  } catch(异常){\n    //必须的补救措施，例如删除文件、删除数据库记录\n    ...\n  }\n```\n方式二：分散抛出，集中捕获\n```php\n<?php\n  上传{\n    if(文件上传不成功) throw (上传异常)；\n    if(更新数据库不成功)  throw (数据库异常)；\n  }\n  其他{\n    if(其他操作失败) throw （其他操作异常）；\n  }\n  //其他代码...\n  try{\n      上传；\n      其他；\n  } catch(上传异常){\n      //上传异常处理、例如删除文件\n  } catch(数据库异常){\n      //数据库异常处理、比如删除数据库记录等\n  } catch(其他异常){\n      //其他异常处理，比如记录异常日志等\n  }\n```\n\n**需要注意，exception作为超类应该放在最后捕获**\n\n\n#### try...catch...finally\n示例：\n```php\n<?php\n  function inverse($x) {\n      if (!$x) {\n          throw new Exception('Division by zero.');\n      }\n      return 1/$x;\n  }\n  //\n  try {\n      echo inverse(5) . \"\\n\";\n  } catch (Exception $e) {\n      echo 'Caught exception: ',  $e->getMessage(), \"\\n\";\n  } finally {\n      echo \"First finally.\\n\";\n  }\n  //\n  try {\n      echo inverse(0) . \"\\n\";\n  } catch (Exception $e) {\n      echo 'Caught exception: ',  $e->getMessage(), \"\\n\";\n  } finally {\n      echo \"Second finally.\\n\";\n  }\n  //\n  // Continue execution\n  echo \"Hello World\\n\";\n?>\n\n```\n\n### PHP异常处理使用场景\n#### 对程序的悲观预测\n即当一个操作可能会由于一些不可控的因素（比如网络问题等），可能会出现执行不成功的情况。那么在种情况下就可以抛出异常，然后进行捕获，对异常情况进行细致的处理。\n#### 程序的需要和对业务的需要\n需要强调的是，异常是业务处理中必不可少的环节，我们不能对异常视而不见。\n需要用到异常处理的情况\n- 不希望业务代码中充斥着大量的打印、调试等处理；\n- 业务中自定义的异常，对现实生活中各种业务进行补充；\n- 对数据一致性有要求的业务操作中；\n\n异常处理机制可以把每一件事当做事务来考虑，还可以把异常处理当做成一种内建的恢复系统。\n\n\n\n#### 语言级别的健壮性要求\n我们都知道PHP在健壮性这一点是不足的。对很多异常是没有强制性限制的。所以很多异常需要我们自己来做。\n\n通过try...catch处理，我们可以把异常造成的逻辑中断破坏降低到最小的范围，并且经过补救处理后不影响业务逻辑的完整性；乱抛异常和只抛不捕获，或者捕获而不补救，都会导致数据混乱。\n\n\n\n\n## 错误处理\n### PHP中的错误级别\nPHP的错误有很多类，包括warning、notice、deprecated、fatal error等。\n\n常用到的错误级别\n- deprecated，是最低级别的错误，表示不推荐、不建议。其虽不影响PHP正常的业务流程，但一般情况下建议修正；\n- notice，通知级别错误。表示你语法中存在不恰当的地方。常见的是 使用未定义的变量就会报此错误。这种错误也影响PHP正常流程；\n- warning，警告级别错误，是比较高级别的错误，表示在语法中出现很不恰当的地方，比如函数参数不匹配。这种级别的错误可能会导致出现不可预期的结果，所以建议修正；\n- fetal error，致命错误。直接导致PHP流程终结，后面代码不在执行。\n- prase error，语法解析错误。导致PHP代码无法通过语法检查。\n\n错误信息显示控制\n方式一：\nphp.ini\n```\nerror_reporting = E_ALL | E_STRICT  #指定显示错误级别\ndisplay_errors = On                 #错误信息显示控制\n```\n方式二：PHP代码中\n1. error_reporting(0),表示屏蔽所有错误信息。正式部署时采用这样的策略，来防止错误信息泄露敏感信息。\n2. @mysql_connect(),抑制错误信息输出。\n\n\n\n### PHP错误处理机制\n\n#### trigger_error\n该方法用于主动抛出一个错误。示例\n```php\n<?php\n  if(mt_rand(0,1) == 1){\n    triggererror(\"random no eq 0\",E_USER_ERROR);\n  }\n\n```\n\n#### set_error_handler\nPHP中提供了set_error_handler（）函数可以用来接管PHP错误处理。\n\n**set_error_handler(error_function, error_type);**\n- error_function,规定发生错误时运行的函数。（必须）\n- error_types,规定在哪个错误级别报告级别会显示用户定义的错误，（可选，默认『E_ALL』）\n\n示例：\n```php\n<?php\n  function customError($errNo, $errStr, $errFile, $errLine){\n    echo \"<b>错误代码：</b>[$errNo]{$errStr}\\r\\n\";\n    echo \"错误所在的代码行：{$errLine},文件:{$errFile}\\r\\n\";\n    echo \"PHP 版本 ，\".PHP_VERSION.\"(\".PHP_OS.\")\\r\\n\";\n    die();  //如果有必要，用户自定义的错误处理程序必须终止（die（）；）当前脚本。\n  }\n\n  set_error_handler(\"custonError\", E_ALL | E_STRICT);\n  $a = array('o' => 2,3,4,8);\n  echo $a[o]\n```\n\n自定义的错误处理函数一定要有这四个输入变量$errno, $errstr, $errfile, $errline.\n- errno,代表错误等级的一组常量。比如 E_WARNING 其二进制掩码为4，表示告警信息。\n\n**注意：** 自定义的错误处理函数并不能托管所有种类的错误，比如E_ERROR, E_PARSE, E_CORE_ERROR, E_CORE_WARNING, E_COMPILE_ERROR, E_COMPILE_WARNING,以及E_STRICT中的部分。\n\n**注意：** 如果使用自定义的 set_error_handler 接管PHP的错误处理，先前代码里的错误抑制 @ 也将会失效，这是这种错误也会被显示。\n\n#### restore_error_handler\n该函数可以取消 set_error_handler 的错误接管.\n\n\n## 结合PHP错误处理主动抛出异常\n\n结合PHP的错误处理机制和异常处理机制，通过组合也可以实现同时捕获异常和非致命错误。\n示例\n```php\n<?php\n  function customError($errNo, $errStr, $errFile, $errLine){\n    //自定义错误处理时，可以手动抛出异常\n    throw new Exception($level.\"|\".$errStr);\n  }\n  set_error_handler(\"custonError\", E_ALL | E_STRICT);\n  try{\n    $a = 5/0;\n  } catch(Exception $e){\n      echo \"错误信息\".$e->getMessage();\n  }\n```\n通过上面示例可以捕获到异常和非致命错误，但对于 fetal error 这样的错误却捕获不到。但是通过其他的一些方法，我们还是可以做一些处理。 register_shutdown_function 该函数会在程序终止或die时触发一个函数，我们可以利用该触发函数做一些最后的收尾操作。\n\n调用时机\n- 当页面被用户强制停止时\n- 当程序代码运行超时时\n- 当ＰＨＰ代码执行完成时，代码执行存在异常和错误、警告\n\nvoid register_shutdown_function ( callable $callback [, mixed $parameter [, mixed $... ]] )\n\n示例\n```php\n<?php\n  function shutdown()\n  {\n      // This is our shutdown function, in\n      // here we can do any last operations\n      // before the script is complete.\n      echo 'Script executed with success', PHP_EOL;\n  }\n  register_shutdown_function('shutdown');\n?>\n```\n\n对于 prase error 级别的错误，PHP层面就没有办法做什么了。我们只能通过开启错误日志，来记录这些错误。\n\nphp.ini设置\n```\nlog_errors = On\nerror_log = /usr/log/log.log\n```\n","slug":"PHP异常和错误处理","published":1,"updated":"2016-09-30T15:11:50.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwt0033699fzycfwwkk","content":"<p>首先，需要明确以下这两个概念</p>\n<ul>\n<li><p>异常(exception)</p>\n<blockquote>\n<p>PHP中的异常，是程序运行中不符合预期的情况及与正常流程不同的状况。<br>是属于逻辑和业务流程的一种中断，而不是语法错误。</p>\n</blockquote>\n</li>\n<li><p>错误(error)</p>\n<blockquote>\n<p>PHP中的错误则属于自身的问题，是一种非法的语法或者环境问题导致的、让编译器无法通过检查甚至无法运行的情况。</p>\n</blockquote>\n</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"异常处理\"><a href=\"#异常处理\" class=\"headerlink\" title=\"异常处理\"></a>异常处理</h2><p>PHP中玉带任何自身问题都会触发一个错误，而不是抛出异常。所以，如果想使用异常处理来处理不可预知的问题，这是PHP办不到的。但在处理一些可以预知的错误，PHP的异常处理机制还是能够帮我们解决一些问题的。例如：</p>\n<ul>\n<li>代码冗余复杂，到处充斥着if…else</li>\n<li>代码可读性差</li>\n</ul>\n<p>而异常处理，其主要作用是将『正常执行过程的代码』和『处理问题怎么处理的代码』进行分离。</p>\n<h3 id=\"PHP常见的异常类\"><a href=\"#PHP常见的异常类\" class=\"headerlink\" title=\"PHP常见的异常类\"></a>PHP常见的异常类</h3><h4 id=\"Exception\"><a href=\"#Exception\" class=\"headerlink\" title=\"Exception\"></a>Exception</h4><blockquote>\n<p>所有异常的基类。</p>\n</blockquote>\n<p>类摘要<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"keyword\">Exception</span> &#123;</div><div class=\"line\">    <span class=\"comment\">/* 属性 */</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> string $message ;     <span class=\"comment\">//异常消息内容</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> int $code ;           <span class=\"comment\">//异常代码</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> string $file ;        <span class=\"comment\">//抛出异常的文件名</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> int $line ;           <span class=\"comment\">//抛出异常在该文件中的行号</span></div><div class=\"line\">    <span class=\"comment\">/* 方法 */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> __construct ([ string $message = <span class=\"string\">\"\"</span> [, int $code = <span class=\"number\">0</span> [, <span class=\"keyword\">Exception</span> $previous = <span class=\"keyword\">NULL</span> ]]] )           <span class=\"comment\">//异常构造函数</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string getMessage ( void )    <span class=\"comment\">//获取异常消息内容</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">Exception</span> getPrevious ( void )<span class=\"comment\">//返回异常链中的前一个异常</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int getCode ( void )          <span class=\"comment\">//获取异常代码</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string getFile ( void )       <span class=\"comment\">//获取发生异常的程序文件名称</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int getLine ( void )          <span class=\"comment\">//获取发生异常的代码在文件中的行号</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">array</span> getTrace ( void )       <span class=\"comment\">//获取异常追踪信息</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string getTraceAsString ( void )<span class=\"comment\">//获取字符串类型的异常追踪信息</span></div><div class=\"line\">    <span class=\"keyword\">public</span> string __toString ( void )            <span class=\"comment\">//将异常对象转换为字符串</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">private</span> void __clone ( void )          <span class=\"comment\">//异常克隆</span></div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"错误异常类\"><a href=\"#错误异常类\" class=\"headerlink\" title=\"错误异常类\"></a>错误异常类</h4><p>类摘要<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  ErrorException extends <span class=\"keyword\">Exception</span> &#123;</div><div class=\"line\">      <span class=\"comment\">/* 属性 */</span></div><div class=\"line\">      <span class=\"keyword\">protected</span> int $severity ;     <span class=\"comment\">//异常级别</span></div><div class=\"line\">      <span class=\"comment\">/* 方法 */</span></div><div class=\"line\">      <span class=\"keyword\">public</span> __construct ([ string $message = <span class=\"string\">\"\"</span> [, int $code = <span class=\"number\">0</span> [, int $severity = <span class=\"number\">1</span> [, string $filename = <span class=\"keyword\">__FILE__</span> [, int $lineno = <span class=\"keyword\">__LINE__</span> [, <span class=\"keyword\">Exception</span> $previous = <span class=\"keyword\">NULL</span> ]]]]]] )   <span class=\"comment\">//异常构造函数</span></div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int getSeverity ( void )             <span class=\"comment\">// 获取异常的严重程度</span></div><div class=\"line\">      <span class=\"comment\">/* 继承的方法 */</span></div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::getMessage ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">Exception</span> <span class=\"keyword\">Exception</span>::getPrevious ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int <span class=\"keyword\">Exception</span>::getCode ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::getFile ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int <span class=\"keyword\">Exception</span>::getLine ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">array</span> <span class=\"keyword\">Exception</span>::getTrace ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::getTraceAsString ( void )</div><div class=\"line\">      <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::__toString ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">private</span> void <span class=\"keyword\">Exception</span>::__clone ( void )</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p>常见使用方式（使用set_error_handle()函数讲错误信息托管至ErrorException）<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exception_error_handler</span><span class=\"params\">($errno, $errstr, $errfile, $errline )</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ErrorException($errstr, <span class=\"number\">0</span>, $errno, $errfile, $errline);</div><div class=\"line\">&#125;</div><div class=\"line\">set_error_handler(<span class=\"string\">\"exception_error_handler\"</span>);</div><div class=\"line\"><span class=\"comment\">/* Trigger exception 抛出异常 */</span></div><div class=\"line\">strpos();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<h4 id=\"自定义异常类\"><a href=\"#自定义异常类\" class=\"headerlink\" title=\"自定义异常类\"></a>自定义异常类</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"comment\">/**</span></div><div class=\"line\"> * 自定义一个异常处理类</div><div class=\"line\"> */</div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyException</span> <span class=\"keyword\">extends</span> <span class=\"title\">Exception</span></span></div><div class=\"line\">&#123;</div><div class=\"line\">    <span class=\"comment\">// 重定义构造器使 message 变为必须被指定的属性</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($message, $code = <span class=\"number\">0</span>, Exception $previous = null)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// 自定义的代码</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 确保所有变量都被正确赋值</span></div><div class=\"line\">        <span class=\"keyword\">parent</span>::__construct($message, $code, $previous);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"comment\">// 自定义字符串输出的样式</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\": [&#123;$this-&gt;code&#125;]: &#123;$this-&gt;message&#125;\\n\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">customFunction</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"A custom function for this type of exception\\n\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"PHP中异常用法\"><a href=\"#PHP中异常用法\" class=\"headerlink\" title=\"PHP中异常用法\"></a>PHP中异常用法</h3><p>&gt;</p>\n<p>首先我们需要知道，<strong><em>在PHP中只有手动抛出异常后才能捕获异常，对于抛出的异常只有进行捕获并作出相应的操作抛出异常才有意义，否则没有任何意义。</em></strong></p>\n<p>抛出异常<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check</span><span class=\"params\">($n)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($n))&#123;</div><div class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">\"参数错误\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"try…catch\"><a href=\"#try…catch\" class=\"headerlink\" title=\"try…catch\"></a>try…catch</h4><p>示例：关于上传操作的异常处理</p>\n<p>方式一：异常发生时立即捕获<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"keyword\">try</span>&#123;</div><div class=\"line\">    <span class=\"comment\">//可能出现错误的代码</span></div><div class=\"line\">    <span class=\"keyword\">if</span>(文件上传不成功)</div><div class=\"line\">      <span class=\"keyword\">throw</span> (上传异常)；</div><div class=\"line\">    <span class=\"keyword\">if</span>(更新数据库不成功)</div><div class=\"line\">      <span class=\"keyword\">throw</span> (数据库异常操作)；</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(异常)&#123;</div><div class=\"line\">    <span class=\"comment\">//必须的补救措施，例如删除文件、删除数据库记录</span></div><div class=\"line\">    ...</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p>方式二：分散抛出，集中捕获<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  上传&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(文件上传不成功) <span class=\"keyword\">throw</span> (上传异常)；</div><div class=\"line\">    <span class=\"keyword\">if</span>(更新数据库不成功)  <span class=\"keyword\">throw</span> (数据库异常)；</div><div class=\"line\">  &#125;</div><div class=\"line\">  其他&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(其他操作失败) <span class=\"keyword\">throw</span> （其他操作异常）；</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//其他代码...</span></div><div class=\"line\">  <span class=\"keyword\">try</span>&#123;</div><div class=\"line\">      上传；</div><div class=\"line\">      其他；</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(上传异常)&#123;</div><div class=\"line\">      <span class=\"comment\">//上传异常处理、例如删除文件</span></div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(数据库异常)&#123;</div><div class=\"line\">      <span class=\"comment\">//数据库异常处理、比如删除数据库记录等</span></div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(其他异常)&#123;</div><div class=\"line\">      <span class=\"comment\">//其他异常处理，比如记录异常日志等</span></div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p><strong>需要注意，exception作为超类应该放在最后捕获</strong></p>\n<h4 id=\"try…catch…finally\"><a href=\"#try…catch…finally\" class=\"headerlink\" title=\"try…catch…finally\"></a>try…catch…finally</h4><p>示例：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inverse</span><span class=\"params\">($x)</span> </span>&#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (!$x) &#123;</div><div class=\"line\">          <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">'Division by zero.'</span>);</div><div class=\"line\">      &#125;</div><div class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span>/$x;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> inverse(<span class=\"number\">5</span>) . <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">Exception</span> $e) &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">'Caught exception: '</span>,  $e-&gt;getMessage(), <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">\"First finally.\\n\"</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> inverse(<span class=\"number\">0</span>) . <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">Exception</span> $e) &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">'Caught exception: '</span>,  $e-&gt;getMessage(), <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">\"Second finally.\\n\"</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// Continue execution</span></div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"Hello World\\n\"</span>;</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"PHP异常处理使用场景\"><a href=\"#PHP异常处理使用场景\" class=\"headerlink\" title=\"PHP异常处理使用场景\"></a>PHP异常处理使用场景</h3><h4 id=\"对程序的悲观预测\"><a href=\"#对程序的悲观预测\" class=\"headerlink\" title=\"对程序的悲观预测\"></a>对程序的悲观预测</h4><p>即当一个操作可能会由于一些不可控的因素（比如网络问题等），可能会出现执行不成功的情况。那么在种情况下就可以抛出异常，然后进行捕获，对异常情况进行细致的处理。</p>\n<h4 id=\"程序的需要和对业务的需要\"><a href=\"#程序的需要和对业务的需要\" class=\"headerlink\" title=\"程序的需要和对业务的需要\"></a>程序的需要和对业务的需要</h4><p>需要强调的是，异常是业务处理中必不可少的环节，我们不能对异常视而不见。<br>需要用到异常处理的情况</p>\n<ul>\n<li>不希望业务代码中充斥着大量的打印、调试等处理；</li>\n<li>业务中自定义的异常，对现实生活中各种业务进行补充；</li>\n<li>对数据一致性有要求的业务操作中；</li>\n</ul>\n<p>异常处理机制可以把每一件事当做事务来考虑，还可以把异常处理当做成一种内建的恢复系统。</p>\n<h4 id=\"语言级别的健壮性要求\"><a href=\"#语言级别的健壮性要求\" class=\"headerlink\" title=\"语言级别的健壮性要求\"></a>语言级别的健壮性要求</h4><p>我们都知道PHP在健壮性这一点是不足的。对很多异常是没有强制性限制的。所以很多异常需要我们自己来做。</p>\n<p>通过try…catch处理，我们可以把异常造成的逻辑中断破坏降低到最小的范围，并且经过补救处理后不影响业务逻辑的完整性；乱抛异常和只抛不捕获，或者捕获而不补救，都会导致数据混乱。</p>\n<h2 id=\"错误处理\"><a href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"></a>错误处理</h2><h3 id=\"PHP中的错误级别\"><a href=\"#PHP中的错误级别\" class=\"headerlink\" title=\"PHP中的错误级别\"></a>PHP中的错误级别</h3><p>PHP的错误有很多类，包括warning、notice、deprecated、fatal error等。</p>\n<p>常用到的错误级别</p>\n<ul>\n<li>deprecated，是最低级别的错误，表示不推荐、不建议。其虽不影响PHP正常的业务流程，但一般情况下建议修正；</li>\n<li>notice，通知级别错误。表示你语法中存在不恰当的地方。常见的是 使用未定义的变量就会报此错误。这种错误也影响PHP正常流程；</li>\n<li>warning，警告级别错误，是比较高级别的错误，表示在语法中出现很不恰当的地方，比如函数参数不匹配。这种级别的错误可能会导致出现不可预期的结果，所以建议修正；</li>\n<li>fetal error，致命错误。直接导致PHP流程终结，后面代码不在执行。</li>\n<li>prase error，语法解析错误。导致PHP代码无法通过语法检查。</li>\n</ul>\n<p>错误信息显示控制<br>方式一：<br>php.ini<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">error_reporting = E_ALL | E_STRICT  #指定显示错误级别</div><div class=\"line\">display_errors = On                 #错误信息显示控制</div></pre></td></tr></table></figure></p>\n<p>方式二：PHP代码中</p>\n<ol>\n<li>error_reporting(0),表示屏蔽所有错误信息。正式部署时采用这样的策略，来防止错误信息泄露敏感信息。</li>\n<li>@mysql_connect(),抑制错误信息输出。</li>\n</ol>\n<h3 id=\"PHP错误处理机制\"><a href=\"#PHP错误处理机制\" class=\"headerlink\" title=\"PHP错误处理机制\"></a>PHP错误处理机制</h3><h4 id=\"trigger-error\"><a href=\"#trigger-error\" class=\"headerlink\" title=\"trigger_error\"></a>trigger_error</h4><p>该方法用于主动抛出一个错误。示例<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"keyword\">if</span>(mt_rand(<span class=\"number\">0</span>,<span class=\"number\">1</span>) == <span class=\"number\">1</span>)&#123;</div><div class=\"line\">    triggererror(<span class=\"string\">\"random no eq 0\"</span>,E_USER_ERROR);</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"set-error-handler\"><a href=\"#set-error-handler\" class=\"headerlink\" title=\"set_error_handler\"></a>set_error_handler</h4><p>PHP中提供了set_error_handler（）函数可以用来接管PHP错误处理。</p>\n<p><strong>set_error_handler(error_function, error_type);</strong></p>\n<ul>\n<li>error_function,规定发生错误时运行的函数。（必须）</li>\n<li>error_types,规定在哪个错误级别报告级别会显示用户定义的错误，（可选，默认『E_ALL』）</li>\n</ul>\n<p>示例：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">customError</span><span class=\"params\">($errNo, $errStr, $errFile, $errLine)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;b&gt;错误代码：&lt;/b&gt;[$errNo]&#123;$errStr&#125;\\r\\n\"</span>;</div><div class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"错误所在的代码行：&#123;$errLine&#125;,文件:&#123;$errFile&#125;\\r\\n\"</span>;</div><div class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"PHP 版本 ，\"</span>.PHP_VERSION.<span class=\"string\">\"(\"</span>.PHP_OS.<span class=\"string\">\")\\r\\n\"</span>;</div><div class=\"line\">    <span class=\"keyword\">die</span>();  <span class=\"comment\">//如果有必要，用户自定义的错误处理程序必须终止（die（）；）当前脚本。</span></div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  set_error_handler(<span class=\"string\">\"custonError\"</span>, E_ALL | E_STRICT);</div><div class=\"line\">  $a = <span class=\"keyword\">array</span>(<span class=\"string\">'o'</span> =&gt; <span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">8</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> $a[o]</div></pre></td></tr></table></figure></p>\n<p>自定义的错误处理函数一定要有这四个输入变量$errno, $errstr, $errfile, $errline.</p>\n<ul>\n<li>errno,代表错误等级的一组常量。比如 E_WARNING 其二进制掩码为4，表示告警信息。</li>\n</ul>\n<p><strong>注意：</strong> 自定义的错误处理函数并不能托管所有种类的错误，比如E_ERROR, E_PARSE, E_CORE_ERROR, E_CORE_WARNING, E_COMPILE_ERROR, E_COMPILE_WARNING,以及E_STRICT中的部分。</p>\n<p><strong>注意：</strong> 如果使用自定义的 set_error_handler 接管PHP的错误处理，先前代码里的错误抑制 @ 也将会失效，这是这种错误也会被显示。</p>\n<h4 id=\"restore-error-handler\"><a href=\"#restore-error-handler\" class=\"headerlink\" title=\"restore_error_handler\"></a>restore_error_handler</h4><p>该函数可以取消 set_error_handler 的错误接管.</p>\n<h2 id=\"结合PHP错误处理主动抛出异常\"><a href=\"#结合PHP错误处理主动抛出异常\" class=\"headerlink\" title=\"结合PHP错误处理主动抛出异常\"></a>结合PHP错误处理主动抛出异常</h2><p>结合PHP的错误处理机制和异常处理机制，通过组合也可以实现同时捕获异常和非致命错误。<br>示例<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">customError</span><span class=\"params\">($errNo, $errStr, $errFile, $errLine)</span></span>&#123;</div><div class=\"line\">    <span class=\"comment\">//自定义错误处理时，可以手动抛出异常</span></div><div class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>($level.<span class=\"string\">\"|\"</span>.$errStr);</div><div class=\"line\">  &#125;</div><div class=\"line\">  set_error_handler(<span class=\"string\">\"custonError\"</span>, E_ALL | E_STRICT);</div><div class=\"line\">  <span class=\"keyword\">try</span>&#123;</div><div class=\"line\">    $a = <span class=\"number\">5</span>/<span class=\"number\">0</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(<span class=\"keyword\">Exception</span> $e)&#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">\"错误信息\"</span>.$e-&gt;getMessage();</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p>通过上面示例可以捕获到异常和非致命错误，但对于 fetal error 这样的错误却捕获不到。但是通过其他的一些方法，我们还是可以做一些处理。 register_shutdown_function 该函数会在程序终止或die时触发一个函数，我们可以利用该触发函数做一些最后的收尾操作。</p>\n<p>调用时机</p>\n<ul>\n<li>当页面被用户强制停止时</li>\n<li>当程序代码运行超时时</li>\n<li>当ＰＨＰ代码执行完成时，代码执行存在异常和错误、警告</li>\n</ul>\n<p>void register_shutdown_function ( callable $callback [, mixed $parameter [, mixed $… ]] )</p>\n<p>示例<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span></span></div><div class=\"line\">  &#123;</div><div class=\"line\">      <span class=\"comment\">// This is our shutdown function, in</span></div><div class=\"line\">      <span class=\"comment\">// here we can do any last operations</span></div><div class=\"line\">      <span class=\"comment\">// before the script is complete.</span></div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">'Script executed with success'</span>, PHP_EOL;</div><div class=\"line\">  &#125;</div><div class=\"line\">  register_shutdown_function(<span class=\"string\">'shutdown'</span>);</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p>对于 prase error 级别的错误，PHP层面就没有办法做什么了。我们只能通过开启错误日志，来记录这些错误。</p>\n<p>php.ini设置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">log_errors = On</div><div class=\"line\">error_log = /usr/log/log.log</div></pre></td></tr></table></figure></p>\n","excerpt":"<p>首先，需要明确以下这两个概念</p>\n<ul>\n<li><p>异常(exception)</p>\n<blockquote>\n<p>PHP中的异常，是程序运行中不符合预期的情况及与正常流程不同的状况。<br>是属于逻辑和业务流程的一种中断，而不是语法错误。</p>\n</blockquote>\n</li>\n<li><p>错误(error)</p>\n<blockquote>\n<p>PHP中的错误则属于自身的问题，是一种非法的语法或者环境问题导致的、让编译器无法通过检查甚至无法运行的情况。</p>\n</blockquote>\n</li>\n</ul>","more":"<h2 id=\"异常处理\"><a href=\"#异常处理\" class=\"headerlink\" title=\"异常处理\"></a>异常处理</h2><p>PHP中玉带任何自身问题都会触发一个错误，而不是抛出异常。所以，如果想使用异常处理来处理不可预知的问题，这是PHP办不到的。但在处理一些可以预知的错误，PHP的异常处理机制还是能够帮我们解决一些问题的。例如：</p>\n<ul>\n<li>代码冗余复杂，到处充斥着if…else</li>\n<li>代码可读性差</li>\n</ul>\n<p>而异常处理，其主要作用是将『正常执行过程的代码』和『处理问题怎么处理的代码』进行分离。</p>\n<h3 id=\"PHP常见的异常类\"><a href=\"#PHP常见的异常类\" class=\"headerlink\" title=\"PHP常见的异常类\"></a>PHP常见的异常类</h3><h4 id=\"Exception\"><a href=\"#Exception\" class=\"headerlink\" title=\"Exception\"></a>Exception</h4><blockquote>\n<p>所有异常的基类。</p>\n</blockquote>\n<p>类摘要<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"keyword\">Exception</span> &#123;</div><div class=\"line\">    <span class=\"comment\">/* 属性 */</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> string $message ;     <span class=\"comment\">//异常消息内容</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> int $code ;           <span class=\"comment\">//异常代码</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> string $file ;        <span class=\"comment\">//抛出异常的文件名</span></div><div class=\"line\">    <span class=\"keyword\">protected</span> int $line ;           <span class=\"comment\">//抛出异常在该文件中的行号</span></div><div class=\"line\">    <span class=\"comment\">/* 方法 */</span></div><div class=\"line\">    <span class=\"keyword\">public</span> __construct ([ string $message = <span class=\"string\">\"\"</span> [, int $code = <span class=\"number\">0</span> [, <span class=\"keyword\">Exception</span> $previous = <span class=\"keyword\">NULL</span> ]]] )           <span class=\"comment\">//异常构造函数</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string getMessage ( void )    <span class=\"comment\">//获取异常消息内容</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">Exception</span> getPrevious ( void )<span class=\"comment\">//返回异常链中的前一个异常</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int getCode ( void )          <span class=\"comment\">//获取异常代码</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string getFile ( void )       <span class=\"comment\">//获取发生异常的程序文件名称</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int getLine ( void )          <span class=\"comment\">//获取发生异常的代码在文件中的行号</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">array</span> getTrace ( void )       <span class=\"comment\">//获取异常追踪信息</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string getTraceAsString ( void )<span class=\"comment\">//获取字符串类型的异常追踪信息</span></div><div class=\"line\">    <span class=\"keyword\">public</span> string __toString ( void )            <span class=\"comment\">//将异常对象转换为字符串</span></div><div class=\"line\">    <span class=\"keyword\">final</span> <span class=\"keyword\">private</span> void __clone ( void )          <span class=\"comment\">//异常克隆</span></div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"错误异常类\"><a href=\"#错误异常类\" class=\"headerlink\" title=\"错误异常类\"></a>错误异常类</h4><p>类摘要<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  ErrorException extends <span class=\"keyword\">Exception</span> &#123;</div><div class=\"line\">      <span class=\"comment\">/* 属性 */</span></div><div class=\"line\">      <span class=\"keyword\">protected</span> int $severity ;     <span class=\"comment\">//异常级别</span></div><div class=\"line\">      <span class=\"comment\">/* 方法 */</span></div><div class=\"line\">      <span class=\"keyword\">public</span> __construct ([ string $message = <span class=\"string\">\"\"</span> [, int $code = <span class=\"number\">0</span> [, int $severity = <span class=\"number\">1</span> [, string $filename = <span class=\"keyword\">__FILE__</span> [, int $lineno = <span class=\"keyword\">__LINE__</span> [, <span class=\"keyword\">Exception</span> $previous = <span class=\"keyword\">NULL</span> ]]]]]] )   <span class=\"comment\">//异常构造函数</span></div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int getSeverity ( void )             <span class=\"comment\">// 获取异常的严重程度</span></div><div class=\"line\">      <span class=\"comment\">/* 继承的方法 */</span></div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::getMessage ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">Exception</span> <span class=\"keyword\">Exception</span>::getPrevious ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int <span class=\"keyword\">Exception</span>::getCode ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::getFile ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> int <span class=\"keyword\">Exception</span>::getLine ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> <span class=\"keyword\">array</span> <span class=\"keyword\">Exception</span>::getTrace ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::getTraceAsString ( void )</div><div class=\"line\">      <span class=\"keyword\">public</span> string <span class=\"keyword\">Exception</span>::__toString ( void )</div><div class=\"line\">      <span class=\"keyword\">final</span> <span class=\"keyword\">private</span> void <span class=\"keyword\">Exception</span>::__clone ( void )</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p>常见使用方式（使用set_error_handle()函数讲错误信息托管至ErrorException）<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">exception_error_handler</span><span class=\"params\">($errno, $errstr, $errfile, $errline )</span> </span>&#123;</div><div class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> ErrorException($errstr, <span class=\"number\">0</span>, $errno, $errfile, $errline);</div><div class=\"line\">&#125;</div><div class=\"line\">set_error_handler(<span class=\"string\">\"exception_error_handler\"</span>);</div><div class=\"line\"><span class=\"comment\">/* Trigger exception 抛出异常 */</span></div><div class=\"line\">strpos();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<h4 id=\"自定义异常类\"><a href=\"#自定义异常类\" class=\"headerlink\" title=\"自定义异常类\"></a>自定义异常类</h4><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"><span class=\"comment\">/**</div><div class=\"line\"> * 自定义一个异常处理类</div><div class=\"line\"> */</span></div><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyException</span> <span class=\"keyword\">extends</span> <span class=\"title\">Exception</span></div><div class=\"line\"></span>&#123;</div><div class=\"line\">    <span class=\"comment\">// 重定义构造器使 message 变为必须被指定的属性</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($message, $code = <span class=\"number\">0</span>, Exception $previous = null)</span> </span>&#123;</div><div class=\"line\">        <span class=\"comment\">// 自定义的代码</span></div><div class=\"line\"></div><div class=\"line\">        <span class=\"comment\">// 确保所有变量都被正确赋值</span></div><div class=\"line\">        <span class=\"keyword\">parent</span>::__construct($message, $code, $previous);</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"comment\">// 自定义字符串输出的样式</span></div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">__CLASS__</span> . <span class=\"string\">\": [&#123;$this-&gt;code&#125;]: &#123;$this-&gt;message&#125;\\n\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">customFunction</span><span class=\"params\">()</span> </span>&#123;</div><div class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"A custom function for this type of exception\\n\"</span>;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<h3 id=\"PHP中异常用法\"><a href=\"#PHP中异常用法\" class=\"headerlink\" title=\"PHP中异常用法\"></a>PHP中异常用法</h3><p>&gt;</p>\n<p>首先我们需要知道，<strong><em>在PHP中只有手动抛出异常后才能捕获异常，对于抛出的异常只有进行捕获并作出相应的操作抛出异常才有意义，否则没有任何意义。</em></strong></p>\n<p>抛出异常<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check</span><span class=\"params\">($n)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">empty</span>($n))&#123;</div><div class=\"line\">      <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">\"参数错误\"</span>);</div><div class=\"line\">    &#125;</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"try…catch\"><a href=\"#try…catch\" class=\"headerlink\" title=\"try…catch\"></a>try…catch</h4><p>示例：关于上传操作的异常处理</p>\n<p>方式一：异常发生时立即捕获<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"keyword\">try</span>&#123;</div><div class=\"line\">    <span class=\"comment\">//可能出现错误的代码</span></div><div class=\"line\">    <span class=\"keyword\">if</span>(文件上传不成功)</div><div class=\"line\">      <span class=\"keyword\">throw</span> (上传异常)；</div><div class=\"line\">    <span class=\"keyword\">if</span>(更新数据库不成功)</div><div class=\"line\">      <span class=\"keyword\">throw</span> (数据库异常操作)；</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(异常)&#123;</div><div class=\"line\">    <span class=\"comment\">//必须的补救措施，例如删除文件、删除数据库记录</span></div><div class=\"line\">    ...</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p>方式二：分散抛出，集中捕获<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  上传&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(文件上传不成功) <span class=\"keyword\">throw</span> (上传异常)；</div><div class=\"line\">    <span class=\"keyword\">if</span>(更新数据库不成功)  <span class=\"keyword\">throw</span> (数据库异常)；</div><div class=\"line\">  &#125;</div><div class=\"line\">  其他&#123;</div><div class=\"line\">    <span class=\"keyword\">if</span>(其他操作失败) <span class=\"keyword\">throw</span> （其他操作异常）；</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//其他代码...</span></div><div class=\"line\">  <span class=\"keyword\">try</span>&#123;</div><div class=\"line\">      上传；</div><div class=\"line\">      其他；</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(上传异常)&#123;</div><div class=\"line\">      <span class=\"comment\">//上传异常处理、例如删除文件</span></div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(数据库异常)&#123;</div><div class=\"line\">      <span class=\"comment\">//数据库异常处理、比如删除数据库记录等</span></div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(其他异常)&#123;</div><div class=\"line\">      <span class=\"comment\">//其他异常处理，比如记录异常日志等</span></div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p><strong>需要注意，exception作为超类应该放在最后捕获</strong></p>\n<h4 id=\"try…catch…finally\"><a href=\"#try…catch…finally\" class=\"headerlink\" title=\"try…catch…finally\"></a>try…catch…finally</h4><p>示例：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">inverse</span><span class=\"params\">($x)</span> </span>&#123;</div><div class=\"line\">      <span class=\"keyword\">if</span> (!$x) &#123;</div><div class=\"line\">          <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>(<span class=\"string\">'Division by zero.'</span>);</div><div class=\"line\">      &#125;</div><div class=\"line\">      <span class=\"keyword\">return</span> <span class=\"number\">1</span>/$x;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> inverse(<span class=\"number\">5</span>) . <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">Exception</span> $e) &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">'Caught exception: '</span>,  $e-&gt;getMessage(), <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">\"First finally.\\n\"</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"keyword\">try</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> inverse(<span class=\"number\">0</span>) . <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span> (<span class=\"keyword\">Exception</span> $e) &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">'Caught exception: '</span>,  $e-&gt;getMessage(), <span class=\"string\">\"\\n\"</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">finally</span> &#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">\"Second finally.\\n\"</span>;</div><div class=\"line\">  &#125;</div><div class=\"line\">  <span class=\"comment\">//</span></div><div class=\"line\">  <span class=\"comment\">// Continue execution</span></div><div class=\"line\">  <span class=\"keyword\">echo</span> <span class=\"string\">\"Hello World\\n\"</span>;</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<h3 id=\"PHP异常处理使用场景\"><a href=\"#PHP异常处理使用场景\" class=\"headerlink\" title=\"PHP异常处理使用场景\"></a>PHP异常处理使用场景</h3><h4 id=\"对程序的悲观预测\"><a href=\"#对程序的悲观预测\" class=\"headerlink\" title=\"对程序的悲观预测\"></a>对程序的悲观预测</h4><p>即当一个操作可能会由于一些不可控的因素（比如网络问题等），可能会出现执行不成功的情况。那么在种情况下就可以抛出异常，然后进行捕获，对异常情况进行细致的处理。</p>\n<h4 id=\"程序的需要和对业务的需要\"><a href=\"#程序的需要和对业务的需要\" class=\"headerlink\" title=\"程序的需要和对业务的需要\"></a>程序的需要和对业务的需要</h4><p>需要强调的是，异常是业务处理中必不可少的环节，我们不能对异常视而不见。<br>需要用到异常处理的情况</p>\n<ul>\n<li>不希望业务代码中充斥着大量的打印、调试等处理；</li>\n<li>业务中自定义的异常，对现实生活中各种业务进行补充；</li>\n<li>对数据一致性有要求的业务操作中；</li>\n</ul>\n<p>异常处理机制可以把每一件事当做事务来考虑，还可以把异常处理当做成一种内建的恢复系统。</p>\n<h4 id=\"语言级别的健壮性要求\"><a href=\"#语言级别的健壮性要求\" class=\"headerlink\" title=\"语言级别的健壮性要求\"></a>语言级别的健壮性要求</h4><p>我们都知道PHP在健壮性这一点是不足的。对很多异常是没有强制性限制的。所以很多异常需要我们自己来做。</p>\n<p>通过try…catch处理，我们可以把异常造成的逻辑中断破坏降低到最小的范围，并且经过补救处理后不影响业务逻辑的完整性；乱抛异常和只抛不捕获，或者捕获而不补救，都会导致数据混乱。</p>\n<h2 id=\"错误处理\"><a href=\"#错误处理\" class=\"headerlink\" title=\"错误处理\"></a>错误处理</h2><h3 id=\"PHP中的错误级别\"><a href=\"#PHP中的错误级别\" class=\"headerlink\" title=\"PHP中的错误级别\"></a>PHP中的错误级别</h3><p>PHP的错误有很多类，包括warning、notice、deprecated、fatal error等。</p>\n<p>常用到的错误级别</p>\n<ul>\n<li>deprecated，是最低级别的错误，表示不推荐、不建议。其虽不影响PHP正常的业务流程，但一般情况下建议修正；</li>\n<li>notice，通知级别错误。表示你语法中存在不恰当的地方。常见的是 使用未定义的变量就会报此错误。这种错误也影响PHP正常流程；</li>\n<li>warning，警告级别错误，是比较高级别的错误，表示在语法中出现很不恰当的地方，比如函数参数不匹配。这种级别的错误可能会导致出现不可预期的结果，所以建议修正；</li>\n<li>fetal error，致命错误。直接导致PHP流程终结，后面代码不在执行。</li>\n<li>prase error，语法解析错误。导致PHP代码无法通过语法检查。</li>\n</ul>\n<p>错误信息显示控制<br>方式一：<br>php.ini<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">error_reporting = E_ALL | E_STRICT  #指定显示错误级别</div><div class=\"line\">display_errors = On                 #错误信息显示控制</div></pre></td></tr></table></figure></p>\n<p>方式二：PHP代码中</p>\n<ol>\n<li>error_reporting(0),表示屏蔽所有错误信息。正式部署时采用这样的策略，来防止错误信息泄露敏感信息。</li>\n<li>@mysql_connect(),抑制错误信息输出。</li>\n</ol>\n<h3 id=\"PHP错误处理机制\"><a href=\"#PHP错误处理机制\" class=\"headerlink\" title=\"PHP错误处理机制\"></a>PHP错误处理机制</h3><h4 id=\"trigger-error\"><a href=\"#trigger-error\" class=\"headerlink\" title=\"trigger_error\"></a>trigger_error</h4><p>该方法用于主动抛出一个错误。示例<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"keyword\">if</span>(mt_rand(<span class=\"number\">0</span>,<span class=\"number\">1</span>) == <span class=\"number\">1</span>)&#123;</div><div class=\"line\">    triggererror(<span class=\"string\">\"random no eq 0\"</span>,E_USER_ERROR);</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<h4 id=\"set-error-handler\"><a href=\"#set-error-handler\" class=\"headerlink\" title=\"set_error_handler\"></a>set_error_handler</h4><p>PHP中提供了set_error_handler（）函数可以用来接管PHP错误处理。</p>\n<p><strong>set_error_handler(error_function, error_type);</strong></p>\n<ul>\n<li>error_function,规定发生错误时运行的函数。（必须）</li>\n<li>error_types,规定在哪个错误级别报告级别会显示用户定义的错误，（可选，默认『E_ALL』）</li>\n</ul>\n<p>示例：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">customError</span><span class=\"params\">($errNo, $errStr, $errFile, $errLine)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;b&gt;错误代码：&lt;/b&gt;[$errNo]&#123;$errStr&#125;\\r\\n\"</span>;</div><div class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"错误所在的代码行：&#123;$errLine&#125;,文件:&#123;$errFile&#125;\\r\\n\"</span>;</div><div class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"PHP 版本 ，\"</span>.PHP_VERSION.<span class=\"string\">\"(\"</span>.PHP_OS.<span class=\"string\">\")\\r\\n\"</span>;</div><div class=\"line\">    <span class=\"keyword\">die</span>();  <span class=\"comment\">//如果有必要，用户自定义的错误处理程序必须终止（die（）；）当前脚本。</span></div><div class=\"line\">  &#125;</div><div class=\"line\"></div><div class=\"line\">  set_error_handler(<span class=\"string\">\"custonError\"</span>, E_ALL | E_STRICT);</div><div class=\"line\">  $a = <span class=\"keyword\">array</span>(<span class=\"string\">'o'</span> =&gt; <span class=\"number\">2</span>,<span class=\"number\">3</span>,<span class=\"number\">4</span>,<span class=\"number\">8</span>);</div><div class=\"line\">  <span class=\"keyword\">echo</span> $a[o]</div></pre></td></tr></table></figure></p>\n<p>自定义的错误处理函数一定要有这四个输入变量$errno, $errstr, $errfile, $errline.</p>\n<ul>\n<li>errno,代表错误等级的一组常量。比如 E_WARNING 其二进制掩码为4，表示告警信息。</li>\n</ul>\n<p><strong>注意：</strong> 自定义的错误处理函数并不能托管所有种类的错误，比如E_ERROR, E_PARSE, E_CORE_ERROR, E_CORE_WARNING, E_COMPILE_ERROR, E_COMPILE_WARNING,以及E_STRICT中的部分。</p>\n<p><strong>注意：</strong> 如果使用自定义的 set_error_handler 接管PHP的错误处理，先前代码里的错误抑制 @ 也将会失效，这是这种错误也会被显示。</p>\n<h4 id=\"restore-error-handler\"><a href=\"#restore-error-handler\" class=\"headerlink\" title=\"restore_error_handler\"></a>restore_error_handler</h4><p>该函数可以取消 set_error_handler 的错误接管.</p>\n<h2 id=\"结合PHP错误处理主动抛出异常\"><a href=\"#结合PHP错误处理主动抛出异常\" class=\"headerlink\" title=\"结合PHP错误处理主动抛出异常\"></a>结合PHP错误处理主动抛出异常</h2><p>结合PHP的错误处理机制和异常处理机制，通过组合也可以实现同时捕获异常和非致命错误。<br>示例<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">customError</span><span class=\"params\">($errNo, $errStr, $errFile, $errLine)</span></span>&#123;</div><div class=\"line\">    <span class=\"comment\">//自定义错误处理时，可以手动抛出异常</span></div><div class=\"line\">    <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"keyword\">Exception</span>($level.<span class=\"string\">\"|\"</span>.$errStr);</div><div class=\"line\">  &#125;</div><div class=\"line\">  set_error_handler(<span class=\"string\">\"custonError\"</span>, E_ALL | E_STRICT);</div><div class=\"line\">  <span class=\"keyword\">try</span>&#123;</div><div class=\"line\">    $a = <span class=\"number\">5</span>/<span class=\"number\">0</span>;</div><div class=\"line\">  &#125; <span class=\"keyword\">catch</span>(<span class=\"keyword\">Exception</span> $e)&#123;</div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">\"错误信息\"</span>.$e-&gt;getMessage();</div><div class=\"line\">  &#125;</div></pre></td></tr></table></figure></p>\n<p>通过上面示例可以捕获到异常和非致命错误，但对于 fetal error 这样的错误却捕获不到。但是通过其他的一些方法，我们还是可以做一些处理。 register_shutdown_function 该函数会在程序终止或die时触发一个函数，我们可以利用该触发函数做一些最后的收尾操作。</p>\n<p>调用时机</p>\n<ul>\n<li>当页面被用户强制停止时</li>\n<li>当程序代码运行超时时</li>\n<li>当ＰＨＰ代码执行完成时，代码执行存在异常和错误、警告</li>\n</ul>\n<p>void register_shutdown_function ( callable $callback [, mixed $parameter [, mixed $… ]] )</p>\n<p>示例<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">  <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">shutdown</span><span class=\"params\">()</span></div><div class=\"line\">  </span>&#123;</div><div class=\"line\">      <span class=\"comment\">// This is our shutdown function, in</span></div><div class=\"line\">      <span class=\"comment\">// here we can do any last operations</span></div><div class=\"line\">      <span class=\"comment\">// before the script is complete.</span></div><div class=\"line\">      <span class=\"keyword\">echo</span> <span class=\"string\">'Script executed with success'</span>, PHP_EOL;</div><div class=\"line\">  &#125;</div><div class=\"line\">  register_shutdown_function(<span class=\"string\">'shutdown'</span>);</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure></p>\n<p>对于 prase error 级别的错误，PHP层面就没有办法做什么了。我们只能通过开启错误日志，来记录这些错误。</p>\n<p>php.ini设置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">log_errors = On</div><div class=\"line\">error_log = /usr/log/log.log</div></pre></td></tr></table></figure></p>"},{"title":"PHP扩展模块安装","date":"2016-09-26T13:30:00.000Z","ctime":"2016-09-26T13:48:00.000Z","utime":"2016-09-26T13:48:00.000Z","modif_times":1,"_content":"\nPHP编译安装之后，通常我们还需要根据我们的业务需求去安装各种扩展。通常我们可以通过php提供的phpize这个工具来为PHP动态地添加我们需要的模块。\n\n<!-- more -->\n\n## 工具介绍\n- phpize，是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块。一般在我们安装PHP时已经一起安装了。位置一般在/path/to/php/bin/phpize。\n\n- autoconf，是用来生成自动配置软件源代码脚本（configure）的 工具.configure脚本能独立于autoconf运行,且在 运行的 过程中,不需要用户的干预.\n\n- m4，是 一个宏处理器.将输入拷贝到输出,同时将宏展开.宏可以是 内嵌的 ,也可以是 用户定义的 .除了可以展开宏,m4还有一些内建的 函数,用来引用文件,执行命令,整数运算,文本操作,循环等.m4既可以作为编译器的 前端,也可以单独作为一个宏处理器.\n\n## 示例（为PHP添加mysqli扩展）\n进入PHP源码包的ext/mysqli扩展目录\n```\ncd  ext/mysqli\n./configure --with-php-config=/usr/local/php56/bin/php-config --with-mysqli=/usr/local/mysql/bin/mysql_config\nmake && make install\n#\n#Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\n#Installing header files:           /usr/local/php56/include/php/\n```\n\n查看模块是否编译成功\n```\ncd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\nll\n#-rwxr-xr-x 1 root root  756714 Sep 26 17:32 mysqli.so\n#-rwxr-xr-x 1 root root 1333912 Sep 24 23:31 opcache.a\n#-rwxr-xr-x 1 root root  618435 Sep 24 23:31 opcache.so\n```\n\n将模块加载到php\n```\nvi /usr/local/php56/lib/php.ini\n#将下面这行写入到php.ini中\nextension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/mysqli.so\n```\n重启php-fpm\n```\nkill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`\n```\n\n查看是否加载成功\n```\nphp -m\n```\n或浏览器访问index.php (包含phpinfo()函数)\n","source":"_posts/PHP扩展模块安装.md","raw":"---\ntitle: PHP扩展模块安装\ndate: 2016-09-26 21:30:00\nctime: 2016-09-26 21:48:00\nutime: 2016-09-26 21:48:00\nmodif_times: 1\ntags:\n- PHP扩展\n- phpize\ncategories:\n- PHP\n---\n\nPHP编译安装之后，通常我们还需要根据我们的业务需求去安装各种扩展。通常我们可以通过php提供的phpize这个工具来为PHP动态地添加我们需要的模块。\n\n<!-- more -->\n\n## 工具介绍\n- phpize，是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块。一般在我们安装PHP时已经一起安装了。位置一般在/path/to/php/bin/phpize。\n\n- autoconf，是用来生成自动配置软件源代码脚本（configure）的 工具.configure脚本能独立于autoconf运行,且在 运行的 过程中,不需要用户的干预.\n\n- m4，是 一个宏处理器.将输入拷贝到输出,同时将宏展开.宏可以是 内嵌的 ,也可以是 用户定义的 .除了可以展开宏,m4还有一些内建的 函数,用来引用文件,执行命令,整数运算,文本操作,循环等.m4既可以作为编译器的 前端,也可以单独作为一个宏处理器.\n\n## 示例（为PHP添加mysqli扩展）\n进入PHP源码包的ext/mysqli扩展目录\n```\ncd  ext/mysqli\n./configure --with-php-config=/usr/local/php56/bin/php-config --with-mysqli=/usr/local/mysql/bin/mysql_config\nmake && make install\n#\n#Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\n#Installing header files:           /usr/local/php56/include/php/\n```\n\n查看模块是否编译成功\n```\ncd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\nll\n#-rwxr-xr-x 1 root root  756714 Sep 26 17:32 mysqli.so\n#-rwxr-xr-x 1 root root 1333912 Sep 24 23:31 opcache.a\n#-rwxr-xr-x 1 root root  618435 Sep 24 23:31 opcache.so\n```\n\n将模块加载到php\n```\nvi /usr/local/php56/lib/php.ini\n#将下面这行写入到php.ini中\nextension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/mysqli.so\n```\n重启php-fpm\n```\nkill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`\n```\n\n查看是否加载成功\n```\nphp -m\n```\n或浏览器访问index.php (包含phpinfo()函数)\n","slug":"PHP扩展模块安装","published":1,"updated":"2016-09-26T13:14:08.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwww0036699fj7tz5kbz","content":"<p>PHP编译安装之后，通常我们还需要根据我们的业务需求去安装各种扩展。通常我们可以通过php提供的phpize这个工具来为PHP动态地添加我们需要的模块。</p>\n<a id=\"more\"></a>\n<h2 id=\"工具介绍\"><a href=\"#工具介绍\" class=\"headerlink\" title=\"工具介绍\"></a>工具介绍</h2><ul>\n<li><p>phpize，是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块。一般在我们安装PHP时已经一起安装了。位置一般在/path/to/php/bin/phpize。</p>\n</li>\n<li><p>autoconf，是用来生成自动配置软件源代码脚本（configure）的 工具.configure脚本能独立于autoconf运行,且在 运行的 过程中,不需要用户的干预.</p>\n</li>\n<li><p>m4，是 一个宏处理器.将输入拷贝到输出,同时将宏展开.宏可以是 内嵌的 ,也可以是 用户定义的 .除了可以展开宏,m4还有一些内建的 函数,用来引用文件,执行命令,整数运算,文本操作,循环等.m4既可以作为编译器的 前端,也可以单独作为一个宏处理器.</p>\n</li>\n</ul>\n<h2 id=\"示例（为PHP添加mysqli扩展）\"><a href=\"#示例（为PHP添加mysqli扩展）\" class=\"headerlink\" title=\"示例（为PHP添加mysqli扩展）\"></a>示例（为PHP添加mysqli扩展）</h2><p>进入PHP源码包的ext/mysqli扩展目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd  ext/mysqli</div><div class=\"line\">./configure --with-php-config=/usr/local/php56/bin/php-config --with-mysqli=/usr/local/mysql/bin/mysql_config</div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\">#</div><div class=\"line\">#Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">#Installing header files:           /usr/local/php56/include/php/</div></pre></td></tr></table></figure></p>\n<p>查看模块是否编译成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">ll</div><div class=\"line\">#-rwxr-xr-x 1 root root  756714 Sep 26 17:32 mysqli.so</div><div class=\"line\">#-rwxr-xr-x 1 root root 1333912 Sep 24 23:31 opcache.a</div><div class=\"line\">#-rwxr-xr-x 1 root root  618435 Sep 24 23:31 opcache.so</div></pre></td></tr></table></figure></p>\n<p>将模块加载到php<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/lib/php.ini</div><div class=\"line\">#将下面这行写入到php.ini中</div><div class=\"line\">extension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/mysqli.so</div></pre></td></tr></table></figure></p>\n<p>重启php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<p>查看是否加载成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php -m</div></pre></td></tr></table></figure></p>\n<p>或浏览器访问index.php (包含phpinfo()函数)</p>\n","excerpt":"<p>PHP编译安装之后，通常我们还需要根据我们的业务需求去安装各种扩展。通常我们可以通过php提供的phpize这个工具来为PHP动态地添加我们需要的模块。</p>","more":"<h2 id=\"工具介绍\"><a href=\"#工具介绍\" class=\"headerlink\" title=\"工具介绍\"></a>工具介绍</h2><ul>\n<li><p>phpize，是用来扩展php扩展模块的，通过phpize可以建立php的外挂模块。一般在我们安装PHP时已经一起安装了。位置一般在/path/to/php/bin/phpize。</p>\n</li>\n<li><p>autoconf，是用来生成自动配置软件源代码脚本（configure）的 工具.configure脚本能独立于autoconf运行,且在 运行的 过程中,不需要用户的干预.</p>\n</li>\n<li><p>m4，是 一个宏处理器.将输入拷贝到输出,同时将宏展开.宏可以是 内嵌的 ,也可以是 用户定义的 .除了可以展开宏,m4还有一些内建的 函数,用来引用文件,执行命令,整数运算,文本操作,循环等.m4既可以作为编译器的 前端,也可以单独作为一个宏处理器.</p>\n</li>\n</ul>\n<h2 id=\"示例（为PHP添加mysqli扩展）\"><a href=\"#示例（为PHP添加mysqli扩展）\" class=\"headerlink\" title=\"示例（为PHP添加mysqli扩展）\"></a>示例（为PHP添加mysqli扩展）</h2><p>进入PHP源码包的ext/mysqli扩展目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd  ext/mysqli</div><div class=\"line\">./configure --with-php-config=/usr/local/php56/bin/php-config --with-mysqli=/usr/local/mysql/bin/mysql_config</div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\">#</div><div class=\"line\">#Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">#Installing header files:           /usr/local/php56/include/php/</div></pre></td></tr></table></figure></p>\n<p>查看模块是否编译成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">ll</div><div class=\"line\">#-rwxr-xr-x 1 root root  756714 Sep 26 17:32 mysqli.so</div><div class=\"line\">#-rwxr-xr-x 1 root root 1333912 Sep 24 23:31 opcache.a</div><div class=\"line\">#-rwxr-xr-x 1 root root  618435 Sep 24 23:31 opcache.so</div></pre></td></tr></table></figure></p>\n<p>将模块加载到php<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/lib/php.ini</div><div class=\"line\">#将下面这行写入到php.ini中</div><div class=\"line\">extension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/mysqli.so</div></pre></td></tr></table></figure></p>\n<p>重启php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<p>查看是否加载成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">php -m</div></pre></td></tr></table></figure></p>\n<p>或浏览器访问index.php (包含phpinfo()函数)</p>"},{"title":"PHP魔术方法小结","date":"2016-10-12T14:30:00.000Z","_content":"\nMVC模式，即模型-试图-控制器模式，是将应用程序划分成不同层次的一种方式。\n\n即，\n\nC | Control |控制器层  |负责业务逻辑的处理。根据用户的请求确定用户可以做什么。之后，调用模型执行操作获得数据。最后调用视图将操作结果呈现给用户。\n--|---------|---------|------\nM | Model   |模型层    |负责加工处理数据 返回结果。\nV | View    |视图层    |负责接收信息和显示信息。\n\n一个典型MVC应用程序流程图\n\n![典型MVC应用程序流程图](http://n.sinaimg.cn/games/3ece443e/20161013/mvcYingYongChengXuLiuChengTu.png)\n\n<!-- more -->\n\n## 简单实现：\n\n### 文件结构：\n```\n$ tree shop         \nshop\n├── Control\n│   ├── FlinkControl.class.php\n│   ├── GoodsControl.class.php\n│   ├── IndexControl.class.php\n│   ├── NewsControl.class.php\n│   ├── OrderControl.class.php\n│   └── UserControl.class.php\n├── Model\n│   ├── MemcacheModel.class.php\n│   └── MysqlModel.class.php\n├── Org\n│   └── Vcode.class.php\n├── Views\n├── index.php\n└── readme\n\n4 directories, 11 files\n```\n\n### 说明：\n```\nModel  文件夹    模型层的Model类（操作数据 MYSQL、Memcached...）\nOrg    文件夹\t  模型层的其他类(不操作数据 分页/验证码...)\nControls文件夹\t  控制器层的类\nViews  文件夹\t  视图层(html页面)\n```\n\n### 主要文件内容：\nindex.php\n\n```php\n<?php\n\t//类的自动加载\n\tfunction __autoload($className){\n\n\t\t//包含控制器的类\n\t\tif(strtolower(substr($className,-7))=='control'){\n\t\t\tinclude 'Control/'.$className.'.class.php';\n\t\t}elseif(strtolower(substr($className,-5))=='model'){\n\t\t\tinclude 'Model/'.$className.'.class.php';\n\t\t}else{\n\t\t\tinclude 'Org/'.$className.'.class.php';\n\t\t}\n\t}\n\n\t//如何调用控制器\n\t//index.php?m=user&a=add      表示调用用户类中的添加用户方法\n\t//index.php?m=goods&a=drop    表示调用商品类中的删除商品方法\n\n\t//index.php?m=user&a=add  \n\n\t//m=user ->调用UserControl类\n\t$class=!empty($_GET['m'])?strtolower($_GET['m']):'Index';//$class=user;\n\t$class=ucfirst($class);//$class=User;\n\t$class.='Control';//$class=UserControl\n\n\t//a=add -> add\n\t$method=!empty($_GET['a'])?strtolower($_GET['a']):'index';\n\t$one=new $class;\n\t$one->$method();\n?>\n```\n\nControl/UserControl.class.php\n\n```php\n<?php\n\tclass UserControl{\n\t\t//控制器不需用属性！！！1\n\n\t\t//默认的方法index\n\t\tfunction index(){\n      //实例化一个模型层的扩展类\n\t\t\techo new Vcode;\n\t\t\techo '显示用户列表';\n\t\t}\n\n\t\t//添加用户\n\t\tfunction add(){\n      //调用Model 查询友情连接信息\n\t\t\t$mysql=new MysqlModel;\n\t\t\t//调用Model类的方法\n\t\t\t$mysql->insert();\n\n\t\t\techo '添加用户操作';\n\t\t}\n\n\t\t//删除用户\n\t\tfunction drop(){\n\t\t\techo '删除用户操作';\n\t\t}\n\n\t\t//修改用户\n\t\tfunction mod(){\n\t\t\techo '修改用户操作';\n\t\t}\n\n\t\t//查询用户\n\t\tfunction show(){\n\t\t\techo '查询用户操作';\n\t\t}\n\n\t}\n\n```\nModel/MysqlModel.class.php\n\n```php\n<?php\n\n\tclass MysqlModel{\n\n\t\t//连接数据库的方法\n\t\tfunction __construct(){\n\t\t\techo '连接数据库中<br>';\n\t\t}\n\n\t\t//使用数据库进行查询操作\n\t\tfunction select(){\n\t\t\techo '使用数据库进行查询操作<br>';\n\t\t}\n\n\t\t//使用数据库进行删除操作\n\t\tfunction delete(){\n\t\t\techo '使用数据库进行删除操作<br>';\n\t\t}\n\n\t\t//使用数据库进行修改操作\n\t\tfunction update(){\n\t\t\techo '使用数据库进行修改操作<br>';\n\t\t}\n\n\t\t//使用数据库进行添加操作\n\t\tfunction insert(){\n\t\t\techo '使用数据库进行添加操作<br>';\n\t\t}\n\n\t\tfunction __destruct(){\n\t\t\techo '断开数据库连接';\n\t\t}\n\n\t}\n```\n\nOrg/Vcode.class.php\n\n```php\n<?php\n\tclass  Vcode {\n\t\tprivate $width;                               //验证码图片的宽度\n\t\tprivate $height;                              //验证码图片的高度\n\t\tprivate $codeNum;                             //验证码字符的个数\n\t\tprivate $disturbColorNum;                     //干扰元素数量\n\t\tprivate $checkCode;                           //验证码字符\n\t\tprivate $image;                               //验证码资源\n\n\t\t/**\n\t\t * 构造方法用来实例化验证码对象，并为一些成员属性初使化       \n\t\t * @param\tint\t$width\t\t设置验证码图片的宽度，默认宽度值为80像素        \n\t\t * @param\tint\t$height\t\t设置验证码图片的高度，默认高度值为20像素       \n\t\t * @param\tint\t$codeNum\t设置验证码中字母和数字的个数，默认个数为4个  \n\t\t */\n\t\tfunction __construct($width=80, $height=20, $codeNum=4) {\n\t\t\t$this->width=$width;                     //为成员属性width初使化\n\t\t\t$this->height=$height;                     //为成员属性height初使化\n\t\t\t$this->codeNum=$codeNum;               //为成员属性codeNum初使化\n\t\t\t$number=floor($height*$width/15);\n\t\t\tif($number > 240-$codeNum)\n\t\t\t\t$this->disturbColorNum=240-$codeNum;\n\t\t\telse\n\t\t\t\t$this->disturbColorNum=$number;\n\t\t\t$this->checkCode=$this->createCheckCode();  //为成员属性checkCode初使化\n\t\t}\n\t\t/**\n\t\t * 用于输出验证码图片，也向服务器的SESSION中保存了验证码\n\t\t * 使用echo 输出对象即可\n\t\t * @return string\t验证码\n\t\t */\n\n\t\tfunction __toString(){\n\t\t\t$_SESSION[\"code\"]=strtoupper($this->checkCode);  //加到session中\n\t\t\t$this->outImg();              //输出验证码\n\t\t\treturn '';\n\t\t}\n\n\t\tprivate function outImg(){                       //通过访问该方法向浏览器中输出图像\n\t\t\t$this->getCreateImage();                 //调用内部方法创建画布并对其进行初使化\n\t\t\t$this->setDisturbColor();                 //向图像中设置一些干扰像素\n\t\t\t$this->outputText();                     //向图像中输出随机的字符串\n\t\t\t$this->outputImage();                    //生成相应格式的图像并输出\n\t\t}\n\n\n\t\tprivate function getCreateImage(){              //用来创建图像资源，并初使化背影\n\t\t\t$this->image=imagecreatetruecolor($this->width,$this->height);\n\n\t\t\t$backColor = imagecolorallocate($this->image, rand(225,255),rand(225,255),rand(225,255));    //背景色（随机）\n\t\t\t @imagefill($this->image, 0, 0, $backColor);\n\n\t\t\t$border=imageColorAllocate($this->image, 0, 0, 0);\n\t\t\timageRectangle($this->image,0,0,$this->width-1,$this->height-1,$border);\n\t\t}\n\t\tprivate function createCheckCode(){           \n\t\t\t//随机生成用户指定个数的字符串,去掉了容易混淆的字符oOLlz和数字012\n\t\t\t$code=\"3456789abcdefghijkmnpqrstuvwxyABCDEFGHIJKMNPQRSTUVWXY\";\n\t\t\tfor($i=0;$i<$this->codeNum;$i++) {\n\t\t\t\t$char=$code{rand(0,strlen($code)-1)};\n\n\t\t\t\t$ascii.=$char;\n\t\t\t}\n\t\t\treturn $ascii;\n\n\t\t}\n\t\tprivate function setDisturbColor() {    \n\t\t\t//设置干扰像素，向图像中输出不同颜色的100个点\n\t\t\tfor($i=0; $i<=$this->disturbColorNum; $i++) {\n\t\t\t\t$color = imagecolorallocate($this->image, rand(0,255), rand(0,255), rand(0,255));\n   \t\t\t\timagesetpixel($this->image,rand(1,$this->width-2),rand(1,$this->height-2),$color);\n\t\t\t}\n\n\t\t\tfor($i=0; $i<10; $i++){\n\t\t\t\t$color=imagecolorallocate($this->image,rand(0,255),rand(0,255),rand(0,255));\n\t\t\t\timagearc($this->image,rand(-10,$this->width),rand(-10,$this->height),rand(30,300),rand(20,200),55,44,$color);\n\t\t\t}  \n\t\t}\n\n\n\t\tprivate function outputText() {       \n\t\t\t//随机颜色、随机摆放、随机字符串向图像中输出\n\t\t\tfor ($i=0;$i<=$this->codeNum;$i++) {\n\t\t\t\t$fontcolor = imagecolorallocate($this->image, rand(0,128), rand(0,128), rand(0,128));\n\t\t\t\t$fontSize=rand(3,5);\n\t\t\t\t$x = floor($this->width/$this->codeNum)*$i+3;\n   \t\t\t\t$y = rand(0,$this->height-imagefontheight($fontSize));\n\t\t\t\timagechar($this->image, $fontSize, $x, $y, $this->checkCode{$i}, $fontcolor);\n \t\t\t  }\n\t\t}\n\n\t\tprivate function outputImage(){              \n\t\t\t//自动检测GD支持的图像类型，并输出图像\n\t\t\tif(imagetypes() & IMG_GIF){          //判断生成GIF格式图像的函数是否存在\n\t\t\t\theader(\"Content-type: image/gif\");  //发送标头信息设置MIME类型为image/gif\n\t\t\t\timagegif($this->image);           //以GIF格式将图像输出到浏览器\n\t\t\t}elseif(imagetypes() & IMG_JPG){      //判断生成JPG格式图像的函数是否存在\n\t\t\t\theader(\"Content-type: image/jpeg\"); //发送标头信息设置MIME类型为image/jpeg\n\t\t\t\timagejpeg($this->image, \"\", 0.5);   //以JPEN格式将图像输出到浏览器\n\t\t\t}elseif(imagetypes() & IMG_PNG){     //判断生成PNG格式图像的函数是否存在\n\t\t\t\theader(\"Content-type: image/png\");  //发送标头信息设置MIME类型为image/png\n\t\t\t\timagepng($this->image);          //以PNG格式将图像输出到浏览器\n\t\t\t}elseif(imagetypes() & IMG_WBMP){   //判断生成WBMP格式图像的函数是否存在\n\t\t\t\t header(\"Content-type: image/vnd.wap.wbmp\");   //发送标头为image/wbmp\n\t\t\t\t imagewbmp($this->image);       //以WBMP格式将图像输出到浏览器\n\t\t\t}else{                              //如果没有支持的图像类型\n\t\t\t\tdie(\"PHP不支持图像创建！\");    //不输出图像，输出一错误消息，并退出程序\n\t\t\t}\n\t\t}\n\t\tfunction __destruct(){                      //当对象结束之前销毁图像资源释放内存\n \t\t\timagedestroy($this->image);            //调用GD库中的方法销毁图像资源\n\t\t}\n\t}\n```\n","source":"_posts/PHP的MVC设计与实现.md","raw":"---\ntitle: PHP魔术方法小结\ndate: 2016-10-12 22:30:00\ntags:\n- MVC\ncategories:\n- PHP\n---\n\nMVC模式，即模型-试图-控制器模式，是将应用程序划分成不同层次的一种方式。\n\n即，\n\nC | Control |控制器层  |负责业务逻辑的处理。根据用户的请求确定用户可以做什么。之后，调用模型执行操作获得数据。最后调用视图将操作结果呈现给用户。\n--|---------|---------|------\nM | Model   |模型层    |负责加工处理数据 返回结果。\nV | View    |视图层    |负责接收信息和显示信息。\n\n一个典型MVC应用程序流程图\n\n![典型MVC应用程序流程图](http://n.sinaimg.cn/games/3ece443e/20161013/mvcYingYongChengXuLiuChengTu.png)\n\n<!-- more -->\n\n## 简单实现：\n\n### 文件结构：\n```\n$ tree shop         \nshop\n├── Control\n│   ├── FlinkControl.class.php\n│   ├── GoodsControl.class.php\n│   ├── IndexControl.class.php\n│   ├── NewsControl.class.php\n│   ├── OrderControl.class.php\n│   └── UserControl.class.php\n├── Model\n│   ├── MemcacheModel.class.php\n│   └── MysqlModel.class.php\n├── Org\n│   └── Vcode.class.php\n├── Views\n├── index.php\n└── readme\n\n4 directories, 11 files\n```\n\n### 说明：\n```\nModel  文件夹    模型层的Model类（操作数据 MYSQL、Memcached...）\nOrg    文件夹\t  模型层的其他类(不操作数据 分页/验证码...)\nControls文件夹\t  控制器层的类\nViews  文件夹\t  视图层(html页面)\n```\n\n### 主要文件内容：\nindex.php\n\n```php\n<?php\n\t//类的自动加载\n\tfunction __autoload($className){\n\n\t\t//包含控制器的类\n\t\tif(strtolower(substr($className,-7))=='control'){\n\t\t\tinclude 'Control/'.$className.'.class.php';\n\t\t}elseif(strtolower(substr($className,-5))=='model'){\n\t\t\tinclude 'Model/'.$className.'.class.php';\n\t\t}else{\n\t\t\tinclude 'Org/'.$className.'.class.php';\n\t\t}\n\t}\n\n\t//如何调用控制器\n\t//index.php?m=user&a=add      表示调用用户类中的添加用户方法\n\t//index.php?m=goods&a=drop    表示调用商品类中的删除商品方法\n\n\t//index.php?m=user&a=add  \n\n\t//m=user ->调用UserControl类\n\t$class=!empty($_GET['m'])?strtolower($_GET['m']):'Index';//$class=user;\n\t$class=ucfirst($class);//$class=User;\n\t$class.='Control';//$class=UserControl\n\n\t//a=add -> add\n\t$method=!empty($_GET['a'])?strtolower($_GET['a']):'index';\n\t$one=new $class;\n\t$one->$method();\n?>\n```\n\nControl/UserControl.class.php\n\n```php\n<?php\n\tclass UserControl{\n\t\t//控制器不需用属性！！！1\n\n\t\t//默认的方法index\n\t\tfunction index(){\n      //实例化一个模型层的扩展类\n\t\t\techo new Vcode;\n\t\t\techo '显示用户列表';\n\t\t}\n\n\t\t//添加用户\n\t\tfunction add(){\n      //调用Model 查询友情连接信息\n\t\t\t$mysql=new MysqlModel;\n\t\t\t//调用Model类的方法\n\t\t\t$mysql->insert();\n\n\t\t\techo '添加用户操作';\n\t\t}\n\n\t\t//删除用户\n\t\tfunction drop(){\n\t\t\techo '删除用户操作';\n\t\t}\n\n\t\t//修改用户\n\t\tfunction mod(){\n\t\t\techo '修改用户操作';\n\t\t}\n\n\t\t//查询用户\n\t\tfunction show(){\n\t\t\techo '查询用户操作';\n\t\t}\n\n\t}\n\n```\nModel/MysqlModel.class.php\n\n```php\n<?php\n\n\tclass MysqlModel{\n\n\t\t//连接数据库的方法\n\t\tfunction __construct(){\n\t\t\techo '连接数据库中<br>';\n\t\t}\n\n\t\t//使用数据库进行查询操作\n\t\tfunction select(){\n\t\t\techo '使用数据库进行查询操作<br>';\n\t\t}\n\n\t\t//使用数据库进行删除操作\n\t\tfunction delete(){\n\t\t\techo '使用数据库进行删除操作<br>';\n\t\t}\n\n\t\t//使用数据库进行修改操作\n\t\tfunction update(){\n\t\t\techo '使用数据库进行修改操作<br>';\n\t\t}\n\n\t\t//使用数据库进行添加操作\n\t\tfunction insert(){\n\t\t\techo '使用数据库进行添加操作<br>';\n\t\t}\n\n\t\tfunction __destruct(){\n\t\t\techo '断开数据库连接';\n\t\t}\n\n\t}\n```\n\nOrg/Vcode.class.php\n\n```php\n<?php\n\tclass  Vcode {\n\t\tprivate $width;                               //验证码图片的宽度\n\t\tprivate $height;                              //验证码图片的高度\n\t\tprivate $codeNum;                             //验证码字符的个数\n\t\tprivate $disturbColorNum;                     //干扰元素数量\n\t\tprivate $checkCode;                           //验证码字符\n\t\tprivate $image;                               //验证码资源\n\n\t\t/**\n\t\t * 构造方法用来实例化验证码对象，并为一些成员属性初使化       \n\t\t * @param\tint\t$width\t\t设置验证码图片的宽度，默认宽度值为80像素        \n\t\t * @param\tint\t$height\t\t设置验证码图片的高度，默认高度值为20像素       \n\t\t * @param\tint\t$codeNum\t设置验证码中字母和数字的个数，默认个数为4个  \n\t\t */\n\t\tfunction __construct($width=80, $height=20, $codeNum=4) {\n\t\t\t$this->width=$width;                     //为成员属性width初使化\n\t\t\t$this->height=$height;                     //为成员属性height初使化\n\t\t\t$this->codeNum=$codeNum;               //为成员属性codeNum初使化\n\t\t\t$number=floor($height*$width/15);\n\t\t\tif($number > 240-$codeNum)\n\t\t\t\t$this->disturbColorNum=240-$codeNum;\n\t\t\telse\n\t\t\t\t$this->disturbColorNum=$number;\n\t\t\t$this->checkCode=$this->createCheckCode();  //为成员属性checkCode初使化\n\t\t}\n\t\t/**\n\t\t * 用于输出验证码图片，也向服务器的SESSION中保存了验证码\n\t\t * 使用echo 输出对象即可\n\t\t * @return string\t验证码\n\t\t */\n\n\t\tfunction __toString(){\n\t\t\t$_SESSION[\"code\"]=strtoupper($this->checkCode);  //加到session中\n\t\t\t$this->outImg();              //输出验证码\n\t\t\treturn '';\n\t\t}\n\n\t\tprivate function outImg(){                       //通过访问该方法向浏览器中输出图像\n\t\t\t$this->getCreateImage();                 //调用内部方法创建画布并对其进行初使化\n\t\t\t$this->setDisturbColor();                 //向图像中设置一些干扰像素\n\t\t\t$this->outputText();                     //向图像中输出随机的字符串\n\t\t\t$this->outputImage();                    //生成相应格式的图像并输出\n\t\t}\n\n\n\t\tprivate function getCreateImage(){              //用来创建图像资源，并初使化背影\n\t\t\t$this->image=imagecreatetruecolor($this->width,$this->height);\n\n\t\t\t$backColor = imagecolorallocate($this->image, rand(225,255),rand(225,255),rand(225,255));    //背景色（随机）\n\t\t\t @imagefill($this->image, 0, 0, $backColor);\n\n\t\t\t$border=imageColorAllocate($this->image, 0, 0, 0);\n\t\t\timageRectangle($this->image,0,0,$this->width-1,$this->height-1,$border);\n\t\t}\n\t\tprivate function createCheckCode(){           \n\t\t\t//随机生成用户指定个数的字符串,去掉了容易混淆的字符oOLlz和数字012\n\t\t\t$code=\"3456789abcdefghijkmnpqrstuvwxyABCDEFGHIJKMNPQRSTUVWXY\";\n\t\t\tfor($i=0;$i<$this->codeNum;$i++) {\n\t\t\t\t$char=$code{rand(0,strlen($code)-1)};\n\n\t\t\t\t$ascii.=$char;\n\t\t\t}\n\t\t\treturn $ascii;\n\n\t\t}\n\t\tprivate function setDisturbColor() {    \n\t\t\t//设置干扰像素，向图像中输出不同颜色的100个点\n\t\t\tfor($i=0; $i<=$this->disturbColorNum; $i++) {\n\t\t\t\t$color = imagecolorallocate($this->image, rand(0,255), rand(0,255), rand(0,255));\n   \t\t\t\timagesetpixel($this->image,rand(1,$this->width-2),rand(1,$this->height-2),$color);\n\t\t\t}\n\n\t\t\tfor($i=0; $i<10; $i++){\n\t\t\t\t$color=imagecolorallocate($this->image,rand(0,255),rand(0,255),rand(0,255));\n\t\t\t\timagearc($this->image,rand(-10,$this->width),rand(-10,$this->height),rand(30,300),rand(20,200),55,44,$color);\n\t\t\t}  \n\t\t}\n\n\n\t\tprivate function outputText() {       \n\t\t\t//随机颜色、随机摆放、随机字符串向图像中输出\n\t\t\tfor ($i=0;$i<=$this->codeNum;$i++) {\n\t\t\t\t$fontcolor = imagecolorallocate($this->image, rand(0,128), rand(0,128), rand(0,128));\n\t\t\t\t$fontSize=rand(3,5);\n\t\t\t\t$x = floor($this->width/$this->codeNum)*$i+3;\n   \t\t\t\t$y = rand(0,$this->height-imagefontheight($fontSize));\n\t\t\t\timagechar($this->image, $fontSize, $x, $y, $this->checkCode{$i}, $fontcolor);\n \t\t\t  }\n\t\t}\n\n\t\tprivate function outputImage(){              \n\t\t\t//自动检测GD支持的图像类型，并输出图像\n\t\t\tif(imagetypes() & IMG_GIF){          //判断生成GIF格式图像的函数是否存在\n\t\t\t\theader(\"Content-type: image/gif\");  //发送标头信息设置MIME类型为image/gif\n\t\t\t\timagegif($this->image);           //以GIF格式将图像输出到浏览器\n\t\t\t}elseif(imagetypes() & IMG_JPG){      //判断生成JPG格式图像的函数是否存在\n\t\t\t\theader(\"Content-type: image/jpeg\"); //发送标头信息设置MIME类型为image/jpeg\n\t\t\t\timagejpeg($this->image, \"\", 0.5);   //以JPEN格式将图像输出到浏览器\n\t\t\t}elseif(imagetypes() & IMG_PNG){     //判断生成PNG格式图像的函数是否存在\n\t\t\t\theader(\"Content-type: image/png\");  //发送标头信息设置MIME类型为image/png\n\t\t\t\timagepng($this->image);          //以PNG格式将图像输出到浏览器\n\t\t\t}elseif(imagetypes() & IMG_WBMP){   //判断生成WBMP格式图像的函数是否存在\n\t\t\t\t header(\"Content-type: image/vnd.wap.wbmp\");   //发送标头为image/wbmp\n\t\t\t\t imagewbmp($this->image);       //以WBMP格式将图像输出到浏览器\n\t\t\t}else{                              //如果没有支持的图像类型\n\t\t\t\tdie(\"PHP不支持图像创建！\");    //不输出图像，输出一错误消息，并退出程序\n\t\t\t}\n\t\t}\n\t\tfunction __destruct(){                      //当对象结束之前销毁图像资源释放内存\n \t\t\timagedestroy($this->image);            //调用GD库中的方法销毁图像资源\n\t\t}\n\t}\n```\n","slug":"PHP的MVC设计与实现","published":1,"updated":"2016-10-13T03:03:13.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwx0038699f3bd2wnjo","content":"<p>MVC模式，即模型-试图-控制器模式，是将应用程序划分成不同层次的一种方式。</p>\n<p>即，</p>\n<table>\n<thead>\n<tr>\n<th>C</th>\n<th>Control</th>\n<th>控制器层</th>\n<th>负责业务逻辑的处理。根据用户的请求确定用户可以做什么。之后，调用模型执行操作获得数据。最后调用视图将操作结果呈现给用户。</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>M</td>\n<td>Model</td>\n<td>模型层</td>\n<td>负责加工处理数据 返回结果。</td>\n</tr>\n<tr>\n<td>V</td>\n<td>View</td>\n<td>视图层</td>\n<td>负责接收信息和显示信息。</td>\n</tr>\n</tbody>\n</table>\n<p>一个典型MVC应用程序流程图</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161013/mvcYingYongChengXuLiuChengTu.png\" alt=\"典型MVC应用程序流程图\"></p>\n<a id=\"more\"></a>\n<h2 id=\"简单实现：\"><a href=\"#简单实现：\" class=\"headerlink\" title=\"简单实现：\"></a>简单实现：</h2><h3 id=\"文件结构：\"><a href=\"#文件结构：\" class=\"headerlink\" title=\"文件结构：\"></a>文件结构：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ tree shop         </div><div class=\"line\">shop</div><div class=\"line\">├── Control</div><div class=\"line\">│   ├── FlinkControl.class.php</div><div class=\"line\">│   ├── GoodsControl.class.php</div><div class=\"line\">│   ├── IndexControl.class.php</div><div class=\"line\">│   ├── NewsControl.class.php</div><div class=\"line\">│   ├── OrderControl.class.php</div><div class=\"line\">│   └── UserControl.class.php</div><div class=\"line\">├── Model</div><div class=\"line\">│   ├── MemcacheModel.class.php</div><div class=\"line\">│   └── MysqlModel.class.php</div><div class=\"line\">├── Org</div><div class=\"line\">│   └── Vcode.class.php</div><div class=\"line\">├── Views</div><div class=\"line\">├── index.php</div><div class=\"line\">└── readme</div><div class=\"line\"></div><div class=\"line\">4 directories, 11 files</div></pre></td></tr></table></figure>\n<h3 id=\"说明：\"><a href=\"#说明：\" class=\"headerlink\" title=\"说明：\"></a>说明：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">Model  文件夹    模型层的Model类（操作数据 MYSQL、Memcached...）</div><div class=\"line\">Org    文件夹\t  模型层的其他类(不操作数据 分页/验证码...)</div><div class=\"line\">Controls文件夹\t  控制器层的类</div><div class=\"line\">Views  文件夹\t  视图层(html页面)</div></pre></td></tr></table></figure>\n<h3 id=\"主要文件内容：\"><a href=\"#主要文件内容：\" class=\"headerlink\" title=\"主要文件内容：\"></a>主要文件内容：</h3><p>index.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">\t<span class=\"comment\">//类的自动加载</span></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__autoload</span><span class=\"params\">($className)</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//包含控制器的类</span></div><div class=\"line\">\t\t<span class=\"keyword\">if</span>(strtolower(substr($className,<span class=\"number\">-7</span>))==<span class=\"string\">'control'</span>)&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">include</span> <span class=\"string\">'Control/'</span>.$className.<span class=\"string\">'.class.php'</span>;</div><div class=\"line\">\t\t&#125;<span class=\"keyword\">elseif</span>(strtolower(substr($className,<span class=\"number\">-5</span>))==<span class=\"string\">'model'</span>)&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">include</span> <span class=\"string\">'Model/'</span>.$className.<span class=\"string\">'.class.php'</span>;</div><div class=\"line\">\t\t&#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">include</span> <span class=\"string\">'Org/'</span>.$className.<span class=\"string\">'.class.php'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//如何调用控制器</span></div><div class=\"line\">\t<span class=\"comment\">//index.php?m=user&amp;a=add      表示调用用户类中的添加用户方法</span></div><div class=\"line\">\t<span class=\"comment\">//index.php?m=goods&amp;a=drop    表示调用商品类中的删除商品方法</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//index.php?m=user&amp;a=add  </span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//m=user -&gt;调用UserControl类</span></div><div class=\"line\">\t$class=!<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'m'</span>])?strtolower($_GET[<span class=\"string\">'m'</span>]):<span class=\"string\">'Index'</span>;<span class=\"comment\">//$class=user;</span></div><div class=\"line\">\t$class=ucfirst($class);<span class=\"comment\">//$class=User;</span></div><div class=\"line\">\t$class.=<span class=\"string\">'Control'</span>;<span class=\"comment\">//$class=UserControl</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//a=add -&gt; add</span></div><div class=\"line\">\t$method=!<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'a'</span>])?strtolower($_GET[<span class=\"string\">'a'</span>]):<span class=\"string\">'index'</span>;</div><div class=\"line\">\t$one=<span class=\"keyword\">new</span> $class;</div><div class=\"line\">\t$one-&gt;$method();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>Control/UserControl.class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserControl</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"comment\">//控制器不需用属性！！！1</span></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//默认的方法index</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">index</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">      <span class=\"comment\">//实例化一个模型层的扩展类</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"keyword\">new</span> Vcode;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'显示用户列表'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//添加用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">      <span class=\"comment\">//调用Model 查询友情连接信息</span></div><div class=\"line\">\t\t\t$mysql=<span class=\"keyword\">new</span> MysqlModel;</div><div class=\"line\">\t\t\t<span class=\"comment\">//调用Model类的方法</span></div><div class=\"line\">\t\t\t$mysql-&gt;insert();</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'添加用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//删除用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">drop</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'删除用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//修改用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mod</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'修改用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//查询用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'查询用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n<p>Model/MysqlModel.class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MysqlModel</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//连接数据库的方法</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'连接数据库中&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行查询操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">select</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行查询操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行删除操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">delete</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行删除操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行修改操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行修改操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行添加操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">insert</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行添加操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'断开数据库连接'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n<p>Org/Vcode.class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span>  <span class=\"title\">Vcode</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $width;                               <span class=\"comment\">//验证码图片的宽度</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $height;                              <span class=\"comment\">//验证码图片的高度</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $codeNum;                             <span class=\"comment\">//验证码字符的个数</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $disturbColorNum;                     <span class=\"comment\">//干扰元素数量</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $checkCode;                           <span class=\"comment\">//验证码字符</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $image;                               <span class=\"comment\">//验证码资源</span></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">/**</span></div><div class=\"line\">\t\t * 构造方法用来实例化验证码对象，并为一些成员属性初使化       </div><div class=\"line\">\t\t * <span class=\"doctag\">@param</span>\tint\t$width\t\t设置验证码图片的宽度，默认宽度值为80像素        </div><div class=\"line\">\t\t * <span class=\"doctag\">@param</span>\tint\t$height\t\t设置验证码图片的高度，默认高度值为20像素       </div><div class=\"line\">\t\t * <span class=\"doctag\">@param</span>\tint\t$codeNum\t设置验证码中字母和数字的个数，默认个数为4个  </div><div class=\"line\">\t\t */</div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($width=<span class=\"number\">80</span>, $height=<span class=\"number\">20</span>, $codeNum=<span class=\"number\">4</span>)</span> </span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;width=$width;                     <span class=\"comment\">//为成员属性width初使化</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;height=$height;                     <span class=\"comment\">//为成员属性height初使化</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;codeNum=$codeNum;               <span class=\"comment\">//为成员属性codeNum初使化</span></div><div class=\"line\">\t\t\t$number=floor($height*$width/<span class=\"number\">15</span>);</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span>($number &gt; <span class=\"number\">240</span>-$codeNum)</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">$this</span>-&gt;disturbColorNum=<span class=\"number\">240</span>-$codeNum;</div><div class=\"line\">\t\t\t<span class=\"keyword\">else</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">$this</span>-&gt;disturbColorNum=$number;</div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;checkCode=<span class=\"keyword\">$this</span>-&gt;createCheckCode();  <span class=\"comment\">//为成员属性checkCode初使化</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"comment\">/**</span></div><div class=\"line\">\t\t * 用于输出验证码图片，也向服务器的SESSION中保存了验证码</div><div class=\"line\">\t\t * 使用echo 输出对象即可</div><div class=\"line\">\t\t * <span class=\"doctag\">@return</span> string\t验证码</div><div class=\"line\">\t\t */</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t$_SESSION[<span class=\"string\">\"code\"</span>]=strtoupper(<span class=\"keyword\">$this</span>-&gt;checkCode);  <span class=\"comment\">//加到session中</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;outImg();              <span class=\"comment\">//输出验证码</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"string\">''</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outImg</span><span class=\"params\">()</span></span>&#123;                       <span class=\"comment\">//通过访问该方法向浏览器中输出图像</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;getCreateImage();                 <span class=\"comment\">//调用内部方法创建画布并对其进行初使化</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;setDisturbColor();                 <span class=\"comment\">//向图像中设置一些干扰像素</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;outputText();                     <span class=\"comment\">//向图像中输出随机的字符串</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;outputImage();                    <span class=\"comment\">//生成相应格式的图像并输出</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCreateImage</span><span class=\"params\">()</span></span>&#123;              <span class=\"comment\">//用来创建图像资源，并初使化背影</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;image=imagecreatetruecolor(<span class=\"keyword\">$this</span>-&gt;width,<span class=\"keyword\">$this</span>-&gt;height);</div><div class=\"line\"></div><div class=\"line\">\t\t\t$backColor = imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image, rand(<span class=\"number\">225</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">225</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">225</span>,<span class=\"number\">255</span>));    <span class=\"comment\">//背景色（随机）</span></div><div class=\"line\">\t\t\t @imagefill(<span class=\"keyword\">$this</span>-&gt;image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, $backColor);</div><div class=\"line\"></div><div class=\"line\">\t\t\t$border=imageColorAllocate(<span class=\"keyword\">$this</span>-&gt;image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">\t\t\timageRectangle(<span class=\"keyword\">$this</span>-&gt;image,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"keyword\">$this</span>-&gt;width<span class=\"number\">-1</span>,<span class=\"keyword\">$this</span>-&gt;height<span class=\"number\">-1</span>,$border);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createCheckCode</span><span class=\"params\">()</span></span>&#123;           </div><div class=\"line\">\t\t\t<span class=\"comment\">//随机生成用户指定个数的字符串,去掉了容易混淆的字符oOLlz和数字012</span></div><div class=\"line\">\t\t\t$code=<span class=\"string\">\"3456789abcdefghijkmnpqrstuvwxyABCDEFGHIJKMNPQRSTUVWXY\"</span>;</div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"keyword\">$this</span>-&gt;codeNum;$i++) &#123;</div><div class=\"line\">\t\t\t\t$char=$code&#123;rand(<span class=\"number\">0</span>,strlen($code)<span class=\"number\">-1</span>)&#125;;</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t$ascii.=$char;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> $ascii;</div><div class=\"line\"></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setDisturbColor</span><span class=\"params\">()</span> </span>&#123;    </div><div class=\"line\">\t\t\t<span class=\"comment\">//设置干扰像素，向图像中输出不同颜色的100个点</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>; $i&lt;=<span class=\"keyword\">$this</span>-&gt;disturbColorNum; $i++) &#123;</div><div class=\"line\">\t\t\t\t$color = imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image, rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>));</div><div class=\"line\">   \t\t\t\timagesetpixel(<span class=\"keyword\">$this</span>-&gt;image,rand(<span class=\"number\">1</span>,<span class=\"keyword\">$this</span>-&gt;width<span class=\"number\">-2</span>),rand(<span class=\"number\">1</span>,<span class=\"keyword\">$this</span>-&gt;height<span class=\"number\">-2</span>),$color);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>; $i&lt;<span class=\"number\">10</span>; $i++)&#123;</div><div class=\"line\">\t\t\t\t$color=imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image,rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>));</div><div class=\"line\">\t\t\t\timagearc(<span class=\"keyword\">$this</span>-&gt;image,rand(<span class=\"number\">-10</span>,<span class=\"keyword\">$this</span>-&gt;width),rand(<span class=\"number\">-10</span>,<span class=\"keyword\">$this</span>-&gt;height),rand(<span class=\"number\">30</span>,<span class=\"number\">300</span>),rand(<span class=\"number\">20</span>,<span class=\"number\">200</span>),<span class=\"number\">55</span>,<span class=\"number\">44</span>,$color);</div><div class=\"line\">\t\t\t&#125;  </div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outputText</span><span class=\"params\">()</span> </span>&#123;       </div><div class=\"line\">\t\t\t<span class=\"comment\">//随机颜色、随机摆放、随机字符串向图像中输出</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span> ($i=<span class=\"number\">0</span>;$i&lt;=<span class=\"keyword\">$this</span>-&gt;codeNum;$i++) &#123;</div><div class=\"line\">\t\t\t\t$fontcolor = imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image, rand(<span class=\"number\">0</span>,<span class=\"number\">128</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">128</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">128</span>));</div><div class=\"line\">\t\t\t\t$fontSize=rand(<span class=\"number\">3</span>,<span class=\"number\">5</span>);</div><div class=\"line\">\t\t\t\t$x = floor(<span class=\"keyword\">$this</span>-&gt;width/<span class=\"keyword\">$this</span>-&gt;codeNum)*$i+<span class=\"number\">3</span>;</div><div class=\"line\">   \t\t\t\t$y = rand(<span class=\"number\">0</span>,<span class=\"keyword\">$this</span>-&gt;height-imagefontheight($fontSize));</div><div class=\"line\">\t\t\t\timagechar(<span class=\"keyword\">$this</span>-&gt;image, $fontSize, $x, $y, <span class=\"keyword\">$this</span>-&gt;checkCode&#123;$i&#125;, $fontcolor);</div><div class=\"line\"> \t\t\t  &#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outputImage</span><span class=\"params\">()</span></span>&#123;              </div><div class=\"line\">\t\t\t<span class=\"comment\">//自动检测GD支持的图像类型，并输出图像</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span>(imagetypes() &amp; IMG_GIF)&#123;          <span class=\"comment\">//判断生成GIF格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\theader(<span class=\"string\">\"Content-type: image/gif\"</span>);  <span class=\"comment\">//发送标头信息设置MIME类型为image/gif</span></div><div class=\"line\">\t\t\t\timagegif(<span class=\"keyword\">$this</span>-&gt;image);           <span class=\"comment\">//以GIF格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">elseif</span>(imagetypes() &amp; IMG_JPG)&#123;      <span class=\"comment\">//判断生成JPG格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\theader(<span class=\"string\">\"Content-type: image/jpeg\"</span>); <span class=\"comment\">//发送标头信息设置MIME类型为image/jpeg</span></div><div class=\"line\">\t\t\t\timagejpeg(<span class=\"keyword\">$this</span>-&gt;image, <span class=\"string\">\"\"</span>, <span class=\"number\">0.5</span>);   <span class=\"comment\">//以JPEN格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">elseif</span>(imagetypes() &amp; IMG_PNG)&#123;     <span class=\"comment\">//判断生成PNG格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\theader(<span class=\"string\">\"Content-type: image/png\"</span>);  <span class=\"comment\">//发送标头信息设置MIME类型为image/png</span></div><div class=\"line\">\t\t\t\timagepng(<span class=\"keyword\">$this</span>-&gt;image);          <span class=\"comment\">//以PNG格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">elseif</span>(imagetypes() &amp; IMG_WBMP)&#123;   <span class=\"comment\">//判断生成WBMP格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\t header(<span class=\"string\">\"Content-type: image/vnd.wap.wbmp\"</span>);   <span class=\"comment\">//发送标头为image/wbmp</span></div><div class=\"line\">\t\t\t\t imagewbmp(<span class=\"keyword\">$this</span>-&gt;image);       <span class=\"comment\">//以WBMP格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">else</span>&#123;                              <span class=\"comment\">//如果没有支持的图像类型</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">die</span>(<span class=\"string\">\"PHP不支持图像创建！\"</span>);    <span class=\"comment\">//不输出图像，输出一错误消息，并退出程序</span></div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span>&#123;                      <span class=\"comment\">//当对象结束之前销毁图像资源释放内存</span></div><div class=\"line\"> \t\t\timagedestroy(<span class=\"keyword\">$this</span>-&gt;image);            <span class=\"comment\">//调用GD库中的方法销毁图像资源</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n","excerpt":"<p>MVC模式，即模型-试图-控制器模式，是将应用程序划分成不同层次的一种方式。</p>\n<p>即，</p>\n<table>\n<thead>\n<tr>\n<th>C</th>\n<th>Control</th>\n<th>控制器层</th>\n<th>负责业务逻辑的处理。根据用户的请求确定用户可以做什么。之后，调用模型执行操作获得数据。最后调用视图将操作结果呈现给用户。</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>M</td>\n<td>Model</td>\n<td>模型层</td>\n<td>负责加工处理数据 返回结果。</td>\n</tr>\n<tr>\n<td>V</td>\n<td>View</td>\n<td>视图层</td>\n<td>负责接收信息和显示信息。</td>\n</tr>\n</tbody>\n</table>\n<p>一个典型MVC应用程序流程图</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161013/mvcYingYongChengXuLiuChengTu.png\" alt=\"典型MVC应用程序流程图\"></p>","more":"<h2 id=\"简单实现：\"><a href=\"#简单实现：\" class=\"headerlink\" title=\"简单实现：\"></a>简单实现：</h2><h3 id=\"文件结构：\"><a href=\"#文件结构：\" class=\"headerlink\" title=\"文件结构：\"></a>文件结构：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ tree shop         </div><div class=\"line\">shop</div><div class=\"line\">├── Control</div><div class=\"line\">│   ├── FlinkControl.class.php</div><div class=\"line\">│   ├── GoodsControl.class.php</div><div class=\"line\">│   ├── IndexControl.class.php</div><div class=\"line\">│   ├── NewsControl.class.php</div><div class=\"line\">│   ├── OrderControl.class.php</div><div class=\"line\">│   └── UserControl.class.php</div><div class=\"line\">├── Model</div><div class=\"line\">│   ├── MemcacheModel.class.php</div><div class=\"line\">│   └── MysqlModel.class.php</div><div class=\"line\">├── Org</div><div class=\"line\">│   └── Vcode.class.php</div><div class=\"line\">├── Views</div><div class=\"line\">├── index.php</div><div class=\"line\">└── readme</div><div class=\"line\"></div><div class=\"line\">4 directories, 11 files</div></pre></td></tr></table></figure>\n<h3 id=\"说明：\"><a href=\"#说明：\" class=\"headerlink\" title=\"说明：\"></a>说明：</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">Model  文件夹    模型层的Model类（操作数据 MYSQL、Memcached...）</div><div class=\"line\">Org    文件夹\t  模型层的其他类(不操作数据 分页/验证码...)</div><div class=\"line\">Controls文件夹\t  控制器层的类</div><div class=\"line\">Views  文件夹\t  视图层(html页面)</div></pre></td></tr></table></figure>\n<h3 id=\"主要文件内容：\"><a href=\"#主要文件内容：\" class=\"headerlink\" title=\"主要文件内容：\"></a>主要文件内容：</h3><p>index.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">\t<span class=\"comment\">//类的自动加载</span></div><div class=\"line\">\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__autoload</span><span class=\"params\">($className)</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//包含控制器的类</span></div><div class=\"line\">\t\t<span class=\"keyword\">if</span>(strtolower(substr($className,<span class=\"number\">-7</span>))==<span class=\"string\">'control'</span>)&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">include</span> <span class=\"string\">'Control/'</span>.$className.<span class=\"string\">'.class.php'</span>;</div><div class=\"line\">\t\t&#125;<span class=\"keyword\">elseif</span>(strtolower(substr($className,<span class=\"number\">-5</span>))==<span class=\"string\">'model'</span>)&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">include</span> <span class=\"string\">'Model/'</span>.$className.<span class=\"string\">'.class.php'</span>;</div><div class=\"line\">\t\t&#125;<span class=\"keyword\">else</span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">include</span> <span class=\"string\">'Org/'</span>.$className.<span class=\"string\">'.class.php'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//如何调用控制器</span></div><div class=\"line\">\t<span class=\"comment\">//index.php?m=user&amp;a=add      表示调用用户类中的添加用户方法</span></div><div class=\"line\">\t<span class=\"comment\">//index.php?m=goods&amp;a=drop    表示调用商品类中的删除商品方法</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//index.php?m=user&amp;a=add  </span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//m=user -&gt;调用UserControl类</span></div><div class=\"line\">\t$class=!<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'m'</span>])?strtolower($_GET[<span class=\"string\">'m'</span>]):<span class=\"string\">'Index'</span>;<span class=\"comment\">//$class=user;</span></div><div class=\"line\">\t$class=ucfirst($class);<span class=\"comment\">//$class=User;</span></div><div class=\"line\">\t$class.=<span class=\"string\">'Control'</span>;<span class=\"comment\">//$class=UserControl</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"comment\">//a=add -&gt; add</span></div><div class=\"line\">\t$method=!<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'a'</span>])?strtolower($_GET[<span class=\"string\">'a'</span>]):<span class=\"string\">'index'</span>;</div><div class=\"line\">\t$one=<span class=\"keyword\">new</span> $class;</div><div class=\"line\">\t$one-&gt;$method();</div><div class=\"line\"><span class=\"meta\">?&gt;</span></div></pre></td></tr></table></figure>\n<p>Control/UserControl.class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">UserControl</span></span>&#123;</div><div class=\"line\">\t\t<span class=\"comment\">//控制器不需用属性！！！1</span></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//默认的方法index</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">index</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">      <span class=\"comment\">//实例化一个模型层的扩展类</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"keyword\">new</span> Vcode;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'显示用户列表'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//添加用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">      <span class=\"comment\">//调用Model 查询友情连接信息</span></div><div class=\"line\">\t\t\t$mysql=<span class=\"keyword\">new</span> MysqlModel;</div><div class=\"line\">\t\t\t<span class=\"comment\">//调用Model类的方法</span></div><div class=\"line\">\t\t\t$mysql-&gt;insert();</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'添加用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//删除用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">drop</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'删除用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//修改用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">mod</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'修改用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//查询用户</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'查询用户操作'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n<p>Model/MysqlModel.class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\"></div><div class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MysqlModel</span></span>&#123;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//连接数据库的方法</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'连接数据库中&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行查询操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">select</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行查询操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行删除操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">delete</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行删除操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行修改操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">update</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行修改操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">//使用数据库进行添加操作</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">insert</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'使用数据库进行添加操作&lt;br&gt;'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">'断开数据库连接'</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>\n<p>Org/Vcode.class.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span>  <span class=\"title\">Vcode</span> </span>&#123;</div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $width;                               <span class=\"comment\">//验证码图片的宽度</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $height;                              <span class=\"comment\">//验证码图片的高度</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $codeNum;                             <span class=\"comment\">//验证码字符的个数</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $disturbColorNum;                     <span class=\"comment\">//干扰元素数量</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $checkCode;                           <span class=\"comment\">//验证码字符</span></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> $image;                               <span class=\"comment\">//验证码资源</span></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"comment\">/**</div><div class=\"line\">\t\t * 构造方法用来实例化验证码对象，并为一些成员属性初使化       </div><div class=\"line\">\t\t * <span class=\"doctag\">@param</span>\tint\t$width\t\t设置验证码图片的宽度，默认宽度值为80像素        </div><div class=\"line\">\t\t * <span class=\"doctag\">@param</span>\tint\t$height\t\t设置验证码图片的高度，默认高度值为20像素       </div><div class=\"line\">\t\t * <span class=\"doctag\">@param</span>\tint\t$codeNum\t设置验证码中字母和数字的个数，默认个数为4个  </div><div class=\"line\">\t\t */</span></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($width=<span class=\"number\">80</span>, $height=<span class=\"number\">20</span>, $codeNum=<span class=\"number\">4</span>)</span> </span>&#123;</div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;width=$width;                     <span class=\"comment\">//为成员属性width初使化</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;height=$height;                     <span class=\"comment\">//为成员属性height初使化</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;codeNum=$codeNum;               <span class=\"comment\">//为成员属性codeNum初使化</span></div><div class=\"line\">\t\t\t$number=floor($height*$width/<span class=\"number\">15</span>);</div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span>($number &gt; <span class=\"number\">240</span>-$codeNum)</div><div class=\"line\">\t\t\t\t<span class=\"keyword\">$this</span>-&gt;disturbColorNum=<span class=\"number\">240</span>-$codeNum;</div><div class=\"line\">\t\t\t<span class=\"keyword\">else</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">$this</span>-&gt;disturbColorNum=$number;</div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;checkCode=<span class=\"keyword\">$this</span>-&gt;createCheckCode();  <span class=\"comment\">//为成员属性checkCode初使化</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"comment\">/**</div><div class=\"line\">\t\t * 用于输出验证码图片，也向服务器的SESSION中保存了验证码</div><div class=\"line\">\t\t * 使用echo 输出对象即可</div><div class=\"line\">\t\t * <span class=\"doctag\">@return</span> string\t验证码</div><div class=\"line\">\t\t */</span></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span><span class=\"params\">()</span></span>&#123;</div><div class=\"line\">\t\t\t$_SESSION[<span class=\"string\">\"code\"</span>]=strtoupper(<span class=\"keyword\">$this</span>-&gt;checkCode);  <span class=\"comment\">//加到session中</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;outImg();              <span class=\"comment\">//输出验证码</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> <span class=\"string\">''</span>;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outImg</span><span class=\"params\">()</span></span>&#123;                       <span class=\"comment\">//通过访问该方法向浏览器中输出图像</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;getCreateImage();                 <span class=\"comment\">//调用内部方法创建画布并对其进行初使化</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;setDisturbColor();                 <span class=\"comment\">//向图像中设置一些干扰像素</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;outputText();                     <span class=\"comment\">//向图像中输出随机的字符串</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;outputImage();                    <span class=\"comment\">//生成相应格式的图像并输出</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getCreateImage</span><span class=\"params\">()</span></span>&#123;              <span class=\"comment\">//用来创建图像资源，并初使化背影</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">$this</span>-&gt;image=imagecreatetruecolor(<span class=\"keyword\">$this</span>-&gt;width,<span class=\"keyword\">$this</span>-&gt;height);</div><div class=\"line\"></div><div class=\"line\">\t\t\t$backColor = imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image, rand(<span class=\"number\">225</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">225</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">225</span>,<span class=\"number\">255</span>));    <span class=\"comment\">//背景色（随机）</span></div><div class=\"line\">\t\t\t @imagefill(<span class=\"keyword\">$this</span>-&gt;image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, $backColor);</div><div class=\"line\"></div><div class=\"line\">\t\t\t$border=imageColorAllocate(<span class=\"keyword\">$this</span>-&gt;image, <span class=\"number\">0</span>, <span class=\"number\">0</span>, <span class=\"number\">0</span>);</div><div class=\"line\">\t\t\timageRectangle(<span class=\"keyword\">$this</span>-&gt;image,<span class=\"number\">0</span>,<span class=\"number\">0</span>,<span class=\"keyword\">$this</span>-&gt;width<span class=\"number\">-1</span>,<span class=\"keyword\">$this</span>-&gt;height<span class=\"number\">-1</span>,$border);</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">createCheckCode</span><span class=\"params\">()</span></span>&#123;           </div><div class=\"line\">\t\t\t<span class=\"comment\">//随机生成用户指定个数的字符串,去掉了容易混淆的字符oOLlz和数字012</span></div><div class=\"line\">\t\t\t$code=<span class=\"string\">\"3456789abcdefghijkmnpqrstuvwxyABCDEFGHIJKMNPQRSTUVWXY\"</span>;</div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"keyword\">$this</span>-&gt;codeNum;$i++) &#123;</div><div class=\"line\">\t\t\t\t$char=$code&#123;rand(<span class=\"number\">0</span>,strlen($code)<span class=\"number\">-1</span>)&#125;;</div><div class=\"line\"></div><div class=\"line\">\t\t\t\t$ascii.=$char;</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t\t<span class=\"keyword\">return</span> $ascii;</div><div class=\"line\"></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">setDisturbColor</span><span class=\"params\">()</span> </span>&#123;    </div><div class=\"line\">\t\t\t<span class=\"comment\">//设置干扰像素，向图像中输出不同颜色的100个点</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>; $i&lt;=<span class=\"keyword\">$this</span>-&gt;disturbColorNum; $i++) &#123;</div><div class=\"line\">\t\t\t\t$color = imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image, rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>));</div><div class=\"line\">   \t\t\t\timagesetpixel(<span class=\"keyword\">$this</span>-&gt;image,rand(<span class=\"number\">1</span>,<span class=\"keyword\">$this</span>-&gt;width<span class=\"number\">-2</span>),rand(<span class=\"number\">1</span>,<span class=\"keyword\">$this</span>-&gt;height<span class=\"number\">-2</span>),$color);</div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>; $i&lt;<span class=\"number\">10</span>; $i++)&#123;</div><div class=\"line\">\t\t\t\t$color=imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image,rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>),rand(<span class=\"number\">0</span>,<span class=\"number\">255</span>));</div><div class=\"line\">\t\t\t\timagearc(<span class=\"keyword\">$this</span>-&gt;image,rand(<span class=\"number\">-10</span>,<span class=\"keyword\">$this</span>-&gt;width),rand(<span class=\"number\">-10</span>,<span class=\"keyword\">$this</span>-&gt;height),rand(<span class=\"number\">30</span>,<span class=\"number\">300</span>),rand(<span class=\"number\">20</span>,<span class=\"number\">200</span>),<span class=\"number\">55</span>,<span class=\"number\">44</span>,$color);</div><div class=\"line\">\t\t\t&#125;  </div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outputText</span><span class=\"params\">()</span> </span>&#123;       </div><div class=\"line\">\t\t\t<span class=\"comment\">//随机颜色、随机摆放、随机字符串向图像中输出</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">for</span> ($i=<span class=\"number\">0</span>;$i&lt;=<span class=\"keyword\">$this</span>-&gt;codeNum;$i++) &#123;</div><div class=\"line\">\t\t\t\t$fontcolor = imagecolorallocate(<span class=\"keyword\">$this</span>-&gt;image, rand(<span class=\"number\">0</span>,<span class=\"number\">128</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">128</span>), rand(<span class=\"number\">0</span>,<span class=\"number\">128</span>));</div><div class=\"line\">\t\t\t\t$fontSize=rand(<span class=\"number\">3</span>,<span class=\"number\">5</span>);</div><div class=\"line\">\t\t\t\t$x = floor(<span class=\"keyword\">$this</span>-&gt;width/<span class=\"keyword\">$this</span>-&gt;codeNum)*$i+<span class=\"number\">3</span>;</div><div class=\"line\">   \t\t\t\t$y = rand(<span class=\"number\">0</span>,<span class=\"keyword\">$this</span>-&gt;height-imagefontheight($fontSize));</div><div class=\"line\">\t\t\t\timagechar(<span class=\"keyword\">$this</span>-&gt;image, $fontSize, $x, $y, <span class=\"keyword\">$this</span>-&gt;checkCode&#123;$i&#125;, $fontcolor);</div><div class=\"line\"> \t\t\t  &#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\"></div><div class=\"line\">\t\t<span class=\"keyword\">private</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">outputImage</span><span class=\"params\">()</span></span>&#123;              </div><div class=\"line\">\t\t\t<span class=\"comment\">//自动检测GD支持的图像类型，并输出图像</span></div><div class=\"line\">\t\t\t<span class=\"keyword\">if</span>(imagetypes() &amp; IMG_GIF)&#123;          <span class=\"comment\">//判断生成GIF格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\theader(<span class=\"string\">\"Content-type: image/gif\"</span>);  <span class=\"comment\">//发送标头信息设置MIME类型为image/gif</span></div><div class=\"line\">\t\t\t\timagegif(<span class=\"keyword\">$this</span>-&gt;image);           <span class=\"comment\">//以GIF格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">elseif</span>(imagetypes() &amp; IMG_JPG)&#123;      <span class=\"comment\">//判断生成JPG格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\theader(<span class=\"string\">\"Content-type: image/jpeg\"</span>); <span class=\"comment\">//发送标头信息设置MIME类型为image/jpeg</span></div><div class=\"line\">\t\t\t\timagejpeg(<span class=\"keyword\">$this</span>-&gt;image, <span class=\"string\">\"\"</span>, <span class=\"number\">0.5</span>);   <span class=\"comment\">//以JPEN格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">elseif</span>(imagetypes() &amp; IMG_PNG)&#123;     <span class=\"comment\">//判断生成PNG格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\theader(<span class=\"string\">\"Content-type: image/png\"</span>);  <span class=\"comment\">//发送标头信息设置MIME类型为image/png</span></div><div class=\"line\">\t\t\t\timagepng(<span class=\"keyword\">$this</span>-&gt;image);          <span class=\"comment\">//以PNG格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">elseif</span>(imagetypes() &amp; IMG_WBMP)&#123;   <span class=\"comment\">//判断生成WBMP格式图像的函数是否存在</span></div><div class=\"line\">\t\t\t\t header(<span class=\"string\">\"Content-type: image/vnd.wap.wbmp\"</span>);   <span class=\"comment\">//发送标头为image/wbmp</span></div><div class=\"line\">\t\t\t\t imagewbmp(<span class=\"keyword\">$this</span>-&gt;image);       <span class=\"comment\">//以WBMP格式将图像输出到浏览器</span></div><div class=\"line\">\t\t\t&#125;<span class=\"keyword\">else</span>&#123;                              <span class=\"comment\">//如果没有支持的图像类型</span></div><div class=\"line\">\t\t\t\t<span class=\"keyword\">die</span>(<span class=\"string\">\"PHP不支持图像创建！\"</span>);    <span class=\"comment\">//不输出图像，输出一错误消息，并退出程序</span></div><div class=\"line\">\t\t\t&#125;</div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span><span class=\"params\">()</span></span>&#123;                      <span class=\"comment\">//当对象结束之前销毁图像资源释放内存</span></div><div class=\"line\"> \t\t\timagedestroy(<span class=\"keyword\">$this</span>-&gt;image);            <span class=\"comment\">//调用GD库中的方法销毁图像资源</span></div><div class=\"line\">\t\t&#125;</div><div class=\"line\">\t&#125;</div></pre></td></tr></table></figure>"},{"title":"PHP项目权限控制实现小结","date":"2016-10-07T12:00:00.000Z","_content":"\nRBAC，Role Based Access Control,基于角色的访问控制。实体关系如下：\n\n![RBAC实体关系](http://n.sinaimg.cn/games/3ece443e/20161007/RBACShiTiGuanXi.png)\n\n<!-- more -->\n\n## 实现逻辑设计\n\n用户表，user\n- id,用户标识\n- username，用户名\n- passwd，密码\n- status,状态\n\n角色表，role\n- id,角色标识\n- name，角色名称\n- desc，角色描述\n- status，状态\n\n权限节点表，node\n- id，权限节点标识\n- name，权限名称\n- title，权限描述\n- status，状态\n- sort，排序\n- pid，父标识\n- level，层级（一般，1、项目，2、模块（类），3、操作（方法））\n\n用户角色关系表，role_user\n- id，关系标识\n- role_id,角色标识\n- user_id,用户标识\n\n角色权限关系表, access\n- id，关系标识\n- role_id，角色标识\n- node_id，权限标识\n\n## 实现过程\n角色 --> 权限节点 --> 角色权限关系 --> 用户 --> 角色用户关系\n\n角色：\n- 创建角色\n- 角色管理\n\n权限\n- 添加权限节点\n- 权限管理\n\n权限节点列表的『权限结构』的递归显示问题，可用无限制分类来实现。\n\n无限制分类简单实现\n```php\nclass Tree{\n  static public $treeList = array();  //存放无限制分类结果\n\n  public function create($data, $pid=0){\n    foreach ($data as $key => $value) {\n      if($value['pid'] == $pid){\n          self::$treeList[] = $value;\n          unset($data[$key]);\n          self::$create($data, $value['id']);\n      }\n    }\n    return self::$treeList;\n  }\n}\n```\n\n角色权限关系\n- 添加角色-权限节点关系（添加角色新权限时，必须先删除原来的权限设置）\n- 管理角色-权限节点关系\n\n用户：\n- 添加用户\n- 用户管理\n\n用户角色关系\n- 添加用户-角色关系\n- 管理用户-角色关系\n\n## 权限控制应用\n\n\n实现权限控制方法步骤：\n1. 通过用户-角色关系表，获得用户所属角色\n2. 从权限表中，获得所有权限列表，并应用无限级分类实现分类排序\n3. 根据用户角色，通过角色-权限关系表获得当前拥有的权限几点信息\n4. 组合所有权限列表，和当前拥有的权限数据，在所有权限节点列表中标识当前用户是否具有对各个节点的权限。去除当前用户没有权限操作的权限节点。将当前的权限信息保存到当前用户的会话中。\n5. 用户进行操作各个权限节点时，首先检测当前的操作是否在会话中的权限信息中存在。不存在则按照权限不足处理，存在则继续进行操作。\n\nover~\n","source":"_posts/PHP项目权限控制实现小结.md","raw":"---\ntitle: PHP项目权限控制实现小结\ndate: 2016-10-07 20:00:00\ntags:\n  - 权限控制\n  - RBAC\ncategories:\n  - PHP\n---\n\nRBAC，Role Based Access Control,基于角色的访问控制。实体关系如下：\n\n![RBAC实体关系](http://n.sinaimg.cn/games/3ece443e/20161007/RBACShiTiGuanXi.png)\n\n<!-- more -->\n\n## 实现逻辑设计\n\n用户表，user\n- id,用户标识\n- username，用户名\n- passwd，密码\n- status,状态\n\n角色表，role\n- id,角色标识\n- name，角色名称\n- desc，角色描述\n- status，状态\n\n权限节点表，node\n- id，权限节点标识\n- name，权限名称\n- title，权限描述\n- status，状态\n- sort，排序\n- pid，父标识\n- level，层级（一般，1、项目，2、模块（类），3、操作（方法））\n\n用户角色关系表，role_user\n- id，关系标识\n- role_id,角色标识\n- user_id,用户标识\n\n角色权限关系表, access\n- id，关系标识\n- role_id，角色标识\n- node_id，权限标识\n\n## 实现过程\n角色 --> 权限节点 --> 角色权限关系 --> 用户 --> 角色用户关系\n\n角色：\n- 创建角色\n- 角色管理\n\n权限\n- 添加权限节点\n- 权限管理\n\n权限节点列表的『权限结构』的递归显示问题，可用无限制分类来实现。\n\n无限制分类简单实现\n```php\nclass Tree{\n  static public $treeList = array();  //存放无限制分类结果\n\n  public function create($data, $pid=0){\n    foreach ($data as $key => $value) {\n      if($value['pid'] == $pid){\n          self::$treeList[] = $value;\n          unset($data[$key]);\n          self::$create($data, $value['id']);\n      }\n    }\n    return self::$treeList;\n  }\n}\n```\n\n角色权限关系\n- 添加角色-权限节点关系（添加角色新权限时，必须先删除原来的权限设置）\n- 管理角色-权限节点关系\n\n用户：\n- 添加用户\n- 用户管理\n\n用户角色关系\n- 添加用户-角色关系\n- 管理用户-角色关系\n\n## 权限控制应用\n\n\n实现权限控制方法步骤：\n1. 通过用户-角色关系表，获得用户所属角色\n2. 从权限表中，获得所有权限列表，并应用无限级分类实现分类排序\n3. 根据用户角色，通过角色-权限关系表获得当前拥有的权限几点信息\n4. 组合所有权限列表，和当前拥有的权限数据，在所有权限节点列表中标识当前用户是否具有对各个节点的权限。去除当前用户没有权限操作的权限节点。将当前的权限信息保存到当前用户的会话中。\n5. 用户进行操作各个权限节点时，首先检测当前的操作是否在会话中的权限信息中存在。不存在则按照权限不足处理，存在则继续进行操作。\n\nover~\n","slug":"PHP项目权限控制实现小结","published":1,"updated":"2016-10-07T09:49:06.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwwy003b699fcfnt3ao3","content":"<p>RBAC，Role Based Access Control,基于角色的访问控制。实体关系如下：</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161007/RBACShiTiGuanXi.png\" alt=\"RBAC实体关系\"></p>\n<a id=\"more\"></a>\n<h2 id=\"实现逻辑设计\"><a href=\"#实现逻辑设计\" class=\"headerlink\" title=\"实现逻辑设计\"></a>实现逻辑设计</h2><p>用户表，user</p>\n<ul>\n<li>id,用户标识</li>\n<li>username，用户名</li>\n<li>passwd，密码</li>\n<li>status,状态</li>\n</ul>\n<p>角色表，role</p>\n<ul>\n<li>id,角色标识</li>\n<li>name，角色名称</li>\n<li>desc，角色描述</li>\n<li>status，状态</li>\n</ul>\n<p>权限节点表，node</p>\n<ul>\n<li>id，权限节点标识</li>\n<li>name，权限名称</li>\n<li>title，权限描述</li>\n<li>status，状态</li>\n<li>sort，排序</li>\n<li>pid，父标识</li>\n<li>level，层级（一般，1、项目，2、模块（类），3、操作（方法））</li>\n</ul>\n<p>用户角色关系表，role_user</p>\n<ul>\n<li>id，关系标识</li>\n<li>role_id,角色标识</li>\n<li>user_id,用户标识</li>\n</ul>\n<p>角色权限关系表, access</p>\n<ul>\n<li>id，关系标识</li>\n<li>role_id，角色标识</li>\n<li>node_id，权限标识</li>\n</ul>\n<h2 id=\"实现过程\"><a href=\"#实现过程\" class=\"headerlink\" title=\"实现过程\"></a>实现过程</h2><p>角色 –&gt; 权限节点 –&gt; 角色权限关系 –&gt; 用户 –&gt; 角色用户关系</p>\n<p>角色：</p>\n<ul>\n<li>创建角色</li>\n<li>角色管理</li>\n</ul>\n<p>权限</p>\n<ul>\n<li>添加权限节点</li>\n<li>权限管理</li>\n</ul>\n<p>权限节点列表的『权限结构』的递归显示问题，可用无限制分类来实现。</p>\n<p>无限制分类简单实现<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Tree</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">static</span> <span class=\"keyword\">public</span> $treeList = <span class=\"keyword\">array</span>();  <span class=\"comment\">//存放无限制分类结果</span></div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">create</span><span class=\"params\">($data, $pid=<span class=\"number\">0</span>)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">foreach</span> ($data <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span>($value[<span class=\"string\">'pid'</span>] == $pid)&#123;</div><div class=\"line\">          <span class=\"keyword\">self</span>::$treeList[] = $value;</div><div class=\"line\">          <span class=\"keyword\">unset</span>($data[$key]);</div><div class=\"line\">          <span class=\"keyword\">self</span>::$create($data, $value[<span class=\"string\">'id'</span>]);</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$treeList;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>角色权限关系</p>\n<ul>\n<li>添加角色-权限节点关系（添加角色新权限时，必须先删除原来的权限设置）</li>\n<li>管理角色-权限节点关系</li>\n</ul>\n<p>用户：</p>\n<ul>\n<li>添加用户</li>\n<li>用户管理</li>\n</ul>\n<p>用户角色关系</p>\n<ul>\n<li>添加用户-角色关系</li>\n<li>管理用户-角色关系</li>\n</ul>\n<h2 id=\"权限控制应用\"><a href=\"#权限控制应用\" class=\"headerlink\" title=\"权限控制应用\"></a>权限控制应用</h2><p>实现权限控制方法步骤：</p>\n<ol>\n<li>通过用户-角色关系表，获得用户所属角色</li>\n<li>从权限表中，获得所有权限列表，并应用无限级分类实现分类排序</li>\n<li>根据用户角色，通过角色-权限关系表获得当前拥有的权限几点信息</li>\n<li>组合所有权限列表，和当前拥有的权限数据，在所有权限节点列表中标识当前用户是否具有对各个节点的权限。去除当前用户没有权限操作的权限节点。将当前的权限信息保存到当前用户的会话中。</li>\n<li>用户进行操作各个权限节点时，首先检测当前的操作是否在会话中的权限信息中存在。不存在则按照权限不足处理，存在则继续进行操作。</li>\n</ol>\n<p>over~</p>\n","excerpt":"<p>RBAC，Role Based Access Control,基于角色的访问控制。实体关系如下：</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161007/RBACShiTiGuanXi.png\" alt=\"RBAC实体关系\"></p>","more":"<h2 id=\"实现逻辑设计\"><a href=\"#实现逻辑设计\" class=\"headerlink\" title=\"实现逻辑设计\"></a>实现逻辑设计</h2><p>用户表，user</p>\n<ul>\n<li>id,用户标识</li>\n<li>username，用户名</li>\n<li>passwd，密码</li>\n<li>status,状态</li>\n</ul>\n<p>角色表，role</p>\n<ul>\n<li>id,角色标识</li>\n<li>name，角色名称</li>\n<li>desc，角色描述</li>\n<li>status，状态</li>\n</ul>\n<p>权限节点表，node</p>\n<ul>\n<li>id，权限节点标识</li>\n<li>name，权限名称</li>\n<li>title，权限描述</li>\n<li>status，状态</li>\n<li>sort，排序</li>\n<li>pid，父标识</li>\n<li>level，层级（一般，1、项目，2、模块（类），3、操作（方法））</li>\n</ul>\n<p>用户角色关系表，role_user</p>\n<ul>\n<li>id，关系标识</li>\n<li>role_id,角色标识</li>\n<li>user_id,用户标识</li>\n</ul>\n<p>角色权限关系表, access</p>\n<ul>\n<li>id，关系标识</li>\n<li>role_id，角色标识</li>\n<li>node_id，权限标识</li>\n</ul>\n<h2 id=\"实现过程\"><a href=\"#实现过程\" class=\"headerlink\" title=\"实现过程\"></a>实现过程</h2><p>角色 –&gt; 权限节点 –&gt; 角色权限关系 –&gt; 用户 –&gt; 角色用户关系</p>\n<p>角色：</p>\n<ul>\n<li>创建角色</li>\n<li>角色管理</li>\n</ul>\n<p>权限</p>\n<ul>\n<li>添加权限节点</li>\n<li>权限管理</li>\n</ul>\n<p>权限节点列表的『权限结构』的递归显示问题，可用无限制分类来实现。</p>\n<p>无限制分类简单实现<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Tree</span></span>&#123;</div><div class=\"line\">  <span class=\"keyword\">static</span> <span class=\"keyword\">public</span> $treeList = <span class=\"keyword\">array</span>();  <span class=\"comment\">//存放无限制分类结果</span></div><div class=\"line\"></div><div class=\"line\">  <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">create</span><span class=\"params\">($data, $pid=<span class=\"number\">0</span>)</span></span>&#123;</div><div class=\"line\">    <span class=\"keyword\">foreach</span> ($data <span class=\"keyword\">as</span> $key =&gt; $value) &#123;</div><div class=\"line\">      <span class=\"keyword\">if</span>($value[<span class=\"string\">'pid'</span>] == $pid)&#123;</div><div class=\"line\">          <span class=\"keyword\">self</span>::$treeList[] = $value;</div><div class=\"line\">          <span class=\"keyword\">unset</span>($data[$key]);</div><div class=\"line\">          <span class=\"keyword\">self</span>::$create($data, $value[<span class=\"string\">'id'</span>]);</div><div class=\"line\">      &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">self</span>::$treeList;</div><div class=\"line\">  &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<p>角色权限关系</p>\n<ul>\n<li>添加角色-权限节点关系（添加角色新权限时，必须先删除原来的权限设置）</li>\n<li>管理角色-权限节点关系</li>\n</ul>\n<p>用户：</p>\n<ul>\n<li>添加用户</li>\n<li>用户管理</li>\n</ul>\n<p>用户角色关系</p>\n<ul>\n<li>添加用户-角色关系</li>\n<li>管理用户-角色关系</li>\n</ul>\n<h2 id=\"权限控制应用\"><a href=\"#权限控制应用\" class=\"headerlink\" title=\"权限控制应用\"></a>权限控制应用</h2><p>实现权限控制方法步骤：</p>\n<ol>\n<li>通过用户-角色关系表，获得用户所属角色</li>\n<li>从权限表中，获得所有权限列表，并应用无限级分类实现分类排序</li>\n<li>根据用户角色，通过角色-权限关系表获得当前拥有的权限几点信息</li>\n<li>组合所有权限列表，和当前拥有的权限数据，在所有权限节点列表中标识当前用户是否具有对各个节点的权限。去除当前用户没有权限操作的权限节点。将当前的权限信息保存到当前用户的会话中。</li>\n<li>用户进行操作各个权限节点时，首先检测当前的操作是否在会话中的权限信息中存在。不存在则按照权限不足处理，存在则继续进行操作。</li>\n</ol>\n<p>over~</p>"},{"title":"PHP魔术方法小结","date":"2016-10-06T14:30:00.000Z","_content":"\n魔术方法：\n> 一种特殊的函数\n\n<!-- more -->\n## 构造方法： \\__construct()  或者和类名同名的方法\n触发时机：在对象实例化的时候自动触发。\n\n作用：初始化成员属性\n\n参数：可以有，可以没有，取决于设定和逻辑\n\n返回值：没有\n\n注意：如果构造方法具有参数，且参数没有默认值，在实例化对象时，必须在类名()内添加对应的实参值。\n\n## 析构方法 \\__destruct()\n触发时机： 在销毁对象的时候自动触发(unset或者页面执行完毕)\n\n作用：回收对象使用过程中的资源。\n\n参数：没有\n\n返回值：没有\n\n## \\__get()\n触发时机：访问私有成员属性的时候自动触发\n\n功能：1.防止报错  2.为私有属性访问提供后门\n\n参数：1个    访问的私有属性名称\n\n返回值：可以有，可以没有\n\n## \\__set()\n触发时机: 对私有成员属性进行设置值的时候自动触发\n\n功能:1.屏蔽错误  2.为私有成员属性设置\n\n参数: 2个   1私有成员属性名  2 要设置的值\n\n返回值:无\n\n## \\__isset()\n\n触发时机:对私有成员属性进行isset检测时自动触发\n\n功能: 1.代替对象外部的isset检测，返回结果\n\n参数: 1个   1私有成员属性名\n\n返回值:有  一般返回 isset(属性)结果\n\n## \\__unset()\n\n触发时机:在对象外部对私有成员属性进行unset操作时自动触发\n\n功能: 1.代替对象外部的unset操作，返回结果\n\n参数: 1个   1私有成员属性名\n\n返回值:无\n\n## \\__sleep()\n\n触发时机：在对象进行串行化操作时触发.\n\n功能：指定需要串行化的成员属性.\n\n参数:无\n\n返回值: 需要返回一个数组类型，每个元素都是需要串行化的成员属性名.\n\n## \\__wakeup()\n\n触发时机：.在对象进行反串行化时自动触发\n\n功能：.反串行化时自动修改部分成员属性值.\n\n参数:无\n\n返回值: 无\n\n## \\__tostring()\n触发时机：对一个对象进行echo操作时 自动触发\n\n功能：简化操作或者为对象输出值\n\n参数:无\n\n返回值:必须有且必须为字符串类型.\n\n## \\__clone()\n触发时机:对对象进行克隆操作时自动触发\n\n功能：修改克隆之后的对象的部分属性值.\n\n参数:无\n\n返回值:无\n\n注意：对象的赋值默认就是引用赋值，不能通过赋值操作获取一个新的对象，获取新对象的操作应该使用克隆操作\n\n格式： 变量=clone 对象变量\n\n## \\__call（）\n\n触发时机:\t调用了类中不存在的方法时自动触发\n\n功能：1.屏蔽错误  2.为不存在的方法定义个一个功能.\n\n参数:2个   1 不存在的方法名   2所有的实参组成的数组\n\n返回值:可有可无(根据实际功能来看)\n\n## \\__autoload()(唯一一个类外部的魔术方法)\n\n触发时机:\t当页面中需要一个 类而该类不存在时自动触发\n\n功能：实现类的自动加载.\n\n参数1个 不存在的类名\n","source":"_posts/PHP魔术方法小结.md","raw":"---\ntitle: PHP魔术方法小结\ndate: 2016-10-06 22:30:00\ncategories:\n- PHP\n---\n\n魔术方法：\n> 一种特殊的函数\n\n<!-- more -->\n## 构造方法： \\__construct()  或者和类名同名的方法\n触发时机：在对象实例化的时候自动触发。\n\n作用：初始化成员属性\n\n参数：可以有，可以没有，取决于设定和逻辑\n\n返回值：没有\n\n注意：如果构造方法具有参数，且参数没有默认值，在实例化对象时，必须在类名()内添加对应的实参值。\n\n## 析构方法 \\__destruct()\n触发时机： 在销毁对象的时候自动触发(unset或者页面执行完毕)\n\n作用：回收对象使用过程中的资源。\n\n参数：没有\n\n返回值：没有\n\n## \\__get()\n触发时机：访问私有成员属性的时候自动触发\n\n功能：1.防止报错  2.为私有属性访问提供后门\n\n参数：1个    访问的私有属性名称\n\n返回值：可以有，可以没有\n\n## \\__set()\n触发时机: 对私有成员属性进行设置值的时候自动触发\n\n功能:1.屏蔽错误  2.为私有成员属性设置\n\n参数: 2个   1私有成员属性名  2 要设置的值\n\n返回值:无\n\n## \\__isset()\n\n触发时机:对私有成员属性进行isset检测时自动触发\n\n功能: 1.代替对象外部的isset检测，返回结果\n\n参数: 1个   1私有成员属性名\n\n返回值:有  一般返回 isset(属性)结果\n\n## \\__unset()\n\n触发时机:在对象外部对私有成员属性进行unset操作时自动触发\n\n功能: 1.代替对象外部的unset操作，返回结果\n\n参数: 1个   1私有成员属性名\n\n返回值:无\n\n## \\__sleep()\n\n触发时机：在对象进行串行化操作时触发.\n\n功能：指定需要串行化的成员属性.\n\n参数:无\n\n返回值: 需要返回一个数组类型，每个元素都是需要串行化的成员属性名.\n\n## \\__wakeup()\n\n触发时机：.在对象进行反串行化时自动触发\n\n功能：.反串行化时自动修改部分成员属性值.\n\n参数:无\n\n返回值: 无\n\n## \\__tostring()\n触发时机：对一个对象进行echo操作时 自动触发\n\n功能：简化操作或者为对象输出值\n\n参数:无\n\n返回值:必须有且必须为字符串类型.\n\n## \\__clone()\n触发时机:对对象进行克隆操作时自动触发\n\n功能：修改克隆之后的对象的部分属性值.\n\n参数:无\n\n返回值:无\n\n注意：对象的赋值默认就是引用赋值，不能通过赋值操作获取一个新的对象，获取新对象的操作应该使用克隆操作\n\n格式： 变量=clone 对象变量\n\n## \\__call（）\n\n触发时机:\t调用了类中不存在的方法时自动触发\n\n功能：1.屏蔽错误  2.为不存在的方法定义个一个功能.\n\n参数:2个   1 不存在的方法名   2所有的实参组成的数组\n\n返回值:可有可无(根据实际功能来看)\n\n## \\__autoload()(唯一一个类外部的魔术方法)\n\n触发时机:\t当页面中需要一个 类而该类不存在时自动触发\n\n功能：实现类的自动加载.\n\n参数1个 不存在的类名\n","slug":"PHP魔术方法小结","published":1,"updated":"2016-10-07T13:24:03.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwx0003e699fjl1hpahs","content":"<p>魔术方法：</p>\n<blockquote>\n<p>一种特殊的函数</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"构造方法：-construct-或者和类名同名的方法\"><a href=\"#构造方法：-construct-或者和类名同名的方法\" class=\"headerlink\" title=\"构造方法： __construct()  或者和类名同名的方法\"></a>构造方法： __construct()  或者和类名同名的方法</h2><p>触发时机：在对象实例化的时候自动触发。</p>\n<p>作用：初始化成员属性</p>\n<p>参数：可以有，可以没有，取决于设定和逻辑</p>\n<p>返回值：没有</p>\n<p>注意：如果构造方法具有参数，且参数没有默认值，在实例化对象时，必须在类名()内添加对应的实参值。</p>\n<h2 id=\"析构方法-destruct\"><a href=\"#析构方法-destruct\" class=\"headerlink\" title=\"析构方法 __destruct()\"></a>析构方法 __destruct()</h2><p>触发时机： 在销毁对象的时候自动触发(unset或者页面执行完毕)</p>\n<p>作用：回收对象使用过程中的资源。</p>\n<p>参数：没有</p>\n<p>返回值：没有</p>\n<h2 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"__get()\"></a>__get()</h2><p>触发时机：访问私有成员属性的时候自动触发</p>\n<p>功能：1.防止报错  2.为私有属性访问提供后门</p>\n<p>参数：1个    访问的私有属性名称</p>\n<p>返回值：可以有，可以没有</p>\n<h2 id=\"set\"><a href=\"#set\" class=\"headerlink\" title=\"__set()\"></a>__set()</h2><p>触发时机: 对私有成员属性进行设置值的时候自动触发</p>\n<p>功能:1.屏蔽错误  2.为私有成员属性设置</p>\n<p>参数: 2个   1私有成员属性名  2 要设置的值</p>\n<p>返回值:无</p>\n<h2 id=\"isset\"><a href=\"#isset\" class=\"headerlink\" title=\"__isset()\"></a>__isset()</h2><p>触发时机:对私有成员属性进行isset检测时自动触发</p>\n<p>功能: 1.代替对象外部的isset检测，返回结果</p>\n<p>参数: 1个   1私有成员属性名</p>\n<p>返回值:有  一般返回 isset(属性)结果</p>\n<h2 id=\"unset\"><a href=\"#unset\" class=\"headerlink\" title=\"__unset()\"></a>__unset()</h2><p>触发时机:在对象外部对私有成员属性进行unset操作时自动触发</p>\n<p>功能: 1.代替对象外部的unset操作，返回结果</p>\n<p>参数: 1个   1私有成员属性名</p>\n<p>返回值:无</p>\n<h2 id=\"sleep\"><a href=\"#sleep\" class=\"headerlink\" title=\"__sleep()\"></a>__sleep()</h2><p>触发时机：在对象进行串行化操作时触发.</p>\n<p>功能：指定需要串行化的成员属性.</p>\n<p>参数:无</p>\n<p>返回值: 需要返回一个数组类型，每个元素都是需要串行化的成员属性名.</p>\n<h2 id=\"wakeup\"><a href=\"#wakeup\" class=\"headerlink\" title=\"__wakeup()\"></a>__wakeup()</h2><p>触发时机：.在对象进行反串行化时自动触发</p>\n<p>功能：.反串行化时自动修改部分成员属性值.</p>\n<p>参数:无</p>\n<p>返回值: 无</p>\n<h2 id=\"tostring\"><a href=\"#tostring\" class=\"headerlink\" title=\"__tostring()\"></a>__tostring()</h2><p>触发时机：对一个对象进行echo操作时 自动触发</p>\n<p>功能：简化操作或者为对象输出值</p>\n<p>参数:无</p>\n<p>返回值:必须有且必须为字符串类型.</p>\n<h2 id=\"clone\"><a href=\"#clone\" class=\"headerlink\" title=\"__clone()\"></a>__clone()</h2><p>触发时机:对对象进行克隆操作时自动触发</p>\n<p>功能：修改克隆之后的对象的部分属性值.</p>\n<p>参数:无</p>\n<p>返回值:无</p>\n<p>注意：对象的赋值默认就是引用赋值，不能通过赋值操作获取一个新的对象，获取新对象的操作应该使用克隆操作</p>\n<p>格式： 变量=clone 对象变量</p>\n<h2 id=\"call（）\"><a href=\"#call（）\" class=\"headerlink\" title=\"__call（）\"></a>__call（）</h2><p>触发时机:    调用了类中不存在的方法时自动触发</p>\n<p>功能：1.屏蔽错误  2.为不存在的方法定义个一个功能.</p>\n<p>参数:2个   1 不存在的方法名   2所有的实参组成的数组</p>\n<p>返回值:可有可无(根据实际功能来看)</p>\n<h2 id=\"autoload-唯一一个类外部的魔术方法\"><a href=\"#autoload-唯一一个类外部的魔术方法\" class=\"headerlink\" title=\"__autoload()(唯一一个类外部的魔术方法)\"></a>__autoload()(唯一一个类外部的魔术方法)</h2><p>触发时机:    当页面中需要一个 类而该类不存在时自动触发</p>\n<p>功能：实现类的自动加载.</p>\n<p>参数1个 不存在的类名</p>\n","excerpt":"<p>魔术方法：</p>\n<blockquote>\n<p>一种特殊的函数</p>\n</blockquote>","more":"<h2 id=\"构造方法：-construct-或者和类名同名的方法\"><a href=\"#构造方法：-construct-或者和类名同名的方法\" class=\"headerlink\" title=\"构造方法： __construct()  或者和类名同名的方法\"></a>构造方法： __construct()  或者和类名同名的方法</h2><p>触发时机：在对象实例化的时候自动触发。</p>\n<p>作用：初始化成员属性</p>\n<p>参数：可以有，可以没有，取决于设定和逻辑</p>\n<p>返回值：没有</p>\n<p>注意：如果构造方法具有参数，且参数没有默认值，在实例化对象时，必须在类名()内添加对应的实参值。</p>\n<h2 id=\"析构方法-destruct\"><a href=\"#析构方法-destruct\" class=\"headerlink\" title=\"析构方法 __destruct()\"></a>析构方法 __destruct()</h2><p>触发时机： 在销毁对象的时候自动触发(unset或者页面执行完毕)</p>\n<p>作用：回收对象使用过程中的资源。</p>\n<p>参数：没有</p>\n<p>返回值：没有</p>\n<h2 id=\"get\"><a href=\"#get\" class=\"headerlink\" title=\"__get()\"></a>__get()</h2><p>触发时机：访问私有成员属性的时候自动触发</p>\n<p>功能：1.防止报错  2.为私有属性访问提供后门</p>\n<p>参数：1个    访问的私有属性名称</p>\n<p>返回值：可以有，可以没有</p>\n<h2 id=\"set\"><a href=\"#set\" class=\"headerlink\" title=\"__set()\"></a>__set()</h2><p>触发时机: 对私有成员属性进行设置值的时候自动触发</p>\n<p>功能:1.屏蔽错误  2.为私有成员属性设置</p>\n<p>参数: 2个   1私有成员属性名  2 要设置的值</p>\n<p>返回值:无</p>\n<h2 id=\"isset\"><a href=\"#isset\" class=\"headerlink\" title=\"__isset()\"></a>__isset()</h2><p>触发时机:对私有成员属性进行isset检测时自动触发</p>\n<p>功能: 1.代替对象外部的isset检测，返回结果</p>\n<p>参数: 1个   1私有成员属性名</p>\n<p>返回值:有  一般返回 isset(属性)结果</p>\n<h2 id=\"unset\"><a href=\"#unset\" class=\"headerlink\" title=\"__unset()\"></a>__unset()</h2><p>触发时机:在对象外部对私有成员属性进行unset操作时自动触发</p>\n<p>功能: 1.代替对象外部的unset操作，返回结果</p>\n<p>参数: 1个   1私有成员属性名</p>\n<p>返回值:无</p>\n<h2 id=\"sleep\"><a href=\"#sleep\" class=\"headerlink\" title=\"__sleep()\"></a>__sleep()</h2><p>触发时机：在对象进行串行化操作时触发.</p>\n<p>功能：指定需要串行化的成员属性.</p>\n<p>参数:无</p>\n<p>返回值: 需要返回一个数组类型，每个元素都是需要串行化的成员属性名.</p>\n<h2 id=\"wakeup\"><a href=\"#wakeup\" class=\"headerlink\" title=\"__wakeup()\"></a>__wakeup()</h2><p>触发时机：.在对象进行反串行化时自动触发</p>\n<p>功能：.反串行化时自动修改部分成员属性值.</p>\n<p>参数:无</p>\n<p>返回值: 无</p>\n<h2 id=\"tostring\"><a href=\"#tostring\" class=\"headerlink\" title=\"__tostring()\"></a>__tostring()</h2><p>触发时机：对一个对象进行echo操作时 自动触发</p>\n<p>功能：简化操作或者为对象输出值</p>\n<p>参数:无</p>\n<p>返回值:必须有且必须为字符串类型.</p>\n<h2 id=\"clone\"><a href=\"#clone\" class=\"headerlink\" title=\"__clone()\"></a>__clone()</h2><p>触发时机:对对象进行克隆操作时自动触发</p>\n<p>功能：修改克隆之后的对象的部分属性值.</p>\n<p>参数:无</p>\n<p>返回值:无</p>\n<p>注意：对象的赋值默认就是引用赋值，不能通过赋值操作获取一个新的对象，获取新对象的操作应该使用克隆操作</p>\n<p>格式： 变量=clone 对象变量</p>\n<h2 id=\"call（）\"><a href=\"#call（）\" class=\"headerlink\" title=\"__call（）\"></a>__call（）</h2><p>触发时机:    调用了类中不存在的方法时自动触发</p>\n<p>功能：1.屏蔽错误  2.为不存在的方法定义个一个功能.</p>\n<p>参数:2个   1 不存在的方法名   2所有的实参组成的数组</p>\n<p>返回值:可有可无(根据实际功能来看)</p>\n<h2 id=\"autoload-唯一一个类外部的魔术方法\"><a href=\"#autoload-唯一一个类外部的魔术方法\" class=\"headerlink\" title=\"__autoload()(唯一一个类外部的魔术方法)\"></a>__autoload()(唯一一个类外部的魔术方法)</h2><p>触发时机:    当页面中需要一个 类而该类不存在时自动触发</p>\n<p>功能：实现类的自动加载.</p>\n<p>参数1个 不存在的类名</p>"},{"title":"PHP输出缓冲区","date":"2016-10-07T13:30:00.000Z","_content":"\n\n\n## 什么是缓冲区?\n简单而言,缓冲区的作用就是,把输入或者输出的内容先放进内存,而不显示或者读取.\n\n其实缓冲区最本质的作用就是,协调高速CPU和相对缓慢的IO设备(磁盘等)的运作.\n\n\n\n## PHP在执行的时候,在什么地方有用到缓冲区?\n\n想要了解PHP的缓冲区,就要知道执行PHP的时候,缓冲区被设置到了什么地方.\n\n当执行PHP的时候,如果碰到了echo print_r之类的会输出数据的代码,PHP就会将要输出的数据放到PHP自身的缓冲区,等待输出.\n\n当PHP自身的缓冲区接到指令,指示要输出缓冲区的内容时,将会把缓冲区内的数据输出到apache上, apache接受到PHP输出的数据,然后再把该数据存在到apache自身的缓冲区内,等到输出。\n\n当apache接受到指令,只是要输出缓冲区的内容时, 将会把缓冲区的内容输出,返回到浏览器.\n\n由此可见,PHP要输出数据的时候,将会经过两个缓冲区(先是自身的,然后是apache的),再返回到浏览器.\n\n<!-- more -->\n\n## 缓冲区在PHP中起到什么作用?\n\n### 最常见的就是在使用header函数之前\n\nheader();函数要求在其之前不能有输出。如在header之前有输出时会报错： Cannot modify header information – headers already sent by;\n\n```\necho \"this is test\";\nheader(\"LOCATION http://www.baidu.com\");\n```\n\n\n出现这个错误的原因是, 在header之前已经输出了某些数据,而输出这些数据的同时, apache将会同时发送一个响应状态到浏览器上(既然有输出,即这个请求是有效的),而其后你又再次使用header函数发送http头,则会返回这个错误,错误的意思是:HTTP头已经发送出去了,你不能对他再做修改.\n\n为什么使用缓冲区可以避免这个错误呢?\n\n因为header函数是不受缓冲区影响的,当一碰到header函数的时候,PHP马上执行apache发送这一个http头都浏览器.\n而输出的数据PHP打开输出缓冲区后, 这些数据将会存放在缓冲区,等待输出.这样就可以避免了之前所发生的错误.\n\n### 通过PHP写文件下载程序的时候.\n为了让文件下载更安全,同时提高更多的可控性,很多朋友都喜欢用PHP写文件下载页面.\n\n其原理很简单,就是通过fwrite把文件内容读出并显示,然后通过header来发送HTTP头,让浏览器知道这是一个附件,这样就可以达到提供下载的效果.\n\n如果用上面的办法提供下载页面,会碰到一个效率问题,如果一个文件很大,假设为100M,那么在不开启缓冲区输出的情况下,必须要把100M数据全部读出,然后一次返回到页面上,如果这样做,用户将会在所有数据读完之后才会得到响应,降低了用户体验感.\n\n如果开启了输出缓冲区,当PHP程序读完文件的某一段,然后马上输出到apache,然后让apache马上返回到浏览器,这样就可以减少用户等待时间.\n\n那后面的数据怎么办呢?\n\n我们可以写一个while循环,一直一段一段地读取文件，每读一段,就马上输出,直到把文件全部输出为止,这样浏览器就可以持续地接受到数据,而不必等到所有文件读取完毕.\n\n另外,该做法还解决了另外一个很严重的问题.\n\n例如一个文件是100M,如果不开启缓冲区的情况下,则需要把100M文件全部读入内存,然后再输出.\n\n但是,如果PHP程序做了内存限制呢?\n为了保证服务器的稳定,管理员通常会把PHP的执行内存设一个限制(通过php.ini总的memory_limit, 其默认值是8M), 也就是每个PHP程序使用的内存不能使用超过这个值的内存.\n\n假设该值为8M,而要读入的文件是100M,根本就没有足够的内存来读入该文件.这个时候,我们就需要用到上面的办法来解决这个问题,每次只读某一段,这样就可以避免了内存的限制\n\n### 静态文件缓存\n现在很多公司有这么一个需求, 就是某一个页面在第一次访问的时候,会执行PHP,然后把显示的内容返回到浏览器,同时需要把这次显示的内容保存到服务器上,这样下次访问的时候,就直接把保存在服务器上的文件直接显示,而不需要通过PHP来做操作这就是所谓的”静态页面缓存”.\n\n那怎么样才能做到把内容返回到浏览器的同时把数据保存到服务器上呢?\n\n这就要用到输出缓冲区了.\n\n```\nob_start();\necho 'aaa';\n$string = ob_get_contents();\nfile_put_contents('a.html', $string);\nob_flush();\nflush();\n```\n## 与输出缓冲区有关的配置\n在PHP.INI中,有两个跟缓冲区紧密相关的配置项\n### output_buffering\n该配置直接影响的是php本身的缓冲区,有3种配置参数.on/off/xK(x为某个整型数值);\n```\non    - 开启缓冲区\noff    - 关闭缓冲区\n256k    - 开启缓冲区,而且当缓冲区的内容超过256k的时候,自动刷新缓冲区(把数据发送到apache);\n```\n### implicit_flush\n该配置直接影响apache的缓冲区,有2种配置参数. on/off\n```\non    - 自动刷新apache缓冲区,也就是,当php发送数据到apache的缓冲区的时候,不需要等待其他指令,直接就把输出返回到浏览器\noff    - 不自动刷新apache缓冲区,接受到数据后,等待刷新指令\n```\n## 与缓冲区有关的函数\n- ob_implicit_flush\n> 作用和implicit_flush一样,是否自动刷新apache的缓冲区\n\n- flush\n> 作用是发送指令到apache,让apache刷新自身的输出缓冲区.\n\n- ob_start\n> 打开输出缓冲区,无论php.ini的文件如何配置,如果使用该函数,即使output_buffering设置成off,也会打开输出缓冲区\n>\n>ob_start函数还接受一个参数,该参数是一个函数的回调,意思是,在输入缓冲区内容之前,需要使用调用传递进来的参数把缓冲区的内容处理一次,再放入缓冲区内\n\n- ob_flush\n> 指示php本身刷新自身的缓冲区,把数据发送到apache\n\n- ob_clean\n> 清除php缓冲区里面的内容\n\n- ob_end_clean\n> 清除php缓冲区内的内容,并且关闭输出缓冲区\n\n- ob_end_flush\n> 把php自身的缓冲区里的内容发送到apache,并把清除自身缓冲区内的内容\n\n- ob_get_clean\n> 获取缓冲区的内容之后,清除缓冲区.\n\n- ob_get_contents\n> 获取输出缓冲区里的内容\n\n- ob_get_flush\n> 获取缓冲区里的内容,并且把这些内容发送到apache\n\n- ob_get_length\n> 获取缓冲区里内容的长度\n\n- ob_list_handlers\n> 获取运行ob_start时,所回调的函数名称, 例如:\n\n```\nob_start(‘ob_gzhandler’);\nprint_r(ob_list_handlers);\n```\n将打印出ob_gzhandler;\n\n- ob_gzhandler\n> 该函数的作用是作为ob_start的回调参数, 在缓冲区刷新之前,会调用该函数对数据进行到底gzip或者deflate压缩.这个函数需要zlib扩展的支持.\n\n## 使用缓冲区的相关内容\n- ob_flush和flush的次序关系.\n> 上面的分析可以看出,ob_flush是和php自身相关的,而flush操作的是apache的缓冲区,所有我们在使用这两个函数的时候,需要先执行ob_flush,\n再执行flush,因为我们需要先把数据从PHP上发送到apache,然后再由apache返回到浏览器.如果php还没有把数据刷新到apache,就调用了flush,则apache无任何数据返回到浏览器.\n\n- 有的浏览器,如果接受到的字符太少,则不会把数据显示出来\n> 例如老版的IE(必须要大于256k才显示).这样就会造成一个疑问, 明明在php和apache都进行了刷新缓冲区的操作,但是浏览器就是没有出现自己想要的数据,也许就是这个原因造成的.所以才测试的时候,可以在输出数据的后面加上多个空格,以填满数据,确定不会浏览器造成这类诡异的问题.\n\n- 有些webserver,他自身的输出缓冲区会有一些限制\n> 比如nginx,他有一个配置fastcgi_buffer_size 4k, 就是是表明,当自身的输出缓冲区的内容达到4K才会刷新,所以为了保证内容的数据,可以添加以下代码,保证内容长度\n```\n<?php\n  echo str_repeat(\" \",4096);\n?>\n```\n\n- 在apache中,如果你开启了mod_gzip的压缩模块,这样可能会导致你的flush函数刷新不成功\n> 其原因是,mod_gzip有自己的输出缓冲区,当php执行了flush函数,指示apache刷新输出缓冲区,但是内容需要压缩,apache就把内容输出到自身的mod_gzip模块,mod_gzip也有自身的输出 缓冲区,他也不会马上输出,所以造成了内容不能马上输出.为了改善这个情况,可以关闭mod_gzip模块,或者在httpd.conf增加以下内容,以禁止压缩\n\n\n转自：http://www.keepmyway.com/index.php/124.html\n","source":"_posts/PHP输出缓冲区.md","raw":"---\ntitle: PHP输出缓冲区\ndate: 2016-10-07 21:30:00\ncategories:\n- PHP\n---\n\n\n\n## 什么是缓冲区?\n简单而言,缓冲区的作用就是,把输入或者输出的内容先放进内存,而不显示或者读取.\n\n其实缓冲区最本质的作用就是,协调高速CPU和相对缓慢的IO设备(磁盘等)的运作.\n\n\n\n## PHP在执行的时候,在什么地方有用到缓冲区?\n\n想要了解PHP的缓冲区,就要知道执行PHP的时候,缓冲区被设置到了什么地方.\n\n当执行PHP的时候,如果碰到了echo print_r之类的会输出数据的代码,PHP就会将要输出的数据放到PHP自身的缓冲区,等待输出.\n\n当PHP自身的缓冲区接到指令,指示要输出缓冲区的内容时,将会把缓冲区内的数据输出到apache上, apache接受到PHP输出的数据,然后再把该数据存在到apache自身的缓冲区内,等到输出。\n\n当apache接受到指令,只是要输出缓冲区的内容时, 将会把缓冲区的内容输出,返回到浏览器.\n\n由此可见,PHP要输出数据的时候,将会经过两个缓冲区(先是自身的,然后是apache的),再返回到浏览器.\n\n<!-- more -->\n\n## 缓冲区在PHP中起到什么作用?\n\n### 最常见的就是在使用header函数之前\n\nheader();函数要求在其之前不能有输出。如在header之前有输出时会报错： Cannot modify header information – headers already sent by;\n\n```\necho \"this is test\";\nheader(\"LOCATION http://www.baidu.com\");\n```\n\n\n出现这个错误的原因是, 在header之前已经输出了某些数据,而输出这些数据的同时, apache将会同时发送一个响应状态到浏览器上(既然有输出,即这个请求是有效的),而其后你又再次使用header函数发送http头,则会返回这个错误,错误的意思是:HTTP头已经发送出去了,你不能对他再做修改.\n\n为什么使用缓冲区可以避免这个错误呢?\n\n因为header函数是不受缓冲区影响的,当一碰到header函数的时候,PHP马上执行apache发送这一个http头都浏览器.\n而输出的数据PHP打开输出缓冲区后, 这些数据将会存放在缓冲区,等待输出.这样就可以避免了之前所发生的错误.\n\n### 通过PHP写文件下载程序的时候.\n为了让文件下载更安全,同时提高更多的可控性,很多朋友都喜欢用PHP写文件下载页面.\n\n其原理很简单,就是通过fwrite把文件内容读出并显示,然后通过header来发送HTTP头,让浏览器知道这是一个附件,这样就可以达到提供下载的效果.\n\n如果用上面的办法提供下载页面,会碰到一个效率问题,如果一个文件很大,假设为100M,那么在不开启缓冲区输出的情况下,必须要把100M数据全部读出,然后一次返回到页面上,如果这样做,用户将会在所有数据读完之后才会得到响应,降低了用户体验感.\n\n如果开启了输出缓冲区,当PHP程序读完文件的某一段,然后马上输出到apache,然后让apache马上返回到浏览器,这样就可以减少用户等待时间.\n\n那后面的数据怎么办呢?\n\n我们可以写一个while循环,一直一段一段地读取文件，每读一段,就马上输出,直到把文件全部输出为止,这样浏览器就可以持续地接受到数据,而不必等到所有文件读取完毕.\n\n另外,该做法还解决了另外一个很严重的问题.\n\n例如一个文件是100M,如果不开启缓冲区的情况下,则需要把100M文件全部读入内存,然后再输出.\n\n但是,如果PHP程序做了内存限制呢?\n为了保证服务器的稳定,管理员通常会把PHP的执行内存设一个限制(通过php.ini总的memory_limit, 其默认值是8M), 也就是每个PHP程序使用的内存不能使用超过这个值的内存.\n\n假设该值为8M,而要读入的文件是100M,根本就没有足够的内存来读入该文件.这个时候,我们就需要用到上面的办法来解决这个问题,每次只读某一段,这样就可以避免了内存的限制\n\n### 静态文件缓存\n现在很多公司有这么一个需求, 就是某一个页面在第一次访问的时候,会执行PHP,然后把显示的内容返回到浏览器,同时需要把这次显示的内容保存到服务器上,这样下次访问的时候,就直接把保存在服务器上的文件直接显示,而不需要通过PHP来做操作这就是所谓的”静态页面缓存”.\n\n那怎么样才能做到把内容返回到浏览器的同时把数据保存到服务器上呢?\n\n这就要用到输出缓冲区了.\n\n```\nob_start();\necho 'aaa';\n$string = ob_get_contents();\nfile_put_contents('a.html', $string);\nob_flush();\nflush();\n```\n## 与输出缓冲区有关的配置\n在PHP.INI中,有两个跟缓冲区紧密相关的配置项\n### output_buffering\n该配置直接影响的是php本身的缓冲区,有3种配置参数.on/off/xK(x为某个整型数值);\n```\non    - 开启缓冲区\noff    - 关闭缓冲区\n256k    - 开启缓冲区,而且当缓冲区的内容超过256k的时候,自动刷新缓冲区(把数据发送到apache);\n```\n### implicit_flush\n该配置直接影响apache的缓冲区,有2种配置参数. on/off\n```\non    - 自动刷新apache缓冲区,也就是,当php发送数据到apache的缓冲区的时候,不需要等待其他指令,直接就把输出返回到浏览器\noff    - 不自动刷新apache缓冲区,接受到数据后,等待刷新指令\n```\n## 与缓冲区有关的函数\n- ob_implicit_flush\n> 作用和implicit_flush一样,是否自动刷新apache的缓冲区\n\n- flush\n> 作用是发送指令到apache,让apache刷新自身的输出缓冲区.\n\n- ob_start\n> 打开输出缓冲区,无论php.ini的文件如何配置,如果使用该函数,即使output_buffering设置成off,也会打开输出缓冲区\n>\n>ob_start函数还接受一个参数,该参数是一个函数的回调,意思是,在输入缓冲区内容之前,需要使用调用传递进来的参数把缓冲区的内容处理一次,再放入缓冲区内\n\n- ob_flush\n> 指示php本身刷新自身的缓冲区,把数据发送到apache\n\n- ob_clean\n> 清除php缓冲区里面的内容\n\n- ob_end_clean\n> 清除php缓冲区内的内容,并且关闭输出缓冲区\n\n- ob_end_flush\n> 把php自身的缓冲区里的内容发送到apache,并把清除自身缓冲区内的内容\n\n- ob_get_clean\n> 获取缓冲区的内容之后,清除缓冲区.\n\n- ob_get_contents\n> 获取输出缓冲区里的内容\n\n- ob_get_flush\n> 获取缓冲区里的内容,并且把这些内容发送到apache\n\n- ob_get_length\n> 获取缓冲区里内容的长度\n\n- ob_list_handlers\n> 获取运行ob_start时,所回调的函数名称, 例如:\n\n```\nob_start(‘ob_gzhandler’);\nprint_r(ob_list_handlers);\n```\n将打印出ob_gzhandler;\n\n- ob_gzhandler\n> 该函数的作用是作为ob_start的回调参数, 在缓冲区刷新之前,会调用该函数对数据进行到底gzip或者deflate压缩.这个函数需要zlib扩展的支持.\n\n## 使用缓冲区的相关内容\n- ob_flush和flush的次序关系.\n> 上面的分析可以看出,ob_flush是和php自身相关的,而flush操作的是apache的缓冲区,所有我们在使用这两个函数的时候,需要先执行ob_flush,\n再执行flush,因为我们需要先把数据从PHP上发送到apache,然后再由apache返回到浏览器.如果php还没有把数据刷新到apache,就调用了flush,则apache无任何数据返回到浏览器.\n\n- 有的浏览器,如果接受到的字符太少,则不会把数据显示出来\n> 例如老版的IE(必须要大于256k才显示).这样就会造成一个疑问, 明明在php和apache都进行了刷新缓冲区的操作,但是浏览器就是没有出现自己想要的数据,也许就是这个原因造成的.所以才测试的时候,可以在输出数据的后面加上多个空格,以填满数据,确定不会浏览器造成这类诡异的问题.\n\n- 有些webserver,他自身的输出缓冲区会有一些限制\n> 比如nginx,他有一个配置fastcgi_buffer_size 4k, 就是是表明,当自身的输出缓冲区的内容达到4K才会刷新,所以为了保证内容的数据,可以添加以下代码,保证内容长度\n```\n<?php\n  echo str_repeat(\" \",4096);\n?>\n```\n\n- 在apache中,如果你开启了mod_gzip的压缩模块,这样可能会导致你的flush函数刷新不成功\n> 其原因是,mod_gzip有自己的输出缓冲区,当php执行了flush函数,指示apache刷新输出缓冲区,但是内容需要压缩,apache就把内容输出到自身的mod_gzip模块,mod_gzip也有自身的输出 缓冲区,他也不会马上输出,所以造成了内容不能马上输出.为了改善这个情况,可以关闭mod_gzip模块,或者在httpd.conf增加以下内容,以禁止压缩\n\n\n转自：http://www.keepmyway.com/index.php/124.html\n","slug":"PHP输出缓冲区","published":1,"updated":"2016-10-08T15:27:45.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwx1003h699fz28bsfce","content":"<h2 id=\"什么是缓冲区\"><a href=\"#什么是缓冲区\" class=\"headerlink\" title=\"什么是缓冲区?\"></a>什么是缓冲区?</h2><p>简单而言,缓冲区的作用就是,把输入或者输出的内容先放进内存,而不显示或者读取.</p>\n<p>其实缓冲区最本质的作用就是,协调高速CPU和相对缓慢的IO设备(磁盘等)的运作.</p>\n<h2 id=\"PHP在执行的时候-在什么地方有用到缓冲区\"><a href=\"#PHP在执行的时候-在什么地方有用到缓冲区\" class=\"headerlink\" title=\"PHP在执行的时候,在什么地方有用到缓冲区?\"></a>PHP在执行的时候,在什么地方有用到缓冲区?</h2><p>想要了解PHP的缓冲区,就要知道执行PHP的时候,缓冲区被设置到了什么地方.</p>\n<p>当执行PHP的时候,如果碰到了echo print_r之类的会输出数据的代码,PHP就会将要输出的数据放到PHP自身的缓冲区,等待输出.</p>\n<p>当PHP自身的缓冲区接到指令,指示要输出缓冲区的内容时,将会把缓冲区内的数据输出到apache上, apache接受到PHP输出的数据,然后再把该数据存在到apache自身的缓冲区内,等到输出。</p>\n<p>当apache接受到指令,只是要输出缓冲区的内容时, 将会把缓冲区的内容输出,返回到浏览器.</p>\n<p>由此可见,PHP要输出数据的时候,将会经过两个缓冲区(先是自身的,然后是apache的),再返回到浏览器.</p>\n<a id=\"more\"></a>\n<h2 id=\"缓冲区在PHP中起到什么作用\"><a href=\"#缓冲区在PHP中起到什么作用\" class=\"headerlink\" title=\"缓冲区在PHP中起到什么作用?\"></a>缓冲区在PHP中起到什么作用?</h2><h3 id=\"最常见的就是在使用header函数之前\"><a href=\"#最常见的就是在使用header函数之前\" class=\"headerlink\" title=\"最常见的就是在使用header函数之前\"></a>最常见的就是在使用header函数之前</h3><p>header();函数要求在其之前不能有输出。如在header之前有输出时会报错： Cannot modify header information – headers already sent by;</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;this is test&quot;;</div><div class=\"line\">header(&quot;LOCATION http://www.baidu.com&quot;);</div></pre></td></tr></table></figure>\n<p>出现这个错误的原因是, 在header之前已经输出了某些数据,而输出这些数据的同时, apache将会同时发送一个响应状态到浏览器上(既然有输出,即这个请求是有效的),而其后你又再次使用header函数发送http头,则会返回这个错误,错误的意思是:HTTP头已经发送出去了,你不能对他再做修改.</p>\n<p>为什么使用缓冲区可以避免这个错误呢?</p>\n<p>因为header函数是不受缓冲区影响的,当一碰到header函数的时候,PHP马上执行apache发送这一个http头都浏览器.<br>而输出的数据PHP打开输出缓冲区后, 这些数据将会存放在缓冲区,等待输出.这样就可以避免了之前所发生的错误.</p>\n<h3 id=\"通过PHP写文件下载程序的时候\"><a href=\"#通过PHP写文件下载程序的时候\" class=\"headerlink\" title=\"通过PHP写文件下载程序的时候.\"></a>通过PHP写文件下载程序的时候.</h3><p>为了让文件下载更安全,同时提高更多的可控性,很多朋友都喜欢用PHP写文件下载页面.</p>\n<p>其原理很简单,就是通过fwrite把文件内容读出并显示,然后通过header来发送HTTP头,让浏览器知道这是一个附件,这样就可以达到提供下载的效果.</p>\n<p>如果用上面的办法提供下载页面,会碰到一个效率问题,如果一个文件很大,假设为100M,那么在不开启缓冲区输出的情况下,必须要把100M数据全部读出,然后一次返回到页面上,如果这样做,用户将会在所有数据读完之后才会得到响应,降低了用户体验感.</p>\n<p>如果开启了输出缓冲区,当PHP程序读完文件的某一段,然后马上输出到apache,然后让apache马上返回到浏览器,这样就可以减少用户等待时间.</p>\n<p>那后面的数据怎么办呢?</p>\n<p>我们可以写一个while循环,一直一段一段地读取文件，每读一段,就马上输出,直到把文件全部输出为止,这样浏览器就可以持续地接受到数据,而不必等到所有文件读取完毕.</p>\n<p>另外,该做法还解决了另外一个很严重的问题.</p>\n<p>例如一个文件是100M,如果不开启缓冲区的情况下,则需要把100M文件全部读入内存,然后再输出.</p>\n<p>但是,如果PHP程序做了内存限制呢?<br>为了保证服务器的稳定,管理员通常会把PHP的执行内存设一个限制(通过php.ini总的memory_limit, 其默认值是8M), 也就是每个PHP程序使用的内存不能使用超过这个值的内存.</p>\n<p>假设该值为8M,而要读入的文件是100M,根本就没有足够的内存来读入该文件.这个时候,我们就需要用到上面的办法来解决这个问题,每次只读某一段,这样就可以避免了内存的限制</p>\n<h3 id=\"静态文件缓存\"><a href=\"#静态文件缓存\" class=\"headerlink\" title=\"静态文件缓存\"></a>静态文件缓存</h3><p>现在很多公司有这么一个需求, 就是某一个页面在第一次访问的时候,会执行PHP,然后把显示的内容返回到浏览器,同时需要把这次显示的内容保存到服务器上,这样下次访问的时候,就直接把保存在服务器上的文件直接显示,而不需要通过PHP来做操作这就是所谓的”静态页面缓存”.</p>\n<p>那怎么样才能做到把内容返回到浏览器的同时把数据保存到服务器上呢?</p>\n<p>这就要用到输出缓冲区了.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">ob_start();</div><div class=\"line\">echo &apos;aaa&apos;;</div><div class=\"line\">$string = ob_get_contents();</div><div class=\"line\">file_put_contents(&apos;a.html&apos;, $string);</div><div class=\"line\">ob_flush();</div><div class=\"line\">flush();</div></pre></td></tr></table></figure>\n<h2 id=\"与输出缓冲区有关的配置\"><a href=\"#与输出缓冲区有关的配置\" class=\"headerlink\" title=\"与输出缓冲区有关的配置\"></a>与输出缓冲区有关的配置</h2><p>在PHP.INI中,有两个跟缓冲区紧密相关的配置项</p>\n<h3 id=\"output-buffering\"><a href=\"#output-buffering\" class=\"headerlink\" title=\"output_buffering\"></a>output_buffering</h3><p>该配置直接影响的是php本身的缓冲区,有3种配置参数.on/off/xK(x为某个整型数值);<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">on    - 开启缓冲区</div><div class=\"line\">off    - 关闭缓冲区</div><div class=\"line\">256k    - 开启缓冲区,而且当缓冲区的内容超过256k的时候,自动刷新缓冲区(把数据发送到apache);</div></pre></td></tr></table></figure></p>\n<h3 id=\"implicit-flush\"><a href=\"#implicit-flush\" class=\"headerlink\" title=\"implicit_flush\"></a>implicit_flush</h3><p>该配置直接影响apache的缓冲区,有2种配置参数. on/off<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">on    - 自动刷新apache缓冲区,也就是,当php发送数据到apache的缓冲区的时候,不需要等待其他指令,直接就把输出返回到浏览器</div><div class=\"line\">off    - 不自动刷新apache缓冲区,接受到数据后,等待刷新指令</div></pre></td></tr></table></figure></p>\n<h2 id=\"与缓冲区有关的函数\"><a href=\"#与缓冲区有关的函数\" class=\"headerlink\" title=\"与缓冲区有关的函数\"></a>与缓冲区有关的函数</h2><ul>\n<li><p>ob_implicit_flush</p>\n<blockquote>\n<p>作用和implicit_flush一样,是否自动刷新apache的缓冲区</p>\n</blockquote>\n</li>\n<li><p>flush</p>\n<blockquote>\n<p>作用是发送指令到apache,让apache刷新自身的输出缓冲区.</p>\n</blockquote>\n</li>\n<li><p>ob_start</p>\n<blockquote>\n<p>打开输出缓冲区,无论php.ini的文件如何配置,如果使用该函数,即使output_buffering设置成off,也会打开输出缓冲区</p>\n<p>ob_start函数还接受一个参数,该参数是一个函数的回调,意思是,在输入缓冲区内容之前,需要使用调用传递进来的参数把缓冲区的内容处理一次,再放入缓冲区内</p>\n</blockquote>\n</li>\n<li><p>ob_flush</p>\n<blockquote>\n<p>指示php本身刷新自身的缓冲区,把数据发送到apache</p>\n</blockquote>\n</li>\n<li><p>ob_clean</p>\n<blockquote>\n<p>清除php缓冲区里面的内容</p>\n</blockquote>\n</li>\n<li><p>ob_end_clean</p>\n<blockquote>\n<p>清除php缓冲区内的内容,并且关闭输出缓冲区</p>\n</blockquote>\n</li>\n<li><p>ob_end_flush</p>\n<blockquote>\n<p>把php自身的缓冲区里的内容发送到apache,并把清除自身缓冲区内的内容</p>\n</blockquote>\n</li>\n<li><p>ob_get_clean</p>\n<blockquote>\n<p>获取缓冲区的内容之后,清除缓冲区.</p>\n</blockquote>\n</li>\n<li><p>ob_get_contents</p>\n<blockquote>\n<p>获取输出缓冲区里的内容</p>\n</blockquote>\n</li>\n<li><p>ob_get_flush</p>\n<blockquote>\n<p>获取缓冲区里的内容,并且把这些内容发送到apache</p>\n</blockquote>\n</li>\n<li><p>ob_get_length</p>\n<blockquote>\n<p>获取缓冲区里内容的长度</p>\n</blockquote>\n</li>\n<li><p>ob_list_handlers</p>\n<blockquote>\n<p>获取运行ob_start时,所回调的函数名称, 例如:</p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ob_start(‘ob_gzhandler’);</div><div class=\"line\">print_r(ob_list_handlers);</div></pre></td></tr></table></figure>\n<p>将打印出ob_gzhandler;</p>\n<ul>\n<li>ob_gzhandler<blockquote>\n<p>该函数的作用是作为ob_start的回调参数, 在缓冲区刷新之前,会调用该函数对数据进行到底gzip或者deflate压缩.这个函数需要zlib扩展的支持.</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"使用缓冲区的相关内容\"><a href=\"#使用缓冲区的相关内容\" class=\"headerlink\" title=\"使用缓冲区的相关内容\"></a>使用缓冲区的相关内容</h2><ul>\n<li><p>ob_flush和flush的次序关系.</p>\n<blockquote>\n<p>上面的分析可以看出,ob_flush是和php自身相关的,而flush操作的是apache的缓冲区,所有我们在使用这两个函数的时候,需要先执行ob_flush,<br>再执行flush,因为我们需要先把数据从PHP上发送到apache,然后再由apache返回到浏览器.如果php还没有把数据刷新到apache,就调用了flush,则apache无任何数据返回到浏览器.</p>\n</blockquote>\n</li>\n<li><p>有的浏览器,如果接受到的字符太少,则不会把数据显示出来</p>\n<blockquote>\n<p>例如老版的IE(必须要大于256k才显示).这样就会造成一个疑问, 明明在php和apache都进行了刷新缓冲区的操作,但是浏览器就是没有出现自己想要的数据,也许就是这个原因造成的.所以才测试的时候,可以在输出数据的后面加上多个空格,以填满数据,确定不会浏览器造成这类诡异的问题.</p>\n</blockquote>\n</li>\n<li><p>有些webserver,他自身的输出缓冲区会有一些限制</p>\n<blockquote>\n<p>比如nginx,他有一个配置fastcgi_buffer_size 4k, 就是是表明,当自身的输出缓冲区的内容达到4K才会刷新,所以为了保证内容的数据,可以添加以下代码,保证内容长度</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">  echo str_repeat(&quot; &quot;,4096);</div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure>\n</blockquote>\n</li>\n<li><p>在apache中,如果你开启了mod_gzip的压缩模块,这样可能会导致你的flush函数刷新不成功</p>\n<blockquote>\n<p>其原因是,mod_gzip有自己的输出缓冲区,当php执行了flush函数,指示apache刷新输出缓冲区,但是内容需要压缩,apache就把内容输出到自身的mod_gzip模块,mod_gzip也有自身的输出 缓冲区,他也不会马上输出,所以造成了内容不能马上输出.为了改善这个情况,可以关闭mod_gzip模块,或者在httpd.conf增加以下内容,以禁止压缩</p>\n</blockquote>\n</li>\n</ul>\n<p>转自：<a href=\"http://www.keepmyway.com/index.php/124.html\" target=\"_blank\" rel=\"external\">http://www.keepmyway.com/index.php/124.html</a></p>\n","excerpt":"<h2 id=\"什么是缓冲区\"><a href=\"#什么是缓冲区\" class=\"headerlink\" title=\"什么是缓冲区?\"></a>什么是缓冲区?</h2><p>简单而言,缓冲区的作用就是,把输入或者输出的内容先放进内存,而不显示或者读取.</p>\n<p>其实缓冲区最本质的作用就是,协调高速CPU和相对缓慢的IO设备(磁盘等)的运作.</p>\n<h2 id=\"PHP在执行的时候-在什么地方有用到缓冲区\"><a href=\"#PHP在执行的时候-在什么地方有用到缓冲区\" class=\"headerlink\" title=\"PHP在执行的时候,在什么地方有用到缓冲区?\"></a>PHP在执行的时候,在什么地方有用到缓冲区?</h2><p>想要了解PHP的缓冲区,就要知道执行PHP的时候,缓冲区被设置到了什么地方.</p>\n<p>当执行PHP的时候,如果碰到了echo print_r之类的会输出数据的代码,PHP就会将要输出的数据放到PHP自身的缓冲区,等待输出.</p>\n<p>当PHP自身的缓冲区接到指令,指示要输出缓冲区的内容时,将会把缓冲区内的数据输出到apache上, apache接受到PHP输出的数据,然后再把该数据存在到apache自身的缓冲区内,等到输出。</p>\n<p>当apache接受到指令,只是要输出缓冲区的内容时, 将会把缓冲区的内容输出,返回到浏览器.</p>\n<p>由此可见,PHP要输出数据的时候,将会经过两个缓冲区(先是自身的,然后是apache的),再返回到浏览器.</p>","more":"<h2 id=\"缓冲区在PHP中起到什么作用\"><a href=\"#缓冲区在PHP中起到什么作用\" class=\"headerlink\" title=\"缓冲区在PHP中起到什么作用?\"></a>缓冲区在PHP中起到什么作用?</h2><h3 id=\"最常见的就是在使用header函数之前\"><a href=\"#最常见的就是在使用header函数之前\" class=\"headerlink\" title=\"最常见的就是在使用header函数之前\"></a>最常见的就是在使用header函数之前</h3><p>header();函数要求在其之前不能有输出。如在header之前有输出时会报错： Cannot modify header information – headers already sent by;</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;this is test&quot;;</div><div class=\"line\">header(&quot;LOCATION http://www.baidu.com&quot;);</div></pre></td></tr></table></figure>\n<p>出现这个错误的原因是, 在header之前已经输出了某些数据,而输出这些数据的同时, apache将会同时发送一个响应状态到浏览器上(既然有输出,即这个请求是有效的),而其后你又再次使用header函数发送http头,则会返回这个错误,错误的意思是:HTTP头已经发送出去了,你不能对他再做修改.</p>\n<p>为什么使用缓冲区可以避免这个错误呢?</p>\n<p>因为header函数是不受缓冲区影响的,当一碰到header函数的时候,PHP马上执行apache发送这一个http头都浏览器.<br>而输出的数据PHP打开输出缓冲区后, 这些数据将会存放在缓冲区,等待输出.这样就可以避免了之前所发生的错误.</p>\n<h3 id=\"通过PHP写文件下载程序的时候\"><a href=\"#通过PHP写文件下载程序的时候\" class=\"headerlink\" title=\"通过PHP写文件下载程序的时候.\"></a>通过PHP写文件下载程序的时候.</h3><p>为了让文件下载更安全,同时提高更多的可控性,很多朋友都喜欢用PHP写文件下载页面.</p>\n<p>其原理很简单,就是通过fwrite把文件内容读出并显示,然后通过header来发送HTTP头,让浏览器知道这是一个附件,这样就可以达到提供下载的效果.</p>\n<p>如果用上面的办法提供下载页面,会碰到一个效率问题,如果一个文件很大,假设为100M,那么在不开启缓冲区输出的情况下,必须要把100M数据全部读出,然后一次返回到页面上,如果这样做,用户将会在所有数据读完之后才会得到响应,降低了用户体验感.</p>\n<p>如果开启了输出缓冲区,当PHP程序读完文件的某一段,然后马上输出到apache,然后让apache马上返回到浏览器,这样就可以减少用户等待时间.</p>\n<p>那后面的数据怎么办呢?</p>\n<p>我们可以写一个while循环,一直一段一段地读取文件，每读一段,就马上输出,直到把文件全部输出为止,这样浏览器就可以持续地接受到数据,而不必等到所有文件读取完毕.</p>\n<p>另外,该做法还解决了另外一个很严重的问题.</p>\n<p>例如一个文件是100M,如果不开启缓冲区的情况下,则需要把100M文件全部读入内存,然后再输出.</p>\n<p>但是,如果PHP程序做了内存限制呢?<br>为了保证服务器的稳定,管理员通常会把PHP的执行内存设一个限制(通过php.ini总的memory_limit, 其默认值是8M), 也就是每个PHP程序使用的内存不能使用超过这个值的内存.</p>\n<p>假设该值为8M,而要读入的文件是100M,根本就没有足够的内存来读入该文件.这个时候,我们就需要用到上面的办法来解决这个问题,每次只读某一段,这样就可以避免了内存的限制</p>\n<h3 id=\"静态文件缓存\"><a href=\"#静态文件缓存\" class=\"headerlink\" title=\"静态文件缓存\"></a>静态文件缓存</h3><p>现在很多公司有这么一个需求, 就是某一个页面在第一次访问的时候,会执行PHP,然后把显示的内容返回到浏览器,同时需要把这次显示的内容保存到服务器上,这样下次访问的时候,就直接把保存在服务器上的文件直接显示,而不需要通过PHP来做操作这就是所谓的”静态页面缓存”.</p>\n<p>那怎么样才能做到把内容返回到浏览器的同时把数据保存到服务器上呢?</p>\n<p>这就要用到输出缓冲区了.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">ob_start();</div><div class=\"line\">echo &apos;aaa&apos;;</div><div class=\"line\">$string = ob_get_contents();</div><div class=\"line\">file_put_contents(&apos;a.html&apos;, $string);</div><div class=\"line\">ob_flush();</div><div class=\"line\">flush();</div></pre></td></tr></table></figure>\n<h2 id=\"与输出缓冲区有关的配置\"><a href=\"#与输出缓冲区有关的配置\" class=\"headerlink\" title=\"与输出缓冲区有关的配置\"></a>与输出缓冲区有关的配置</h2><p>在PHP.INI中,有两个跟缓冲区紧密相关的配置项</p>\n<h3 id=\"output-buffering\"><a href=\"#output-buffering\" class=\"headerlink\" title=\"output_buffering\"></a>output_buffering</h3><p>该配置直接影响的是php本身的缓冲区,有3种配置参数.on/off/xK(x为某个整型数值);<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">on    - 开启缓冲区</div><div class=\"line\">off    - 关闭缓冲区</div><div class=\"line\">256k    - 开启缓冲区,而且当缓冲区的内容超过256k的时候,自动刷新缓冲区(把数据发送到apache);</div></pre></td></tr></table></figure></p>\n<h3 id=\"implicit-flush\"><a href=\"#implicit-flush\" class=\"headerlink\" title=\"implicit_flush\"></a>implicit_flush</h3><p>该配置直接影响apache的缓冲区,有2种配置参数. on/off<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">on    - 自动刷新apache缓冲区,也就是,当php发送数据到apache的缓冲区的时候,不需要等待其他指令,直接就把输出返回到浏览器</div><div class=\"line\">off    - 不自动刷新apache缓冲区,接受到数据后,等待刷新指令</div></pre></td></tr></table></figure></p>\n<h2 id=\"与缓冲区有关的函数\"><a href=\"#与缓冲区有关的函数\" class=\"headerlink\" title=\"与缓冲区有关的函数\"></a>与缓冲区有关的函数</h2><ul>\n<li><p>ob_implicit_flush</p>\n<blockquote>\n<p>作用和implicit_flush一样,是否自动刷新apache的缓冲区</p>\n</blockquote>\n</li>\n<li><p>flush</p>\n<blockquote>\n<p>作用是发送指令到apache,让apache刷新自身的输出缓冲区.</p>\n</blockquote>\n</li>\n<li><p>ob_start</p>\n<blockquote>\n<p>打开输出缓冲区,无论php.ini的文件如何配置,如果使用该函数,即使output_buffering设置成off,也会打开输出缓冲区</p>\n<p>ob_start函数还接受一个参数,该参数是一个函数的回调,意思是,在输入缓冲区内容之前,需要使用调用传递进来的参数把缓冲区的内容处理一次,再放入缓冲区内</p>\n</blockquote>\n</li>\n<li><p>ob_flush</p>\n<blockquote>\n<p>指示php本身刷新自身的缓冲区,把数据发送到apache</p>\n</blockquote>\n</li>\n<li><p>ob_clean</p>\n<blockquote>\n<p>清除php缓冲区里面的内容</p>\n</blockquote>\n</li>\n<li><p>ob_end_clean</p>\n<blockquote>\n<p>清除php缓冲区内的内容,并且关闭输出缓冲区</p>\n</blockquote>\n</li>\n<li><p>ob_end_flush</p>\n<blockquote>\n<p>把php自身的缓冲区里的内容发送到apache,并把清除自身缓冲区内的内容</p>\n</blockquote>\n</li>\n<li><p>ob_get_clean</p>\n<blockquote>\n<p>获取缓冲区的内容之后,清除缓冲区.</p>\n</blockquote>\n</li>\n<li><p>ob_get_contents</p>\n<blockquote>\n<p>获取输出缓冲区里的内容</p>\n</blockquote>\n</li>\n<li><p>ob_get_flush</p>\n<blockquote>\n<p>获取缓冲区里的内容,并且把这些内容发送到apache</p>\n</blockquote>\n</li>\n<li><p>ob_get_length</p>\n<blockquote>\n<p>获取缓冲区里内容的长度</p>\n</blockquote>\n</li>\n<li><p>ob_list_handlers</p>\n<blockquote>\n<p>获取运行ob_start时,所回调的函数名称, 例如:</p>\n</blockquote>\n</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ob_start(‘ob_gzhandler’);</div><div class=\"line\">print_r(ob_list_handlers);</div></pre></td></tr></table></figure>\n<p>将打印出ob_gzhandler;</p>\n<ul>\n<li>ob_gzhandler<blockquote>\n<p>该函数的作用是作为ob_start的回调参数, 在缓冲区刷新之前,会调用该函数对数据进行到底gzip或者deflate压缩.这个函数需要zlib扩展的支持.</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"使用缓冲区的相关内容\"><a href=\"#使用缓冲区的相关内容\" class=\"headerlink\" title=\"使用缓冲区的相关内容\"></a>使用缓冲区的相关内容</h2><ul>\n<li><p>ob_flush和flush的次序关系.</p>\n<blockquote>\n<p>上面的分析可以看出,ob_flush是和php自身相关的,而flush操作的是apache的缓冲区,所有我们在使用这两个函数的时候,需要先执行ob_flush,<br>再执行flush,因为我们需要先把数据从PHP上发送到apache,然后再由apache返回到浏览器.如果php还没有把数据刷新到apache,就调用了flush,则apache无任何数据返回到浏览器.</p>\n</blockquote>\n</li>\n<li><p>有的浏览器,如果接受到的字符太少,则不会把数据显示出来</p>\n<blockquote>\n<p>例如老版的IE(必须要大于256k才显示).这样就会造成一个疑问, 明明在php和apache都进行了刷新缓冲区的操作,但是浏览器就是没有出现自己想要的数据,也许就是这个原因造成的.所以才测试的时候,可以在输出数据的后面加上多个空格,以填满数据,确定不会浏览器造成这类诡异的问题.</p>\n</blockquote>\n</li>\n<li><p>有些webserver,他自身的输出缓冲区会有一些限制</p>\n<blockquote>\n<p>比如nginx,他有一个配置fastcgi_buffer_size 4k, 就是是表明,当自身的输出缓冲区的内容达到4K才会刷新,所以为了保证内容的数据,可以添加以下代码,保证内容长度</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;?php</div><div class=\"line\">  echo str_repeat(&quot; &quot;,4096);</div><div class=\"line\">?&gt;</div></pre></td></tr></table></figure>\n</blockquote>\n</li>\n<li><p>在apache中,如果你开启了mod_gzip的压缩模块,这样可能会导致你的flush函数刷新不成功</p>\n<blockquote>\n<p>其原因是,mod_gzip有自己的输出缓冲区,当php执行了flush函数,指示apache刷新输出缓冲区,但是内容需要压缩,apache就把内容输出到自身的mod_gzip模块,mod_gzip也有自身的输出 缓冲区,他也不会马上输出,所以造成了内容不能马上输出.为了改善这个情况,可以关闭mod_gzip模块,或者在httpd.conf增加以下内容,以禁止压缩</p>\n</blockquote>\n</li>\n</ul>\n<p>转自：<a href=\"http://www.keepmyway.com/index.php/124.html\">http://www.keepmyway.com/index.php/124.html</a></p>"},{"title":"Redis安装与管理","date":"2016-09-27T12:30:00.000Z","_content":"\n\nredis是一个key-value存储系统。\n和Memcached类似，它支持存储的value类型相对更多，\n包括string(字符串)、list(链表)、set(集合)和zset(有序集合)。\n这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。\n\n在此基础上，redis支持各种不同方式的排序。与memcached一样，为了保证效率，数据都是缓存在内存中。\n区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。\n\nRedis 是一个高性能的key-value数据库。\n redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部 分场合可以对关系数据库起到很好的补充作用。\n它提供了Python，Ruby，Erlang，PHP客户端，使用很方便。\n\n- Memcache\n> 内存缓存服务，缓存数据保存在内存中，一旦断电重启，数据将丢失\n\n- mangoDB\n> 开源免费的NOSQL 数据库，提供数据持久化服务，以文档的形式提供数据组织方式，而不是表\n\n- Redis\n> 开源免费的 NOSQL数据库，提供数据持久化服务，即能实现内存缓存服务，也能提供数据结构服务取代MySQL 自建索引用来弥补关系型数据的不足\n\n<!-- more -->\n\n## 安装\n### 默认安装位置\n```\n[root@localhost ~]# wget http://download.redis.io/releases/redis-2.8.6.tar.gz\n[root@localhost ~]# tar xzf redis-2.8.6.tar.gz\n[root@localhost ~]# cd redis-2.8.6\n[root@localhost ~]# make\n#不指定安装位置，则会把redis的可执行文件安装到  redis-2.8.6/src/目录下\n```\n\n### 指定安装位置\n```\n[root@localhost ~]# tar xzf redis-2.8.6.tar.gz\n[root@localhost ~]# cd redis-2.8.6\n[root@localhost ~]# make\n[root@localhost ~]# make PREFIX=/usr/local/redis install\n#指定安装位置，如果没有指定安装位置PREFIX=/usr/local/redis，则make install会把redis安装到/usr/local/bin/目录下\n[root@localhost ~]# mkdir /usr/local/redis/etc\n[root@localhost ~]# cp /root/redis-2.8.6/redis.conf /usr/local/redis/etc/\n```\n\n### 安装的可执行文件的作用\n```\nredis-server           \t服务器端\nredis-cli              \t客户端\nredis-benchmark       \t调试\nredis-check-dump      \t数据导出\nredis-check-aof        \t数据导入\n```\n\n## 启动与关闭\n###\t启动\n路径\n```\n/redis-server\n```\n配置文件\n```\n/usr/local/redis/bin/redis-server  /usr/local/redis/etc/redis.conf\n```\n\n注意：需要修改配置文件\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\ndaemonize no\t\t改为\ndaemonize yes    \t#后台启动\n```\n端口 6379\n```\n[root@localhost redis]# /usr/local/redis/bin/redis-cli\n#客户端连接\n\t-h  IP\t：\t\t连接指定的redis服务器\n\t-p  6379：\t\t指定redis服务器的端口\n\t-a  密码：\t\t使用密码登录\n\t-n 数据库号：\t指定连接哪个数据库\n```\n\n###\t关闭redis\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-cli shutdown\n```\n或\n```\n[root@localhost ~]# pkill  -9 redis\n```\n## 配置文件\n\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\n#是否以后台进程运行，默认为no，如果需要以后台进程运行则改为yes\ndaemonize no\n\n\n#如果以后台进程运行的话，就需要指定pid，你可以在此自定义redis.pid文件的位置。\npidfile /var/run/redis.pid\n\n\n#接受连接的端口号，如果端口是0则redis将不会监听TCP socket连接\nport 6379\n\n# If you want you can bind a single interface, if the bind option is not\n# specified all the interfaces will listen for incoming connections.\n#\n# bind 127.0.0.1\n\n# Specify the path for the unix socket that will be used to listen for\n# incoming connections. There is no default, so Redis will not listen\n# on a unix socket when not specified.\n#\n# unixsocket /tmp/redis.sock\n# unixsocketperm 755\n\n\n#连接超时时间，单位秒。(0 to disable)？\ntimeout 300000000\n\n\n#日志级别，默认是verbose（详细），各种日志级别：\n#debug:很详细的信息，适合开发和测试\n#verbose:包含许多不太有用的信息，但比debug要清爽一些（many rarely useful info, but not a mess like #the debug level）\n#notice:比较适合生产环境\n#warning:警告信息\nloglevel verbose\n\n\n#指定log文件的名字，默认是空。stdout会让redis把日志输出到标准输出。但是如果使用stdout而又以后台进#程的方式运行redis，则日志会输出到/dev/null。请改为需要的日志名\nlogfile  \"\"\n\n\n#'syslog-enabled'设置为yes会把日志输出到系统日志，默认是no\n# syslog-enabled no\n\n\n#指定syslog的标示符，如果'syslog-enabled'是no，则这个选项无效。\n# syslog-ident redis\n\n\n#指定syslog 设备（facility), 必须是USER或者LOCAL0到LOCAL7.\n# syslog-facility local0\n\n\n#设置数据库数目。默认的数据库是DB 0。可以通过SELECT <dbid>来选择一个数据库，dbid是[0,'databases'-1]的数字\ndatabases 16\n\n################## 快照#################################\n#\n# 硬盘上保存数据:\n#\n#   save <seconds> <changes>\n#\n#   <seconds>和<changes>都满足时就会触发数据保存动作。\n#   \n#\n#   以下面的例子来说明：\n#   过了900秒并且有1个key发生了改变 就会触发save动作\n#   过了300秒并且有10个key发生了改变 就会触发save动作\n#   过了60秒并且至少有10000个key发生了改变 也会触发save动作\n#\n#   注意：如果你不想让redis自动保存数据，那就把下面的配置注释掉！\n\nsave 900 1\nsave 300 10\nsave 60 10000\n\n\n#存储数据时是否压缩数据。默认是yes。\nrdbcompression yes\n\n# 保存dump数据的文件名\ndbfilename dump.rdb\n\n# 工作目录.\n#\n# 数据会被持久化到这个目录下的‘dbfilename’指定的文件中。\n#\n#\n# 注意，这里指定的必须是目录而不能是文件。\ndir ./\n\n######## REPLICATION（复制，冗余）#################################\n\n# Master-Slave replication. 使用slaveof把一个 Redis 实例设置成为另一个Redis server的从库（热备）. 注意： #配置只对当前slave有效。\n# 因此可以把某个slave配置成使用不同的时间间隔来保存数据或者监听其他端口等等。\n#命令格式：\n# slaveof <masterip> <masterport>\n\n\n#如果master有密码保护，则在slave与master进行数据同步之前需要进行密码校验，否则master会拒绝slave的请#求。\n#\n# masterauth <master-password>\n\n#当slave丢失与master的连接时，或者slave仍然在于master进行数据同步时（还没有与master保持一致），#slave可以有两种方式来响应客户端请求：\n#\n# 1) 如果 slave-serve-stale-data 设置成 'yes' (the default) slave会仍然响应客户端请求,此时可能会有问题。\n#\n# 2) 如果 slave-serve-stale data设置成  'no'  slave会返回\"SYNC with master in progress\"这样的错误信息。 但 INFO 和SLAVEOF命令除外。\n#\nslave-serve-stale-data yes\n\n############### 安全 ###################################\n\n# 需要客户端在执行任何命令之前指定 AUTH <PASSWORD>\n#\n# requirepass foobared\n\n# 命令重命名.\n#\n#\n# 例如:\n#\n# rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52\n#\n# 同样可以通过把一个命令重命名为空串来彻底kill掉这个命令，比如：\n#\n# rename-command CONFIG \"\"\n\n#################### 限制 ####################################\n\n# 设置最大连接数. 默认没有限制,  '0' 意味着不限制.\n#\n# maxclients 128\n\n\n#最大可使用内存。如果超过，Redis会试图删除EXPIRE集合中的keys，具体做法是：Redis会试图释放即将过期的#keys，而保护还有很长生命周期的keys。\n#\n#如果这样还不行，Redis就会报错，但像GET之类的查询请求还是会得到响应。\n#\n#警告：如果你想把Redis视为一个真正的DB的话，那不要设置<maxmemory>,只有你只想把Redis作为cache或者\n#有状态的server（'state' server)时才需要设置。\n#\n# maxmemory <bytes>\n\n#内存清理策略：如果达到了maxmemory，你可以采取如下动作：\n#\n# volatile-lru -> 使用LRU算法来删除过期的set\n# allkeys-lru -> 删除任何遵循LRU算法的key\n# volatile-random ->随机地删除过期set中的key\n# allkeys->random -> 随机地删除一个key\n# volatile-ttl -> 删除最近即将过期的key（the nearest expire time (minor TTL)）\n# noeviction -> 根本不过期，写操作直接报错\n#\n#\n# 默认策略:\n#\n# maxmemory-policy volatile-lru\n\n# 对于处理redis内存来说，LRU和minor TTL算法不是精确的，而是近似的（估计的）算法。所以我们会检查某些样本#来达到内存检查的目的。默认的样本数是3，你可以修改它。\n#\n# maxmemory-samples 3\n\n################# APPEND ONLY MODE ###############################\n\n#默认情况下，Redis会异步的把数据保存到硬盘。如果你的应用场景允许因为系统崩溃等极端情况而导致最新数据丢失#的话，那这种做法已经很ok了。否则你应该打开‘append only’模式，开启这种模式后，Redis会在#appendonly.aof文件中添加每一个写操作，这个文件会在Redis启动时被读取来在内存中重新构建数据集。\n#\n#注意：如果你需要，你可以同时开启‘append only’模式和异步dumps模式（你需要注释掉上面的‘save’表达式来禁#止dumps），这种情况下，Redis重建数据集时会优先使用appendonly.aof而忽略dump.rdb\n#\nappendonly no\n\n#  append only 文件名 (默认: \"appendonly.aof\")\n# appendfilename appendonly.aof\n\n# 调用fsync()函数通知操作系统立刻向硬盘写数据\n#\n# Redis支持3中模式:\n#\n# no:不fsync, 只是通知OS可以flush数据了，具体是否flush取决于OS.性能更好.\n# always: 每次写入append only 日志文件后都会fsync . 性能差，但很安全.\n# everysec: 没间隔1秒进行一次fsync. 折中.\n#\n# 默认是 \"everysec\"\n# appendfsync always\nappendfsync everysec\n# appendfsync no\n\n# 当AOF fsync策略被设置为always或者everysec并且后台保存进程（saving process)正在执行大量I/O操作时\n# Redis可能会在fsync()调用上阻塞过长时间\n#\nno-appendfsync-on-rewrite no\n\n# append only 文件的自动重写\n# 当AOF 日志文件即将增长到指定百分比时，Redis可以通过调用BGREWRITEAOF 来自动重写append only文件。\n#\n# 它是这么干的：Redis会记住最近一次重写后的AOF 文件size。然后它会把这个size与当前size进行比较，如果当前# size比指定的百分比大，就会触发重写。同样，你需要指定AOF文件被重写的最小size，这对避免虽然百分比达到了# 但是实际上文件size还是很小（这种情况没有必要重写）却导致AOF文件重写的情况很有用。\n#\n#\n# auto-aof-rewrite-percentage 设置为 0 可以关闭AOF重写功能\n\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\n\n################## SLOW LOG ###################################\n\n# Redis slow log用来记录超过指定执行时间的查询。\n#\n# 你可以指定两个参数：一个是慢查询的阀值，单位是毫秒；另外一个是slow log的长度，相当于一个队列。\n\n# 负数则关闭slow log，0则会导致每个命令都被记录\nslowlog-log-slower-than 10000\n\n# 不设置会消耗过多内存，所以还是要设置一下。可以使用SLOWLOG RESET命令来回收slow log使用的内存\nslowlog-max-len 1024\n\n################ 虚拟内存 ###############################\n#使用redis 就别用虚拟内存了，绝对不是一个好主意，加个机器吧，所以这里不翻译啦！！\n\n### WARNING! Virtual Memory is deprecated in Redis 2.4\n### The use of Virtual Memory is strongly discouraged.\n\n# Virtual Memory allows Redis to work with datasets bigger than the actual\n# amount of RAM needed to hold the whole dataset in memory.\n# In order to do so very used keys are taken in memory while the other keys\n# are swapped into a swap file, similarly to what operating systems do\n# with memory pages.\n#\n# To enable VM just set 'vm-enabled' to yes, and set the following three\n# VM parameters accordingly to your needs.\n\nvm-enabled no\n# vm-enabled yes\n\n# This is the path of the Redis swap file. As you can guess, swap files\n# can't be shared by different Redis instances, so make sure to use a swap\n# file for every redis process you are running. Redis will complain if the\n# swap file is already in use.\n#\n# The best kind of storage for the Redis swap file (that's accessed at random)\n# is a Solid State Disk (SSD).\n#\n# *** WARNING *** if you are using a shared hosting the default of putting\n# the swap file under /tmp is not secure. Create a dir with access granted\n# only to Redis user and configure Redis to create the swap file there.\nvm-swap-file /tmp/redis.swap\n\n# vm-max-memory configures the VM to use at max the specified amount of\n# RAM. Everything that deos not fit will be swapped on disk *if* possible, that\n# is, if there is still enough contiguous space in the swap file.\n#\n# With vm-max-memory 0 the system will swap everything it can. Not a good\n# default, just specify the max amount of RAM you can in bytes, but it's\n# better to leave some margin. For instance specify an amount of RAM\n# that's more or less between 60 and 80% of your free RAM.\nvm-max-memory 0\n\n# Redis swap files is split into pages. An object can be saved using multiple\n# contiguous pages, but pages can't be shared between different objects.\n# So if your page is too big, small objects swapped out on disk will waste\n# a lot of space. If you page is too small, there is less space in the swap\n# file (assuming you configured the same number of total swap file pages).\n#\n# If you use a lot of small objects, use a page size of 64 or 32 bytes.\n# If you use a lot of big objects, use a bigger page size.\n# If unsure, use the default :)\nvm-page-size 32\n\n# Number of total memory pages in the swap file.\n# Given that the page table (a bitmap of free/used pages) is taken in memory,\n# every 8 pages on disk will consume 1 byte of RAM.\n#\n# The total swap size is vm-page-size * vm-pages\n#\n# With the default of 32-bytes memory pages and 134217728 pages Redis will\n# use a 4 GB swap file, that will use 16 MB of RAM for the page table.\n#\n# It's better to use the smallest acceptable value for your application,\n# but the default is large in order to work in most conditions.\nvm-pages 134217728\n\n# Max number of VM I/O threads running at the same time.\n# This threads are used to read/write data from/to swap file, since they\n# also encode and decode objects from disk to memory or the reverse, a bigger\n# number of threads can help with big objects even if they can't help with\n# I/O itself as the physical device may not be able to couple with many\n# reads/writes operations at the same time.\n#\n# The special value of 0 turn off threaded I/O and enables the blocking\n# Virtual Memory implementation.\nvm-max-threads 4\n\n################高级配置###############################\n\n# Hashes are encoded in a special way (much more memory efficient) when they\n# have at max a given numer of elements, and the biggest element does not\n# exceed a given threshold. You can configure this limits with the following\n# configuration directives.\nhash-max-zipmap-entries 512\nhash-max-zipmap-value 64\n\n# Similarly to hashes, small lists are also encoded in a special way in order\n# to save a lot of space. The special representation is only used when\n# you are under the following limits:\nlist-max-ziplist-entries 512\nlist-max-ziplist-value 64\n\n# Sets have a special encoding in just one case: when a set is composed\n# of just strings that happens to be integers in radix 10 in the range\n# of 64 bit signed integers.\n# The following configuration setting sets the limit in the size of the\n# set in order to use this special memory saving encoding.\nset-max-intset-entries 512\n\n# Similarly to hashes and lists, sorted sets are also specially encoded in\n# order to save a lot of space. This encoding is only used when the length and\n# elements of a sorted set are below the following limits:\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\n\n# Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in\n# order to help rehashing the main Redis hash table (the one mapping top-level\n# keys to values). The hash table implementation redis uses (see dict.c)\n# performs a lazy rehashing: the more operation you run into an hash table\n# that is rhashing, the more rehashing \"steps\" are performed, so if the\n# server is idle the rehashing is never complete and some more memory is used\n# by the hash table.\n#\n# The default is to use this millisecond 10 times every second in order to\n# active rehashing the main dictionaries, freeing memory when possible.\n#\n# If unsure:\n# use \"activerehashing no\" if you have hard latency requirements and it is\n# not a good thing in your environment that Redis can reply form time to time\n# to queries with 2 milliseconds delay.\n#\n# use \"activerehashing yes\" if you don't have such hard requirements but\n# want to free memory asap when possible.\nactiverehashing yes\n\n################## INCLUDES ###################################\n\n# Include one or more other config files here.  This is useful if you\n# have a standard template that goes to all redis server but also need\n# to customize a few per-server settings.  Include files can include\n# other files, so use this wisely.\n#\n# include /path/to/local.conf\n# include /path/to/other.conf\n```\n\n\n##\tRedis常用命令\n### 键值相关命令\n1、 keys  键名\n> 按照键名查找指定的键。支持通配符\n\n```\n127.0.0.1:6379> set hello 1\nOK\n127.0.0.1:6379> set hallo 1\nOK\n127.0.0.1:6379> set heeeello 1\nOK\n127.0.0.1:6379> keys h?llo\n1) \"hallo\"\n2) \"hello\"\n127.0.0.1:6379> keys h*llo\n1) \"hallo\"\n2) \"heeeello\"\n3) \"hello\"\n```\n\n2、\texists  键名\n>\t确认一个键是否存在\n\n```\n127.0.0.1:6379> EXISTS name\n(integer) 1\t\t\t\t\t\t//name键存在\n127.0.0.1:6379> EXISTS age\n(integer) 0\t\t\t\t\t\t//age键不存在\n```\n\n3、\tdel  键名\n>\t删除一个键\n\n```\n127.0.0.1:6379> del hello\n(integer) 1\n127.0.0.1:6379> EXISTS hello\n(integer) 0\n```\n\n4、\texpire  键  秒\n>\t设置一个键的过期时间，如果键已经过期，将会被自动删除\n\n```\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> EXPIRE age 20\n(integer) 1\n127.0.0.1:6379> ttl age\n(integer) 18\n127.0.0.1:6379> ttl age\n(integer) -2\n127.0.0.1:6379> EXISTS age\n(integer) 0\n```\n\n5、\tttl  键\n>\t以秒为单位，返回键的剩余生存时间。\n>\n>\t当键不存在时，返回值为-2\n>\n>\t当键存在，但没有设置剩余生存时间时，返回-1\n\n\n```\n127.0.0.1:6379> ttl name\n(integer) -1\n```\n\n6、\tselect  数据库号\n>\t选择一个数据库。\n>\t默认连接的数据库是0，可以支持共16个数据库。\n>\t在配置文件中，通过databases 16 关键字定义\n\n```\n127.0.0.1:6379> select 1\nOK\n127.0.0.1:6379[1]>\n```\n\n7、\tmove  键  数据库号\n>\t将当前数据库的键移动到指定的数据空中\n\n```\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> move age 1\n(integer) 1\n127.0.0.1:6379> get age\n(nil)\n127.0.0.1:6379> select 1\nOK\n127.0.0.1:6379[1]> get age\n\"18\"\n```\n\n8、\trandomkey  \n>\t从当前数据库返回一个随机的键。如果当前库没有任何键，则返回nil\n\n9、\trename  旧名  新名\n>\t重命名键\n\n```\n127.0.0.1:6379> rename name name_new\nOK\n127.0.0.1:6379> get name_new\n\"sc\"\n```\n\n10、 type  键\n> \t返回键类型。\n\n返回值\n- none (key不存在)\n- string (字符串)\n- list (列表)\n- set (集合)\n- zset (有序集)\n- hash (哈希表)\n\n### 服务器相关命令\n1、\tping\n>\t测试服务器是否可以连接\n\n```\n127.0.0.1:6379> ping\nPONG\t\t\t\t\t//连接正常\n127.0.0.1:6379> ping\nCould not connect to Redis at 127.0.0.1:6379: Connection refused\n//redis被停止，连接拒绝\n```\n\n2、\techo  字符串\n>\t在命令行输出字符串\n\n```\n127.0.0.1:6379> echo \"test message\"\n\"test message\"\n```\n\n3、\tquit\n>\t退出redis数据库\n\n4、\tsave\n>\t保存所有的数据。很少在生产环境直接使用SAVE 命令，因为它会阻塞所有的客户端的请求，可以使用BGSAVE 命令代替. 如果在BGSAVE命令的保存数据的子进程发生错误的时,用 SAVE命令保存最新的数据是最后的手段\n\n5、\tdbsize\n>\t返回当前库中键的数量\n\n```\n127.0.0.1:6379> dbsize\n(integer) 6\n```\n\n6、\tinfo\n>\t获取服务器的详细信息\n\n7、\tconfig get 参数\n>\t获取redis服务器配置文件中的参数。支持通配符\n\n```\n127.0.0.1:6379> config get *\t\t\t//查询配置文件中所有的参数\n  1) \"dbfilename\"\n  2) \"dump.rdb\"\n 45) \"port\"\n 46) \"6379\"\n 99) \"save\"\n 100) \"900 1 300 10 60 10000\"\n```\n\n8、 flushdb\n>\t删除当前数据库中所有的数据\n\n```\n127.0.0.1:6379> dbsize\n(integer) 6\n127.0.0.1:6379> flushdb\nOK\n127.0.0.1:6379> dbsize\n(integer) 0\n```\n\n9、\tflushall\n> \t删除所有数据库中所有的数据\n","source":"_posts/Redis安装与管理.md","raw":"---\ntitle: Redis安装与管理\ndate: 2016-09-27 20:30:00\ntags:\n- Redis\ncategories:\n- Linux\n---\n\n\nredis是一个key-value存储系统。\n和Memcached类似，它支持存储的value类型相对更多，\n包括string(字符串)、list(链表)、set(集合)和zset(有序集合)。\n这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。\n\n在此基础上，redis支持各种不同方式的排序。与memcached一样，为了保证效率，数据都是缓存在内存中。\n区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。\n\nRedis 是一个高性能的key-value数据库。\n redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部 分场合可以对关系数据库起到很好的补充作用。\n它提供了Python，Ruby，Erlang，PHP客户端，使用很方便。\n\n- Memcache\n> 内存缓存服务，缓存数据保存在内存中，一旦断电重启，数据将丢失\n\n- mangoDB\n> 开源免费的NOSQL 数据库，提供数据持久化服务，以文档的形式提供数据组织方式，而不是表\n\n- Redis\n> 开源免费的 NOSQL数据库，提供数据持久化服务，即能实现内存缓存服务，也能提供数据结构服务取代MySQL 自建索引用来弥补关系型数据的不足\n\n<!-- more -->\n\n## 安装\n### 默认安装位置\n```\n[root@localhost ~]# wget http://download.redis.io/releases/redis-2.8.6.tar.gz\n[root@localhost ~]# tar xzf redis-2.8.6.tar.gz\n[root@localhost ~]# cd redis-2.8.6\n[root@localhost ~]# make\n#不指定安装位置，则会把redis的可执行文件安装到  redis-2.8.6/src/目录下\n```\n\n### 指定安装位置\n```\n[root@localhost ~]# tar xzf redis-2.8.6.tar.gz\n[root@localhost ~]# cd redis-2.8.6\n[root@localhost ~]# make\n[root@localhost ~]# make PREFIX=/usr/local/redis install\n#指定安装位置，如果没有指定安装位置PREFIX=/usr/local/redis，则make install会把redis安装到/usr/local/bin/目录下\n[root@localhost ~]# mkdir /usr/local/redis/etc\n[root@localhost ~]# cp /root/redis-2.8.6/redis.conf /usr/local/redis/etc/\n```\n\n### 安装的可执行文件的作用\n```\nredis-server           \t服务器端\nredis-cli              \t客户端\nredis-benchmark       \t调试\nredis-check-dump      \t数据导出\nredis-check-aof        \t数据导入\n```\n\n## 启动与关闭\n###\t启动\n路径\n```\n/redis-server\n```\n配置文件\n```\n/usr/local/redis/bin/redis-server  /usr/local/redis/etc/redis.conf\n```\n\n注意：需要修改配置文件\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\ndaemonize no\t\t改为\ndaemonize yes    \t#后台启动\n```\n端口 6379\n```\n[root@localhost redis]# /usr/local/redis/bin/redis-cli\n#客户端连接\n\t-h  IP\t：\t\t连接指定的redis服务器\n\t-p  6379：\t\t指定redis服务器的端口\n\t-a  密码：\t\t使用密码登录\n\t-n 数据库号：\t指定连接哪个数据库\n```\n\n###\t关闭redis\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-cli shutdown\n```\n或\n```\n[root@localhost ~]# pkill  -9 redis\n```\n## 配置文件\n\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\n#是否以后台进程运行，默认为no，如果需要以后台进程运行则改为yes\ndaemonize no\n\n\n#如果以后台进程运行的话，就需要指定pid，你可以在此自定义redis.pid文件的位置。\npidfile /var/run/redis.pid\n\n\n#接受连接的端口号，如果端口是0则redis将不会监听TCP socket连接\nport 6379\n\n# If you want you can bind a single interface, if the bind option is not\n# specified all the interfaces will listen for incoming connections.\n#\n# bind 127.0.0.1\n\n# Specify the path for the unix socket that will be used to listen for\n# incoming connections. There is no default, so Redis will not listen\n# on a unix socket when not specified.\n#\n# unixsocket /tmp/redis.sock\n# unixsocketperm 755\n\n\n#连接超时时间，单位秒。(0 to disable)？\ntimeout 300000000\n\n\n#日志级别，默认是verbose（详细），各种日志级别：\n#debug:很详细的信息，适合开发和测试\n#verbose:包含许多不太有用的信息，但比debug要清爽一些（many rarely useful info, but not a mess like #the debug level）\n#notice:比较适合生产环境\n#warning:警告信息\nloglevel verbose\n\n\n#指定log文件的名字，默认是空。stdout会让redis把日志输出到标准输出。但是如果使用stdout而又以后台进#程的方式运行redis，则日志会输出到/dev/null。请改为需要的日志名\nlogfile  \"\"\n\n\n#'syslog-enabled'设置为yes会把日志输出到系统日志，默认是no\n# syslog-enabled no\n\n\n#指定syslog的标示符，如果'syslog-enabled'是no，则这个选项无效。\n# syslog-ident redis\n\n\n#指定syslog 设备（facility), 必须是USER或者LOCAL0到LOCAL7.\n# syslog-facility local0\n\n\n#设置数据库数目。默认的数据库是DB 0。可以通过SELECT <dbid>来选择一个数据库，dbid是[0,'databases'-1]的数字\ndatabases 16\n\n################## 快照#################################\n#\n# 硬盘上保存数据:\n#\n#   save <seconds> <changes>\n#\n#   <seconds>和<changes>都满足时就会触发数据保存动作。\n#   \n#\n#   以下面的例子来说明：\n#   过了900秒并且有1个key发生了改变 就会触发save动作\n#   过了300秒并且有10个key发生了改变 就会触发save动作\n#   过了60秒并且至少有10000个key发生了改变 也会触发save动作\n#\n#   注意：如果你不想让redis自动保存数据，那就把下面的配置注释掉！\n\nsave 900 1\nsave 300 10\nsave 60 10000\n\n\n#存储数据时是否压缩数据。默认是yes。\nrdbcompression yes\n\n# 保存dump数据的文件名\ndbfilename dump.rdb\n\n# 工作目录.\n#\n# 数据会被持久化到这个目录下的‘dbfilename’指定的文件中。\n#\n#\n# 注意，这里指定的必须是目录而不能是文件。\ndir ./\n\n######## REPLICATION（复制，冗余）#################################\n\n# Master-Slave replication. 使用slaveof把一个 Redis 实例设置成为另一个Redis server的从库（热备）. 注意： #配置只对当前slave有效。\n# 因此可以把某个slave配置成使用不同的时间间隔来保存数据或者监听其他端口等等。\n#命令格式：\n# slaveof <masterip> <masterport>\n\n\n#如果master有密码保护，则在slave与master进行数据同步之前需要进行密码校验，否则master会拒绝slave的请#求。\n#\n# masterauth <master-password>\n\n#当slave丢失与master的连接时，或者slave仍然在于master进行数据同步时（还没有与master保持一致），#slave可以有两种方式来响应客户端请求：\n#\n# 1) 如果 slave-serve-stale-data 设置成 'yes' (the default) slave会仍然响应客户端请求,此时可能会有问题。\n#\n# 2) 如果 slave-serve-stale data设置成  'no'  slave会返回\"SYNC with master in progress\"这样的错误信息。 但 INFO 和SLAVEOF命令除外。\n#\nslave-serve-stale-data yes\n\n############### 安全 ###################################\n\n# 需要客户端在执行任何命令之前指定 AUTH <PASSWORD>\n#\n# requirepass foobared\n\n# 命令重命名.\n#\n#\n# 例如:\n#\n# rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52\n#\n# 同样可以通过把一个命令重命名为空串来彻底kill掉这个命令，比如：\n#\n# rename-command CONFIG \"\"\n\n#################### 限制 ####################################\n\n# 设置最大连接数. 默认没有限制,  '0' 意味着不限制.\n#\n# maxclients 128\n\n\n#最大可使用内存。如果超过，Redis会试图删除EXPIRE集合中的keys，具体做法是：Redis会试图释放即将过期的#keys，而保护还有很长生命周期的keys。\n#\n#如果这样还不行，Redis就会报错，但像GET之类的查询请求还是会得到响应。\n#\n#警告：如果你想把Redis视为一个真正的DB的话，那不要设置<maxmemory>,只有你只想把Redis作为cache或者\n#有状态的server（'state' server)时才需要设置。\n#\n# maxmemory <bytes>\n\n#内存清理策略：如果达到了maxmemory，你可以采取如下动作：\n#\n# volatile-lru -> 使用LRU算法来删除过期的set\n# allkeys-lru -> 删除任何遵循LRU算法的key\n# volatile-random ->随机地删除过期set中的key\n# allkeys->random -> 随机地删除一个key\n# volatile-ttl -> 删除最近即将过期的key（the nearest expire time (minor TTL)）\n# noeviction -> 根本不过期，写操作直接报错\n#\n#\n# 默认策略:\n#\n# maxmemory-policy volatile-lru\n\n# 对于处理redis内存来说，LRU和minor TTL算法不是精确的，而是近似的（估计的）算法。所以我们会检查某些样本#来达到内存检查的目的。默认的样本数是3，你可以修改它。\n#\n# maxmemory-samples 3\n\n################# APPEND ONLY MODE ###############################\n\n#默认情况下，Redis会异步的把数据保存到硬盘。如果你的应用场景允许因为系统崩溃等极端情况而导致最新数据丢失#的话，那这种做法已经很ok了。否则你应该打开‘append only’模式，开启这种模式后，Redis会在#appendonly.aof文件中添加每一个写操作，这个文件会在Redis启动时被读取来在内存中重新构建数据集。\n#\n#注意：如果你需要，你可以同时开启‘append only’模式和异步dumps模式（你需要注释掉上面的‘save’表达式来禁#止dumps），这种情况下，Redis重建数据集时会优先使用appendonly.aof而忽略dump.rdb\n#\nappendonly no\n\n#  append only 文件名 (默认: \"appendonly.aof\")\n# appendfilename appendonly.aof\n\n# 调用fsync()函数通知操作系统立刻向硬盘写数据\n#\n# Redis支持3中模式:\n#\n# no:不fsync, 只是通知OS可以flush数据了，具体是否flush取决于OS.性能更好.\n# always: 每次写入append only 日志文件后都会fsync . 性能差，但很安全.\n# everysec: 没间隔1秒进行一次fsync. 折中.\n#\n# 默认是 \"everysec\"\n# appendfsync always\nappendfsync everysec\n# appendfsync no\n\n# 当AOF fsync策略被设置为always或者everysec并且后台保存进程（saving process)正在执行大量I/O操作时\n# Redis可能会在fsync()调用上阻塞过长时间\n#\nno-appendfsync-on-rewrite no\n\n# append only 文件的自动重写\n# 当AOF 日志文件即将增长到指定百分比时，Redis可以通过调用BGREWRITEAOF 来自动重写append only文件。\n#\n# 它是这么干的：Redis会记住最近一次重写后的AOF 文件size。然后它会把这个size与当前size进行比较，如果当前# size比指定的百分比大，就会触发重写。同样，你需要指定AOF文件被重写的最小size，这对避免虽然百分比达到了# 但是实际上文件size还是很小（这种情况没有必要重写）却导致AOF文件重写的情况很有用。\n#\n#\n# auto-aof-rewrite-percentage 设置为 0 可以关闭AOF重写功能\n\nauto-aof-rewrite-percentage 100\nauto-aof-rewrite-min-size 64mb\n\n################## SLOW LOG ###################################\n\n# Redis slow log用来记录超过指定执行时间的查询。\n#\n# 你可以指定两个参数：一个是慢查询的阀值，单位是毫秒；另外一个是slow log的长度，相当于一个队列。\n\n# 负数则关闭slow log，0则会导致每个命令都被记录\nslowlog-log-slower-than 10000\n\n# 不设置会消耗过多内存，所以还是要设置一下。可以使用SLOWLOG RESET命令来回收slow log使用的内存\nslowlog-max-len 1024\n\n################ 虚拟内存 ###############################\n#使用redis 就别用虚拟内存了，绝对不是一个好主意，加个机器吧，所以这里不翻译啦！！\n\n### WARNING! Virtual Memory is deprecated in Redis 2.4\n### The use of Virtual Memory is strongly discouraged.\n\n# Virtual Memory allows Redis to work with datasets bigger than the actual\n# amount of RAM needed to hold the whole dataset in memory.\n# In order to do so very used keys are taken in memory while the other keys\n# are swapped into a swap file, similarly to what operating systems do\n# with memory pages.\n#\n# To enable VM just set 'vm-enabled' to yes, and set the following three\n# VM parameters accordingly to your needs.\n\nvm-enabled no\n# vm-enabled yes\n\n# This is the path of the Redis swap file. As you can guess, swap files\n# can't be shared by different Redis instances, so make sure to use a swap\n# file for every redis process you are running. Redis will complain if the\n# swap file is already in use.\n#\n# The best kind of storage for the Redis swap file (that's accessed at random)\n# is a Solid State Disk (SSD).\n#\n# *** WARNING *** if you are using a shared hosting the default of putting\n# the swap file under /tmp is not secure. Create a dir with access granted\n# only to Redis user and configure Redis to create the swap file there.\nvm-swap-file /tmp/redis.swap\n\n# vm-max-memory configures the VM to use at max the specified amount of\n# RAM. Everything that deos not fit will be swapped on disk *if* possible, that\n# is, if there is still enough contiguous space in the swap file.\n#\n# With vm-max-memory 0 the system will swap everything it can. Not a good\n# default, just specify the max amount of RAM you can in bytes, but it's\n# better to leave some margin. For instance specify an amount of RAM\n# that's more or less between 60 and 80% of your free RAM.\nvm-max-memory 0\n\n# Redis swap files is split into pages. An object can be saved using multiple\n# contiguous pages, but pages can't be shared between different objects.\n# So if your page is too big, small objects swapped out on disk will waste\n# a lot of space. If you page is too small, there is less space in the swap\n# file (assuming you configured the same number of total swap file pages).\n#\n# If you use a lot of small objects, use a page size of 64 or 32 bytes.\n# If you use a lot of big objects, use a bigger page size.\n# If unsure, use the default :)\nvm-page-size 32\n\n# Number of total memory pages in the swap file.\n# Given that the page table (a bitmap of free/used pages) is taken in memory,\n# every 8 pages on disk will consume 1 byte of RAM.\n#\n# The total swap size is vm-page-size * vm-pages\n#\n# With the default of 32-bytes memory pages and 134217728 pages Redis will\n# use a 4 GB swap file, that will use 16 MB of RAM for the page table.\n#\n# It's better to use the smallest acceptable value for your application,\n# but the default is large in order to work in most conditions.\nvm-pages 134217728\n\n# Max number of VM I/O threads running at the same time.\n# This threads are used to read/write data from/to swap file, since they\n# also encode and decode objects from disk to memory or the reverse, a bigger\n# number of threads can help with big objects even if they can't help with\n# I/O itself as the physical device may not be able to couple with many\n# reads/writes operations at the same time.\n#\n# The special value of 0 turn off threaded I/O and enables the blocking\n# Virtual Memory implementation.\nvm-max-threads 4\n\n################高级配置###############################\n\n# Hashes are encoded in a special way (much more memory efficient) when they\n# have at max a given numer of elements, and the biggest element does not\n# exceed a given threshold. You can configure this limits with the following\n# configuration directives.\nhash-max-zipmap-entries 512\nhash-max-zipmap-value 64\n\n# Similarly to hashes, small lists are also encoded in a special way in order\n# to save a lot of space. The special representation is only used when\n# you are under the following limits:\nlist-max-ziplist-entries 512\nlist-max-ziplist-value 64\n\n# Sets have a special encoding in just one case: when a set is composed\n# of just strings that happens to be integers in radix 10 in the range\n# of 64 bit signed integers.\n# The following configuration setting sets the limit in the size of the\n# set in order to use this special memory saving encoding.\nset-max-intset-entries 512\n\n# Similarly to hashes and lists, sorted sets are also specially encoded in\n# order to save a lot of space. This encoding is only used when the length and\n# elements of a sorted set are below the following limits:\nzset-max-ziplist-entries 128\nzset-max-ziplist-value 64\n\n# Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in\n# order to help rehashing the main Redis hash table (the one mapping top-level\n# keys to values). The hash table implementation redis uses (see dict.c)\n# performs a lazy rehashing: the more operation you run into an hash table\n# that is rhashing, the more rehashing \"steps\" are performed, so if the\n# server is idle the rehashing is never complete and some more memory is used\n# by the hash table.\n#\n# The default is to use this millisecond 10 times every second in order to\n# active rehashing the main dictionaries, freeing memory when possible.\n#\n# If unsure:\n# use \"activerehashing no\" if you have hard latency requirements and it is\n# not a good thing in your environment that Redis can reply form time to time\n# to queries with 2 milliseconds delay.\n#\n# use \"activerehashing yes\" if you don't have such hard requirements but\n# want to free memory asap when possible.\nactiverehashing yes\n\n################## INCLUDES ###################################\n\n# Include one or more other config files here.  This is useful if you\n# have a standard template that goes to all redis server but also need\n# to customize a few per-server settings.  Include files can include\n# other files, so use this wisely.\n#\n# include /path/to/local.conf\n# include /path/to/other.conf\n```\n\n\n##\tRedis常用命令\n### 键值相关命令\n1、 keys  键名\n> 按照键名查找指定的键。支持通配符\n\n```\n127.0.0.1:6379> set hello 1\nOK\n127.0.0.1:6379> set hallo 1\nOK\n127.0.0.1:6379> set heeeello 1\nOK\n127.0.0.1:6379> keys h?llo\n1) \"hallo\"\n2) \"hello\"\n127.0.0.1:6379> keys h*llo\n1) \"hallo\"\n2) \"heeeello\"\n3) \"hello\"\n```\n\n2、\texists  键名\n>\t确认一个键是否存在\n\n```\n127.0.0.1:6379> EXISTS name\n(integer) 1\t\t\t\t\t\t//name键存在\n127.0.0.1:6379> EXISTS age\n(integer) 0\t\t\t\t\t\t//age键不存在\n```\n\n3、\tdel  键名\n>\t删除一个键\n\n```\n127.0.0.1:6379> del hello\n(integer) 1\n127.0.0.1:6379> EXISTS hello\n(integer) 0\n```\n\n4、\texpire  键  秒\n>\t设置一个键的过期时间，如果键已经过期，将会被自动删除\n\n```\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> EXPIRE age 20\n(integer) 1\n127.0.0.1:6379> ttl age\n(integer) 18\n127.0.0.1:6379> ttl age\n(integer) -2\n127.0.0.1:6379> EXISTS age\n(integer) 0\n```\n\n5、\tttl  键\n>\t以秒为单位，返回键的剩余生存时间。\n>\n>\t当键不存在时，返回值为-2\n>\n>\t当键存在，但没有设置剩余生存时间时，返回-1\n\n\n```\n127.0.0.1:6379> ttl name\n(integer) -1\n```\n\n6、\tselect  数据库号\n>\t选择一个数据库。\n>\t默认连接的数据库是0，可以支持共16个数据库。\n>\t在配置文件中，通过databases 16 关键字定义\n\n```\n127.0.0.1:6379> select 1\nOK\n127.0.0.1:6379[1]>\n```\n\n7、\tmove  键  数据库号\n>\t将当前数据库的键移动到指定的数据空中\n\n```\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> move age 1\n(integer) 1\n127.0.0.1:6379> get age\n(nil)\n127.0.0.1:6379> select 1\nOK\n127.0.0.1:6379[1]> get age\n\"18\"\n```\n\n8、\trandomkey  \n>\t从当前数据库返回一个随机的键。如果当前库没有任何键，则返回nil\n\n9、\trename  旧名  新名\n>\t重命名键\n\n```\n127.0.0.1:6379> rename name name_new\nOK\n127.0.0.1:6379> get name_new\n\"sc\"\n```\n\n10、 type  键\n> \t返回键类型。\n\n返回值\n- none (key不存在)\n- string (字符串)\n- list (列表)\n- set (集合)\n- zset (有序集)\n- hash (哈希表)\n\n### 服务器相关命令\n1、\tping\n>\t测试服务器是否可以连接\n\n```\n127.0.0.1:6379> ping\nPONG\t\t\t\t\t//连接正常\n127.0.0.1:6379> ping\nCould not connect to Redis at 127.0.0.1:6379: Connection refused\n//redis被停止，连接拒绝\n```\n\n2、\techo  字符串\n>\t在命令行输出字符串\n\n```\n127.0.0.1:6379> echo \"test message\"\n\"test message\"\n```\n\n3、\tquit\n>\t退出redis数据库\n\n4、\tsave\n>\t保存所有的数据。很少在生产环境直接使用SAVE 命令，因为它会阻塞所有的客户端的请求，可以使用BGSAVE 命令代替. 如果在BGSAVE命令的保存数据的子进程发生错误的时,用 SAVE命令保存最新的数据是最后的手段\n\n5、\tdbsize\n>\t返回当前库中键的数量\n\n```\n127.0.0.1:6379> dbsize\n(integer) 6\n```\n\n6、\tinfo\n>\t获取服务器的详细信息\n\n7、\tconfig get 参数\n>\t获取redis服务器配置文件中的参数。支持通配符\n\n```\n127.0.0.1:6379> config get *\t\t\t//查询配置文件中所有的参数\n  1) \"dbfilename\"\n  2) \"dump.rdb\"\n 45) \"port\"\n 46) \"6379\"\n 99) \"save\"\n 100) \"900 1 300 10 60 10000\"\n```\n\n8、 flushdb\n>\t删除当前数据库中所有的数据\n\n```\n127.0.0.1:6379> dbsize\n(integer) 6\n127.0.0.1:6379> flushdb\nOK\n127.0.0.1:6379> dbsize\n(integer) 0\n```\n\n9、\tflushall\n> \t删除所有数据库中所有的数据\n","slug":"Redis安装与管理","published":1,"updated":"2016-10-07T13:00:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwx3003k699f39e6ojfp","content":"<p>redis是一个key-value存储系统。<br>和Memcached类似，它支持存储的value类型相对更多，<br>包括string(字符串)、list(链表)、set(集合)和zset(有序集合)。<br>这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。</p>\n<p>在此基础上，redis支持各种不同方式的排序。与memcached一样，为了保证效率，数据都是缓存在内存中。<br>区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。</p>\n<p>Redis 是一个高性能的key-value数据库。<br> redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部 分场合可以对关系数据库起到很好的补充作用。<br>它提供了Python，Ruby，Erlang，PHP客户端，使用很方便。</p>\n<ul>\n<li><p>Memcache</p>\n<blockquote>\n<p>内存缓存服务，缓存数据保存在内存中，一旦断电重启，数据将丢失</p>\n</blockquote>\n</li>\n<li><p>mangoDB</p>\n<blockquote>\n<p>开源免费的NOSQL 数据库，提供数据持久化服务，以文档的形式提供数据组织方式，而不是表</p>\n</blockquote>\n</li>\n<li><p>Redis</p>\n<blockquote>\n<p>开源免费的 NOSQL数据库，提供数据持久化服务，即能实现内存缓存服务，也能提供数据结构服务取代MySQL 自建索引用来弥补关系型数据的不足</p>\n</blockquote>\n</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h3 id=\"默认安装位置\"><a href=\"#默认安装位置\" class=\"headerlink\" title=\"默认安装位置\"></a>默认安装位置</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# wget http://download.redis.io/releases/redis-2.8.6.tar.gz</div><div class=\"line\">[root@localhost ~]# tar xzf redis-2.8.6.tar.gz</div><div class=\"line\">[root@localhost ~]# cd redis-2.8.6</div><div class=\"line\">[root@localhost ~]# make</div><div class=\"line\">#不指定安装位置，则会把redis的可执行文件安装到  redis-2.8.6/src/目录下</div></pre></td></tr></table></figure>\n<h3 id=\"指定安装位置\"><a href=\"#指定安装位置\" class=\"headerlink\" title=\"指定安装位置\"></a>指定安装位置</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# tar xzf redis-2.8.6.tar.gz</div><div class=\"line\">[root@localhost ~]# cd redis-2.8.6</div><div class=\"line\">[root@localhost ~]# make</div><div class=\"line\">[root@localhost ~]# make PREFIX=/usr/local/redis install</div><div class=\"line\">#指定安装位置，如果没有指定安装位置PREFIX=/usr/local/redis，则make install会把redis安装到/usr/local/bin/目录下</div><div class=\"line\">[root@localhost ~]# mkdir /usr/local/redis/etc</div><div class=\"line\">[root@localhost ~]# cp /root/redis-2.8.6/redis.conf /usr/local/redis/etc/</div></pre></td></tr></table></figure>\n<h3 id=\"安装的可执行文件的作用\"><a href=\"#安装的可执行文件的作用\" class=\"headerlink\" title=\"安装的可执行文件的作用\"></a>安装的可执行文件的作用</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">redis-server           \t服务器端</div><div class=\"line\">redis-cli              \t客户端</div><div class=\"line\">redis-benchmark       \t调试</div><div class=\"line\">redis-check-dump      \t数据导出</div><div class=\"line\">redis-check-aof        \t数据导入</div></pre></td></tr></table></figure>\n<h2 id=\"启动与关闭\"><a href=\"#启动与关闭\" class=\"headerlink\" title=\"启动与关闭\"></a>启动与关闭</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><p>路径<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/redis-server</div></pre></td></tr></table></figure></p>\n<p>配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/redis/bin/redis-server  /usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>注意：需要修改配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\">daemonize no\t\t改为</div><div class=\"line\">daemonize yes    \t#后台启动</div></pre></td></tr></table></figure></p>\n<p>端口 6379<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">#客户端连接</div><div class=\"line\">\t-h  IP\t：\t\t连接指定的redis服务器</div><div class=\"line\">\t-p  6379：\t\t指定redis服务器的端口</div><div class=\"line\">\t-a  密码：\t\t使用密码登录</div><div class=\"line\">\t-n 数据库号：\t指定连接哪个数据库</div></pre></td></tr></table></figure></p>\n<h3 id=\"关闭redis\"><a href=\"#关闭redis\" class=\"headerlink\" title=\"关闭redis\"></a>关闭redis</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-cli shutdown</div></pre></td></tr></table></figure>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# pkill  -9 redis</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div><div class=\"line\">311</div><div class=\"line\">312</div><div class=\"line\">313</div><div class=\"line\">314</div><div class=\"line\">315</div><div class=\"line\">316</div><div class=\"line\">317</div><div class=\"line\">318</div><div class=\"line\">319</div><div class=\"line\">320</div><div class=\"line\">321</div><div class=\"line\">322</div><div class=\"line\">323</div><div class=\"line\">324</div><div class=\"line\">325</div><div class=\"line\">326</div><div class=\"line\">327</div><div class=\"line\">328</div><div class=\"line\">329</div><div class=\"line\">330</div><div class=\"line\">331</div><div class=\"line\">332</div><div class=\"line\">333</div><div class=\"line\">334</div><div class=\"line\">335</div><div class=\"line\">336</div><div class=\"line\">337</div><div class=\"line\">338</div><div class=\"line\">339</div><div class=\"line\">340</div><div class=\"line\">341</div><div class=\"line\">342</div><div class=\"line\">343</div><div class=\"line\">344</div><div class=\"line\">345</div><div class=\"line\">346</div><div class=\"line\">347</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\">#是否以后台进程运行，默认为no，如果需要以后台进程运行则改为yes</div><div class=\"line\">daemonize no</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#如果以后台进程运行的话，就需要指定pid，你可以在此自定义redis.pid文件的位置。</div><div class=\"line\">pidfile /var/run/redis.pid</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#接受连接的端口号，如果端口是0则redis将不会监听TCP socket连接</div><div class=\"line\">port 6379</div><div class=\"line\"></div><div class=\"line\"># If you want you can bind a single interface, if the bind option is not</div><div class=\"line\"># specified all the interfaces will listen for incoming connections.</div><div class=\"line\">#</div><div class=\"line\"># bind 127.0.0.1</div><div class=\"line\"></div><div class=\"line\"># Specify the path for the unix socket that will be used to listen for</div><div class=\"line\"># incoming connections. There is no default, so Redis will not listen</div><div class=\"line\"># on a unix socket when not specified.</div><div class=\"line\">#</div><div class=\"line\"># unixsocket /tmp/redis.sock</div><div class=\"line\"># unixsocketperm 755</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#连接超时时间，单位秒。(0 to disable)？</div><div class=\"line\">timeout 300000000</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#日志级别，默认是verbose（详细），各种日志级别：</div><div class=\"line\">#debug:很详细的信息，适合开发和测试</div><div class=\"line\">#verbose:包含许多不太有用的信息，但比debug要清爽一些（many rarely useful info, but not a mess like #the debug level）</div><div class=\"line\">#notice:比较适合生产环境</div><div class=\"line\">#warning:警告信息</div><div class=\"line\">loglevel verbose</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#指定log文件的名字，默认是空。stdout会让redis把日志输出到标准输出。但是如果使用stdout而又以后台进#程的方式运行redis，则日志会输出到/dev/null。请改为需要的日志名</div><div class=\"line\">logfile  &quot;&quot;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#&apos;syslog-enabled&apos;设置为yes会把日志输出到系统日志，默认是no</div><div class=\"line\"># syslog-enabled no</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#指定syslog的标示符，如果&apos;syslog-enabled&apos;是no，则这个选项无效。</div><div class=\"line\"># syslog-ident redis</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#指定syslog 设备（facility), 必须是USER或者LOCAL0到LOCAL7.</div><div class=\"line\"># syslog-facility local0</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#设置数据库数目。默认的数据库是DB 0。可以通过SELECT &lt;dbid&gt;来选择一个数据库，dbid是[0,&apos;databases&apos;-1]的数字</div><div class=\"line\">databases 16</div><div class=\"line\"></div><div class=\"line\">################## 快照#################################</div><div class=\"line\">#</div><div class=\"line\"># 硬盘上保存数据:</div><div class=\"line\">#</div><div class=\"line\">#   save &lt;seconds&gt; &lt;changes&gt;</div><div class=\"line\">#</div><div class=\"line\">#   &lt;seconds&gt;和&lt;changes&gt;都满足时就会触发数据保存动作。</div><div class=\"line\">#   </div><div class=\"line\">#</div><div class=\"line\">#   以下面的例子来说明：</div><div class=\"line\">#   过了900秒并且有1个key发生了改变 就会触发save动作</div><div class=\"line\">#   过了300秒并且有10个key发生了改变 就会触发save动作</div><div class=\"line\">#   过了60秒并且至少有10000个key发生了改变 也会触发save动作</div><div class=\"line\">#</div><div class=\"line\">#   注意：如果你不想让redis自动保存数据，那就把下面的配置注释掉！</div><div class=\"line\"></div><div class=\"line\">save 900 1</div><div class=\"line\">save 300 10</div><div class=\"line\">save 60 10000</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#存储数据时是否压缩数据。默认是yes。</div><div class=\"line\">rdbcompression yes</div><div class=\"line\"></div><div class=\"line\"># 保存dump数据的文件名</div><div class=\"line\">dbfilename dump.rdb</div><div class=\"line\"></div><div class=\"line\"># 工作目录.</div><div class=\"line\">#</div><div class=\"line\"># 数据会被持久化到这个目录下的‘dbfilename’指定的文件中。</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># 注意，这里指定的必须是目录而不能是文件。</div><div class=\"line\">dir ./</div><div class=\"line\"></div><div class=\"line\">######## REPLICATION（复制，冗余）#################################</div><div class=\"line\"></div><div class=\"line\"># Master-Slave replication. 使用slaveof把一个 Redis 实例设置成为另一个Redis server的从库（热备）. 注意： #配置只对当前slave有效。</div><div class=\"line\"># 因此可以把某个slave配置成使用不同的时间间隔来保存数据或者监听其他端口等等。</div><div class=\"line\">#命令格式：</div><div class=\"line\"># slaveof &lt;masterip&gt; &lt;masterport&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#如果master有密码保护，则在slave与master进行数据同步之前需要进行密码校验，否则master会拒绝slave的请#求。</div><div class=\"line\">#</div><div class=\"line\"># masterauth &lt;master-password&gt;</div><div class=\"line\"></div><div class=\"line\">#当slave丢失与master的连接时，或者slave仍然在于master进行数据同步时（还没有与master保持一致），#slave可以有两种方式来响应客户端请求：</div><div class=\"line\">#</div><div class=\"line\"># 1) 如果 slave-serve-stale-data 设置成 &apos;yes&apos; (the default) slave会仍然响应客户端请求,此时可能会有问题。</div><div class=\"line\">#</div><div class=\"line\"># 2) 如果 slave-serve-stale data设置成  &apos;no&apos;  slave会返回&quot;SYNC with master in progress&quot;这样的错误信息。 但 INFO 和SLAVEOF命令除外。</div><div class=\"line\">#</div><div class=\"line\">slave-serve-stale-data yes</div><div class=\"line\"></div><div class=\"line\">############### 安全 ###################################</div><div class=\"line\"></div><div class=\"line\"># 需要客户端在执行任何命令之前指定 AUTH &lt;PASSWORD&gt;</div><div class=\"line\">#</div><div class=\"line\"># requirepass foobared</div><div class=\"line\"></div><div class=\"line\"># 命令重命名.</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># 例如:</div><div class=\"line\">#</div><div class=\"line\"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</div><div class=\"line\">#</div><div class=\"line\"># 同样可以通过把一个命令重命名为空串来彻底kill掉这个命令，比如：</div><div class=\"line\">#</div><div class=\"line\"># rename-command CONFIG &quot;&quot;</div><div class=\"line\"></div><div class=\"line\">#################### 限制 ####################################</div><div class=\"line\"></div><div class=\"line\"># 设置最大连接数. 默认没有限制,  &apos;0&apos; 意味着不限制.</div><div class=\"line\">#</div><div class=\"line\"># maxclients 128</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#最大可使用内存。如果超过，Redis会试图删除EXPIRE集合中的keys，具体做法是：Redis会试图释放即将过期的#keys，而保护还有很长生命周期的keys。</div><div class=\"line\">#</div><div class=\"line\">#如果这样还不行，Redis就会报错，但像GET之类的查询请求还是会得到响应。</div><div class=\"line\">#</div><div class=\"line\">#警告：如果你想把Redis视为一个真正的DB的话，那不要设置&lt;maxmemory&gt;,只有你只想把Redis作为cache或者</div><div class=\"line\">#有状态的server（&apos;state&apos; server)时才需要设置。</div><div class=\"line\">#</div><div class=\"line\"># maxmemory &lt;bytes&gt;</div><div class=\"line\"></div><div class=\"line\">#内存清理策略：如果达到了maxmemory，你可以采取如下动作：</div><div class=\"line\">#</div><div class=\"line\"># volatile-lru -&gt; 使用LRU算法来删除过期的set</div><div class=\"line\"># allkeys-lru -&gt; 删除任何遵循LRU算法的key</div><div class=\"line\"># volatile-random -&gt;随机地删除过期set中的key</div><div class=\"line\"># allkeys-&gt;random -&gt; 随机地删除一个key</div><div class=\"line\"># volatile-ttl -&gt; 删除最近即将过期的key（the nearest expire time (minor TTL)）</div><div class=\"line\"># noeviction -&gt; 根本不过期，写操作直接报错</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># 默认策略:</div><div class=\"line\">#</div><div class=\"line\"># maxmemory-policy volatile-lru</div><div class=\"line\"></div><div class=\"line\"># 对于处理redis内存来说，LRU和minor TTL算法不是精确的，而是近似的（估计的）算法。所以我们会检查某些样本#来达到内存检查的目的。默认的样本数是3，你可以修改它。</div><div class=\"line\">#</div><div class=\"line\"># maxmemory-samples 3</div><div class=\"line\"></div><div class=\"line\">################# APPEND ONLY MODE ###############################</div><div class=\"line\"></div><div class=\"line\">#默认情况下，Redis会异步的把数据保存到硬盘。如果你的应用场景允许因为系统崩溃等极端情况而导致最新数据丢失#的话，那这种做法已经很ok了。否则你应该打开‘append only’模式，开启这种模式后，Redis会在#appendonly.aof文件中添加每一个写操作，这个文件会在Redis启动时被读取来在内存中重新构建数据集。</div><div class=\"line\">#</div><div class=\"line\">#注意：如果你需要，你可以同时开启‘append only’模式和异步dumps模式（你需要注释掉上面的‘save’表达式来禁#止dumps），这种情况下，Redis重建数据集时会优先使用appendonly.aof而忽略dump.rdb</div><div class=\"line\">#</div><div class=\"line\">appendonly no</div><div class=\"line\"></div><div class=\"line\">#  append only 文件名 (默认: &quot;appendonly.aof&quot;)</div><div class=\"line\"># appendfilename appendonly.aof</div><div class=\"line\"></div><div class=\"line\"># 调用fsync()函数通知操作系统立刻向硬盘写数据</div><div class=\"line\">#</div><div class=\"line\"># Redis支持3中模式:</div><div class=\"line\">#</div><div class=\"line\"># no:不fsync, 只是通知OS可以flush数据了，具体是否flush取决于OS.性能更好.</div><div class=\"line\"># always: 每次写入append only 日志文件后都会fsync . 性能差，但很安全.</div><div class=\"line\"># everysec: 没间隔1秒进行一次fsync. 折中.</div><div class=\"line\">#</div><div class=\"line\"># 默认是 &quot;everysec&quot;</div><div class=\"line\"># appendfsync always</div><div class=\"line\">appendfsync everysec</div><div class=\"line\"># appendfsync no</div><div class=\"line\"></div><div class=\"line\"># 当AOF fsync策略被设置为always或者everysec并且后台保存进程（saving process)正在执行大量I/O操作时</div><div class=\"line\"># Redis可能会在fsync()调用上阻塞过长时间</div><div class=\"line\">#</div><div class=\"line\">no-appendfsync-on-rewrite no</div><div class=\"line\"></div><div class=\"line\"># append only 文件的自动重写</div><div class=\"line\"># 当AOF 日志文件即将增长到指定百分比时，Redis可以通过调用BGREWRITEAOF 来自动重写append only文件。</div><div class=\"line\">#</div><div class=\"line\"># 它是这么干的：Redis会记住最近一次重写后的AOF 文件size。然后它会把这个size与当前size进行比较，如果当前# size比指定的百分比大，就会触发重写。同样，你需要指定AOF文件被重写的最小size，这对避免虽然百分比达到了# 但是实际上文件size还是很小（这种情况没有必要重写）却导致AOF文件重写的情况很有用。</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># auto-aof-rewrite-percentage 设置为 0 可以关闭AOF重写功能</div><div class=\"line\"></div><div class=\"line\">auto-aof-rewrite-percentage 100</div><div class=\"line\">auto-aof-rewrite-min-size 64mb</div><div class=\"line\"></div><div class=\"line\">################## SLOW LOG ###################################</div><div class=\"line\"></div><div class=\"line\"># Redis slow log用来记录超过指定执行时间的查询。</div><div class=\"line\">#</div><div class=\"line\"># 你可以指定两个参数：一个是慢查询的阀值，单位是毫秒；另外一个是slow log的长度，相当于一个队列。</div><div class=\"line\"></div><div class=\"line\"># 负数则关闭slow log，0则会导致每个命令都被记录</div><div class=\"line\">slowlog-log-slower-than 10000</div><div class=\"line\"></div><div class=\"line\"># 不设置会消耗过多内存，所以还是要设置一下。可以使用SLOWLOG RESET命令来回收slow log使用的内存</div><div class=\"line\">slowlog-max-len 1024</div><div class=\"line\"></div><div class=\"line\">################ 虚拟内存 ###############################</div><div class=\"line\">#使用redis 就别用虚拟内存了，绝对不是一个好主意，加个机器吧，所以这里不翻译啦！！</div><div class=\"line\"></div><div class=\"line\">### WARNING! Virtual Memory is deprecated in Redis 2.4</div><div class=\"line\">### The use of Virtual Memory is strongly discouraged.</div><div class=\"line\"></div><div class=\"line\"># Virtual Memory allows Redis to work with datasets bigger than the actual</div><div class=\"line\"># amount of RAM needed to hold the whole dataset in memory.</div><div class=\"line\"># In order to do so very used keys are taken in memory while the other keys</div><div class=\"line\"># are swapped into a swap file, similarly to what operating systems do</div><div class=\"line\"># with memory pages.</div><div class=\"line\">#</div><div class=\"line\"># To enable VM just set &apos;vm-enabled&apos; to yes, and set the following three</div><div class=\"line\"># VM parameters accordingly to your needs.</div><div class=\"line\"></div><div class=\"line\">vm-enabled no</div><div class=\"line\"># vm-enabled yes</div><div class=\"line\"></div><div class=\"line\"># This is the path of the Redis swap file. As you can guess, swap files</div><div class=\"line\"># can&apos;t be shared by different Redis instances, so make sure to use a swap</div><div class=\"line\"># file for every redis process you are running. Redis will complain if the</div><div class=\"line\"># swap file is already in use.</div><div class=\"line\">#</div><div class=\"line\"># The best kind of storage for the Redis swap file (that&apos;s accessed at random)</div><div class=\"line\"># is a Solid State Disk (SSD).</div><div class=\"line\">#</div><div class=\"line\"># *** WARNING *** if you are using a shared hosting the default of putting</div><div class=\"line\"># the swap file under /tmp is not secure. Create a dir with access granted</div><div class=\"line\"># only to Redis user and configure Redis to create the swap file there.</div><div class=\"line\">vm-swap-file /tmp/redis.swap</div><div class=\"line\"></div><div class=\"line\"># vm-max-memory configures the VM to use at max the specified amount of</div><div class=\"line\"># RAM. Everything that deos not fit will be swapped on disk *if* possible, that</div><div class=\"line\"># is, if there is still enough contiguous space in the swap file.</div><div class=\"line\">#</div><div class=\"line\"># With vm-max-memory 0 the system will swap everything it can. Not a good</div><div class=\"line\"># default, just specify the max amount of RAM you can in bytes, but it&apos;s</div><div class=\"line\"># better to leave some margin. For instance specify an amount of RAM</div><div class=\"line\"># that&apos;s more or less between 60 and 80% of your free RAM.</div><div class=\"line\">vm-max-memory 0</div><div class=\"line\"></div><div class=\"line\"># Redis swap files is split into pages. An object can be saved using multiple</div><div class=\"line\"># contiguous pages, but pages can&apos;t be shared between different objects.</div><div class=\"line\"># So if your page is too big, small objects swapped out on disk will waste</div><div class=\"line\"># a lot of space. If you page is too small, there is less space in the swap</div><div class=\"line\"># file (assuming you configured the same number of total swap file pages).</div><div class=\"line\">#</div><div class=\"line\"># If you use a lot of small objects, use a page size of 64 or 32 bytes.</div><div class=\"line\"># If you use a lot of big objects, use a bigger page size.</div><div class=\"line\"># If unsure, use the default :)</div><div class=\"line\">vm-page-size 32</div><div class=\"line\"></div><div class=\"line\"># Number of total memory pages in the swap file.</div><div class=\"line\"># Given that the page table (a bitmap of free/used pages) is taken in memory,</div><div class=\"line\"># every 8 pages on disk will consume 1 byte of RAM.</div><div class=\"line\">#</div><div class=\"line\"># The total swap size is vm-page-size * vm-pages</div><div class=\"line\">#</div><div class=\"line\"># With the default of 32-bytes memory pages and 134217728 pages Redis will</div><div class=\"line\"># use a 4 GB swap file, that will use 16 MB of RAM for the page table.</div><div class=\"line\">#</div><div class=\"line\"># It&apos;s better to use the smallest acceptable value for your application,</div><div class=\"line\"># but the default is large in order to work in most conditions.</div><div class=\"line\">vm-pages 134217728</div><div class=\"line\"></div><div class=\"line\"># Max number of VM I/O threads running at the same time.</div><div class=\"line\"># This threads are used to read/write data from/to swap file, since they</div><div class=\"line\"># also encode and decode objects from disk to memory or the reverse, a bigger</div><div class=\"line\"># number of threads can help with big objects even if they can&apos;t help with</div><div class=\"line\"># I/O itself as the physical device may not be able to couple with many</div><div class=\"line\"># reads/writes operations at the same time.</div><div class=\"line\">#</div><div class=\"line\"># The special value of 0 turn off threaded I/O and enables the blocking</div><div class=\"line\"># Virtual Memory implementation.</div><div class=\"line\">vm-max-threads 4</div><div class=\"line\"></div><div class=\"line\">################高级配置###############################</div><div class=\"line\"></div><div class=\"line\"># Hashes are encoded in a special way (much more memory efficient) when they</div><div class=\"line\"># have at max a given numer of elements, and the biggest element does not</div><div class=\"line\"># exceed a given threshold. You can configure this limits with the following</div><div class=\"line\"># configuration directives.</div><div class=\"line\">hash-max-zipmap-entries 512</div><div class=\"line\">hash-max-zipmap-value 64</div><div class=\"line\"></div><div class=\"line\"># Similarly to hashes, small lists are also encoded in a special way in order</div><div class=\"line\"># to save a lot of space. The special representation is only used when</div><div class=\"line\"># you are under the following limits:</div><div class=\"line\">list-max-ziplist-entries 512</div><div class=\"line\">list-max-ziplist-value 64</div><div class=\"line\"></div><div class=\"line\"># Sets have a special encoding in just one case: when a set is composed</div><div class=\"line\"># of just strings that happens to be integers in radix 10 in the range</div><div class=\"line\"># of 64 bit signed integers.</div><div class=\"line\"># The following configuration setting sets the limit in the size of the</div><div class=\"line\"># set in order to use this special memory saving encoding.</div><div class=\"line\">set-max-intset-entries 512</div><div class=\"line\"></div><div class=\"line\"># Similarly to hashes and lists, sorted sets are also specially encoded in</div><div class=\"line\"># order to save a lot of space. This encoding is only used when the length and</div><div class=\"line\"># elements of a sorted set are below the following limits:</div><div class=\"line\">zset-max-ziplist-entries 128</div><div class=\"line\">zset-max-ziplist-value 64</div><div class=\"line\"></div><div class=\"line\"># Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in</div><div class=\"line\"># order to help rehashing the main Redis hash table (the one mapping top-level</div><div class=\"line\"># keys to values). The hash table implementation redis uses (see dict.c)</div><div class=\"line\"># performs a lazy rehashing: the more operation you run into an hash table</div><div class=\"line\"># that is rhashing, the more rehashing &quot;steps&quot; are performed, so if the</div><div class=\"line\"># server is idle the rehashing is never complete and some more memory is used</div><div class=\"line\"># by the hash table.</div><div class=\"line\">#</div><div class=\"line\"># The default is to use this millisecond 10 times every second in order to</div><div class=\"line\"># active rehashing the main dictionaries, freeing memory when possible.</div><div class=\"line\">#</div><div class=\"line\"># If unsure:</div><div class=\"line\"># use &quot;activerehashing no&quot; if you have hard latency requirements and it is</div><div class=\"line\"># not a good thing in your environment that Redis can reply form time to time</div><div class=\"line\"># to queries with 2 milliseconds delay.</div><div class=\"line\">#</div><div class=\"line\"># use &quot;activerehashing yes&quot; if you don&apos;t have such hard requirements but</div><div class=\"line\"># want to free memory asap when possible.</div><div class=\"line\">activerehashing yes</div><div class=\"line\"></div><div class=\"line\">################## INCLUDES ###################################</div><div class=\"line\"></div><div class=\"line\"># Include one or more other config files here.  This is useful if you</div><div class=\"line\"># have a standard template that goes to all redis server but also need</div><div class=\"line\"># to customize a few per-server settings.  Include files can include</div><div class=\"line\"># other files, so use this wisely.</div><div class=\"line\">#</div><div class=\"line\"># include /path/to/local.conf</div><div class=\"line\"># include /path/to/other.conf</div></pre></td></tr></table></figure>\n<h2 id=\"Redis常用命令\"><a href=\"#Redis常用命令\" class=\"headerlink\" title=\"Redis常用命令\"></a>Redis常用命令</h2><h3 id=\"键值相关命令\"><a href=\"#键值相关命令\" class=\"headerlink\" title=\"键值相关命令\"></a>键值相关命令</h3><p>1、 keys  键名</p>\n<blockquote>\n<p>按照键名查找指定的键。支持通配符</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set hello 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; set hallo 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; set heeeello 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys h?llo</div><div class=\"line\">1) &quot;hallo&quot;</div><div class=\"line\">2) &quot;hello&quot;</div><div class=\"line\">127.0.0.1:6379&gt; keys h*llo</div><div class=\"line\">1) &quot;hallo&quot;</div><div class=\"line\">2) &quot;heeeello&quot;</div><div class=\"line\">3) &quot;hello&quot;</div></pre></td></tr></table></figure>\n<p>2、    exists  键名</p>\n<blockquote>\n<p>   确认一个键是否存在</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; EXISTS name</div><div class=\"line\">(integer) 1\t\t\t\t\t\t//name键存在</div><div class=\"line\">127.0.0.1:6379&gt; EXISTS age</div><div class=\"line\">(integer) 0\t\t\t\t\t\t//age键不存在</div></pre></td></tr></table></figure>\n<p>3、    del  键名</p>\n<blockquote>\n<p>   删除一个键</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; del hello</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; EXISTS hello</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<p>4、    expire  键  秒</p>\n<blockquote>\n<p>   设置一个键的过期时间，如果键已经过期，将会被自动删除</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set age 18</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; EXPIRE age 20</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; ttl age</div><div class=\"line\">(integer) 18</div><div class=\"line\">127.0.0.1:6379&gt; ttl age</div><div class=\"line\">(integer) -2</div><div class=\"line\">127.0.0.1:6379&gt; EXISTS age</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<p>5、    ttl  键</p>\n<blockquote>\n<p>   以秒为单位，返回键的剩余生存时间。</p>\n<p>   当键不存在时，返回值为-2</p>\n<p>   当键存在，但没有设置剩余生存时间时，返回-1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; ttl name</div><div class=\"line\">(integer) -1</div></pre></td></tr></table></figure>\n<p>6、    select  数据库号</p>\n<blockquote>\n<p>   选择一个数据库。<br>   默认连接的数据库是0，可以支持共16个数据库。<br>   在配置文件中，通过databases 16 关键字定义</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; select 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379[1]&gt;</div></pre></td></tr></table></figure>\n<p>7、    move  键  数据库号</p>\n<blockquote>\n<p>   将当前数据库的键移动到指定的数据空中</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set age 18</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; move age 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">(nil)</div><div class=\"line\">127.0.0.1:6379&gt; select 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379[1]&gt; get age</div><div class=\"line\">&quot;18&quot;</div></pre></td></tr></table></figure>\n<p>8、    randomkey  </p>\n<blockquote>\n<p>   从当前数据库返回一个随机的键。如果当前库没有任何键，则返回nil</p>\n</blockquote>\n<p>9、    rename  旧名  新名</p>\n<blockquote>\n<p>   重命名键</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; rename name name_new</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; get name_new</div><div class=\"line\">&quot;sc&quot;</div></pre></td></tr></table></figure>\n<p>10、 type  键</p>\n<blockquote>\n<pre><code>返回键类型。\n</code></pre></blockquote>\n<p>返回值</p>\n<ul>\n<li>none (key不存在)</li>\n<li>string (字符串)</li>\n<li>list (列表)</li>\n<li>set (集合)</li>\n<li>zset (有序集)</li>\n<li>hash (哈希表)</li>\n</ul>\n<h3 id=\"服务器相关命令\"><a href=\"#服务器相关命令\" class=\"headerlink\" title=\"服务器相关命令\"></a>服务器相关命令</h3><p>1、    ping</p>\n<blockquote>\n<p>   测试服务器是否可以连接</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; ping</div><div class=\"line\">PONG\t\t\t\t\t//连接正常</div><div class=\"line\">127.0.0.1:6379&gt; ping</div><div class=\"line\">Could not connect to Redis at 127.0.0.1:6379: Connection refused</div><div class=\"line\">//redis被停止，连接拒绝</div></pre></td></tr></table></figure>\n<p>2、    echo  字符串</p>\n<blockquote>\n<p>   在命令行输出字符串</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; echo &quot;test message&quot;</div><div class=\"line\">&quot;test message&quot;</div></pre></td></tr></table></figure>\n<p>3、    quit</p>\n<blockquote>\n<p>   退出redis数据库</p>\n</blockquote>\n<p>4、    save</p>\n<blockquote>\n<p>   保存所有的数据。很少在生产环境直接使用SAVE 命令，因为它会阻塞所有的客户端的请求，可以使用BGSAVE 命令代替. 如果在BGSAVE命令的保存数据的子进程发生错误的时,用 SAVE命令保存最新的数据是最后的手段</p>\n</blockquote>\n<p>5、    dbsize</p>\n<blockquote>\n<p>   返回当前库中键的数量</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; dbsize</div><div class=\"line\">(integer) 6</div></pre></td></tr></table></figure>\n<p>6、    info</p>\n<blockquote>\n<p>   获取服务器的详细信息</p>\n</blockquote>\n<p>7、    config get 参数</p>\n<blockquote>\n<p>   获取redis服务器配置文件中的参数。支持通配符</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; config get *\t\t\t//查询配置文件中所有的参数</div><div class=\"line\">  1) &quot;dbfilename&quot;</div><div class=\"line\">  2) &quot;dump.rdb&quot;</div><div class=\"line\"> 45) &quot;port&quot;</div><div class=\"line\"> 46) &quot;6379&quot;</div><div class=\"line\"> 99) &quot;save&quot;</div><div class=\"line\"> 100) &quot;900 1 300 10 60 10000&quot;</div></pre></td></tr></table></figure>\n<p>8、 flushdb</p>\n<blockquote>\n<p>   删除当前数据库中所有的数据</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; dbsize</div><div class=\"line\">(integer) 6</div><div class=\"line\">127.0.0.1:6379&gt; flushdb</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; dbsize</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<p>9、    flushall</p>\n<blockquote>\n<pre><code>删除所有数据库中所有的数据\n</code></pre></blockquote>\n","excerpt":"<p>redis是一个key-value存储系统。<br>和Memcached类似，它支持存储的value类型相对更多，<br>包括string(字符串)、list(链表)、set(集合)和zset(有序集合)。<br>这些数据类型都支持push/pop、add/remove及取交集并集和差集及更丰富的操作，而且这些操作都是原子性的。</p>\n<p>在此基础上，redis支持各种不同方式的排序。与memcached一样，为了保证效率，数据都是缓存在内存中。<br>区别的是redis会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并且在此基础上实现了master-slave(主从)同步。</p>\n<p>Redis 是一个高性能的key-value数据库。<br> redis的出现，很大程度补偿了memcached这类key/value存储的不足，在部 分场合可以对关系数据库起到很好的补充作用。<br>它提供了Python，Ruby，Erlang，PHP客户端，使用很方便。</p>\n<ul>\n<li><p>Memcache</p>\n<blockquote>\n<p>内存缓存服务，缓存数据保存在内存中，一旦断电重启，数据将丢失</p>\n</blockquote>\n</li>\n<li><p>mangoDB</p>\n<blockquote>\n<p>开源免费的NOSQL 数据库，提供数据持久化服务，以文档的形式提供数据组织方式，而不是表</p>\n</blockquote>\n</li>\n<li><p>Redis</p>\n<blockquote>\n<p>开源免费的 NOSQL数据库，提供数据持久化服务，即能实现内存缓存服务，也能提供数据结构服务取代MySQL 自建索引用来弥补关系型数据的不足</p>\n</blockquote>\n</li>\n</ul>","more":"<h2 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h2><h3 id=\"默认安装位置\"><a href=\"#默认安装位置\" class=\"headerlink\" title=\"默认安装位置\"></a>默认安装位置</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# wget http://download.redis.io/releases/redis-2.8.6.tar.gz</div><div class=\"line\">[root@localhost ~]# tar xzf redis-2.8.6.tar.gz</div><div class=\"line\">[root@localhost ~]# cd redis-2.8.6</div><div class=\"line\">[root@localhost ~]# make</div><div class=\"line\">#不指定安装位置，则会把redis的可执行文件安装到  redis-2.8.6/src/目录下</div></pre></td></tr></table></figure>\n<h3 id=\"指定安装位置\"><a href=\"#指定安装位置\" class=\"headerlink\" title=\"指定安装位置\"></a>指定安装位置</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# tar xzf redis-2.8.6.tar.gz</div><div class=\"line\">[root@localhost ~]# cd redis-2.8.6</div><div class=\"line\">[root@localhost ~]# make</div><div class=\"line\">[root@localhost ~]# make PREFIX=/usr/local/redis install</div><div class=\"line\">#指定安装位置，如果没有指定安装位置PREFIX=/usr/local/redis，则make install会把redis安装到/usr/local/bin/目录下</div><div class=\"line\">[root@localhost ~]# mkdir /usr/local/redis/etc</div><div class=\"line\">[root@localhost ~]# cp /root/redis-2.8.6/redis.conf /usr/local/redis/etc/</div></pre></td></tr></table></figure>\n<h3 id=\"安装的可执行文件的作用\"><a href=\"#安装的可执行文件的作用\" class=\"headerlink\" title=\"安装的可执行文件的作用\"></a>安装的可执行文件的作用</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">redis-server           \t服务器端</div><div class=\"line\">redis-cli              \t客户端</div><div class=\"line\">redis-benchmark       \t调试</div><div class=\"line\">redis-check-dump      \t数据导出</div><div class=\"line\">redis-check-aof        \t数据导入</div></pre></td></tr></table></figure>\n<h2 id=\"启动与关闭\"><a href=\"#启动与关闭\" class=\"headerlink\" title=\"启动与关闭\"></a>启动与关闭</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><p>路径<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/redis-server</div></pre></td></tr></table></figure></p>\n<p>配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/redis/bin/redis-server  /usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>注意：需要修改配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\">daemonize no\t\t改为</div><div class=\"line\">daemonize yes    \t#后台启动</div></pre></td></tr></table></figure></p>\n<p>端口 6379<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">#客户端连接</div><div class=\"line\">\t-h  IP\t：\t\t连接指定的redis服务器</div><div class=\"line\">\t-p  6379：\t\t指定redis服务器的端口</div><div class=\"line\">\t-a  密码：\t\t使用密码登录</div><div class=\"line\">\t-n 数据库号：\t指定连接哪个数据库</div></pre></td></tr></table></figure></p>\n<h3 id=\"关闭redis\"><a href=\"#关闭redis\" class=\"headerlink\" title=\"关闭redis\"></a>关闭redis</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-cli shutdown</div></pre></td></tr></table></figure>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# pkill  -9 redis</div></pre></td></tr></table></figure></p>\n<h2 id=\"配置文件\"><a href=\"#配置文件\" class=\"headerlink\" title=\"配置文件\"></a>配置文件</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div><div class=\"line\">66</div><div class=\"line\">67</div><div class=\"line\">68</div><div class=\"line\">69</div><div class=\"line\">70</div><div class=\"line\">71</div><div class=\"line\">72</div><div class=\"line\">73</div><div class=\"line\">74</div><div class=\"line\">75</div><div class=\"line\">76</div><div class=\"line\">77</div><div class=\"line\">78</div><div class=\"line\">79</div><div class=\"line\">80</div><div class=\"line\">81</div><div class=\"line\">82</div><div class=\"line\">83</div><div class=\"line\">84</div><div class=\"line\">85</div><div class=\"line\">86</div><div class=\"line\">87</div><div class=\"line\">88</div><div class=\"line\">89</div><div class=\"line\">90</div><div class=\"line\">91</div><div class=\"line\">92</div><div class=\"line\">93</div><div class=\"line\">94</div><div class=\"line\">95</div><div class=\"line\">96</div><div class=\"line\">97</div><div class=\"line\">98</div><div class=\"line\">99</div><div class=\"line\">100</div><div class=\"line\">101</div><div class=\"line\">102</div><div class=\"line\">103</div><div class=\"line\">104</div><div class=\"line\">105</div><div class=\"line\">106</div><div class=\"line\">107</div><div class=\"line\">108</div><div class=\"line\">109</div><div class=\"line\">110</div><div class=\"line\">111</div><div class=\"line\">112</div><div class=\"line\">113</div><div class=\"line\">114</div><div class=\"line\">115</div><div class=\"line\">116</div><div class=\"line\">117</div><div class=\"line\">118</div><div class=\"line\">119</div><div class=\"line\">120</div><div class=\"line\">121</div><div class=\"line\">122</div><div class=\"line\">123</div><div class=\"line\">124</div><div class=\"line\">125</div><div class=\"line\">126</div><div class=\"line\">127</div><div class=\"line\">128</div><div class=\"line\">129</div><div class=\"line\">130</div><div class=\"line\">131</div><div class=\"line\">132</div><div class=\"line\">133</div><div class=\"line\">134</div><div class=\"line\">135</div><div class=\"line\">136</div><div class=\"line\">137</div><div class=\"line\">138</div><div class=\"line\">139</div><div class=\"line\">140</div><div class=\"line\">141</div><div class=\"line\">142</div><div class=\"line\">143</div><div class=\"line\">144</div><div class=\"line\">145</div><div class=\"line\">146</div><div class=\"line\">147</div><div class=\"line\">148</div><div class=\"line\">149</div><div class=\"line\">150</div><div class=\"line\">151</div><div class=\"line\">152</div><div class=\"line\">153</div><div class=\"line\">154</div><div class=\"line\">155</div><div class=\"line\">156</div><div class=\"line\">157</div><div class=\"line\">158</div><div class=\"line\">159</div><div class=\"line\">160</div><div class=\"line\">161</div><div class=\"line\">162</div><div class=\"line\">163</div><div class=\"line\">164</div><div class=\"line\">165</div><div class=\"line\">166</div><div class=\"line\">167</div><div class=\"line\">168</div><div class=\"line\">169</div><div class=\"line\">170</div><div class=\"line\">171</div><div class=\"line\">172</div><div class=\"line\">173</div><div class=\"line\">174</div><div class=\"line\">175</div><div class=\"line\">176</div><div class=\"line\">177</div><div class=\"line\">178</div><div class=\"line\">179</div><div class=\"line\">180</div><div class=\"line\">181</div><div class=\"line\">182</div><div class=\"line\">183</div><div class=\"line\">184</div><div class=\"line\">185</div><div class=\"line\">186</div><div class=\"line\">187</div><div class=\"line\">188</div><div class=\"line\">189</div><div class=\"line\">190</div><div class=\"line\">191</div><div class=\"line\">192</div><div class=\"line\">193</div><div class=\"line\">194</div><div class=\"line\">195</div><div class=\"line\">196</div><div class=\"line\">197</div><div class=\"line\">198</div><div class=\"line\">199</div><div class=\"line\">200</div><div class=\"line\">201</div><div class=\"line\">202</div><div class=\"line\">203</div><div class=\"line\">204</div><div class=\"line\">205</div><div class=\"line\">206</div><div class=\"line\">207</div><div class=\"line\">208</div><div class=\"line\">209</div><div class=\"line\">210</div><div class=\"line\">211</div><div class=\"line\">212</div><div class=\"line\">213</div><div class=\"line\">214</div><div class=\"line\">215</div><div class=\"line\">216</div><div class=\"line\">217</div><div class=\"line\">218</div><div class=\"line\">219</div><div class=\"line\">220</div><div class=\"line\">221</div><div class=\"line\">222</div><div class=\"line\">223</div><div class=\"line\">224</div><div class=\"line\">225</div><div class=\"line\">226</div><div class=\"line\">227</div><div class=\"line\">228</div><div class=\"line\">229</div><div class=\"line\">230</div><div class=\"line\">231</div><div class=\"line\">232</div><div class=\"line\">233</div><div class=\"line\">234</div><div class=\"line\">235</div><div class=\"line\">236</div><div class=\"line\">237</div><div class=\"line\">238</div><div class=\"line\">239</div><div class=\"line\">240</div><div class=\"line\">241</div><div class=\"line\">242</div><div class=\"line\">243</div><div class=\"line\">244</div><div class=\"line\">245</div><div class=\"line\">246</div><div class=\"line\">247</div><div class=\"line\">248</div><div class=\"line\">249</div><div class=\"line\">250</div><div class=\"line\">251</div><div class=\"line\">252</div><div class=\"line\">253</div><div class=\"line\">254</div><div class=\"line\">255</div><div class=\"line\">256</div><div class=\"line\">257</div><div class=\"line\">258</div><div class=\"line\">259</div><div class=\"line\">260</div><div class=\"line\">261</div><div class=\"line\">262</div><div class=\"line\">263</div><div class=\"line\">264</div><div class=\"line\">265</div><div class=\"line\">266</div><div class=\"line\">267</div><div class=\"line\">268</div><div class=\"line\">269</div><div class=\"line\">270</div><div class=\"line\">271</div><div class=\"line\">272</div><div class=\"line\">273</div><div class=\"line\">274</div><div class=\"line\">275</div><div class=\"line\">276</div><div class=\"line\">277</div><div class=\"line\">278</div><div class=\"line\">279</div><div class=\"line\">280</div><div class=\"line\">281</div><div class=\"line\">282</div><div class=\"line\">283</div><div class=\"line\">284</div><div class=\"line\">285</div><div class=\"line\">286</div><div class=\"line\">287</div><div class=\"line\">288</div><div class=\"line\">289</div><div class=\"line\">290</div><div class=\"line\">291</div><div class=\"line\">292</div><div class=\"line\">293</div><div class=\"line\">294</div><div class=\"line\">295</div><div class=\"line\">296</div><div class=\"line\">297</div><div class=\"line\">298</div><div class=\"line\">299</div><div class=\"line\">300</div><div class=\"line\">301</div><div class=\"line\">302</div><div class=\"line\">303</div><div class=\"line\">304</div><div class=\"line\">305</div><div class=\"line\">306</div><div class=\"line\">307</div><div class=\"line\">308</div><div class=\"line\">309</div><div class=\"line\">310</div><div class=\"line\">311</div><div class=\"line\">312</div><div class=\"line\">313</div><div class=\"line\">314</div><div class=\"line\">315</div><div class=\"line\">316</div><div class=\"line\">317</div><div class=\"line\">318</div><div class=\"line\">319</div><div class=\"line\">320</div><div class=\"line\">321</div><div class=\"line\">322</div><div class=\"line\">323</div><div class=\"line\">324</div><div class=\"line\">325</div><div class=\"line\">326</div><div class=\"line\">327</div><div class=\"line\">328</div><div class=\"line\">329</div><div class=\"line\">330</div><div class=\"line\">331</div><div class=\"line\">332</div><div class=\"line\">333</div><div class=\"line\">334</div><div class=\"line\">335</div><div class=\"line\">336</div><div class=\"line\">337</div><div class=\"line\">338</div><div class=\"line\">339</div><div class=\"line\">340</div><div class=\"line\">341</div><div class=\"line\">342</div><div class=\"line\">343</div><div class=\"line\">344</div><div class=\"line\">345</div><div class=\"line\">346</div><div class=\"line\">347</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\">#是否以后台进程运行，默认为no，如果需要以后台进程运行则改为yes</div><div class=\"line\">daemonize no</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#如果以后台进程运行的话，就需要指定pid，你可以在此自定义redis.pid文件的位置。</div><div class=\"line\">pidfile /var/run/redis.pid</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#接受连接的端口号，如果端口是0则redis将不会监听TCP socket连接</div><div class=\"line\">port 6379</div><div class=\"line\"></div><div class=\"line\"># If you want you can bind a single interface, if the bind option is not</div><div class=\"line\"># specified all the interfaces will listen for incoming connections.</div><div class=\"line\">#</div><div class=\"line\"># bind 127.0.0.1</div><div class=\"line\"></div><div class=\"line\"># Specify the path for the unix socket that will be used to listen for</div><div class=\"line\"># incoming connections. There is no default, so Redis will not listen</div><div class=\"line\"># on a unix socket when not specified.</div><div class=\"line\">#</div><div class=\"line\"># unixsocket /tmp/redis.sock</div><div class=\"line\"># unixsocketperm 755</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#连接超时时间，单位秒。(0 to disable)？</div><div class=\"line\">timeout 300000000</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#日志级别，默认是verbose（详细），各种日志级别：</div><div class=\"line\">#debug:很详细的信息，适合开发和测试</div><div class=\"line\">#verbose:包含许多不太有用的信息，但比debug要清爽一些（many rarely useful info, but not a mess like #the debug level）</div><div class=\"line\">#notice:比较适合生产环境</div><div class=\"line\">#warning:警告信息</div><div class=\"line\">loglevel verbose</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#指定log文件的名字，默认是空。stdout会让redis把日志输出到标准输出。但是如果使用stdout而又以后台进#程的方式运行redis，则日志会输出到/dev/null。请改为需要的日志名</div><div class=\"line\">logfile  &quot;&quot;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#&apos;syslog-enabled&apos;设置为yes会把日志输出到系统日志，默认是no</div><div class=\"line\"># syslog-enabled no</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#指定syslog的标示符，如果&apos;syslog-enabled&apos;是no，则这个选项无效。</div><div class=\"line\"># syslog-ident redis</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#指定syslog 设备（facility), 必须是USER或者LOCAL0到LOCAL7.</div><div class=\"line\"># syslog-facility local0</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#设置数据库数目。默认的数据库是DB 0。可以通过SELECT &lt;dbid&gt;来选择一个数据库，dbid是[0,&apos;databases&apos;-1]的数字</div><div class=\"line\">databases 16</div><div class=\"line\"></div><div class=\"line\">################## 快照#################################</div><div class=\"line\">#</div><div class=\"line\"># 硬盘上保存数据:</div><div class=\"line\">#</div><div class=\"line\">#   save &lt;seconds&gt; &lt;changes&gt;</div><div class=\"line\">#</div><div class=\"line\">#   &lt;seconds&gt;和&lt;changes&gt;都满足时就会触发数据保存动作。</div><div class=\"line\">#   </div><div class=\"line\">#</div><div class=\"line\">#   以下面的例子来说明：</div><div class=\"line\">#   过了900秒并且有1个key发生了改变 就会触发save动作</div><div class=\"line\">#   过了300秒并且有10个key发生了改变 就会触发save动作</div><div class=\"line\">#   过了60秒并且至少有10000个key发生了改变 也会触发save动作</div><div class=\"line\">#</div><div class=\"line\">#   注意：如果你不想让redis自动保存数据，那就把下面的配置注释掉！</div><div class=\"line\"></div><div class=\"line\">save 900 1</div><div class=\"line\">save 300 10</div><div class=\"line\">save 60 10000</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#存储数据时是否压缩数据。默认是yes。</div><div class=\"line\">rdbcompression yes</div><div class=\"line\"></div><div class=\"line\"># 保存dump数据的文件名</div><div class=\"line\">dbfilename dump.rdb</div><div class=\"line\"></div><div class=\"line\"># 工作目录.</div><div class=\"line\">#</div><div class=\"line\"># 数据会被持久化到这个目录下的‘dbfilename’指定的文件中。</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># 注意，这里指定的必须是目录而不能是文件。</div><div class=\"line\">dir ./</div><div class=\"line\"></div><div class=\"line\">######## REPLICATION（复制，冗余）#################################</div><div class=\"line\"></div><div class=\"line\"># Master-Slave replication. 使用slaveof把一个 Redis 实例设置成为另一个Redis server的从库（热备）. 注意： #配置只对当前slave有效。</div><div class=\"line\"># 因此可以把某个slave配置成使用不同的时间间隔来保存数据或者监听其他端口等等。</div><div class=\"line\">#命令格式：</div><div class=\"line\"># slaveof &lt;masterip&gt; &lt;masterport&gt;</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#如果master有密码保护，则在slave与master进行数据同步之前需要进行密码校验，否则master会拒绝slave的请#求。</div><div class=\"line\">#</div><div class=\"line\"># masterauth &lt;master-password&gt;</div><div class=\"line\"></div><div class=\"line\">#当slave丢失与master的连接时，或者slave仍然在于master进行数据同步时（还没有与master保持一致），#slave可以有两种方式来响应客户端请求：</div><div class=\"line\">#</div><div class=\"line\"># 1) 如果 slave-serve-stale-data 设置成 &apos;yes&apos; (the default) slave会仍然响应客户端请求,此时可能会有问题。</div><div class=\"line\">#</div><div class=\"line\"># 2) 如果 slave-serve-stale data设置成  &apos;no&apos;  slave会返回&quot;SYNC with master in progress&quot;这样的错误信息。 但 INFO 和SLAVEOF命令除外。</div><div class=\"line\">#</div><div class=\"line\">slave-serve-stale-data yes</div><div class=\"line\"></div><div class=\"line\">############### 安全 ###################################</div><div class=\"line\"></div><div class=\"line\"># 需要客户端在执行任何命令之前指定 AUTH &lt;PASSWORD&gt;</div><div class=\"line\">#</div><div class=\"line\"># requirepass foobared</div><div class=\"line\"></div><div class=\"line\"># 命令重命名.</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># 例如:</div><div class=\"line\">#</div><div class=\"line\"># rename-command CONFIG b840fc02d524045429941cc15f59e41cb7be6c52</div><div class=\"line\">#</div><div class=\"line\"># 同样可以通过把一个命令重命名为空串来彻底kill掉这个命令，比如：</div><div class=\"line\">#</div><div class=\"line\"># rename-command CONFIG &quot;&quot;</div><div class=\"line\"></div><div class=\"line\">#################### 限制 ####################################</div><div class=\"line\"></div><div class=\"line\"># 设置最大连接数. 默认没有限制,  &apos;0&apos; 意味着不限制.</div><div class=\"line\">#</div><div class=\"line\"># maxclients 128</div><div class=\"line\"></div><div class=\"line\"></div><div class=\"line\">#最大可使用内存。如果超过，Redis会试图删除EXPIRE集合中的keys，具体做法是：Redis会试图释放即将过期的#keys，而保护还有很长生命周期的keys。</div><div class=\"line\">#</div><div class=\"line\">#如果这样还不行，Redis就会报错，但像GET之类的查询请求还是会得到响应。</div><div class=\"line\">#</div><div class=\"line\">#警告：如果你想把Redis视为一个真正的DB的话，那不要设置&lt;maxmemory&gt;,只有你只想把Redis作为cache或者</div><div class=\"line\">#有状态的server（&apos;state&apos; server)时才需要设置。</div><div class=\"line\">#</div><div class=\"line\"># maxmemory &lt;bytes&gt;</div><div class=\"line\"></div><div class=\"line\">#内存清理策略：如果达到了maxmemory，你可以采取如下动作：</div><div class=\"line\">#</div><div class=\"line\"># volatile-lru -&gt; 使用LRU算法来删除过期的set</div><div class=\"line\"># allkeys-lru -&gt; 删除任何遵循LRU算法的key</div><div class=\"line\"># volatile-random -&gt;随机地删除过期set中的key</div><div class=\"line\"># allkeys-&gt;random -&gt; 随机地删除一个key</div><div class=\"line\"># volatile-ttl -&gt; 删除最近即将过期的key（the nearest expire time (minor TTL)）</div><div class=\"line\"># noeviction -&gt; 根本不过期，写操作直接报错</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># 默认策略:</div><div class=\"line\">#</div><div class=\"line\"># maxmemory-policy volatile-lru</div><div class=\"line\"></div><div class=\"line\"># 对于处理redis内存来说，LRU和minor TTL算法不是精确的，而是近似的（估计的）算法。所以我们会检查某些样本#来达到内存检查的目的。默认的样本数是3，你可以修改它。</div><div class=\"line\">#</div><div class=\"line\"># maxmemory-samples 3</div><div class=\"line\"></div><div class=\"line\">################# APPEND ONLY MODE ###############################</div><div class=\"line\"></div><div class=\"line\">#默认情况下，Redis会异步的把数据保存到硬盘。如果你的应用场景允许因为系统崩溃等极端情况而导致最新数据丢失#的话，那这种做法已经很ok了。否则你应该打开‘append only’模式，开启这种模式后，Redis会在#appendonly.aof文件中添加每一个写操作，这个文件会在Redis启动时被读取来在内存中重新构建数据集。</div><div class=\"line\">#</div><div class=\"line\">#注意：如果你需要，你可以同时开启‘append only’模式和异步dumps模式（你需要注释掉上面的‘save’表达式来禁#止dumps），这种情况下，Redis重建数据集时会优先使用appendonly.aof而忽略dump.rdb</div><div class=\"line\">#</div><div class=\"line\">appendonly no</div><div class=\"line\"></div><div class=\"line\">#  append only 文件名 (默认: &quot;appendonly.aof&quot;)</div><div class=\"line\"># appendfilename appendonly.aof</div><div class=\"line\"></div><div class=\"line\"># 调用fsync()函数通知操作系统立刻向硬盘写数据</div><div class=\"line\">#</div><div class=\"line\"># Redis支持3中模式:</div><div class=\"line\">#</div><div class=\"line\"># no:不fsync, 只是通知OS可以flush数据了，具体是否flush取决于OS.性能更好.</div><div class=\"line\"># always: 每次写入append only 日志文件后都会fsync . 性能差，但很安全.</div><div class=\"line\"># everysec: 没间隔1秒进行一次fsync. 折中.</div><div class=\"line\">#</div><div class=\"line\"># 默认是 &quot;everysec&quot;</div><div class=\"line\"># appendfsync always</div><div class=\"line\">appendfsync everysec</div><div class=\"line\"># appendfsync no</div><div class=\"line\"></div><div class=\"line\"># 当AOF fsync策略被设置为always或者everysec并且后台保存进程（saving process)正在执行大量I/O操作时</div><div class=\"line\"># Redis可能会在fsync()调用上阻塞过长时间</div><div class=\"line\">#</div><div class=\"line\">no-appendfsync-on-rewrite no</div><div class=\"line\"></div><div class=\"line\"># append only 文件的自动重写</div><div class=\"line\"># 当AOF 日志文件即将增长到指定百分比时，Redis可以通过调用BGREWRITEAOF 来自动重写append only文件。</div><div class=\"line\">#</div><div class=\"line\"># 它是这么干的：Redis会记住最近一次重写后的AOF 文件size。然后它会把这个size与当前size进行比较，如果当前# size比指定的百分比大，就会触发重写。同样，你需要指定AOF文件被重写的最小size，这对避免虽然百分比达到了# 但是实际上文件size还是很小（这种情况没有必要重写）却导致AOF文件重写的情况很有用。</div><div class=\"line\">#</div><div class=\"line\">#</div><div class=\"line\"># auto-aof-rewrite-percentage 设置为 0 可以关闭AOF重写功能</div><div class=\"line\"></div><div class=\"line\">auto-aof-rewrite-percentage 100</div><div class=\"line\">auto-aof-rewrite-min-size 64mb</div><div class=\"line\"></div><div class=\"line\">################## SLOW LOG ###################################</div><div class=\"line\"></div><div class=\"line\"># Redis slow log用来记录超过指定执行时间的查询。</div><div class=\"line\">#</div><div class=\"line\"># 你可以指定两个参数：一个是慢查询的阀值，单位是毫秒；另外一个是slow log的长度，相当于一个队列。</div><div class=\"line\"></div><div class=\"line\"># 负数则关闭slow log，0则会导致每个命令都被记录</div><div class=\"line\">slowlog-log-slower-than 10000</div><div class=\"line\"></div><div class=\"line\"># 不设置会消耗过多内存，所以还是要设置一下。可以使用SLOWLOG RESET命令来回收slow log使用的内存</div><div class=\"line\">slowlog-max-len 1024</div><div class=\"line\"></div><div class=\"line\">################ 虚拟内存 ###############################</div><div class=\"line\">#使用redis 就别用虚拟内存了，绝对不是一个好主意，加个机器吧，所以这里不翻译啦！！</div><div class=\"line\"></div><div class=\"line\">### WARNING! Virtual Memory is deprecated in Redis 2.4</div><div class=\"line\">### The use of Virtual Memory is strongly discouraged.</div><div class=\"line\"></div><div class=\"line\"># Virtual Memory allows Redis to work with datasets bigger than the actual</div><div class=\"line\"># amount of RAM needed to hold the whole dataset in memory.</div><div class=\"line\"># In order to do so very used keys are taken in memory while the other keys</div><div class=\"line\"># are swapped into a swap file, similarly to what operating systems do</div><div class=\"line\"># with memory pages.</div><div class=\"line\">#</div><div class=\"line\"># To enable VM just set &apos;vm-enabled&apos; to yes, and set the following three</div><div class=\"line\"># VM parameters accordingly to your needs.</div><div class=\"line\"></div><div class=\"line\">vm-enabled no</div><div class=\"line\"># vm-enabled yes</div><div class=\"line\"></div><div class=\"line\"># This is the path of the Redis swap file. As you can guess, swap files</div><div class=\"line\"># can&apos;t be shared by different Redis instances, so make sure to use a swap</div><div class=\"line\"># file for every redis process you are running. Redis will complain if the</div><div class=\"line\"># swap file is already in use.</div><div class=\"line\">#</div><div class=\"line\"># The best kind of storage for the Redis swap file (that&apos;s accessed at random)</div><div class=\"line\"># is a Solid State Disk (SSD).</div><div class=\"line\">#</div><div class=\"line\"># *** WARNING *** if you are using a shared hosting the default of putting</div><div class=\"line\"># the swap file under /tmp is not secure. Create a dir with access granted</div><div class=\"line\"># only to Redis user and configure Redis to create the swap file there.</div><div class=\"line\">vm-swap-file /tmp/redis.swap</div><div class=\"line\"></div><div class=\"line\"># vm-max-memory configures the VM to use at max the specified amount of</div><div class=\"line\"># RAM. Everything that deos not fit will be swapped on disk *if* possible, that</div><div class=\"line\"># is, if there is still enough contiguous space in the swap file.</div><div class=\"line\">#</div><div class=\"line\"># With vm-max-memory 0 the system will swap everything it can. Not a good</div><div class=\"line\"># default, just specify the max amount of RAM you can in bytes, but it&apos;s</div><div class=\"line\"># better to leave some margin. For instance specify an amount of RAM</div><div class=\"line\"># that&apos;s more or less between 60 and 80% of your free RAM.</div><div class=\"line\">vm-max-memory 0</div><div class=\"line\"></div><div class=\"line\"># Redis swap files is split into pages. An object can be saved using multiple</div><div class=\"line\"># contiguous pages, but pages can&apos;t be shared between different objects.</div><div class=\"line\"># So if your page is too big, small objects swapped out on disk will waste</div><div class=\"line\"># a lot of space. If you page is too small, there is less space in the swap</div><div class=\"line\"># file (assuming you configured the same number of total swap file pages).</div><div class=\"line\">#</div><div class=\"line\"># If you use a lot of small objects, use a page size of 64 or 32 bytes.</div><div class=\"line\"># If you use a lot of big objects, use a bigger page size.</div><div class=\"line\"># If unsure, use the default :)</div><div class=\"line\">vm-page-size 32</div><div class=\"line\"></div><div class=\"line\"># Number of total memory pages in the swap file.</div><div class=\"line\"># Given that the page table (a bitmap of free/used pages) is taken in memory,</div><div class=\"line\"># every 8 pages on disk will consume 1 byte of RAM.</div><div class=\"line\">#</div><div class=\"line\"># The total swap size is vm-page-size * vm-pages</div><div class=\"line\">#</div><div class=\"line\"># With the default of 32-bytes memory pages and 134217728 pages Redis will</div><div class=\"line\"># use a 4 GB swap file, that will use 16 MB of RAM for the page table.</div><div class=\"line\">#</div><div class=\"line\"># It&apos;s better to use the smallest acceptable value for your application,</div><div class=\"line\"># but the default is large in order to work in most conditions.</div><div class=\"line\">vm-pages 134217728</div><div class=\"line\"></div><div class=\"line\"># Max number of VM I/O threads running at the same time.</div><div class=\"line\"># This threads are used to read/write data from/to swap file, since they</div><div class=\"line\"># also encode and decode objects from disk to memory or the reverse, a bigger</div><div class=\"line\"># number of threads can help with big objects even if they can&apos;t help with</div><div class=\"line\"># I/O itself as the physical device may not be able to couple with many</div><div class=\"line\"># reads/writes operations at the same time.</div><div class=\"line\">#</div><div class=\"line\"># The special value of 0 turn off threaded I/O and enables the blocking</div><div class=\"line\"># Virtual Memory implementation.</div><div class=\"line\">vm-max-threads 4</div><div class=\"line\"></div><div class=\"line\">################高级配置###############################</div><div class=\"line\"></div><div class=\"line\"># Hashes are encoded in a special way (much more memory efficient) when they</div><div class=\"line\"># have at max a given numer of elements, and the biggest element does not</div><div class=\"line\"># exceed a given threshold. You can configure this limits with the following</div><div class=\"line\"># configuration directives.</div><div class=\"line\">hash-max-zipmap-entries 512</div><div class=\"line\">hash-max-zipmap-value 64</div><div class=\"line\"></div><div class=\"line\"># Similarly to hashes, small lists are also encoded in a special way in order</div><div class=\"line\"># to save a lot of space. The special representation is only used when</div><div class=\"line\"># you are under the following limits:</div><div class=\"line\">list-max-ziplist-entries 512</div><div class=\"line\">list-max-ziplist-value 64</div><div class=\"line\"></div><div class=\"line\"># Sets have a special encoding in just one case: when a set is composed</div><div class=\"line\"># of just strings that happens to be integers in radix 10 in the range</div><div class=\"line\"># of 64 bit signed integers.</div><div class=\"line\"># The following configuration setting sets the limit in the size of the</div><div class=\"line\"># set in order to use this special memory saving encoding.</div><div class=\"line\">set-max-intset-entries 512</div><div class=\"line\"></div><div class=\"line\"># Similarly to hashes and lists, sorted sets are also specially encoded in</div><div class=\"line\"># order to save a lot of space. This encoding is only used when the length and</div><div class=\"line\"># elements of a sorted set are below the following limits:</div><div class=\"line\">zset-max-ziplist-entries 128</div><div class=\"line\">zset-max-ziplist-value 64</div><div class=\"line\"></div><div class=\"line\"># Active rehashing uses 1 millisecond every 100 milliseconds of CPU time in</div><div class=\"line\"># order to help rehashing the main Redis hash table (the one mapping top-level</div><div class=\"line\"># keys to values). The hash table implementation redis uses (see dict.c)</div><div class=\"line\"># performs a lazy rehashing: the more operation you run into an hash table</div><div class=\"line\"># that is rhashing, the more rehashing &quot;steps&quot; are performed, so if the</div><div class=\"line\"># server is idle the rehashing is never complete and some more memory is used</div><div class=\"line\"># by the hash table.</div><div class=\"line\">#</div><div class=\"line\"># The default is to use this millisecond 10 times every second in order to</div><div class=\"line\"># active rehashing the main dictionaries, freeing memory when possible.</div><div class=\"line\">#</div><div class=\"line\"># If unsure:</div><div class=\"line\"># use &quot;activerehashing no&quot; if you have hard latency requirements and it is</div><div class=\"line\"># not a good thing in your environment that Redis can reply form time to time</div><div class=\"line\"># to queries with 2 milliseconds delay.</div><div class=\"line\">#</div><div class=\"line\"># use &quot;activerehashing yes&quot; if you don&apos;t have such hard requirements but</div><div class=\"line\"># want to free memory asap when possible.</div><div class=\"line\">activerehashing yes</div><div class=\"line\"></div><div class=\"line\">################## INCLUDES ###################################</div><div class=\"line\"></div><div class=\"line\"># Include one or more other config files here.  This is useful if you</div><div class=\"line\"># have a standard template that goes to all redis server but also need</div><div class=\"line\"># to customize a few per-server settings.  Include files can include</div><div class=\"line\"># other files, so use this wisely.</div><div class=\"line\">#</div><div class=\"line\"># include /path/to/local.conf</div><div class=\"line\"># include /path/to/other.conf</div></pre></td></tr></table></figure>\n<h2 id=\"Redis常用命令\"><a href=\"#Redis常用命令\" class=\"headerlink\" title=\"Redis常用命令\"></a>Redis常用命令</h2><h3 id=\"键值相关命令\"><a href=\"#键值相关命令\" class=\"headerlink\" title=\"键值相关命令\"></a>键值相关命令</h3><p>1、 keys  键名</p>\n<blockquote>\n<p>按照键名查找指定的键。支持通配符</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set hello 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; set hallo 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; set heeeello 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys h?llo</div><div class=\"line\">1) &quot;hallo&quot;</div><div class=\"line\">2) &quot;hello&quot;</div><div class=\"line\">127.0.0.1:6379&gt; keys h*llo</div><div class=\"line\">1) &quot;hallo&quot;</div><div class=\"line\">2) &quot;heeeello&quot;</div><div class=\"line\">3) &quot;hello&quot;</div></pre></td></tr></table></figure>\n<p>2、    exists  键名</p>\n<blockquote>\n<p>   确认一个键是否存在</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; EXISTS name</div><div class=\"line\">(integer) 1\t\t\t\t\t\t//name键存在</div><div class=\"line\">127.0.0.1:6379&gt; EXISTS age</div><div class=\"line\">(integer) 0\t\t\t\t\t\t//age键不存在</div></pre></td></tr></table></figure>\n<p>3、    del  键名</p>\n<blockquote>\n<p>   删除一个键</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; del hello</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; EXISTS hello</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<p>4、    expire  键  秒</p>\n<blockquote>\n<p>   设置一个键的过期时间，如果键已经过期，将会被自动删除</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set age 18</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; EXPIRE age 20</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; ttl age</div><div class=\"line\">(integer) 18</div><div class=\"line\">127.0.0.1:6379&gt; ttl age</div><div class=\"line\">(integer) -2</div><div class=\"line\">127.0.0.1:6379&gt; EXISTS age</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<p>5、    ttl  键</p>\n<blockquote>\n<p>   以秒为单位，返回键的剩余生存时间。</p>\n<p>   当键不存在时，返回值为-2</p>\n<p>   当键存在，但没有设置剩余生存时间时，返回-1</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; ttl name</div><div class=\"line\">(integer) -1</div></pre></td></tr></table></figure>\n<p>6、    select  数据库号</p>\n<blockquote>\n<p>   选择一个数据库。<br>   默认连接的数据库是0，可以支持共16个数据库。<br>   在配置文件中，通过databases 16 关键字定义</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; select 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379[1]&gt;</div></pre></td></tr></table></figure>\n<p>7、    move  键  数据库号</p>\n<blockquote>\n<p>   将当前数据库的键移动到指定的数据空中</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set age 18</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; move age 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">(nil)</div><div class=\"line\">127.0.0.1:6379&gt; select 1</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379[1]&gt; get age</div><div class=\"line\">&quot;18&quot;</div></pre></td></tr></table></figure>\n<p>8、    randomkey  </p>\n<blockquote>\n<p>   从当前数据库返回一个随机的键。如果当前库没有任何键，则返回nil</p>\n</blockquote>\n<p>9、    rename  旧名  新名</p>\n<blockquote>\n<p>   重命名键</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; rename name name_new</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; get name_new</div><div class=\"line\">&quot;sc&quot;</div></pre></td></tr></table></figure>\n<p>10、 type  键</p>\n<blockquote>\n<pre><code>返回键类型。\n</code></pre></blockquote>\n<p>返回值</p>\n<ul>\n<li>none (key不存在)</li>\n<li>string (字符串)</li>\n<li>list (列表)</li>\n<li>set (集合)</li>\n<li>zset (有序集)</li>\n<li>hash (哈希表)</li>\n</ul>\n<h3 id=\"服务器相关命令\"><a href=\"#服务器相关命令\" class=\"headerlink\" title=\"服务器相关命令\"></a>服务器相关命令</h3><p>1、    ping</p>\n<blockquote>\n<p>   测试服务器是否可以连接</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; ping</div><div class=\"line\">PONG\t\t\t\t\t//连接正常</div><div class=\"line\">127.0.0.1:6379&gt; ping</div><div class=\"line\">Could not connect to Redis at 127.0.0.1:6379: Connection refused</div><div class=\"line\">//redis被停止，连接拒绝</div></pre></td></tr></table></figure>\n<p>2、    echo  字符串</p>\n<blockquote>\n<p>   在命令行输出字符串</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; echo &quot;test message&quot;</div><div class=\"line\">&quot;test message&quot;</div></pre></td></tr></table></figure>\n<p>3、    quit</p>\n<blockquote>\n<p>   退出redis数据库</p>\n</blockquote>\n<p>4、    save</p>\n<blockquote>\n<p>   保存所有的数据。很少在生产环境直接使用SAVE 命令，因为它会阻塞所有的客户端的请求，可以使用BGSAVE 命令代替. 如果在BGSAVE命令的保存数据的子进程发生错误的时,用 SAVE命令保存最新的数据是最后的手段</p>\n</blockquote>\n<p>5、    dbsize</p>\n<blockquote>\n<p>   返回当前库中键的数量</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; dbsize</div><div class=\"line\">(integer) 6</div></pre></td></tr></table></figure>\n<p>6、    info</p>\n<blockquote>\n<p>   获取服务器的详细信息</p>\n</blockquote>\n<p>7、    config get 参数</p>\n<blockquote>\n<p>   获取redis服务器配置文件中的参数。支持通配符</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; config get *\t\t\t//查询配置文件中所有的参数</div><div class=\"line\">  1) &quot;dbfilename&quot;</div><div class=\"line\">  2) &quot;dump.rdb&quot;</div><div class=\"line\"> 45) &quot;port&quot;</div><div class=\"line\"> 46) &quot;6379&quot;</div><div class=\"line\"> 99) &quot;save&quot;</div><div class=\"line\"> 100) &quot;900 1 300 10 60 10000&quot;</div></pre></td></tr></table></figure>\n<p>8、 flushdb</p>\n<blockquote>\n<p>   删除当前数据库中所有的数据</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; dbsize</div><div class=\"line\">(integer) 6</div><div class=\"line\">127.0.0.1:6379&gt; flushdb</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; dbsize</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<p>9、    flushall</p>\n<blockquote>\n<pre><code>删除所有数据库中所有的数据\n</code></pre></blockquote>"},{"title":"Redis高级应用","date":"2016-09-27T12:30:00.000Z","_content":"\n- 给redis服务器设置密码\n- 持久化\n- 主从备份\n\n<!-- more -->\n\n##\t给redis服务器设置密码\n\n1、 修改redis服务器的配置文件\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\n# requirepass foobared\t\t\t\t\t（340行）\n#找到这句话，requirepass后面就是登录redis的密码，改为\nrequirepass flzx_3QC\n```\n2、 重启redis\n```\n[root@localhost redis]# pkill  redis\n[root@localhost redis]# bin/redis-server  /usr/local/redis/etc/redis.conf\n```\n3、 连接redis\n```\n[root@localhost redis]# /usr/local/redis/bin/redis-cli\n127.0.0.1:6379> keys *\t\t\t\t\t\t//可以正常连接redis\n(error) NOAUTH Authentication required.\t\t//但因为没有密码，提示操作拒绝\n127.0.0.1:6379> auth flzx_3QC\t\t\t\t//利用auth命令输入密码\nOK\n127.0.0.1:6379> keys *\t\t\t\t\t\t//才可以正常使用\n1) \"name\"\n```\n或\n```\n[root@localhost redis]# /usr/local/redis/bin/redis-cli -a flzx_3QC\n```\n在登录的同时指定密码\n\n**注意历史命令中会明文保存此密码**\n```\n127.0.0.1:6379> keys *\n1) \"name\"\n```\n\n## 持久化\n\nRedis 提供了不同级别的持久化方式:\n### RDB持久化方式\n> RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储。是默认的持久化方式。这种方式是将内存中数据以快照的方式写入到二进制文件中，默认的文件名为dump.rdb。这种持久化方式被称为快照 snapshotting（快照）。\n\n```\nsave 900 1\t\t\n#900秒内，最少有1个键被改动。则自动保存一次数据集\nsave 300 10\n#300秒内，最少有10个键被改动。则自动保存一次数据集\nsave 60 10000\n#60秒内，最少有10000个键被改动。则自动保存一次数据集\n```\n实验：验证dump.rdb数据保存文件\n```\n[root@localhost ~]# ls\nanaconda-ks.cfg  dump.rdb  install.log  install.log.syslog\n```\nroot目录下有dump.rdb文件\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-server  \\\n/usr/local/redis/etc/redis.conf\n```\n在root目录中启动redis\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-cli\n127.0.0.1:6379> auth 123\nOK\n127.0.0.1:6379> keys *\n1) \"name2\"\n2) \"name\"\n3) \"name1\"\n```\n0库中有键\n```\n[root@localhost ~]# cd /usr/local/redis/\n[root@localhost redis]# pkill -9 redis\n[root@localhost redis]# /usr/local/redis/bin/redis-server  \\\n/usr/local/redis/etc/redis.conf\n```\n在/usr/local/redis/库中重启redis，\n```\n[root@localhost redis]# ls\n[root@localhost redis]# /usr/local/redis/bin/redis-cli\n127.0.0.1:6379> keys *\n(empty list or set)\n```\n0库中没有键\n```\n127.0.0.1:6379> save\nOK\n```\n保存\n```\n127.0.0.1:6379> quit\n[root@localhost redis]# ls\nbin  dump.rdb  etc\n```\n在redis目录中也生成dump.rdb文件\n\n**结论：**\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\ndir ./\n```\n定义了dump.rdb数据库文件保存在当前位置。所以每次重启redis服务的所在位置不同，导致生成新的dump.rdb文件\n```\ndir /usr/local/redis/\n```\n将数据库保存目录写为绝对路径（注意只能是目录）\n\n###  使用AOF\n> 使用AOF会让你的Redis更加耐久: 你可以使用不同的持久化策略：无备份,每秒备份,每次写的时候备份。使用默认的每秒备份策略,Redis的性能依然很好(备份是由后台线程进行处理的,主线程会尽力处理客户端请求),一旦出现故障，你最多丢失1秒的数据。\n\n```\nappendonly no\n#默认不使用AOF持久化（450行）\n\nappendonly yes\n#开启AOF持久化\n# appendfsync always\t\t#有写操作，就马上写入磁盘。效率最慢，到那时最按\nappendfsync everysec\t\t#默认，每秒钟写入磁盘一次。\n# appendfsync no\t\t\t#不进行AOF备份，将数据交给操作系统处理。最快，最不安全\n```\n\n\n## 主从备份\nRedis主从复制特点：\n- a.Master可以拥有多个slave\n- b.多个slave可以连接同一个master外，还可以连接到其它slave\n- c.主从复制不会阻塞master，在同步数据时，master可以继续处理client请求\n- d.提高系统的伸缩性\n\n\nRedis主从复制过程：\n- a.Slave与master建立连接，发送sync同步命令\n- b.Master会启动一个后台进程，将数据库快照保存到文件中，同时master主进程会开始收集新的写命令并缓存。\n- c.后台完成保存后，就将此文件发送给slave\n- d.Slave将此文件保存到硬盘上\n\n###\t不同服务器配置主从\n\n1. 克隆一台linux作为从服务器\n克隆机需要进行如下操作：\n\n```\n\t\t\t①\tvi /etc/sysconfig/network-scripts/ifcfg-eth0\n\t\t\t\t删除MAC地址行\n\t\t\t②\trm  -rf  /etc/udev/rules.d/70-persistent-net.rules\n\t\t\t\t删除网卡和MAC地址绑定文件\n\t\t\t③\t注意关闭防火墙和SELinux\n\t\t\t④\t重启动系统\n```\n\n2. 在从服务器上配置\n\n```\n[root@localhost ~]# vi /usr/local/redis/etc/redis.conf\n# slaveof <masterip> <masterport>\n#把此句开启，并指定主服务器ip和端口\t（196行）\n\nmasterauth flzx_3QC\n#设定主服务器密码\n```\n\n3. 重启从服务器上redis\n\n### 同一台服务器实现主从配置\n\n这里我们以本机配置 1台Master + 1台Slave 为例子,其中:\n> - Master IP:127.0.0.1  PORT:6379\n> - Slave1 IP:127.0.0.1  PORT:63791\n\n\n1.  复制出从服务器目录\n\n```\n[root@localhost ~]# cp -r /usr/local/redis/ /usr/local/redis-slave1\n```\n\n2.  修改redis-slave1配置文件\n\n\n```\n[root@localhost ~]# vi /usr/local/redis-slave1/etc/redis.conf\npidfile /usr/local/redis-slave1/redis.pid\n#指定pid文件\nport 63791\n#指定端口号\ndir /usr/local/redis-slave1/\n#指定服务器目录\nslaveof 127.0.0.1 6379\n#指定主服务器IP和端口\nmasterauth flzx_3QC\n#指定主服务器密码\n```\n\n3. 启动服务\n\n\n```\n/usr/local/redis-slave1/bin/redis-server /usr/local/redis-slave1/etc/redis.conf\n#启动从服务器，并调用从服务器配置文件\n\n[root@localhost ~]# netstat -tlun\ntcp     0      0 :::6379                     :::*                        LISTEN      \ntcp     0      0 :::63791                    :::*                        LISTEN\n#验证两个端口是否都启动\n```\n\n4. 验证\n\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-cli -a flzx_3QC   \n#启动主服务器，并建立一个键\n127.0.0.1:6379> set bb 234\nOK\n127.0.0.1:6379> keys *\n1) \"sex\"\n2) \"aa\"\n3) \"name\"\n4) \"age\"\n5) \"bb\"\n\n[root@localhost ~]# /usr/local/redis-slave1/bin/redis-cli -a flzx_3QC -p 63791\n#启动从服务器，发现键已经同步\n127.0.0.1:63791> keys *\n1) \"aa\"\n2) \"sex\"\n3) \"age\"\n4) \"name\"\n5) \"bb\"\n```\n","source":"_posts/Redis高级应用.md","raw":"---\ntitle: Redis高级应用\ndate: 2016-09-27 20:30:00\ntags:\n- Redis\ncategories:\n- Linux\n---\n\n- 给redis服务器设置密码\n- 持久化\n- 主从备份\n\n<!-- more -->\n\n##\t给redis服务器设置密码\n\n1、 修改redis服务器的配置文件\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\n# requirepass foobared\t\t\t\t\t（340行）\n#找到这句话，requirepass后面就是登录redis的密码，改为\nrequirepass flzx_3QC\n```\n2、 重启redis\n```\n[root@localhost redis]# pkill  redis\n[root@localhost redis]# bin/redis-server  /usr/local/redis/etc/redis.conf\n```\n3、 连接redis\n```\n[root@localhost redis]# /usr/local/redis/bin/redis-cli\n127.0.0.1:6379> keys *\t\t\t\t\t\t//可以正常连接redis\n(error) NOAUTH Authentication required.\t\t//但因为没有密码，提示操作拒绝\n127.0.0.1:6379> auth flzx_3QC\t\t\t\t//利用auth命令输入密码\nOK\n127.0.0.1:6379> keys *\t\t\t\t\t\t//才可以正常使用\n1) \"name\"\n```\n或\n```\n[root@localhost redis]# /usr/local/redis/bin/redis-cli -a flzx_3QC\n```\n在登录的同时指定密码\n\n**注意历史命令中会明文保存此密码**\n```\n127.0.0.1:6379> keys *\n1) \"name\"\n```\n\n## 持久化\n\nRedis 提供了不同级别的持久化方式:\n### RDB持久化方式\n> RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储。是默认的持久化方式。这种方式是将内存中数据以快照的方式写入到二进制文件中，默认的文件名为dump.rdb。这种持久化方式被称为快照 snapshotting（快照）。\n\n```\nsave 900 1\t\t\n#900秒内，最少有1个键被改动。则自动保存一次数据集\nsave 300 10\n#300秒内，最少有10个键被改动。则自动保存一次数据集\nsave 60 10000\n#60秒内，最少有10000个键被改动。则自动保存一次数据集\n```\n实验：验证dump.rdb数据保存文件\n```\n[root@localhost ~]# ls\nanaconda-ks.cfg  dump.rdb  install.log  install.log.syslog\n```\nroot目录下有dump.rdb文件\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-server  \\\n/usr/local/redis/etc/redis.conf\n```\n在root目录中启动redis\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-cli\n127.0.0.1:6379> auth 123\nOK\n127.0.0.1:6379> keys *\n1) \"name2\"\n2) \"name\"\n3) \"name1\"\n```\n0库中有键\n```\n[root@localhost ~]# cd /usr/local/redis/\n[root@localhost redis]# pkill -9 redis\n[root@localhost redis]# /usr/local/redis/bin/redis-server  \\\n/usr/local/redis/etc/redis.conf\n```\n在/usr/local/redis/库中重启redis，\n```\n[root@localhost redis]# ls\n[root@localhost redis]# /usr/local/redis/bin/redis-cli\n127.0.0.1:6379> keys *\n(empty list or set)\n```\n0库中没有键\n```\n127.0.0.1:6379> save\nOK\n```\n保存\n```\n127.0.0.1:6379> quit\n[root@localhost redis]# ls\nbin  dump.rdb  etc\n```\n在redis目录中也生成dump.rdb文件\n\n**结论：**\n```\n[root@localhost redis]# vi /usr/local/redis/etc/redis.conf\ndir ./\n```\n定义了dump.rdb数据库文件保存在当前位置。所以每次重启redis服务的所在位置不同，导致生成新的dump.rdb文件\n```\ndir /usr/local/redis/\n```\n将数据库保存目录写为绝对路径（注意只能是目录）\n\n###  使用AOF\n> 使用AOF会让你的Redis更加耐久: 你可以使用不同的持久化策略：无备份,每秒备份,每次写的时候备份。使用默认的每秒备份策略,Redis的性能依然很好(备份是由后台线程进行处理的,主线程会尽力处理客户端请求),一旦出现故障，你最多丢失1秒的数据。\n\n```\nappendonly no\n#默认不使用AOF持久化（450行）\n\nappendonly yes\n#开启AOF持久化\n# appendfsync always\t\t#有写操作，就马上写入磁盘。效率最慢，到那时最按\nappendfsync everysec\t\t#默认，每秒钟写入磁盘一次。\n# appendfsync no\t\t\t#不进行AOF备份，将数据交给操作系统处理。最快，最不安全\n```\n\n\n## 主从备份\nRedis主从复制特点：\n- a.Master可以拥有多个slave\n- b.多个slave可以连接同一个master外，还可以连接到其它slave\n- c.主从复制不会阻塞master，在同步数据时，master可以继续处理client请求\n- d.提高系统的伸缩性\n\n\nRedis主从复制过程：\n- a.Slave与master建立连接，发送sync同步命令\n- b.Master会启动一个后台进程，将数据库快照保存到文件中，同时master主进程会开始收集新的写命令并缓存。\n- c.后台完成保存后，就将此文件发送给slave\n- d.Slave将此文件保存到硬盘上\n\n###\t不同服务器配置主从\n\n1. 克隆一台linux作为从服务器\n克隆机需要进行如下操作：\n\n```\n\t\t\t①\tvi /etc/sysconfig/network-scripts/ifcfg-eth0\n\t\t\t\t删除MAC地址行\n\t\t\t②\trm  -rf  /etc/udev/rules.d/70-persistent-net.rules\n\t\t\t\t删除网卡和MAC地址绑定文件\n\t\t\t③\t注意关闭防火墙和SELinux\n\t\t\t④\t重启动系统\n```\n\n2. 在从服务器上配置\n\n```\n[root@localhost ~]# vi /usr/local/redis/etc/redis.conf\n# slaveof <masterip> <masterport>\n#把此句开启，并指定主服务器ip和端口\t（196行）\n\nmasterauth flzx_3QC\n#设定主服务器密码\n```\n\n3. 重启从服务器上redis\n\n### 同一台服务器实现主从配置\n\n这里我们以本机配置 1台Master + 1台Slave 为例子,其中:\n> - Master IP:127.0.0.1  PORT:6379\n> - Slave1 IP:127.0.0.1  PORT:63791\n\n\n1.  复制出从服务器目录\n\n```\n[root@localhost ~]# cp -r /usr/local/redis/ /usr/local/redis-slave1\n```\n\n2.  修改redis-slave1配置文件\n\n\n```\n[root@localhost ~]# vi /usr/local/redis-slave1/etc/redis.conf\npidfile /usr/local/redis-slave1/redis.pid\n#指定pid文件\nport 63791\n#指定端口号\ndir /usr/local/redis-slave1/\n#指定服务器目录\nslaveof 127.0.0.1 6379\n#指定主服务器IP和端口\nmasterauth flzx_3QC\n#指定主服务器密码\n```\n\n3. 启动服务\n\n\n```\n/usr/local/redis-slave1/bin/redis-server /usr/local/redis-slave1/etc/redis.conf\n#启动从服务器，并调用从服务器配置文件\n\n[root@localhost ~]# netstat -tlun\ntcp     0      0 :::6379                     :::*                        LISTEN      \ntcp     0      0 :::63791                    :::*                        LISTEN\n#验证两个端口是否都启动\n```\n\n4. 验证\n\n```\n[root@localhost ~]# /usr/local/redis/bin/redis-cli -a flzx_3QC   \n#启动主服务器，并建立一个键\n127.0.0.1:6379> set bb 234\nOK\n127.0.0.1:6379> keys *\n1) \"sex\"\n2) \"aa\"\n3) \"name\"\n4) \"age\"\n5) \"bb\"\n\n[root@localhost ~]# /usr/local/redis-slave1/bin/redis-cli -a flzx_3QC -p 63791\n#启动从服务器，发现键已经同步\n127.0.0.1:63791> keys *\n1) \"aa\"\n2) \"sex\"\n3) \"age\"\n4) \"name\"\n5) \"bb\"\n```\n","slug":"Redis高级应用","published":1,"updated":"2016-10-07T14:00:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwx5003m699fogqq4bc0","content":"<ul>\n<li>给redis服务器设置密码</li>\n<li>持久化</li>\n<li>主从备份</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"给redis服务器设置密码\"><a href=\"#给redis服务器设置密码\" class=\"headerlink\" title=\"给redis服务器设置密码\"></a>给redis服务器设置密码</h2><p>1、 修改redis服务器的配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\"># requirepass foobared\t\t\t\t\t（340行）</div><div class=\"line\">#找到这句话，requirepass后面就是登录redis的密码，改为</div><div class=\"line\">requirepass flzx_3QC</div></pre></td></tr></table></figure></p>\n<p>2、 重启redis<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# pkill  redis</div><div class=\"line\">[root@localhost redis]# bin/redis-server  /usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>3、 连接redis<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">127.0.0.1:6379&gt; keys *\t\t\t\t\t\t//可以正常连接redis</div><div class=\"line\">(error) NOAUTH Authentication required.\t\t//但因为没有密码，提示操作拒绝</div><div class=\"line\">127.0.0.1:6379&gt; auth flzx_3QC\t\t\t\t//利用auth命令输入密码</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys *\t\t\t\t\t\t//才可以正常使用</div><div class=\"line\">1) &quot;name&quot;</div></pre></td></tr></table></figure></p>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli -a flzx_3QC</div></pre></td></tr></table></figure></p>\n<p>在登录的同时指定密码</p>\n<p><strong>注意历史命令中会明文保存此密码</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">1) &quot;name&quot;</div></pre></td></tr></table></figure></p>\n<h2 id=\"持久化\"><a href=\"#持久化\" class=\"headerlink\" title=\"持久化\"></a>持久化</h2><p>Redis 提供了不同级别的持久化方式:</p>\n<h3 id=\"RDB持久化方式\"><a href=\"#RDB持久化方式\" class=\"headerlink\" title=\"RDB持久化方式\"></a>RDB持久化方式</h3><blockquote>\n<p>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储。是默认的持久化方式。这种方式是将内存中数据以快照的方式写入到二进制文件中，默认的文件名为dump.rdb。这种持久化方式被称为快照 snapshotting（快照）。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">save 900 1\t\t</div><div class=\"line\">#900秒内，最少有1个键被改动。则自动保存一次数据集</div><div class=\"line\">save 300 10</div><div class=\"line\">#300秒内，最少有10个键被改动。则自动保存一次数据集</div><div class=\"line\">save 60 10000</div><div class=\"line\">#60秒内，最少有10000个键被改动。则自动保存一次数据集</div></pre></td></tr></table></figure>\n<p>实验：验证dump.rdb数据保存文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# ls</div><div class=\"line\">anaconda-ks.cfg  dump.rdb  install.log  install.log.syslog</div></pre></td></tr></table></figure></p>\n<p>root目录下有dump.rdb文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-server  \\</div><div class=\"line\">/usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>在root目录中启动redis<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">127.0.0.1:6379&gt; auth 123</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">1) &quot;name2&quot;</div><div class=\"line\">2) &quot;name&quot;</div><div class=\"line\">3) &quot;name1&quot;</div></pre></td></tr></table></figure></p>\n<p>0库中有键<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# cd /usr/local/redis/</div><div class=\"line\">[root@localhost redis]# pkill -9 redis</div><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-server  \\</div><div class=\"line\">/usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>在/usr/local/redis/库中重启redis，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# ls</div><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">(empty list or set)</div></pre></td></tr></table></figure></p>\n<p>0库中没有键<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; save</div><div class=\"line\">OK</div></pre></td></tr></table></figure></p>\n<p>保存<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; quit</div><div class=\"line\">[root@localhost redis]# ls</div><div class=\"line\">bin  dump.rdb  etc</div></pre></td></tr></table></figure></p>\n<p>在redis目录中也生成dump.rdb文件</p>\n<p><strong>结论：</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\">dir ./</div></pre></td></tr></table></figure></p>\n<p>定义了dump.rdb数据库文件保存在当前位置。所以每次重启redis服务的所在位置不同，导致生成新的dump.rdb文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dir /usr/local/redis/</div></pre></td></tr></table></figure></p>\n<p>将数据库保存目录写为绝对路径（注意只能是目录）</p>\n<h3 id=\"使用AOF\"><a href=\"#使用AOF\" class=\"headerlink\" title=\"使用AOF\"></a>使用AOF</h3><blockquote>\n<p>使用AOF会让你的Redis更加耐久: 你可以使用不同的持久化策略：无备份,每秒备份,每次写的时候备份。使用默认的每秒备份策略,Redis的性能依然很好(备份是由后台线程进行处理的,主线程会尽力处理客户端请求),一旦出现故障，你最多丢失1秒的数据。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">appendonly no</div><div class=\"line\">#默认不使用AOF持久化（450行）</div><div class=\"line\"></div><div class=\"line\">appendonly yes</div><div class=\"line\">#开启AOF持久化</div><div class=\"line\"># appendfsync always\t\t#有写操作，就马上写入磁盘。效率最慢，到那时最按</div><div class=\"line\">appendfsync everysec\t\t#默认，每秒钟写入磁盘一次。</div><div class=\"line\"># appendfsync no\t\t\t#不进行AOF备份，将数据交给操作系统处理。最快，最不安全</div></pre></td></tr></table></figure>\n<h2 id=\"主从备份\"><a href=\"#主从备份\" class=\"headerlink\" title=\"主从备份\"></a>主从备份</h2><p>Redis主从复制特点：</p>\n<ul>\n<li>a.Master可以拥有多个slave</li>\n<li>b.多个slave可以连接同一个master外，还可以连接到其它slave</li>\n<li>c.主从复制不会阻塞master，在同步数据时，master可以继续处理client请求</li>\n<li>d.提高系统的伸缩性</li>\n</ul>\n<p>Redis主从复制过程：</p>\n<ul>\n<li>a.Slave与master建立连接，发送sync同步命令</li>\n<li>b.Master会启动一个后台进程，将数据库快照保存到文件中，同时master主进程会开始收集新的写命令并缓存。</li>\n<li>c.后台完成保存后，就将此文件发送给slave</li>\n<li>d.Slave将此文件保存到硬盘上</li>\n</ul>\n<h3 id=\"不同服务器配置主从\"><a href=\"#不同服务器配置主从\" class=\"headerlink\" title=\"不同服务器配置主从\"></a>不同服务器配置主从</h3><ol>\n<li>克隆一台linux作为从服务器<br>克隆机需要进行如下操作：</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">①\tvi /etc/sysconfig/network-scripts/ifcfg-eth0</div><div class=\"line\">\t删除MAC地址行</div><div class=\"line\">②\trm  -rf  /etc/udev/rules.d/70-persistent-net.rules</div><div class=\"line\">\t删除网卡和MAC地址绑定文件</div><div class=\"line\">③\t注意关闭防火墙和SELinux</div><div class=\"line\">④\t重启动系统</div></pre></td></tr></table></figure>\n<ol>\n<li>在从服务器上配置</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\"># slaveof &lt;masterip&gt; &lt;masterport&gt;</div><div class=\"line\">#把此句开启，并指定主服务器ip和端口\t（196行）</div><div class=\"line\"></div><div class=\"line\">masterauth flzx_3QC</div><div class=\"line\">#设定主服务器密码</div></pre></td></tr></table></figure>\n<ol>\n<li>重启从服务器上redis</li>\n</ol>\n<h3 id=\"同一台服务器实现主从配置\"><a href=\"#同一台服务器实现主从配置\" class=\"headerlink\" title=\"同一台服务器实现主从配置\"></a>同一台服务器实现主从配置</h3><p>这里我们以本机配置 1台Master + 1台Slave 为例子,其中:</p>\n<blockquote>\n<ul>\n<li>Master IP:127.0.0.1  PORT:6379</li>\n<li>Slave1 IP:127.0.0.1  PORT:63791</li>\n</ul>\n</blockquote>\n<ol>\n<li>复制出从服务器目录</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# cp -r /usr/local/redis/ /usr/local/redis-slave1</div></pre></td></tr></table></figure>\n<ol>\n<li>修改redis-slave1配置文件</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# vi /usr/local/redis-slave1/etc/redis.conf</div><div class=\"line\">pidfile /usr/local/redis-slave1/redis.pid</div><div class=\"line\">#指定pid文件</div><div class=\"line\">port 63791</div><div class=\"line\">#指定端口号</div><div class=\"line\">dir /usr/local/redis-slave1/</div><div class=\"line\">#指定服务器目录</div><div class=\"line\">slaveof 127.0.0.1 6379</div><div class=\"line\">#指定主服务器IP和端口</div><div class=\"line\">masterauth flzx_3QC</div><div class=\"line\">#指定主服务器密码</div></pre></td></tr></table></figure>\n<ol>\n<li>启动服务</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/redis-slave1/bin/redis-server /usr/local/redis-slave1/etc/redis.conf</div><div class=\"line\">#启动从服务器，并调用从服务器配置文件</div><div class=\"line\"></div><div class=\"line\">[root@localhost ~]# netstat -tlun</div><div class=\"line\">tcp     0      0 :::6379                     :::*                        LISTEN      </div><div class=\"line\">tcp     0      0 :::63791                    :::*                        LISTEN</div><div class=\"line\">#验证两个端口是否都启动</div></pre></td></tr></table></figure>\n<ol>\n<li>验证</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-cli -a flzx_3QC   </div><div class=\"line\">#启动主服务器，并建立一个键</div><div class=\"line\">127.0.0.1:6379&gt; set bb 234</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">1) &quot;sex&quot;</div><div class=\"line\">2) &quot;aa&quot;</div><div class=\"line\">3) &quot;name&quot;</div><div class=\"line\">4) &quot;age&quot;</div><div class=\"line\">5) &quot;bb&quot;</div><div class=\"line\"></div><div class=\"line\">[root@localhost ~]# /usr/local/redis-slave1/bin/redis-cli -a flzx_3QC -p 63791</div><div class=\"line\">#启动从服务器，发现键已经同步</div><div class=\"line\">127.0.0.1:63791&gt; keys *</div><div class=\"line\">1) &quot;aa&quot;</div><div class=\"line\">2) &quot;sex&quot;</div><div class=\"line\">3) &quot;age&quot;</div><div class=\"line\">4) &quot;name&quot;</div><div class=\"line\">5) &quot;bb&quot;</div></pre></td></tr></table></figure>\n","excerpt":"<ul>\n<li>给redis服务器设置密码</li>\n<li>持久化</li>\n<li>主从备份</li>\n</ul>","more":"<h2 id=\"给redis服务器设置密码\"><a href=\"#给redis服务器设置密码\" class=\"headerlink\" title=\"给redis服务器设置密码\"></a>给redis服务器设置密码</h2><p>1、 修改redis服务器的配置文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\"># requirepass foobared\t\t\t\t\t（340行）</div><div class=\"line\">#找到这句话，requirepass后面就是登录redis的密码，改为</div><div class=\"line\">requirepass flzx_3QC</div></pre></td></tr></table></figure></p>\n<p>2、 重启redis<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# pkill  redis</div><div class=\"line\">[root@localhost redis]# bin/redis-server  /usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>3、 连接redis<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">127.0.0.1:6379&gt; keys *\t\t\t\t\t\t//可以正常连接redis</div><div class=\"line\">(error) NOAUTH Authentication required.\t\t//但因为没有密码，提示操作拒绝</div><div class=\"line\">127.0.0.1:6379&gt; auth flzx_3QC\t\t\t\t//利用auth命令输入密码</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys *\t\t\t\t\t\t//才可以正常使用</div><div class=\"line\">1) &quot;name&quot;</div></pre></td></tr></table></figure></p>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli -a flzx_3QC</div></pre></td></tr></table></figure></p>\n<p>在登录的同时指定密码</p>\n<p><strong>注意历史命令中会明文保存此密码</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">1) &quot;name&quot;</div></pre></td></tr></table></figure></p>\n<h2 id=\"持久化\"><a href=\"#持久化\" class=\"headerlink\" title=\"持久化\"></a>持久化</h2><p>Redis 提供了不同级别的持久化方式:</p>\n<h3 id=\"RDB持久化方式\"><a href=\"#RDB持久化方式\" class=\"headerlink\" title=\"RDB持久化方式\"></a>RDB持久化方式</h3><blockquote>\n<p>RDB持久化方式能够在指定的时间间隔能对你的数据进行快照存储。是默认的持久化方式。这种方式是将内存中数据以快照的方式写入到二进制文件中，默认的文件名为dump.rdb。这种持久化方式被称为快照 snapshotting（快照）。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">save 900 1\t\t</div><div class=\"line\">#900秒内，最少有1个键被改动。则自动保存一次数据集</div><div class=\"line\">save 300 10</div><div class=\"line\">#300秒内，最少有10个键被改动。则自动保存一次数据集</div><div class=\"line\">save 60 10000</div><div class=\"line\">#60秒内，最少有10000个键被改动。则自动保存一次数据集</div></pre></td></tr></table></figure>\n<p>实验：验证dump.rdb数据保存文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# ls</div><div class=\"line\">anaconda-ks.cfg  dump.rdb  install.log  install.log.syslog</div></pre></td></tr></table></figure></p>\n<p>root目录下有dump.rdb文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-server  \\</div><div class=\"line\">/usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>在root目录中启动redis<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">127.0.0.1:6379&gt; auth 123</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">1) &quot;name2&quot;</div><div class=\"line\">2) &quot;name&quot;</div><div class=\"line\">3) &quot;name1&quot;</div></pre></td></tr></table></figure></p>\n<p>0库中有键<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# cd /usr/local/redis/</div><div class=\"line\">[root@localhost redis]# pkill -9 redis</div><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-server  \\</div><div class=\"line\">/usr/local/redis/etc/redis.conf</div></pre></td></tr></table></figure></p>\n<p>在/usr/local/redis/库中重启redis，<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# ls</div><div class=\"line\">[root@localhost redis]# /usr/local/redis/bin/redis-cli</div><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">(empty list or set)</div></pre></td></tr></table></figure></p>\n<p>0库中没有键<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; save</div><div class=\"line\">OK</div></pre></td></tr></table></figure></p>\n<p>保存<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; quit</div><div class=\"line\">[root@localhost redis]# ls</div><div class=\"line\">bin  dump.rdb  etc</div></pre></td></tr></table></figure></p>\n<p>在redis目录中也生成dump.rdb文件</p>\n<p><strong>结论：</strong><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost redis]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\">dir ./</div></pre></td></tr></table></figure></p>\n<p>定义了dump.rdb数据库文件保存在当前位置。所以每次重启redis服务的所在位置不同，导致生成新的dump.rdb文件<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">dir /usr/local/redis/</div></pre></td></tr></table></figure></p>\n<p>将数据库保存目录写为绝对路径（注意只能是目录）</p>\n<h3 id=\"使用AOF\"><a href=\"#使用AOF\" class=\"headerlink\" title=\"使用AOF\"></a>使用AOF</h3><blockquote>\n<p>使用AOF会让你的Redis更加耐久: 你可以使用不同的持久化策略：无备份,每秒备份,每次写的时候备份。使用默认的每秒备份策略,Redis的性能依然很好(备份是由后台线程进行处理的,主线程会尽力处理客户端请求),一旦出现故障，你最多丢失1秒的数据。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">appendonly no</div><div class=\"line\">#默认不使用AOF持久化（450行）</div><div class=\"line\"></div><div class=\"line\">appendonly yes</div><div class=\"line\">#开启AOF持久化</div><div class=\"line\"># appendfsync always\t\t#有写操作，就马上写入磁盘。效率最慢，到那时最按</div><div class=\"line\">appendfsync everysec\t\t#默认，每秒钟写入磁盘一次。</div><div class=\"line\"># appendfsync no\t\t\t#不进行AOF备份，将数据交给操作系统处理。最快，最不安全</div></pre></td></tr></table></figure>\n<h2 id=\"主从备份\"><a href=\"#主从备份\" class=\"headerlink\" title=\"主从备份\"></a>主从备份</h2><p>Redis主从复制特点：</p>\n<ul>\n<li>a.Master可以拥有多个slave</li>\n<li>b.多个slave可以连接同一个master外，还可以连接到其它slave</li>\n<li>c.主从复制不会阻塞master，在同步数据时，master可以继续处理client请求</li>\n<li>d.提高系统的伸缩性</li>\n</ul>\n<p>Redis主从复制过程：</p>\n<ul>\n<li>a.Slave与master建立连接，发送sync同步命令</li>\n<li>b.Master会启动一个后台进程，将数据库快照保存到文件中，同时master主进程会开始收集新的写命令并缓存。</li>\n<li>c.后台完成保存后，就将此文件发送给slave</li>\n<li>d.Slave将此文件保存到硬盘上</li>\n</ul>\n<h3 id=\"不同服务器配置主从\"><a href=\"#不同服务器配置主从\" class=\"headerlink\" title=\"不同服务器配置主从\"></a>不同服务器配置主从</h3><ol>\n<li>克隆一台linux作为从服务器<br>克隆机需要进行如下操作：</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">①\tvi /etc/sysconfig/network-scripts/ifcfg-eth0</div><div class=\"line\">\t删除MAC地址行</div><div class=\"line\">②\trm  -rf  /etc/udev/rules.d/70-persistent-net.rules</div><div class=\"line\">\t删除网卡和MAC地址绑定文件</div><div class=\"line\">③\t注意关闭防火墙和SELinux</div><div class=\"line\">④\t重启动系统</div></pre></td></tr></table></figure>\n<ol>\n<li>在从服务器上配置</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# vi /usr/local/redis/etc/redis.conf</div><div class=\"line\"># slaveof &lt;masterip&gt; &lt;masterport&gt;</div><div class=\"line\">#把此句开启，并指定主服务器ip和端口\t（196行）</div><div class=\"line\"></div><div class=\"line\">masterauth flzx_3QC</div><div class=\"line\">#设定主服务器密码</div></pre></td></tr></table></figure>\n<ol>\n<li>重启从服务器上redis</li>\n</ol>\n<h3 id=\"同一台服务器实现主从配置\"><a href=\"#同一台服务器实现主从配置\" class=\"headerlink\" title=\"同一台服务器实现主从配置\"></a>同一台服务器实现主从配置</h3><p>这里我们以本机配置 1台Master + 1台Slave 为例子,其中:</p>\n<blockquote>\n<ul>\n<li>Master IP:127.0.0.1  PORT:6379</li>\n<li>Slave1 IP:127.0.0.1  PORT:63791</li>\n</ul>\n</blockquote>\n<ol>\n<li>复制出从服务器目录</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# cp -r /usr/local/redis/ /usr/local/redis-slave1</div></pre></td></tr></table></figure>\n<ol>\n<li>修改redis-slave1配置文件</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# vi /usr/local/redis-slave1/etc/redis.conf</div><div class=\"line\">pidfile /usr/local/redis-slave1/redis.pid</div><div class=\"line\">#指定pid文件</div><div class=\"line\">port 63791</div><div class=\"line\">#指定端口号</div><div class=\"line\">dir /usr/local/redis-slave1/</div><div class=\"line\">#指定服务器目录</div><div class=\"line\">slaveof 127.0.0.1 6379</div><div class=\"line\">#指定主服务器IP和端口</div><div class=\"line\">masterauth flzx_3QC</div><div class=\"line\">#指定主服务器密码</div></pre></td></tr></table></figure>\n<ol>\n<li>启动服务</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/redis-slave1/bin/redis-server /usr/local/redis-slave1/etc/redis.conf</div><div class=\"line\">#启动从服务器，并调用从服务器配置文件</div><div class=\"line\"></div><div class=\"line\">[root@localhost ~]# netstat -tlun</div><div class=\"line\">tcp     0      0 :::6379                     :::*                        LISTEN      </div><div class=\"line\">tcp     0      0 :::63791                    :::*                        LISTEN</div><div class=\"line\">#验证两个端口是否都启动</div></pre></td></tr></table></figure>\n<ol>\n<li>验证</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">[root@localhost ~]# /usr/local/redis/bin/redis-cli -a flzx_3QC   </div><div class=\"line\">#启动主服务器，并建立一个键</div><div class=\"line\">127.0.0.1:6379&gt; set bb 234</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; keys *</div><div class=\"line\">1) &quot;sex&quot;</div><div class=\"line\">2) &quot;aa&quot;</div><div class=\"line\">3) &quot;name&quot;</div><div class=\"line\">4) &quot;age&quot;</div><div class=\"line\">5) &quot;bb&quot;</div><div class=\"line\"></div><div class=\"line\">[root@localhost ~]# /usr/local/redis-slave1/bin/redis-cli -a flzx_3QC -p 63791</div><div class=\"line\">#启动从服务器，发现键已经同步</div><div class=\"line\">127.0.0.1:63791&gt; keys *</div><div class=\"line\">1) &quot;aa&quot;</div><div class=\"line\">2) &quot;sex&quot;</div><div class=\"line\">3) &quot;age&quot;</div><div class=\"line\">4) &quot;name&quot;</div><div class=\"line\">5) &quot;bb&quot;</div></pre></td></tr></table></figure>"},{"title":"Schema数据类型优化","date":"2016-09-19T10:30:00.000Z","_content":"\n良好的数据路逻辑设计和物理设计是高性能的基石，所以要打造一个高性能的数据库服务，在Schema设计之初就应该需要权衡各种因素。\n\n## 选择最优化的数据类型\n数据库支持的数据类型非常多，选择一个正确的数据类型对于获得高性能至关重要。\n\n选择合适数据类型的几个原则：\n1. 更小的通常更好\n一般情况下，应该尽量使用可以正确数据类型的最小数据类型。但也要确保没有低估需要存储的范围。\n\n2. 简单就好\n简单的数据类型的操作通常需要更少的CPU周期。例如，\n- 整型比字符串操作代价更低\n- 使用MySQL内建的数据类型（比如，date、time、datetime），比用字符串更快\n- 使用整型存储一个IP地址，比用一个字符串更好\n\n3. 尽量避免使用NULL\n因为如果在查询中包含有NULL的列，对MySQL来说更难优化。所以通常情况下，最好指定列为 NOT NULL。\n\n**TIPS：**\ndatetime和timstamp列都可以存储相同类型的数据（时间和日期，都可以精确到秒），然而timestamp实际只使用datetime一般的存储空间。但另一方面，timestamp允许的时间范围要小的多。\n\n<!-- more -->\n\n## 基本的数据类型\n1. 数字\n  1. 整数\n    - TINYINT (8)\n    - SMALLINT (16)\n    - MEDIUMINT (24)\n    - INT (32)\n    - BIGINT (64)\n\n    > **TIPS1:** 整数类型有可选的 unsigned 属性，表示不允许有负值，如果将要使用的列不会出现负值的话，加上这个属性，将会可以使正数的上限增加一倍。\n\n    > **TIPS2:** int(1)与int(11)，对于存储和计算来说，这两者本质是没有区别的；两者只是在MySQL的一些交互工具中略有差别（比如，MySQL命令行客户端，用来控制显示字符的个数）。\n\n  2. 实数\n    - 作用\n    > 存储小数\n    > \n    > 存储比BIGINT更大的数\n\n    - float\n    - double\n    > float 和 double支持使用标准的浮点运算进行近似的计算。\n\n    - decimal\n    > decimal 类型用于存储精确的小数，支持精确的计算。\n    >\n    > 由于CPU不支持对decimal的直接计算，所以对decimal的精确计算是由MySQL服务器自己来实现。\n    >\n    > **Tips:** 因为在进行精确计算时需要额外的空间和计算开销，所以尽量只对小数才使用decimal。比如，财务数据。另外如果数据量大的话，可以考虑使用bigint代替decimal，只需将存储的货币单位根据小数的位数乘以相应的倍数即可。\n2. 字符串\n  1. CHAR\n  > char 类型是定长的：MySQL是根据定义的字符串长度分配足够的空间。\n  > char，适合存储很短的字符串，或者所有值的长度都差不多的的字符串。例如，密码的md5值。\n  > 另外，char还适合存储经常进行变更的值，相比于vachar，char类型很少会产生碎片。所以这一类的列，会比varchar更好。\n\n  2. VARCHAR\n  > varchar 类型用于存储可变长的字符串。它只使用必要的空间，所以比定长类型更节省空间。\n  >\n  > varchar,需要使用一个或者两个额外的字节来存储当前字符串的长度信息；如果列的长度小于或等于255个字节，则只需要一个字节表示，否则就需要两个字节来表示。\n  >\n  > 下面的这些情况适合使用varchar\n  > 1. 字符串列的长度比平均长度大很多\n  > 2. 列的更新很少，所以碎片不是问题\n  > 3. 使用了像UTF-8这样复杂的字符集，因为该字符集中每个字符可能使用不同的字节来进行存储\n\n    **Tips:**\n    用varchar(5)和varchar(200)来存储 「hello」有什么区别？\n\n    首先两者在存储空间的开销是一样的。\n    但是，一般的列在查询时会消耗更多的内存，因为在读到这些列时MySQL通常会分配固定大小的内存块来保存内部值。\n    尤其在使用内存临时表进行排序或者其他操作时，会特别的糟糕。\n    所以最好的策略就是，**分配真正需要的空间**。\n\n    **Tips：**\n    字符串长度定义不是字节数，而是字符数。两者概念是不同的，多字节字符集会需要更多的空间存储单个字符。\n3. BLOB和TEXT\n> 两者都是为存储很大的数据而设计的字符串数据类型，不同的是两者分别采用二进制和字符方式存储。\n>\n>MySQL在处理两个类型的值时，处理基本相同，仅有的不同是BLOB类型是以二进制格式来存储的，所以没有排序规则和字符集，而text类型有排序规则和字符集。\n\n4. 枚举（ENUM）\n> 枚举可以把一些不重复的字符串存储成一个预定义的集合。\n> MySQL会在存储枚举类型时粉肠紧凑，会根据列的值的数量压缩到一个或者两个字节中。\n> MySQL会在内部将每个值在列表中的位置保存成整数，而这些『数字--字符串』的对应关系，会保存在 .frm 文件中。\n> 所以当该列需要新添加一个新的枚举值时，必须添加在之前枚举列表的最后面，否则就会出现数据错乱的问题。切记。\n\n5. 日期和时间类型\n  - DATETIME\n  > 该类型能保存大范围的值，从1001年到9999年，精度为秒。他会把时间封装到YYYYMMDDHHIISS的整数中，没有时区概念。使用8个字节的存储空间。\n\n  - TIMESTAMP\n  > 该类型保存了从1970-01-01 00：00：00（格林威治时间）以来的秒数。该类型使用4个字节的存储空间，所以只能表示1970到2023年，其值还具有时区的概念。\n\n6. 位数据类型\n> 存储更紧凑。但所有这些位类型，不管底层存储格式和存储方式，从技术上来说都是字符串类型。虽然用它存储数据更紧凑，但是对于大部分应用来说，最好避免使用该类型。\n\n  - BIT\n\n  - SET\n\n7. 特殊类型的数据\n> 某些数据的类型并不直接和内置的类型一致。所以需要一定的转换进行存储。\n\n  - 低于秒级的时间戳\n  > 低于秒级的时间需要在引用层做处理，一般可以通过存储两个或者多个列来存储（一个存储秒级的时间戳，另外的存储秒级以下的）\n\n  - ipv4地址\n  > 我们常见到有人会用 varchar(15)来存错一个IP地址，IP地址实际是一个32位的无符号整数，所以应该用无符号整数来存储IP地址。MySQL提供了 INET_ATON()和 INET_NTOA() 函数在这两表示方法之间转换。\n\nlove over~\n2016-09-19\n\n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=86 src=\"http://music.163.com/outchain/player?type=2&id=28947001&auto=1&height=66\"></iframe>\n","source":"_posts/Schema数据类型优化.md","raw":"---\ntitle: Schema数据类型优化\ndate: 2016-09-19 18:30:00\ntags:\n- 数据类型\ncategories:\n- MySQL\n---\n\n良好的数据路逻辑设计和物理设计是高性能的基石，所以要打造一个高性能的数据库服务，在Schema设计之初就应该需要权衡各种因素。\n\n## 选择最优化的数据类型\n数据库支持的数据类型非常多，选择一个正确的数据类型对于获得高性能至关重要。\n\n选择合适数据类型的几个原则：\n1. 更小的通常更好\n一般情况下，应该尽量使用可以正确数据类型的最小数据类型。但也要确保没有低估需要存储的范围。\n\n2. 简单就好\n简单的数据类型的操作通常需要更少的CPU周期。例如，\n- 整型比字符串操作代价更低\n- 使用MySQL内建的数据类型（比如，date、time、datetime），比用字符串更快\n- 使用整型存储一个IP地址，比用一个字符串更好\n\n3. 尽量避免使用NULL\n因为如果在查询中包含有NULL的列，对MySQL来说更难优化。所以通常情况下，最好指定列为 NOT NULL。\n\n**TIPS：**\ndatetime和timstamp列都可以存储相同类型的数据（时间和日期，都可以精确到秒），然而timestamp实际只使用datetime一般的存储空间。但另一方面，timestamp允许的时间范围要小的多。\n\n<!-- more -->\n\n## 基本的数据类型\n1. 数字\n  1. 整数\n    - TINYINT (8)\n    - SMALLINT (16)\n    - MEDIUMINT (24)\n    - INT (32)\n    - BIGINT (64)\n\n    > **TIPS1:** 整数类型有可选的 unsigned 属性，表示不允许有负值，如果将要使用的列不会出现负值的话，加上这个属性，将会可以使正数的上限增加一倍。\n\n    > **TIPS2:** int(1)与int(11)，对于存储和计算来说，这两者本质是没有区别的；两者只是在MySQL的一些交互工具中略有差别（比如，MySQL命令行客户端，用来控制显示字符的个数）。\n\n  2. 实数\n    - 作用\n    > 存储小数\n    > \n    > 存储比BIGINT更大的数\n\n    - float\n    - double\n    > float 和 double支持使用标准的浮点运算进行近似的计算。\n\n    - decimal\n    > decimal 类型用于存储精确的小数，支持精确的计算。\n    >\n    > 由于CPU不支持对decimal的直接计算，所以对decimal的精确计算是由MySQL服务器自己来实现。\n    >\n    > **Tips:** 因为在进行精确计算时需要额外的空间和计算开销，所以尽量只对小数才使用decimal。比如，财务数据。另外如果数据量大的话，可以考虑使用bigint代替decimal，只需将存储的货币单位根据小数的位数乘以相应的倍数即可。\n2. 字符串\n  1. CHAR\n  > char 类型是定长的：MySQL是根据定义的字符串长度分配足够的空间。\n  > char，适合存储很短的字符串，或者所有值的长度都差不多的的字符串。例如，密码的md5值。\n  > 另外，char还适合存储经常进行变更的值，相比于vachar，char类型很少会产生碎片。所以这一类的列，会比varchar更好。\n\n  2. VARCHAR\n  > varchar 类型用于存储可变长的字符串。它只使用必要的空间，所以比定长类型更节省空间。\n  >\n  > varchar,需要使用一个或者两个额外的字节来存储当前字符串的长度信息；如果列的长度小于或等于255个字节，则只需要一个字节表示，否则就需要两个字节来表示。\n  >\n  > 下面的这些情况适合使用varchar\n  > 1. 字符串列的长度比平均长度大很多\n  > 2. 列的更新很少，所以碎片不是问题\n  > 3. 使用了像UTF-8这样复杂的字符集，因为该字符集中每个字符可能使用不同的字节来进行存储\n\n    **Tips:**\n    用varchar(5)和varchar(200)来存储 「hello」有什么区别？\n\n    首先两者在存储空间的开销是一样的。\n    但是，一般的列在查询时会消耗更多的内存，因为在读到这些列时MySQL通常会分配固定大小的内存块来保存内部值。\n    尤其在使用内存临时表进行排序或者其他操作时，会特别的糟糕。\n    所以最好的策略就是，**分配真正需要的空间**。\n\n    **Tips：**\n    字符串长度定义不是字节数，而是字符数。两者概念是不同的，多字节字符集会需要更多的空间存储单个字符。\n3. BLOB和TEXT\n> 两者都是为存储很大的数据而设计的字符串数据类型，不同的是两者分别采用二进制和字符方式存储。\n>\n>MySQL在处理两个类型的值时，处理基本相同，仅有的不同是BLOB类型是以二进制格式来存储的，所以没有排序规则和字符集，而text类型有排序规则和字符集。\n\n4. 枚举（ENUM）\n> 枚举可以把一些不重复的字符串存储成一个预定义的集合。\n> MySQL会在存储枚举类型时粉肠紧凑，会根据列的值的数量压缩到一个或者两个字节中。\n> MySQL会在内部将每个值在列表中的位置保存成整数，而这些『数字--字符串』的对应关系，会保存在 .frm 文件中。\n> 所以当该列需要新添加一个新的枚举值时，必须添加在之前枚举列表的最后面，否则就会出现数据错乱的问题。切记。\n\n5. 日期和时间类型\n  - DATETIME\n  > 该类型能保存大范围的值，从1001年到9999年，精度为秒。他会把时间封装到YYYYMMDDHHIISS的整数中，没有时区概念。使用8个字节的存储空间。\n\n  - TIMESTAMP\n  > 该类型保存了从1970-01-01 00：00：00（格林威治时间）以来的秒数。该类型使用4个字节的存储空间，所以只能表示1970到2023年，其值还具有时区的概念。\n\n6. 位数据类型\n> 存储更紧凑。但所有这些位类型，不管底层存储格式和存储方式，从技术上来说都是字符串类型。虽然用它存储数据更紧凑，但是对于大部分应用来说，最好避免使用该类型。\n\n  - BIT\n\n  - SET\n\n7. 特殊类型的数据\n> 某些数据的类型并不直接和内置的类型一致。所以需要一定的转换进行存储。\n\n  - 低于秒级的时间戳\n  > 低于秒级的时间需要在引用层做处理，一般可以通过存储两个或者多个列来存储（一个存储秒级的时间戳，另外的存储秒级以下的）\n\n  - ipv4地址\n  > 我们常见到有人会用 varchar(15)来存错一个IP地址，IP地址实际是一个32位的无符号整数，所以应该用无符号整数来存储IP地址。MySQL提供了 INET_ATON()和 INET_NTOA() 函数在这两表示方法之间转换。\n\nlove over~\n2016-09-19\n\n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=86 src=\"http://music.163.com/outchain/player?type=2&id=28947001&auto=1&height=66\"></iframe>\n","slug":"Schema数据类型优化","published":1,"updated":"2016-09-20T14:35:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxa003p699fi169ysg2","content":"<p>良好的数据路逻辑设计和物理设计是高性能的基石，所以要打造一个高性能的数据库服务，在Schema设计之初就应该需要权衡各种因素。</p>\n<h2 id=\"选择最优化的数据类型\"><a href=\"#选择最优化的数据类型\" class=\"headerlink\" title=\"选择最优化的数据类型\"></a>选择最优化的数据类型</h2><p>数据库支持的数据类型非常多，选择一个正确的数据类型对于获得高性能至关重要。</p>\n<p>选择合适数据类型的几个原则：</p>\n<ol>\n<li><p>更小的通常更好<br>一般情况下，应该尽量使用可以正确数据类型的最小数据类型。但也要确保没有低估需要存储的范围。</p>\n</li>\n<li><p>简单就好<br>简单的数据类型的操作通常需要更少的CPU周期。例如，</p>\n</li>\n</ol>\n<ul>\n<li>整型比字符串操作代价更低</li>\n<li>使用MySQL内建的数据类型（比如，date、time、datetime），比用字符串更快</li>\n<li>使用整型存储一个IP地址，比用一个字符串更好</li>\n</ul>\n<ol>\n<li>尽量避免使用NULL<br>因为如果在查询中包含有NULL的列，对MySQL来说更难优化。所以通常情况下，最好指定列为 NOT NULL。</li>\n</ol>\n<p><strong>TIPS：</strong><br>datetime和timstamp列都可以存储相同类型的数据（时间和日期，都可以精确到秒），然而timestamp实际只使用datetime一般的存储空间。但另一方面，timestamp允许的时间范围要小的多。</p>\n<a id=\"more\"></a>\n<h2 id=\"基本的数据类型\"><a href=\"#基本的数据类型\" class=\"headerlink\" title=\"基本的数据类型\"></a>基本的数据类型</h2><ol>\n<li><p>数字</p>\n<ol>\n<li><p>整数</p>\n<ul>\n<li>TINYINT (8)</li>\n<li>SMALLINT (16)</li>\n<li>MEDIUMINT (24)</li>\n<li>INT (32)</li>\n<li>BIGINT (64)</li>\n</ul>\n<blockquote>\n<p><strong>TIPS1:</strong> 整数类型有可选的 unsigned 属性，表示不允许有负值，如果将要使用的列不会出现负值的话，加上这个属性，将会可以使正数的上限增加一倍。</p>\n<p><strong>TIPS2:</strong> int(1)与int(11)，对于存储和计算来说，这两者本质是没有区别的；两者只是在MySQL的一些交互工具中略有差别（比如，MySQL命令行客户端，用来控制显示字符的个数）。</p>\n</blockquote>\n</li>\n<li><p>实数</p>\n<ul>\n<li><p>作用</p>\n<blockquote>\n<p>存储小数</p>\n<p>存储比BIGINT更大的数</p>\n</blockquote>\n</li>\n<li><p>float</p>\n</li>\n<li><p>double</p>\n<blockquote>\n<p>float 和 double支持使用标准的浮点运算进行近似的计算。</p>\n</blockquote>\n</li>\n<li><p>decimal</p>\n<blockquote>\n<p>decimal 类型用于存储精确的小数，支持精确的计算。</p>\n<p>由于CPU不支持对decimal的直接计算，所以对decimal的精确计算是由MySQL服务器自己来实现。</p>\n<p><strong>Tips:</strong> 因为在进行精确计算时需要额外的空间和计算开销，所以尽量只对小数才使用decimal。比如，财务数据。另外如果数据量大的话，可以考虑使用bigint代替decimal，只需将存储的货币单位根据小数的位数乘以相应的倍数即可。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ol>\n</li>\n<li><p>字符串</p>\n<ol>\n<li><p>CHAR</p>\n<blockquote>\n<p>char 类型是定长的：MySQL是根据定义的字符串长度分配足够的空间。<br>char，适合存储很短的字符串，或者所有值的长度都差不多的的字符串。例如，密码的md5值。<br>另外，char还适合存储经常进行变更的值，相比于vachar，char类型很少会产生碎片。所以这一类的列，会比varchar更好。</p>\n</blockquote>\n</li>\n<li><p>VARCHAR</p>\n<blockquote>\n<p>varchar 类型用于存储可变长的字符串。它只使用必要的空间，所以比定长类型更节省空间。</p>\n<p>varchar,需要使用一个或者两个额外的字节来存储当前字符串的长度信息；如果列的长度小于或等于255个字节，则只需要一个字节表示，否则就需要两个字节来表示。</p>\n<p>下面的这些情况适合使用varchar</p>\n<ol>\n<li>字符串列的长度比平均长度大很多</li>\n<li>列的更新很少，所以碎片不是问题</li>\n<li>使用了像UTF-8这样复杂的字符集，因为该字符集中每个字符可能使用不同的字节来进行存储</li>\n</ol>\n</blockquote>\n<p><strong>Tips:</strong><br>用varchar(5)和varchar(200)来存储 「hello」有什么区别？</p>\n<p>首先两者在存储空间的开销是一样的。<br>但是，一般的列在查询时会消耗更多的内存，因为在读到这些列时MySQL通常会分配固定大小的内存块来保存内部值。<br>尤其在使用内存临时表进行排序或者其他操作时，会特别的糟糕。<br>所以最好的策略就是，<strong>分配真正需要的空间</strong>。</p>\n<p><strong>Tips：</strong><br>字符串长度定义不是字节数，而是字符数。两者概念是不同的，多字节字符集会需要更多的空间存储单个字符。</p>\n</li>\n</ol>\n</li>\n<li><p>BLOB和TEXT</p>\n<blockquote>\n<p>两者都是为存储很大的数据而设计的字符串数据类型，不同的是两者分别采用二进制和字符方式存储。</p>\n<p>MySQL在处理两个类型的值时，处理基本相同，仅有的不同是BLOB类型是以二进制格式来存储的，所以没有排序规则和字符集，而text类型有排序规则和字符集。</p>\n</blockquote>\n</li>\n<li><p>枚举（ENUM）</p>\n<blockquote>\n<p>枚举可以把一些不重复的字符串存储成一个预定义的集合。<br>MySQL会在存储枚举类型时粉肠紧凑，会根据列的值的数量压缩到一个或者两个字节中。<br>MySQL会在内部将每个值在列表中的位置保存成整数，而这些『数字–字符串』的对应关系，会保存在 .frm 文件中。<br>所以当该列需要新添加一个新的枚举值时，必须添加在之前枚举列表的最后面，否则就会出现数据错乱的问题。切记。</p>\n</blockquote>\n</li>\n<li><p>日期和时间类型</p>\n<ul>\n<li><p>DATETIME</p>\n<blockquote>\n<p>该类型能保存大范围的值，从1001年到9999年，精度为秒。他会把时间封装到YYYYMMDDHHIISS的整数中，没有时区概念。使用8个字节的存储空间。</p>\n</blockquote>\n</li>\n<li><p>TIMESTAMP</p>\n<blockquote>\n<p>该类型保存了从1970-01-01 00：00：00（格林威治时间）以来的秒数。该类型使用4个字节的存储空间，所以只能表示1970到2023年，其值还具有时区的概念。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p>位数据类型</p>\n<blockquote>\n<p>存储更紧凑。但所有这些位类型，不管底层存储格式和存储方式，从技术上来说都是字符串类型。虽然用它存储数据更紧凑，但是对于大部分应用来说，最好避免使用该类型。</p>\n</blockquote>\n<ul>\n<li><p>BIT</p>\n</li>\n<li><p>SET</p>\n</li>\n</ul>\n</li>\n<li><p>特殊类型的数据</p>\n<blockquote>\n<p>某些数据的类型并不直接和内置的类型一致。所以需要一定的转换进行存储。</p>\n</blockquote>\n<ul>\n<li><p>低于秒级的时间戳</p>\n<blockquote>\n<p>低于秒级的时间需要在引用层做处理，一般可以通过存储两个或者多个列来存储（一个存储秒级的时间戳，另外的存储秒级以下的）</p>\n</blockquote>\n</li>\n<li><p>ipv4地址</p>\n<blockquote>\n<p>我们常见到有人会用 varchar(15)来存错一个IP地址，IP地址实际是一个32位的无符号整数，所以应该用无符号整数来存储IP地址。MySQL提供了 INET_ATON()和 INET_NTOA() 函数在这两表示方法之间转换。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ol>\n<p>love over~<br>2016-09-19</p>\n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=\"330\" height=\"86\" src=\"http://music.163.com/outchain/player?type=2&id=28947001&auto=1&height=66\"></iframe>\n","excerpt":"<p>良好的数据路逻辑设计和物理设计是高性能的基石，所以要打造一个高性能的数据库服务，在Schema设计之初就应该需要权衡各种因素。</p>\n<h2 id=\"选择最优化的数据类型\"><a href=\"#选择最优化的数据类型\" class=\"headerlink\" title=\"选择最优化的数据类型\"></a>选择最优化的数据类型</h2><p>数据库支持的数据类型非常多，选择一个正确的数据类型对于获得高性能至关重要。</p>\n<p>选择合适数据类型的几个原则：</p>\n<ol>\n<li><p>更小的通常更好<br>一般情况下，应该尽量使用可以正确数据类型的最小数据类型。但也要确保没有低估需要存储的范围。</p>\n</li>\n<li><p>简单就好<br>简单的数据类型的操作通常需要更少的CPU周期。例如，</p>\n</li>\n</ol>\n<ul>\n<li>整型比字符串操作代价更低</li>\n<li>使用MySQL内建的数据类型（比如，date、time、datetime），比用字符串更快</li>\n<li>使用整型存储一个IP地址，比用一个字符串更好</li>\n</ul>\n<ol>\n<li>尽量避免使用NULL<br>因为如果在查询中包含有NULL的列，对MySQL来说更难优化。所以通常情况下，最好指定列为 NOT NULL。</li>\n</ol>\n<p><strong>TIPS：</strong><br>datetime和timstamp列都可以存储相同类型的数据（时间和日期，都可以精确到秒），然而timestamp实际只使用datetime一般的存储空间。但另一方面，timestamp允许的时间范围要小的多。</p>","more":"<h2 id=\"基本的数据类型\"><a href=\"#基本的数据类型\" class=\"headerlink\" title=\"基本的数据类型\"></a>基本的数据类型</h2><ol>\n<li><p>数字</p>\n<ol>\n<li><p>整数</p>\n<ul>\n<li>TINYINT (8)</li>\n<li>SMALLINT (16)</li>\n<li>MEDIUMINT (24)</li>\n<li>INT (32)</li>\n<li>BIGINT (64)</li>\n</ul>\n<blockquote>\n<p><strong>TIPS1:</strong> 整数类型有可选的 unsigned 属性，表示不允许有负值，如果将要使用的列不会出现负值的话，加上这个属性，将会可以使正数的上限增加一倍。</p>\n<p><strong>TIPS2:</strong> int(1)与int(11)，对于存储和计算来说，这两者本质是没有区别的；两者只是在MySQL的一些交互工具中略有差别（比如，MySQL命令行客户端，用来控制显示字符的个数）。</p>\n</blockquote>\n</li>\n<li><p>实数</p>\n<ul>\n<li><p>作用</p>\n<blockquote>\n<p>存储小数</p>\n<p>存储比BIGINT更大的数</p>\n</blockquote>\n</li>\n<li><p>float</p>\n</li>\n<li><p>double</p>\n<blockquote>\n<p>float 和 double支持使用标准的浮点运算进行近似的计算。</p>\n</blockquote>\n</li>\n<li><p>decimal</p>\n<blockquote>\n<p>decimal 类型用于存储精确的小数，支持精确的计算。</p>\n<p>由于CPU不支持对decimal的直接计算，所以对decimal的精确计算是由MySQL服务器自己来实现。</p>\n<p><strong>Tips:</strong> 因为在进行精确计算时需要额外的空间和计算开销，所以尽量只对小数才使用decimal。比如，财务数据。另外如果数据量大的话，可以考虑使用bigint代替decimal，只需将存储的货币单位根据小数的位数乘以相应的倍数即可。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ol>\n</li>\n<li><p>字符串</p>\n<ol>\n<li><p>CHAR</p>\n<blockquote>\n<p>char 类型是定长的：MySQL是根据定义的字符串长度分配足够的空间。<br>char，适合存储很短的字符串，或者所有值的长度都差不多的的字符串。例如，密码的md5值。<br>另外，char还适合存储经常进行变更的值，相比于vachar，char类型很少会产生碎片。所以这一类的列，会比varchar更好。</p>\n</blockquote>\n</li>\n<li><p>VARCHAR</p>\n<blockquote>\n<p>varchar 类型用于存储可变长的字符串。它只使用必要的空间，所以比定长类型更节省空间。</p>\n<p>varchar,需要使用一个或者两个额外的字节来存储当前字符串的长度信息；如果列的长度小于或等于255个字节，则只需要一个字节表示，否则就需要两个字节来表示。</p>\n<p>下面的这些情况适合使用varchar</p>\n<ol>\n<li>字符串列的长度比平均长度大很多</li>\n<li>列的更新很少，所以碎片不是问题</li>\n<li>使用了像UTF-8这样复杂的字符集，因为该字符集中每个字符可能使用不同的字节来进行存储</li>\n</ol>\n</blockquote>\n<p><strong>Tips:</strong><br>用varchar(5)和varchar(200)来存储 「hello」有什么区别？</p>\n<p>首先两者在存储空间的开销是一样的。<br>但是，一般的列在查询时会消耗更多的内存，因为在读到这些列时MySQL通常会分配固定大小的内存块来保存内部值。<br>尤其在使用内存临时表进行排序或者其他操作时，会特别的糟糕。<br>所以最好的策略就是，<strong>分配真正需要的空间</strong>。</p>\n<p><strong>Tips：</strong><br>字符串长度定义不是字节数，而是字符数。两者概念是不同的，多字节字符集会需要更多的空间存储单个字符。</p>\n</li>\n</ol>\n</li>\n<li><p>BLOB和TEXT</p>\n<blockquote>\n<p>两者都是为存储很大的数据而设计的字符串数据类型，不同的是两者分别采用二进制和字符方式存储。</p>\n<p>MySQL在处理两个类型的值时，处理基本相同，仅有的不同是BLOB类型是以二进制格式来存储的，所以没有排序规则和字符集，而text类型有排序规则和字符集。</p>\n</blockquote>\n</li>\n<li><p>枚举（ENUM）</p>\n<blockquote>\n<p>枚举可以把一些不重复的字符串存储成一个预定义的集合。<br>MySQL会在存储枚举类型时粉肠紧凑，会根据列的值的数量压缩到一个或者两个字节中。<br>MySQL会在内部将每个值在列表中的位置保存成整数，而这些『数字–字符串』的对应关系，会保存在 .frm 文件中。<br>所以当该列需要新添加一个新的枚举值时，必须添加在之前枚举列表的最后面，否则就会出现数据错乱的问题。切记。</p>\n</blockquote>\n</li>\n<li><p>日期和时间类型</p>\n<ul>\n<li><p>DATETIME</p>\n<blockquote>\n<p>该类型能保存大范围的值，从1001年到9999年，精度为秒。他会把时间封装到YYYYMMDDHHIISS的整数中，没有时区概念。使用8个字节的存储空间。</p>\n</blockquote>\n</li>\n<li><p>TIMESTAMP</p>\n<blockquote>\n<p>该类型保存了从1970-01-01 00：00：00（格林威治时间）以来的秒数。该类型使用4个字节的存储空间，所以只能表示1970到2023年，其值还具有时区的概念。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n<li><p>位数据类型</p>\n<blockquote>\n<p>存储更紧凑。但所有这些位类型，不管底层存储格式和存储方式，从技术上来说都是字符串类型。虽然用它存储数据更紧凑，但是对于大部分应用来说，最好避免使用该类型。</p>\n</blockquote>\n<ul>\n<li><p>BIT</p>\n</li>\n<li><p>SET</p>\n</li>\n</ul>\n</li>\n<li><p>特殊类型的数据</p>\n<blockquote>\n<p>某些数据的类型并不直接和内置的类型一致。所以需要一定的转换进行存储。</p>\n</blockquote>\n<ul>\n<li><p>低于秒级的时间戳</p>\n<blockquote>\n<p>低于秒级的时间需要在引用层做处理，一般可以通过存储两个或者多个列来存储（一个存储秒级的时间戳，另外的存储秒级以下的）</p>\n</blockquote>\n</li>\n<li><p>ipv4地址</p>\n<blockquote>\n<p>我们常见到有人会用 varchar(15)来存错一个IP地址，IP地址实际是一个32位的无符号整数，所以应该用无符号整数来存储IP地址。MySQL提供了 INET_ATON()和 INET_NTOA() 函数在这两表示方法之间转换。</p>\n</blockquote>\n</li>\n</ul>\n</li>\n</ol>\n<p>love over~<br>2016-09-19</p>\n<iframe frameborder=\"no\" border=\"0\" marginwidth=\"0\" marginheight=\"0\" width=330 height=86 src=\"http://music.163.com/outchain/player?type=2&id=28947001&auto=1&height=66\"></iframe>"},{"title":"Web性能优化随笔","date":"2016-07-31T06:22:23.000Z","_content":"谈到web性能优化，一般我们可以把它分为两个部分来讲，页面加载（Page Speed）和页面渲染（Page Performance）。\n\n\n<!-- more -->\n\n\n# 页面加载\n\n## 加快服务器脚本的计算速度\n* 动态内容缓存\n* 数据缓存\n* 动态内容静态化\n* 选择适合的web服务器软件（Apache、nginx等）\n* 数据库优化\n* 等等···\n\n\n## 压缩源码和图片\n* Js 混淆压缩\n* CSS 普通压缩\n* JPG 根据具体质量压缩到50%~70%\n* PNG 色彩压缩、去除一些格式信息等\n\n\n## 选择合适的图片\n* 颜色较多，则使用JPG格式\n* 颜色较少，则使用PNG格式\n* 尽量使用WebP、SVG\n\n> 总之就是，尽量减少每一个资源的体积\n\n## 合并静态资源\n合并CSS、Javascript和小图片\n\n> 尽量减少同一域下的HTTP请求数\n\n## 开启服务器短的Gzip压缩\nGzip开启以后会将输出到用户浏览器的数据进行压缩的处理，这样就会减小通过网络传输的数据量，提高浏览的速度。所以Gzip对文本资源非常有效。\n\n\n## 使用CDN\n一些公用的静态资源（比如jquery、angular、bootstrap等）。使用这些公用的静态资源一方面可以增加页面文件并发下载量，另一方面还能和其他网站共享这些缓存。\n\n\n## 尽可能缓存静态资源\n尽可能延长静态资源的缓存时间，不但能使频繁访问网站的用户更快的访问，还能减轻服务器压力。至于静态资源的更新，则可以结合`修改文件名和+版本号`的方式来确保资源更新时，用户会加载到新的内容。\n\n\n## 尽可能将CSS文件放在页面头部，JavaScript放在页面底部\n应为javascript在加载的时候会出现阻塞，所以为避免出现阻塞页面渲染，让页面页面出现长时间空白，尽量将Javascript文件放在页面底部。\n\n# 页面渲染\n\n## 关键渲染路径\n![CRP](https://sfault-image.b0.upaiyun.com/315/063/3150630289-5766c21f45ef4_articlex)\n\n> 上图是浏览器渲染的关键路径，首先，让我们从浏览器解析一个页面开始吧。\n\n* ***转化***： 浏览器从磁盘或网络读取 HTML 的原始字节，浏览器会将这段原始文件按照相应编码规范进行解码（现在一般为 utf-8）。\n* ***符号化***： 根据 W3C 标准转化为对应的符号（一般在尖括号内）。\n* ***DOM 构建***：HTML 解析器会解析其中的 tag 标签，生成 token ，遇到 CSS 或 JS 会发送相应请求。HTML 解析时阻塞主进程的，CSS 一般也是阻塞主进程的（媒体查询时例外），也就是说它们在解析过程中是无法做出响应的。而 JS 手动添加 async 后达到异步加载，根据 token 生成相应 DOM 树。\n* ***CSSDOM 构建***：添加 CSS 样式生成 CSSDOM 树。\n* ***渲染树构建***：从 DOM 树的根节点开始，遍历每个可见的节点，给每个可见节点找到相应匹配的 CSSOM 规则，并应用这些规则，连带其内容及计算的样式。\n* ***样式计算***：浏览器会将所有的相对位置转换成绝对位置等一系列的样式计算。\n* ***布局***：浏览器将元素进行定位、布局。\n* ***绘制***：绘制元素样式，颜色、背景、大小、边框等。\n* ***合成***：将各层合成到一起、显示在屏幕上。\n\n![](https://sfault-image.b0.upaiyun.com/951/893/951893846-5766c220cc68c_articlex)\n\n如果我们是做一个动画，一般会用 JS 更改相应样式，接着浏览器就会经历 JS 运行、样式计算、布局、绘制、合成等多个重要步骤（后面还会讲到这个步骤实际过程中可以更长或者更短）。那么要做的优化就是在这几个步骤中进行优化并且尽量去掉中间的耗时步骤。\n![](https://sfault-image.b0.upaiyun.com/396/985/3969857354-5766c2228ceed_articlex)\n\n\n### 优化JavaScript的执行\n* 函数的输入事件处理\n* 优化处理\n\n\n### 样式计算\n* 减小选择器的复杂性\n* 减少样式的计算量\n\n\n### 布局\n* 避免触发布局\n* 使用Flexbox布局\n* 避免强制同步布局事件\n* 避免快速连续的布局\n\n\n### 绘制\n* 提升移动或渐变元素的绘制层\n* 仔细规划动画和简化绘制的复杂度\n\n\n### 合成\n* 使用transform/opacity实现动画效果\n* 管理渲染层、避免过多数量的层\n\n\n### 其他\n* 关注趋势，今天很多的性能瓶颈很可能在将来都不再是问题。\n* 充分利用工具 Chrome DevTools。\n* 不要进行微优化，有时花上很短的带来的性能提升却很小，对于日常快速迭代的业务是没必要这样做的。\n\n\n[更多详细关于页面渲染的内容，请查看][Performance]\n[Performance]:https://segmentfault.com/a/1190000005754881\n","source":"_posts/Web性能优化随笔.md","raw":"---\ntitle: Web性能优化随笔\ndate: 2016-07-31 14:22:23\ntags:\n- Web\n- 性能优化\ncategories:\n- Web\n---\n谈到web性能优化，一般我们可以把它分为两个部分来讲，页面加载（Page Speed）和页面渲染（Page Performance）。\n\n\n<!-- more -->\n\n\n# 页面加载\n\n## 加快服务器脚本的计算速度\n* 动态内容缓存\n* 数据缓存\n* 动态内容静态化\n* 选择适合的web服务器软件（Apache、nginx等）\n* 数据库优化\n* 等等···\n\n\n## 压缩源码和图片\n* Js 混淆压缩\n* CSS 普通压缩\n* JPG 根据具体质量压缩到50%~70%\n* PNG 色彩压缩、去除一些格式信息等\n\n\n## 选择合适的图片\n* 颜色较多，则使用JPG格式\n* 颜色较少，则使用PNG格式\n* 尽量使用WebP、SVG\n\n> 总之就是，尽量减少每一个资源的体积\n\n## 合并静态资源\n合并CSS、Javascript和小图片\n\n> 尽量减少同一域下的HTTP请求数\n\n## 开启服务器短的Gzip压缩\nGzip开启以后会将输出到用户浏览器的数据进行压缩的处理，这样就会减小通过网络传输的数据量，提高浏览的速度。所以Gzip对文本资源非常有效。\n\n\n## 使用CDN\n一些公用的静态资源（比如jquery、angular、bootstrap等）。使用这些公用的静态资源一方面可以增加页面文件并发下载量，另一方面还能和其他网站共享这些缓存。\n\n\n## 尽可能缓存静态资源\n尽可能延长静态资源的缓存时间，不但能使频繁访问网站的用户更快的访问，还能减轻服务器压力。至于静态资源的更新，则可以结合`修改文件名和+版本号`的方式来确保资源更新时，用户会加载到新的内容。\n\n\n## 尽可能将CSS文件放在页面头部，JavaScript放在页面底部\n应为javascript在加载的时候会出现阻塞，所以为避免出现阻塞页面渲染，让页面页面出现长时间空白，尽量将Javascript文件放在页面底部。\n\n# 页面渲染\n\n## 关键渲染路径\n![CRP](https://sfault-image.b0.upaiyun.com/315/063/3150630289-5766c21f45ef4_articlex)\n\n> 上图是浏览器渲染的关键路径，首先，让我们从浏览器解析一个页面开始吧。\n\n* ***转化***： 浏览器从磁盘或网络读取 HTML 的原始字节，浏览器会将这段原始文件按照相应编码规范进行解码（现在一般为 utf-8）。\n* ***符号化***： 根据 W3C 标准转化为对应的符号（一般在尖括号内）。\n* ***DOM 构建***：HTML 解析器会解析其中的 tag 标签，生成 token ，遇到 CSS 或 JS 会发送相应请求。HTML 解析时阻塞主进程的，CSS 一般也是阻塞主进程的（媒体查询时例外），也就是说它们在解析过程中是无法做出响应的。而 JS 手动添加 async 后达到异步加载，根据 token 生成相应 DOM 树。\n* ***CSSDOM 构建***：添加 CSS 样式生成 CSSDOM 树。\n* ***渲染树构建***：从 DOM 树的根节点开始，遍历每个可见的节点，给每个可见节点找到相应匹配的 CSSOM 规则，并应用这些规则，连带其内容及计算的样式。\n* ***样式计算***：浏览器会将所有的相对位置转换成绝对位置等一系列的样式计算。\n* ***布局***：浏览器将元素进行定位、布局。\n* ***绘制***：绘制元素样式，颜色、背景、大小、边框等。\n* ***合成***：将各层合成到一起、显示在屏幕上。\n\n![](https://sfault-image.b0.upaiyun.com/951/893/951893846-5766c220cc68c_articlex)\n\n如果我们是做一个动画，一般会用 JS 更改相应样式，接着浏览器就会经历 JS 运行、样式计算、布局、绘制、合成等多个重要步骤（后面还会讲到这个步骤实际过程中可以更长或者更短）。那么要做的优化就是在这几个步骤中进行优化并且尽量去掉中间的耗时步骤。\n![](https://sfault-image.b0.upaiyun.com/396/985/3969857354-5766c2228ceed_articlex)\n\n\n### 优化JavaScript的执行\n* 函数的输入事件处理\n* 优化处理\n\n\n### 样式计算\n* 减小选择器的复杂性\n* 减少样式的计算量\n\n\n### 布局\n* 避免触发布局\n* 使用Flexbox布局\n* 避免强制同步布局事件\n* 避免快速连续的布局\n\n\n### 绘制\n* 提升移动或渐变元素的绘制层\n* 仔细规划动画和简化绘制的复杂度\n\n\n### 合成\n* 使用transform/opacity实现动画效果\n* 管理渲染层、避免过多数量的层\n\n\n### 其他\n* 关注趋势，今天很多的性能瓶颈很可能在将来都不再是问题。\n* 充分利用工具 Chrome DevTools。\n* 不要进行微优化，有时花上很短的带来的性能提升却很小，对于日常快速迭代的业务是没必要这样做的。\n\n\n[更多详细关于页面渲染的内容，请查看][Performance]\n[Performance]:https://segmentfault.com/a/1190000005754881\n","slug":"Web性能优化随笔","published":1,"updated":"2016-08-24T03:16:22.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxc003s699frlydvl6r","content":"<p>谈到web性能优化，一般我们可以把它分为两个部分来讲，页面加载（Page Speed）和页面渲染（Page Performance）。</p>\n<a id=\"more\"></a>\n<h1 id=\"页面加载\"><a href=\"#页面加载\" class=\"headerlink\" title=\"页面加载\"></a>页面加载</h1><h2 id=\"加快服务器脚本的计算速度\"><a href=\"#加快服务器脚本的计算速度\" class=\"headerlink\" title=\"加快服务器脚本的计算速度\"></a>加快服务器脚本的计算速度</h2><ul>\n<li>动态内容缓存</li>\n<li>数据缓存</li>\n<li>动态内容静态化</li>\n<li>选择适合的web服务器软件（Apache、nginx等）</li>\n<li>数据库优化</li>\n<li>等等···</li>\n</ul>\n<h2 id=\"压缩源码和图片\"><a href=\"#压缩源码和图片\" class=\"headerlink\" title=\"压缩源码和图片\"></a>压缩源码和图片</h2><ul>\n<li>Js 混淆压缩</li>\n<li>CSS 普通压缩</li>\n<li>JPG 根据具体质量压缩到50%~70%</li>\n<li>PNG 色彩压缩、去除一些格式信息等</li>\n</ul>\n<h2 id=\"选择合适的图片\"><a href=\"#选择合适的图片\" class=\"headerlink\" title=\"选择合适的图片\"></a>选择合适的图片</h2><ul>\n<li>颜色较多，则使用JPG格式</li>\n<li>颜色较少，则使用PNG格式</li>\n<li>尽量使用WebP、SVG</li>\n</ul>\n<blockquote>\n<p>总之就是，尽量减少每一个资源的体积</p>\n</blockquote>\n<h2 id=\"合并静态资源\"><a href=\"#合并静态资源\" class=\"headerlink\" title=\"合并静态资源\"></a>合并静态资源</h2><p>合并CSS、Javascript和小图片</p>\n<blockquote>\n<p>尽量减少同一域下的HTTP请求数</p>\n</blockquote>\n<h2 id=\"开启服务器短的Gzip压缩\"><a href=\"#开启服务器短的Gzip压缩\" class=\"headerlink\" title=\"开启服务器短的Gzip压缩\"></a>开启服务器短的Gzip压缩</h2><p>Gzip开启以后会将输出到用户浏览器的数据进行压缩的处理，这样就会减小通过网络传输的数据量，提高浏览的速度。所以Gzip对文本资源非常有效。</p>\n<h2 id=\"使用CDN\"><a href=\"#使用CDN\" class=\"headerlink\" title=\"使用CDN\"></a>使用CDN</h2><p>一些公用的静态资源（比如jquery、angular、bootstrap等）。使用这些公用的静态资源一方面可以增加页面文件并发下载量，另一方面还能和其他网站共享这些缓存。</p>\n<h2 id=\"尽可能缓存静态资源\"><a href=\"#尽可能缓存静态资源\" class=\"headerlink\" title=\"尽可能缓存静态资源\"></a>尽可能缓存静态资源</h2><p>尽可能延长静态资源的缓存时间，不但能使频繁访问网站的用户更快的访问，还能减轻服务器压力。至于静态资源的更新，则可以结合<code>修改文件名和+版本号</code>的方式来确保资源更新时，用户会加载到新的内容。</p>\n<h2 id=\"尽可能将CSS文件放在页面头部，JavaScript放在页面底部\"><a href=\"#尽可能将CSS文件放在页面头部，JavaScript放在页面底部\" class=\"headerlink\" title=\"尽可能将CSS文件放在页面头部，JavaScript放在页面底部\"></a>尽可能将CSS文件放在页面头部，JavaScript放在页面底部</h2><p>应为javascript在加载的时候会出现阻塞，所以为避免出现阻塞页面渲染，让页面页面出现长时间空白，尽量将Javascript文件放在页面底部。</p>\n<h1 id=\"页面渲染\"><a href=\"#页面渲染\" class=\"headerlink\" title=\"页面渲染\"></a>页面渲染</h1><h2 id=\"关键渲染路径\"><a href=\"#关键渲染路径\" class=\"headerlink\" title=\"关键渲染路径\"></a>关键渲染路径</h2><p><img src=\"https://sfault-image.b0.upaiyun.com/315/063/3150630289-5766c21f45ef4_articlex\" alt=\"CRP\"></p>\n<blockquote>\n<p>上图是浏览器渲染的关键路径，首先，让我们从浏览器解析一个页面开始吧。</p>\n</blockquote>\n<ul>\n<li><strong><em>转化</em></strong>： 浏览器从磁盘或网络读取 HTML 的原始字节，浏览器会将这段原始文件按照相应编码规范进行解码（现在一般为 utf-8）。</li>\n<li><strong><em>符号化</em></strong>： 根据 W3C 标准转化为对应的符号（一般在尖括号内）。</li>\n<li><strong><em>DOM 构建</em></strong>：HTML 解析器会解析其中的 tag 标签，生成 token ，遇到 CSS 或 JS 会发送相应请求。HTML 解析时阻塞主进程的，CSS 一般也是阻塞主进程的（媒体查询时例外），也就是说它们在解析过程中是无法做出响应的。而 JS 手动添加 async 后达到异步加载，根据 token 生成相应 DOM 树。</li>\n<li><strong><em>CSSDOM 构建</em></strong>：添加 CSS 样式生成 CSSDOM 树。</li>\n<li><strong><em>渲染树构建</em></strong>：从 DOM 树的根节点开始，遍历每个可见的节点，给每个可见节点找到相应匹配的 CSSOM 规则，并应用这些规则，连带其内容及计算的样式。</li>\n<li><strong><em>样式计算</em></strong>：浏览器会将所有的相对位置转换成绝对位置等一系列的样式计算。</li>\n<li><strong><em>布局</em></strong>：浏览器将元素进行定位、布局。</li>\n<li><strong><em>绘制</em></strong>：绘制元素样式，颜色、背景、大小、边框等。</li>\n<li><strong><em>合成</em></strong>：将各层合成到一起、显示在屏幕上。</li>\n</ul>\n<p><img src=\"https://sfault-image.b0.upaiyun.com/951/893/951893846-5766c220cc68c_articlex\" alt=\"\"></p>\n<p>如果我们是做一个动画，一般会用 JS 更改相应样式，接着浏览器就会经历 JS 运行、样式计算、布局、绘制、合成等多个重要步骤（后面还会讲到这个步骤实际过程中可以更长或者更短）。那么要做的优化就是在这几个步骤中进行优化并且尽量去掉中间的耗时步骤。<br><img src=\"https://sfault-image.b0.upaiyun.com/396/985/3969857354-5766c2228ceed_articlex\" alt=\"\"></p>\n<h3 id=\"优化JavaScript的执行\"><a href=\"#优化JavaScript的执行\" class=\"headerlink\" title=\"优化JavaScript的执行\"></a>优化JavaScript的执行</h3><ul>\n<li>函数的输入事件处理</li>\n<li>优化处理</li>\n</ul>\n<h3 id=\"样式计算\"><a href=\"#样式计算\" class=\"headerlink\" title=\"样式计算\"></a>样式计算</h3><ul>\n<li>减小选择器的复杂性</li>\n<li>减少样式的计算量</li>\n</ul>\n<h3 id=\"布局\"><a href=\"#布局\" class=\"headerlink\" title=\"布局\"></a>布局</h3><ul>\n<li>避免触发布局</li>\n<li>使用Flexbox布局</li>\n<li>避免强制同步布局事件</li>\n<li>避免快速连续的布局</li>\n</ul>\n<h3 id=\"绘制\"><a href=\"#绘制\" class=\"headerlink\" title=\"绘制\"></a>绘制</h3><ul>\n<li>提升移动或渐变元素的绘制层</li>\n<li>仔细规划动画和简化绘制的复杂度</li>\n</ul>\n<h3 id=\"合成\"><a href=\"#合成\" class=\"headerlink\" title=\"合成\"></a>合成</h3><ul>\n<li>使用transform/opacity实现动画效果</li>\n<li>管理渲染层、避免过多数量的层</li>\n</ul>\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><ul>\n<li>关注趋势，今天很多的性能瓶颈很可能在将来都不再是问题。</li>\n<li>充分利用工具 Chrome DevTools。</li>\n<li>不要进行微优化，有时花上很短的带来的性能提升却很小，对于日常快速迭代的业务是没必要这样做的。</li>\n</ul>\n<p><a href=\"https://segmentfault.com/a/1190000005754881\" target=\"_blank\" rel=\"external\">更多详细关于页面渲染的内容，请查看</a></p>\n","excerpt":"<p>谈到web性能优化，一般我们可以把它分为两个部分来讲，页面加载（Page Speed）和页面渲染（Page Performance）。</p>","more":"<h1 id=\"页面加载\"><a href=\"#页面加载\" class=\"headerlink\" title=\"页面加载\"></a>页面加载</h1><h2 id=\"加快服务器脚本的计算速度\"><a href=\"#加快服务器脚本的计算速度\" class=\"headerlink\" title=\"加快服务器脚本的计算速度\"></a>加快服务器脚本的计算速度</h2><ul>\n<li>动态内容缓存</li>\n<li>数据缓存</li>\n<li>动态内容静态化</li>\n<li>选择适合的web服务器软件（Apache、nginx等）</li>\n<li>数据库优化</li>\n<li>等等···</li>\n</ul>\n<h2 id=\"压缩源码和图片\"><a href=\"#压缩源码和图片\" class=\"headerlink\" title=\"压缩源码和图片\"></a>压缩源码和图片</h2><ul>\n<li>Js 混淆压缩</li>\n<li>CSS 普通压缩</li>\n<li>JPG 根据具体质量压缩到50%~70%</li>\n<li>PNG 色彩压缩、去除一些格式信息等</li>\n</ul>\n<h2 id=\"选择合适的图片\"><a href=\"#选择合适的图片\" class=\"headerlink\" title=\"选择合适的图片\"></a>选择合适的图片</h2><ul>\n<li>颜色较多，则使用JPG格式</li>\n<li>颜色较少，则使用PNG格式</li>\n<li>尽量使用WebP、SVG</li>\n</ul>\n<blockquote>\n<p>总之就是，尽量减少每一个资源的体积</p>\n</blockquote>\n<h2 id=\"合并静态资源\"><a href=\"#合并静态资源\" class=\"headerlink\" title=\"合并静态资源\"></a>合并静态资源</h2><p>合并CSS、Javascript和小图片</p>\n<blockquote>\n<p>尽量减少同一域下的HTTP请求数</p>\n</blockquote>\n<h2 id=\"开启服务器短的Gzip压缩\"><a href=\"#开启服务器短的Gzip压缩\" class=\"headerlink\" title=\"开启服务器短的Gzip压缩\"></a>开启服务器短的Gzip压缩</h2><p>Gzip开启以后会将输出到用户浏览器的数据进行压缩的处理，这样就会减小通过网络传输的数据量，提高浏览的速度。所以Gzip对文本资源非常有效。</p>\n<h2 id=\"使用CDN\"><a href=\"#使用CDN\" class=\"headerlink\" title=\"使用CDN\"></a>使用CDN</h2><p>一些公用的静态资源（比如jquery、angular、bootstrap等）。使用这些公用的静态资源一方面可以增加页面文件并发下载量，另一方面还能和其他网站共享这些缓存。</p>\n<h2 id=\"尽可能缓存静态资源\"><a href=\"#尽可能缓存静态资源\" class=\"headerlink\" title=\"尽可能缓存静态资源\"></a>尽可能缓存静态资源</h2><p>尽可能延长静态资源的缓存时间，不但能使频繁访问网站的用户更快的访问，还能减轻服务器压力。至于静态资源的更新，则可以结合<code>修改文件名和+版本号</code>的方式来确保资源更新时，用户会加载到新的内容。</p>\n<h2 id=\"尽可能将CSS文件放在页面头部，JavaScript放在页面底部\"><a href=\"#尽可能将CSS文件放在页面头部，JavaScript放在页面底部\" class=\"headerlink\" title=\"尽可能将CSS文件放在页面头部，JavaScript放在页面底部\"></a>尽可能将CSS文件放在页面头部，JavaScript放在页面底部</h2><p>应为javascript在加载的时候会出现阻塞，所以为避免出现阻塞页面渲染，让页面页面出现长时间空白，尽量将Javascript文件放在页面底部。</p>\n<h1 id=\"页面渲染\"><a href=\"#页面渲染\" class=\"headerlink\" title=\"页面渲染\"></a>页面渲染</h1><h2 id=\"关键渲染路径\"><a href=\"#关键渲染路径\" class=\"headerlink\" title=\"关键渲染路径\"></a>关键渲染路径</h2><p><img src=\"https://sfault-image.b0.upaiyun.com/315/063/3150630289-5766c21f45ef4_articlex\" alt=\"CRP\"></p>\n<blockquote>\n<p>上图是浏览器渲染的关键路径，首先，让我们从浏览器解析一个页面开始吧。</p>\n</blockquote>\n<ul>\n<li><strong><em>转化</em></strong>： 浏览器从磁盘或网络读取 HTML 的原始字节，浏览器会将这段原始文件按照相应编码规范进行解码（现在一般为 utf-8）。</li>\n<li><strong><em>符号化</em></strong>： 根据 W3C 标准转化为对应的符号（一般在尖括号内）。</li>\n<li><strong><em>DOM 构建</em></strong>：HTML 解析器会解析其中的 tag 标签，生成 token ，遇到 CSS 或 JS 会发送相应请求。HTML 解析时阻塞主进程的，CSS 一般也是阻塞主进程的（媒体查询时例外），也就是说它们在解析过程中是无法做出响应的。而 JS 手动添加 async 后达到异步加载，根据 token 生成相应 DOM 树。</li>\n<li><strong><em>CSSDOM 构建</em></strong>：添加 CSS 样式生成 CSSDOM 树。</li>\n<li><strong><em>渲染树构建</em></strong>：从 DOM 树的根节点开始，遍历每个可见的节点，给每个可见节点找到相应匹配的 CSSOM 规则，并应用这些规则，连带其内容及计算的样式。</li>\n<li><strong><em>样式计算</em></strong>：浏览器会将所有的相对位置转换成绝对位置等一系列的样式计算。</li>\n<li><strong><em>布局</em></strong>：浏览器将元素进行定位、布局。</li>\n<li><strong><em>绘制</em></strong>：绘制元素样式，颜色、背景、大小、边框等。</li>\n<li><strong><em>合成</em></strong>：将各层合成到一起、显示在屏幕上。</li>\n</ul>\n<p><img src=\"https://sfault-image.b0.upaiyun.com/951/893/951893846-5766c220cc68c_articlex\" alt=\"\"></p>\n<p>如果我们是做一个动画，一般会用 JS 更改相应样式，接着浏览器就会经历 JS 运行、样式计算、布局、绘制、合成等多个重要步骤（后面还会讲到这个步骤实际过程中可以更长或者更短）。那么要做的优化就是在这几个步骤中进行优化并且尽量去掉中间的耗时步骤。<br><img src=\"https://sfault-image.b0.upaiyun.com/396/985/3969857354-5766c2228ceed_articlex\" alt=\"\"></p>\n<h3 id=\"优化JavaScript的执行\"><a href=\"#优化JavaScript的执行\" class=\"headerlink\" title=\"优化JavaScript的执行\"></a>优化JavaScript的执行</h3><ul>\n<li>函数的输入事件处理</li>\n<li>优化处理</li>\n</ul>\n<h3 id=\"样式计算\"><a href=\"#样式计算\" class=\"headerlink\" title=\"样式计算\"></a>样式计算</h3><ul>\n<li>减小选择器的复杂性</li>\n<li>减少样式的计算量</li>\n</ul>\n<h3 id=\"布局\"><a href=\"#布局\" class=\"headerlink\" title=\"布局\"></a>布局</h3><ul>\n<li>避免触发布局</li>\n<li>使用Flexbox布局</li>\n<li>避免强制同步布局事件</li>\n<li>避免快速连续的布局</li>\n</ul>\n<h3 id=\"绘制\"><a href=\"#绘制\" class=\"headerlink\" title=\"绘制\"></a>绘制</h3><ul>\n<li>提升移动或渐变元素的绘制层</li>\n<li>仔细规划动画和简化绘制的复杂度</li>\n</ul>\n<h3 id=\"合成\"><a href=\"#合成\" class=\"headerlink\" title=\"合成\"></a>合成</h3><ul>\n<li>使用transform/opacity实现动画效果</li>\n<li>管理渲染层、避免过多数量的层</li>\n</ul>\n<h3 id=\"其他\"><a href=\"#其他\" class=\"headerlink\" title=\"其他\"></a>其他</h3><ul>\n<li>关注趋势，今天很多的性能瓶颈很可能在将来都不再是问题。</li>\n<li>充分利用工具 Chrome DevTools。</li>\n<li>不要进行微优化，有时花上很短的带来的性能提升却很小，对于日常快速迭代的业务是没必要这样做的。</li>\n</ul>\n<p><a href=\"https://segmentfault.com/a/1190000005754881\">更多详细关于页面渲染的内容，请查看</a></p>"},{"title":"Redis数据类型与操作","date":"2016-09-27T12:30:00.000Z","_content":"\nRedis共有5种数据类型\n- string(字符串)\n- hash(哈希表)\n- list(双向队列)\n- set(集合)\n- zset(有序集合)\n\n<!-- more -->\n\n## String（子串类型）\nString是最简单的类型，一个Key对应一个Value，string类型是二进制安全的。Redis的string可以包含任何数据，比如jpg图片或者序列化的对象。\n\n1. set 键  \"值\"\n> 设置一个键和值，键存在则覆盖，返回ok\n\n```\n127.0.0.1:6379> set name liming\nOK\n```\n\n2. get 键\n> 获取一个键的值，返回值\n\n```  \t   \n127.0.0.1:6379> get name\n\"liming\"\n```\n\n3. setnx 键 值\n> 只有当该键不存在时设置一个键的值，若键已存在则返回0表示失败（防止覆盖），\n\n```\n127.0.0.1:6379> setnx age 18\n(integer) 1\n127.0.0.1:6379> setnx age 18\n(integer) 0\n```\n\n4.  setex 键 [有效时间] 值\n> 设置一个指定有效期的键和值（单位秒）。不写有效时间则表示永久有效，等价于set\n\n```   \n127.0.0.1:6379> setex movie 30 canglaoshi\nOK\n127.0.0.1:6379> ttl movie\t\t\t\t//获取键的有效时间\n(integer) 26\n127.0.0.1:6379> ttl movie\n(integer) 20\n127.0.0.1:6379> get movie\n\"canglaoshi\"\n127.0.0.1:6379> ttl movie\n(integer) -2\n127.0.0.1:6379> get movie\n(nil)\n```\n\n4. ttl 键\n> 以秒为单位，返回给定 key 的剩余生存时间\n> - 当 key 不存在时，返回 -2 。\n>\t-\t当 key 存在但没有设置剩余生存时间时，返回 -1 。\n>\t-\t否则，以秒为单位，返回 key 的剩余生存时间。\n\n\n5. setrange 键 位置 子字串\n> 替换子字符串 (替换长度由子子串长度决定)\n\n```\n127.0.0.1:6379> set key1 \"hello world\"\nOK\n127.0.0.1:6379> get key1\n\"hello world\"\n127.0.0.1:6379> setrange key1 6 liming\n(integer) 12\n127.0.0.1:6379> get key1\n\"hello liming\"\n\t#将key1键对应值的第6个位置开始替换（字符串位置从0开始计算）\n```\n\n6. mset 键1 值1 键2 值2 键3 值3 ....\n> 批量设置键和值,成功则返回ok\n\n```\n127.0.0.1:6379> mset name1 lm name2 sc name3 zjj\nOK\n```\n\n7. mget 键1 键2 键3....\n> 批量获取值\n\n```\n127.0.0.1:6379> mget name1 name2 name3\n1) \"lm\"\n2) \"sc\"\n3) \"zjj\"\n```\n\n8. msetnx 键1 值1 键2 值2 键3 值3 ....\n> 批量设置不存在的键和值,成功则返回ok\n\n\n9. getset 键 新值\n> 获取原值，并设置新值\n\n```\n127.0.0.1:6379> set name \"shen chao\"\nOK\n127.0.0.1:6379> get name\n\"shen chao\"\n127.0.0.1:6379> getset name \"liming\"\n\"shen chao\"\n127.0.0.1:6379> get name\n\"liming\"\n```\n\n10. getrange 键 0 4  \n> 获取指定范围的值（获取指定0到4位置上的值，字符串位置从0开始计算）\n\n```\n127.0.0.1:6379> getrange key1 0 4\n\"hello\"\n```\n\n11. incr 键  \n> 指定键的值做加1操作，返回加后的结果（只能加数字）。\n\n```\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> incr age\n(integer) 19\n127.0.0.1:6379> get age\n\"19\"\n```\n\n12. incrby 键 m    \n> 其中m可以是正整数或负整数.加指定值，键不存在时候会设置键\n\n```\n127.0.0.1:6379> incrby age 10\n(integer) 29\n127.0.0.1:6379> get age\n\"29\"\n127.0.0.1:6379> incrby age -5\n(integer) 24\n```\n\n13. decr 键\n> 指定键的值做减1操作，返回减后的结果。\n\n```    \n127.0.0.1:6379> decr age\n(integer) 23\n127.0.0.1:6379> get age\n\"23\"\n```\n\n14. decrby 键 n\n> 其中n可以是正整数或负整数.设置某个键减上指定值\n\n```\n127.0.0.1:6379> decrby age 5\n(integer) 18\n127.0.0.1:6379> decrby age -10\n(integer) 28\n127.0.0.1:6379> get age\n\"28\"\n```\n\n15. append  键 追加字串\n> 给指定key的字符串追加value，返回新字符串值的长度\n\n``` \t\n127.0.0.1:6379> append name1 \" have a hot body!\"\n(integer) 19\n127.0.0.1:6379> get name1\n\"lm have a hot body!\"\n```\n\n16. strlen 键名\n> strlen求一个键长度\n\n```\n127.0.0.1:6379> strlen name1\n(integer) 19\n```\n\n17. del命令：\n> 删除一个键\n\n```\n127.0.0.1:6379> del name3\n(integer) 1\n127.0.0.1:6379> get name3\n(nil)\n```\n\n## hashs类型\n> 注意：redis中没有表概念，所有的数据都存入键中。\n> - string键类型：所有的值（可以是任何数据类型）都保存在一个键当中，放在一个内存块中\n>\t- hashs键类型：所有的值也都保存在一个键当中，只是放在不同的内存块中，每个块称作字段\n\n1. hset key field value\n> 设置一个键，在键中保存字段和值\n> 格式： hset 哈希集（键） 字段 值\n\n```\n127.0.0.1:6379> hset user1 name4 ysm\n(integer) 1\n127.0.0.1:6379> keys *\t\t\t\t\t//查看库中所有的键\n1) \"aa\"\n2) \"name\"\n3) \"name1\"\n4) \"user1\"\n5) \"name2\"\n6) \"age\"\n7) \"key1\"\n```\n\n2. hsetnx  键  字段  值\n>\t设置一个键中，不存在的字段和值。如果字段存在则报错（成功返回1，失败返回0）\n\n```\n127.0.0.1:6379> hsetnx user1 name1 lm\n(integer) 1\n127.0.0.1:6379> hsetnx user1 name1 sc\n(integer) 0\t\t\t\t\t//报错\n127.0.0.1:6379> hget user1 name1\n\"lm\"\t\t\t\t\t\t//内容没有更新\n```\n\n3. hmset  键  字段1  值1  字段2  值2 …\n>\t在一个键中，批量设置字段\n\n```\n127.0.0.1:6379> hmset user2 name liming age 36 interest AV-Girl\nOK\n```\n\n4. hget 键 字段\n>\t获取键中的一个指定字段的值\n\n```\n127.0.0.1:6379> hget user1 name1\n\"lm\"\n127.0.0.1:6379> hget user2 interest\n\"AV-Girl\"\n```\n\n5. hmget 键 字段1 [字段2…]\n>\t获取键中一个或多个字段的值\n\n```\n127.0.0.1:6379> hmget user2 name age interest\n1) \"liming\"\n2) \"36\"\n3) \"AV-Girl\"\n```\n\n6. hexists ：\n> 判断指定的字段是否存在于键中\n\n```\n127.0.0.1:6379> HEXISTS user2 age\n(integer) 1\t\t\t\t\t\t\t//存在\n127.0.0.1:6379> HEXISTS user1 age\n(integer) 0\t\t\t\t\t\t\t//不存在\n```\n\n7. hlen ：获取键中的字段数量\n\n```\n127.0.0.1:6379> hlen user2\n(integer) 3\t\t\t\t\t\t\t//user2键中有3个字段\n```\n\n8. hkeys ：获取键中的所有字段名\n\n```\n127.0.0.1:6379> hkeys user2\n1) \"name\"\n2) \"age\"\n3) \"interest\"\n```\n\n9. hvals：获取键中所有字段的值\n\n```\n127.0.0.1:6379> hvals user2\n1) \"liming\"\n2) \"36\"\n3) \"AV-Girl\"\n```\n\n10. hgetall ：获取键中的所有字段和值\n\n```\n127.0.0.1:6379> hgetall user2\n1) \"name\"\n2) \"liming\"\n3) \"age\"\n4) \"36\"\n5) \"interest\"\n6) \"AV-Girl\"\n```\n\n11. hincrby：将键中指定字段的值，增加指定的数字\n\n```\n127.0.0.1:6379> hincrby user2 age 5\n(integer) 41\n\n127.0.0.1:6379> HINCRBY user2 name 5\n(error) ERR hash value is not an integer\t//值不是数字的字段，不能加数字\n```\n\n12. hdel 键 字段1 字段2\n>\t删除键中的一个或多个字段\n\n```\n127.0.0.1:6379> hdel user2 age interest\n(integer) 2\n127.0.0.1:6379> hkeys user2\n1) \"name\"\n\t//删除一个键，还是要使用del命令\n```\n\n\n\n## list类型（双向链表结构）\nList是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等，操作中key理解为链表的名字。Redis的list类型其实就是一个每个子元素都是string类型的双向链表。列表允许有重复值\n\n1. lpush 键 值1 [值2…]\n> 从队列左边向队列写入一个或多个值（认为队列的左面为队列头，右边为队列尾）\n\n```\n127.0.0.1:6379> lpush list1 1\n(integer) 1\n127.0.0.1:6379> lpush list1 2\n(integer) 2\n127.0.0.1:6379> lpush list1 3\n(integer) 3\n127.0.0.1:6379> lpush list1 4\n(integer) 4\n\n127.0.0.1:6379> lpush list2 one two three four\n(integer) 4\n```\n\n2. lrange 键 起始下标 终止下标\n>\t从队列中获取指定的返回值（从队列左边向右获取）\n> 下标：\n> - 0代表队列中第一个元素，1代表第二个元素，依次类推\n> - -1代表队列中最后一个元素，-2代表倒数第二个元素\n\n```\n127.0.0.1:6379> LRANGE list1 0 -1\n1) \"4\"\t\t//4是从左面写入队列的最后一个值，所以在队列的开头\n2) \"3\"\n3) \"2\"\n4) \"1\"\t\t//1是从左面写入队列的第一个值，所以直接放到了队列尾。\n\n127.0.0.1:6379> LRANGE list2 0 -1\n1) \"four\"\n2) \"three\"\n3) \"two\"\n4) \"one\"\n\n127.0.0.1:6379> LRANGE list1 0 1\n1) \"4\"\n2) \"3\"\n\n127.0.0.1:6379> LRANGE list2 -4 3\n1) \"four\"\t\t//-4代表从队列右边数第四个元素\n2) \"three\"\n3) \"two\"\n4) \"one\"\t\t//3代表从队列左边数第四个元素\n```\n\n3. rpush 键 值1 [值2…]\n>\t从队列右边向队列写入一个或多个值\n\n```\n127.0.0.1:6379> RPUSH list3 1 2 3 4\n(integer) 4\n127.0.0.1:6379> LRANGE list3 0 -1\n1) \"1\"\t\t//从队列右边向队列写入值，第一个值就会写到队列的开头\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n4. linsert  键  before|after  原值  新值\n>\t在队列中指定元素之前或之后插入新值\n\n```\n127.0.0.1:6379> LINSERT list3 before 3 hello\n(integer) 5\n127.0.0.1:6379> LRANGE list3 0 -1\n1) \"1\"\n2) \"2\"\n3) \"hello\"\n4) \"3\"\n5) \"4\"\n```\n\n5. lset  键  下标  新值\n>\t给队列中指定元素设定新值\n\n```\n127.0.0.1:6379> lset list3 2 \"5\"\nOK\n127.0.0.1:6379> LRANGE list3 0 -1\n1) \"1\"\n2) \"2\"\n3) \"5\"\n4) \"3\"\n5) \"4\"\n```\n\n6. lerm  键  n  指定值\n> 从队列中删除n个值为“指定值”的元素\n>\t- n > 0 \t从队列头向尾删除n个元素\n>\t- n < 0 \t从队列尾向头删除n个元素\n>\t- n = 0\t删除所有值为“指定值”的元素\n\n```\n127.0.0.1:6379> rpush list4 hello 1 hello 2 hello 3 hello\n(integer) 7\n127.0.0.1:6379> lrange list4 0 -1\n1) \"hello\"\n2) \"1\"\n3) \"hello\"\n4) \"2\"\n5) \"hello\"\n6) \"3\"\n7) \"hello\"\n127.0.0.1:6379> lrem list4 -2 hello\t\t\t//删除后两个hello\n(integer) 2\n127.0.0.1:6379> lrange list4 0 -1\n1) \"hello\"\n2) \"1\"\n3) \"hello\"\n4) \"2\"\n5) \"3\"\n127.0.0.1:6379> lrem list4 0 hello\t\t\t//删除所有hello\n(integer) 2\n127.0.0.1:6379> lrange list4 0 -1\n1) \"1\"\n2) \"2\"\n3) \"3\"\n```\n\n7. ltrim  键  起始下标  结束下标\n>\t修剪队列，让队列只保留指定指定范围内的元素\n\n```\n127.0.0.1:6379> RPUSH list5 1 2 3 4\n(integer) 4\n127.0.0.1:6379> ltrim list5 1 2\nOK\n127.0.0.1:6379> lrange list5 0 -1\n1) \"2\"\n2) \"3\"\n```\n\n8. lpop  键\n>\t从指定的队列左面移除一个值\n\n```\n127.0.0.1:6379> lrange list1 0 -1\n1) \"4\"\n2) \"3\"\n3) \"2\"\n4) \"1\"\n127.0.0.1:6379> lpop list1\n\"4\"\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n3) \"1\"\n```\n\n9. rpop  键\n>\t从指定队列的右边移除一个值\n\n```\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n3) \"1\"\n127.0.0.1:6379> rpop list1\n\"1\"\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n```\n\n10. rpoplpush  源队列  目标队列\n>\t移除源队列的最后一个元素，并把该元素写入目标队列\n\n```\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n127.0.0.1:6379> lrange list5 0 -1\n1) \"2\"\n2) \"3\"\n127.0.0.1:6379> RPOPLPUSH list1 list5\n\"2\"\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n127.0.0.1:6379> lrange list5 0 -1\n1) \"2\"\n2) \"2\"\n3) \"3\"\n```\n\n11. lindex  键  下标\n>\t获取队列中指定下标元素的值\n\n```\n127.0.0.1:6379> lrange list2 0 -1\n1) \"four\"\n2) \"three\"\n3) \"two\"\n4) \"one\"\n127.0.0.1:6379> lindex list2 1\n\"three\"\n127.0.0.1:6379> lindex list2 3\n\"one\"\n```\n\n12. llen  键\n>\t获得队列的长度\n\n```\n127.0.0.1:6379> llen list2\n(integer) 4\n```\n\n\n## sets类型和操作\n\nSet是集合，它是string类型的无序集合。对集合我们可以取并集、交集、差集。通过这些操作我们可以实现社交网站中的好友推荐和blog的tag功能。集合不允许有重复值。\n\n1. sadd  键  值1[值2…]\n>\t添加一个或多个元素到集合中\n\n```\n127.0.0.1:6379> sadd mset1 1\n(integer) 1\n127.0.0.1:6379> sadd mset1 2 3 4\n(integer) 3\n```\n2. smembers  键\n>\t获取集合里面所有的元素\n\n```\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n3. srem  键  值1[值2…]\n>\t从集合中删除指定的一个或多个元素\n\n```\n127.0.0.1:6379> srem mset1 3 4\n(integer) 2\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n\n（删除键，依然使用“del 键” 命令）\n```\n\n4. spop  键  \n>\t随机从集合中删除一个元素，并返回\n\n```\n127.0.0.1:6379> sadd mset2 4 5 6 7 8\n(integer) 5\n127.0.0.1:6379> spop mset2\n\"4\"\n127.0.0.1:6379> spop mset2\n\"5\"\n127.0.0.1:6379> spop mset2\n\"8\"\n127.0.0.1:6379> smembers mset2\n1) \"6\"\n2) \"7\"\n```\n\n5. srandmember  键  值\n>\t随机返回集合中一个元素，但不删除\n\n```\n127.0.0.1:6379> sadd mset3 4 5 6 7 8\n(integer) 5\n127.0.0.1:6379> srandmember mset3\n\"5\"\n127.0.0.1:6379> srandmember mset3\n\"5\"\n127.0.0.1:6379> srandmember mset3\n\"4\"\n```\n\n6. scard  键\n>\t获取集合里面元素个数\n\n```\n127.0.0.1:6379> scard mset1\n(integer) 2\n```\n\n7. sismember  键  值\n>\t确定一个指定的值是否是集合中的元素\n\n```\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n127.0.0.1:6379> sismember mset1 3\n(integer) 0\n127.0.0.1:6379> sismember mset1 1\n(integer) 1\n```\n\n8. sdiff  集合1  集合2\n>\t返回集合1与集合2的差集。以集合1为主\n\n```\n127.0.0.1:6379> sadd mset4 1 2 3\n(integer) 3\n127.0.0.1:6379> sadd mset5 2 3 4\n(integer) 3\n127.0.0.1:6379> sdiff mset4 mset5\n1) \"1\"\n```\n\n9. sdiffstore  新集合  集合1  集合2\n>\t返回集合1和集合2的差集，并把结果存入新集合\n\n```\n127.0.0.1:6379> sadd mset4 1 2 3\n(integer) 3\n127.0.0.1:6379> sadd mset5 2 3 4\n(integer) 3\n127.0.0.1:6379> sdiffstore mset6 mset5 mset4\n(integer) 1\t\t\t\t//返回值为1 ，证明成功\n127.0.0.1:6379> smembers mset6\n1) \"4\"\t\t\t\t\t//结果存入了mset6，值为4\n```\n\n10. sinter  集合1  集合2\n>\t获得两个集合的交集\n\n```\n127.0.0.1:6379> smembers mset4\n1) \"1\"\n2) \"2\"\n3) \"3\"\n127.0.0.1:6379> smembers mset5\n1) \"2\"\n2) \"3\"\n3) \"4\"\n127.0.0.1:6379> sinter mset4 mset5\n1) \"2\"\n2) \"3\"\n```\n\n11. sinterstore  新集合  集合1  集合2\n>\t获得集合1和集合2的交集，并把结果存入新集合\n\n```\n127.0.0.1:6379> sinterstore mset7 mset4 mset5\n(integer) 2\n127.0.0.1:6379> smembers mset7\n1) \"2\"\n2) \"3\"\n```\n\n12. sunion  集合1  集合2\n>\t获得指定集合的并集\n\n```\n127.0.0.1:6379> sunion mset4 mset5\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n13. sunionstore  新集合  集合1  集合2\n>\t获得指定集合的并集，并把结果保存如新集合\n\n```\n127.0.0.1:6379> sunionstore mset8 mset4 mset5\n(integer) 4\n127.0.0.1:6379> smembers mset8\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n14. smove  源集合  目标集合  值\n>\t将指定的值从源集合移动到目标集合\n\n```\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n127.0.0.1:6379> smembers mset2\n1) \"6\"\n2) \"7\"\n127.0.0.1:6379> smove mset1 mset2 1\n(integer) 1\n127.0.0.1:6379> smembers mset1\n1) \"2\"\n127.0.0.1:6379> smembers mset2\n1) \"1\"\n2) \"6\"\n3) \"7\"\n```\n\n## sorted sets类型和操作\nsorted set是set的一个升级版本，它给集合中每个元素都定义一个分数，集合中的元素按照其分数排序。也不允许有重复值\n\n1. zadd  键  分数1  值1  [分数2  值2…]\n> 该命令添加指定的成员到key对应的有序集合中，每个成员都有一个分数。你可以指定多个分数/成员组合。如果一个指定的成员已经在对应的有序集合中了，那么其分数就会被更新成最新的，并且该成员会重新调整到正确的位置，以确保集合有序。分数的值必须是一个表示数字的字符串，并且可以是double类型的浮点数。\n\n```\n127.0.0.1:6379> zadd zset1 1 lm 2 sc 3 glf\n(integer) 3\n127.0.0.1:6379> zadd zset1 1 ymj\n(integer) 1\n```\n\n2. zrange  集合  起始下标  截止下标  [withscores]\n>\t返回有序集合中，指定区间内的成员。其中成员按照score（分数）值从小到大排序。具有相同score值的成员按照字典顺序来排列。\n>\n>\t起始下标与截止下标和list类型一致：\n>\t-\t0代表队列中第一个元素，1代表第二个元素，依次类推\n>\t-\t-1代表队列中最后一个元素，-2代表倒数第二个元素\n>\n>\twithscores：返回集合中元素的同时，返回其分数（score）\n\n```\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"lm\"\n2) \"1\"\n3) \"ymj\"\n4) \"1\"\n5) \"sc\"\n6) \"2\"\n7) \"glf\"\n8) \"3\"\n```\n\n3. zrevrange  集合  起始下标  截止下标  [withscores]\n>\t返回有序集合中，指定区间的成员。其成员按照score从大到小来排列。\n\n```\n127.0.0.1:6379> zrevrange zset1 0 -1 withscores\n1) \"glf\"\t\t//下标为0\n2) \"3\"\n3) \"sc\"\t\t\t//下标为1\n4) \"2\"\n5) \"ymj\"\t\t//下标为2\n6) \"1\"\n7) \"lm\"\t\t\t//下标为3\n8) \"1\"\n\n127.0.0.1:6379> zrevrange zset1 1 2 withscores\t\t//查看集合中下标是1-2的值\n1) \"sc\"\n2) \"2\"\n3) \"ymj\"\n4) \"1\"\n```\n\n4. zrangebyscore  集合  起始分数  截止分数  withscores\n>\t返回有序集合中score（分数）在指定区间的值\n\n```\n127.0.0.1:6379> zadd zset2 1 one 2 two 3 three 4 four\n(integer) 4\n127.0.0.1:6379> zrange zset2 0 -1 withscores\t\t//按照下标区间返回值\n1) \"one\"\n2) \"1\"\n3) \"two\"\n4) \"2\"\n5) \"three\"\n6) \"3\"\n7) \"four\"\n8) \"4\"\n\n127.0.0.1:6379> zrangebyscore zset2 2 3 withscores\t//按照分数区间返回值\n1) \"two\"\n2) \"2\"\n3) \"three\"\n4) \"3\"\n```\n\n5. zrem  集合  值1  [值2…]\n>\t删除有序集合中指定的值\n\n```\n127.0.0.1:6379> zrem zset1 lm\n(integer) 1\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"ymj\"\n2) \"1\"\n3) \"sc\"\n4) \"2\"\n5) \"glf\"\n6) \"3\"\n```\n\n6. zincrby  集合  增量  值\n>\t给有序集合中指定值的成员的分数（score）值加上增量（increment）。如果集合中没有这个值，则给添加一个分数是increment的值。\n\n```\n127.0.0.1:6379> zincrby zset1 2 ymj\t\t//如果值存在，则在其分数上加增量\n\"3\"\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n\n127.0.0.1:6379> zincrby zset1 4 bro\t\t//如果值不存在，则加入值。并指定分数为增\"4\"\t\t\t\t\t\t\t\t\t\t量\n\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n7) \"bro\"\n8) \"4\"\n```\n\n7. zrank  集合  值\n>\t返回有序集合中指定值的下标。值按照score从小到大排序\n\n```\n127.0.0.1:6379> zrank zset1 sc\n(integer) 0\n127.0.0.1:6379> zrank zset1 ymj\n(integer) 2\n```\n\n8. zrevrank  集合  值\n>\t返回有序集合中指定值的下标，值按照score从大到小排序\n\n```\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n7) \"bro\"\n8) \"4\"\n127.0.0.1:6379> zrevrank zset1 ymj\n(integer) 1\n127.0.0.1:6379> zrevrank zset1 sc\n(integer) 3\n```\n\n9. zcount  集合  起始分数  截止分数\n>\t返回有序集合中，score值在起始分数与截止分数之间的个数\n\n```\n127.0.0.1:6379> zrange zset2 0 -1 withscores\n1) \"one\"\n2) \"1\"\n3) \"two\"\n4) \"2\"\n5) \"three\"\n6) \"3\"\n7) \"four\"\n8) \"4\"\n\n127.0.0.1:6379> zcount zset2 2 4\n(integer) 3\n```\n\n10. zcard  集合\n>\t返回有序集合元素的个数\n\n```\n127.0.0.1:6379> zcard zset2\n(integer) 4\n```\n\n11. zremrangebyrank  集合  起始下标  结束下标\n>\t删除有序集合中，下标在指定区间的元素\n\n```\n127.0.0.1:6379> zrange zset2 0 -1 withscores\n1) \"one\"\n2) \"1\"\n3) \"two\"\n4) \"2\"\n5) \"three\"\n6) \"3\"\n7) \"four\"\n8) \"4\"\n127.0.0.1:6379> ZREMRANGEBYRANK zset2 0 1\n(integer) 2\n127.0.0.1:6379> zrange zset2 0 -1 withscores\n1) \"three\"\n2) \"3\"\n3) \"four\"\n4) \"4\"\n```\n\n12. zremrangebyscore  集合  起始分数  截止分数\n> 删除有序集合中，分数在指定区间的元素\n\n```\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n7) \"bro\"\n8) \"4\"\n127.0.0.1:6379> ZREMRANGEBYSCORE zset1 2 3\n(integer) 3\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"bro\"\n2) \"4\"\n```\n\n13. zinterstore  新集合  取交集的集合个数  集合1 集合2\n>\t取集合1和集合2的交集，并把结果保存到新集合中。在计算交集之前，需要指定计算交集的集合的个数。交集中，值的分数是多个集合中分数的和。\n\n```\n127.0.0.1:6379> zadd zset1 1 one 2 two 3 three 4 four\n(integer) 4\n127.0.0.1:6379> zadd zset2  2 two 3 three 4 four 5 five\n(integer) 4\n127.0.0.1:6379> ZINTERSTORE zset3 2 zset1 zset2 \t\n//有两个集合计算交集，所以集合个数是2\n(integer) 3\n127.0.0.1:6379> ZRANGE zset3 0 -1 withscores\n1) \"two\"\n2) \"4\"\t\t\t\t//分数是两个集合中two值的分数和\n3) \"three\"\n4) \"6\"\n5) \"four\"\n6) \"8\"\n```\n\n14. zunionstore  新集合  取并集的集合个数  集合1 集合2\n>\t取集合1和集合2的并集，并把结果保存到新集合中。在计算并集之前，需要指定计算并集的集合的个数。并集中，值的分数是多个集合中分数的和。\n\n```\n127.0.0.1:6379> zadd zset1 1 one 2 two 3 three 4 four\n(integer) 4\n127.0.0.1:6379> zadd zset2  2 two 3 three 4 four 5 five\n(integer) 4\n127.0.0.1:6379> ZUNIONSTORE zset4 2 zset1 zset2\n(integer) 5\n127.0.0.1:6379> ZRANGE zset4 0 -1 withscores\n 1) \"one\"\n 2) \"1\"\n 3) \"two\"\n 4) \"4\"\n 5) \"five\"\n 6) \"5\"\n 7) \"three\"\n 8) \"6\"\n 9) \"four\"\n10) \"8\"\n```\n","source":"_posts/Redis数据类型与操作.md","raw":"---\ntitle: Redis数据类型与操作\ndate: 2016-09-27 20:30:00\ntags:\n- Redis\ncategories:\n- Linux\n---\n\nRedis共有5种数据类型\n- string(字符串)\n- hash(哈希表)\n- list(双向队列)\n- set(集合)\n- zset(有序集合)\n\n<!-- more -->\n\n## String（子串类型）\nString是最简单的类型，一个Key对应一个Value，string类型是二进制安全的。Redis的string可以包含任何数据，比如jpg图片或者序列化的对象。\n\n1. set 键  \"值\"\n> 设置一个键和值，键存在则覆盖，返回ok\n\n```\n127.0.0.1:6379> set name liming\nOK\n```\n\n2. get 键\n> 获取一个键的值，返回值\n\n```  \t   \n127.0.0.1:6379> get name\n\"liming\"\n```\n\n3. setnx 键 值\n> 只有当该键不存在时设置一个键的值，若键已存在则返回0表示失败（防止覆盖），\n\n```\n127.0.0.1:6379> setnx age 18\n(integer) 1\n127.0.0.1:6379> setnx age 18\n(integer) 0\n```\n\n4.  setex 键 [有效时间] 值\n> 设置一个指定有效期的键和值（单位秒）。不写有效时间则表示永久有效，等价于set\n\n```   \n127.0.0.1:6379> setex movie 30 canglaoshi\nOK\n127.0.0.1:6379> ttl movie\t\t\t\t//获取键的有效时间\n(integer) 26\n127.0.0.1:6379> ttl movie\n(integer) 20\n127.0.0.1:6379> get movie\n\"canglaoshi\"\n127.0.0.1:6379> ttl movie\n(integer) -2\n127.0.0.1:6379> get movie\n(nil)\n```\n\n4. ttl 键\n> 以秒为单位，返回给定 key 的剩余生存时间\n> - 当 key 不存在时，返回 -2 。\n>\t-\t当 key 存在但没有设置剩余生存时间时，返回 -1 。\n>\t-\t否则，以秒为单位，返回 key 的剩余生存时间。\n\n\n5. setrange 键 位置 子字串\n> 替换子字符串 (替换长度由子子串长度决定)\n\n```\n127.0.0.1:6379> set key1 \"hello world\"\nOK\n127.0.0.1:6379> get key1\n\"hello world\"\n127.0.0.1:6379> setrange key1 6 liming\n(integer) 12\n127.0.0.1:6379> get key1\n\"hello liming\"\n\t#将key1键对应值的第6个位置开始替换（字符串位置从0开始计算）\n```\n\n6. mset 键1 值1 键2 值2 键3 值3 ....\n> 批量设置键和值,成功则返回ok\n\n```\n127.0.0.1:6379> mset name1 lm name2 sc name3 zjj\nOK\n```\n\n7. mget 键1 键2 键3....\n> 批量获取值\n\n```\n127.0.0.1:6379> mget name1 name2 name3\n1) \"lm\"\n2) \"sc\"\n3) \"zjj\"\n```\n\n8. msetnx 键1 值1 键2 值2 键3 值3 ....\n> 批量设置不存在的键和值,成功则返回ok\n\n\n9. getset 键 新值\n> 获取原值，并设置新值\n\n```\n127.0.0.1:6379> set name \"shen chao\"\nOK\n127.0.0.1:6379> get name\n\"shen chao\"\n127.0.0.1:6379> getset name \"liming\"\n\"shen chao\"\n127.0.0.1:6379> get name\n\"liming\"\n```\n\n10. getrange 键 0 4  \n> 获取指定范围的值（获取指定0到4位置上的值，字符串位置从0开始计算）\n\n```\n127.0.0.1:6379> getrange key1 0 4\n\"hello\"\n```\n\n11. incr 键  \n> 指定键的值做加1操作，返回加后的结果（只能加数字）。\n\n```\n127.0.0.1:6379> set age 18\nOK\n127.0.0.1:6379> incr age\n(integer) 19\n127.0.0.1:6379> get age\n\"19\"\n```\n\n12. incrby 键 m    \n> 其中m可以是正整数或负整数.加指定值，键不存在时候会设置键\n\n```\n127.0.0.1:6379> incrby age 10\n(integer) 29\n127.0.0.1:6379> get age\n\"29\"\n127.0.0.1:6379> incrby age -5\n(integer) 24\n```\n\n13. decr 键\n> 指定键的值做减1操作，返回减后的结果。\n\n```    \n127.0.0.1:6379> decr age\n(integer) 23\n127.0.0.1:6379> get age\n\"23\"\n```\n\n14. decrby 键 n\n> 其中n可以是正整数或负整数.设置某个键减上指定值\n\n```\n127.0.0.1:6379> decrby age 5\n(integer) 18\n127.0.0.1:6379> decrby age -10\n(integer) 28\n127.0.0.1:6379> get age\n\"28\"\n```\n\n15. append  键 追加字串\n> 给指定key的字符串追加value，返回新字符串值的长度\n\n``` \t\n127.0.0.1:6379> append name1 \" have a hot body!\"\n(integer) 19\n127.0.0.1:6379> get name1\n\"lm have a hot body!\"\n```\n\n16. strlen 键名\n> strlen求一个键长度\n\n```\n127.0.0.1:6379> strlen name1\n(integer) 19\n```\n\n17. del命令：\n> 删除一个键\n\n```\n127.0.0.1:6379> del name3\n(integer) 1\n127.0.0.1:6379> get name3\n(nil)\n```\n\n## hashs类型\n> 注意：redis中没有表概念，所有的数据都存入键中。\n> - string键类型：所有的值（可以是任何数据类型）都保存在一个键当中，放在一个内存块中\n>\t- hashs键类型：所有的值也都保存在一个键当中，只是放在不同的内存块中，每个块称作字段\n\n1. hset key field value\n> 设置一个键，在键中保存字段和值\n> 格式： hset 哈希集（键） 字段 值\n\n```\n127.0.0.1:6379> hset user1 name4 ysm\n(integer) 1\n127.0.0.1:6379> keys *\t\t\t\t\t//查看库中所有的键\n1) \"aa\"\n2) \"name\"\n3) \"name1\"\n4) \"user1\"\n5) \"name2\"\n6) \"age\"\n7) \"key1\"\n```\n\n2. hsetnx  键  字段  值\n>\t设置一个键中，不存在的字段和值。如果字段存在则报错（成功返回1，失败返回0）\n\n```\n127.0.0.1:6379> hsetnx user1 name1 lm\n(integer) 1\n127.0.0.1:6379> hsetnx user1 name1 sc\n(integer) 0\t\t\t\t\t//报错\n127.0.0.1:6379> hget user1 name1\n\"lm\"\t\t\t\t\t\t//内容没有更新\n```\n\n3. hmset  键  字段1  值1  字段2  值2 …\n>\t在一个键中，批量设置字段\n\n```\n127.0.0.1:6379> hmset user2 name liming age 36 interest AV-Girl\nOK\n```\n\n4. hget 键 字段\n>\t获取键中的一个指定字段的值\n\n```\n127.0.0.1:6379> hget user1 name1\n\"lm\"\n127.0.0.1:6379> hget user2 interest\n\"AV-Girl\"\n```\n\n5. hmget 键 字段1 [字段2…]\n>\t获取键中一个或多个字段的值\n\n```\n127.0.0.1:6379> hmget user2 name age interest\n1) \"liming\"\n2) \"36\"\n3) \"AV-Girl\"\n```\n\n6. hexists ：\n> 判断指定的字段是否存在于键中\n\n```\n127.0.0.1:6379> HEXISTS user2 age\n(integer) 1\t\t\t\t\t\t\t//存在\n127.0.0.1:6379> HEXISTS user1 age\n(integer) 0\t\t\t\t\t\t\t//不存在\n```\n\n7. hlen ：获取键中的字段数量\n\n```\n127.0.0.1:6379> hlen user2\n(integer) 3\t\t\t\t\t\t\t//user2键中有3个字段\n```\n\n8. hkeys ：获取键中的所有字段名\n\n```\n127.0.0.1:6379> hkeys user2\n1) \"name\"\n2) \"age\"\n3) \"interest\"\n```\n\n9. hvals：获取键中所有字段的值\n\n```\n127.0.0.1:6379> hvals user2\n1) \"liming\"\n2) \"36\"\n3) \"AV-Girl\"\n```\n\n10. hgetall ：获取键中的所有字段和值\n\n```\n127.0.0.1:6379> hgetall user2\n1) \"name\"\n2) \"liming\"\n3) \"age\"\n4) \"36\"\n5) \"interest\"\n6) \"AV-Girl\"\n```\n\n11. hincrby：将键中指定字段的值，增加指定的数字\n\n```\n127.0.0.1:6379> hincrby user2 age 5\n(integer) 41\n\n127.0.0.1:6379> HINCRBY user2 name 5\n(error) ERR hash value is not an integer\t//值不是数字的字段，不能加数字\n```\n\n12. hdel 键 字段1 字段2\n>\t删除键中的一个或多个字段\n\n```\n127.0.0.1:6379> hdel user2 age interest\n(integer) 2\n127.0.0.1:6379> hkeys user2\n1) \"name\"\n\t//删除一个键，还是要使用del命令\n```\n\n\n\n## list类型（双向链表结构）\nList是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等，操作中key理解为链表的名字。Redis的list类型其实就是一个每个子元素都是string类型的双向链表。列表允许有重复值\n\n1. lpush 键 值1 [值2…]\n> 从队列左边向队列写入一个或多个值（认为队列的左面为队列头，右边为队列尾）\n\n```\n127.0.0.1:6379> lpush list1 1\n(integer) 1\n127.0.0.1:6379> lpush list1 2\n(integer) 2\n127.0.0.1:6379> lpush list1 3\n(integer) 3\n127.0.0.1:6379> lpush list1 4\n(integer) 4\n\n127.0.0.1:6379> lpush list2 one two three four\n(integer) 4\n```\n\n2. lrange 键 起始下标 终止下标\n>\t从队列中获取指定的返回值（从队列左边向右获取）\n> 下标：\n> - 0代表队列中第一个元素，1代表第二个元素，依次类推\n> - -1代表队列中最后一个元素，-2代表倒数第二个元素\n\n```\n127.0.0.1:6379> LRANGE list1 0 -1\n1) \"4\"\t\t//4是从左面写入队列的最后一个值，所以在队列的开头\n2) \"3\"\n3) \"2\"\n4) \"1\"\t\t//1是从左面写入队列的第一个值，所以直接放到了队列尾。\n\n127.0.0.1:6379> LRANGE list2 0 -1\n1) \"four\"\n2) \"three\"\n3) \"two\"\n4) \"one\"\n\n127.0.0.1:6379> LRANGE list1 0 1\n1) \"4\"\n2) \"3\"\n\n127.0.0.1:6379> LRANGE list2 -4 3\n1) \"four\"\t\t//-4代表从队列右边数第四个元素\n2) \"three\"\n3) \"two\"\n4) \"one\"\t\t//3代表从队列左边数第四个元素\n```\n\n3. rpush 键 值1 [值2…]\n>\t从队列右边向队列写入一个或多个值\n\n```\n127.0.0.1:6379> RPUSH list3 1 2 3 4\n(integer) 4\n127.0.0.1:6379> LRANGE list3 0 -1\n1) \"1\"\t\t//从队列右边向队列写入值，第一个值就会写到队列的开头\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n4. linsert  键  before|after  原值  新值\n>\t在队列中指定元素之前或之后插入新值\n\n```\n127.0.0.1:6379> LINSERT list3 before 3 hello\n(integer) 5\n127.0.0.1:6379> LRANGE list3 0 -1\n1) \"1\"\n2) \"2\"\n3) \"hello\"\n4) \"3\"\n5) \"4\"\n```\n\n5. lset  键  下标  新值\n>\t给队列中指定元素设定新值\n\n```\n127.0.0.1:6379> lset list3 2 \"5\"\nOK\n127.0.0.1:6379> LRANGE list3 0 -1\n1) \"1\"\n2) \"2\"\n3) \"5\"\n4) \"3\"\n5) \"4\"\n```\n\n6. lerm  键  n  指定值\n> 从队列中删除n个值为“指定值”的元素\n>\t- n > 0 \t从队列头向尾删除n个元素\n>\t- n < 0 \t从队列尾向头删除n个元素\n>\t- n = 0\t删除所有值为“指定值”的元素\n\n```\n127.0.0.1:6379> rpush list4 hello 1 hello 2 hello 3 hello\n(integer) 7\n127.0.0.1:6379> lrange list4 0 -1\n1) \"hello\"\n2) \"1\"\n3) \"hello\"\n4) \"2\"\n5) \"hello\"\n6) \"3\"\n7) \"hello\"\n127.0.0.1:6379> lrem list4 -2 hello\t\t\t//删除后两个hello\n(integer) 2\n127.0.0.1:6379> lrange list4 0 -1\n1) \"hello\"\n2) \"1\"\n3) \"hello\"\n4) \"2\"\n5) \"3\"\n127.0.0.1:6379> lrem list4 0 hello\t\t\t//删除所有hello\n(integer) 2\n127.0.0.1:6379> lrange list4 0 -1\n1) \"1\"\n2) \"2\"\n3) \"3\"\n```\n\n7. ltrim  键  起始下标  结束下标\n>\t修剪队列，让队列只保留指定指定范围内的元素\n\n```\n127.0.0.1:6379> RPUSH list5 1 2 3 4\n(integer) 4\n127.0.0.1:6379> ltrim list5 1 2\nOK\n127.0.0.1:6379> lrange list5 0 -1\n1) \"2\"\n2) \"3\"\n```\n\n8. lpop  键\n>\t从指定的队列左面移除一个值\n\n```\n127.0.0.1:6379> lrange list1 0 -1\n1) \"4\"\n2) \"3\"\n3) \"2\"\n4) \"1\"\n127.0.0.1:6379> lpop list1\n\"4\"\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n3) \"1\"\n```\n\n9. rpop  键\n>\t从指定队列的右边移除一个值\n\n```\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n3) \"1\"\n127.0.0.1:6379> rpop list1\n\"1\"\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n```\n\n10. rpoplpush  源队列  目标队列\n>\t移除源队列的最后一个元素，并把该元素写入目标队列\n\n```\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n2) \"2\"\n127.0.0.1:6379> lrange list5 0 -1\n1) \"2\"\n2) \"3\"\n127.0.0.1:6379> RPOPLPUSH list1 list5\n\"2\"\n127.0.0.1:6379> lrange list1 0 -1\n1) \"3\"\n127.0.0.1:6379> lrange list5 0 -1\n1) \"2\"\n2) \"2\"\n3) \"3\"\n```\n\n11. lindex  键  下标\n>\t获取队列中指定下标元素的值\n\n```\n127.0.0.1:6379> lrange list2 0 -1\n1) \"four\"\n2) \"three\"\n3) \"two\"\n4) \"one\"\n127.0.0.1:6379> lindex list2 1\n\"three\"\n127.0.0.1:6379> lindex list2 3\n\"one\"\n```\n\n12. llen  键\n>\t获得队列的长度\n\n```\n127.0.0.1:6379> llen list2\n(integer) 4\n```\n\n\n## sets类型和操作\n\nSet是集合，它是string类型的无序集合。对集合我们可以取并集、交集、差集。通过这些操作我们可以实现社交网站中的好友推荐和blog的tag功能。集合不允许有重复值。\n\n1. sadd  键  值1[值2…]\n>\t添加一个或多个元素到集合中\n\n```\n127.0.0.1:6379> sadd mset1 1\n(integer) 1\n127.0.0.1:6379> sadd mset1 2 3 4\n(integer) 3\n```\n2. smembers  键\n>\t获取集合里面所有的元素\n\n```\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n3. srem  键  值1[值2…]\n>\t从集合中删除指定的一个或多个元素\n\n```\n127.0.0.1:6379> srem mset1 3 4\n(integer) 2\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n\n（删除键，依然使用“del 键” 命令）\n```\n\n4. spop  键  \n>\t随机从集合中删除一个元素，并返回\n\n```\n127.0.0.1:6379> sadd mset2 4 5 6 7 8\n(integer) 5\n127.0.0.1:6379> spop mset2\n\"4\"\n127.0.0.1:6379> spop mset2\n\"5\"\n127.0.0.1:6379> spop mset2\n\"8\"\n127.0.0.1:6379> smembers mset2\n1) \"6\"\n2) \"7\"\n```\n\n5. srandmember  键  值\n>\t随机返回集合中一个元素，但不删除\n\n```\n127.0.0.1:6379> sadd mset3 4 5 6 7 8\n(integer) 5\n127.0.0.1:6379> srandmember mset3\n\"5\"\n127.0.0.1:6379> srandmember mset3\n\"5\"\n127.0.0.1:6379> srandmember mset3\n\"4\"\n```\n\n6. scard  键\n>\t获取集合里面元素个数\n\n```\n127.0.0.1:6379> scard mset1\n(integer) 2\n```\n\n7. sismember  键  值\n>\t确定一个指定的值是否是集合中的元素\n\n```\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n127.0.0.1:6379> sismember mset1 3\n(integer) 0\n127.0.0.1:6379> sismember mset1 1\n(integer) 1\n```\n\n8. sdiff  集合1  集合2\n>\t返回集合1与集合2的差集。以集合1为主\n\n```\n127.0.0.1:6379> sadd mset4 1 2 3\n(integer) 3\n127.0.0.1:6379> sadd mset5 2 3 4\n(integer) 3\n127.0.0.1:6379> sdiff mset4 mset5\n1) \"1\"\n```\n\n9. sdiffstore  新集合  集合1  集合2\n>\t返回集合1和集合2的差集，并把结果存入新集合\n\n```\n127.0.0.1:6379> sadd mset4 1 2 3\n(integer) 3\n127.0.0.1:6379> sadd mset5 2 3 4\n(integer) 3\n127.0.0.1:6379> sdiffstore mset6 mset5 mset4\n(integer) 1\t\t\t\t//返回值为1 ，证明成功\n127.0.0.1:6379> smembers mset6\n1) \"4\"\t\t\t\t\t//结果存入了mset6，值为4\n```\n\n10. sinter  集合1  集合2\n>\t获得两个集合的交集\n\n```\n127.0.0.1:6379> smembers mset4\n1) \"1\"\n2) \"2\"\n3) \"3\"\n127.0.0.1:6379> smembers mset5\n1) \"2\"\n2) \"3\"\n3) \"4\"\n127.0.0.1:6379> sinter mset4 mset5\n1) \"2\"\n2) \"3\"\n```\n\n11. sinterstore  新集合  集合1  集合2\n>\t获得集合1和集合2的交集，并把结果存入新集合\n\n```\n127.0.0.1:6379> sinterstore mset7 mset4 mset5\n(integer) 2\n127.0.0.1:6379> smembers mset7\n1) \"2\"\n2) \"3\"\n```\n\n12. sunion  集合1  集合2\n>\t获得指定集合的并集\n\n```\n127.0.0.1:6379> sunion mset4 mset5\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n13. sunionstore  新集合  集合1  集合2\n>\t获得指定集合的并集，并把结果保存如新集合\n\n```\n127.0.0.1:6379> sunionstore mset8 mset4 mset5\n(integer) 4\n127.0.0.1:6379> smembers mset8\n1) \"1\"\n2) \"2\"\n3) \"3\"\n4) \"4\"\n```\n\n14. smove  源集合  目标集合  值\n>\t将指定的值从源集合移动到目标集合\n\n```\n127.0.0.1:6379> smembers mset1\n1) \"1\"\n2) \"2\"\n127.0.0.1:6379> smembers mset2\n1) \"6\"\n2) \"7\"\n127.0.0.1:6379> smove mset1 mset2 1\n(integer) 1\n127.0.0.1:6379> smembers mset1\n1) \"2\"\n127.0.0.1:6379> smembers mset2\n1) \"1\"\n2) \"6\"\n3) \"7\"\n```\n\n## sorted sets类型和操作\nsorted set是set的一个升级版本，它给集合中每个元素都定义一个分数，集合中的元素按照其分数排序。也不允许有重复值\n\n1. zadd  键  分数1  值1  [分数2  值2…]\n> 该命令添加指定的成员到key对应的有序集合中，每个成员都有一个分数。你可以指定多个分数/成员组合。如果一个指定的成员已经在对应的有序集合中了，那么其分数就会被更新成最新的，并且该成员会重新调整到正确的位置，以确保集合有序。分数的值必须是一个表示数字的字符串，并且可以是double类型的浮点数。\n\n```\n127.0.0.1:6379> zadd zset1 1 lm 2 sc 3 glf\n(integer) 3\n127.0.0.1:6379> zadd zset1 1 ymj\n(integer) 1\n```\n\n2. zrange  集合  起始下标  截止下标  [withscores]\n>\t返回有序集合中，指定区间内的成员。其中成员按照score（分数）值从小到大排序。具有相同score值的成员按照字典顺序来排列。\n>\n>\t起始下标与截止下标和list类型一致：\n>\t-\t0代表队列中第一个元素，1代表第二个元素，依次类推\n>\t-\t-1代表队列中最后一个元素，-2代表倒数第二个元素\n>\n>\twithscores：返回集合中元素的同时，返回其分数（score）\n\n```\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"lm\"\n2) \"1\"\n3) \"ymj\"\n4) \"1\"\n5) \"sc\"\n6) \"2\"\n7) \"glf\"\n8) \"3\"\n```\n\n3. zrevrange  集合  起始下标  截止下标  [withscores]\n>\t返回有序集合中，指定区间的成员。其成员按照score从大到小来排列。\n\n```\n127.0.0.1:6379> zrevrange zset1 0 -1 withscores\n1) \"glf\"\t\t//下标为0\n2) \"3\"\n3) \"sc\"\t\t\t//下标为1\n4) \"2\"\n5) \"ymj\"\t\t//下标为2\n6) \"1\"\n7) \"lm\"\t\t\t//下标为3\n8) \"1\"\n\n127.0.0.1:6379> zrevrange zset1 1 2 withscores\t\t//查看集合中下标是1-2的值\n1) \"sc\"\n2) \"2\"\n3) \"ymj\"\n4) \"1\"\n```\n\n4. zrangebyscore  集合  起始分数  截止分数  withscores\n>\t返回有序集合中score（分数）在指定区间的值\n\n```\n127.0.0.1:6379> zadd zset2 1 one 2 two 3 three 4 four\n(integer) 4\n127.0.0.1:6379> zrange zset2 0 -1 withscores\t\t//按照下标区间返回值\n1) \"one\"\n2) \"1\"\n3) \"two\"\n4) \"2\"\n5) \"three\"\n6) \"3\"\n7) \"four\"\n8) \"4\"\n\n127.0.0.1:6379> zrangebyscore zset2 2 3 withscores\t//按照分数区间返回值\n1) \"two\"\n2) \"2\"\n3) \"three\"\n4) \"3\"\n```\n\n5. zrem  集合  值1  [值2…]\n>\t删除有序集合中指定的值\n\n```\n127.0.0.1:6379> zrem zset1 lm\n(integer) 1\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"ymj\"\n2) \"1\"\n3) \"sc\"\n4) \"2\"\n5) \"glf\"\n6) \"3\"\n```\n\n6. zincrby  集合  增量  值\n>\t给有序集合中指定值的成员的分数（score）值加上增量（increment）。如果集合中没有这个值，则给添加一个分数是increment的值。\n\n```\n127.0.0.1:6379> zincrby zset1 2 ymj\t\t//如果值存在，则在其分数上加增量\n\"3\"\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n\n127.0.0.1:6379> zincrby zset1 4 bro\t\t//如果值不存在，则加入值。并指定分数为增\"4\"\t\t\t\t\t\t\t\t\t\t量\n\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n7) \"bro\"\n8) \"4\"\n```\n\n7. zrank  集合  值\n>\t返回有序集合中指定值的下标。值按照score从小到大排序\n\n```\n127.0.0.1:6379> zrank zset1 sc\n(integer) 0\n127.0.0.1:6379> zrank zset1 ymj\n(integer) 2\n```\n\n8. zrevrank  集合  值\n>\t返回有序集合中指定值的下标，值按照score从大到小排序\n\n```\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n7) \"bro\"\n8) \"4\"\n127.0.0.1:6379> zrevrank zset1 ymj\n(integer) 1\n127.0.0.1:6379> zrevrank zset1 sc\n(integer) 3\n```\n\n9. zcount  集合  起始分数  截止分数\n>\t返回有序集合中，score值在起始分数与截止分数之间的个数\n\n```\n127.0.0.1:6379> zrange zset2 0 -1 withscores\n1) \"one\"\n2) \"1\"\n3) \"two\"\n4) \"2\"\n5) \"three\"\n6) \"3\"\n7) \"four\"\n8) \"4\"\n\n127.0.0.1:6379> zcount zset2 2 4\n(integer) 3\n```\n\n10. zcard  集合\n>\t返回有序集合元素的个数\n\n```\n127.0.0.1:6379> zcard zset2\n(integer) 4\n```\n\n11. zremrangebyrank  集合  起始下标  结束下标\n>\t删除有序集合中，下标在指定区间的元素\n\n```\n127.0.0.1:6379> zrange zset2 0 -1 withscores\n1) \"one\"\n2) \"1\"\n3) \"two\"\n4) \"2\"\n5) \"three\"\n6) \"3\"\n7) \"four\"\n8) \"4\"\n127.0.0.1:6379> ZREMRANGEBYRANK zset2 0 1\n(integer) 2\n127.0.0.1:6379> zrange zset2 0 -1 withscores\n1) \"three\"\n2) \"3\"\n3) \"four\"\n4) \"4\"\n```\n\n12. zremrangebyscore  集合  起始分数  截止分数\n> 删除有序集合中，分数在指定区间的元素\n\n```\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"sc\"\n2) \"2\"\n3) \"glf\"\n4) \"3\"\n5) \"ymj\"\n6) \"3\"\n7) \"bro\"\n8) \"4\"\n127.0.0.1:6379> ZREMRANGEBYSCORE zset1 2 3\n(integer) 3\n127.0.0.1:6379> zrange zset1 0 -1 withscores\n1) \"bro\"\n2) \"4\"\n```\n\n13. zinterstore  新集合  取交集的集合个数  集合1 集合2\n>\t取集合1和集合2的交集，并把结果保存到新集合中。在计算交集之前，需要指定计算交集的集合的个数。交集中，值的分数是多个集合中分数的和。\n\n```\n127.0.0.1:6379> zadd zset1 1 one 2 two 3 three 4 four\n(integer) 4\n127.0.0.1:6379> zadd zset2  2 two 3 three 4 four 5 five\n(integer) 4\n127.0.0.1:6379> ZINTERSTORE zset3 2 zset1 zset2 \t\n//有两个集合计算交集，所以集合个数是2\n(integer) 3\n127.0.0.1:6379> ZRANGE zset3 0 -1 withscores\n1) \"two\"\n2) \"4\"\t\t\t\t//分数是两个集合中two值的分数和\n3) \"three\"\n4) \"6\"\n5) \"four\"\n6) \"8\"\n```\n\n14. zunionstore  新集合  取并集的集合个数  集合1 集合2\n>\t取集合1和集合2的并集，并把结果保存到新集合中。在计算并集之前，需要指定计算并集的集合的个数。并集中，值的分数是多个集合中分数的和。\n\n```\n127.0.0.1:6379> zadd zset1 1 one 2 two 3 three 4 four\n(integer) 4\n127.0.0.1:6379> zadd zset2  2 two 3 three 4 four 5 five\n(integer) 4\n127.0.0.1:6379> ZUNIONSTORE zset4 2 zset1 zset2\n(integer) 5\n127.0.0.1:6379> ZRANGE zset4 0 -1 withscores\n 1) \"one\"\n 2) \"1\"\n 3) \"two\"\n 4) \"4\"\n 5) \"five\"\n 6) \"5\"\n 7) \"three\"\n 8) \"6\"\n 9) \"four\"\n10) \"8\"\n```\n","slug":"Redis数据类型与操作","published":1,"updated":"2016-10-07T14:58:06.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxd003w699f5tga7smm","content":"<p>Redis共有5种数据类型</p>\n<ul>\n<li>string(字符串)</li>\n<li>hash(哈希表)</li>\n<li>list(双向队列)</li>\n<li>set(集合)</li>\n<li>zset(有序集合)</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"String（子串类型）\"><a href=\"#String（子串类型）\" class=\"headerlink\" title=\"String（子串类型）\"></a>String（子串类型）</h2><p>String是最简单的类型，一个Key对应一个Value，string类型是二进制安全的。Redis的string可以包含任何数据，比如jpg图片或者序列化的对象。</p>\n<ol>\n<li>set 键  “值”<blockquote>\n<p>设置一个键和值，键存在则覆盖，返回ok</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set name liming</div><div class=\"line\">OK</div></pre></td></tr></table></figure>\n<ol>\n<li>get 键<blockquote>\n<p>获取一个键的值，返回值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; get name</div><div class=\"line\">&quot;liming&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>setnx 键 值<blockquote>\n<p>只有当该键不存在时设置一个键的值，若键已存在则返回0表示失败（防止覆盖），</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; setnx age 18</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; setnx age 18</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<ol>\n<li>setex 键 [有效时间] 值<blockquote>\n<p>设置一个指定有效期的键和值（单位秒）。不写有效时间则表示永久有效，等价于set</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; setex movie 30 canglaoshi</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; ttl movie\t\t\t\t//获取键的有效时间</div><div class=\"line\">(integer) 26</div><div class=\"line\">127.0.0.1:6379&gt; ttl movie</div><div class=\"line\">(integer) 20</div><div class=\"line\">127.0.0.1:6379&gt; get movie</div><div class=\"line\">&quot;canglaoshi&quot;</div><div class=\"line\">127.0.0.1:6379&gt; ttl movie</div><div class=\"line\">(integer) -2</div><div class=\"line\">127.0.0.1:6379&gt; get movie</div><div class=\"line\">(nil)</div></pre></td></tr></table></figure>\n<ol>\n<li>ttl 键<blockquote>\n<p>以秒为单位，返回给定 key 的剩余生存时间</p>\n<ul>\n<li>当 key 不存在时，返回 -2 。<ul>\n<li>当 key 存在但没有设置剩余生存时间时，返回 -1 。</li>\n<li>否则，以秒为单位，返回 key 的剩余生存时间。</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<ol>\n<li>setrange 键 位置 子字串<blockquote>\n<p>替换子字符串 (替换长度由子子串长度决定)</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set key1 &quot;hello world&quot;</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; get key1</div><div class=\"line\">&quot;hello world&quot;</div><div class=\"line\">127.0.0.1:6379&gt; setrange key1 6 liming</div><div class=\"line\">(integer) 12</div><div class=\"line\">127.0.0.1:6379&gt; get key1</div><div class=\"line\">&quot;hello liming&quot;</div><div class=\"line\">\t#将key1键对应值的第6个位置开始替换（字符串位置从0开始计算）</div></pre></td></tr></table></figure>\n<ol>\n<li>mset 键1 值1 键2 值2 键3 值3 ….<blockquote>\n<p>批量设置键和值,成功则返回ok</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; mset name1 lm name2 sc name3 zjj</div><div class=\"line\">OK</div></pre></td></tr></table></figure>\n<ol>\n<li>mget 键1 键2 键3….<blockquote>\n<p>批量获取值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; mget name1 name2 name3</div><div class=\"line\">1) &quot;lm&quot;</div><div class=\"line\">2) &quot;sc&quot;</div><div class=\"line\">3) &quot;zjj&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>msetnx 键1 值1 键2 值2 键3 值3 ….<blockquote>\n<p>批量设置不存在的键和值,成功则返回ok</p>\n</blockquote>\n</li>\n</ol>\n<ol>\n<li>getset 键 新值<blockquote>\n<p>获取原值，并设置新值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set name &quot;shen chao&quot;</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; get name</div><div class=\"line\">&quot;shen chao&quot;</div><div class=\"line\">127.0.0.1:6379&gt; getset name &quot;liming&quot;</div><div class=\"line\">&quot;shen chao&quot;</div><div class=\"line\">127.0.0.1:6379&gt; get name</div><div class=\"line\">&quot;liming&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>getrange 键 0 4  <blockquote>\n<p>获取指定范围的值（获取指定0到4位置上的值，字符串位置从0开始计算）</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; getrange key1 0 4</div><div class=\"line\">&quot;hello&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>incr 键  <blockquote>\n<p>指定键的值做加1操作，返回加后的结果（只能加数字）。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set age 18</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; incr age</div><div class=\"line\">(integer) 19</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;19&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>incrby 键 m    <blockquote>\n<p>其中m可以是正整数或负整数.加指定值，键不存在时候会设置键</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; incrby age 10</div><div class=\"line\">(integer) 29</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;29&quot;</div><div class=\"line\">127.0.0.1:6379&gt; incrby age -5</div><div class=\"line\">(integer) 24</div></pre></td></tr></table></figure>\n<ol>\n<li>decr 键<blockquote>\n<p>指定键的值做减1操作，返回减后的结果。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; decr age</div><div class=\"line\">(integer) 23</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;23&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>decrby 键 n<blockquote>\n<p>其中n可以是正整数或负整数.设置某个键减上指定值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; decrby age 5</div><div class=\"line\">(integer) 18</div><div class=\"line\">127.0.0.1:6379&gt; decrby age -10</div><div class=\"line\">(integer) 28</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;28&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>append  键 追加字串<blockquote>\n<p>给指定key的字符串追加value，返回新字符串值的长度</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; append name1 &quot; have a hot body!&quot;</div><div class=\"line\">(integer) 19</div><div class=\"line\">127.0.0.1:6379&gt; get name1</div><div class=\"line\">&quot;lm have a hot body!&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>strlen 键名<blockquote>\n<p>strlen求一个键长度</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; strlen name1</div><div class=\"line\">(integer) 19</div></pre></td></tr></table></figure>\n<ol>\n<li>del命令：<blockquote>\n<p>删除一个键</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; del name3</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; get name3</div><div class=\"line\">(nil)</div></pre></td></tr></table></figure>\n<h2 id=\"hashs类型\"><a href=\"#hashs类型\" class=\"headerlink\" title=\"hashs类型\"></a>hashs类型</h2><blockquote>\n<p>注意：redis中没有表概念，所有的数据都存入键中。</p>\n<ul>\n<li>string键类型：所有的值（可以是任何数据类型）都保存在一个键当中，放在一个内存块中<ul>\n<li>hashs键类型：所有的值也都保存在一个键当中，只是放在不同的内存块中，每个块称作字段</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<ol>\n<li>hset key field value<blockquote>\n<p>设置一个键，在键中保存字段和值<br>格式： hset 哈希集（键） 字段 值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hset user1 name4 ysm</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; keys *\t\t\t\t\t//查看库中所有的键</div><div class=\"line\">1) &quot;aa&quot;</div><div class=\"line\">2) &quot;name&quot;</div><div class=\"line\">3) &quot;name1&quot;</div><div class=\"line\">4) &quot;user1&quot;</div><div class=\"line\">5) &quot;name2&quot;</div><div class=\"line\">6) &quot;age&quot;</div><div class=\"line\">7) &quot;key1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hsetnx  键  字段  值<blockquote>\n<p>   设置一个键中，不存在的字段和值。如果字段存在则报错（成功返回1，失败返回0）</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hsetnx user1 name1 lm</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; hsetnx user1 name1 sc</div><div class=\"line\">(integer) 0\t\t\t\t\t//报错</div><div class=\"line\">127.0.0.1:6379&gt; hget user1 name1</div><div class=\"line\">&quot;lm&quot;\t\t\t\t\t\t//内容没有更新</div></pre></td></tr></table></figure>\n<ol>\n<li>hmset  键  字段1  值1  字段2  值2 …<blockquote>\n<p>   在一个键中，批量设置字段</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hmset user2 name liming age 36 interest AV-Girl</div><div class=\"line\">OK</div></pre></td></tr></table></figure>\n<ol>\n<li>hget 键 字段<blockquote>\n<p>   获取键中的一个指定字段的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hget user1 name1</div><div class=\"line\">&quot;lm&quot;</div><div class=\"line\">127.0.0.1:6379&gt; hget user2 interest</div><div class=\"line\">&quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hmget 键 字段1 [字段2…]<blockquote>\n<p>   获取键中一个或多个字段的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hmget user2 name age interest</div><div class=\"line\">1) &quot;liming&quot;</div><div class=\"line\">2) &quot;36&quot;</div><div class=\"line\">3) &quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hexists ：<blockquote>\n<p>判断指定的字段是否存在于键中</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; HEXISTS user2 age</div><div class=\"line\">(integer) 1\t\t\t\t\t\t\t//存在</div><div class=\"line\">127.0.0.1:6379&gt; HEXISTS user1 age</div><div class=\"line\">(integer) 0\t\t\t\t\t\t\t//不存在</div></pre></td></tr></table></figure>\n<ol>\n<li>hlen ：获取键中的字段数量</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hlen user2</div><div class=\"line\">(integer) 3\t\t\t\t\t\t\t//user2键中有3个字段</div></pre></td></tr></table></figure>\n<ol>\n<li>hkeys ：获取键中的所有字段名</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hkeys user2</div><div class=\"line\">1) &quot;name&quot;</div><div class=\"line\">2) &quot;age&quot;</div><div class=\"line\">3) &quot;interest&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hvals：获取键中所有字段的值</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hvals user2</div><div class=\"line\">1) &quot;liming&quot;</div><div class=\"line\">2) &quot;36&quot;</div><div class=\"line\">3) &quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hgetall ：获取键中的所有字段和值</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hgetall user2</div><div class=\"line\">1) &quot;name&quot;</div><div class=\"line\">2) &quot;liming&quot;</div><div class=\"line\">3) &quot;age&quot;</div><div class=\"line\">4) &quot;36&quot;</div><div class=\"line\">5) &quot;interest&quot;</div><div class=\"line\">6) &quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hincrby：将键中指定字段的值，增加指定的数字</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hincrby user2 age 5</div><div class=\"line\">(integer) 41</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; HINCRBY user2 name 5</div><div class=\"line\">(error) ERR hash value is not an integer\t//值不是数字的字段，不能加数字</div></pre></td></tr></table></figure>\n<ol>\n<li>hdel 键 字段1 字段2<blockquote>\n<p>   删除键中的一个或多个字段</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hdel user2 age interest</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; hkeys user2</div><div class=\"line\">1) &quot;name&quot;</div><div class=\"line\">\t//删除一个键，还是要使用del命令</div></pre></td></tr></table></figure>\n<h2 id=\"list类型（双向链表结构）\"><a href=\"#list类型（双向链表结构）\" class=\"headerlink\" title=\"list类型（双向链表结构）\"></a>list类型（双向链表结构）</h2><p>List是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等，操作中key理解为链表的名字。Redis的list类型其实就是一个每个子元素都是string类型的双向链表。列表允许有重复值</p>\n<ol>\n<li>lpush 键 值1 [值2…]<blockquote>\n<p>从队列左边向队列写入一个或多个值（认为队列的左面为队列头，右边为队列尾）</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lpush list1 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; lpush list1 2</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; lpush list1 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; lpush list1 4</div><div class=\"line\">(integer) 4</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; lpush list2 one two three four</div><div class=\"line\">(integer) 4</div></pre></td></tr></table></figure>\n<ol>\n<li>lrange 键 起始下标 终止下标<blockquote>\n<p>   从队列中获取指定的返回值（从队列左边向右获取）<br>下标：</p>\n<ul>\n<li>0代表队列中第一个元素，1代表第二个元素，依次类推</li>\n<li>-1代表队列中最后一个元素，-2代表倒数第二个元素</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; LRANGE list1 0 -1</div><div class=\"line\">1) &quot;4&quot;\t\t//4是从左面写入队列的最后一个值，所以在队列的开头</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;2&quot;</div><div class=\"line\">4) &quot;1&quot;\t\t//1是从左面写入队列的第一个值，所以直接放到了队列尾。</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list2 0 -1</div><div class=\"line\">1) &quot;four&quot;</div><div class=\"line\">2) &quot;three&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;one&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list1 0 1</div><div class=\"line\">1) &quot;4&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list2 -4 3</div><div class=\"line\">1) &quot;four&quot;\t\t//-4代表从队列右边数第四个元素</div><div class=\"line\">2) &quot;three&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;one&quot;\t\t//3代表从队列左边数第四个元素</div></pre></td></tr></table></figure>\n<ol>\n<li>rpush 键 值1 [值2…]<blockquote>\n<p>   从队列右边向队列写入一个或多个值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; RPUSH list3 1 2 3 4</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list3 0 -1</div><div class=\"line\">1) &quot;1&quot;\t\t//从队列右边向队列写入值，第一个值就会写到队列的开头</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>linsert  键  before|after  原值  新值<blockquote>\n<p>   在队列中指定元素之前或之后插入新值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; LINSERT list3 before 3 hello</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list3 0 -1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;hello&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lset  键  下标  新值<blockquote>\n<p>   给队列中指定元素设定新值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lset list3 2 &quot;5&quot;</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list3 0 -1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;5&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lerm  键  n  指定值<blockquote>\n<p>从队列中删除n个值为“指定值”的元素</p>\n<ul>\n<li>n &gt; 0     从队列头向尾删除n个元素</li>\n<li>n &lt; 0     从队列尾向头删除n个元素</li>\n<li>n = 0    删除所有值为“指定值”的元素</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; rpush list4 hello 1 hello 2 hello 3 hello</div><div class=\"line\">(integer) 7</div><div class=\"line\">127.0.0.1:6379&gt; lrange list4 0 -1</div><div class=\"line\">1) &quot;hello&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;hello&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;hello&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;hello&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrem list4 -2 hello\t\t\t//删除后两个hello</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; lrange list4 0 -1</div><div class=\"line\">1) &quot;hello&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;hello&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrem list4 0 hello\t\t\t//删除所有hello</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; lrange list4 0 -1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>ltrim  键  起始下标  结束下标<blockquote>\n<p>   修剪队列，让队列只保留指定指定范围内的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; RPUSH list5 1 2 3 4</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; ltrim list5 1 2</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; lrange list5 0 -1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lpop  键<blockquote>\n<p>   从指定的队列左面移除一个值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;4&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;2&quot;</div><div class=\"line\">4) &quot;1&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lpop list1</div><div class=\"line\">&quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>rpop  键<blockquote>\n<p>   从指定队列的右边移除一个值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;1&quot;</div><div class=\"line\">127.0.0.1:6379&gt; rpop list1</div><div class=\"line\">&quot;1&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>rpoplpush  源队列  目标队列<blockquote>\n<p>   移除源队列的最后一个元素，并把该元素写入目标队列</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list5 0 -1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; RPOPLPUSH list1 list5</div><div class=\"line\">&quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list5 0 -1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lindex  键  下标<blockquote>\n<p>   获取队列中指定下标元素的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list2 0 -1</div><div class=\"line\">1) &quot;four&quot;</div><div class=\"line\">2) &quot;three&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;one&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lindex list2 1</div><div class=\"line\">&quot;three&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lindex list2 3</div><div class=\"line\">&quot;one&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>llen  键<blockquote>\n<p>   获得队列的长度</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; llen list2</div><div class=\"line\">(integer) 4</div></pre></td></tr></table></figure>\n<h2 id=\"sets类型和操作\"><a href=\"#sets类型和操作\" class=\"headerlink\" title=\"sets类型和操作\"></a>sets类型和操作</h2><p>Set是集合，它是string类型的无序集合。对集合我们可以取并集、交集、差集。通过这些操作我们可以实现社交网站中的好友推荐和blog的tag功能。集合不允许有重复值。</p>\n<ol>\n<li>sadd  键  值1[值2…]<blockquote>\n<p>   添加一个或多个元素到集合中</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset1 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; sadd mset1 2 3 4</div><div class=\"line\">(integer) 3</div></pre></td></tr></table></figure>\n<ol>\n<li>smembers  键<blockquote>\n<p>   获取集合里面所有的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>srem  键  值1[值2…]<blockquote>\n<p>   从集合中删除指定的一个或多个元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; srem mset1 3 4</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\"></div><div class=\"line\">（删除键，依然使用“del 键” 命令）</div></pre></td></tr></table></figure>\n<ol>\n<li>spop  键  <blockquote>\n<p>   随机从集合中删除一个元素，并返回</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset2 4 5 6 7 8</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; spop mset2</div><div class=\"line\">&quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; spop mset2</div><div class=\"line\">&quot;5&quot;</div><div class=\"line\">127.0.0.1:6379&gt; spop mset2</div><div class=\"line\">&quot;8&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset2</div><div class=\"line\">1) &quot;6&quot;</div><div class=\"line\">2) &quot;7&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>srandmember  键  值<blockquote>\n<p>   随机返回集合中一个元素，但不删除</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset3 4 5 6 7 8</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; srandmember mset3</div><div class=\"line\">&quot;5&quot;</div><div class=\"line\">127.0.0.1:6379&gt; srandmember mset3</div><div class=\"line\">&quot;5&quot;</div><div class=\"line\">127.0.0.1:6379&gt; srandmember mset3</div><div class=\"line\">&quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>scard  键<blockquote>\n<p>   获取集合里面元素个数</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; scard mset1</div><div class=\"line\">(integer) 2</div></pre></td></tr></table></figure>\n<ol>\n<li>sismember  键  值<blockquote>\n<p>   确定一个指定的值是否是集合中的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; sismember mset1 3</div><div class=\"line\">(integer) 0</div><div class=\"line\">127.0.0.1:6379&gt; sismember mset1 1</div><div class=\"line\">(integer) 1</div></pre></td></tr></table></figure>\n<ol>\n<li>sdiff  集合1  集合2<blockquote>\n<p>   返回集合1与集合2的差集。以集合1为主</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset4 1 2 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sadd mset5 2 3 4</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sdiff mset4 mset5</div><div class=\"line\">1) &quot;1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sdiffstore  新集合  集合1  集合2<blockquote>\n<p>   返回集合1和集合2的差集，并把结果存入新集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset4 1 2 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sadd mset5 2 3 4</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sdiffstore mset6 mset5 mset4</div><div class=\"line\">(integer) 1\t\t\t\t//返回值为1 ，证明成功</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset6</div><div class=\"line\">1) &quot;4&quot;\t\t\t\t\t//结果存入了mset6，值为4</div></pre></td></tr></table></figure>\n<ol>\n<li>sinter  集合1  集合2<blockquote>\n<p>   获得两个集合的交集</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset4</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset5</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; sinter mset4 mset5</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sinterstore  新集合  集合1  集合2<blockquote>\n<p>   获得集合1和集合2的交集，并把结果存入新集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sinterstore mset7 mset4 mset5</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset7</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sunion  集合1  集合2<blockquote>\n<p>   获得指定集合的并集</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sunion mset4 mset5</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sunionstore  新集合  集合1  集合2<blockquote>\n<p>   获得指定集合的并集，并把结果保存如新集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sunionstore mset8 mset4 mset5</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset8</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>smove  源集合  目标集合  值<blockquote>\n<p>   将指定的值从源集合移动到目标集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset2</div><div class=\"line\">1) &quot;6&quot;</div><div class=\"line\">2) &quot;7&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smove mset1 mset2 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset2</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;6&quot;</div><div class=\"line\">3) &quot;7&quot;</div></pre></td></tr></table></figure>\n<h2 id=\"sorted-sets类型和操作\"><a href=\"#sorted-sets类型和操作\" class=\"headerlink\" title=\"sorted sets类型和操作\"></a>sorted sets类型和操作</h2><p>sorted set是set的一个升级版本，它给集合中每个元素都定义一个分数，集合中的元素按照其分数排序。也不允许有重复值</p>\n<ol>\n<li>zadd  键  分数1  值1  [分数2  值2…]<blockquote>\n<p>该命令添加指定的成员到key对应的有序集合中，每个成员都有一个分数。你可以指定多个分数/成员组合。如果一个指定的成员已经在对应的有序集合中了，那么其分数就会被更新成最新的，并且该成员会重新调整到正确的位置，以确保集合有序。分数的值必须是一个表示数字的字符串，并且可以是double类型的浮点数。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 lm 2 sc 3 glf</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 ymj</div><div class=\"line\">(integer) 1</div></pre></td></tr></table></figure>\n<ol>\n<li>zrange  集合  起始下标  截止下标  [withscores]<blockquote>\n<p>   返回有序集合中，指定区间内的成员。其中成员按照score（分数）值从小到大排序。具有相同score值的成员按照字典顺序来排列。</p>\n<p>   起始下标与截止下标和list类型一致：</p>\n<ul>\n<li>0代表队列中第一个元素，1代表第二个元素，依次类推</li>\n<li><p>-1代表队列中最后一个元素，-2代表倒数第二个元素</p>\n<p>withscores：返回集合中元素的同时，返回其分数（score）</p>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;lm&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;ymj&quot;</div><div class=\"line\">4) &quot;1&quot;</div><div class=\"line\">5) &quot;sc&quot;</div><div class=\"line\">6) &quot;2&quot;</div><div class=\"line\">7) &quot;glf&quot;</div><div class=\"line\">8) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrevrange  集合  起始下标  截止下标  [withscores]<blockquote>\n<p>   返回有序集合中，指定区间的成员。其成员按照score从大到小来排列。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrevrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;glf&quot;\t\t//下标为0</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;sc&quot;\t\t\t//下标为1</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;ymj&quot;\t\t//下标为2</div><div class=\"line\">6) &quot;1&quot;</div><div class=\"line\">7) &quot;lm&quot;\t\t\t//下标为3</div><div class=\"line\">8) &quot;1&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zrevrange zset1 1 2 withscores\t\t//查看集合中下标是1-2的值</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;ymj&quot;</div><div class=\"line\">4) &quot;1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrangebyscore  集合  起始分数  截止分数  withscores<blockquote>\n<p>   返回有序集合中score（分数）在指定区间的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset2 1 one 2 two 3 three 4 four</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores\t\t//按照下标区间返回值</div><div class=\"line\">1) &quot;one&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;three&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;four&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zrangebyscore zset2 2 3 withscores\t//按照分数区间返回值</div><div class=\"line\">1) &quot;two&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;three&quot;</div><div class=\"line\">4) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrem  集合  值1  [值2…]<blockquote>\n<p>   删除有序集合中指定的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrem zset1 lm</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;ymj&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;sc&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;glf&quot;</div><div class=\"line\">6) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zincrby  集合  增量  值<blockquote>\n<p>   给有序集合中指定值的成员的分数（score）值加上增量（increment）。如果集合中没有这个值，则给添加一个分数是increment的值。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zincrby zset1 2 ymj\t\t//如果值存在，则在其分数上加增量</div><div class=\"line\">&quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zincrby zset1 4 bro\t\t//如果值不存在，则加入值。并指定分数为增&quot;4&quot;\t\t\t\t\t\t\t\t\t\t量</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;bro&quot;</div><div class=\"line\">8) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrank  集合  值<blockquote>\n<p>   返回有序集合中指定值的下标。值按照score从小到大排序</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrank zset1 sc</div><div class=\"line\">(integer) 0</div><div class=\"line\">127.0.0.1:6379&gt; zrank zset1 ymj</div><div class=\"line\">(integer) 2</div></pre></td></tr></table></figure>\n<ol>\n<li>zrevrank  集合  值<blockquote>\n<p>   返回有序集合中指定值的下标，值按照score从大到小排序</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;bro&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; zrevrank zset1 ymj</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; zrevrank zset1 sc</div><div class=\"line\">(integer) 3</div></pre></td></tr></table></figure>\n<ol>\n<li>zcount  集合  起始分数  截止分数<blockquote>\n<p>   返回有序集合中，score值在起始分数与截止分数之间的个数</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores</div><div class=\"line\">1) &quot;one&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;three&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;four&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zcount zset2 2 4</div><div class=\"line\">(integer) 3</div></pre></td></tr></table></figure>\n<ol>\n<li>zcard  集合<blockquote>\n<p>   返回有序集合元素的个数</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zcard zset2</div><div class=\"line\">(integer) 4</div></pre></td></tr></table></figure>\n<ol>\n<li>zremrangebyrank  集合  起始下标  结束下标<blockquote>\n<p>   删除有序集合中，下标在指定区间的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores</div><div class=\"line\">1) &quot;one&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;three&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;four&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYRANK zset2 0 1</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores</div><div class=\"line\">1) &quot;three&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;four&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zremrangebyscore  集合  起始分数  截止分数<blockquote>\n<p>删除有序集合中，分数在指定区间的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;bro&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYSCORE zset1 2 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;bro&quot;</div><div class=\"line\">2) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zinterstore  新集合  取交集的集合个数  集合1 集合2<blockquote>\n<p>   取集合1和集合2的交集，并把结果保存到新集合中。在计算交集之前，需要指定计算交集的集合的个数。交集中，值的分数是多个集合中分数的和。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 one 2 two 3 three 4 four</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; zadd zset2  2 two 3 three 4 four 5 five</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; ZINTERSTORE zset3 2 zset1 zset2 \t</div><div class=\"line\">//有两个集合计算交集，所以集合个数是2</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; ZRANGE zset3 0 -1 withscores</div><div class=\"line\">1) &quot;two&quot;</div><div class=\"line\">2) &quot;4&quot;\t\t\t\t//分数是两个集合中two值的分数和</div><div class=\"line\">3) &quot;three&quot;</div><div class=\"line\">4) &quot;6&quot;</div><div class=\"line\">5) &quot;four&quot;</div><div class=\"line\">6) &quot;8&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zunionstore  新集合  取并集的集合个数  集合1 集合2<blockquote>\n<p>   取集合1和集合2的并集，并把结果保存到新集合中。在计算并集之前，需要指定计算并集的集合的个数。并集中，值的分数是多个集合中分数的和。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 one 2 two 3 three 4 four</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; zadd zset2  2 two 3 three 4 four 5 five</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; ZUNIONSTORE zset4 2 zset1 zset2</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; ZRANGE zset4 0 -1 withscores</div><div class=\"line\"> 1) &quot;one&quot;</div><div class=\"line\"> 2) &quot;1&quot;</div><div class=\"line\"> 3) &quot;two&quot;</div><div class=\"line\"> 4) &quot;4&quot;</div><div class=\"line\"> 5) &quot;five&quot;</div><div class=\"line\"> 6) &quot;5&quot;</div><div class=\"line\"> 7) &quot;three&quot;</div><div class=\"line\"> 8) &quot;6&quot;</div><div class=\"line\"> 9) &quot;four&quot;</div><div class=\"line\">10) &quot;8&quot;</div></pre></td></tr></table></figure>\n","excerpt":"<p>Redis共有5种数据类型</p>\n<ul>\n<li>string(字符串)</li>\n<li>hash(哈希表)</li>\n<li>list(双向队列)</li>\n<li>set(集合)</li>\n<li>zset(有序集合)</li>\n</ul>","more":"<h2 id=\"String（子串类型）\"><a href=\"#String（子串类型）\" class=\"headerlink\" title=\"String（子串类型）\"></a>String（子串类型）</h2><p>String是最简单的类型，一个Key对应一个Value，string类型是二进制安全的。Redis的string可以包含任何数据，比如jpg图片或者序列化的对象。</p>\n<ol>\n<li>set 键  “值”<blockquote>\n<p>设置一个键和值，键存在则覆盖，返回ok</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set name liming</div><div class=\"line\">OK</div></pre></td></tr></table></figure>\n<ol>\n<li>get 键<blockquote>\n<p>获取一个键的值，返回值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; get name</div><div class=\"line\">&quot;liming&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>setnx 键 值<blockquote>\n<p>只有当该键不存在时设置一个键的值，若键已存在则返回0表示失败（防止覆盖），</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; setnx age 18</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; setnx age 18</div><div class=\"line\">(integer) 0</div></pre></td></tr></table></figure>\n<ol>\n<li>setex 键 [有效时间] 值<blockquote>\n<p>设置一个指定有效期的键和值（单位秒）。不写有效时间则表示永久有效，等价于set</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; setex movie 30 canglaoshi</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; ttl movie\t\t\t\t//获取键的有效时间</div><div class=\"line\">(integer) 26</div><div class=\"line\">127.0.0.1:6379&gt; ttl movie</div><div class=\"line\">(integer) 20</div><div class=\"line\">127.0.0.1:6379&gt; get movie</div><div class=\"line\">&quot;canglaoshi&quot;</div><div class=\"line\">127.0.0.1:6379&gt; ttl movie</div><div class=\"line\">(integer) -2</div><div class=\"line\">127.0.0.1:6379&gt; get movie</div><div class=\"line\">(nil)</div></pre></td></tr></table></figure>\n<ol>\n<li>ttl 键<blockquote>\n<p>以秒为单位，返回给定 key 的剩余生存时间</p>\n<ul>\n<li>当 key 不存在时，返回 -2 。<ul>\n<li>当 key 存在但没有设置剩余生存时间时，返回 -1 。</li>\n<li>否则，以秒为单位，返回 key 的剩余生存时间。</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<ol>\n<li>setrange 键 位置 子字串<blockquote>\n<p>替换子字符串 (替换长度由子子串长度决定)</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set key1 &quot;hello world&quot;</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; get key1</div><div class=\"line\">&quot;hello world&quot;</div><div class=\"line\">127.0.0.1:6379&gt; setrange key1 6 liming</div><div class=\"line\">(integer) 12</div><div class=\"line\">127.0.0.1:6379&gt; get key1</div><div class=\"line\">&quot;hello liming&quot;</div><div class=\"line\">\t#将key1键对应值的第6个位置开始替换（字符串位置从0开始计算）</div></pre></td></tr></table></figure>\n<ol>\n<li>mset 键1 值1 键2 值2 键3 值3 ….<blockquote>\n<p>批量设置键和值,成功则返回ok</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; mset name1 lm name2 sc name3 zjj</div><div class=\"line\">OK</div></pre></td></tr></table></figure>\n<ol>\n<li>mget 键1 键2 键3….<blockquote>\n<p>批量获取值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; mget name1 name2 name3</div><div class=\"line\">1) &quot;lm&quot;</div><div class=\"line\">2) &quot;sc&quot;</div><div class=\"line\">3) &quot;zjj&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>msetnx 键1 值1 键2 值2 键3 值3 ….<blockquote>\n<p>批量设置不存在的键和值,成功则返回ok</p>\n</blockquote>\n</li>\n</ol>\n<ol>\n<li>getset 键 新值<blockquote>\n<p>获取原值，并设置新值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set name &quot;shen chao&quot;</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; get name</div><div class=\"line\">&quot;shen chao&quot;</div><div class=\"line\">127.0.0.1:6379&gt; getset name &quot;liming&quot;</div><div class=\"line\">&quot;shen chao&quot;</div><div class=\"line\">127.0.0.1:6379&gt; get name</div><div class=\"line\">&quot;liming&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>getrange 键 0 4  <blockquote>\n<p>获取指定范围的值（获取指定0到4位置上的值，字符串位置从0开始计算）</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; getrange key1 0 4</div><div class=\"line\">&quot;hello&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>incr 键  <blockquote>\n<p>指定键的值做加1操作，返回加后的结果（只能加数字）。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; set age 18</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; incr age</div><div class=\"line\">(integer) 19</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;19&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>incrby 键 m    <blockquote>\n<p>其中m可以是正整数或负整数.加指定值，键不存在时候会设置键</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; incrby age 10</div><div class=\"line\">(integer) 29</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;29&quot;</div><div class=\"line\">127.0.0.1:6379&gt; incrby age -5</div><div class=\"line\">(integer) 24</div></pre></td></tr></table></figure>\n<ol>\n<li>decr 键<blockquote>\n<p>指定键的值做减1操作，返回减后的结果。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; decr age</div><div class=\"line\">(integer) 23</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;23&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>decrby 键 n<blockquote>\n<p>其中n可以是正整数或负整数.设置某个键减上指定值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; decrby age 5</div><div class=\"line\">(integer) 18</div><div class=\"line\">127.0.0.1:6379&gt; decrby age -10</div><div class=\"line\">(integer) 28</div><div class=\"line\">127.0.0.1:6379&gt; get age</div><div class=\"line\">&quot;28&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>append  键 追加字串<blockquote>\n<p>给指定key的字符串追加value，返回新字符串值的长度</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; append name1 &quot; have a hot body!&quot;</div><div class=\"line\">(integer) 19</div><div class=\"line\">127.0.0.1:6379&gt; get name1</div><div class=\"line\">&quot;lm have a hot body!&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>strlen 键名<blockquote>\n<p>strlen求一个键长度</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; strlen name1</div><div class=\"line\">(integer) 19</div></pre></td></tr></table></figure>\n<ol>\n<li>del命令：<blockquote>\n<p>删除一个键</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; del name3</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; get name3</div><div class=\"line\">(nil)</div></pre></td></tr></table></figure>\n<h2 id=\"hashs类型\"><a href=\"#hashs类型\" class=\"headerlink\" title=\"hashs类型\"></a>hashs类型</h2><blockquote>\n<p>注意：redis中没有表概念，所有的数据都存入键中。</p>\n<ul>\n<li>string键类型：所有的值（可以是任何数据类型）都保存在一个键当中，放在一个内存块中<ul>\n<li>hashs键类型：所有的值也都保存在一个键当中，只是放在不同的内存块中，每个块称作字段</li>\n</ul>\n</li>\n</ul>\n</blockquote>\n<ol>\n<li>hset key field value<blockquote>\n<p>设置一个键，在键中保存字段和值<br>格式： hset 哈希集（键） 字段 值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hset user1 name4 ysm</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; keys *\t\t\t\t\t//查看库中所有的键</div><div class=\"line\">1) &quot;aa&quot;</div><div class=\"line\">2) &quot;name&quot;</div><div class=\"line\">3) &quot;name1&quot;</div><div class=\"line\">4) &quot;user1&quot;</div><div class=\"line\">5) &quot;name2&quot;</div><div class=\"line\">6) &quot;age&quot;</div><div class=\"line\">7) &quot;key1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hsetnx  键  字段  值<blockquote>\n<p>   设置一个键中，不存在的字段和值。如果字段存在则报错（成功返回1，失败返回0）</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hsetnx user1 name1 lm</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; hsetnx user1 name1 sc</div><div class=\"line\">(integer) 0\t\t\t\t\t//报错</div><div class=\"line\">127.0.0.1:6379&gt; hget user1 name1</div><div class=\"line\">&quot;lm&quot;\t\t\t\t\t\t//内容没有更新</div></pre></td></tr></table></figure>\n<ol>\n<li>hmset  键  字段1  值1  字段2  值2 …<blockquote>\n<p>   在一个键中，批量设置字段</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hmset user2 name liming age 36 interest AV-Girl</div><div class=\"line\">OK</div></pre></td></tr></table></figure>\n<ol>\n<li>hget 键 字段<blockquote>\n<p>   获取键中的一个指定字段的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hget user1 name1</div><div class=\"line\">&quot;lm&quot;</div><div class=\"line\">127.0.0.1:6379&gt; hget user2 interest</div><div class=\"line\">&quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hmget 键 字段1 [字段2…]<blockquote>\n<p>   获取键中一个或多个字段的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hmget user2 name age interest</div><div class=\"line\">1) &quot;liming&quot;</div><div class=\"line\">2) &quot;36&quot;</div><div class=\"line\">3) &quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hexists ：<blockquote>\n<p>判断指定的字段是否存在于键中</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; HEXISTS user2 age</div><div class=\"line\">(integer) 1\t\t\t\t\t\t\t//存在</div><div class=\"line\">127.0.0.1:6379&gt; HEXISTS user1 age</div><div class=\"line\">(integer) 0\t\t\t\t\t\t\t//不存在</div></pre></td></tr></table></figure>\n<ol>\n<li>hlen ：获取键中的字段数量</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hlen user2</div><div class=\"line\">(integer) 3\t\t\t\t\t\t\t//user2键中有3个字段</div></pre></td></tr></table></figure>\n<ol>\n<li>hkeys ：获取键中的所有字段名</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hkeys user2</div><div class=\"line\">1) &quot;name&quot;</div><div class=\"line\">2) &quot;age&quot;</div><div class=\"line\">3) &quot;interest&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hvals：获取键中所有字段的值</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hvals user2</div><div class=\"line\">1) &quot;liming&quot;</div><div class=\"line\">2) &quot;36&quot;</div><div class=\"line\">3) &quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hgetall ：获取键中的所有字段和值</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hgetall user2</div><div class=\"line\">1) &quot;name&quot;</div><div class=\"line\">2) &quot;liming&quot;</div><div class=\"line\">3) &quot;age&quot;</div><div class=\"line\">4) &quot;36&quot;</div><div class=\"line\">5) &quot;interest&quot;</div><div class=\"line\">6) &quot;AV-Girl&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>hincrby：将键中指定字段的值，增加指定的数字</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hincrby user2 age 5</div><div class=\"line\">(integer) 41</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; HINCRBY user2 name 5</div><div class=\"line\">(error) ERR hash value is not an integer\t//值不是数字的字段，不能加数字</div></pre></td></tr></table></figure>\n<ol>\n<li>hdel 键 字段1 字段2<blockquote>\n<p>   删除键中的一个或多个字段</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; hdel user2 age interest</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; hkeys user2</div><div class=\"line\">1) &quot;name&quot;</div><div class=\"line\">\t//删除一个键，还是要使用del命令</div></pre></td></tr></table></figure>\n<h2 id=\"list类型（双向链表结构）\"><a href=\"#list类型（双向链表结构）\" class=\"headerlink\" title=\"list类型（双向链表结构）\"></a>list类型（双向链表结构）</h2><p>List是一个链表结构，主要功能是push、pop、获取一个范围的所有值等等，操作中key理解为链表的名字。Redis的list类型其实就是一个每个子元素都是string类型的双向链表。列表允许有重复值</p>\n<ol>\n<li>lpush 键 值1 [值2…]<blockquote>\n<p>从队列左边向队列写入一个或多个值（认为队列的左面为队列头，右边为队列尾）</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lpush list1 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; lpush list1 2</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; lpush list1 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; lpush list1 4</div><div class=\"line\">(integer) 4</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; lpush list2 one two three four</div><div class=\"line\">(integer) 4</div></pre></td></tr></table></figure>\n<ol>\n<li>lrange 键 起始下标 终止下标<blockquote>\n<p>   从队列中获取指定的返回值（从队列左边向右获取）<br>下标：</p>\n<ul>\n<li>0代表队列中第一个元素，1代表第二个元素，依次类推</li>\n<li>-1代表队列中最后一个元素，-2代表倒数第二个元素</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; LRANGE list1 0 -1</div><div class=\"line\">1) &quot;4&quot;\t\t//4是从左面写入队列的最后一个值，所以在队列的开头</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;2&quot;</div><div class=\"line\">4) &quot;1&quot;\t\t//1是从左面写入队列的第一个值，所以直接放到了队列尾。</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list2 0 -1</div><div class=\"line\">1) &quot;four&quot;</div><div class=\"line\">2) &quot;three&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;one&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list1 0 1</div><div class=\"line\">1) &quot;4&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list2 -4 3</div><div class=\"line\">1) &quot;four&quot;\t\t//-4代表从队列右边数第四个元素</div><div class=\"line\">2) &quot;three&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;one&quot;\t\t//3代表从队列左边数第四个元素</div></pre></td></tr></table></figure>\n<ol>\n<li>rpush 键 值1 [值2…]<blockquote>\n<p>   从队列右边向队列写入一个或多个值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; RPUSH list3 1 2 3 4</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list3 0 -1</div><div class=\"line\">1) &quot;1&quot;\t\t//从队列右边向队列写入值，第一个值就会写到队列的开头</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>linsert  键  before|after  原值  新值<blockquote>\n<p>   在队列中指定元素之前或之后插入新值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; LINSERT list3 before 3 hello</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list3 0 -1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;hello&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lset  键  下标  新值<blockquote>\n<p>   给队列中指定元素设定新值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lset list3 2 &quot;5&quot;</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; LRANGE list3 0 -1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;5&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lerm  键  n  指定值<blockquote>\n<p>从队列中删除n个值为“指定值”的元素</p>\n<ul>\n<li>n &gt; 0     从队列头向尾删除n个元素</li>\n<li>n &lt; 0     从队列尾向头删除n个元素</li>\n<li>n = 0    删除所有值为“指定值”的元素</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; rpush list4 hello 1 hello 2 hello 3 hello</div><div class=\"line\">(integer) 7</div><div class=\"line\">127.0.0.1:6379&gt; lrange list4 0 -1</div><div class=\"line\">1) &quot;hello&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;hello&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;hello&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;hello&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrem list4 -2 hello\t\t\t//删除后两个hello</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; lrange list4 0 -1</div><div class=\"line\">1) &quot;hello&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;hello&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrem list4 0 hello\t\t\t//删除所有hello</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; lrange list4 0 -1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>ltrim  键  起始下标  结束下标<blockquote>\n<p>   修剪队列，让队列只保留指定指定范围内的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; RPUSH list5 1 2 3 4</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; ltrim list5 1 2</div><div class=\"line\">OK</div><div class=\"line\">127.0.0.1:6379&gt; lrange list5 0 -1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lpop  键<blockquote>\n<p>   从指定的队列左面移除一个值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;4&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;2&quot;</div><div class=\"line\">4) &quot;1&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lpop list1</div><div class=\"line\">&quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>rpop  键<blockquote>\n<p>   从指定队列的右边移除一个值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;1&quot;</div><div class=\"line\">127.0.0.1:6379&gt; rpop list1</div><div class=\"line\">&quot;1&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>rpoplpush  源队列  目标队列<blockquote>\n<p>   移除源队列的最后一个元素，并把该元素写入目标队列</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list5 0 -1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; RPOPLPUSH list1 list5</div><div class=\"line\">&quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list1 0 -1</div><div class=\"line\">1) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lrange list5 0 -1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>lindex  键  下标<blockquote>\n<p>   获取队列中指定下标元素的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; lrange list2 0 -1</div><div class=\"line\">1) &quot;four&quot;</div><div class=\"line\">2) &quot;three&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;one&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lindex list2 1</div><div class=\"line\">&quot;three&quot;</div><div class=\"line\">127.0.0.1:6379&gt; lindex list2 3</div><div class=\"line\">&quot;one&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>llen  键<blockquote>\n<p>   获得队列的长度</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; llen list2</div><div class=\"line\">(integer) 4</div></pre></td></tr></table></figure>\n<h2 id=\"sets类型和操作\"><a href=\"#sets类型和操作\" class=\"headerlink\" title=\"sets类型和操作\"></a>sets类型和操作</h2><p>Set是集合，它是string类型的无序集合。对集合我们可以取并集、交集、差集。通过这些操作我们可以实现社交网站中的好友推荐和blog的tag功能。集合不允许有重复值。</p>\n<ol>\n<li>sadd  键  值1[值2…]<blockquote>\n<p>   添加一个或多个元素到集合中</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset1 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; sadd mset1 2 3 4</div><div class=\"line\">(integer) 3</div></pre></td></tr></table></figure>\n<ol>\n<li>smembers  键<blockquote>\n<p>   获取集合里面所有的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>srem  键  值1[值2…]<blockquote>\n<p>   从集合中删除指定的一个或多个元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; srem mset1 3 4</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\"></div><div class=\"line\">（删除键，依然使用“del 键” 命令）</div></pre></td></tr></table></figure>\n<ol>\n<li>spop  键  <blockquote>\n<p>   随机从集合中删除一个元素，并返回</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset2 4 5 6 7 8</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; spop mset2</div><div class=\"line\">&quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; spop mset2</div><div class=\"line\">&quot;5&quot;</div><div class=\"line\">127.0.0.1:6379&gt; spop mset2</div><div class=\"line\">&quot;8&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset2</div><div class=\"line\">1) &quot;6&quot;</div><div class=\"line\">2) &quot;7&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>srandmember  键  值<blockquote>\n<p>   随机返回集合中一个元素，但不删除</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset3 4 5 6 7 8</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; srandmember mset3</div><div class=\"line\">&quot;5&quot;</div><div class=\"line\">127.0.0.1:6379&gt; srandmember mset3</div><div class=\"line\">&quot;5&quot;</div><div class=\"line\">127.0.0.1:6379&gt; srandmember mset3</div><div class=\"line\">&quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>scard  键<blockquote>\n<p>   获取集合里面元素个数</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; scard mset1</div><div class=\"line\">(integer) 2</div></pre></td></tr></table></figure>\n<ol>\n<li>sismember  键  值<blockquote>\n<p>   确定一个指定的值是否是集合中的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; sismember mset1 3</div><div class=\"line\">(integer) 0</div><div class=\"line\">127.0.0.1:6379&gt; sismember mset1 1</div><div class=\"line\">(integer) 1</div></pre></td></tr></table></figure>\n<ol>\n<li>sdiff  集合1  集合2<blockquote>\n<p>   返回集合1与集合2的差集。以集合1为主</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset4 1 2 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sadd mset5 2 3 4</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sdiff mset4 mset5</div><div class=\"line\">1) &quot;1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sdiffstore  新集合  集合1  集合2<blockquote>\n<p>   返回集合1和集合2的差集，并把结果存入新集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sadd mset4 1 2 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sadd mset5 2 3 4</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; sdiffstore mset6 mset5 mset4</div><div class=\"line\">(integer) 1\t\t\t\t//返回值为1 ，证明成功</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset6</div><div class=\"line\">1) &quot;4&quot;\t\t\t\t\t//结果存入了mset6，值为4</div></pre></td></tr></table></figure>\n<ol>\n<li>sinter  集合1  集合2<blockquote>\n<p>   获得两个集合的交集</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset4</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset5</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; sinter mset4 mset5</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sinterstore  新集合  集合1  集合2<blockquote>\n<p>   获得集合1和集合2的交集，并把结果存入新集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sinterstore mset7 mset4 mset5</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset7</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">2) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sunion  集合1  集合2<blockquote>\n<p>   获得指定集合的并集</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sunion mset4 mset5</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>sunionstore  新集合  集合1  集合2<blockquote>\n<p>   获得指定集合的并集，并把结果保存如新集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; sunionstore mset8 mset4 mset5</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset8</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;3&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>smove  源集合  目标集合  值<blockquote>\n<p>   将指定的值从源集合移动到目标集合</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset2</div><div class=\"line\">1) &quot;6&quot;</div><div class=\"line\">2) &quot;7&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smove mset1 mset2 1</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset1</div><div class=\"line\">1) &quot;2&quot;</div><div class=\"line\">127.0.0.1:6379&gt; smembers mset2</div><div class=\"line\">1) &quot;1&quot;</div><div class=\"line\">2) &quot;6&quot;</div><div class=\"line\">3) &quot;7&quot;</div></pre></td></tr></table></figure>\n<h2 id=\"sorted-sets类型和操作\"><a href=\"#sorted-sets类型和操作\" class=\"headerlink\" title=\"sorted sets类型和操作\"></a>sorted sets类型和操作</h2><p>sorted set是set的一个升级版本，它给集合中每个元素都定义一个分数，集合中的元素按照其分数排序。也不允许有重复值</p>\n<ol>\n<li>zadd  键  分数1  值1  [分数2  值2…]<blockquote>\n<p>该命令添加指定的成员到key对应的有序集合中，每个成员都有一个分数。你可以指定多个分数/成员组合。如果一个指定的成员已经在对应的有序集合中了，那么其分数就会被更新成最新的，并且该成员会重新调整到正确的位置，以确保集合有序。分数的值必须是一个表示数字的字符串，并且可以是double类型的浮点数。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 lm 2 sc 3 glf</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 ymj</div><div class=\"line\">(integer) 1</div></pre></td></tr></table></figure>\n<ol>\n<li>zrange  集合  起始下标  截止下标  [withscores]<blockquote>\n<p>   返回有序集合中，指定区间内的成员。其中成员按照score（分数）值从小到大排序。具有相同score值的成员按照字典顺序来排列。</p>\n<p>   起始下标与截止下标和list类型一致：</p>\n<ul>\n<li>0代表队列中第一个元素，1代表第二个元素，依次类推</li>\n<li><p>-1代表队列中最后一个元素，-2代表倒数第二个元素</p>\n<p>withscores：返回集合中元素的同时，返回其分数（score）</p>\n</li>\n</ul>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;lm&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;ymj&quot;</div><div class=\"line\">4) &quot;1&quot;</div><div class=\"line\">5) &quot;sc&quot;</div><div class=\"line\">6) &quot;2&quot;</div><div class=\"line\">7) &quot;glf&quot;</div><div class=\"line\">8) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrevrange  集合  起始下标  截止下标  [withscores]<blockquote>\n<p>   返回有序集合中，指定区间的成员。其成员按照score从大到小来排列。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrevrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;glf&quot;\t\t//下标为0</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;sc&quot;\t\t\t//下标为1</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;ymj&quot;\t\t//下标为2</div><div class=\"line\">6) &quot;1&quot;</div><div class=\"line\">7) &quot;lm&quot;\t\t\t//下标为3</div><div class=\"line\">8) &quot;1&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zrevrange zset1 1 2 withscores\t\t//查看集合中下标是1-2的值</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;ymj&quot;</div><div class=\"line\">4) &quot;1&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrangebyscore  集合  起始分数  截止分数  withscores<blockquote>\n<p>   返回有序集合中score（分数）在指定区间的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset2 1 one 2 two 3 three 4 four</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores\t\t//按照下标区间返回值</div><div class=\"line\">1) &quot;one&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;three&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;four&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zrangebyscore zset2 2 3 withscores\t//按照分数区间返回值</div><div class=\"line\">1) &quot;two&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;three&quot;</div><div class=\"line\">4) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrem  集合  值1  [值2…]<blockquote>\n<p>   删除有序集合中指定的值</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrem zset1 lm</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;ymj&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;sc&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;glf&quot;</div><div class=\"line\">6) &quot;3&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zincrby  集合  增量  值<blockquote>\n<p>   给有序集合中指定值的成员的分数（score）值加上增量（increment）。如果集合中没有这个值，则给添加一个分数是increment的值。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zincrby zset1 2 ymj\t\t//如果值存在，则在其分数上加增量</div><div class=\"line\">&quot;3&quot;</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zincrby zset1 4 bro\t\t//如果值不存在，则加入值。并指定分数为增&quot;4&quot;\t\t\t\t\t\t\t\t\t\t量</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;bro&quot;</div><div class=\"line\">8) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zrank  集合  值<blockquote>\n<p>   返回有序集合中指定值的下标。值按照score从小到大排序</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrank zset1 sc</div><div class=\"line\">(integer) 0</div><div class=\"line\">127.0.0.1:6379&gt; zrank zset1 ymj</div><div class=\"line\">(integer) 2</div></pre></td></tr></table></figure>\n<ol>\n<li>zrevrank  集合  值<blockquote>\n<p>   返回有序集合中指定值的下标，值按照score从大到小排序</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;bro&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; zrevrank zset1 ymj</div><div class=\"line\">(integer) 1</div><div class=\"line\">127.0.0.1:6379&gt; zrevrank zset1 sc</div><div class=\"line\">(integer) 3</div></pre></td></tr></table></figure>\n<ol>\n<li>zcount  集合  起始分数  截止分数<blockquote>\n<p>   返回有序集合中，score值在起始分数与截止分数之间的个数</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores</div><div class=\"line\">1) &quot;one&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;three&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;four&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\"></div><div class=\"line\">127.0.0.1:6379&gt; zcount zset2 2 4</div><div class=\"line\">(integer) 3</div></pre></td></tr></table></figure>\n<ol>\n<li>zcard  集合<blockquote>\n<p>   返回有序集合元素的个数</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zcard zset2</div><div class=\"line\">(integer) 4</div></pre></td></tr></table></figure>\n<ol>\n<li>zremrangebyrank  集合  起始下标  结束下标<blockquote>\n<p>   删除有序集合中，下标在指定区间的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores</div><div class=\"line\">1) &quot;one&quot;</div><div class=\"line\">2) &quot;1&quot;</div><div class=\"line\">3) &quot;two&quot;</div><div class=\"line\">4) &quot;2&quot;</div><div class=\"line\">5) &quot;three&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;four&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYRANK zset2 0 1</div><div class=\"line\">(integer) 2</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset2 0 -1 withscores</div><div class=\"line\">1) &quot;three&quot;</div><div class=\"line\">2) &quot;3&quot;</div><div class=\"line\">3) &quot;four&quot;</div><div class=\"line\">4) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zremrangebyscore  集合  起始分数  截止分数<blockquote>\n<p>删除有序集合中，分数在指定区间的元素</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;sc&quot;</div><div class=\"line\">2) &quot;2&quot;</div><div class=\"line\">3) &quot;glf&quot;</div><div class=\"line\">4) &quot;3&quot;</div><div class=\"line\">5) &quot;ymj&quot;</div><div class=\"line\">6) &quot;3&quot;</div><div class=\"line\">7) &quot;bro&quot;</div><div class=\"line\">8) &quot;4&quot;</div><div class=\"line\">127.0.0.1:6379&gt; ZREMRANGEBYSCORE zset1 2 3</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; zrange zset1 0 -1 withscores</div><div class=\"line\">1) &quot;bro&quot;</div><div class=\"line\">2) &quot;4&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zinterstore  新集合  取交集的集合个数  集合1 集合2<blockquote>\n<p>   取集合1和集合2的交集，并把结果保存到新集合中。在计算交集之前，需要指定计算交集的集合的个数。交集中，值的分数是多个集合中分数的和。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 one 2 two 3 three 4 four</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; zadd zset2  2 two 3 three 4 four 5 five</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; ZINTERSTORE zset3 2 zset1 zset2 \t</div><div class=\"line\">//有两个集合计算交集，所以集合个数是2</div><div class=\"line\">(integer) 3</div><div class=\"line\">127.0.0.1:6379&gt; ZRANGE zset3 0 -1 withscores</div><div class=\"line\">1) &quot;two&quot;</div><div class=\"line\">2) &quot;4&quot;\t\t\t\t//分数是两个集合中two值的分数和</div><div class=\"line\">3) &quot;three&quot;</div><div class=\"line\">4) &quot;6&quot;</div><div class=\"line\">5) &quot;four&quot;</div><div class=\"line\">6) &quot;8&quot;</div></pre></td></tr></table></figure>\n<ol>\n<li>zunionstore  新集合  取并集的集合个数  集合1 集合2<blockquote>\n<p>   取集合1和集合2的并集，并把结果保存到新集合中。在计算并集之前，需要指定计算并集的集合的个数。并集中，值的分数是多个集合中分数的和。</p>\n</blockquote>\n</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div></pre></td><td class=\"code\"><pre><div class=\"line\">127.0.0.1:6379&gt; zadd zset1 1 one 2 two 3 three 4 four</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; zadd zset2  2 two 3 three 4 four 5 five</div><div class=\"line\">(integer) 4</div><div class=\"line\">127.0.0.1:6379&gt; ZUNIONSTORE zset4 2 zset1 zset2</div><div class=\"line\">(integer) 5</div><div class=\"line\">127.0.0.1:6379&gt; ZRANGE zset4 0 -1 withscores</div><div class=\"line\"> 1) &quot;one&quot;</div><div class=\"line\"> 2) &quot;1&quot;</div><div class=\"line\"> 3) &quot;two&quot;</div><div class=\"line\"> 4) &quot;4&quot;</div><div class=\"line\"> 5) &quot;five&quot;</div><div class=\"line\"> 6) &quot;5&quot;</div><div class=\"line\"> 7) &quot;three&quot;</div><div class=\"line\"> 8) &quot;6&quot;</div><div class=\"line\"> 9) &quot;four&quot;</div><div class=\"line\">10) &quot;8&quot;</div></pre></td></tr></table></figure>"},{"title":"hexo常用命令","date":"2016-08-12T12:00:00.000Z","_content":"\n## init\n```\n$ hexo init [folder]\n```\n新建一个网站。如果没有设置 folder ，Hexo 默认在目前的文件夹建立网站。\n\n## new\n```\n$ hexo new [layout] <title>\n```\n新建一篇文章。如果没有设置 layout 的话，默认使用 `_config.yml` 中的 default_layout 参数代替。如果标题包含空格的话，请使用引号括起来。\n\n\n<!-- more -->\n\n\n## generate\n```\n$ hexo generate\n```\n生成静态文件。\n\n  选项\t描述\n  -d, --deploy\t文件生成后立即部署网站\n  -w, --watch\t监视文件变动\n\n\n##  publish\n```\n$ hexo publish [layout] <filename>\n```\n发表草稿。\n\n## server\n```\n$ hexo server\n```\n启动服务器。默认情况下，访问网址为： http://localhost:4000/。\n\n  选项\t描述\n  -p, --port\t重设端口\n  -s, --static\t只使用静态文件\n  -l, --log\t启动日记记录，使用覆盖记录格式\n\n## deploy\n```\n$ hexo deploy\n```\n部署网站。\n\n  参数\t描述\n  -g, --generate\t部署之前预先生成静态文件\n\n## render\n```\n$ hexo render <file1> [file2] ...\n```\n渲染文件。\n\n  参数\t描述\n  -o, --output\t设置输出路径\n\n## migrate\n```\n$ hexo migrate <type>\n```\n从其他博客系统 迁移内容。\n\n## clean\n```\n$ hexo clean\n```\n清除缓存文件 (db.json) 和已生成的静态文件 (public)。\n\n## list\n```\n$ hexo list <type>\n```\n列出网站资料。\n\n## version\n```\n$ hexo version\n```\n显示 Hexo 版本。\n\n## 选项\n### 安全模式\n```\n$ hexo --safe\n```\n在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。\n\n### 调试模式\n```\n$ hexo --debug\n```\n在终端中显示调试信息并记录到 debug.log。当您碰到问题时，可以尝试用调试模式重新执行一次，并 提交调试信息到 GitHub。\n\n### 简洁模式\n```\n$ hexo --silent\n```\n隐藏终端信息。\n\n### 自定义配置文件的路径\n```\n$ hexo --config custom.yml\n```\n自定义配置文件的路径，执行后将不再使用 `_config.yml`。\n\n### 显示草稿\n```\n$ hexo --draft\n```\n显示 `source/_drafts` 文件夹中的草稿文章。\n\n### 自定义 CWD\n```\n$ hexo --cwd /path/to/cwd\n```\n自定义当前工作目录（Current working directory）的路径。\n","source":"_posts/hexo常用命令.md","raw":"---\ntitle: hexo常用命令\ndate: 2016-08-12 20:00:00\ntags:\n- hexo\n---\n\n## init\n```\n$ hexo init [folder]\n```\n新建一个网站。如果没有设置 folder ，Hexo 默认在目前的文件夹建立网站。\n\n## new\n```\n$ hexo new [layout] <title>\n```\n新建一篇文章。如果没有设置 layout 的话，默认使用 `_config.yml` 中的 default_layout 参数代替。如果标题包含空格的话，请使用引号括起来。\n\n\n<!-- more -->\n\n\n## generate\n```\n$ hexo generate\n```\n生成静态文件。\n\n  选项\t描述\n  -d, --deploy\t文件生成后立即部署网站\n  -w, --watch\t监视文件变动\n\n\n##  publish\n```\n$ hexo publish [layout] <filename>\n```\n发表草稿。\n\n## server\n```\n$ hexo server\n```\n启动服务器。默认情况下，访问网址为： http://localhost:4000/。\n\n  选项\t描述\n  -p, --port\t重设端口\n  -s, --static\t只使用静态文件\n  -l, --log\t启动日记记录，使用覆盖记录格式\n\n## deploy\n```\n$ hexo deploy\n```\n部署网站。\n\n  参数\t描述\n  -g, --generate\t部署之前预先生成静态文件\n\n## render\n```\n$ hexo render <file1> [file2] ...\n```\n渲染文件。\n\n  参数\t描述\n  -o, --output\t设置输出路径\n\n## migrate\n```\n$ hexo migrate <type>\n```\n从其他博客系统 迁移内容。\n\n## clean\n```\n$ hexo clean\n```\n清除缓存文件 (db.json) 和已生成的静态文件 (public)。\n\n## list\n```\n$ hexo list <type>\n```\n列出网站资料。\n\n## version\n```\n$ hexo version\n```\n显示 Hexo 版本。\n\n## 选项\n### 安全模式\n```\n$ hexo --safe\n```\n在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。\n\n### 调试模式\n```\n$ hexo --debug\n```\n在终端中显示调试信息并记录到 debug.log。当您碰到问题时，可以尝试用调试模式重新执行一次，并 提交调试信息到 GitHub。\n\n### 简洁模式\n```\n$ hexo --silent\n```\n隐藏终端信息。\n\n### 自定义配置文件的路径\n```\n$ hexo --config custom.yml\n```\n自定义配置文件的路径，执行后将不再使用 `_config.yml`。\n\n### 显示草稿\n```\n$ hexo --draft\n```\n显示 `source/_drafts` 文件夹中的草稿文章。\n\n### 自定义 CWD\n```\n$ hexo --cwd /path/to/cwd\n```\n自定义当前工作目录（Current working directory）的路径。\n","slug":"hexo常用命令","published":1,"updated":"2016-08-24T03:16:26.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxg003z699f56ch67gz","content":"<h2 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init\"></a>init</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo init [folder]</div></pre></td></tr></table></figure>\n<p>新建一个网站。如果没有设置 folder ，Hexo 默认在目前的文件夹建立网站。</p>\n<h2 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new [layout] &lt;title&gt;</div></pre></td></tr></table></figure>\n<p>新建一篇文章。如果没有设置 layout 的话，默认使用 <code>_config.yml</code> 中的 default_layout 参数代替。如果标题包含空格的话，请使用引号括起来。</p>\n<a id=\"more\"></a>\n<h2 id=\"generate\"><a href=\"#generate\" class=\"headerlink\" title=\"generate\"></a>generate</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>生成静态文件。</p>\n<p>  选项    描述<br>  -d, –deploy    文件生成后立即部署网站<br>  -w, –watch    监视文件变动</p>\n<h2 id=\"publish\"><a href=\"#publish\" class=\"headerlink\" title=\"publish\"></a>publish</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo publish [layout] &lt;filename&gt;</div></pre></td></tr></table></figure>\n<p>发表草稿。</p>\n<h2 id=\"server\"><a href=\"#server\" class=\"headerlink\" title=\"server\"></a>server</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>启动服务器。默认情况下，访问网址为： <a href=\"http://localhost:4000/。\" target=\"_blank\" rel=\"external\">http://localhost:4000/。</a></p>\n<p>  选项    描述<br>  -p, –port    重设端口<br>  -s, –static    只使用静态文件<br>  -l, –log    启动日记记录，使用覆盖记录格式</p>\n<h2 id=\"deploy\"><a href=\"#deploy\" class=\"headerlink\" title=\"deploy\"></a>deploy</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>部署网站。</p>\n<p>  参数    描述<br>  -g, –generate    部署之前预先生成静态文件</p>\n<h2 id=\"render\"><a href=\"#render\" class=\"headerlink\" title=\"render\"></a>render</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo render &lt;file1&gt; [file2] ...</div></pre></td></tr></table></figure>\n<p>渲染文件。</p>\n<p>  参数    描述<br>  -o, –output    设置输出路径</p>\n<h2 id=\"migrate\"><a href=\"#migrate\" class=\"headerlink\" title=\"migrate\"></a>migrate</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo migrate &lt;type&gt;</div></pre></td></tr></table></figure>\n<p>从其他博客系统 迁移内容。</p>\n<h2 id=\"clean\"><a href=\"#clean\" class=\"headerlink\" title=\"clean\"></a>clean</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo clean</div></pre></td></tr></table></figure>\n<p>清除缓存文件 (db.json) 和已生成的静态文件 (public)。</p>\n<h2 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo list &lt;type&gt;</div></pre></td></tr></table></figure>\n<p>列出网站资料。</p>\n<h2 id=\"version\"><a href=\"#version\" class=\"headerlink\" title=\"version\"></a>version</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo version</div></pre></td></tr></table></figure>\n<p>显示 Hexo 版本。</p>\n<h2 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h2><h3 id=\"安全模式\"><a href=\"#安全模式\" class=\"headerlink\" title=\"安全模式\"></a>安全模式</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --safe</div></pre></td></tr></table></figure>\n<p>在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。</p>\n<h3 id=\"调试模式\"><a href=\"#调试模式\" class=\"headerlink\" title=\"调试模式\"></a>调试模式</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --debug</div></pre></td></tr></table></figure>\n<p>在终端中显示调试信息并记录到 debug.log。当您碰到问题时，可以尝试用调试模式重新执行一次，并 提交调试信息到 GitHub。</p>\n<h3 id=\"简洁模式\"><a href=\"#简洁模式\" class=\"headerlink\" title=\"简洁模式\"></a>简洁模式</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --silent</div></pre></td></tr></table></figure>\n<p>隐藏终端信息。</p>\n<h3 id=\"自定义配置文件的路径\"><a href=\"#自定义配置文件的路径\" class=\"headerlink\" title=\"自定义配置文件的路径\"></a>自定义配置文件的路径</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --config custom.yml</div></pre></td></tr></table></figure>\n<p>自定义配置文件的路径，执行后将不再使用 <code>_config.yml</code>。</p>\n<h3 id=\"显示草稿\"><a href=\"#显示草稿\" class=\"headerlink\" title=\"显示草稿\"></a>显示草稿</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --draft</div></pre></td></tr></table></figure>\n<p>显示 <code>source/_drafts</code> 文件夹中的草稿文章。</p>\n<h3 id=\"自定义-CWD\"><a href=\"#自定义-CWD\" class=\"headerlink\" title=\"自定义 CWD\"></a>自定义 CWD</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --cwd /path/to/cwd</div></pre></td></tr></table></figure>\n<p>自定义当前工作目录（Current working directory）的路径。</p>\n","excerpt":"<h2 id=\"init\"><a href=\"#init\" class=\"headerlink\" title=\"init\"></a>init</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo init [folder]</div></pre></td></tr></table></figure>\n<p>新建一个网站。如果没有设置 folder ，Hexo 默认在目前的文件夹建立网站。</p>\n<h2 id=\"new\"><a href=\"#new\" class=\"headerlink\" title=\"new\"></a>new</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo new [layout] &lt;title&gt;</div></pre></td></tr></table></figure>\n<p>新建一篇文章。如果没有设置 layout 的话，默认使用 <code>_config.yml</code> 中的 default_layout 参数代替。如果标题包含空格的话，请使用引号括起来。</p>","more":"<h2 id=\"generate\"><a href=\"#generate\" class=\"headerlink\" title=\"generate\"></a>generate</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo generate</div></pre></td></tr></table></figure>\n<p>生成静态文件。</p>\n<p>  选项    描述<br>  -d, –deploy    文件生成后立即部署网站<br>  -w, –watch    监视文件变动</p>\n<h2 id=\"publish\"><a href=\"#publish\" class=\"headerlink\" title=\"publish\"></a>publish</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo publish [layout] &lt;filename&gt;</div></pre></td></tr></table></figure>\n<p>发表草稿。</p>\n<h2 id=\"server\"><a href=\"#server\" class=\"headerlink\" title=\"server\"></a>server</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo server</div></pre></td></tr></table></figure>\n<p>启动服务器。默认情况下，访问网址为： <a href=\"http://localhost:4000/。\">http://localhost:4000/。</a></p>\n<p>  选项    描述<br>  -p, –port    重设端口<br>  -s, –static    只使用静态文件<br>  -l, –log    启动日记记录，使用覆盖记录格式</p>\n<h2 id=\"deploy\"><a href=\"#deploy\" class=\"headerlink\" title=\"deploy\"></a>deploy</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo deploy</div></pre></td></tr></table></figure>\n<p>部署网站。</p>\n<p>  参数    描述<br>  -g, –generate    部署之前预先生成静态文件</p>\n<h2 id=\"render\"><a href=\"#render\" class=\"headerlink\" title=\"render\"></a>render</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo render &lt;file1&gt; [file2] ...</div></pre></td></tr></table></figure>\n<p>渲染文件。</p>\n<p>  参数    描述<br>  -o, –output    设置输出路径</p>\n<h2 id=\"migrate\"><a href=\"#migrate\" class=\"headerlink\" title=\"migrate\"></a>migrate</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo migrate &lt;type&gt;</div></pre></td></tr></table></figure>\n<p>从其他博客系统 迁移内容。</p>\n<h2 id=\"clean\"><a href=\"#clean\" class=\"headerlink\" title=\"clean\"></a>clean</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo clean</div></pre></td></tr></table></figure>\n<p>清除缓存文件 (db.json) 和已生成的静态文件 (public)。</p>\n<h2 id=\"list\"><a href=\"#list\" class=\"headerlink\" title=\"list\"></a>list</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo list &lt;type&gt;</div></pre></td></tr></table></figure>\n<p>列出网站资料。</p>\n<h2 id=\"version\"><a href=\"#version\" class=\"headerlink\" title=\"version\"></a>version</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo version</div></pre></td></tr></table></figure>\n<p>显示 Hexo 版本。</p>\n<h2 id=\"选项\"><a href=\"#选项\" class=\"headerlink\" title=\"选项\"></a>选项</h2><h3 id=\"安全模式\"><a href=\"#安全模式\" class=\"headerlink\" title=\"安全模式\"></a>安全模式</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --safe</div></pre></td></tr></table></figure>\n<p>在安全模式下，不会载入插件和脚本。当您在安装新插件遭遇问题时，可以尝试以安全模式重新执行。</p>\n<h3 id=\"调试模式\"><a href=\"#调试模式\" class=\"headerlink\" title=\"调试模式\"></a>调试模式</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --debug</div></pre></td></tr></table></figure>\n<p>在终端中显示调试信息并记录到 debug.log。当您碰到问题时，可以尝试用调试模式重新执行一次，并 提交调试信息到 GitHub。</p>\n<h3 id=\"简洁模式\"><a href=\"#简洁模式\" class=\"headerlink\" title=\"简洁模式\"></a>简洁模式</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --silent</div></pre></td></tr></table></figure>\n<p>隐藏终端信息。</p>\n<h3 id=\"自定义配置文件的路径\"><a href=\"#自定义配置文件的路径\" class=\"headerlink\" title=\"自定义配置文件的路径\"></a>自定义配置文件的路径</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --config custom.yml</div></pre></td></tr></table></figure>\n<p>自定义配置文件的路径，执行后将不再使用 <code>_config.yml</code>。</p>\n<h3 id=\"显示草稿\"><a href=\"#显示草稿\" class=\"headerlink\" title=\"显示草稿\"></a>显示草稿</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --draft</div></pre></td></tr></table></figure>\n<p>显示 <code>source/_drafts</code> 文件夹中的草稿文章。</p>\n<h3 id=\"自定义-CWD\"><a href=\"#自定义-CWD\" class=\"headerlink\" title=\"自定义 CWD\"></a>自定义 CWD</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">$ hexo --cwd /path/to/cwd</div></pre></td></tr></table></figure>\n<p>自定义当前工作目录（Current working directory）的路径。</p>"},{"title":".htaccess 文件功能及配置介绍","date":"2016-09-05T02:00:00.000Z","_content":"\nURL重定向是`.htaccess` 的重头戏，它可以将长地址转为短地址、将动态地址转为静态地址、重定向丢失的页面、防止盗链、实现自动语言转换等等。\n\n**难点：** 正则表达式的运用和理解。\n\n<!-- more -->\n## 准备 mod_rewrite\n要实现上述功能，首先得装上mod_rewrite 模块，并确保启用了该模块。\n\n一般我们会这样设置。\n```\n<IfModule mod_rewrite.c>\n  Options +FollowSymlinks\n  RewriteEngine on\n  ...\n\n<IfModule>\n```\n***Tips:***\n* FollowSymlinks:必须启用，这是rewrite引擎的安全要求。\n* RewriteEngine：用于启用rewrite引擎。\n\n## URL重写及重定向\n利用`.htaccess` 文件可以实现对URL的重写（rewrite）与重定向（redirect）\n1. 将`.html` 映射到`.php`\n```\n  Options +FollowSymlinks\n  RewriteEngine on\n  RewriteRule ^(.*)\\.html$ $1.php [NC]\n```\n***注***\n  - 必须保证服务器上有对应的`.php` 文件，否则会报 404\n  - 浏览器和搜索引擎可同事用`.html` 和`.php` 访问到网页。\n  - [NC] 表示不区分大小写\n\n2. 临时重定向（R=302）与永久重定向（R=301）\n```\nRewriteEngine on\nRewriteBase /\nRewriteRule ^(.*)\\.html $1.php [R,NC,L]\n```\n***注***\n  - RewriteBase 定义了重写基准目录。\n  > 例如，如虚拟机站点设在 /var/www目录下，删除这行这行将会导致重定向到 http://your-domain/var/www/1.php. 显然这不是我们想要的。如果RewriteBase /base/，那么将会重定向到http://your-domain/base/1.php.\n\n  - 对于重写基准目录，我们还可以将 `$1.php` 变成 `/$1.php` 实现直接变换，这是就可以将 `RewriteBase` 省略。\n  - 字母`L`，表示如果能匹配到本条规则，则本条规则是最后一条（Last），忽略之后的规则。\n\n  永久重定向（R=301）\n```\nRewriteEngine on\nRewriteRule ^(.*)$ http://newdomain/$1 [R=301,NC,L]\n```\n\n3. 为什么要用重定向\n  1. 通过重定向，浏览器知道页面位置发生变化，从而会改变地址栏到新的地址。\n  2. 通过重定向，搜索引擎能够发现位置发生变化，从而进行更新。\n  3. R=302，R=301都是亲搜索引擎的，是SEO的一个重要手段。\n  4. **URL重写用于将页面映射到本站的另一页面，而重写到另一个域名下，则安重定向处理。**\n\n4. 长短地址处理   \n> 利用URL重写，方便实现长短地址转换。\n\n  ```\nRewriteEngine on\nRewriteRule ^grab /public/files/download/download.php\n```\n若访问 http://your-domain/grab?file=my.zip, 则页面会实际执行该页面 http://your-domain/public/files/download/download.php?file=my.zip\n5. 去掉WWW\n```\nRewriteEngine on\nRewriteCond %{HTTP_HOST} ^(.*)$\nRewriteRule (.*) http://www\\.%1/$1 [R=301,L]\n```\n***注:***\n  - RewriteCond 定义了规则的生效条件。即，一个RewriteRule规则之前可以有一个或者多个RewriteCond指令。\n  - 语法：RewriteCond TestString CondPattern [flags]\n\n6. 加上www\n```\nRewriteEngine on\nRewriteCond %{HTTP_HOST} ^(.*)$\nRewriteRule (.*) http://www\\.%1/$1 [R=301,L]\n```\n\n7. 支持多域名访问\n\n  > 如果有些主机不支持多域名，那么`.htaccess` 或许也可以解决。\n\n  ```\n#one.com\nRewriteCond %{HTTP_HOST} one.com\nRewriteCond %{REQUEST_URI} !^/one\nRewriteRule ^(.*)$ /one/$1 [L]\n#two.com\nRewriteCond %{HTTP_HOST} two.com\nRewriteCond %{REQUEST_URI} !^/two\nRewriteRule ^(.*)$ /two/$1 [L]\n```\n\n## 改写查询字符串 QUERY_STRING\n所谓查询字符串，就是值URL问号之后的部分。\n1. 利用QSA转换 QUERY_STRING\n```\nRewriteEngine on\nRewriteRule /page/(.+) /page.php?page=$1 [QSA]\n```\n***注：***\n 1. 将会把 `/page/123?one=two` 映射到 `/page.php?page=123&one=two`.\n 2. 如果没有[QAS] 标志，则会映射到`page.php?page=123`.\n 3. 如果没有用到小括号正则表达式，就不需要 QSA\n > 例，将 `/simple/flat/link ` => server-side.php?first-var=flat&second-var=link\n\n    ```\nRewriteEngine on\nRewriteRule ^/simple/([^/]+)/([^/]+)/? /server-side.php?first-var=$1&second-var=$2 [QSA]\n```\n2. 利用RewriteCond 改写 QUERY_STRING\n```\nRewriteEngine On\nRewriteCond %{QUERY_STRING} foo=(.*)\nRewriteRule ^grab(.*) /page.php?bar=%1\n```\n  - 该规则将访问请求http://mysite/grab?foo=bar转换为http://mysite/page.php?bar=bar\n  - RewriteCond用于捕获查询字符串（QUERY_STRING）中变量foo的值，并存储在%1中\n  - QUERY_STRING是Apache定义的“变量=值”向量（数组）\n\n3. RewriteCond与QSA双剑齐发\n```\nRewriteEngine On\nRewriteCond %{QUERY_STRING} foo=(.+)\nRewriteRule ^grab/(.*) /%1/index.php?file=$1 [QSA]\n```\n - 会把/grab/foobar.zip?level=5&foo=bar 映射到 /bar/index.php?file=foobar.zip&level=5&foo=bar\n - 转换后根目录是bar目录\n - foobar.zip?level=5中的“问号”变成了foobar.zip&level=5中的“与”符号\n\n4. 剥离查询字符串\n> 只需在要开始剥离的链接后面加个“问号”，并且不要启用QSA标志，就可剥离查询字符串\n\n  ```\nRewriteEngine On\n# Whatever QS is\nRewriteCond %{QUERY_STRING} .\n# I don't want it with Question mark\nRewriteRule foo.php(.*) /foo.php? [L]\n```\n\n\n\n## 访问控制\n1. 文件访问控制\n> 利用Order、Files及FilesMatch命令实现的访问控制可以满足大部分要求，但是当用户被拒绝时，他们看到的是硕大的“403 Forbidden”，如果你不想伤害用户的感情，就需要显示一些别的东西，通过Rewrite就可以实现这个特性：\n\n  ```\nRewriteEngine On\nRewriteCond %{REQUEST_FILENAME} !^(.+)\\.css$\nRewriteCond %{REQUEST_FILENAME} !^(.+)\\.js$\nRewriteCond %{REQUEST_FILENAME} !special.zip$\nRewriteRule ^(.+)$ /chat/ [NC]\n```\n - 该规则将仅允许用户请求.css, .js类型的文件，还有special.zip文件\n - RewriteRule 后面指定了限制规则：映射到/char/目录下处理\n - RewriteCond 后面的“感叹号”(!)起到了“否定”作用，它表明，对不满足后面正则表达式者应用RewriteRule规则，也就是对当前类型的文件将不应用规则\n - RewriteCond 之间是以逻辑“与”连接的，也就是只有当三个条件都不满足时才执行RewriteRule\n - 该规则也会限制访问.htm, .jpg等格式\n - 该规则不可以放在虚拟站点根目录（/）下，否则会死循环\n - 如果是二级目录，如/test/，那么传入RewriteCond的参数是以/test/开始的，因此从(.+)获得的文件名也含有/test/，读者必须对此多加小心\n - 要想仅获得文件名，可以将(.+)替换成([^/]+)，并且去掉符号^，如下所示：\n```\nRewriteEngine On\nRewriteCond %{REQUEST_FILENAME} !([^/]+)\\.css$\nRewriteCond %{REQUEST_FILENAME} !([^/]+)\\.js$\nRewriteRule ^(.+)$ /chat/ [NC]\n```\n\n2. 用.htaccess阻止User-agent\n> User-agent用于浏览器向服务器“自报家门”，更确切的说是所有HTTP客户端都得用User-agent向服务器“自报家门”，以便服务器对不同的客户端作出不同响应。比如，某站点可能需要对浏览器、搜索引擎crawl还有各类下载工具作出不同的响应。服务器就是通过所谓的User-agent进行区分的。\n如果你的服务器提供某些资源的下载，那么你就必须多加小心诸如“迅雷”等下载软件，因为它们可能把你网站资源吸干，并且影响你的正常访客访问。\n\n  为此，我们可以利用Rewrite限制某些UA的访问：\n  ```\nRewriteEngine on\nRewriteCond %{HTTP_USER_AGENT} 2.0.50727 [NC]\nRewriteRule . abuse.txt [L]\n```\n - 该规则限制“迅雷”客户端下载资源，并将下载文件重置到abuse.txt\n - HTTP_USER_AGENT是Apache的内置变量\n - 2.0.50727是迅雷User-agent的特征字符串\n - RewriteRule后面的“点”表示“任意URI”，也就是不管请求的是什么，都输出abuse.txt\n\n  通常，我们不会仅限制一个UA。利用[OR]即可实现对多个UA作出统一处理：\n  ```\nRewriteEngine on\nRewriteCond %{HTTP_USER_AGENT} 2.0.50727 [NC,OR]\nRewriteCond %{HTTP_USER_AGENT} ^BlackWidow [NC,OR]\n# etc..\nRewriteCond %{HTTP_USER_AGENT} ^Net\\ Vampire [NC]\nRewriteRule . abuse.txt [L]\n```\n\n3. 用.htaccess阻止盗链(hot-linking)\n> 盗链，特别是图片，是非常可耻的！哪怕将图片复制到自己服务器上，也比盗用他人的图片链接来得光彩！\n\n  .htaccess的Rewrite功能可以提供非常简单、有效的方法阻止这种可耻行为：\n  ```\nRewriteEngine On\nRewriteCond %{HTTP_REFERER} !^$\nRewriteCond %{HTTP_REFERER} !^http://(www\\.)?lesca\\.me/ [NC]\nRewriteCond %{REQUEST_URI} !hotlink\\.png [NC]\nRewriteRule .*\\.(gif|jpg|png)$ /hotlink.png [NC]\n```\n简单解释一下该规则的功能：\n - 除本站以外其他网站都不得引用本站图片，具体可以理解为\n - 如果引用站点为“空”或者是“本站”，或者，所引用对象是“hotlink.png”，那么就允许访问\n - 再次提醒，RewriteCond之间默认的逻辑连接词是逻辑“与”\n - 这里的难点是理解逻辑转换，即德·摩根定律\n\n\n## htaccess 缺点\n说了这么多`.htaccess` 可以实现这么多的功能，那么它有没有什么缺点呢?\n\n答案是，当然有。由于开启了`.htaccess` 文件，当我们访问了一个地址对应到服务器端某个目录之后`Apache` 会遍历并解析每层目录下的`.htaccess` 文件，所有对服务器性能会有一定的影响。\n\n但是具体影响有多大，要不要使用还需要看具体的环境。或者需要进行前后对比在进行选择。\n\n## htaccess 生成工具\n说了这么多，貌似真正配置起来还是非常麻烦。不用着急目前网上有非常多`htaccess` 在线生成工具，可大大方便我们进行完成各种配置。\n\n如：[smarty .htaccess :http://htaccess.uuz.cc/](http://htaccess.uuz.cc/)\n\n[转自:Lesca技术宅](http://lesca.me/archives/htaccess-rewrite.html)\n","source":"_posts/htaccess 文件功能及配置整理.md","raw":"---\ntitle: .htaccess 文件功能及配置介绍\ndate: 2016-09-05 10:00:00\ntags:\n- Apache\n- .htaccess\ncategories:\n- Apache\n---\n\nURL重定向是`.htaccess` 的重头戏，它可以将长地址转为短地址、将动态地址转为静态地址、重定向丢失的页面、防止盗链、实现自动语言转换等等。\n\n**难点：** 正则表达式的运用和理解。\n\n<!-- more -->\n## 准备 mod_rewrite\n要实现上述功能，首先得装上mod_rewrite 模块，并确保启用了该模块。\n\n一般我们会这样设置。\n```\n<IfModule mod_rewrite.c>\n  Options +FollowSymlinks\n  RewriteEngine on\n  ...\n\n<IfModule>\n```\n***Tips:***\n* FollowSymlinks:必须启用，这是rewrite引擎的安全要求。\n* RewriteEngine：用于启用rewrite引擎。\n\n## URL重写及重定向\n利用`.htaccess` 文件可以实现对URL的重写（rewrite）与重定向（redirect）\n1. 将`.html` 映射到`.php`\n```\n  Options +FollowSymlinks\n  RewriteEngine on\n  RewriteRule ^(.*)\\.html$ $1.php [NC]\n```\n***注***\n  - 必须保证服务器上有对应的`.php` 文件，否则会报 404\n  - 浏览器和搜索引擎可同事用`.html` 和`.php` 访问到网页。\n  - [NC] 表示不区分大小写\n\n2. 临时重定向（R=302）与永久重定向（R=301）\n```\nRewriteEngine on\nRewriteBase /\nRewriteRule ^(.*)\\.html $1.php [R,NC,L]\n```\n***注***\n  - RewriteBase 定义了重写基准目录。\n  > 例如，如虚拟机站点设在 /var/www目录下，删除这行这行将会导致重定向到 http://your-domain/var/www/1.php. 显然这不是我们想要的。如果RewriteBase /base/，那么将会重定向到http://your-domain/base/1.php.\n\n  - 对于重写基准目录，我们还可以将 `$1.php` 变成 `/$1.php` 实现直接变换，这是就可以将 `RewriteBase` 省略。\n  - 字母`L`，表示如果能匹配到本条规则，则本条规则是最后一条（Last），忽略之后的规则。\n\n  永久重定向（R=301）\n```\nRewriteEngine on\nRewriteRule ^(.*)$ http://newdomain/$1 [R=301,NC,L]\n```\n\n3. 为什么要用重定向\n  1. 通过重定向，浏览器知道页面位置发生变化，从而会改变地址栏到新的地址。\n  2. 通过重定向，搜索引擎能够发现位置发生变化，从而进行更新。\n  3. R=302，R=301都是亲搜索引擎的，是SEO的一个重要手段。\n  4. **URL重写用于将页面映射到本站的另一页面，而重写到另一个域名下，则安重定向处理。**\n\n4. 长短地址处理   \n> 利用URL重写，方便实现长短地址转换。\n\n  ```\nRewriteEngine on\nRewriteRule ^grab /public/files/download/download.php\n```\n若访问 http://your-domain/grab?file=my.zip, 则页面会实际执行该页面 http://your-domain/public/files/download/download.php?file=my.zip\n5. 去掉WWW\n```\nRewriteEngine on\nRewriteCond %{HTTP_HOST} ^(.*)$\nRewriteRule (.*) http://www\\.%1/$1 [R=301,L]\n```\n***注:***\n  - RewriteCond 定义了规则的生效条件。即，一个RewriteRule规则之前可以有一个或者多个RewriteCond指令。\n  - 语法：RewriteCond TestString CondPattern [flags]\n\n6. 加上www\n```\nRewriteEngine on\nRewriteCond %{HTTP_HOST} ^(.*)$\nRewriteRule (.*) http://www\\.%1/$1 [R=301,L]\n```\n\n7. 支持多域名访问\n\n  > 如果有些主机不支持多域名，那么`.htaccess` 或许也可以解决。\n\n  ```\n#one.com\nRewriteCond %{HTTP_HOST} one.com\nRewriteCond %{REQUEST_URI} !^/one\nRewriteRule ^(.*)$ /one/$1 [L]\n#two.com\nRewriteCond %{HTTP_HOST} two.com\nRewriteCond %{REQUEST_URI} !^/two\nRewriteRule ^(.*)$ /two/$1 [L]\n```\n\n## 改写查询字符串 QUERY_STRING\n所谓查询字符串，就是值URL问号之后的部分。\n1. 利用QSA转换 QUERY_STRING\n```\nRewriteEngine on\nRewriteRule /page/(.+) /page.php?page=$1 [QSA]\n```\n***注：***\n 1. 将会把 `/page/123?one=two` 映射到 `/page.php?page=123&one=two`.\n 2. 如果没有[QAS] 标志，则会映射到`page.php?page=123`.\n 3. 如果没有用到小括号正则表达式，就不需要 QSA\n > 例，将 `/simple/flat/link ` => server-side.php?first-var=flat&second-var=link\n\n    ```\nRewriteEngine on\nRewriteRule ^/simple/([^/]+)/([^/]+)/? /server-side.php?first-var=$1&second-var=$2 [QSA]\n```\n2. 利用RewriteCond 改写 QUERY_STRING\n```\nRewriteEngine On\nRewriteCond %{QUERY_STRING} foo=(.*)\nRewriteRule ^grab(.*) /page.php?bar=%1\n```\n  - 该规则将访问请求http://mysite/grab?foo=bar转换为http://mysite/page.php?bar=bar\n  - RewriteCond用于捕获查询字符串（QUERY_STRING）中变量foo的值，并存储在%1中\n  - QUERY_STRING是Apache定义的“变量=值”向量（数组）\n\n3. RewriteCond与QSA双剑齐发\n```\nRewriteEngine On\nRewriteCond %{QUERY_STRING} foo=(.+)\nRewriteRule ^grab/(.*) /%1/index.php?file=$1 [QSA]\n```\n - 会把/grab/foobar.zip?level=5&foo=bar 映射到 /bar/index.php?file=foobar.zip&level=5&foo=bar\n - 转换后根目录是bar目录\n - foobar.zip?level=5中的“问号”变成了foobar.zip&level=5中的“与”符号\n\n4. 剥离查询字符串\n> 只需在要开始剥离的链接后面加个“问号”，并且不要启用QSA标志，就可剥离查询字符串\n\n  ```\nRewriteEngine On\n# Whatever QS is\nRewriteCond %{QUERY_STRING} .\n# I don't want it with Question mark\nRewriteRule foo.php(.*) /foo.php? [L]\n```\n\n\n\n## 访问控制\n1. 文件访问控制\n> 利用Order、Files及FilesMatch命令实现的访问控制可以满足大部分要求，但是当用户被拒绝时，他们看到的是硕大的“403 Forbidden”，如果你不想伤害用户的感情，就需要显示一些别的东西，通过Rewrite就可以实现这个特性：\n\n  ```\nRewriteEngine On\nRewriteCond %{REQUEST_FILENAME} !^(.+)\\.css$\nRewriteCond %{REQUEST_FILENAME} !^(.+)\\.js$\nRewriteCond %{REQUEST_FILENAME} !special.zip$\nRewriteRule ^(.+)$ /chat/ [NC]\n```\n - 该规则将仅允许用户请求.css, .js类型的文件，还有special.zip文件\n - RewriteRule 后面指定了限制规则：映射到/char/目录下处理\n - RewriteCond 后面的“感叹号”(!)起到了“否定”作用，它表明，对不满足后面正则表达式者应用RewriteRule规则，也就是对当前类型的文件将不应用规则\n - RewriteCond 之间是以逻辑“与”连接的，也就是只有当三个条件都不满足时才执行RewriteRule\n - 该规则也会限制访问.htm, .jpg等格式\n - 该规则不可以放在虚拟站点根目录（/）下，否则会死循环\n - 如果是二级目录，如/test/，那么传入RewriteCond的参数是以/test/开始的，因此从(.+)获得的文件名也含有/test/，读者必须对此多加小心\n - 要想仅获得文件名，可以将(.+)替换成([^/]+)，并且去掉符号^，如下所示：\n```\nRewriteEngine On\nRewriteCond %{REQUEST_FILENAME} !([^/]+)\\.css$\nRewriteCond %{REQUEST_FILENAME} !([^/]+)\\.js$\nRewriteRule ^(.+)$ /chat/ [NC]\n```\n\n2. 用.htaccess阻止User-agent\n> User-agent用于浏览器向服务器“自报家门”，更确切的说是所有HTTP客户端都得用User-agent向服务器“自报家门”，以便服务器对不同的客户端作出不同响应。比如，某站点可能需要对浏览器、搜索引擎crawl还有各类下载工具作出不同的响应。服务器就是通过所谓的User-agent进行区分的。\n如果你的服务器提供某些资源的下载，那么你就必须多加小心诸如“迅雷”等下载软件，因为它们可能把你网站资源吸干，并且影响你的正常访客访问。\n\n  为此，我们可以利用Rewrite限制某些UA的访问：\n  ```\nRewriteEngine on\nRewriteCond %{HTTP_USER_AGENT} 2.0.50727 [NC]\nRewriteRule . abuse.txt [L]\n```\n - 该规则限制“迅雷”客户端下载资源，并将下载文件重置到abuse.txt\n - HTTP_USER_AGENT是Apache的内置变量\n - 2.0.50727是迅雷User-agent的特征字符串\n - RewriteRule后面的“点”表示“任意URI”，也就是不管请求的是什么，都输出abuse.txt\n\n  通常，我们不会仅限制一个UA。利用[OR]即可实现对多个UA作出统一处理：\n  ```\nRewriteEngine on\nRewriteCond %{HTTP_USER_AGENT} 2.0.50727 [NC,OR]\nRewriteCond %{HTTP_USER_AGENT} ^BlackWidow [NC,OR]\n# etc..\nRewriteCond %{HTTP_USER_AGENT} ^Net\\ Vampire [NC]\nRewriteRule . abuse.txt [L]\n```\n\n3. 用.htaccess阻止盗链(hot-linking)\n> 盗链，特别是图片，是非常可耻的！哪怕将图片复制到自己服务器上，也比盗用他人的图片链接来得光彩！\n\n  .htaccess的Rewrite功能可以提供非常简单、有效的方法阻止这种可耻行为：\n  ```\nRewriteEngine On\nRewriteCond %{HTTP_REFERER} !^$\nRewriteCond %{HTTP_REFERER} !^http://(www\\.)?lesca\\.me/ [NC]\nRewriteCond %{REQUEST_URI} !hotlink\\.png [NC]\nRewriteRule .*\\.(gif|jpg|png)$ /hotlink.png [NC]\n```\n简单解释一下该规则的功能：\n - 除本站以外其他网站都不得引用本站图片，具体可以理解为\n - 如果引用站点为“空”或者是“本站”，或者，所引用对象是“hotlink.png”，那么就允许访问\n - 再次提醒，RewriteCond之间默认的逻辑连接词是逻辑“与”\n - 这里的难点是理解逻辑转换，即德·摩根定律\n\n\n## htaccess 缺点\n说了这么多`.htaccess` 可以实现这么多的功能，那么它有没有什么缺点呢?\n\n答案是，当然有。由于开启了`.htaccess` 文件，当我们访问了一个地址对应到服务器端某个目录之后`Apache` 会遍历并解析每层目录下的`.htaccess` 文件，所有对服务器性能会有一定的影响。\n\n但是具体影响有多大，要不要使用还需要看具体的环境。或者需要进行前后对比在进行选择。\n\n## htaccess 生成工具\n说了这么多，貌似真正配置起来还是非常麻烦。不用着急目前网上有非常多`htaccess` 在线生成工具，可大大方便我们进行完成各种配置。\n\n如：[smarty .htaccess :http://htaccess.uuz.cc/](http://htaccess.uuz.cc/)\n\n[转自:Lesca技术宅](http://lesca.me/archives/htaccess-rewrite.html)\n","slug":"htaccess 文件功能及配置整理","published":1,"updated":"2016-09-05T11:44:28.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxi0042699fvufi6jq2","content":"<p>URL重定向是<code>.htaccess</code> 的重头戏，它可以将长地址转为短地址、将动态地址转为静态地址、重定向丢失的页面、防止盗链、实现自动语言转换等等。</p>\n<p><strong>难点：</strong> 正则表达式的运用和理解。</p>\n<a id=\"more\"></a>\n<h2 id=\"准备-mod-rewrite\"><a href=\"#准备-mod-rewrite\" class=\"headerlink\" title=\"准备 mod_rewrite\"></a>准备 mod_rewrite</h2><p>要实现上述功能，首先得装上mod_rewrite 模块，并确保启用了该模块。</p>\n<p>一般我们会这样设置。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule mod_rewrite.c&gt;</div><div class=\"line\">  Options +FollowSymlinks</div><div class=\"line\">  RewriteEngine on</div><div class=\"line\">  ...</div><div class=\"line\"></div><div class=\"line\">&lt;IfModule&gt;</div></pre></td></tr></table></figure></p>\n<p><strong><em>Tips:</em></strong></p>\n<ul>\n<li>FollowSymlinks:必须启用，这是rewrite引擎的安全要求。</li>\n<li>RewriteEngine：用于启用rewrite引擎。</li>\n</ul>\n<h2 id=\"URL重写及重定向\"><a href=\"#URL重写及重定向\" class=\"headerlink\" title=\"URL重写及重定向\"></a>URL重写及重定向</h2><p>利用<code>.htaccess</code> 文件可以实现对URL的重写（rewrite）与重定向（redirect）</p>\n<ol>\n<li>将<code>.html</code> 映射到<code>.php</code><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">Options +FollowSymlinks</div><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^(.*)\\.html$ $1.php [NC]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注</em></strong></p>\n<ul>\n<li>必须保证服务器上有对应的<code>.php</code> 文件，否则会报 404</li>\n<li>浏览器和搜索引擎可同事用<code>.html</code> 和<code>.php</code> 访问到网页。</li>\n<li>[NC] 表示不区分大小写</li>\n</ul>\n<ol>\n<li>临时重定向（R=302）与永久重定向（R=301）<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteBase /</div><div class=\"line\">RewriteRule ^(.*)\\.html $1.php [R,NC,L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注</em></strong></p>\n<ul>\n<li><p>RewriteBase 定义了重写基准目录。</p>\n<blockquote>\n<p>例如，如虚拟机站点设在 /var/www目录下，删除这行这行将会导致重定向到 <a href=\"http://your-domain/var/www/1.php\" target=\"_blank\" rel=\"external\">http://your-domain/var/www/1.php</a>. 显然这不是我们想要的。如果RewriteBase /base/，那么将会重定向到<a href=\"http://your-domain/base/1.php\" target=\"_blank\" rel=\"external\">http://your-domain/base/1.php</a>.</p>\n</blockquote>\n</li>\n<li><p>对于重写基准目录，我们还可以将 <code>$1.php</code> 变成 <code>/$1.php</code> 实现直接变换，这是就可以将 <code>RewriteBase</code> 省略。</p>\n</li>\n<li><p>字母<code>L</code>，表示如果能匹配到本条规则，则本条规则是最后一条（Last），忽略之后的规则。</p>\n<p>永久重定向（R=301）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^(.*)$ http://newdomain/$1 [R=301,NC,L]</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<ol>\n<li><p>为什么要用重定向</p>\n<ol>\n<li>通过重定向，浏览器知道页面位置发生变化，从而会改变地址栏到新的地址。</li>\n<li>通过重定向，搜索引擎能够发现位置发生变化，从而进行更新。</li>\n<li>R=302，R=301都是亲搜索引擎的，是SEO的一个重要手段。</li>\n<li><strong>URL重写用于将页面映射到本站的另一页面，而重写到另一个域名下，则安重定向处理。</strong></li>\n</ol>\n</li>\n<li><p>长短地址处理   </p>\n<blockquote>\n<p>利用URL重写，方便实现长短地址转换。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^grab /public/files/download/download.php</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>若访问 <a href=\"http://your-domain/grab?file=my.zip\" target=\"_blank\" rel=\"external\">http://your-domain/grab?file=my.zip</a>, 则页面会实际执行该页面 <a href=\"http://your-domain/public/files/download/download.php?file=my.zip\" target=\"_blank\" rel=\"external\">http://your-domain/public/files/download/download.php?file=my.zip</a></p>\n<ol>\n<li>去掉WWW<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; ^(.*)$</div><div class=\"line\">RewriteRule (.*) http://www\\.%1/$1 [R=301,L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注:</em></strong></p>\n<ul>\n<li>RewriteCond 定义了规则的生效条件。即，一个RewriteRule规则之前可以有一个或者多个RewriteCond指令。</li>\n<li>语法：RewriteCond TestString CondPattern [flags]</li>\n</ul>\n<ol>\n<li><p>加上www</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; ^(.*)$</div><div class=\"line\">RewriteRule (.*) http://www\\.%1/$1 [R=301,L]</div></pre></td></tr></table></figure>\n</li>\n<li><p>支持多域名访问</p>\n<blockquote>\n<p>如果有些主机不支持多域名，那么<code>.htaccess</code> 或许也可以解决。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">#one.com</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; one.com</div><div class=\"line\">RewriteCond %&#123;REQUEST_URI&#125; !^/one</div><div class=\"line\">RewriteRule ^(.*)$ /one/$1 [L]</div><div class=\"line\">#two.com</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; two.com</div><div class=\"line\">RewriteCond %&#123;REQUEST_URI&#125; !^/two</div><div class=\"line\">RewriteRule ^(.*)$ /two/$1 [L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"改写查询字符串-QUERY-STRING\"><a href=\"#改写查询字符串-QUERY-STRING\" class=\"headerlink\" title=\"改写查询字符串 QUERY_STRING\"></a>改写查询字符串 QUERY_STRING</h2><p>所谓查询字符串，就是值URL问号之后的部分。</p>\n<ol>\n<li>利用QSA转换 QUERY_STRING<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule /page/(.+) /page.php?page=$1 [QSA]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注：</em></strong></p>\n<ol>\n<li>将会把 <code>/page/123?one=two</code> 映射到 <code>/page.php?page=123&amp;one=two</code>.</li>\n<li>如果没有[QAS] 标志，则会映射到<code>page.php?page=123</code>.</li>\n<li><p>如果没有用到小括号正则表达式，就不需要 QSA</p>\n<blockquote>\n<p>例，将 <code>/simple/flat/link</code> =&gt; server-side.php?first-var=flat&amp;second-var=link</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^/simple/([^/]+)/([^/]+)/? /server-side.php?first-var=$1&amp;second-var=$2 [QSA]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<ol>\n<li><p>利用RewriteCond 改写 QUERY_STRING</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;QUERY_STRING&#125; foo=(.*)</div><div class=\"line\">RewriteRule ^grab(.*) /page.php?bar=%1</div></pre></td></tr></table></figure>\n<ul>\n<li>该规则将访问请求<a href=\"http://mysite/grab?foo=bar转换为http://mysite/page.php?bar=bar\" target=\"_blank\" rel=\"external\">http://mysite/grab?foo=bar转换为http://mysite/page.php?bar=bar</a></li>\n<li>RewriteCond用于捕获查询字符串（QUERY_STRING）中变量foo的值，并存储在%1中</li>\n<li>QUERY_STRING是Apache定义的“变量=值”向量（数组）</li>\n</ul>\n</li>\n<li><p>RewriteCond与QSA双剑齐发</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;QUERY_STRING&#125; foo=(.+)</div><div class=\"line\">RewriteRule ^grab/(.*) /%1/index.php?file=$1 [QSA]</div></pre></td></tr></table></figure>\n<ul>\n<li>会把/grab/foobar.zip?level=5&amp;foo=bar 映射到 /bar/index.php?file=foobar.zip&amp;level=5&amp;foo=bar</li>\n<li>转换后根目录是bar目录</li>\n<li>foobar.zip?level=5中的“问号”变成了foobar.zip&amp;level=5中的“与”符号</li>\n</ul>\n</li>\n<li><p>剥离查询字符串</p>\n<blockquote>\n<p>只需在要开始剥离的链接后面加个“问号”，并且不要启用QSA标志，就可剥离查询字符串</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\"># Whatever QS is</div><div class=\"line\">RewriteCond %&#123;QUERY_STRING&#125; .</div><div class=\"line\"># I don&apos;t want it with Question mark</div><div class=\"line\">RewriteRule foo.php(.*) /foo.php? [L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"访问控制\"><a href=\"#访问控制\" class=\"headerlink\" title=\"访问控制\"></a>访问控制</h2><ol>\n<li><p>文件访问控制</p>\n<blockquote>\n<p>利用Order、Files及FilesMatch命令实现的访问控制可以满足大部分要求，但是当用户被拒绝时，他们看到的是硕大的“403 Forbidden”，如果你不想伤害用户的感情，就需要显示一些别的东西，通过Rewrite就可以实现这个特性：</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !^(.+)\\.css$</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !^(.+)\\.js$</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !special.zip$</div><div class=\"line\">RewriteRule ^(.+)$ /chat/ [NC]</div></pre></td></tr></table></figure>\n<ul>\n<li>该规则将仅允许用户请求.css, .js类型的文件，还有special.zip文件</li>\n<li>RewriteRule 后面指定了限制规则：映射到/char/目录下处理</li>\n<li>RewriteCond 后面的“感叹号”(!)起到了“否定”作用，它表明，对不满足后面正则表达式者应用RewriteRule规则，也就是对当前类型的文件将不应用规则</li>\n<li>RewriteCond 之间是以逻辑“与”连接的，也就是只有当三个条件都不满足时才执行RewriteRule</li>\n<li>该规则也会限制访问.htm, .jpg等格式</li>\n<li>该规则不可以放在虚拟站点根目录（/）下，否则会死循环</li>\n<li>如果是二级目录，如/test/，那么传入RewriteCond的参数是以/test/开始的，因此从(.+)获得的文件名也含有/test/，读者必须对此多加小心</li>\n<li>要想仅获得文件名，可以将(.+)替换成([^/]+)，并且去掉符号^，如下所示：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !([^/]+)\\.css$</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !([^/]+)\\.js$</div><div class=\"line\">RewriteRule ^(.+)$ /chat/ [NC]</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>用.htaccess阻止User-agent</p>\n<blockquote>\n<p>User-agent用于浏览器向服务器“自报家门”，更确切的说是所有HTTP客户端都得用User-agent向服务器“自报家门”，以便服务器对不同的客户端作出不同响应。比如，某站点可能需要对浏览器、搜索引擎crawl还有各类下载工具作出不同的响应。服务器就是通过所谓的User-agent进行区分的。<br>如果你的服务器提供某些资源的下载，那么你就必须多加小心诸如“迅雷”等下载软件，因为它们可能把你网站资源吸干，并且影响你的正常访客访问。</p>\n</blockquote>\n<p>为此，我们可以利用Rewrite限制某些UA的访问：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; 2.0.50727 [NC]</div><div class=\"line\">RewriteRule . abuse.txt [L]</div></pre></td></tr></table></figure>\n<ul>\n<li>该规则限制“迅雷”客户端下载资源，并将下载文件重置到abuse.txt</li>\n<li>HTTP_USER_AGENT是Apache的内置变量</li>\n<li>2.0.50727是迅雷User-agent的特征字符串</li>\n<li>RewriteRule后面的“点”表示“任意URI”，也就是不管请求的是什么，都输出abuse.txt</li>\n</ul>\n<p>通常，我们不会仅限制一个UA。利用[OR]即可实现对多个UA作出统一处理：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; 2.0.50727 [NC,OR]</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; ^BlackWidow [NC,OR]</div><div class=\"line\"># etc..</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; ^Net\\ Vampire [NC]</div><div class=\"line\">RewriteRule . abuse.txt [L]</div></pre></td></tr></table></figure>\n</li>\n<li><p>用.htaccess阻止盗链(hot-linking)</p>\n<blockquote>\n<p>盗链，特别是图片，是非常可耻的！哪怕将图片复制到自己服务器上，也比盗用他人的图片链接来得光彩！</p>\n</blockquote>\n<p>.htaccess的Rewrite功能可以提供非常简单、有效的方法阻止这种可耻行为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;HTTP_REFERER&#125; !^$</div><div class=\"line\">RewriteCond %&#123;HTTP_REFERER&#125; !^http://(www\\.)?lesca\\.me/ [NC]</div><div class=\"line\">RewriteCond %&#123;REQUEST_URI&#125; !hotlink\\.png [NC]</div><div class=\"line\">RewriteRule .*\\.(gif|jpg|png)$ /hotlink.png [NC]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>简单解释一下该规则的功能：</p>\n<ul>\n<li>除本站以外其他网站都不得引用本站图片，具体可以理解为</li>\n<li>如果引用站点为“空”或者是“本站”，或者，所引用对象是“hotlink.png”，那么就允许访问</li>\n<li>再次提醒，RewriteCond之间默认的逻辑连接词是逻辑“与”</li>\n<li>这里的难点是理解逻辑转换，即德·摩根定律</li>\n</ul>\n<h2 id=\"htaccess-缺点\"><a href=\"#htaccess-缺点\" class=\"headerlink\" title=\"htaccess 缺点\"></a>htaccess 缺点</h2><p>说了这么多<code>.htaccess</code> 可以实现这么多的功能，那么它有没有什么缺点呢?</p>\n<p>答案是，当然有。由于开启了<code>.htaccess</code> 文件，当我们访问了一个地址对应到服务器端某个目录之后<code>Apache</code> 会遍历并解析每层目录下的<code>.htaccess</code> 文件，所有对服务器性能会有一定的影响。</p>\n<p>但是具体影响有多大，要不要使用还需要看具体的环境。或者需要进行前后对比在进行选择。</p>\n<h2 id=\"htaccess-生成工具\"><a href=\"#htaccess-生成工具\" class=\"headerlink\" title=\"htaccess 生成工具\"></a>htaccess 生成工具</h2><p>说了这么多，貌似真正配置起来还是非常麻烦。不用着急目前网上有非常多<code>htaccess</code> 在线生成工具，可大大方便我们进行完成各种配置。</p>\n<p>如：<a href=\"http://htaccess.uuz.cc/\" target=\"_blank\" rel=\"external\">smarty .htaccess :http://htaccess.uuz.cc/</a></p>\n<p><a href=\"http://lesca.me/archives/htaccess-rewrite.html\" target=\"_blank\" rel=\"external\">转自:Lesca技术宅</a></p>\n","excerpt":"<p>URL重定向是<code>.htaccess</code> 的重头戏，它可以将长地址转为短地址、将动态地址转为静态地址、重定向丢失的页面、防止盗链、实现自动语言转换等等。</p>\n<p><strong>难点：</strong> 正则表达式的运用和理解。</p>","more":"<h2 id=\"准备-mod-rewrite\"><a href=\"#准备-mod-rewrite\" class=\"headerlink\" title=\"准备 mod_rewrite\"></a>准备 mod_rewrite</h2><p>要实现上述功能，首先得装上mod_rewrite 模块，并确保启用了该模块。</p>\n<p>一般我们会这样设置。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">&lt;IfModule mod_rewrite.c&gt;</div><div class=\"line\">  Options +FollowSymlinks</div><div class=\"line\">  RewriteEngine on</div><div class=\"line\">  ...</div><div class=\"line\"></div><div class=\"line\">&lt;IfModule&gt;</div></pre></td></tr></table></figure></p>\n<p><strong><em>Tips:</em></strong></p>\n<ul>\n<li>FollowSymlinks:必须启用，这是rewrite引擎的安全要求。</li>\n<li>RewriteEngine：用于启用rewrite引擎。</li>\n</ul>\n<h2 id=\"URL重写及重定向\"><a href=\"#URL重写及重定向\" class=\"headerlink\" title=\"URL重写及重定向\"></a>URL重写及重定向</h2><p>利用<code>.htaccess</code> 文件可以实现对URL的重写（rewrite）与重定向（redirect）</p>\n<ol>\n<li>将<code>.html</code> 映射到<code>.php</code><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">Options +FollowSymlinks</div><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^(.*)\\.html$ $1.php [NC]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注</em></strong></p>\n<ul>\n<li>必须保证服务器上有对应的<code>.php</code> 文件，否则会报 404</li>\n<li>浏览器和搜索引擎可同事用<code>.html</code> 和<code>.php</code> 访问到网页。</li>\n<li>[NC] 表示不区分大小写</li>\n</ul>\n<ol>\n<li>临时重定向（R=302）与永久重定向（R=301）<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteBase /</div><div class=\"line\">RewriteRule ^(.*)\\.html $1.php [R,NC,L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注</em></strong></p>\n<ul>\n<li><p>RewriteBase 定义了重写基准目录。</p>\n<blockquote>\n<p>例如，如虚拟机站点设在 /var/www目录下，删除这行这行将会导致重定向到 <a href=\"http://your-domain/var/www/1.php\">http://your-domain/var/www/1.php</a>. 显然这不是我们想要的。如果RewriteBase /base/，那么将会重定向到<a href=\"http://your-domain/base/1.php\">http://your-domain/base/1.php</a>.</p>\n</blockquote>\n</li>\n<li><p>对于重写基准目录，我们还可以将 <code>$1.php</code> 变成 <code>/$1.php</code> 实现直接变换，这是就可以将 <code>RewriteBase</code> 省略。</p>\n</li>\n<li><p>字母<code>L</code>，表示如果能匹配到本条规则，则本条规则是最后一条（Last），忽略之后的规则。</p>\n<p>永久重定向（R=301）</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^(.*)$ http://newdomain/$1 [R=301,NC,L]</div></pre></td></tr></table></figure>\n</li>\n</ul>\n<ol>\n<li><p>为什么要用重定向</p>\n<ol>\n<li>通过重定向，浏览器知道页面位置发生变化，从而会改变地址栏到新的地址。</li>\n<li>通过重定向，搜索引擎能够发现位置发生变化，从而进行更新。</li>\n<li>R=302，R=301都是亲搜索引擎的，是SEO的一个重要手段。</li>\n<li><strong>URL重写用于将页面映射到本站的另一页面，而重写到另一个域名下，则安重定向处理。</strong></li>\n</ol>\n</li>\n<li><p>长短地址处理   </p>\n<blockquote>\n<p>利用URL重写，方便实现长短地址转换。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^grab /public/files/download/download.php</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>若访问 <a href=\"http://your-domain/grab?file=my.zip\">http://your-domain/grab?file=my.zip</a>, 则页面会实际执行该页面 <a href=\"http://your-domain/public/files/download/download.php?file=my.zip\">http://your-domain/public/files/download/download.php?file=my.zip</a></p>\n<ol>\n<li>去掉WWW<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; ^(.*)$</div><div class=\"line\">RewriteRule (.*) http://www\\.%1/$1 [R=301,L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注:</em></strong></p>\n<ul>\n<li>RewriteCond 定义了规则的生效条件。即，一个RewriteRule规则之前可以有一个或者多个RewriteCond指令。</li>\n<li>语法：RewriteCond TestString CondPattern [flags]</li>\n</ul>\n<ol>\n<li><p>加上www</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; ^(.*)$</div><div class=\"line\">RewriteRule (.*) http://www\\.%1/$1 [R=301,L]</div></pre></td></tr></table></figure>\n</li>\n<li><p>支持多域名访问</p>\n<blockquote>\n<p>如果有些主机不支持多域名，那么<code>.htaccess</code> 或许也可以解决。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">#one.com</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; one.com</div><div class=\"line\">RewriteCond %&#123;REQUEST_URI&#125; !^/one</div><div class=\"line\">RewriteRule ^(.*)$ /one/$1 [L]</div><div class=\"line\">#two.com</div><div class=\"line\">RewriteCond %&#123;HTTP_HOST&#125; two.com</div><div class=\"line\">RewriteCond %&#123;REQUEST_URI&#125; !^/two</div><div class=\"line\">RewriteRule ^(.*)$ /two/$1 [L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"改写查询字符串-QUERY-STRING\"><a href=\"#改写查询字符串-QUERY-STRING\" class=\"headerlink\" title=\"改写查询字符串 QUERY_STRING\"></a>改写查询字符串 QUERY_STRING</h2><p>所谓查询字符串，就是值URL问号之后的部分。</p>\n<ol>\n<li>利用QSA转换 QUERY_STRING<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule /page/(.+) /page.php?page=$1 [QSA]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p><strong><em>注：</em></strong></p>\n<ol>\n<li>将会把 <code>/page/123?one=two</code> 映射到 <code>/page.php?page=123&amp;one=two</code>.</li>\n<li>如果没有[QAS] 标志，则会映射到<code>page.php?page=123</code>.</li>\n<li><p>如果没有用到小括号正则表达式，就不需要 QSA</p>\n<blockquote>\n<p>例，将 <code>/simple/flat/link</code> =&gt; server-side.php?first-var=flat&amp;second-var=link</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteRule ^/simple/([^/]+)/([^/]+)/? /server-side.php?first-var=$1&amp;second-var=$2 [QSA]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<ol>\n<li><p>利用RewriteCond 改写 QUERY_STRING</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;QUERY_STRING&#125; foo=(.*)</div><div class=\"line\">RewriteRule ^grab(.*) /page.php?bar=%1</div></pre></td></tr></table></figure>\n<ul>\n<li>该规则将访问请求<a href=\"http://mysite/grab?foo=bar转换为http://mysite/page.php?bar=bar\">http://mysite/grab?foo=bar转换为http://mysite/page.php?bar=bar</a></li>\n<li>RewriteCond用于捕获查询字符串（QUERY_STRING）中变量foo的值，并存储在%1中</li>\n<li>QUERY_STRING是Apache定义的“变量=值”向量（数组）</li>\n</ul>\n</li>\n<li><p>RewriteCond与QSA双剑齐发</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;QUERY_STRING&#125; foo=(.+)</div><div class=\"line\">RewriteRule ^grab/(.*) /%1/index.php?file=$1 [QSA]</div></pre></td></tr></table></figure>\n<ul>\n<li>会把/grab/foobar.zip?level=5&amp;foo=bar 映射到 /bar/index.php?file=foobar.zip&amp;level=5&amp;foo=bar</li>\n<li>转换后根目录是bar目录</li>\n<li>foobar.zip?level=5中的“问号”变成了foobar.zip&amp;level=5中的“与”符号</li>\n</ul>\n</li>\n<li><p>剥离查询字符串</p>\n<blockquote>\n<p>只需在要开始剥离的链接后面加个“问号”，并且不要启用QSA标志，就可剥离查询字符串</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\"># Whatever QS is</div><div class=\"line\">RewriteCond %&#123;QUERY_STRING&#125; .</div><div class=\"line\"># I don&apos;t want it with Question mark</div><div class=\"line\">RewriteRule foo.php(.*) /foo.php? [L]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"访问控制\"><a href=\"#访问控制\" class=\"headerlink\" title=\"访问控制\"></a>访问控制</h2><ol>\n<li><p>文件访问控制</p>\n<blockquote>\n<p>利用Order、Files及FilesMatch命令实现的访问控制可以满足大部分要求，但是当用户被拒绝时，他们看到的是硕大的“403 Forbidden”，如果你不想伤害用户的感情，就需要显示一些别的东西，通过Rewrite就可以实现这个特性：</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !^(.+)\\.css$</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !^(.+)\\.js$</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !special.zip$</div><div class=\"line\">RewriteRule ^(.+)$ /chat/ [NC]</div></pre></td></tr></table></figure>\n<ul>\n<li>该规则将仅允许用户请求.css, .js类型的文件，还有special.zip文件</li>\n<li>RewriteRule 后面指定了限制规则：映射到/char/目录下处理</li>\n<li>RewriteCond 后面的“感叹号”(!)起到了“否定”作用，它表明，对不满足后面正则表达式者应用RewriteRule规则，也就是对当前类型的文件将不应用规则</li>\n<li>RewriteCond 之间是以逻辑“与”连接的，也就是只有当三个条件都不满足时才执行RewriteRule</li>\n<li>该规则也会限制访问.htm, .jpg等格式</li>\n<li>该规则不可以放在虚拟站点根目录（/）下，否则会死循环</li>\n<li>如果是二级目录，如/test/，那么传入RewriteCond的参数是以/test/开始的，因此从(.+)获得的文件名也含有/test/，读者必须对此多加小心</li>\n<li>要想仅获得文件名，可以将(.+)替换成([^/]+)，并且去掉符号^，如下所示：<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !([^/]+)\\.css$</div><div class=\"line\">RewriteCond %&#123;REQUEST_FILENAME&#125; !([^/]+)\\.js$</div><div class=\"line\">RewriteRule ^(.+)$ /chat/ [NC]</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n<li><p>用.htaccess阻止User-agent</p>\n<blockquote>\n<p>User-agent用于浏览器向服务器“自报家门”，更确切的说是所有HTTP客户端都得用User-agent向服务器“自报家门”，以便服务器对不同的客户端作出不同响应。比如，某站点可能需要对浏览器、搜索引擎crawl还有各类下载工具作出不同的响应。服务器就是通过所谓的User-agent进行区分的。<br>如果你的服务器提供某些资源的下载，那么你就必须多加小心诸如“迅雷”等下载软件，因为它们可能把你网站资源吸干，并且影响你的正常访客访问。</p>\n</blockquote>\n<p>为此，我们可以利用Rewrite限制某些UA的访问：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; 2.0.50727 [NC]</div><div class=\"line\">RewriteRule . abuse.txt [L]</div></pre></td></tr></table></figure>\n<ul>\n<li>该规则限制“迅雷”客户端下载资源，并将下载文件重置到abuse.txt</li>\n<li>HTTP_USER_AGENT是Apache的内置变量</li>\n<li>2.0.50727是迅雷User-agent的特征字符串</li>\n<li>RewriteRule后面的“点”表示“任意URI”，也就是不管请求的是什么，都输出abuse.txt</li>\n</ul>\n<p>通常，我们不会仅限制一个UA。利用[OR]即可实现对多个UA作出统一处理：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine on</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; 2.0.50727 [NC,OR]</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; ^BlackWidow [NC,OR]</div><div class=\"line\"># etc..</div><div class=\"line\">RewriteCond %&#123;HTTP_USER_AGENT&#125; ^Net\\ Vampire [NC]</div><div class=\"line\">RewriteRule . abuse.txt [L]</div></pre></td></tr></table></figure>\n</li>\n<li><p>用.htaccess阻止盗链(hot-linking)</p>\n<blockquote>\n<p>盗链，特别是图片，是非常可耻的！哪怕将图片复制到自己服务器上，也比盗用他人的图片链接来得光彩！</p>\n</blockquote>\n<p>.htaccess的Rewrite功能可以提供非常简单、有效的方法阻止这种可耻行为：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">RewriteEngine On</div><div class=\"line\">RewriteCond %&#123;HTTP_REFERER&#125; !^$</div><div class=\"line\">RewriteCond %&#123;HTTP_REFERER&#125; !^http://(www\\.)?lesca\\.me/ [NC]</div><div class=\"line\">RewriteCond %&#123;REQUEST_URI&#125; !hotlink\\.png [NC]</div><div class=\"line\">RewriteRule .*\\.(gif|jpg|png)$ /hotlink.png [NC]</div></pre></td></tr></table></figure>\n</li>\n</ol>\n<p>简单解释一下该规则的功能：</p>\n<ul>\n<li>除本站以外其他网站都不得引用本站图片，具体可以理解为</li>\n<li>如果引用站点为“空”或者是“本站”，或者，所引用对象是“hotlink.png”，那么就允许访问</li>\n<li>再次提醒，RewriteCond之间默认的逻辑连接词是逻辑“与”</li>\n<li>这里的难点是理解逻辑转换，即德·摩根定律</li>\n</ul>\n<h2 id=\"htaccess-缺点\"><a href=\"#htaccess-缺点\" class=\"headerlink\" title=\"htaccess 缺点\"></a>htaccess 缺点</h2><p>说了这么多<code>.htaccess</code> 可以实现这么多的功能，那么它有没有什么缺点呢?</p>\n<p>答案是，当然有。由于开启了<code>.htaccess</code> 文件，当我们访问了一个地址对应到服务器端某个目录之后<code>Apache</code> 会遍历并解析每层目录下的<code>.htaccess</code> 文件，所有对服务器性能会有一定的影响。</p>\n<p>但是具体影响有多大，要不要使用还需要看具体的环境。或者需要进行前后对比在进行选择。</p>\n<h2 id=\"htaccess-生成工具\"><a href=\"#htaccess-生成工具\" class=\"headerlink\" title=\"htaccess 生成工具\"></a>htaccess 生成工具</h2><p>说了这么多，貌似真正配置起来还是非常麻烦。不用着急目前网上有非常多<code>htaccess</code> 在线生成工具，可大大方便我们进行完成各种配置。</p>\n<p>如：<a href=\"http://htaccess.uuz.cc/\">smarty .htaccess :http://htaccess.uuz.cc/</a></p>\n<p><a href=\"http://lesca.me/archives/htaccess-rewrite.html\">转自:Lesca技术宅</a></p>"},{"title":"keepalive工作原理和配置(转)","date":"2016-10-05T12:30:00.000Z","utime":"2016-10-05T12:30:00.000Z","modif_times":0,"_content":"\n\n## keepalived是什么\n\nkeepalived是集群管理中保证集群高可用的一个服务软件，其功能类似于[heartbeat](https://github.com/chenzhiwei/linux/tree/master/heartbeat)，用来防止单点故障。\n\n## keepalived工作原理\n\nkeepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即[虚拟路由冗余协议](http://en.wikipedia.org/wiki/VRRP)。\n\n虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据[VRRP的优先级](http://tools.ietf.org/html/rfc5798#section-5.1)来选举一个backup当master。这样的话就可以保证路由器的高可用了。\n\nkeepalived主要有三个模块，分别是core、check和vrrp。\n- core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。\n- check负责健康检查，包括常见的各种检查方式。\n- vrrp模块是来实现VRRP协议的。\n\n<!-- more -->\n\n## keepalived的配置文件\n\nkeepalived只有一个配置文件keepalived.conf，里面主要包括以下几个配置区域，分别是global_defs、static_ipaddress、static_routes、vrrp_script、vrrp_instance和virtual_server。\n\n### global_defs区域\n> 主要是配置故障发生时的通知对象以及机器标识\n\n```\nglobal_defs {\n    notification_email {\n        a@abc.com\n        b@abc.com\n        ...\n    }\n    notification_email_from alert@abc.com\n    smtp_server smtp.abc.com\n    smtp_connect_timeout 30\n    enable_traps\n    router_id host163\n}\n```\n- notification_email 故障发生时给谁发邮件通知。\n- notification_email_from 通知邮件从哪个地址发出。\n- smpt_server 通知邮件的smtp地址。\n- smtp_connect_timeout 连接smtp服务器的超时时间。\n- enable_traps 开启SNMP陷阱（[Simple Network Management Protocol](http://en.wikipedia.org/wiki/Simple_Network_Management_Protocol)）。\n- router_id 标识本节点的字条串，通常为hostname，但不一定非得是hostname。故障发生时，邮件通知会用到。\n\n\n### static_ipaddress和static_routes\n> static_ipaddress和static_routes区域配置的是是本节点的IP和路由信息。如果你的机器上已经配置了IP和路由，那么这两个区域可以不用配置。\n> 其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。\n\n```\nstatic_ipaddress {\n    10.210.214.163/24 brd 10.210.214.255 dev eth0\n    ...\n}\n```\n```\nstatic_routes {\n    10.0.0.0/8 via 10.210.214.1 dev eth0\n    ...\n}\n```\n以上分别表示启动/关闭keepalived时在本机执行的如下命令：\n```\n# /sbin/ip addr add 10.210.214.163/24 brd 10.210.214.255 dev eth0\n# /sbin/ip route add 10.0.0.0/8 via 10.210.214.1 dev eth0\n# /sbin/ip addr del 10.210.214.163/24 brd 10.210.214.255 dev eth0\n# /sbin/ip route del 10.0.0.0/8 via 10.210.214.1 dev eth0\n```\n注意： 请忽略这两个区域，因为我坚信你的机器肯定已经配置了IP和路由。\n\n### vrrp_script\n> 用来做健康检查的，当时检查失败时会将vrrp_instance的priority减少相应的值。\n\n```\nvrrp_script chk_http_port {\n    script \"</dev/tcp/127.0.0.1/80\"\n    interval 1\n    weight -10\n}\n```\n以上意思是如果script中的指令执行失败，那么相应的vrrp_instance的优先级会减少10个点。\n\n### vrrp_instance和vrrp_sync_group区域\n> vrrp_instance用来定义对外提供服务的VIP区域及其相关属性。\n>\n> vrrp_rsync_group用来定义vrrp_intance组，使得这个组内成员动作一致。\n\n举个例子来说明一下其功能：\n\n两个vrrp_instance同属于一个vrrp_rsync_group，那么其中一个vrrp_instance发生故障切换时，另一个vrrp_instance也会跟着切换（即使这个instance没有发生故障）。\n```\nvrrp_sync_group VG_1 {\n    group {\n        inside_network   # name of vrrp_instance (below)\n        outside_network  # One for each moveable IP.\n        ...\n    }\n    notify_master /path/to_master.sh\n    notify_backup /path/to_backup.sh\n    notify_fault \"/path/fault.sh VG_1\"\n    notify /path/notify.sh\n    smtp_alert\n}\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    use_vmac <VMAC_INTERFACE>\n    dont_track_primary\n    track_interface {\n        eth0\n        eth1\n    }\n    mcast_src_ip <IPADDR>\n    lvs_sync_daemon_interface eth1\n    garp_master_delay 10\n    virtual_router_id 1\n    priority 100\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 12345678\n    }\n    virtual_ipaddress {\n        10.210.214.253/24 brd 10.210.214.255 dev eth0\n        192.168.1.11/24 brd 192.168.1.255 dev eth1\n    }\n    virtual_routes {\n        172.16.0.0/12 via 10.210.214.1\n        192.168.1.0/24 via 192.168.1.1 dev eth1\n        default via 202.102.152.1\n    }\n    track_script {\n        chk_http_port\n    }\n    nopreempt\n    preempt_delay 300\n    debug\n    notify_master <STRING>|<QUOTED-STRING>\n    notify_backup <STRING>|<QUOTED-STRING>\n    notify_fault <STRING>|<QUOTED-STRING>\n    notify <STRING>|<QUOTED-STRING>\n    smtp_alert\n}\n```\n- notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。\n- notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = \"GROUP\"|\"INSTANCE\"，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。\n- smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。\n- state 可以是MASTER或BACKUP，不过当其他节点keepalived启动时会将priority比较大的节点选举为MASTER，因此该项其实没有实质用途。\n- interface 节点固有IP（非VIP）的网卡，用来发VRRP包。\n- use_vmac 是否使用VRRP的虚拟MAC地址。\n- dont_track_primary 忽略VRRP网卡错误。（默认未设置）\n- track_interface 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）\n- mcast_src_ip 修改vrrp组播包的源地址，默认源地址为master的IP。（由于是组播，因此即使修改了源地址，该master还是能收到回应的）\n- lvs_sync_daemon_interface 绑定lvs syncd的网卡。\n- garp_master_delay 当切为主状态后多久更新ARP缓存，默认5秒。\n- virtual_router_id 取值在0-255之间，用来区分多个instance的VRRP组播。\n\n注意： 同一网段中virtual_router_id的值不能重复，否则会出错，相关错误信息如下。\n```\nKeepalived_vrrp[27120]: ip address associated with VRID not present in received packet :\none or more VIP associated with VRID mismatch actual MASTER advert\nbogus VRRP packet received on eth1 !!!\nreceive an invalid ip number count associated with VRID!\nVRRP_Instance(xxx) ignoring received advertisment...\n```\n可以用这条命令来查看该网络中所存在的vrid：`tcpdump -nn -i any net 224.0.0.0/8`\n- priority 用来选举master的，要成为master，那么这个选项的值最好[高于其他机器50个点](http://tools.ietf.org/html/rfc5798#section-8.3.2)，该项[取值范围](http://tools.ietf.org/html/rfc5798#section-5.2.4)是1-255（在此范围之外会被识别成默认值100）。\n- advert_int 发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）。\n- authentication 认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）。\n- virtual_ipaddress vip，不解释了。\n- virtual_routes 虚拟路由，当IP漂过来之后需要添加的路由信息。\n- virtual_ipaddress_excluded 发送的VRRP包里不包含的IP地址，为减少回应VRRP包的个数。在网卡上绑定的IP地址比较多的时候用。\n- nopreempt 允许一个priority比较低的节点作为master，即使有priority更高的节点启动。\n\n首先nopreemt必须在state为BACKUP的节点上才生效（因为是BACKUP节点决定是否来成为MASTER的），其次要实现类似于关闭auto failback的功能需要将所有节点的state都设置为BACKUP，或者将master节点的priority设置的比BACKUP低。我个人推荐使用将所有节点的state都设置成BACKUP并且都加上nopreempt选项，这样就完成了关于autofailback功能，当想手动将某节点切换为MASTER时只需去掉该节点的nopreempt选项并且将priority改的比其他节点大，然后重新加载配置文件即可（等MASTER切过来之后再将配置文件改回去再reload一下）。\n\n当使用track_script时可以不用加nopreempt，只需要加上preempt_delay 5，这里的间隔时间要大于vrrp_script中定义的时长。\n- preempt_delay master启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项。\n\n### virtual_server_group和virtual_server区域\n> virtual_server_group一般在超大型的LVS中用到，一般LVS用不过这东西，因此不多说。\n\n```\nvirtual_server IP Port {\n    delay_loop <INT>\n    lb_algo rr|wrr|lc|wlc|lblc|sh|dh\n    lb_kind NAT|DR|TUN\n    persistence_timeout <INT>\n    persistence_granularity <NETMASK>\n    protocol TCP\n    ha_suspend\n    virtualhost <STRING>\n    alpha\n    omega\n    quorum <INT>\n    hysteresis <INT>\n    quorum_up <STRING>|<QUOTED-STRING>\n    quorum_down <STRING>|<QUOTED-STRING>\n    sorry_server <IPADDR> <PORT>\n    real_server <IPADDR> <PORT> {\n        weight <INT>\n        inhibit_on_failure\n        notify_up <STRING>|<QUOTED-STRING>\n        notify_down <STRING>|<QUOTED-STRING>\n        # HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK\n        HTTP_GET|SSL_GET {\n            url {\n                path <STRING>\n                # Digest computed with genhash\n                digest <STRING>\n                status_code <INT>\n            }\n            connect_port <PORT>\n            connect_timeout <INT>\n            nb_get_retry <INT>\n            delay_before_retry <INT>\n        }\n    }\n}\n```\n- delay_loop 延迟轮询时间（单位秒）。\n- lb_algo 后端调试算法（load balancing algorithm）。\n- lb_kind LVS调度类型NAT/DR/TUN。\n- virtualhost 用来给HTTP_GET和SSL_GET配置请求header的。\n- sorry_server 当所有real server宕掉时，sorry server顶替。\n- real_server 真正提供服务的服务器。\n- weight 权重。\n- notify_up/down 当real server宕掉或启动时执行的脚本。\n\n健康检查的方式，N多种方式。\n- path 请求real serserver上的路径。\n- digest/status_code 分别表示用genhash算出的结果和http状态码。\n- connect_port 健康检查，如果端口通则认为服务器正常。\n- connect_timeout,nb_get_retry,delay_before_retry分别表示超时时长、重试次数，下次重试的时间延迟。\n\n其他选项暂时不作说明。\n\n## keepalived主从切换\n\n主从切换比较让人蛋疼，需要将backup配置文件的priority选项的值调整的比master高50个点，然后reload配置文件就可以切换了。当时你也可以将master的keepalived停止，这样也可以进行主从切换。\n\n## keepalived仅做HA时的配置\n\n请看该文档同级目录下的配置文件示例。\n\n说明：\n- 10.210.214.113 为keepalived的备机，其配置文件为113.keepalived.conf\n- 10.210.214.163 为keepalived的主机，其配置文件为163.keepalived.conf\n- 10.210.214.253 为Virtual IP，即提供服务的内网IP地址，在网卡eth0上面\n- 192.168.1.11 为模拟的提供服务的公网IP地址，在网卡eth1上面\n\n用tcpdump命令来捕获的结果如下：\n```\n17:20:07.919419 IP 10.210.214.163 > 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 200, authtype simple, intvl 1s, length 20\n```\n## LVS+Keepalived配置\n> 注:Keepalived与LVS结合使用时一般还会用到一个工具ipvsadm，用来查看相关VS相关状态，关于ipvsadm的用法可以参考man手册。\n\n10.67.15.95为keepalived master，VIP为10.67.15.94，配置文件为95-lvs-keepalived.conf\n\n10.67.15.96为keepalived master，VIP为10.67.15.94，配置文件为96-lvs-keepalived.conf\n\n10.67.15.195为real server  \n\n**注意：**\n\n当使用LVS+DR+Keepalived配置时，需要在real server上添加一条iptables规则（其中dport根据情况添加或缺省）：\n```\n# iptables -t nat -A PREROUTING -p tcp -d 10.67.15.94 --dport 80 -j REDIRECT\n```\n当使用LVS+NAT+Keepalived配置时，需要将real server的默认路由配置成Director的VIP10.67.15.94，必须确保client的请求是通过10.67.15.94到达real server的。\n\n## 安装keepalived\n\n从keepalived[官网](http://www.keepalived.org/download.html)下载合适的版本，解压并执行如下命令完成安装。\n```\n# cd keepalived-xxx\n# ./configure --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --mandir=/usr/share\n# make && make install\n```\n你也可以打成[RPM](https://github.com/chenzhiwei/linux/tree/master/rpm-package-management)包，然后安装。\n\n## 说明\n\n我们用到的HA场景如下： 两台主机host113和host163，内网IP在eth1网卡上，分别是10.210.214.113和10.210.214.163，VIP为公网IP在eth0上，IP地址是202.102.152.253，网关为202.102.152.1。当VIP在host113上提供服务时，host113上的默认路由为202.102.152.1，提供服务的端口为202.102.152.253:443。host113发生故障需要将VIP及服务切回到host163上的时候，需要以下几步，第一将VIP接管过来，第二添加默认路由202.102.152.1，第三启动在端口202.102.152.253:443上的服务。\n\n如此一来，keepalived需要另外的脚本来完成添加默认路由和启动服务工作，这点和heartbeat中的resources是相同的。目前我进行了测试，发现keepalived速度要比heartbeat快，也就是说效率比heartbeat高。并且，最重要的一点，keepalived支持多个backup。\n\n不要问我为何有以上需求。要为两个不同的域名提供https服务，由于SSL证书问题，必须有两个公网IP地址分别绑定443端口。\n\n当然，通过[SNI](http://en.wikipedia.org/wiki/Server_Name_Indication)也可以实现一个公网IP绑定443端口来为多个域名提供https服务，但是这需要浏览器支持（M$的IE浏览器不支持）。（[nginx](http://nginx.org/en/docs/http/configuring_https_servers.html#sni)/[apache](http://wiki.apache.org/httpd/NameBasedSSLVHostsWithSNI)）\n\n## 吐槽\n\nkeepalived的主从切换比较让人蛋疼，需要修改配置文件或停止一方的运行。但是由于keepalived是通过vrrp协议来实现failover（故障转移）的，因此也决定了手动主从切换的不便。\n\nkeepalived的文档也很旧了，一直都找不到合适的文档，之前我就一直忽略了vrrp_script这个区域，导致很多事情想不通。\n\n另外，我发现我越来越喜欢keepalived了。。。\n\n\n\n\n\n[转自：http://outofmemory.cn/wiki/keepalived-configuration](http://outofmemory.cn/wiki/keepalived-configuration)\n","source":"_posts/keepalived工作原理和配置.md","raw":"---\ntitle: keepalive工作原理和配置(转)\ndate: 2016-10-05 20:30:00\nutime: 2016-10-05 20:30:00\nmodif_times: 0\ntags:\n- 负载均衡\ncategories:\n- Linux\n---\n\n\n## keepalived是什么\n\nkeepalived是集群管理中保证集群高可用的一个服务软件，其功能类似于[heartbeat](https://github.com/chenzhiwei/linux/tree/master/heartbeat)，用来防止单点故障。\n\n## keepalived工作原理\n\nkeepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即[虚拟路由冗余协议](http://en.wikipedia.org/wiki/VRRP)。\n\n虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据[VRRP的优先级](http://tools.ietf.org/html/rfc5798#section-5.1)来选举一个backup当master。这样的话就可以保证路由器的高可用了。\n\nkeepalived主要有三个模块，分别是core、check和vrrp。\n- core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。\n- check负责健康检查，包括常见的各种检查方式。\n- vrrp模块是来实现VRRP协议的。\n\n<!-- more -->\n\n## keepalived的配置文件\n\nkeepalived只有一个配置文件keepalived.conf，里面主要包括以下几个配置区域，分别是global_defs、static_ipaddress、static_routes、vrrp_script、vrrp_instance和virtual_server。\n\n### global_defs区域\n> 主要是配置故障发生时的通知对象以及机器标识\n\n```\nglobal_defs {\n    notification_email {\n        a@abc.com\n        b@abc.com\n        ...\n    }\n    notification_email_from alert@abc.com\n    smtp_server smtp.abc.com\n    smtp_connect_timeout 30\n    enable_traps\n    router_id host163\n}\n```\n- notification_email 故障发生时给谁发邮件通知。\n- notification_email_from 通知邮件从哪个地址发出。\n- smpt_server 通知邮件的smtp地址。\n- smtp_connect_timeout 连接smtp服务器的超时时间。\n- enable_traps 开启SNMP陷阱（[Simple Network Management Protocol](http://en.wikipedia.org/wiki/Simple_Network_Management_Protocol)）。\n- router_id 标识本节点的字条串，通常为hostname，但不一定非得是hostname。故障发生时，邮件通知会用到。\n\n\n### static_ipaddress和static_routes\n> static_ipaddress和static_routes区域配置的是是本节点的IP和路由信息。如果你的机器上已经配置了IP和路由，那么这两个区域可以不用配置。\n> 其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。\n\n```\nstatic_ipaddress {\n    10.210.214.163/24 brd 10.210.214.255 dev eth0\n    ...\n}\n```\n```\nstatic_routes {\n    10.0.0.0/8 via 10.210.214.1 dev eth0\n    ...\n}\n```\n以上分别表示启动/关闭keepalived时在本机执行的如下命令：\n```\n# /sbin/ip addr add 10.210.214.163/24 brd 10.210.214.255 dev eth0\n# /sbin/ip route add 10.0.0.0/8 via 10.210.214.1 dev eth0\n# /sbin/ip addr del 10.210.214.163/24 brd 10.210.214.255 dev eth0\n# /sbin/ip route del 10.0.0.0/8 via 10.210.214.1 dev eth0\n```\n注意： 请忽略这两个区域，因为我坚信你的机器肯定已经配置了IP和路由。\n\n### vrrp_script\n> 用来做健康检查的，当时检查失败时会将vrrp_instance的priority减少相应的值。\n\n```\nvrrp_script chk_http_port {\n    script \"</dev/tcp/127.0.0.1/80\"\n    interval 1\n    weight -10\n}\n```\n以上意思是如果script中的指令执行失败，那么相应的vrrp_instance的优先级会减少10个点。\n\n### vrrp_instance和vrrp_sync_group区域\n> vrrp_instance用来定义对外提供服务的VIP区域及其相关属性。\n>\n> vrrp_rsync_group用来定义vrrp_intance组，使得这个组内成员动作一致。\n\n举个例子来说明一下其功能：\n\n两个vrrp_instance同属于一个vrrp_rsync_group，那么其中一个vrrp_instance发生故障切换时，另一个vrrp_instance也会跟着切换（即使这个instance没有发生故障）。\n```\nvrrp_sync_group VG_1 {\n    group {\n        inside_network   # name of vrrp_instance (below)\n        outside_network  # One for each moveable IP.\n        ...\n    }\n    notify_master /path/to_master.sh\n    notify_backup /path/to_backup.sh\n    notify_fault \"/path/fault.sh VG_1\"\n    notify /path/notify.sh\n    smtp_alert\n}\nvrrp_instance VI_1 {\n    state MASTER\n    interface eth0\n    use_vmac <VMAC_INTERFACE>\n    dont_track_primary\n    track_interface {\n        eth0\n        eth1\n    }\n    mcast_src_ip <IPADDR>\n    lvs_sync_daemon_interface eth1\n    garp_master_delay 10\n    virtual_router_id 1\n    priority 100\n    advert_int 1\n    authentication {\n        auth_type PASS\n        auth_pass 12345678\n    }\n    virtual_ipaddress {\n        10.210.214.253/24 brd 10.210.214.255 dev eth0\n        192.168.1.11/24 brd 192.168.1.255 dev eth1\n    }\n    virtual_routes {\n        172.16.0.0/12 via 10.210.214.1\n        192.168.1.0/24 via 192.168.1.1 dev eth1\n        default via 202.102.152.1\n    }\n    track_script {\n        chk_http_port\n    }\n    nopreempt\n    preempt_delay 300\n    debug\n    notify_master <STRING>|<QUOTED-STRING>\n    notify_backup <STRING>|<QUOTED-STRING>\n    notify_fault <STRING>|<QUOTED-STRING>\n    notify <STRING>|<QUOTED-STRING>\n    smtp_alert\n}\n```\n- notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。\n- notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = \"GROUP\"|\"INSTANCE\"，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。\n- smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。\n- state 可以是MASTER或BACKUP，不过当其他节点keepalived启动时会将priority比较大的节点选举为MASTER，因此该项其实没有实质用途。\n- interface 节点固有IP（非VIP）的网卡，用来发VRRP包。\n- use_vmac 是否使用VRRP的虚拟MAC地址。\n- dont_track_primary 忽略VRRP网卡错误。（默认未设置）\n- track_interface 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）\n- mcast_src_ip 修改vrrp组播包的源地址，默认源地址为master的IP。（由于是组播，因此即使修改了源地址，该master还是能收到回应的）\n- lvs_sync_daemon_interface 绑定lvs syncd的网卡。\n- garp_master_delay 当切为主状态后多久更新ARP缓存，默认5秒。\n- virtual_router_id 取值在0-255之间，用来区分多个instance的VRRP组播。\n\n注意： 同一网段中virtual_router_id的值不能重复，否则会出错，相关错误信息如下。\n```\nKeepalived_vrrp[27120]: ip address associated with VRID not present in received packet :\none or more VIP associated with VRID mismatch actual MASTER advert\nbogus VRRP packet received on eth1 !!!\nreceive an invalid ip number count associated with VRID!\nVRRP_Instance(xxx) ignoring received advertisment...\n```\n可以用这条命令来查看该网络中所存在的vrid：`tcpdump -nn -i any net 224.0.0.0/8`\n- priority 用来选举master的，要成为master，那么这个选项的值最好[高于其他机器50个点](http://tools.ietf.org/html/rfc5798#section-8.3.2)，该项[取值范围](http://tools.ietf.org/html/rfc5798#section-5.2.4)是1-255（在此范围之外会被识别成默认值100）。\n- advert_int 发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）。\n- authentication 认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）。\n- virtual_ipaddress vip，不解释了。\n- virtual_routes 虚拟路由，当IP漂过来之后需要添加的路由信息。\n- virtual_ipaddress_excluded 发送的VRRP包里不包含的IP地址，为减少回应VRRP包的个数。在网卡上绑定的IP地址比较多的时候用。\n- nopreempt 允许一个priority比较低的节点作为master，即使有priority更高的节点启动。\n\n首先nopreemt必须在state为BACKUP的节点上才生效（因为是BACKUP节点决定是否来成为MASTER的），其次要实现类似于关闭auto failback的功能需要将所有节点的state都设置为BACKUP，或者将master节点的priority设置的比BACKUP低。我个人推荐使用将所有节点的state都设置成BACKUP并且都加上nopreempt选项，这样就完成了关于autofailback功能，当想手动将某节点切换为MASTER时只需去掉该节点的nopreempt选项并且将priority改的比其他节点大，然后重新加载配置文件即可（等MASTER切过来之后再将配置文件改回去再reload一下）。\n\n当使用track_script时可以不用加nopreempt，只需要加上preempt_delay 5，这里的间隔时间要大于vrrp_script中定义的时长。\n- preempt_delay master启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项。\n\n### virtual_server_group和virtual_server区域\n> virtual_server_group一般在超大型的LVS中用到，一般LVS用不过这东西，因此不多说。\n\n```\nvirtual_server IP Port {\n    delay_loop <INT>\n    lb_algo rr|wrr|lc|wlc|lblc|sh|dh\n    lb_kind NAT|DR|TUN\n    persistence_timeout <INT>\n    persistence_granularity <NETMASK>\n    protocol TCP\n    ha_suspend\n    virtualhost <STRING>\n    alpha\n    omega\n    quorum <INT>\n    hysteresis <INT>\n    quorum_up <STRING>|<QUOTED-STRING>\n    quorum_down <STRING>|<QUOTED-STRING>\n    sorry_server <IPADDR> <PORT>\n    real_server <IPADDR> <PORT> {\n        weight <INT>\n        inhibit_on_failure\n        notify_up <STRING>|<QUOTED-STRING>\n        notify_down <STRING>|<QUOTED-STRING>\n        # HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK\n        HTTP_GET|SSL_GET {\n            url {\n                path <STRING>\n                # Digest computed with genhash\n                digest <STRING>\n                status_code <INT>\n            }\n            connect_port <PORT>\n            connect_timeout <INT>\n            nb_get_retry <INT>\n            delay_before_retry <INT>\n        }\n    }\n}\n```\n- delay_loop 延迟轮询时间（单位秒）。\n- lb_algo 后端调试算法（load balancing algorithm）。\n- lb_kind LVS调度类型NAT/DR/TUN。\n- virtualhost 用来给HTTP_GET和SSL_GET配置请求header的。\n- sorry_server 当所有real server宕掉时，sorry server顶替。\n- real_server 真正提供服务的服务器。\n- weight 权重。\n- notify_up/down 当real server宕掉或启动时执行的脚本。\n\n健康检查的方式，N多种方式。\n- path 请求real serserver上的路径。\n- digest/status_code 分别表示用genhash算出的结果和http状态码。\n- connect_port 健康检查，如果端口通则认为服务器正常。\n- connect_timeout,nb_get_retry,delay_before_retry分别表示超时时长、重试次数，下次重试的时间延迟。\n\n其他选项暂时不作说明。\n\n## keepalived主从切换\n\n主从切换比较让人蛋疼，需要将backup配置文件的priority选项的值调整的比master高50个点，然后reload配置文件就可以切换了。当时你也可以将master的keepalived停止，这样也可以进行主从切换。\n\n## keepalived仅做HA时的配置\n\n请看该文档同级目录下的配置文件示例。\n\n说明：\n- 10.210.214.113 为keepalived的备机，其配置文件为113.keepalived.conf\n- 10.210.214.163 为keepalived的主机，其配置文件为163.keepalived.conf\n- 10.210.214.253 为Virtual IP，即提供服务的内网IP地址，在网卡eth0上面\n- 192.168.1.11 为模拟的提供服务的公网IP地址，在网卡eth1上面\n\n用tcpdump命令来捕获的结果如下：\n```\n17:20:07.919419 IP 10.210.214.163 > 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 200, authtype simple, intvl 1s, length 20\n```\n## LVS+Keepalived配置\n> 注:Keepalived与LVS结合使用时一般还会用到一个工具ipvsadm，用来查看相关VS相关状态，关于ipvsadm的用法可以参考man手册。\n\n10.67.15.95为keepalived master，VIP为10.67.15.94，配置文件为95-lvs-keepalived.conf\n\n10.67.15.96为keepalived master，VIP为10.67.15.94，配置文件为96-lvs-keepalived.conf\n\n10.67.15.195为real server  \n\n**注意：**\n\n当使用LVS+DR+Keepalived配置时，需要在real server上添加一条iptables规则（其中dport根据情况添加或缺省）：\n```\n# iptables -t nat -A PREROUTING -p tcp -d 10.67.15.94 --dport 80 -j REDIRECT\n```\n当使用LVS+NAT+Keepalived配置时，需要将real server的默认路由配置成Director的VIP10.67.15.94，必须确保client的请求是通过10.67.15.94到达real server的。\n\n## 安装keepalived\n\n从keepalived[官网](http://www.keepalived.org/download.html)下载合适的版本，解压并执行如下命令完成安装。\n```\n# cd keepalived-xxx\n# ./configure --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --mandir=/usr/share\n# make && make install\n```\n你也可以打成[RPM](https://github.com/chenzhiwei/linux/tree/master/rpm-package-management)包，然后安装。\n\n## 说明\n\n我们用到的HA场景如下： 两台主机host113和host163，内网IP在eth1网卡上，分别是10.210.214.113和10.210.214.163，VIP为公网IP在eth0上，IP地址是202.102.152.253，网关为202.102.152.1。当VIP在host113上提供服务时，host113上的默认路由为202.102.152.1，提供服务的端口为202.102.152.253:443。host113发生故障需要将VIP及服务切回到host163上的时候，需要以下几步，第一将VIP接管过来，第二添加默认路由202.102.152.1，第三启动在端口202.102.152.253:443上的服务。\n\n如此一来，keepalived需要另外的脚本来完成添加默认路由和启动服务工作，这点和heartbeat中的resources是相同的。目前我进行了测试，发现keepalived速度要比heartbeat快，也就是说效率比heartbeat高。并且，最重要的一点，keepalived支持多个backup。\n\n不要问我为何有以上需求。要为两个不同的域名提供https服务，由于SSL证书问题，必须有两个公网IP地址分别绑定443端口。\n\n当然，通过[SNI](http://en.wikipedia.org/wiki/Server_Name_Indication)也可以实现一个公网IP绑定443端口来为多个域名提供https服务，但是这需要浏览器支持（M$的IE浏览器不支持）。（[nginx](http://nginx.org/en/docs/http/configuring_https_servers.html#sni)/[apache](http://wiki.apache.org/httpd/NameBasedSSLVHostsWithSNI)）\n\n## 吐槽\n\nkeepalived的主从切换比较让人蛋疼，需要修改配置文件或停止一方的运行。但是由于keepalived是通过vrrp协议来实现failover（故障转移）的，因此也决定了手动主从切换的不便。\n\nkeepalived的文档也很旧了，一直都找不到合适的文档，之前我就一直忽略了vrrp_script这个区域，导致很多事情想不通。\n\n另外，我发现我越来越喜欢keepalived了。。。\n\n\n\n\n\n[转自：http://outofmemory.cn/wiki/keepalived-configuration](http://outofmemory.cn/wiki/keepalived-configuration)\n","slug":"keepalived工作原理和配置","published":1,"updated":"2016-10-05T06:47:20.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxj0045699f3rdw9s9c","content":"<h2 id=\"keepalived是什么\"><a href=\"#keepalived是什么\" class=\"headerlink\" title=\"keepalived是什么\"></a>keepalived是什么</h2><p>keepalived是集群管理中保证集群高可用的一个服务软件，其功能类似于<a href=\"https://github.com/chenzhiwei/linux/tree/master/heartbeat\" target=\"_blank\" rel=\"external\">heartbeat</a>，用来防止单点故障。</p>\n<h2 id=\"keepalived工作原理\"><a href=\"#keepalived工作原理\" class=\"headerlink\" title=\"keepalived工作原理\"></a>keepalived工作原理</h2><p>keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即<a href=\"http://en.wikipedia.org/wiki/VRRP\" target=\"_blank\" rel=\"external\">虚拟路由冗余协议</a>。</p>\n<p>虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据<a href=\"http://tools.ietf.org/html/rfc5798#section-5.1\" target=\"_blank\" rel=\"external\">VRRP的优先级</a>来选举一个backup当master。这样的话就可以保证路由器的高可用了。</p>\n<p>keepalived主要有三个模块，分别是core、check和vrrp。</p>\n<ul>\n<li>core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。</li>\n<li>check负责健康检查，包括常见的各种检查方式。</li>\n<li>vrrp模块是来实现VRRP协议的。</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"keepalived的配置文件\"><a href=\"#keepalived的配置文件\" class=\"headerlink\" title=\"keepalived的配置文件\"></a>keepalived的配置文件</h2><p>keepalived只有一个配置文件keepalived.conf，里面主要包括以下几个配置区域，分别是global_defs、static_ipaddress、static_routes、vrrp_script、vrrp_instance和virtual_server。</p>\n<h3 id=\"global-defs区域\"><a href=\"#global-defs区域\" class=\"headerlink\" title=\"global_defs区域\"></a>global_defs区域</h3><blockquote>\n<p>主要是配置故障发生时的通知对象以及机器标识</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">global_defs &#123;</div><div class=\"line\">    notification_email &#123;</div><div class=\"line\">        a@abc.com</div><div class=\"line\">        b@abc.com</div><div class=\"line\">        ...</div><div class=\"line\">    &#125;</div><div class=\"line\">    notification_email_from alert@abc.com</div><div class=\"line\">    smtp_server smtp.abc.com</div><div class=\"line\">    smtp_connect_timeout 30</div><div class=\"line\">    enable_traps</div><div class=\"line\">    router_id host163</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>notification_email 故障发生时给谁发邮件通知。</li>\n<li>notification_email_from 通知邮件从哪个地址发出。</li>\n<li>smpt_server 通知邮件的smtp地址。</li>\n<li>smtp_connect_timeout 连接smtp服务器的超时时间。</li>\n<li>enable_traps 开启SNMP陷阱（<a href=\"http://en.wikipedia.org/wiki/Simple_Network_Management_Protocol\" target=\"_blank\" rel=\"external\">Simple Network Management Protocol</a>）。</li>\n<li>router_id 标识本节点的字条串，通常为hostname，但不一定非得是hostname。故障发生时，邮件通知会用到。</li>\n</ul>\n<h3 id=\"static-ipaddress和static-routes\"><a href=\"#static-ipaddress和static-routes\" class=\"headerlink\" title=\"static_ipaddress和static_routes\"></a>static_ipaddress和static_routes</h3><blockquote>\n<p>static_ipaddress和static_routes区域配置的是是本节点的IP和路由信息。如果你的机器上已经配置了IP和路由，那么这两个区域可以不用配置。<br>其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">static_ipaddress &#123;</div><div class=\"line\">    10.210.214.163/24 brd 10.210.214.255 dev eth0</div><div class=\"line\">    ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">static_routes &#123;</div><div class=\"line\">    10.0.0.0/8 via 10.210.214.1 dev eth0</div><div class=\"line\">    ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>以上分别表示启动/关闭keepalived时在本机执行的如下命令：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /sbin/ip addr add 10.210.214.163/24 brd 10.210.214.255 dev eth0</div><div class=\"line\"># /sbin/ip route add 10.0.0.0/8 via 10.210.214.1 dev eth0</div><div class=\"line\"># /sbin/ip addr del 10.210.214.163/24 brd 10.210.214.255 dev eth0</div><div class=\"line\"># /sbin/ip route del 10.0.0.0/8 via 10.210.214.1 dev eth0</div></pre></td></tr></table></figure></p>\n<p>注意： 请忽略这两个区域，因为我坚信你的机器肯定已经配置了IP和路由。</p>\n<h3 id=\"vrrp-script\"><a href=\"#vrrp-script\" class=\"headerlink\" title=\"vrrp_script\"></a>vrrp_script</h3><blockquote>\n<p>用来做健康检查的，当时检查失败时会将vrrp_instance的priority减少相应的值。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">vrrp_script chk_http_port &#123;</div><div class=\"line\">    script &quot;&lt;/dev/tcp/127.0.0.1/80&quot;</div><div class=\"line\">    interval 1</div><div class=\"line\">    weight -10</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>以上意思是如果script中的指令执行失败，那么相应的vrrp_instance的优先级会减少10个点。</p>\n<h3 id=\"vrrp-instance和vrrp-sync-group区域\"><a href=\"#vrrp-instance和vrrp-sync-group区域\" class=\"headerlink\" title=\"vrrp_instance和vrrp_sync_group区域\"></a>vrrp_instance和vrrp_sync_group区域</h3><blockquote>\n<p>vrrp_instance用来定义对外提供服务的VIP区域及其相关属性。</p>\n<p>vrrp_rsync_group用来定义vrrp_intance组，使得这个组内成员动作一致。</p>\n</blockquote>\n<p>举个例子来说明一下其功能：</p>\n<p>两个vrrp_instance同属于一个vrrp_rsync_group，那么其中一个vrrp_instance发生故障切换时，另一个vrrp_instance也会跟着切换（即使这个instance没有发生故障）。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div></pre></td><td class=\"code\"><pre><div class=\"line\">vrrp_sync_group VG_1 &#123;</div><div class=\"line\">    group &#123;</div><div class=\"line\">        inside_network   # name of vrrp_instance (below)</div><div class=\"line\">        outside_network  # One for each moveable IP.</div><div class=\"line\">        ...</div><div class=\"line\">    &#125;</div><div class=\"line\">    notify_master /path/to_master.sh</div><div class=\"line\">    notify_backup /path/to_backup.sh</div><div class=\"line\">    notify_fault &quot;/path/fault.sh VG_1&quot;</div><div class=\"line\">    notify /path/notify.sh</div><div class=\"line\">    smtp_alert</div><div class=\"line\">&#125;</div><div class=\"line\">vrrp_instance VI_1 &#123;</div><div class=\"line\">    state MASTER</div><div class=\"line\">    interface eth0</div><div class=\"line\">    use_vmac &lt;VMAC_INTERFACE&gt;</div><div class=\"line\">    dont_track_primary</div><div class=\"line\">    track_interface &#123;</div><div class=\"line\">        eth0</div><div class=\"line\">        eth1</div><div class=\"line\">    &#125;</div><div class=\"line\">    mcast_src_ip &lt;IPADDR&gt;</div><div class=\"line\">    lvs_sync_daemon_interface eth1</div><div class=\"line\">    garp_master_delay 10</div><div class=\"line\">    virtual_router_id 1</div><div class=\"line\">    priority 100</div><div class=\"line\">    advert_int 1</div><div class=\"line\">    authentication &#123;</div><div class=\"line\">        auth_type PASS</div><div class=\"line\">        auth_pass 12345678</div><div class=\"line\">    &#125;</div><div class=\"line\">    virtual_ipaddress &#123;</div><div class=\"line\">        10.210.214.253/24 brd 10.210.214.255 dev eth0</div><div class=\"line\">        192.168.1.11/24 brd 192.168.1.255 dev eth1</div><div class=\"line\">    &#125;</div><div class=\"line\">    virtual_routes &#123;</div><div class=\"line\">        172.16.0.0/12 via 10.210.214.1</div><div class=\"line\">        192.168.1.0/24 via 192.168.1.1 dev eth1</div><div class=\"line\">        default via 202.102.152.1</div><div class=\"line\">    &#125;</div><div class=\"line\">    track_script &#123;</div><div class=\"line\">        chk_http_port</div><div class=\"line\">    &#125;</div><div class=\"line\">    nopreempt</div><div class=\"line\">    preempt_delay 300</div><div class=\"line\">    debug</div><div class=\"line\">    notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    smtp_alert</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。</li>\n<li>notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = “GROUP”|”INSTANCE”，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。</li>\n<li>smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。</li>\n<li>state 可以是MASTER或BACKUP，不过当其他节点keepalived启动时会将priority比较大的节点选举为MASTER，因此该项其实没有实质用途。</li>\n<li>interface 节点固有IP（非VIP）的网卡，用来发VRRP包。</li>\n<li>use_vmac 是否使用VRRP的虚拟MAC地址。</li>\n<li>dont_track_primary 忽略VRRP网卡错误。（默认未设置）</li>\n<li>track_interface 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）</li>\n<li>mcast_src_ip 修改vrrp组播包的源地址，默认源地址为master的IP。（由于是组播，因此即使修改了源地址，该master还是能收到回应的）</li>\n<li>lvs_sync_daemon_interface 绑定lvs syncd的网卡。</li>\n<li>garp_master_delay 当切为主状态后多久更新ARP缓存，默认5秒。</li>\n<li>virtual_router_id 取值在0-255之间，用来区分多个instance的VRRP组播。</li>\n</ul>\n<p>注意： 同一网段中virtual_router_id的值不能重复，否则会出错，相关错误信息如下。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">Keepalived_vrrp[27120]: ip address associated with VRID not present in received packet :</div><div class=\"line\">one or more VIP associated with VRID mismatch actual MASTER advert</div><div class=\"line\">bogus VRRP packet received on eth1 !!!</div><div class=\"line\">receive an invalid ip number count associated with VRID!</div><div class=\"line\">VRRP_Instance(xxx) ignoring received advertisment...</div></pre></td></tr></table></figure></p>\n<p>可以用这条命令来查看该网络中所存在的vrid：<code>tcpdump -nn -i any net 224.0.0.0/8</code></p>\n<ul>\n<li>priority 用来选举master的，要成为master，那么这个选项的值最好<a href=\"http://tools.ietf.org/html/rfc5798#section-8.3.2\" target=\"_blank\" rel=\"external\">高于其他机器50个点</a>，该项<a href=\"http://tools.ietf.org/html/rfc5798#section-5.2.4\" target=\"_blank\" rel=\"external\">取值范围</a>是1-255（在此范围之外会被识别成默认值100）。</li>\n<li>advert_int 发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）。</li>\n<li>authentication 认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）。</li>\n<li>virtual_ipaddress vip，不解释了。</li>\n<li>virtual_routes 虚拟路由，当IP漂过来之后需要添加的路由信息。</li>\n<li>virtual_ipaddress_excluded 发送的VRRP包里不包含的IP地址，为减少回应VRRP包的个数。在网卡上绑定的IP地址比较多的时候用。</li>\n<li>nopreempt 允许一个priority比较低的节点作为master，即使有priority更高的节点启动。</li>\n</ul>\n<p>首先nopreemt必须在state为BACKUP的节点上才生效（因为是BACKUP节点决定是否来成为MASTER的），其次要实现类似于关闭auto failback的功能需要将所有节点的state都设置为BACKUP，或者将master节点的priority设置的比BACKUP低。我个人推荐使用将所有节点的state都设置成BACKUP并且都加上nopreempt选项，这样就完成了关于autofailback功能，当想手动将某节点切换为MASTER时只需去掉该节点的nopreempt选项并且将priority改的比其他节点大，然后重新加载配置文件即可（等MASTER切过来之后再将配置文件改回去再reload一下）。</p>\n<p>当使用track_script时可以不用加nopreempt，只需要加上preempt_delay 5，这里的间隔时间要大于vrrp_script中定义的时长。</p>\n<ul>\n<li>preempt_delay master启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项。</li>\n</ul>\n<h3 id=\"virtual-server-group和virtual-server区域\"><a href=\"#virtual-server-group和virtual-server区域\" class=\"headerlink\" title=\"virtual_server_group和virtual_server区域\"></a>virtual_server_group和virtual_server区域</h3><blockquote>\n<p>virtual_server_group一般在超大型的LVS中用到，一般LVS用不过这东西，因此不多说。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\">virtual_server IP Port &#123;</div><div class=\"line\">    delay_loop &lt;INT&gt;</div><div class=\"line\">    lb_algo rr|wrr|lc|wlc|lblc|sh|dh</div><div class=\"line\">    lb_kind NAT|DR|TUN</div><div class=\"line\">    persistence_timeout &lt;INT&gt;</div><div class=\"line\">    persistence_granularity &lt;NETMASK&gt;</div><div class=\"line\">    protocol TCP</div><div class=\"line\">    ha_suspend</div><div class=\"line\">    virtualhost &lt;STRING&gt;</div><div class=\"line\">    alpha</div><div class=\"line\">    omega</div><div class=\"line\">    quorum &lt;INT&gt;</div><div class=\"line\">    hysteresis &lt;INT&gt;</div><div class=\"line\">    quorum_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    quorum_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    sorry_server &lt;IPADDR&gt; &lt;PORT&gt;</div><div class=\"line\">    real_server &lt;IPADDR&gt; &lt;PORT&gt; &#123;</div><div class=\"line\">        weight &lt;INT&gt;</div><div class=\"line\">        inhibit_on_failure</div><div class=\"line\">        notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">        notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">        # HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK</div><div class=\"line\">        HTTP_GET|SSL_GET &#123;</div><div class=\"line\">            url &#123;</div><div class=\"line\">                path &lt;STRING&gt;</div><div class=\"line\">                # Digest computed with genhash</div><div class=\"line\">                digest &lt;STRING&gt;</div><div class=\"line\">                status_code &lt;INT&gt;</div><div class=\"line\">            &#125;</div><div class=\"line\">            connect_port &lt;PORT&gt;</div><div class=\"line\">            connect_timeout &lt;INT&gt;</div><div class=\"line\">            nb_get_retry &lt;INT&gt;</div><div class=\"line\">            delay_before_retry &lt;INT&gt;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>delay_loop 延迟轮询时间（单位秒）。</li>\n<li>lb_algo 后端调试算法（load balancing algorithm）。</li>\n<li>lb_kind LVS调度类型NAT/DR/TUN。</li>\n<li>virtualhost 用来给HTTP_GET和SSL_GET配置请求header的。</li>\n<li>sorry_server 当所有real server宕掉时，sorry server顶替。</li>\n<li>real_server 真正提供服务的服务器。</li>\n<li>weight 权重。</li>\n<li>notify_up/down 当real server宕掉或启动时执行的脚本。</li>\n</ul>\n<p>健康检查的方式，N多种方式。</p>\n<ul>\n<li>path 请求real serserver上的路径。</li>\n<li>digest/status_code 分别表示用genhash算出的结果和http状态码。</li>\n<li>connect_port 健康检查，如果端口通则认为服务器正常。</li>\n<li>connect_timeout,nb_get_retry,delay_before_retry分别表示超时时长、重试次数，下次重试的时间延迟。</li>\n</ul>\n<p>其他选项暂时不作说明。</p>\n<h2 id=\"keepalived主从切换\"><a href=\"#keepalived主从切换\" class=\"headerlink\" title=\"keepalived主从切换\"></a>keepalived主从切换</h2><p>主从切换比较让人蛋疼，需要将backup配置文件的priority选项的值调整的比master高50个点，然后reload配置文件就可以切换了。当时你也可以将master的keepalived停止，这样也可以进行主从切换。</p>\n<h2 id=\"keepalived仅做HA时的配置\"><a href=\"#keepalived仅做HA时的配置\" class=\"headerlink\" title=\"keepalived仅做HA时的配置\"></a>keepalived仅做HA时的配置</h2><p>请看该文档同级目录下的配置文件示例。</p>\n<p>说明：</p>\n<ul>\n<li>10.210.214.113 为keepalived的备机，其配置文件为113.keepalived.conf</li>\n<li>10.210.214.163 为keepalived的主机，其配置文件为163.keepalived.conf</li>\n<li>10.210.214.253 为Virtual IP，即提供服务的内网IP地址，在网卡eth0上面</li>\n<li>192.168.1.11 为模拟的提供服务的公网IP地址，在网卡eth1上面</li>\n</ul>\n<p>用tcpdump命令来捕获的结果如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">17:20:07.919419 IP 10.210.214.163 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 200, authtype simple, intvl 1s, length 20</div></pre></td></tr></table></figure></p>\n<h2 id=\"LVS-Keepalived配置\"><a href=\"#LVS-Keepalived配置\" class=\"headerlink\" title=\"LVS+Keepalived配置\"></a>LVS+Keepalived配置</h2><blockquote>\n<p>注:Keepalived与LVS结合使用时一般还会用到一个工具ipvsadm，用来查看相关VS相关状态，关于ipvsadm的用法可以参考man手册。</p>\n</blockquote>\n<p>10.67.15.95为keepalived master，VIP为10.67.15.94，配置文件为95-lvs-keepalived.conf</p>\n<p>10.67.15.96为keepalived master，VIP为10.67.15.94，配置文件为96-lvs-keepalived.conf</p>\n<p>10.67.15.195为real server  </p>\n<p><strong>注意：</strong></p>\n<p>当使用LVS+DR+Keepalived配置时，需要在real server上添加一条iptables规则（其中dport根据情况添加或缺省）：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># iptables -t nat -A PREROUTING -p tcp -d 10.67.15.94 --dport 80 -j REDIRECT</div></pre></td></tr></table></figure></p>\n<p>当使用LVS+NAT+Keepalived配置时，需要将real server的默认路由配置成Director的VIP10.67.15.94，必须确保client的请求是通过10.67.15.94到达real server的。</p>\n<h2 id=\"安装keepalived\"><a href=\"#安装keepalived\" class=\"headerlink\" title=\"安装keepalived\"></a>安装keepalived</h2><p>从keepalived<a href=\"http://www.keepalived.org/download.html\" target=\"_blank\" rel=\"external\">官网</a>下载合适的版本，解压并执行如下命令完成安装。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># cd keepalived-xxx</div><div class=\"line\"># ./configure --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --mandir=/usr/share</div><div class=\"line\"># make &amp;&amp; make install</div></pre></td></tr></table></figure></p>\n<p>你也可以打成<a href=\"https://github.com/chenzhiwei/linux/tree/master/rpm-package-management\" target=\"_blank\" rel=\"external\">RPM</a>包，然后安装。</p>\n<h2 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h2><p>我们用到的HA场景如下： 两台主机host113和host163，内网IP在eth1网卡上，分别是10.210.214.113和10.210.214.163，VIP为公网IP在eth0上，IP地址是202.102.152.253，网关为202.102.152.1。当VIP在host113上提供服务时，host113上的默认路由为202.102.152.1，提供服务的端口为202.102.152.253:443。host113发生故障需要将VIP及服务切回到host163上的时候，需要以下几步，第一将VIP接管过来，第二添加默认路由202.102.152.1，第三启动在端口202.102.152.253:443上的服务。</p>\n<p>如此一来，keepalived需要另外的脚本来完成添加默认路由和启动服务工作，这点和heartbeat中的resources是相同的。目前我进行了测试，发现keepalived速度要比heartbeat快，也就是说效率比heartbeat高。并且，最重要的一点，keepalived支持多个backup。</p>\n<p>不要问我为何有以上需求。要为两个不同的域名提供https服务，由于SSL证书问题，必须有两个公网IP地址分别绑定443端口。</p>\n<p>当然，通过<a href=\"http://en.wikipedia.org/wiki/Server_Name_Indication\" target=\"_blank\" rel=\"external\">SNI</a>也可以实现一个公网IP绑定443端口来为多个域名提供https服务，但是这需要浏览器支持（M$的IE浏览器不支持）。（<a href=\"http://nginx.org/en/docs/http/configuring_https_servers.html#sni\" target=\"_blank\" rel=\"external\">nginx</a>/<a href=\"http://wiki.apache.org/httpd/NameBasedSSLVHostsWithSNI\" target=\"_blank\" rel=\"external\">apache</a>）</p>\n<h2 id=\"吐槽\"><a href=\"#吐槽\" class=\"headerlink\" title=\"吐槽\"></a>吐槽</h2><p>keepalived的主从切换比较让人蛋疼，需要修改配置文件或停止一方的运行。但是由于keepalived是通过vrrp协议来实现failover（故障转移）的，因此也决定了手动主从切换的不便。</p>\n<p>keepalived的文档也很旧了，一直都找不到合适的文档，之前我就一直忽略了vrrp_script这个区域，导致很多事情想不通。</p>\n<p>另外，我发现我越来越喜欢keepalived了。。。</p>\n<p><a href=\"http://outofmemory.cn/wiki/keepalived-configuration\" target=\"_blank\" rel=\"external\">转自：http://outofmemory.cn/wiki/keepalived-configuration</a></p>\n","excerpt":"<h2 id=\"keepalived是什么\"><a href=\"#keepalived是什么\" class=\"headerlink\" title=\"keepalived是什么\"></a>keepalived是什么</h2><p>keepalived是集群管理中保证集群高可用的一个服务软件，其功能类似于<a href=\"https://github.com/chenzhiwei/linux/tree/master/heartbeat\">heartbeat</a>，用来防止单点故障。</p>\n<h2 id=\"keepalived工作原理\"><a href=\"#keepalived工作原理\" class=\"headerlink\" title=\"keepalived工作原理\"></a>keepalived工作原理</h2><p>keepalived是以VRRP协议为实现基础的，VRRP全称Virtual Router Redundancy Protocol，即<a href=\"http://en.wikipedia.org/wiki/VRRP\">虚拟路由冗余协议</a>。</p>\n<p>虚拟路由冗余协议，可以认为是实现路由器高可用的协议，即将N台提供相同功能的路由器组成一个路由器组，这个组里面有一个master和多个backup，master上面有一个对外提供服务的vip（该路由器所在局域网内其他机器的默认路由为该vip），master会发组播，当backup收不到vrrp包时就认为master宕掉了，这时就需要根据<a href=\"http://tools.ietf.org/html/rfc5798#section-5.1\">VRRP的优先级</a>来选举一个backup当master。这样的话就可以保证路由器的高可用了。</p>\n<p>keepalived主要有三个模块，分别是core、check和vrrp。</p>\n<ul>\n<li>core模块为keepalived的核心，负责主进程的启动、维护以及全局配置文件的加载和解析。</li>\n<li>check负责健康检查，包括常见的各种检查方式。</li>\n<li>vrrp模块是来实现VRRP协议的。</li>\n</ul>","more":"<h2 id=\"keepalived的配置文件\"><a href=\"#keepalived的配置文件\" class=\"headerlink\" title=\"keepalived的配置文件\"></a>keepalived的配置文件</h2><p>keepalived只有一个配置文件keepalived.conf，里面主要包括以下几个配置区域，分别是global_defs、static_ipaddress、static_routes、vrrp_script、vrrp_instance和virtual_server。</p>\n<h3 id=\"global-defs区域\"><a href=\"#global-defs区域\" class=\"headerlink\" title=\"global_defs区域\"></a>global_defs区域</h3><blockquote>\n<p>主要是配置故障发生时的通知对象以及机器标识</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div></pre></td><td class=\"code\"><pre><div class=\"line\">global_defs &#123;</div><div class=\"line\">    notification_email &#123;</div><div class=\"line\">        a@abc.com</div><div class=\"line\">        b@abc.com</div><div class=\"line\">        ...</div><div class=\"line\">    &#125;</div><div class=\"line\">    notification_email_from alert@abc.com</div><div class=\"line\">    smtp_server smtp.abc.com</div><div class=\"line\">    smtp_connect_timeout 30</div><div class=\"line\">    enable_traps</div><div class=\"line\">    router_id host163</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>notification_email 故障发生时给谁发邮件通知。</li>\n<li>notification_email_from 通知邮件从哪个地址发出。</li>\n<li>smpt_server 通知邮件的smtp地址。</li>\n<li>smtp_connect_timeout 连接smtp服务器的超时时间。</li>\n<li>enable_traps 开启SNMP陷阱（<a href=\"http://en.wikipedia.org/wiki/Simple_Network_Management_Protocol\">Simple Network Management Protocol</a>）。</li>\n<li>router_id 标识本节点的字条串，通常为hostname，但不一定非得是hostname。故障发生时，邮件通知会用到。</li>\n</ul>\n<h3 id=\"static-ipaddress和static-routes\"><a href=\"#static-ipaddress和static-routes\" class=\"headerlink\" title=\"static_ipaddress和static_routes\"></a>static_ipaddress和static_routes</h3><blockquote>\n<p>static_ipaddress和static_routes区域配置的是是本节点的IP和路由信息。如果你的机器上已经配置了IP和路由，那么这两个区域可以不用配置。<br>其实，一般情况下你的机器都会有IP地址和路由信息的，因此没必要再在这两个区域配置。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">static_ipaddress &#123;</div><div class=\"line\">    10.210.214.163/24 brd 10.210.214.255 dev eth0</div><div class=\"line\">    ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">static_routes &#123;</div><div class=\"line\">    10.0.0.0/8 via 10.210.214.1 dev eth0</div><div class=\"line\">    ...</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>以上分别表示启动/关闭keepalived时在本机执行的如下命令：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\"># /sbin/ip addr add 10.210.214.163/24 brd 10.210.214.255 dev eth0</div><div class=\"line\"># /sbin/ip route add 10.0.0.0/8 via 10.210.214.1 dev eth0</div><div class=\"line\"># /sbin/ip addr del 10.210.214.163/24 brd 10.210.214.255 dev eth0</div><div class=\"line\"># /sbin/ip route del 10.0.0.0/8 via 10.210.214.1 dev eth0</div></pre></td></tr></table></figure></p>\n<p>注意： 请忽略这两个区域，因为我坚信你的机器肯定已经配置了IP和路由。</p>\n<h3 id=\"vrrp-script\"><a href=\"#vrrp-script\" class=\"headerlink\" title=\"vrrp_script\"></a>vrrp_script</h3><blockquote>\n<p>用来做健康检查的，当时检查失败时会将vrrp_instance的priority减少相应的值。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">vrrp_script chk_http_port &#123;</div><div class=\"line\">    script &quot;&lt;/dev/tcp/127.0.0.1/80&quot;</div><div class=\"line\">    interval 1</div><div class=\"line\">    weight -10</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>以上意思是如果script中的指令执行失败，那么相应的vrrp_instance的优先级会减少10个点。</p>\n<h3 id=\"vrrp-instance和vrrp-sync-group区域\"><a href=\"#vrrp-instance和vrrp-sync-group区域\" class=\"headerlink\" title=\"vrrp_instance和vrrp_sync_group区域\"></a>vrrp_instance和vrrp_sync_group区域</h3><blockquote>\n<p>vrrp_instance用来定义对外提供服务的VIP区域及其相关属性。</p>\n<p>vrrp_rsync_group用来定义vrrp_intance组，使得这个组内成员动作一致。</p>\n</blockquote>\n<p>举个例子来说明一下其功能：</p>\n<p>两个vrrp_instance同属于一个vrrp_rsync_group，那么其中一个vrrp_instance发生故障切换时，另一个vrrp_instance也会跟着切换（即使这个instance没有发生故障）。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div></pre></td><td class=\"code\"><pre><div class=\"line\">vrrp_sync_group VG_1 &#123;</div><div class=\"line\">    group &#123;</div><div class=\"line\">        inside_network   # name of vrrp_instance (below)</div><div class=\"line\">        outside_network  # One for each moveable IP.</div><div class=\"line\">        ...</div><div class=\"line\">    &#125;</div><div class=\"line\">    notify_master /path/to_master.sh</div><div class=\"line\">    notify_backup /path/to_backup.sh</div><div class=\"line\">    notify_fault &quot;/path/fault.sh VG_1&quot;</div><div class=\"line\">    notify /path/notify.sh</div><div class=\"line\">    smtp_alert</div><div class=\"line\">&#125;</div><div class=\"line\">vrrp_instance VI_1 &#123;</div><div class=\"line\">    state MASTER</div><div class=\"line\">    interface eth0</div><div class=\"line\">    use_vmac &lt;VMAC_INTERFACE&gt;</div><div class=\"line\">    dont_track_primary</div><div class=\"line\">    track_interface &#123;</div><div class=\"line\">        eth0</div><div class=\"line\">        eth1</div><div class=\"line\">    &#125;</div><div class=\"line\">    mcast_src_ip &lt;IPADDR&gt;</div><div class=\"line\">    lvs_sync_daemon_interface eth1</div><div class=\"line\">    garp_master_delay 10</div><div class=\"line\">    virtual_router_id 1</div><div class=\"line\">    priority 100</div><div class=\"line\">    advert_int 1</div><div class=\"line\">    authentication &#123;</div><div class=\"line\">        auth_type PASS</div><div class=\"line\">        auth_pass 12345678</div><div class=\"line\">    &#125;</div><div class=\"line\">    virtual_ipaddress &#123;</div><div class=\"line\">        10.210.214.253/24 brd 10.210.214.255 dev eth0</div><div class=\"line\">        192.168.1.11/24 brd 192.168.1.255 dev eth1</div><div class=\"line\">    &#125;</div><div class=\"line\">    virtual_routes &#123;</div><div class=\"line\">        172.16.0.0/12 via 10.210.214.1</div><div class=\"line\">        192.168.1.0/24 via 192.168.1.1 dev eth1</div><div class=\"line\">        default via 202.102.152.1</div><div class=\"line\">    &#125;</div><div class=\"line\">    track_script &#123;</div><div class=\"line\">        chk_http_port</div><div class=\"line\">    &#125;</div><div class=\"line\">    nopreempt</div><div class=\"line\">    preempt_delay 300</div><div class=\"line\">    debug</div><div class=\"line\">    notify_master &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    notify_backup &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    notify_fault &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    notify &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    smtp_alert</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure></p>\n<ul>\n<li>notify_master/backup/fault 分别表示切换为主/备/出错时所执行的脚本。</li>\n<li>notify 表示任何一状态切换时都会调用该脚本，并且该脚本在以上三个脚本执行完成之后进行调用，keepalived会自动传递三个参数（$1 = “GROUP”|”INSTANCE”，$2 = name of group or instance，$3 = target state of transition(MASTER/BACKUP/FAULT)）。</li>\n<li>smtp_alert 表示是否开启邮件通知（用全局区域的邮件设置来发通知）。</li>\n<li>state 可以是MASTER或BACKUP，不过当其他节点keepalived启动时会将priority比较大的节点选举为MASTER，因此该项其实没有实质用途。</li>\n<li>interface 节点固有IP（非VIP）的网卡，用来发VRRP包。</li>\n<li>use_vmac 是否使用VRRP的虚拟MAC地址。</li>\n<li>dont_track_primary 忽略VRRP网卡错误。（默认未设置）</li>\n<li>track_interface 监控以下网卡，如果任何一个不通就会切换到FALT状态。（可选项）</li>\n<li>mcast_src_ip 修改vrrp组播包的源地址，默认源地址为master的IP。（由于是组播，因此即使修改了源地址，该master还是能收到回应的）</li>\n<li>lvs_sync_daemon_interface 绑定lvs syncd的网卡。</li>\n<li>garp_master_delay 当切为主状态后多久更新ARP缓存，默认5秒。</li>\n<li>virtual_router_id 取值在0-255之间，用来区分多个instance的VRRP组播。</li>\n</ul>\n<p>注意： 同一网段中virtual_router_id的值不能重复，否则会出错，相关错误信息如下。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">Keepalived_vrrp[27120]: ip address associated with VRID not present in received packet :</div><div class=\"line\">one or more VIP associated with VRID mismatch actual MASTER advert</div><div class=\"line\">bogus VRRP packet received on eth1 !!!</div><div class=\"line\">receive an invalid ip number count associated with VRID!</div><div class=\"line\">VRRP_Instance(xxx) ignoring received advertisment...</div></pre></td></tr></table></figure></p>\n<p>可以用这条命令来查看该网络中所存在的vrid：<code>tcpdump -nn -i any net 224.0.0.0/8</code></p>\n<ul>\n<li>priority 用来选举master的，要成为master，那么这个选项的值最好<a href=\"http://tools.ietf.org/html/rfc5798#section-8.3.2\">高于其他机器50个点</a>，该项<a href=\"http://tools.ietf.org/html/rfc5798#section-5.2.4\">取值范围</a>是1-255（在此范围之外会被识别成默认值100）。</li>\n<li>advert_int 发VRRP包的时间间隔，即多久进行一次master选举（可以认为是健康查检时间间隔）。</li>\n<li>authentication 认证区域，认证类型有PASS和HA（IPSEC），推荐使用PASS（密码只识别前8位）。</li>\n<li>virtual_ipaddress vip，不解释了。</li>\n<li>virtual_routes 虚拟路由，当IP漂过来之后需要添加的路由信息。</li>\n<li>virtual_ipaddress_excluded 发送的VRRP包里不包含的IP地址，为减少回应VRRP包的个数。在网卡上绑定的IP地址比较多的时候用。</li>\n<li>nopreempt 允许一个priority比较低的节点作为master，即使有priority更高的节点启动。</li>\n</ul>\n<p>首先nopreemt必须在state为BACKUP的节点上才生效（因为是BACKUP节点决定是否来成为MASTER的），其次要实现类似于关闭auto failback的功能需要将所有节点的state都设置为BACKUP，或者将master节点的priority设置的比BACKUP低。我个人推荐使用将所有节点的state都设置成BACKUP并且都加上nopreempt选项，这样就完成了关于autofailback功能，当想手动将某节点切换为MASTER时只需去掉该节点的nopreempt选项并且将priority改的比其他节点大，然后重新加载配置文件即可（等MASTER切过来之后再将配置文件改回去再reload一下）。</p>\n<p>当使用track_script时可以不用加nopreempt，只需要加上preempt_delay 5，这里的间隔时间要大于vrrp_script中定义的时长。</p>\n<ul>\n<li>preempt_delay master启动多久之后进行接管资源（VIP/Route信息等），并提是没有nopreempt选项。</li>\n</ul>\n<h3 id=\"virtual-server-group和virtual-server区域\"><a href=\"#virtual-server-group和virtual-server区域\" class=\"headerlink\" title=\"virtual_server_group和virtual_server区域\"></a>virtual_server_group和virtual_server区域</h3><blockquote>\n<p>virtual_server_group一般在超大型的LVS中用到，一般LVS用不过这东西，因此不多说。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div></pre></td><td class=\"code\"><pre><div class=\"line\">virtual_server IP Port &#123;</div><div class=\"line\">    delay_loop &lt;INT&gt;</div><div class=\"line\">    lb_algo rr|wrr|lc|wlc|lblc|sh|dh</div><div class=\"line\">    lb_kind NAT|DR|TUN</div><div class=\"line\">    persistence_timeout &lt;INT&gt;</div><div class=\"line\">    persistence_granularity &lt;NETMASK&gt;</div><div class=\"line\">    protocol TCP</div><div class=\"line\">    ha_suspend</div><div class=\"line\">    virtualhost &lt;STRING&gt;</div><div class=\"line\">    alpha</div><div class=\"line\">    omega</div><div class=\"line\">    quorum &lt;INT&gt;</div><div class=\"line\">    hysteresis &lt;INT&gt;</div><div class=\"line\">    quorum_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    quorum_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">    sorry_server &lt;IPADDR&gt; &lt;PORT&gt;</div><div class=\"line\">    real_server &lt;IPADDR&gt; &lt;PORT&gt; &#123;</div><div class=\"line\">        weight &lt;INT&gt;</div><div class=\"line\">        inhibit_on_failure</div><div class=\"line\">        notify_up &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">        notify_down &lt;STRING&gt;|&lt;QUOTED-STRING&gt;</div><div class=\"line\">        # HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK</div><div class=\"line\">        HTTP_GET|SSL_GET &#123;</div><div class=\"line\">            url &#123;</div><div class=\"line\">                path &lt;STRING&gt;</div><div class=\"line\">                # Digest computed with genhash</div><div class=\"line\">                digest &lt;STRING&gt;</div><div class=\"line\">                status_code &lt;INT&gt;</div><div class=\"line\">            &#125;</div><div class=\"line\">            connect_port &lt;PORT&gt;</div><div class=\"line\">            connect_timeout &lt;INT&gt;</div><div class=\"line\">            nb_get_retry &lt;INT&gt;</div><div class=\"line\">            delay_before_retry &lt;INT&gt;</div><div class=\"line\">        &#125;</div><div class=\"line\">    &#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<ul>\n<li>delay_loop 延迟轮询时间（单位秒）。</li>\n<li>lb_algo 后端调试算法（load balancing algorithm）。</li>\n<li>lb_kind LVS调度类型NAT/DR/TUN。</li>\n<li>virtualhost 用来给HTTP_GET和SSL_GET配置请求header的。</li>\n<li>sorry_server 当所有real server宕掉时，sorry server顶替。</li>\n<li>real_server 真正提供服务的服务器。</li>\n<li>weight 权重。</li>\n<li>notify_up/down 当real server宕掉或启动时执行的脚本。</li>\n</ul>\n<p>健康检查的方式，N多种方式。</p>\n<ul>\n<li>path 请求real serserver上的路径。</li>\n<li>digest/status_code 分别表示用genhash算出的结果和http状态码。</li>\n<li>connect_port 健康检查，如果端口通则认为服务器正常。</li>\n<li>connect_timeout,nb_get_retry,delay_before_retry分别表示超时时长、重试次数，下次重试的时间延迟。</li>\n</ul>\n<p>其他选项暂时不作说明。</p>\n<h2 id=\"keepalived主从切换\"><a href=\"#keepalived主从切换\" class=\"headerlink\" title=\"keepalived主从切换\"></a>keepalived主从切换</h2><p>主从切换比较让人蛋疼，需要将backup配置文件的priority选项的值调整的比master高50个点，然后reload配置文件就可以切换了。当时你也可以将master的keepalived停止，这样也可以进行主从切换。</p>\n<h2 id=\"keepalived仅做HA时的配置\"><a href=\"#keepalived仅做HA时的配置\" class=\"headerlink\" title=\"keepalived仅做HA时的配置\"></a>keepalived仅做HA时的配置</h2><p>请看该文档同级目录下的配置文件示例。</p>\n<p>说明：</p>\n<ul>\n<li>10.210.214.113 为keepalived的备机，其配置文件为113.keepalived.conf</li>\n<li>10.210.214.163 为keepalived的主机，其配置文件为163.keepalived.conf</li>\n<li>10.210.214.253 为Virtual IP，即提供服务的内网IP地址，在网卡eth0上面</li>\n<li>192.168.1.11 为模拟的提供服务的公网IP地址，在网卡eth1上面</li>\n</ul>\n<p>用tcpdump命令来捕获的结果如下：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">17:20:07.919419 IP 10.210.214.163 &gt; 224.0.0.18: VRRPv2, Advertisement, vrid 1, prio 200, authtype simple, intvl 1s, length 20</div></pre></td></tr></table></figure></p>\n<h2 id=\"LVS-Keepalived配置\"><a href=\"#LVS-Keepalived配置\" class=\"headerlink\" title=\"LVS+Keepalived配置\"></a>LVS+Keepalived配置</h2><blockquote>\n<p>注:Keepalived与LVS结合使用时一般还会用到一个工具ipvsadm，用来查看相关VS相关状态，关于ipvsadm的用法可以参考man手册。</p>\n</blockquote>\n<p>10.67.15.95为keepalived master，VIP为10.67.15.94，配置文件为95-lvs-keepalived.conf</p>\n<p>10.67.15.96为keepalived master，VIP为10.67.15.94，配置文件为96-lvs-keepalived.conf</p>\n<p>10.67.15.195为real server  </p>\n<p><strong>注意：</strong></p>\n<p>当使用LVS+DR+Keepalived配置时，需要在real server上添加一条iptables规则（其中dport根据情况添加或缺省）：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\"># iptables -t nat -A PREROUTING -p tcp -d 10.67.15.94 --dport 80 -j REDIRECT</div></pre></td></tr></table></figure></p>\n<p>当使用LVS+NAT+Keepalived配置时，需要将real server的默认路由配置成Director的VIP10.67.15.94，必须确保client的请求是通过10.67.15.94到达real server的。</p>\n<h2 id=\"安装keepalived\"><a href=\"#安装keepalived\" class=\"headerlink\" title=\"安装keepalived\"></a>安装keepalived</h2><p>从keepalived<a href=\"http://www.keepalived.org/download.html\">官网</a>下载合适的版本，解压并执行如下命令完成安装。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\"># cd keepalived-xxx</div><div class=\"line\"># ./configure --bindir=/usr/bin --sbindir=/usr/sbin --sysconfdir=/etc --mandir=/usr/share</div><div class=\"line\"># make &amp;&amp; make install</div></pre></td></tr></table></figure></p>\n<p>你也可以打成<a href=\"https://github.com/chenzhiwei/linux/tree/master/rpm-package-management\">RPM</a>包，然后安装。</p>\n<h2 id=\"说明\"><a href=\"#说明\" class=\"headerlink\" title=\"说明\"></a>说明</h2><p>我们用到的HA场景如下： 两台主机host113和host163，内网IP在eth1网卡上，分别是10.210.214.113和10.210.214.163，VIP为公网IP在eth0上，IP地址是202.102.152.253，网关为202.102.152.1。当VIP在host113上提供服务时，host113上的默认路由为202.102.152.1，提供服务的端口为202.102.152.253:443。host113发生故障需要将VIP及服务切回到host163上的时候，需要以下几步，第一将VIP接管过来，第二添加默认路由202.102.152.1，第三启动在端口202.102.152.253:443上的服务。</p>\n<p>如此一来，keepalived需要另外的脚本来完成添加默认路由和启动服务工作，这点和heartbeat中的resources是相同的。目前我进行了测试，发现keepalived速度要比heartbeat快，也就是说效率比heartbeat高。并且，最重要的一点，keepalived支持多个backup。</p>\n<p>不要问我为何有以上需求。要为两个不同的域名提供https服务，由于SSL证书问题，必须有两个公网IP地址分别绑定443端口。</p>\n<p>当然，通过<a href=\"http://en.wikipedia.org/wiki/Server_Name_Indication\">SNI</a>也可以实现一个公网IP绑定443端口来为多个域名提供https服务，但是这需要浏览器支持（M$的IE浏览器不支持）。（<a href=\"http://nginx.org/en/docs/http/configuring_https_servers.html#sni\">nginx</a>/<a href=\"http://wiki.apache.org/httpd/NameBasedSSLVHostsWithSNI\">apache</a>）</p>\n<h2 id=\"吐槽\"><a href=\"#吐槽\" class=\"headerlink\" title=\"吐槽\"></a>吐槽</h2><p>keepalived的主从切换比较让人蛋疼，需要修改配置文件或停止一方的运行。但是由于keepalived是通过vrrp协议来实现failover（故障转移）的，因此也决定了手动主从切换的不便。</p>\n<p>keepalived的文档也很旧了，一直都找不到合适的文档，之前我就一直忽略了vrrp_script这个区域，导致很多事情想不通。</p>\n<p>另外，我发现我越来越喜欢keepalived了。。。</p>\n<p><a href=\"http://outofmemory.cn/wiki/keepalived-configuration\">转自：http://outofmemory.cn/wiki/keepalived-configuration</a></p>"},{"title":"memcache高速缓存工作原理及应用","date":"2016-09-29T10:30:00.000Z","ctime":"2016-09-19T10:48:00.000Z","utime":"2016-09-29T10:48:00.000Z","modif_times":0,"_content":"\nMemcached,是高性能的分布式内存缓存服务器，主要功能就是通过缓存数据库的查询，减少对数据库的访问次数，来提高动态web应用的速度和可扩展性。\n\nmemcached 是以守护程序方法运行于一个或多个服务器中，随时接受客户端的连接操作，客户端可以由各种语言编写，目前一致的客户端api包括 Perl / PHP / Python / Java / C# / C 等等。客户端在与 memcached 服务建立连接之后，接下来的事情就是存取对象了， 每个被存取的对象都有一个唯一的标识符 key，存取操作均通过这个 key进行，保存到 memcached 中的对象实际上是放置内存中的，并不是保存在平时的 cache 文件中的，这也是为什么 memcached 能够如此高效快速的原因。\n\n注意，这些对象并不是持久的， 服务停止之后， 里边的数据就会丢失。\n\n![Memcached应用模型](http://n.sinaimg.cn/games/3ece443e/20160929/MemcacheYingYongMoXing.png?1)\n\n<!-- more -->\n\n## Memcached的安装\n### 准备\nlibevent\n> Libevent 是一个用C语言编写的、轻量级的开源高性能网络库。\n> 主要有以下几个亮点：事件驱动（ event-driven），高性能;轻量级，专注于网络，不如 ACE 那么臃肿庞大；源代码相当精炼、易读；跨平台，支持 Windows、 Linux、 BSD 和 Mac Os；支持多种 I/O 多路复用技术， epoll、 poll、 dev/poll、 select 和 kqueue 等；支持 I/O，定时器和信号等事件；注册事件优先级。\n> Libevent 已经被广泛的应用，作为底层的网络库；比如 memcached、 Vomit、 Nylon、 Netchat等等。\n\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160929/libevent-2.0.22-stable.tar\ntar -vxf libevent-2.0.22-stable.tar\ncd libevent-2.0.22-stable\n./configure --prefix=/usr/local/libevent\nmake && make install\n```\n\n### 安装\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160930/memcached-1.4.31.tar.gz\ncd memcached-1.4.31\n ./configure --prefix=/usr/local/memcached --with-libevent=/usr/local/libevent\nmake && make install\n```\n查看是否已经安装成功\n```\ncd /usr/local/memcached/\nll\ndrwxr-xr-x 2 root root 4096 9月  28 10:56 bin\ndrwxr-xr-x 3 root root 4096 9月  28 10:56 include\ndrwxr-xr-x 3 root root 4096 9月  28 10:56 share\n```\n## Memcached管理\n\n### 启动\n\n启动Memcached服务器\n```\n/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\n```\n查看是否启动成功\n```\nps aux | grep memcache\nroot     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:00 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\nroot     24436  0.0  0.0 112664   984 pts/0    D+   11:00   0:00 grep --color=auto memcache\n```\n或\n```\nnetstat -tlun | grep 11211\ntcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN\ntcp6       0      0 :::11211                :::*                    LISTEN\nudp        0      0 0.0.0.0:11211           0.0.0.0:*\nudp6       0      0 :::11211                :::*\n```\n\n设置开机自启动\n```\necho \"/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\" >> /etc/rc.d/rc.local\n```\n\nMemcached启动选项及说明\n\n选项           |描述\n--------------|----\n-p <num>      | Memcached监听的TCP端口，要保证该端口号未被占用\n-U <num>      | 指定监听UDP的端口，默认11211，0表示关闭\n-s <file>     | 指定Memcached用于监听的UNIX socket文件\n-A            | enable ascii \"shutdown\" command\n-a <mask>     | 设置-s选项指定的UNIX socket文件的权限(默认权限: 0700)\n-l <addr>     | 监听的服务器IP地址，如果有多个地址的话，使用逗号分隔，格式可以为“IP地址:端口号”，例如：-l 指定192.168.0.184:19830,192.168.0.195:13542；端口号也可以通过-p选项指定\n-d            | 指定memcached进程作为一个守护进程启动\n-r            | 设置产生core文件大小\n-u <username> | 运行memcached的用户 (only when run as root)\n-m <num>      | 指定分配给memcached使用的内存，单位是MB(默认: 64 MB)\n-M            | 当内存使用超出配置值时，禁止自动清除缓存中的数据项，此时Memcached不可用，直到内存被释放\n-c <num>      | 设置最大运行的并发连接数，默认是1024\n-k            | 设置锁定所有分页的内存，对于大缓存应用场景，谨慎使用该选项\n-v            | 输出警告和错误信息\n-vv           | 打印信息比-v更详细：不仅输出警告和错误信息，也输出客户端请求和响应信息\n-vvv          | extremely verbose (also print internal state transitions)\n-h            | 显示Memcached版本和摘要信息\n-i            | 打印libevent和Memcached的licenses信息\n-V            | 输出Memcached版本号\n-P <file>     | 保存memcached进程的pid文件，（与 -d 一起搭配使用）\n-f <factor>   | 用于计算缓存数据项的内存块大小的乘数因子，默认是1.25\n-n <bytes>    | 为缓存数据项的key、value、flag设置最小分配字节数，默认是48\n-L            | 尝试使用大内存分页（pages）\n-D <char>     | 用于统计报告中Key前缀和ID之间的分隔符，默认是冒号“:”  \n-t <num>      | 指定用来处理请求的线程数，默认为4\n-R            | 为避免客户端饿死（starvation），对连续达到的客户端请求数设置一个限额，如果超过该设置，会选择另一个连接来处理请求，默认为20\n-C            | 禁用CAS\n-b <num>      | Set the backlog queue limit (default: 1024)\n-B            | 指定使用的协议，默认行为是自动协商（autonegotiate），可能使用的选项有auto、ascii、binary。\n-I            | Override the size of each slab page. Adjusts max item size(default: 1mb, min: 1k, max: 128m)\n-F            | 禁用flush_all命令\n-o            | 指定逗号分隔的选项，一般用于用于扩展或实验性质的选项\n\n### 通过telnet连接使用Memcache\n连接\n```\ntelnet 127.0.0.1 11211\n```\n\n命令格式：<command name> <key> <flags> <exptime> <bytes>\\r\\n <data block>\\r\\n\n> <command name> 可以是”set”, “add”, “replace”\n> <key> 客户端需要保存数据的key。\n> <flags> 是一个16位的无符号的整数(以十进制的方式表示)。\n> <exptime> 过期的时间。\n> 最后客户端需要加上”\\r\\n”作为”命令头”的结束标志。即回车\n\n示例：\n\n保存一个数据（保存一个『cache_key1=>12345』的键值对到memcached 60s）\n```\nset cache_key1 0 60 5\n12345\nSTORED\n```\n获取刚保存的值\n```\nget cache_key1\nVALUE cache_key1 0 5\n12345\nEND\n```\n其他命令：\n\nCommand | Description | Example\n--------|-------------|-----------------\nget     | 获取值 | get mykey\nset     | 设置值（可以存在可以不存在） | set mykey 0 60 5\nadd     | 添加新值 | add newkey 0 60 5\nreplace | 替换值（必须已存在） | replace key 0 60 5\nappend  | 在原有值之后添加数据 | append key 0 60 15\nprepend | 在原有值之前添加数据| prepend key 0 60 15\nincr    | Increments numerical key value by given number | incr mykey 2\ndecr    | Decrements numerical key value by given number | decr mykey 5\ndelete  | 删除一条数据 | delete mykey\nflush_all | 清除所有数据 | flush_all\n        |清除900秒之内的数据 | flush_all 900\nstats   | 查看所有状态| stats\n        | Prints memory statistics | stats slabs\n        | Prints memory statistics | stats malloc\n        | Print higher level allocation statistics | stats items\n        | | stats detail\n        | 已使用大小 | stats sizes\n        | 重置状态 | stats reset\nversion | 查看版本 | version\nverbosity | Increases log level | verbosity\nquit    | 退出telnet连接 | quit\n\n\n### 通过客户端（PHP）连接和使用Memcached\nphp扩展Memcached安装\n\n依赖\n> libmemcached, 是一个 memcached 的库，客户端库，C 和 C++ 语言实现的客户端库，具有低内存占用率、线程安全、并提供对memcached功能的全面支持。它还采用 多种命令行工具： memcat ， memflush ， memrm ， memstat ，并memslap （负载代）。程序库一直在设计，让不同的散列方法对密钥，分割的钥匙，并使用统一的散列分配。\n\n```\nwget https://launchpadlibrarian.net/165454254/libmemcached-1.0.18.tar.gz\ntar -zxvf libmemcached-1.0.18.tar.gz\ncd libmemcached-1.0.18\n./configure --prefix=/usr/local/libmemcached\nmake && make install\n```\n\n安装扩展\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160929/memcached-2.2.0.tar\ntar -xvf memcached-2.2.0.tar\ncd memcached-2.2.0\n/usr/local/php56/bin/phpize\n./configure --with-php-config=/usr/local/php56/bin/php-config --with-libmemcached-dir=/usr/local/libmemcached  --enable-memcached --disable-memcached-sasl\nmake && make install\nInstalling shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\n```\n\n查看是否安装成功\n```\ncd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\nll\n-rwxr-xr-x 1 root root  380475 9月  28 22:25 memcached.so\n-rwxr-xr-x 1 root root  756714 9月  26 17:32 mysqli.so\n-rwxr-xr-x 1 root root 1333912 9月  24 23:31 opcache.a\n-rwxr-xr-x 1 root root  618435 9月  24 23:31 opcache.so\n```\n修改配置\n```\nvi /usr/local/php56/lib/php.ini\nextension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/memcached.so\n```\n重启php-fpm\n```\nkill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`\n```\n查看是否已经加载成功\n```\n/usr/local/php56/bin/php -m\n或通过phpinfo();查看\n```\n测试\n```\nvi memcache_test.php\n```\n```php\n<?php\n        $mc = new Memcached();\n        var_dump($mc);\n        $mc->addServer('127.0.0.1', 11211);\n        $mc->set('cache_key','mem_value',30);\n        $val = $mc->get('cache_key');\n        var_dump($val);\n        var_dump($mc->delete('cache_key'));\n        $mc->quit();\n```\n访问结果：\n```\nobject(Memcached)#1 (0) { } string(9) \"mem_value\" bool(true)\n```\n\nphp关于memcached 的两种扩展memcache 和 memcached 介绍\n\n1. 目前大多数php环境里使用的都是不带d的memcache版本，这个版本出的比较早，是一个原生版本，完全在php框架内开发的。与之对应的带d的memcached是建立在libmemcached的基础上，所以相对来说，memcached版本的功能更全一些。\n> [memcache:](http://cn2.php.net/manual/en/book.memcache.php)\n>\n> [memcached:](http://cn2.php.net/manual/en/book.memcached.php)\n\n2. Memcache是原生实现的，支持OO和非OO两套接口并存。而memcached是使用libmemcached，只支持OO接口。\n3. memcached有了一个统一的setOption()来设置设置，而不用在操作的时候设置了。Memcached实现了更多的memcached协议。\n4. memcached支持Binary Protocol，而memcache不支持。这意味着memcached会有更高的性能。不过memcached目前还不支持长连接。\n5. 另外一点也是大家比较关心的，就是所使用的算法。“一致性hash算法”是当添加或删除存储节点时，对存储在memcached上的数据影响较小的一种算法。在php的两个扩展库中，都可以使用该算法，只是设置方法有所不同。\n\n\n  - Memcache\n\n修改php.ini添加：\n```\n[Memcache]\nMemcache.allow_failover = 1\nMemcache.hash_strategy =consistent\nMemcache.hash_function =crc32\n```\n或在php中使用ini_set方法：\n```\nini_set(‘memcache.hash_strategy','standard');\nini_set(‘memcache.hash_function','crc32');\n```\n  - Memcached\n\n```\n$mem = new memcached();\n$mem->setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);\n$mem->setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);\n```\n\n## Memcached监控\n\n### 利用phpmemcache.php图形监控工具\n下载 phpmemcache.php\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.php\n```\n将phpmemcache.php放入web目录\n```\nmv phpmemcache.php /usr/local/nginx/html\n```\n修改phpmemcache.php中配置\n```\ndefine('ADMIN_USERNAME','xxxx');    // 用户名修改，在访问 phpmemcache.php 需要进行认证\ndefine('ADMIN_PASSWORD','xxxx');    // 密码\ndefine('DATE_FORMAT','Y/m/d H:i:s');\ndefine('GRAPH_SIZE',200);\ndefine('MAX_ITEM_DUMP',50);\n\n$MEMCACHE_SERVERS[] = '127.0.0.1:11211'; // 加入需要监控的memcached服务器\n//$MEMCACHE_SERVERS[] = '192.168.200.104:11212'; // add more as an array\n```\n\n浏览器访问\n![phpmemcache浏览器访问效果](http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.png?1)\n\n\n### 利用Stats命令查看\n利用stats命令可以查看当前memcached的各种状态\n```\ntelnet 127.0.0.1 11211\nTrying 127.0.0.1...\nConnected to 127.0.0.1.\nEscape character is '^]'.\nstats\nSTAT pid 24732\nSTAT uptime 66597\nSTAT time 1475115983\nSTAT version 1.4.31\nSTAT libevent 2.0.22-stable\nSTAT pointer_size 64\nSTAT rusage_user 6.194421\nSTAT rusage_system 2.419890\nSTAT curr_connections 10\nSTAT total_connections 16\nSTAT connection_structures 11\nSTAT reserved_fds 20\nSTAT cmd_get 5\nSTAT cmd_set 8\nSTAT cmd_flush 0\nSTAT cmd_touch 0\nSTAT get_hits 4\nSTAT get_misses 1\nSTAT get_expired 0\nSTAT get_flushed 0\nSTAT delete_misses 0\nSTAT delete_hits 2\nSTAT incr_misses 0\nSTAT incr_hits 0\nSTAT decr_misses 0\nSTAT decr_hits 0\nSTAT cas_misses 0\nSTAT cas_hits 0\nSTAT cas_badval 0\nSTAT touch_hits 0\nSTAT touch_misses 0\nSTAT auth_cmds 0\nSTAT auth_errors 0\nSTAT bytes_read 3850\nSTAT bytes_written 293\nSTAT limit_maxbytes 134217728\nSTAT accepting_conns 1\nSTAT listen_disabled_num 0\nSTAT time_in_listen_disabled_us 0\nSTAT threads 4\nSTAT conn_yields 0\nSTAT hash_power_level 16\nSTAT hash_bytes 524288\nSTAT hash_is_expanding 0\nSTAT malloc_fails 0\nSTAT log_worker_dropped 0\nSTAT log_worker_written 0\nSTAT log_watcher_skipped 0\nSTAT log_watcher_sent 0\nSTAT bytes 0\nSTAT curr_items 0\nSTAT total_items 6\nSTAT expired_unfetched 0\nSTAT evicted_unfetched 0\nSTAT evictions 0\nSTAT reclaimed 2\nSTAT crawler_reclaimed 0\nSTAT crawler_items_checked 0\nSTAT lrutail_reflocked 0\nEND\n```\n\nStats详解\n\n选项| 说明\n---|-----\npid |memcache服务器的进程ID\nuptime |服务器已经运行的秒数\ntime |服务器当前的unix时间戳\nversion |memcache版本\npointer_size |当前操作系统的指针大小（32位系统一般是32bit）\nrusage_user |进程的累计用户时间\nrusage_system |进程的累计系统时间\ncurr_items |服务器当前存储的items数量\ntotal_items |从服务器启动以后存储的items总数量\nbytes |当前服务器存储items占用的字节数\ncurr_connections|当前打开着的连接数\ntotal_connections |从服务器启动以后曾经打开过的连接数\nconnection_structures |服务器分配的连接构造数\ncmd_get |get命令（获取）总请求次数\ncmd_set |set命令（保存）总请求次数\nget_hits |总命中次数\nget_misses |总未命中次数\nevictions |为获取空闲内存而删除的items数（分配给memcache的空间用满后需要删除旧的items来得到空间分配给新的items）\nbytes_read|总读取字节数（请求字节数）\nbytes_written|总发送字节数（结果字节数）\nlimit_maxbytes|分配给memcache的内存大小（字节）\nthreads|当前线程数\n\n\n### 利用各种监控软件查看（例如：nagios监控memcache的插件）\n> 只以命中率大于和小于为例两种状态。\n\n```\nvim check_memcache\n```\n```bash\n#!/bin/sh\nif [ $# -ne 1 ]\nthen\necho \"Usage:$0 -c num2\"\nexit 0\nfi\ncmd_get=`/usr/local/nagios/libexec/check_tcp -H localhost -p 11211 -E -s 'stats\\r\\nquit\\r\\n' -e 'uptime' |grep cmd_get | awk '{print $3+0}'`\nget_hits=`/usr/local/nagios/libexec/check_tcp -H localhost -p 11211 -E -s 'stats\\r\\nquit\\r\\n' -e 'uptime' |grep get_hits | awk '{print $3+0}'`\nhit_rate=`echo \"$get_hits*100/$cmd_get\"|bc`\nif [ $hit_rate -gt $1 ];then\necho \"OK - hit rate is $hit_rate | hit_rate=$hit_rate; cmd_get=$cmd_get; get_hits=$get_hits\"\nexit 0\nelse\necho \"CRITICAL - hit rate is $hit_rate | hit_rate=$hit_rate; cmd_get=$cmd_get; get_hits=$get_hits\"\nexit 2\nfi\n```\n\n测试命中率大于80%为正常为例;\n```\neg：\nsh check_memcache 80\nroot@ip-10-250-114-95:/liang# sh check_memcache 80\nOK - hit rate is 99 | hit_rate=99; cmd_get=142547; get_hits=141880\n```\n以上证明命中率99%，即状态为OK.\n","source":"_posts/memcache高速缓存的工作原理及应用小结.md","raw":"---\ntitle: memcache高速缓存工作原理及应用\ndate: 2016-09-29 18:30:00\nctime: 2016-09-19 18:48:00\nutime: 2016-09-29 18:48:00\nmodif_times: 0\ntags:\n- 缓存\n- memcache\n- memcached\ncategories:\n- Linux\n---\n\nMemcached,是高性能的分布式内存缓存服务器，主要功能就是通过缓存数据库的查询，减少对数据库的访问次数，来提高动态web应用的速度和可扩展性。\n\nmemcached 是以守护程序方法运行于一个或多个服务器中，随时接受客户端的连接操作，客户端可以由各种语言编写，目前一致的客户端api包括 Perl / PHP / Python / Java / C# / C 等等。客户端在与 memcached 服务建立连接之后，接下来的事情就是存取对象了， 每个被存取的对象都有一个唯一的标识符 key，存取操作均通过这个 key进行，保存到 memcached 中的对象实际上是放置内存中的，并不是保存在平时的 cache 文件中的，这也是为什么 memcached 能够如此高效快速的原因。\n\n注意，这些对象并不是持久的， 服务停止之后， 里边的数据就会丢失。\n\n![Memcached应用模型](http://n.sinaimg.cn/games/3ece443e/20160929/MemcacheYingYongMoXing.png?1)\n\n<!-- more -->\n\n## Memcached的安装\n### 准备\nlibevent\n> Libevent 是一个用C语言编写的、轻量级的开源高性能网络库。\n> 主要有以下几个亮点：事件驱动（ event-driven），高性能;轻量级，专注于网络，不如 ACE 那么臃肿庞大；源代码相当精炼、易读；跨平台，支持 Windows、 Linux、 BSD 和 Mac Os；支持多种 I/O 多路复用技术， epoll、 poll、 dev/poll、 select 和 kqueue 等；支持 I/O，定时器和信号等事件；注册事件优先级。\n> Libevent 已经被广泛的应用，作为底层的网络库；比如 memcached、 Vomit、 Nylon、 Netchat等等。\n\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160929/libevent-2.0.22-stable.tar\ntar -vxf libevent-2.0.22-stable.tar\ncd libevent-2.0.22-stable\n./configure --prefix=/usr/local/libevent\nmake && make install\n```\n\n### 安装\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160930/memcached-1.4.31.tar.gz\ncd memcached-1.4.31\n ./configure --prefix=/usr/local/memcached --with-libevent=/usr/local/libevent\nmake && make install\n```\n查看是否已经安装成功\n```\ncd /usr/local/memcached/\nll\ndrwxr-xr-x 2 root root 4096 9月  28 10:56 bin\ndrwxr-xr-x 3 root root 4096 9月  28 10:56 include\ndrwxr-xr-x 3 root root 4096 9月  28 10:56 share\n```\n## Memcached管理\n\n### 启动\n\n启动Memcached服务器\n```\n/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\n```\n查看是否启动成功\n```\nps aux | grep memcache\nroot     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:00 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\nroot     24436  0.0  0.0 112664   984 pts/0    D+   11:00   0:00 grep --color=auto memcache\n```\n或\n```\nnetstat -tlun | grep 11211\ntcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN\ntcp6       0      0 :::11211                :::*                    LISTEN\nudp        0      0 0.0.0.0:11211           0.0.0.0:*\nudp6       0      0 :::11211                :::*\n```\n\n设置开机自启动\n```\necho \"/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211\" >> /etc/rc.d/rc.local\n```\n\nMemcached启动选项及说明\n\n选项           |描述\n--------------|----\n-p <num>      | Memcached监听的TCP端口，要保证该端口号未被占用\n-U <num>      | 指定监听UDP的端口，默认11211，0表示关闭\n-s <file>     | 指定Memcached用于监听的UNIX socket文件\n-A            | enable ascii \"shutdown\" command\n-a <mask>     | 设置-s选项指定的UNIX socket文件的权限(默认权限: 0700)\n-l <addr>     | 监听的服务器IP地址，如果有多个地址的话，使用逗号分隔，格式可以为“IP地址:端口号”，例如：-l 指定192.168.0.184:19830,192.168.0.195:13542；端口号也可以通过-p选项指定\n-d            | 指定memcached进程作为一个守护进程启动\n-r            | 设置产生core文件大小\n-u <username> | 运行memcached的用户 (only when run as root)\n-m <num>      | 指定分配给memcached使用的内存，单位是MB(默认: 64 MB)\n-M            | 当内存使用超出配置值时，禁止自动清除缓存中的数据项，此时Memcached不可用，直到内存被释放\n-c <num>      | 设置最大运行的并发连接数，默认是1024\n-k            | 设置锁定所有分页的内存，对于大缓存应用场景，谨慎使用该选项\n-v            | 输出警告和错误信息\n-vv           | 打印信息比-v更详细：不仅输出警告和错误信息，也输出客户端请求和响应信息\n-vvv          | extremely verbose (also print internal state transitions)\n-h            | 显示Memcached版本和摘要信息\n-i            | 打印libevent和Memcached的licenses信息\n-V            | 输出Memcached版本号\n-P <file>     | 保存memcached进程的pid文件，（与 -d 一起搭配使用）\n-f <factor>   | 用于计算缓存数据项的内存块大小的乘数因子，默认是1.25\n-n <bytes>    | 为缓存数据项的key、value、flag设置最小分配字节数，默认是48\n-L            | 尝试使用大内存分页（pages）\n-D <char>     | 用于统计报告中Key前缀和ID之间的分隔符，默认是冒号“:”  \n-t <num>      | 指定用来处理请求的线程数，默认为4\n-R            | 为避免客户端饿死（starvation），对连续达到的客户端请求数设置一个限额，如果超过该设置，会选择另一个连接来处理请求，默认为20\n-C            | 禁用CAS\n-b <num>      | Set the backlog queue limit (default: 1024)\n-B            | 指定使用的协议，默认行为是自动协商（autonegotiate），可能使用的选项有auto、ascii、binary。\n-I            | Override the size of each slab page. Adjusts max item size(default: 1mb, min: 1k, max: 128m)\n-F            | 禁用flush_all命令\n-o            | 指定逗号分隔的选项，一般用于用于扩展或实验性质的选项\n\n### 通过telnet连接使用Memcache\n连接\n```\ntelnet 127.0.0.1 11211\n```\n\n命令格式：<command name> <key> <flags> <exptime> <bytes>\\r\\n <data block>\\r\\n\n> <command name> 可以是”set”, “add”, “replace”\n> <key> 客户端需要保存数据的key。\n> <flags> 是一个16位的无符号的整数(以十进制的方式表示)。\n> <exptime> 过期的时间。\n> 最后客户端需要加上”\\r\\n”作为”命令头”的结束标志。即回车\n\n示例：\n\n保存一个数据（保存一个『cache_key1=>12345』的键值对到memcached 60s）\n```\nset cache_key1 0 60 5\n12345\nSTORED\n```\n获取刚保存的值\n```\nget cache_key1\nVALUE cache_key1 0 5\n12345\nEND\n```\n其他命令：\n\nCommand | Description | Example\n--------|-------------|-----------------\nget     | 获取值 | get mykey\nset     | 设置值（可以存在可以不存在） | set mykey 0 60 5\nadd     | 添加新值 | add newkey 0 60 5\nreplace | 替换值（必须已存在） | replace key 0 60 5\nappend  | 在原有值之后添加数据 | append key 0 60 15\nprepend | 在原有值之前添加数据| prepend key 0 60 15\nincr    | Increments numerical key value by given number | incr mykey 2\ndecr    | Decrements numerical key value by given number | decr mykey 5\ndelete  | 删除一条数据 | delete mykey\nflush_all | 清除所有数据 | flush_all\n        |清除900秒之内的数据 | flush_all 900\nstats   | 查看所有状态| stats\n        | Prints memory statistics | stats slabs\n        | Prints memory statistics | stats malloc\n        | Print higher level allocation statistics | stats items\n        | | stats detail\n        | 已使用大小 | stats sizes\n        | 重置状态 | stats reset\nversion | 查看版本 | version\nverbosity | Increases log level | verbosity\nquit    | 退出telnet连接 | quit\n\n\n### 通过客户端（PHP）连接和使用Memcached\nphp扩展Memcached安装\n\n依赖\n> libmemcached, 是一个 memcached 的库，客户端库，C 和 C++ 语言实现的客户端库，具有低内存占用率、线程安全、并提供对memcached功能的全面支持。它还采用 多种命令行工具： memcat ， memflush ， memrm ， memstat ，并memslap （负载代）。程序库一直在设计，让不同的散列方法对密钥，分割的钥匙，并使用统一的散列分配。\n\n```\nwget https://launchpadlibrarian.net/165454254/libmemcached-1.0.18.tar.gz\ntar -zxvf libmemcached-1.0.18.tar.gz\ncd libmemcached-1.0.18\n./configure --prefix=/usr/local/libmemcached\nmake && make install\n```\n\n安装扩展\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160929/memcached-2.2.0.tar\ntar -xvf memcached-2.2.0.tar\ncd memcached-2.2.0\n/usr/local/php56/bin/phpize\n./configure --with-php-config=/usr/local/php56/bin/php-config --with-libmemcached-dir=/usr/local/libmemcached  --enable-memcached --disable-memcached-sasl\nmake && make install\nInstalling shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\n```\n\n查看是否安装成功\n```\ncd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/\nll\n-rwxr-xr-x 1 root root  380475 9月  28 22:25 memcached.so\n-rwxr-xr-x 1 root root  756714 9月  26 17:32 mysqli.so\n-rwxr-xr-x 1 root root 1333912 9月  24 23:31 opcache.a\n-rwxr-xr-x 1 root root  618435 9月  24 23:31 opcache.so\n```\n修改配置\n```\nvi /usr/local/php56/lib/php.ini\nextension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/memcached.so\n```\n重启php-fpm\n```\nkill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`\n```\n查看是否已经加载成功\n```\n/usr/local/php56/bin/php -m\n或通过phpinfo();查看\n```\n测试\n```\nvi memcache_test.php\n```\n```php\n<?php\n        $mc = new Memcached();\n        var_dump($mc);\n        $mc->addServer('127.0.0.1', 11211);\n        $mc->set('cache_key','mem_value',30);\n        $val = $mc->get('cache_key');\n        var_dump($val);\n        var_dump($mc->delete('cache_key'));\n        $mc->quit();\n```\n访问结果：\n```\nobject(Memcached)#1 (0) { } string(9) \"mem_value\" bool(true)\n```\n\nphp关于memcached 的两种扩展memcache 和 memcached 介绍\n\n1. 目前大多数php环境里使用的都是不带d的memcache版本，这个版本出的比较早，是一个原生版本，完全在php框架内开发的。与之对应的带d的memcached是建立在libmemcached的基础上，所以相对来说，memcached版本的功能更全一些。\n> [memcache:](http://cn2.php.net/manual/en/book.memcache.php)\n>\n> [memcached:](http://cn2.php.net/manual/en/book.memcached.php)\n\n2. Memcache是原生实现的，支持OO和非OO两套接口并存。而memcached是使用libmemcached，只支持OO接口。\n3. memcached有了一个统一的setOption()来设置设置，而不用在操作的时候设置了。Memcached实现了更多的memcached协议。\n4. memcached支持Binary Protocol，而memcache不支持。这意味着memcached会有更高的性能。不过memcached目前还不支持长连接。\n5. 另外一点也是大家比较关心的，就是所使用的算法。“一致性hash算法”是当添加或删除存储节点时，对存储在memcached上的数据影响较小的一种算法。在php的两个扩展库中，都可以使用该算法，只是设置方法有所不同。\n\n\n  - Memcache\n\n修改php.ini添加：\n```\n[Memcache]\nMemcache.allow_failover = 1\nMemcache.hash_strategy =consistent\nMemcache.hash_function =crc32\n```\n或在php中使用ini_set方法：\n```\nini_set(‘memcache.hash_strategy','standard');\nini_set(‘memcache.hash_function','crc32');\n```\n  - Memcached\n\n```\n$mem = new memcached();\n$mem->setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);\n$mem->setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);\n```\n\n## Memcached监控\n\n### 利用phpmemcache.php图形监控工具\n下载 phpmemcache.php\n```\nwget http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.php\n```\n将phpmemcache.php放入web目录\n```\nmv phpmemcache.php /usr/local/nginx/html\n```\n修改phpmemcache.php中配置\n```\ndefine('ADMIN_USERNAME','xxxx');    // 用户名修改，在访问 phpmemcache.php 需要进行认证\ndefine('ADMIN_PASSWORD','xxxx');    // 密码\ndefine('DATE_FORMAT','Y/m/d H:i:s');\ndefine('GRAPH_SIZE',200);\ndefine('MAX_ITEM_DUMP',50);\n\n$MEMCACHE_SERVERS[] = '127.0.0.1:11211'; // 加入需要监控的memcached服务器\n//$MEMCACHE_SERVERS[] = '192.168.200.104:11212'; // add more as an array\n```\n\n浏览器访问\n![phpmemcache浏览器访问效果](http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.png?1)\n\n\n### 利用Stats命令查看\n利用stats命令可以查看当前memcached的各种状态\n```\ntelnet 127.0.0.1 11211\nTrying 127.0.0.1...\nConnected to 127.0.0.1.\nEscape character is '^]'.\nstats\nSTAT pid 24732\nSTAT uptime 66597\nSTAT time 1475115983\nSTAT version 1.4.31\nSTAT libevent 2.0.22-stable\nSTAT pointer_size 64\nSTAT rusage_user 6.194421\nSTAT rusage_system 2.419890\nSTAT curr_connections 10\nSTAT total_connections 16\nSTAT connection_structures 11\nSTAT reserved_fds 20\nSTAT cmd_get 5\nSTAT cmd_set 8\nSTAT cmd_flush 0\nSTAT cmd_touch 0\nSTAT get_hits 4\nSTAT get_misses 1\nSTAT get_expired 0\nSTAT get_flushed 0\nSTAT delete_misses 0\nSTAT delete_hits 2\nSTAT incr_misses 0\nSTAT incr_hits 0\nSTAT decr_misses 0\nSTAT decr_hits 0\nSTAT cas_misses 0\nSTAT cas_hits 0\nSTAT cas_badval 0\nSTAT touch_hits 0\nSTAT touch_misses 0\nSTAT auth_cmds 0\nSTAT auth_errors 0\nSTAT bytes_read 3850\nSTAT bytes_written 293\nSTAT limit_maxbytes 134217728\nSTAT accepting_conns 1\nSTAT listen_disabled_num 0\nSTAT time_in_listen_disabled_us 0\nSTAT threads 4\nSTAT conn_yields 0\nSTAT hash_power_level 16\nSTAT hash_bytes 524288\nSTAT hash_is_expanding 0\nSTAT malloc_fails 0\nSTAT log_worker_dropped 0\nSTAT log_worker_written 0\nSTAT log_watcher_skipped 0\nSTAT log_watcher_sent 0\nSTAT bytes 0\nSTAT curr_items 0\nSTAT total_items 6\nSTAT expired_unfetched 0\nSTAT evicted_unfetched 0\nSTAT evictions 0\nSTAT reclaimed 2\nSTAT crawler_reclaimed 0\nSTAT crawler_items_checked 0\nSTAT lrutail_reflocked 0\nEND\n```\n\nStats详解\n\n选项| 说明\n---|-----\npid |memcache服务器的进程ID\nuptime |服务器已经运行的秒数\ntime |服务器当前的unix时间戳\nversion |memcache版本\npointer_size |当前操作系统的指针大小（32位系统一般是32bit）\nrusage_user |进程的累计用户时间\nrusage_system |进程的累计系统时间\ncurr_items |服务器当前存储的items数量\ntotal_items |从服务器启动以后存储的items总数量\nbytes |当前服务器存储items占用的字节数\ncurr_connections|当前打开着的连接数\ntotal_connections |从服务器启动以后曾经打开过的连接数\nconnection_structures |服务器分配的连接构造数\ncmd_get |get命令（获取）总请求次数\ncmd_set |set命令（保存）总请求次数\nget_hits |总命中次数\nget_misses |总未命中次数\nevictions |为获取空闲内存而删除的items数（分配给memcache的空间用满后需要删除旧的items来得到空间分配给新的items）\nbytes_read|总读取字节数（请求字节数）\nbytes_written|总发送字节数（结果字节数）\nlimit_maxbytes|分配给memcache的内存大小（字节）\nthreads|当前线程数\n\n\n### 利用各种监控软件查看（例如：nagios监控memcache的插件）\n> 只以命中率大于和小于为例两种状态。\n\n```\nvim check_memcache\n```\n```bash\n#!/bin/sh\nif [ $# -ne 1 ]\nthen\necho \"Usage:$0 -c num2\"\nexit 0\nfi\ncmd_get=`/usr/local/nagios/libexec/check_tcp -H localhost -p 11211 -E -s 'stats\\r\\nquit\\r\\n' -e 'uptime' |grep cmd_get | awk '{print $3+0}'`\nget_hits=`/usr/local/nagios/libexec/check_tcp -H localhost -p 11211 -E -s 'stats\\r\\nquit\\r\\n' -e 'uptime' |grep get_hits | awk '{print $3+0}'`\nhit_rate=`echo \"$get_hits*100/$cmd_get\"|bc`\nif [ $hit_rate -gt $1 ];then\necho \"OK - hit rate is $hit_rate | hit_rate=$hit_rate; cmd_get=$cmd_get; get_hits=$get_hits\"\nexit 0\nelse\necho \"CRITICAL - hit rate is $hit_rate | hit_rate=$hit_rate; cmd_get=$cmd_get; get_hits=$get_hits\"\nexit 2\nfi\n```\n\n测试命中率大于80%为正常为例;\n```\neg：\nsh check_memcache 80\nroot@ip-10-250-114-95:/liang# sh check_memcache 80\nOK - hit rate is 99 | hit_rate=99; cmd_get=142547; get_hits=141880\n```\n以上证明命中率99%，即状态为OK.\n","slug":"memcache高速缓存的工作原理及应用小结","published":1,"updated":"2016-09-30T02:32:21.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxl0048699fzwfhl4zu","content":"<p>Memcached,是高性能的分布式内存缓存服务器，主要功能就是通过缓存数据库的查询，减少对数据库的访问次数，来提高动态web应用的速度和可扩展性。</p>\n<p>memcached 是以守护程序方法运行于一个或多个服务器中，随时接受客户端的连接操作，客户端可以由各种语言编写，目前一致的客户端api包括 Perl / PHP / Python / Java / C# / C 等等。客户端在与 memcached 服务建立连接之后，接下来的事情就是存取对象了， 每个被存取的对象都有一个唯一的标识符 key，存取操作均通过这个 key进行，保存到 memcached 中的对象实际上是放置内存中的，并不是保存在平时的 cache 文件中的，这也是为什么 memcached 能够如此高效快速的原因。</p>\n<p>注意，这些对象并不是持久的， 服务停止之后， 里边的数据就会丢失。</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160929/MemcacheYingYongMoXing.png?1\" alt=\"Memcached应用模型\"></p>\n<a id=\"more\"></a>\n<h2 id=\"Memcached的安装\"><a href=\"#Memcached的安装\" class=\"headerlink\" title=\"Memcached的安装\"></a>Memcached的安装</h2><h3 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h3><p>libevent</p>\n<blockquote>\n<p>Libevent 是一个用C语言编写的、轻量级的开源高性能网络库。<br>主要有以下几个亮点：事件驱动（ event-driven），高性能;轻量级，专注于网络，不如 ACE 那么臃肿庞大；源代码相当精炼、易读；跨平台，支持 Windows、 Linux、 BSD 和 Mac Os；支持多种 I/O 多路复用技术， epoll、 poll、 dev/poll、 select 和 kqueue 等；支持 I/O，定时器和信号等事件；注册事件优先级。<br>Libevent 已经被广泛的应用，作为底层的网络库；比如 memcached、 Vomit、 Nylon、 Netchat等等。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160929/libevent-2.0.22-stable.tar</div><div class=\"line\">tar -vxf libevent-2.0.22-stable.tar</div><div class=\"line\">cd libevent-2.0.22-stable</div><div class=\"line\">./configure --prefix=/usr/local/libevent</div><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160930/memcached-1.4.31.tar.gz</div><div class=\"line\">cd memcached-1.4.31</div><div class=\"line\"> ./configure --prefix=/usr/local/memcached --with-libevent=/usr/local/libevent</div><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<p>查看是否已经安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/memcached/</div><div class=\"line\">ll</div><div class=\"line\">drwxr-xr-x 2 root root 4096 9月  28 10:56 bin</div><div class=\"line\">drwxr-xr-x 3 root root 4096 9月  28 10:56 include</div><div class=\"line\">drwxr-xr-x 3 root root 4096 9月  28 10:56 share</div></pre></td></tr></table></figure></p>\n<h2 id=\"Memcached管理\"><a href=\"#Memcached管理\" class=\"headerlink\" title=\"Memcached管理\"></a>Memcached管理</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><p>启动Memcached服务器<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div></pre></td></tr></table></figure></p>\n<p>查看是否启动成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux | grep memcache</div><div class=\"line\">root     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:00 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class=\"line\">root     24436  0.0  0.0 112664   984 pts/0    D+   11:00   0:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">netstat -tlun | grep 11211</div><div class=\"line\">tcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN</div><div class=\"line\">tcp6       0      0 :::11211                :::*                    LISTEN</div><div class=\"line\">udp        0      0 0.0.0.0:11211           0.0.0.0:*</div><div class=\"line\">udp6       0      0 :::11211                :::*</div></pre></td></tr></table></figure></p>\n<p>设置开机自启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211&quot; &gt;&gt; /etc/rc.d/rc.local</div></pre></td></tr></table></figure></p>\n<p>Memcached启动选项及说明</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-p <num></num></td>\n<td>Memcached监听的TCP端口，要保证该端口号未被占用</td>\n</tr>\n<tr>\n<td>-U <num></num></td>\n<td>指定监听UDP的端口，默认11211，0表示关闭</td>\n</tr>\n<tr>\n<td>-s <file></file></td>\n<td>指定Memcached用于监听的UNIX socket文件</td>\n</tr>\n<tr>\n<td>-A</td>\n<td>enable ascii “shutdown” command</td>\n</tr>\n<tr>\n<td>-a <mask></mask></td>\n<td>设置-s选项指定的UNIX socket文件的权限(默认权限: 0700)</td>\n</tr>\n<tr>\n<td>-l <addr></addr></td>\n<td>监听的服务器IP地址，如果有多个地址的话，使用逗号分隔，格式可以为“IP地址:端口号”，例如：-l 指定192.168.0.184:19830,192.168.0.195:13542；端口号也可以通过-p选项指定</td>\n</tr>\n<tr>\n<td>-d</td>\n<td>指定memcached进程作为一个守护进程启动</td>\n</tr>\n<tr>\n<td>-r</td>\n<td>设置产生core文件大小</td>\n</tr>\n<tr>\n<td>-u <username></username></td>\n<td>运行memcached的用户 (only when run as root)</td>\n</tr>\n<tr>\n<td>-m <num></num></td>\n<td>指定分配给memcached使用的内存，单位是MB(默认: 64 MB)</td>\n</tr>\n<tr>\n<td>-M</td>\n<td>当内存使用超出配置值时，禁止自动清除缓存中的数据项，此时Memcached不可用，直到内存被释放</td>\n</tr>\n<tr>\n<td>-c <num></num></td>\n<td>设置最大运行的并发连接数，默认是1024</td>\n</tr>\n<tr>\n<td>-k</td>\n<td>设置锁定所有分页的内存，对于大缓存应用场景，谨慎使用该选项</td>\n</tr>\n<tr>\n<td>-v</td>\n<td>输出警告和错误信息</td>\n</tr>\n<tr>\n<td>-vv</td>\n<td>打印信息比-v更详细：不仅输出警告和错误信息，也输出客户端请求和响应信息</td>\n</tr>\n<tr>\n<td>-vvv</td>\n<td>extremely verbose (also print internal state transitions)</td>\n</tr>\n<tr>\n<td>-h</td>\n<td>显示Memcached版本和摘要信息</td>\n</tr>\n<tr>\n<td>-i</td>\n<td>打印libevent和Memcached的licenses信息</td>\n</tr>\n<tr>\n<td>-V</td>\n<td>输出Memcached版本号</td>\n</tr>\n<tr>\n<td>-P <file></file></td>\n<td>保存memcached进程的pid文件，（与 -d 一起搭配使用）</td>\n</tr>\n<tr>\n<td>-f <factor></factor></td>\n<td>用于计算缓存数据项的内存块大小的乘数因子，默认是1.25</td>\n</tr>\n<tr>\n<td>-n <bytes></bytes></td>\n<td>为缓存数据项的key、value、flag设置最小分配字节数，默认是48</td>\n</tr>\n<tr>\n<td>-L</td>\n<td>尝试使用大内存分页（pages）</td>\n</tr>\n<tr>\n<td>-D <char></char></td>\n<td>用于统计报告中Key前缀和ID之间的分隔符，默认是冒号“:”  </td>\n</tr>\n<tr>\n<td>-t <num></num></td>\n<td>指定用来处理请求的线程数，默认为4</td>\n</tr>\n<tr>\n<td>-R</td>\n<td>为避免客户端饿死（starvation），对连续达到的客户端请求数设置一个限额，如果超过该设置，会选择另一个连接来处理请求，默认为20</td>\n</tr>\n<tr>\n<td>-C</td>\n<td>禁用CAS</td>\n</tr>\n<tr>\n<td>-b <num></num></td>\n<td>Set the backlog queue limit (default: 1024)</td>\n</tr>\n<tr>\n<td>-B</td>\n<td>指定使用的协议，默认行为是自动协商（autonegotiate），可能使用的选项有auto、ascii、binary。</td>\n</tr>\n<tr>\n<td>-I</td>\n<td>Override the size of each slab page. Adjusts max item size(default: 1mb, min: 1k, max: 128m)</td>\n</tr>\n<tr>\n<td>-F</td>\n<td>禁用flush_all命令</td>\n</tr>\n<tr>\n<td>-o</td>\n<td>指定逗号分隔的选项，一般用于用于扩展或实验性质的选项</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"通过telnet连接使用Memcache\"><a href=\"#通过telnet连接使用Memcache\" class=\"headerlink\" title=\"通过telnet连接使用Memcache\"></a>通过telnet连接使用Memcache</h3><p>连接<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">telnet 127.0.0.1 11211</div></pre></td></tr></table></figure></p>\n<p>命令格式：<command name=\"\"> <key> <flags> <exptime> <bytes>\\r\\n <data block=\"\">\\r\\n</data></bytes></exptime></flags></key></p>\n<blockquote>\n<p><command name=\"\"> 可以是”set”, “add”, “replace”</p>\n<p><key> 客户端需要保存数据的key。</key></p>\n<p><flags> 是一个16位的无符号的整数(以十进制的方式表示)。</flags></p>\n<p><exptime> 过期的时间。<br>最后客户端需要加上”\\r\\n”作为”命令头”的结束标志。即回车</exptime></p>\n</blockquote>\n<p>示例：</p>\n<p>保存一个数据（保存一个『cache_key1=&gt;12345』的键值对到memcached 60s）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">set cache_key1 0 60 5</div><div class=\"line\">12345</div><div class=\"line\">STORED</div></pre></td></tr></table></figure></p>\n<p>获取刚保存的值<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">get cache_key1</div><div class=\"line\">VALUE cache_key1 0 5</div><div class=\"line\">12345</div><div class=\"line\">END</div></pre></td></tr></table></figure></p>\n<p>其他命令：</p>\n<table>\n<thead>\n<tr>\n<th>Command</th>\n<th>Description</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>get</td>\n<td>获取值</td>\n<td>get mykey</td>\n</tr>\n<tr>\n<td>set</td>\n<td>设置值（可以存在可以不存在）</td>\n<td>set mykey 0 60 5</td>\n</tr>\n<tr>\n<td>add</td>\n<td>添加新值</td>\n<td>add newkey 0 60 5</td>\n</tr>\n<tr>\n<td>replace</td>\n<td>替换值（必须已存在）</td>\n<td>replace key 0 60 5</td>\n</tr>\n<tr>\n<td>append</td>\n<td>在原有值之后添加数据</td>\n<td>append key 0 60 15</td>\n</tr>\n<tr>\n<td>prepend</td>\n<td>在原有值之前添加数据</td>\n<td>prepend key 0 60 15</td>\n</tr>\n<tr>\n<td>incr</td>\n<td>Increments numerical key value by given number</td>\n<td>incr mykey 2</td>\n</tr>\n<tr>\n<td>decr</td>\n<td>Decrements numerical key value by given number</td>\n<td>decr mykey 5</td>\n</tr>\n<tr>\n<td>delete</td>\n<td>删除一条数据</td>\n<td>delete mykey</td>\n</tr>\n<tr>\n<td>flush_all</td>\n<td>清除所有数据</td>\n<td>flush_all</td>\n</tr>\n<tr>\n<td></td>\n<td>清除900秒之内的数据</td>\n<td>flush_all 900</td>\n</tr>\n<tr>\n<td>stats</td>\n<td>查看所有状态</td>\n<td>stats</td>\n</tr>\n<tr>\n<td></td>\n<td>Prints memory statistics</td>\n<td>stats slabs</td>\n</tr>\n<tr>\n<td></td>\n<td>Prints memory statistics</td>\n<td>stats malloc</td>\n</tr>\n<tr>\n<td></td>\n<td>Print higher level allocation statistics</td>\n<td>stats items</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>stats detail</td>\n</tr>\n<tr>\n<td></td>\n<td>已使用大小</td>\n<td>stats sizes</td>\n</tr>\n<tr>\n<td></td>\n<td>重置状态</td>\n<td>stats reset</td>\n</tr>\n<tr>\n<td>version</td>\n<td>查看版本</td>\n<td>version</td>\n</tr>\n<tr>\n<td>verbosity</td>\n<td>Increases log level</td>\n<td>verbosity</td>\n</tr>\n<tr>\n<td>quit</td>\n<td>退出telnet连接</td>\n<td>quit</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"通过客户端（PHP）连接和使用Memcached\"><a href=\"#通过客户端（PHP）连接和使用Memcached\" class=\"headerlink\" title=\"通过客户端（PHP）连接和使用Memcached\"></a>通过客户端（PHP）连接和使用Memcached</h3><p>php扩展Memcached安装</p>\n<p>依赖</p>\n<blockquote>\n<p>libmemcached, 是一个 memcached 的库，客户端库，C 和 C++ 语言实现的客户端库，具有低内存占用率、线程安全、并提供对memcached功能的全面支持。它还采用 多种命令行工具： memcat ， memflush ， memrm ， memstat ，并memslap （负载代）。程序库一直在设计，让不同的散列方法对密钥，分割的钥匙，并使用统一的散列分配。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget https://launchpadlibrarian.net/165454254/libmemcached-1.0.18.tar.gz</div><div class=\"line\">tar -zxvf libmemcached-1.0.18.tar.gz</div><div class=\"line\">cd libmemcached-1.0.18</div><div class=\"line\">./configure --prefix=/usr/local/libmemcached</div><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<p>安装扩展<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160929/memcached-2.2.0.tar</div><div class=\"line\">tar -xvf memcached-2.2.0.tar</div><div class=\"line\">cd memcached-2.2.0</div><div class=\"line\">/usr/local/php56/bin/phpize</div><div class=\"line\">./configure --with-php-config=/usr/local/php56/bin/php-config --with-libmemcached-dir=/usr/local/libmemcached  --enable-memcached --disable-memcached-sasl</div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div></pre></td></tr></table></figure></p>\n<p>查看是否安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">ll</div><div class=\"line\">-rwxr-xr-x 1 root root  380475 9月  28 22:25 memcached.so</div><div class=\"line\">-rwxr-xr-x 1 root root  756714 9月  26 17:32 mysqli.so</div><div class=\"line\">-rwxr-xr-x 1 root root 1333912 9月  24 23:31 opcache.a</div><div class=\"line\">-rwxr-xr-x 1 root root  618435 9月  24 23:31 opcache.so</div></pre></td></tr></table></figure></p>\n<p>修改配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/lib/php.ini</div><div class=\"line\">extension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/memcached.so</div></pre></td></tr></table></figure></p>\n<p>重启php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<p>查看是否已经加载成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php56/bin/php -m</div><div class=\"line\">或通过phpinfo();查看</div></pre></td></tr></table></figure></p>\n<p>测试<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi memcache_test.php</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">        $mc = <span class=\"keyword\">new</span> Memcached();</div><div class=\"line\">        var_dump($mc);</div><div class=\"line\">        $mc-&gt;addServer(<span class=\"string\">'127.0.0.1'</span>, <span class=\"number\">11211</span>);</div><div class=\"line\">        $mc-&gt;set(<span class=\"string\">'cache_key'</span>,<span class=\"string\">'mem_value'</span>,<span class=\"number\">30</span>);</div><div class=\"line\">        $val = $mc-&gt;get(<span class=\"string\">'cache_key'</span>);</div><div class=\"line\">        var_dump($val);</div><div class=\"line\">        var_dump($mc-&gt;delete(<span class=\"string\">'cache_key'</span>));</div><div class=\"line\">        $mc-&gt;quit();</div></pre></td></tr></table></figure>\n<p>访问结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">object(Memcached)#1 (0) &#123; &#125; string(9) &quot;mem_value&quot; bool(true)</div></pre></td></tr></table></figure></p>\n<p>php关于memcached 的两种扩展memcache 和 memcached 介绍</p>\n<ol>\n<li><p>目前大多数php环境里使用的都是不带d的memcache版本，这个版本出的比较早，是一个原生版本，完全在php框架内开发的。与之对应的带d的memcached是建立在libmemcached的基础上，所以相对来说，memcached版本的功能更全一些。</p>\n<blockquote>\n<p><a href=\"http://cn2.php.net/manual/en/book.memcache.php\" target=\"_blank\" rel=\"external\">memcache:</a></p>\n<p><a href=\"http://cn2.php.net/manual/en/book.memcached.php\" target=\"_blank\" rel=\"external\">memcached:</a></p>\n</blockquote>\n</li>\n<li><p>Memcache是原生实现的，支持OO和非OO两套接口并存。而memcached是使用libmemcached，只支持OO接口。</p>\n</li>\n<li>memcached有了一个统一的setOption()来设置设置，而不用在操作的时候设置了。Memcached实现了更多的memcached协议。</li>\n<li>memcached支持Binary Protocol，而memcache不支持。这意味着memcached会有更高的性能。不过memcached目前还不支持长连接。</li>\n<li>另外一点也是大家比较关心的，就是所使用的算法。“一致性hash算法”是当添加或删除存储节点时，对存储在memcached上的数据影响较小的一种算法。在php的两个扩展库中，都可以使用该算法，只是设置方法有所不同。</li>\n</ol>\n<ul>\n<li>Memcache</li>\n</ul>\n<p>修改php.ini添加：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[Memcache]</div><div class=\"line\">Memcache.allow_failover = 1</div><div class=\"line\">Memcache.hash_strategy =consistent</div><div class=\"line\">Memcache.hash_function =crc32</div></pre></td></tr></table></figure></p>\n<p>或在php中使用ini_set方法：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ini_set(‘memcache.hash_strategy&apos;,&apos;standard&apos;);</div><div class=\"line\">ini_set(‘memcache.hash_function&apos;,&apos;crc32&apos;);</div></pre></td></tr></table></figure></p>\n<ul>\n<li>Memcached</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$mem = new memcached();</div><div class=\"line\">$mem-&gt;setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);</div><div class=\"line\">$mem-&gt;setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);</div></pre></td></tr></table></figure>\n<h2 id=\"Memcached监控\"><a href=\"#Memcached监控\" class=\"headerlink\" title=\"Memcached监控\"></a>Memcached监控</h2><h3 id=\"利用phpmemcache-php图形监控工具\"><a href=\"#利用phpmemcache-php图形监控工具\" class=\"headerlink\" title=\"利用phpmemcache.php图形监控工具\"></a>利用phpmemcache.php图形监控工具</h3><p>下载 phpmemcache.php<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.php</div></pre></td></tr></table></figure></p>\n<p>将phpmemcache.php放入web目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mv phpmemcache.php /usr/local/nginx/html</div></pre></td></tr></table></figure></p>\n<p>修改phpmemcache.php中配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">define(&apos;ADMIN_USERNAME&apos;,&apos;xxxx&apos;);    // 用户名修改，在访问 phpmemcache.php 需要进行认证</div><div class=\"line\">define(&apos;ADMIN_PASSWORD&apos;,&apos;xxxx&apos;);    // 密码</div><div class=\"line\">define(&apos;DATE_FORMAT&apos;,&apos;Y/m/d H:i:s&apos;);</div><div class=\"line\">define(&apos;GRAPH_SIZE&apos;,200);</div><div class=\"line\">define(&apos;MAX_ITEM_DUMP&apos;,50);</div><div class=\"line\"></div><div class=\"line\">$MEMCACHE_SERVERS[] = &apos;127.0.0.1:11211&apos;; // 加入需要监控的memcached服务器</div><div class=\"line\">//$MEMCACHE_SERVERS[] = &apos;192.168.200.104:11212&apos;; // add more as an array</div></pre></td></tr></table></figure></p>\n<p>浏览器访问<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.png?1\" alt=\"phpmemcache浏览器访问效果\"></p>\n<h3 id=\"利用Stats命令查看\"><a href=\"#利用Stats命令查看\" class=\"headerlink\" title=\"利用Stats命令查看\"></a>利用Stats命令查看</h3><p>利用stats命令可以查看当前memcached的各种状态<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div></pre></td><td class=\"code\"><pre><div class=\"line\">telnet 127.0.0.1 11211</div><div class=\"line\">Trying 127.0.0.1...</div><div class=\"line\">Connected to 127.0.0.1.</div><div class=\"line\">Escape character is &apos;^]&apos;.</div><div class=\"line\">stats</div><div class=\"line\">STAT pid 24732</div><div class=\"line\">STAT uptime 66597</div><div class=\"line\">STAT time 1475115983</div><div class=\"line\">STAT version 1.4.31</div><div class=\"line\">STAT libevent 2.0.22-stable</div><div class=\"line\">STAT pointer_size 64</div><div class=\"line\">STAT rusage_user 6.194421</div><div class=\"line\">STAT rusage_system 2.419890</div><div class=\"line\">STAT curr_connections 10</div><div class=\"line\">STAT total_connections 16</div><div class=\"line\">STAT connection_structures 11</div><div class=\"line\">STAT reserved_fds 20</div><div class=\"line\">STAT cmd_get 5</div><div class=\"line\">STAT cmd_set 8</div><div class=\"line\">STAT cmd_flush 0</div><div class=\"line\">STAT cmd_touch 0</div><div class=\"line\">STAT get_hits 4</div><div class=\"line\">STAT get_misses 1</div><div class=\"line\">STAT get_expired 0</div><div class=\"line\">STAT get_flushed 0</div><div class=\"line\">STAT delete_misses 0</div><div class=\"line\">STAT delete_hits 2</div><div class=\"line\">STAT incr_misses 0</div><div class=\"line\">STAT incr_hits 0</div><div class=\"line\">STAT decr_misses 0</div><div class=\"line\">STAT decr_hits 0</div><div class=\"line\">STAT cas_misses 0</div><div class=\"line\">STAT cas_hits 0</div><div class=\"line\">STAT cas_badval 0</div><div class=\"line\">STAT touch_hits 0</div><div class=\"line\">STAT touch_misses 0</div><div class=\"line\">STAT auth_cmds 0</div><div class=\"line\">STAT auth_errors 0</div><div class=\"line\">STAT bytes_read 3850</div><div class=\"line\">STAT bytes_written 293</div><div class=\"line\">STAT limit_maxbytes 134217728</div><div class=\"line\">STAT accepting_conns 1</div><div class=\"line\">STAT listen_disabled_num 0</div><div class=\"line\">STAT time_in_listen_disabled_us 0</div><div class=\"line\">STAT threads 4</div><div class=\"line\">STAT conn_yields 0</div><div class=\"line\">STAT hash_power_level 16</div><div class=\"line\">STAT hash_bytes 524288</div><div class=\"line\">STAT hash_is_expanding 0</div><div class=\"line\">STAT malloc_fails 0</div><div class=\"line\">STAT log_worker_dropped 0</div><div class=\"line\">STAT log_worker_written 0</div><div class=\"line\">STAT log_watcher_skipped 0</div><div class=\"line\">STAT log_watcher_sent 0</div><div class=\"line\">STAT bytes 0</div><div class=\"line\">STAT curr_items 0</div><div class=\"line\">STAT total_items 6</div><div class=\"line\">STAT expired_unfetched 0</div><div class=\"line\">STAT evicted_unfetched 0</div><div class=\"line\">STAT evictions 0</div><div class=\"line\">STAT reclaimed 2</div><div class=\"line\">STAT crawler_reclaimed 0</div><div class=\"line\">STAT crawler_items_checked 0</div><div class=\"line\">STAT lrutail_reflocked 0</div><div class=\"line\">END</div></pre></td></tr></table></figure></p>\n<p>Stats详解</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pid</td>\n<td>memcache服务器的进程ID</td>\n</tr>\n<tr>\n<td>uptime</td>\n<td>服务器已经运行的秒数</td>\n</tr>\n<tr>\n<td>time</td>\n<td>服务器当前的unix时间戳</td>\n</tr>\n<tr>\n<td>version</td>\n<td>memcache版本</td>\n</tr>\n<tr>\n<td>pointer_size</td>\n<td>当前操作系统的指针大小（32位系统一般是32bit）</td>\n</tr>\n<tr>\n<td>rusage_user</td>\n<td>进程的累计用户时间</td>\n</tr>\n<tr>\n<td>rusage_system</td>\n<td>进程的累计系统时间</td>\n</tr>\n<tr>\n<td>curr_items</td>\n<td>服务器当前存储的items数量</td>\n</tr>\n<tr>\n<td>total_items</td>\n<td>从服务器启动以后存储的items总数量</td>\n</tr>\n<tr>\n<td>bytes</td>\n<td>当前服务器存储items占用的字节数</td>\n</tr>\n<tr>\n<td>curr_connections</td>\n<td>当前打开着的连接数</td>\n</tr>\n<tr>\n<td>total_connections</td>\n<td>从服务器启动以后曾经打开过的连接数</td>\n</tr>\n<tr>\n<td>connection_structures</td>\n<td>服务器分配的连接构造数</td>\n</tr>\n<tr>\n<td>cmd_get</td>\n<td>get命令（获取）总请求次数</td>\n</tr>\n<tr>\n<td>cmd_set</td>\n<td>set命令（保存）总请求次数</td>\n</tr>\n<tr>\n<td>get_hits</td>\n<td>总命中次数</td>\n</tr>\n<tr>\n<td>get_misses</td>\n<td>总未命中次数</td>\n</tr>\n<tr>\n<td>evictions</td>\n<td>为获取空闲内存而删除的items数（分配给memcache的空间用满后需要删除旧的items来得到空间分配给新的items）</td>\n</tr>\n<tr>\n<td>bytes_read</td>\n<td>总读取字节数（请求字节数）</td>\n</tr>\n<tr>\n<td>bytes_written</td>\n<td>总发送字节数（结果字节数）</td>\n</tr>\n<tr>\n<td>limit_maxbytes</td>\n<td>分配给memcache的内存大小（字节）</td>\n</tr>\n<tr>\n<td>threads</td>\n<td>当前线程数</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"利用各种监控软件查看（例如：nagios监控memcache的插件）\"><a href=\"#利用各种监控软件查看（例如：nagios监控memcache的插件）\" class=\"headerlink\" title=\"利用各种监控软件查看（例如：nagios监控memcache的插件）\"></a>利用各种监控软件查看（例如：nagios监控memcache的插件）</h3><blockquote>\n<p>只以命中率大于和小于为例两种状态。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vim check_memcache</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#!/bin/sh</span></div><div class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$#</span> <span class=\"_\">-ne</span> 1 ]</div><div class=\"line\"><span class=\"keyword\">then</span></div><div class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Usage:<span class=\"variable\">$0</span> -c num2\"</span></div><div class=\"line\"><span class=\"built_in\">exit</span> 0</div><div class=\"line\"><span class=\"keyword\">fi</span></div><div class=\"line\">cmd_get=`/usr/<span class=\"built_in\">local</span>/nagios/libexec/check_tcp -H localhost -p 11211 -E <span class=\"_\">-s</span> <span class=\"string\">'stats\\r\\nquit\\r\\n'</span> <span class=\"_\">-e</span> <span class=\"string\">'uptime'</span> |grep cmd_get | awk <span class=\"string\">'&#123;print $3+0&#125;'</span>`</div><div class=\"line\">get_hits=`/usr/<span class=\"built_in\">local</span>/nagios/libexec/check_tcp -H localhost -p 11211 -E <span class=\"_\">-s</span> <span class=\"string\">'stats\\r\\nquit\\r\\n'</span> <span class=\"_\">-e</span> <span class=\"string\">'uptime'</span> |grep get_hits | awk <span class=\"string\">'&#123;print $3+0&#125;'</span>`</div><div class=\"line\">hit_rate=`<span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$get_hits</span>*100/<span class=\"variable\">$cmd_get</span>\"</span>|bc`</div><div class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$hit_rate</span> <span class=\"_\">-gt</span> <span class=\"variable\">$1</span> ];<span class=\"keyword\">then</span></div><div class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"OK - hit rate is <span class=\"variable\">$hit_rate</span> | hit_rate=<span class=\"variable\">$hit_rate</span>; cmd_get=<span class=\"variable\">$cmd_get</span>; get_hits=<span class=\"variable\">$get_hits</span>\"</span></div><div class=\"line\"><span class=\"built_in\">exit</span> 0</div><div class=\"line\"><span class=\"keyword\">else</span></div><div class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"CRITICAL - hit rate is <span class=\"variable\">$hit_rate</span> | hit_rate=<span class=\"variable\">$hit_rate</span>; cmd_get=<span class=\"variable\">$cmd_get</span>; get_hits=<span class=\"variable\">$get_hits</span>\"</span></div><div class=\"line\"><span class=\"built_in\">exit</span> 2</div><div class=\"line\"><span class=\"keyword\">fi</span></div></pre></td></tr></table></figure>\n<p>测试命中率大于80%为正常为例;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">eg：</div><div class=\"line\">sh check_memcache 80</div><div class=\"line\">root@ip-10-250-114-95:/liang# sh check_memcache 80</div><div class=\"line\">OK - hit rate is 99 | hit_rate=99; cmd_get=142547; get_hits=141880</div></pre></td></tr></table></figure></p>\n<p>以上证明命中率99%，即状态为OK.</p>\n","excerpt":"<p>Memcached,是高性能的分布式内存缓存服务器，主要功能就是通过缓存数据库的查询，减少对数据库的访问次数，来提高动态web应用的速度和可扩展性。</p>\n<p>memcached 是以守护程序方法运行于一个或多个服务器中，随时接受客户端的连接操作，客户端可以由各种语言编写，目前一致的客户端api包括 Perl / PHP / Python / Java / C# / C 等等。客户端在与 memcached 服务建立连接之后，接下来的事情就是存取对象了， 每个被存取的对象都有一个唯一的标识符 key，存取操作均通过这个 key进行，保存到 memcached 中的对象实际上是放置内存中的，并不是保存在平时的 cache 文件中的，这也是为什么 memcached 能够如此高效快速的原因。</p>\n<p>注意，这些对象并不是持久的， 服务停止之后， 里边的数据就会丢失。</p>\n<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160929/MemcacheYingYongMoXing.png?1\" alt=\"Memcached应用模型\"></p>","more":"<h2 id=\"Memcached的安装\"><a href=\"#Memcached的安装\" class=\"headerlink\" title=\"Memcached的安装\"></a>Memcached的安装</h2><h3 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h3><p>libevent</p>\n<blockquote>\n<p>Libevent 是一个用C语言编写的、轻量级的开源高性能网络库。<br>主要有以下几个亮点：事件驱动（ event-driven），高性能;轻量级，专注于网络，不如 ACE 那么臃肿庞大；源代码相当精炼、易读；跨平台，支持 Windows、 Linux、 BSD 和 Mac Os；支持多种 I/O 多路复用技术， epoll、 poll、 dev/poll、 select 和 kqueue 等；支持 I/O，定时器和信号等事件；注册事件优先级。<br>Libevent 已经被广泛的应用，作为底层的网络库；比如 memcached、 Vomit、 Nylon、 Netchat等等。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160929/libevent-2.0.22-stable.tar</div><div class=\"line\">tar -vxf libevent-2.0.22-stable.tar</div><div class=\"line\">cd libevent-2.0.22-stable</div><div class=\"line\">./configure --prefix=/usr/local/libevent</div><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<h3 id=\"安装\"><a href=\"#安装\" class=\"headerlink\" title=\"安装\"></a>安装</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160930/memcached-1.4.31.tar.gz</div><div class=\"line\">cd memcached-1.4.31</div><div class=\"line\"> ./configure --prefix=/usr/local/memcached --with-libevent=/usr/local/libevent</div><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<p>查看是否已经安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/memcached/</div><div class=\"line\">ll</div><div class=\"line\">drwxr-xr-x 2 root root 4096 9月  28 10:56 bin</div><div class=\"line\">drwxr-xr-x 3 root root 4096 9月  28 10:56 include</div><div class=\"line\">drwxr-xr-x 3 root root 4096 9月  28 10:56 share</div></pre></td></tr></table></figure></p>\n<h2 id=\"Memcached管理\"><a href=\"#Memcached管理\" class=\"headerlink\" title=\"Memcached管理\"></a>Memcached管理</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><p>启动Memcached服务器<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div></pre></td></tr></table></figure></p>\n<p>查看是否启动成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux | grep memcache</div><div class=\"line\">root     24428  0.0  0.0 323120   864 ?        Ssl  11:00   0:00 /usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211</div><div class=\"line\">root     24436  0.0  0.0 112664   984 pts/0    D+   11:00   0:00 grep --color=auto memcache</div></pre></td></tr></table></figure></p>\n<p>或<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">netstat -tlun | grep 11211</div><div class=\"line\">tcp        0      0 0.0.0.0:11211           0.0.0.0:*               LISTEN</div><div class=\"line\">tcp6       0      0 :::11211                :::*                    LISTEN</div><div class=\"line\">udp        0      0 0.0.0.0:11211           0.0.0.0:*</div><div class=\"line\">udp6       0      0 :::11211                :::*</div></pre></td></tr></table></figure></p>\n<p>设置开机自启动<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;/usr/local/memcached/bin/memcached -d -m 128 -u root -p 11211&quot; &gt;&gt; /etc/rc.d/rc.local</div></pre></td></tr></table></figure></p>\n<p>Memcached启动选项及说明</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>-p <num></td>\n<td>Memcached监听的TCP端口，要保证该端口号未被占用</td>\n</tr>\n<tr>\n<td>-U <num></td>\n<td>指定监听UDP的端口，默认11211，0表示关闭</td>\n</tr>\n<tr>\n<td>-s <file></td>\n<td>指定Memcached用于监听的UNIX socket文件</td>\n</tr>\n<tr>\n<td>-A</td>\n<td>enable ascii “shutdown” command</td>\n</tr>\n<tr>\n<td>-a <mask></td>\n<td>设置-s选项指定的UNIX socket文件的权限(默认权限: 0700)</td>\n</tr>\n<tr>\n<td>-l <addr></td>\n<td>监听的服务器IP地址，如果有多个地址的话，使用逗号分隔，格式可以为“IP地址:端口号”，例如：-l 指定192.168.0.184:19830,192.168.0.195:13542；端口号也可以通过-p选项指定</td>\n</tr>\n<tr>\n<td>-d</td>\n<td>指定memcached进程作为一个守护进程启动</td>\n</tr>\n<tr>\n<td>-r</td>\n<td>设置产生core文件大小</td>\n</tr>\n<tr>\n<td>-u <username></td>\n<td>运行memcached的用户 (only when run as root)</td>\n</tr>\n<tr>\n<td>-m <num></td>\n<td>指定分配给memcached使用的内存，单位是MB(默认: 64 MB)</td>\n</tr>\n<tr>\n<td>-M</td>\n<td>当内存使用超出配置值时，禁止自动清除缓存中的数据项，此时Memcached不可用，直到内存被释放</td>\n</tr>\n<tr>\n<td>-c <num></td>\n<td>设置最大运行的并发连接数，默认是1024</td>\n</tr>\n<tr>\n<td>-k</td>\n<td>设置锁定所有分页的内存，对于大缓存应用场景，谨慎使用该选项</td>\n</tr>\n<tr>\n<td>-v</td>\n<td>输出警告和错误信息</td>\n</tr>\n<tr>\n<td>-vv</td>\n<td>打印信息比-v更详细：不仅输出警告和错误信息，也输出客户端请求和响应信息</td>\n</tr>\n<tr>\n<td>-vvv</td>\n<td>extremely verbose (also print internal state transitions)</td>\n</tr>\n<tr>\n<td>-h</td>\n<td>显示Memcached版本和摘要信息</td>\n</tr>\n<tr>\n<td>-i</td>\n<td>打印libevent和Memcached的licenses信息</td>\n</tr>\n<tr>\n<td>-V</td>\n<td>输出Memcached版本号</td>\n</tr>\n<tr>\n<td>-P <file></td>\n<td>保存memcached进程的pid文件，（与 -d 一起搭配使用）</td>\n</tr>\n<tr>\n<td>-f <factor></td>\n<td>用于计算缓存数据项的内存块大小的乘数因子，默认是1.25</td>\n</tr>\n<tr>\n<td>-n <bytes></td>\n<td>为缓存数据项的key、value、flag设置最小分配字节数，默认是48</td>\n</tr>\n<tr>\n<td>-L</td>\n<td>尝试使用大内存分页（pages）</td>\n</tr>\n<tr>\n<td>-D <char></td>\n<td>用于统计报告中Key前缀和ID之间的分隔符，默认是冒号“:”  </td>\n</tr>\n<tr>\n<td>-t <num></td>\n<td>指定用来处理请求的线程数，默认为4</td>\n</tr>\n<tr>\n<td>-R</td>\n<td>为避免客户端饿死（starvation），对连续达到的客户端请求数设置一个限额，如果超过该设置，会选择另一个连接来处理请求，默认为20</td>\n</tr>\n<tr>\n<td>-C</td>\n<td>禁用CAS</td>\n</tr>\n<tr>\n<td>-b <num></td>\n<td>Set the backlog queue limit (default: 1024)</td>\n</tr>\n<tr>\n<td>-B</td>\n<td>指定使用的协议，默认行为是自动协商（autonegotiate），可能使用的选项有auto、ascii、binary。</td>\n</tr>\n<tr>\n<td>-I</td>\n<td>Override the size of each slab page. Adjusts max item size(default: 1mb, min: 1k, max: 128m)</td>\n</tr>\n<tr>\n<td>-F</td>\n<td>禁用flush_all命令</td>\n</tr>\n<tr>\n<td>-o</td>\n<td>指定逗号分隔的选项，一般用于用于扩展或实验性质的选项</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"通过telnet连接使用Memcache\"><a href=\"#通过telnet连接使用Memcache\" class=\"headerlink\" title=\"通过telnet连接使用Memcache\"></a>通过telnet连接使用Memcache</h3><p>连接<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">telnet 127.0.0.1 11211</div></pre></td></tr></table></figure></p>\n<p>命令格式：<command name> <key> <flags> <exptime> <bytes>\\r\\n <data block>\\r\\n</p>\n<blockquote>\n<p><command name> 可以是”set”, “add”, “replace”</p>\n<p><key> 客户端需要保存数据的key。</p>\n<p><flags> 是一个16位的无符号的整数(以十进制的方式表示)。</p>\n<p><exptime> 过期的时间。<br>最后客户端需要加上”\\r\\n”作为”命令头”的结束标志。即回车</p>\n</blockquote>\n<p>示例：</p>\n<p>保存一个数据（保存一个『cache_key1=&gt;12345』的键值对到memcached 60s）<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">set cache_key1 0 60 5</div><div class=\"line\">12345</div><div class=\"line\">STORED</div></pre></td></tr></table></figure></p>\n<p>获取刚保存的值<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">get cache_key1</div><div class=\"line\">VALUE cache_key1 0 5</div><div class=\"line\">12345</div><div class=\"line\">END</div></pre></td></tr></table></figure></p>\n<p>其他命令：</p>\n<table>\n<thead>\n<tr>\n<th>Command</th>\n<th>Description</th>\n<th>Example</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>get</td>\n<td>获取值</td>\n<td>get mykey</td>\n</tr>\n<tr>\n<td>set</td>\n<td>设置值（可以存在可以不存在）</td>\n<td>set mykey 0 60 5</td>\n</tr>\n<tr>\n<td>add</td>\n<td>添加新值</td>\n<td>add newkey 0 60 5</td>\n</tr>\n<tr>\n<td>replace</td>\n<td>替换值（必须已存在）</td>\n<td>replace key 0 60 5</td>\n</tr>\n<tr>\n<td>append</td>\n<td>在原有值之后添加数据</td>\n<td>append key 0 60 15</td>\n</tr>\n<tr>\n<td>prepend</td>\n<td>在原有值之前添加数据</td>\n<td>prepend key 0 60 15</td>\n</tr>\n<tr>\n<td>incr</td>\n<td>Increments numerical key value by given number</td>\n<td>incr mykey 2</td>\n</tr>\n<tr>\n<td>decr</td>\n<td>Decrements numerical key value by given number</td>\n<td>decr mykey 5</td>\n</tr>\n<tr>\n<td>delete</td>\n<td>删除一条数据</td>\n<td>delete mykey</td>\n</tr>\n<tr>\n<td>flush_all</td>\n<td>清除所有数据</td>\n<td>flush_all</td>\n</tr>\n<tr>\n<td></td>\n<td>清除900秒之内的数据</td>\n<td>flush_all 900</td>\n</tr>\n<tr>\n<td>stats</td>\n<td>查看所有状态</td>\n<td>stats</td>\n</tr>\n<tr>\n<td></td>\n<td>Prints memory statistics</td>\n<td>stats slabs</td>\n</tr>\n<tr>\n<td></td>\n<td>Prints memory statistics</td>\n<td>stats malloc</td>\n</tr>\n<tr>\n<td></td>\n<td>Print higher level allocation statistics</td>\n<td>stats items</td>\n</tr>\n<tr>\n<td></td>\n<td></td>\n<td>stats detail</td>\n</tr>\n<tr>\n<td></td>\n<td>已使用大小</td>\n<td>stats sizes</td>\n</tr>\n<tr>\n<td></td>\n<td>重置状态</td>\n<td>stats reset</td>\n</tr>\n<tr>\n<td>version</td>\n<td>查看版本</td>\n<td>version</td>\n</tr>\n<tr>\n<td>verbosity</td>\n<td>Increases log level</td>\n<td>verbosity</td>\n</tr>\n<tr>\n<td>quit</td>\n<td>退出telnet连接</td>\n<td>quit</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"通过客户端（PHP）连接和使用Memcached\"><a href=\"#通过客户端（PHP）连接和使用Memcached\" class=\"headerlink\" title=\"通过客户端（PHP）连接和使用Memcached\"></a>通过客户端（PHP）连接和使用Memcached</h3><p>php扩展Memcached安装</p>\n<p>依赖</p>\n<blockquote>\n<p>libmemcached, 是一个 memcached 的库，客户端库，C 和 C++ 语言实现的客户端库，具有低内存占用率、线程安全、并提供对memcached功能的全面支持。它还采用 多种命令行工具： memcat ， memflush ， memrm ， memstat ，并memslap （负载代）。程序库一直在设计，让不同的散列方法对密钥，分割的钥匙，并使用统一的散列分配。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget https://launchpadlibrarian.net/165454254/libmemcached-1.0.18.tar.gz</div><div class=\"line\">tar -zxvf libmemcached-1.0.18.tar.gz</div><div class=\"line\">cd libmemcached-1.0.18</div><div class=\"line\">./configure --prefix=/usr/local/libmemcached</div><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure>\n<p>安装扩展<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160929/memcached-2.2.0.tar</div><div class=\"line\">tar -xvf memcached-2.2.0.tar</div><div class=\"line\">cd memcached-2.2.0</div><div class=\"line\">/usr/local/php56/bin/phpize</div><div class=\"line\">./configure --with-php-config=/usr/local/php56/bin/php-config --with-libmemcached-dir=/usr/local/libmemcached  --enable-memcached --disable-memcached-sasl</div><div class=\"line\">make &amp;&amp; make install</div><div class=\"line\">Installing shared extensions:     /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div></pre></td></tr></table></figure></p>\n<p>查看是否安装成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd /usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/</div><div class=\"line\">ll</div><div class=\"line\">-rwxr-xr-x 1 root root  380475 9月  28 22:25 memcached.so</div><div class=\"line\">-rwxr-xr-x 1 root root  756714 9月  26 17:32 mysqli.so</div><div class=\"line\">-rwxr-xr-x 1 root root 1333912 9月  24 23:31 opcache.a</div><div class=\"line\">-rwxr-xr-x 1 root root  618435 9月  24 23:31 opcache.so</div></pre></td></tr></table></figure></p>\n<p>修改配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi /usr/local/php56/lib/php.ini</div><div class=\"line\">extension=/usr/local/php56/lib/php/extensions/no-debug-non-zts-20131226/memcached.so</div></pre></td></tr></table></figure></p>\n<p>重启php-fpm<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">kill -USR2 `cat /usr/local/php56/var/run/php-fpm.pid`</div></pre></td></tr></table></figure></p>\n<p>查看是否已经加载成功<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/php56/bin/php -m</div><div class=\"line\">或通过phpinfo();查看</div></pre></td></tr></table></figure></p>\n<p>测试<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vi memcache_test.php</div></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">&lt;?php</span></div><div class=\"line\">        $mc = <span class=\"keyword\">new</span> Memcached();</div><div class=\"line\">        var_dump($mc);</div><div class=\"line\">        $mc-&gt;addServer(<span class=\"string\">'127.0.0.1'</span>, <span class=\"number\">11211</span>);</div><div class=\"line\">        $mc-&gt;set(<span class=\"string\">'cache_key'</span>,<span class=\"string\">'mem_value'</span>,<span class=\"number\">30</span>);</div><div class=\"line\">        $val = $mc-&gt;get(<span class=\"string\">'cache_key'</span>);</div><div class=\"line\">        var_dump($val);</div><div class=\"line\">        var_dump($mc-&gt;delete(<span class=\"string\">'cache_key'</span>));</div><div class=\"line\">        $mc-&gt;quit();</div></pre></td></tr></table></figure>\n<p>访问结果：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">object(Memcached)#1 (0) &#123; &#125; string(9) &quot;mem_value&quot; bool(true)</div></pre></td></tr></table></figure></p>\n<p>php关于memcached 的两种扩展memcache 和 memcached 介绍</p>\n<ol>\n<li><p>目前大多数php环境里使用的都是不带d的memcache版本，这个版本出的比较早，是一个原生版本，完全在php框架内开发的。与之对应的带d的memcached是建立在libmemcached的基础上，所以相对来说，memcached版本的功能更全一些。</p>\n<blockquote>\n<p><a href=\"http://cn2.php.net/manual/en/book.memcache.php\">memcache:</a></p>\n<p><a href=\"http://cn2.php.net/manual/en/book.memcached.php\">memcached:</a></p>\n</blockquote>\n</li>\n<li><p>Memcache是原生实现的，支持OO和非OO两套接口并存。而memcached是使用libmemcached，只支持OO接口。</p>\n</li>\n<li>memcached有了一个统一的setOption()来设置设置，而不用在操作的时候设置了。Memcached实现了更多的memcached协议。</li>\n<li>memcached支持Binary Protocol，而memcache不支持。这意味着memcached会有更高的性能。不过memcached目前还不支持长连接。</li>\n<li>另外一点也是大家比较关心的，就是所使用的算法。“一致性hash算法”是当添加或删除存储节点时，对存储在memcached上的数据影响较小的一种算法。在php的两个扩展库中，都可以使用该算法，只是设置方法有所不同。</li>\n</ol>\n<ul>\n<li>Memcache</li>\n</ul>\n<p>修改php.ini添加：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">[Memcache]</div><div class=\"line\">Memcache.allow_failover = 1</div><div class=\"line\">Memcache.hash_strategy =consistent</div><div class=\"line\">Memcache.hash_function =crc32</div></pre></td></tr></table></figure></p>\n<p>或在php中使用ini_set方法：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">ini_set(‘memcache.hash_strategy&apos;,&apos;standard&apos;);</div><div class=\"line\">ini_set(‘memcache.hash_function&apos;,&apos;crc32&apos;);</div></pre></td></tr></table></figure></p>\n<ul>\n<li>Memcached</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">$mem = new memcached();</div><div class=\"line\">$mem-&gt;setOption(Memcached::OPT_DISTRIBUTION,Memcached::DISTRIBUTION_CONSISTENT);</div><div class=\"line\">$mem-&gt;setOption(Memcached::OPT_LIBKETAMA_COMPATIBLE,true);</div></pre></td></tr></table></figure>\n<h2 id=\"Memcached监控\"><a href=\"#Memcached监控\" class=\"headerlink\" title=\"Memcached监控\"></a>Memcached监控</h2><h3 id=\"利用phpmemcache-php图形监控工具\"><a href=\"#利用phpmemcache-php图形监控工具\" class=\"headerlink\" title=\"利用phpmemcache.php图形监控工具\"></a>利用phpmemcache.php图形监控工具</h3><p>下载 phpmemcache.php<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">wget http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.php</div></pre></td></tr></table></figure></p>\n<p>将phpmemcache.php放入web目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">mv phpmemcache.php /usr/local/nginx/html</div></pre></td></tr></table></figure></p>\n<p>修改phpmemcache.php中配置<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div></pre></td><td class=\"code\"><pre><div class=\"line\">define(&apos;ADMIN_USERNAME&apos;,&apos;xxxx&apos;);    // 用户名修改，在访问 phpmemcache.php 需要进行认证</div><div class=\"line\">define(&apos;ADMIN_PASSWORD&apos;,&apos;xxxx&apos;);    // 密码</div><div class=\"line\">define(&apos;DATE_FORMAT&apos;,&apos;Y/m/d H:i:s&apos;);</div><div class=\"line\">define(&apos;GRAPH_SIZE&apos;,200);</div><div class=\"line\">define(&apos;MAX_ITEM_DUMP&apos;,50);</div><div class=\"line\"></div><div class=\"line\">$MEMCACHE_SERVERS[] = &apos;127.0.0.1:11211&apos;; // 加入需要监控的memcached服务器</div><div class=\"line\">//$MEMCACHE_SERVERS[] = &apos;192.168.200.104:11212&apos;; // add more as an array</div></pre></td></tr></table></figure></p>\n<p>浏览器访问<br><img src=\"http://n.sinaimg.cn/games/3ece443e/20160929/phpmemcache.png?1\" alt=\"phpmemcache浏览器访问效果\"></p>\n<h3 id=\"利用Stats命令查看\"><a href=\"#利用Stats命令查看\" class=\"headerlink\" title=\"利用Stats命令查看\"></a>利用Stats命令查看</h3><p>利用stats命令可以查看当前memcached的各种状态<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div><div class=\"line\">27</div><div class=\"line\">28</div><div class=\"line\">29</div><div class=\"line\">30</div><div class=\"line\">31</div><div class=\"line\">32</div><div class=\"line\">33</div><div class=\"line\">34</div><div class=\"line\">35</div><div class=\"line\">36</div><div class=\"line\">37</div><div class=\"line\">38</div><div class=\"line\">39</div><div class=\"line\">40</div><div class=\"line\">41</div><div class=\"line\">42</div><div class=\"line\">43</div><div class=\"line\">44</div><div class=\"line\">45</div><div class=\"line\">46</div><div class=\"line\">47</div><div class=\"line\">48</div><div class=\"line\">49</div><div class=\"line\">50</div><div class=\"line\">51</div><div class=\"line\">52</div><div class=\"line\">53</div><div class=\"line\">54</div><div class=\"line\">55</div><div class=\"line\">56</div><div class=\"line\">57</div><div class=\"line\">58</div><div class=\"line\">59</div><div class=\"line\">60</div><div class=\"line\">61</div><div class=\"line\">62</div><div class=\"line\">63</div><div class=\"line\">64</div><div class=\"line\">65</div></pre></td><td class=\"code\"><pre><div class=\"line\">telnet 127.0.0.1 11211</div><div class=\"line\">Trying 127.0.0.1...</div><div class=\"line\">Connected to 127.0.0.1.</div><div class=\"line\">Escape character is &apos;^]&apos;.</div><div class=\"line\">stats</div><div class=\"line\">STAT pid 24732</div><div class=\"line\">STAT uptime 66597</div><div class=\"line\">STAT time 1475115983</div><div class=\"line\">STAT version 1.4.31</div><div class=\"line\">STAT libevent 2.0.22-stable</div><div class=\"line\">STAT pointer_size 64</div><div class=\"line\">STAT rusage_user 6.194421</div><div class=\"line\">STAT rusage_system 2.419890</div><div class=\"line\">STAT curr_connections 10</div><div class=\"line\">STAT total_connections 16</div><div class=\"line\">STAT connection_structures 11</div><div class=\"line\">STAT reserved_fds 20</div><div class=\"line\">STAT cmd_get 5</div><div class=\"line\">STAT cmd_set 8</div><div class=\"line\">STAT cmd_flush 0</div><div class=\"line\">STAT cmd_touch 0</div><div class=\"line\">STAT get_hits 4</div><div class=\"line\">STAT get_misses 1</div><div class=\"line\">STAT get_expired 0</div><div class=\"line\">STAT get_flushed 0</div><div class=\"line\">STAT delete_misses 0</div><div class=\"line\">STAT delete_hits 2</div><div class=\"line\">STAT incr_misses 0</div><div class=\"line\">STAT incr_hits 0</div><div class=\"line\">STAT decr_misses 0</div><div class=\"line\">STAT decr_hits 0</div><div class=\"line\">STAT cas_misses 0</div><div class=\"line\">STAT cas_hits 0</div><div class=\"line\">STAT cas_badval 0</div><div class=\"line\">STAT touch_hits 0</div><div class=\"line\">STAT touch_misses 0</div><div class=\"line\">STAT auth_cmds 0</div><div class=\"line\">STAT auth_errors 0</div><div class=\"line\">STAT bytes_read 3850</div><div class=\"line\">STAT bytes_written 293</div><div class=\"line\">STAT limit_maxbytes 134217728</div><div class=\"line\">STAT accepting_conns 1</div><div class=\"line\">STAT listen_disabled_num 0</div><div class=\"line\">STAT time_in_listen_disabled_us 0</div><div class=\"line\">STAT threads 4</div><div class=\"line\">STAT conn_yields 0</div><div class=\"line\">STAT hash_power_level 16</div><div class=\"line\">STAT hash_bytes 524288</div><div class=\"line\">STAT hash_is_expanding 0</div><div class=\"line\">STAT malloc_fails 0</div><div class=\"line\">STAT log_worker_dropped 0</div><div class=\"line\">STAT log_worker_written 0</div><div class=\"line\">STAT log_watcher_skipped 0</div><div class=\"line\">STAT log_watcher_sent 0</div><div class=\"line\">STAT bytes 0</div><div class=\"line\">STAT curr_items 0</div><div class=\"line\">STAT total_items 6</div><div class=\"line\">STAT expired_unfetched 0</div><div class=\"line\">STAT evicted_unfetched 0</div><div class=\"line\">STAT evictions 0</div><div class=\"line\">STAT reclaimed 2</div><div class=\"line\">STAT crawler_reclaimed 0</div><div class=\"line\">STAT crawler_items_checked 0</div><div class=\"line\">STAT lrutail_reflocked 0</div><div class=\"line\">END</div></pre></td></tr></table></figure></p>\n<p>Stats详解</p>\n<table>\n<thead>\n<tr>\n<th>选项</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>pid</td>\n<td>memcache服务器的进程ID</td>\n</tr>\n<tr>\n<td>uptime</td>\n<td>服务器已经运行的秒数</td>\n</tr>\n<tr>\n<td>time</td>\n<td>服务器当前的unix时间戳</td>\n</tr>\n<tr>\n<td>version</td>\n<td>memcache版本</td>\n</tr>\n<tr>\n<td>pointer_size</td>\n<td>当前操作系统的指针大小（32位系统一般是32bit）</td>\n</tr>\n<tr>\n<td>rusage_user</td>\n<td>进程的累计用户时间</td>\n</tr>\n<tr>\n<td>rusage_system</td>\n<td>进程的累计系统时间</td>\n</tr>\n<tr>\n<td>curr_items</td>\n<td>服务器当前存储的items数量</td>\n</tr>\n<tr>\n<td>total_items</td>\n<td>从服务器启动以后存储的items总数量</td>\n</tr>\n<tr>\n<td>bytes</td>\n<td>当前服务器存储items占用的字节数</td>\n</tr>\n<tr>\n<td>curr_connections</td>\n<td>当前打开着的连接数</td>\n</tr>\n<tr>\n<td>total_connections</td>\n<td>从服务器启动以后曾经打开过的连接数</td>\n</tr>\n<tr>\n<td>connection_structures</td>\n<td>服务器分配的连接构造数</td>\n</tr>\n<tr>\n<td>cmd_get</td>\n<td>get命令（获取）总请求次数</td>\n</tr>\n<tr>\n<td>cmd_set</td>\n<td>set命令（保存）总请求次数</td>\n</tr>\n<tr>\n<td>get_hits</td>\n<td>总命中次数</td>\n</tr>\n<tr>\n<td>get_misses</td>\n<td>总未命中次数</td>\n</tr>\n<tr>\n<td>evictions</td>\n<td>为获取空闲内存而删除的items数（分配给memcache的空间用满后需要删除旧的items来得到空间分配给新的items）</td>\n</tr>\n<tr>\n<td>bytes_read</td>\n<td>总读取字节数（请求字节数）</td>\n</tr>\n<tr>\n<td>bytes_written</td>\n<td>总发送字节数（结果字节数）</td>\n</tr>\n<tr>\n<td>limit_maxbytes</td>\n<td>分配给memcache的内存大小（字节）</td>\n</tr>\n<tr>\n<td>threads</td>\n<td>当前线程数</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"利用各种监控软件查看（例如：nagios监控memcache的插件）\"><a href=\"#利用各种监控软件查看（例如：nagios监控memcache的插件）\" class=\"headerlink\" title=\"利用各种监控软件查看（例如：nagios监控memcache的插件）\"></a>利用各种监控软件查看（例如：nagios监控memcache的插件）</h3><blockquote>\n<p>只以命中率大于和小于为例两种状态。</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">vim check_memcache</div></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"meta\">#!/bin/sh</span></div><div class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$#</span> <span class=\"_\">-ne</span> 1 ]</div><div class=\"line\"><span class=\"keyword\">then</span></div><div class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"Usage:<span class=\"variable\">$0</span> -c num2\"</span></div><div class=\"line\"><span class=\"built_in\">exit</span> 0</div><div class=\"line\"><span class=\"keyword\">fi</span></div><div class=\"line\">cmd_get=`/usr/<span class=\"built_in\">local</span>/nagios/libexec/check_tcp -H localhost -p 11211 -E <span class=\"_\">-s</span> <span class=\"string\">'stats\\r\\nquit\\r\\n'</span> <span class=\"_\">-e</span> <span class=\"string\">'uptime'</span> |grep cmd_get | awk <span class=\"string\">'&#123;print $3+0&#125;'</span>`</div><div class=\"line\">get_hits=`/usr/<span class=\"built_in\">local</span>/nagios/libexec/check_tcp -H localhost -p 11211 -E <span class=\"_\">-s</span> <span class=\"string\">'stats\\r\\nquit\\r\\n'</span> <span class=\"_\">-e</span> <span class=\"string\">'uptime'</span> |grep get_hits | awk <span class=\"string\">'&#123;print $3+0&#125;'</span>`</div><div class=\"line\">hit_rate=`<span class=\"built_in\">echo</span> <span class=\"string\">\"<span class=\"variable\">$get_hits</span>*100/<span class=\"variable\">$cmd_get</span>\"</span>|bc`</div><div class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"variable\">$hit_rate</span> <span class=\"_\">-gt</span> <span class=\"variable\">$1</span> ];<span class=\"keyword\">then</span></div><div class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"OK - hit rate is <span class=\"variable\">$hit_rate</span> | hit_rate=<span class=\"variable\">$hit_rate</span>; cmd_get=<span class=\"variable\">$cmd_get</span>; get_hits=<span class=\"variable\">$get_hits</span>\"</span></div><div class=\"line\"><span class=\"built_in\">exit</span> 0</div><div class=\"line\"><span class=\"keyword\">else</span></div><div class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">\"CRITICAL - hit rate is <span class=\"variable\">$hit_rate</span> | hit_rate=<span class=\"variable\">$hit_rate</span>; cmd_get=<span class=\"variable\">$cmd_get</span>; get_hits=<span class=\"variable\">$get_hits</span>\"</span></div><div class=\"line\"><span class=\"built_in\">exit</span> 2</div><div class=\"line\"><span class=\"keyword\">fi</span></div></pre></td></tr></table></figure>\n<p>测试命中率大于80%为正常为例;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">eg：</div><div class=\"line\">sh check_memcache 80</div><div class=\"line\">root@ip-10-250-114-95:/liang# sh check_memcache 80</div><div class=\"line\">OK - hit rate is 99 | hit_rate=99; cmd_get=142547; get_hits=141880</div></pre></td></tr></table></figure></p>\n<p>以上证明命中率99%，即状态为OK.</p>"},{"title":"Nginx安装","date":"2016-09-25T13:30:00.000Z","ctime":"2016-09-25T13:30:00.000Z","utime":"2016-09-25T13:30:00.000Z","modif_times":0,"_content":"\n![nginx](http://n.sinaimg.cn/games/3ece443e/20160925/nginx_log.png)\n\n<!-- more -->\n\n## 准备\nOS：CentOS 7.2 64\n\nNginx：[nginx-1.11.4](http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz)\n\n## 编译环境准备\n```\nyum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel\n```\n> 依赖工具说明:\n> gcc 编译器\n> pcre 正则表达式工具\n> zlib 传输内容压缩\n> openssl Https支持\n\n## 编译安装\n解压源码包\n```\ntar -zxvf nginx-1.11.4.tar.gz\n```\n进入源码包目录\n```\ncd nginx-1.11.4\n```\n\n执行配置命令\n```\n./configure --prefix=/usr/local\nConfiguration summary\n  + using PCRE library: /usr/local/pcre\n  + OpenSSL library is not used\n  + using system zlib library\n\n  nginx path prefix: \"/usr/local/nginx\"\n  nginx binary file: \"/usr/local/nginx/sbin/nginx\"\n  nginx modules path: \"/usr/local/nginx/modules\"\n  nginx configuration prefix: \"/usr/local/nginx/conf\"\n  nginx configuration file: \"/usr/local/nginx/conf/nginx.conf\"\n  nginx pid file: \"/usr/local/nginx/logs/nginx.pid\"\n  nginx error log file: \"/usr/local/nginx/logs/error.log\"\n  nginx http access log file: \"/usr/local/nginx/logs/access.log\"\n  nginx http client request body temporary files: \"client_body_temp\"\n  nginx http proxy temporary files: \"proxy_temp\"\n  nginx http fastcgi temporary files: \"fastcgi_temp\"\n  nginx http uwsgi temporary files: \"uwsgi_temp\"\n  nginx http scgi temporary files: \"scgi_temp\"\n```\n执行编译安装\n```\nmake && make install\n```\n## 管理\n### 启动\n```\n/usr/local/nginx/sbin/nginx\n```\n### 停止\n```\n/usr/local/nginx/sbin/nginx -s stop\n```\n### 重启\n```\n/usr/local/nginx/sbin/nginx -s reload\n```\n### 查看Nginx进程状态\n```\nps aux |grep nginx\n```\n结果形如\n```\nroot     24367  0.0  0.0  20472   604 ?        Ss   22:52   0:00 nginx: master process /usr/local/nginx/sbin/nginx\nnobody   24368  0.0  0.0  20900  1320 ?        S    22:52   0:00 nginx: worker process\nroot     24370  0.0  0.0 112664   976 pts/0    S+   22:52   0:00 grep --color=auto nginx\n```\n> master proccess为主进程 守护进程\n> worker proccess为工作进程, 用于响应请求\n\n\n### 设置开机自动启动\n编辑文件 /etc/rc.d/rc.local\n```\necho \"/usr/local/nginx/sbin/nginx\" >> /etc/rc.d/rc.local\n```\n\n## 测试\n启动nginx，在浏览器通过IP地址访问服务器。查看是否有响应。\n\n~over\n","source":"_posts/nginx安装.md","raw":"---\ntitle: Nginx安装\ndate: 2016-09-25 21:30:00\nctime: 2016-09-25 21:30:00\nutime: 2016-09-25 21:30:00\nmodif_times: 0\ntags:\n- Nginx安装\ncategories:\n- Nginx\n---\n\n![nginx](http://n.sinaimg.cn/games/3ece443e/20160925/nginx_log.png)\n\n<!-- more -->\n\n## 准备\nOS：CentOS 7.2 64\n\nNginx：[nginx-1.11.4](http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz)\n\n## 编译环境准备\n```\nyum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel\n```\n> 依赖工具说明:\n> gcc 编译器\n> pcre 正则表达式工具\n> zlib 传输内容压缩\n> openssl Https支持\n\n## 编译安装\n解压源码包\n```\ntar -zxvf nginx-1.11.4.tar.gz\n```\n进入源码包目录\n```\ncd nginx-1.11.4\n```\n\n执行配置命令\n```\n./configure --prefix=/usr/local\nConfiguration summary\n  + using PCRE library: /usr/local/pcre\n  + OpenSSL library is not used\n  + using system zlib library\n\n  nginx path prefix: \"/usr/local/nginx\"\n  nginx binary file: \"/usr/local/nginx/sbin/nginx\"\n  nginx modules path: \"/usr/local/nginx/modules\"\n  nginx configuration prefix: \"/usr/local/nginx/conf\"\n  nginx configuration file: \"/usr/local/nginx/conf/nginx.conf\"\n  nginx pid file: \"/usr/local/nginx/logs/nginx.pid\"\n  nginx error log file: \"/usr/local/nginx/logs/error.log\"\n  nginx http access log file: \"/usr/local/nginx/logs/access.log\"\n  nginx http client request body temporary files: \"client_body_temp\"\n  nginx http proxy temporary files: \"proxy_temp\"\n  nginx http fastcgi temporary files: \"fastcgi_temp\"\n  nginx http uwsgi temporary files: \"uwsgi_temp\"\n  nginx http scgi temporary files: \"scgi_temp\"\n```\n执行编译安装\n```\nmake && make install\n```\n## 管理\n### 启动\n```\n/usr/local/nginx/sbin/nginx\n```\n### 停止\n```\n/usr/local/nginx/sbin/nginx -s stop\n```\n### 重启\n```\n/usr/local/nginx/sbin/nginx -s reload\n```\n### 查看Nginx进程状态\n```\nps aux |grep nginx\n```\n结果形如\n```\nroot     24367  0.0  0.0  20472   604 ?        Ss   22:52   0:00 nginx: master process /usr/local/nginx/sbin/nginx\nnobody   24368  0.0  0.0  20900  1320 ?        S    22:52   0:00 nginx: worker process\nroot     24370  0.0  0.0 112664   976 pts/0    S+   22:52   0:00 grep --color=auto nginx\n```\n> master proccess为主进程 守护进程\n> worker proccess为工作进程, 用于响应请求\n\n\n### 设置开机自动启动\n编辑文件 /etc/rc.d/rc.local\n```\necho \"/usr/local/nginx/sbin/nginx\" >> /etc/rc.d/rc.local\n```\n\n## 测试\n启动nginx，在浏览器通过IP地址访问服务器。查看是否有响应。\n\n~over\n","slug":"nginx安装","published":1,"updated":"2016-09-25T10:46:05.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxo004c699f5xwiskfj","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/nginx_log.png\" alt=\"nginx\"></p>\n<a id=\"more\"></a>\n<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><p>OS：CentOS 7.2 64</p>\n<p>Nginx：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz\" target=\"_blank\" rel=\"external\">nginx-1.11.4</a></p>\n<h2 id=\"编译环境准备\"><a href=\"#编译环境准备\" class=\"headerlink\" title=\"编译环境准备\"></a>编译环境准备</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel</div></pre></td></tr></table></figure>\n<blockquote>\n<p>依赖工具说明:<br>gcc 编译器<br>pcre 正则表达式工具<br>zlib 传输内容压缩<br>openssl Https支持</p>\n</blockquote>\n<h2 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h2><p>解压源码包<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar -zxvf nginx-1.11.4.tar.gz</div></pre></td></tr></table></figure></p>\n<p>进入源码包目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd nginx-1.11.4</div></pre></td></tr></table></figure></p>\n<p>执行配置命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local</div><div class=\"line\">Configuration summary</div><div class=\"line\">  + using PCRE library: /usr/local/pcre</div><div class=\"line\">  + OpenSSL library is not used</div><div class=\"line\">  + using system zlib library</div><div class=\"line\"></div><div class=\"line\">  nginx path prefix: &quot;/usr/local/nginx&quot;</div><div class=\"line\">  nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;</div><div class=\"line\">  nginx modules path: &quot;/usr/local/nginx/modules&quot;</div><div class=\"line\">  nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;</div><div class=\"line\">  nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;</div><div class=\"line\">  nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;</div><div class=\"line\">  nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</div><div class=\"line\">  nginx http access log file: &quot;/usr/local/nginx/logs/access.log&quot;</div><div class=\"line\">  nginx http client request body temporary files: &quot;client_body_temp&quot;</div><div class=\"line\">  nginx http proxy temporary files: &quot;proxy_temp&quot;</div><div class=\"line\">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</div><div class=\"line\">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</div><div class=\"line\">  nginx http scgi temporary files: &quot;scgi_temp&quot;</div></pre></td></tr></table></figure></p>\n<p>执行编译安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>\n<h2 id=\"管理\"><a href=\"#管理\" class=\"headerlink\" title=\"管理\"></a>管理</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure>\n<h3 id=\"停止\"><a href=\"#停止\" class=\"headerlink\" title=\"停止\"></a>停止</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -s stop</div></pre></td></tr></table></figure>\n<h3 id=\"重启\"><a href=\"#重启\" class=\"headerlink\" title=\"重启\"></a>重启</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure>\n<h3 id=\"查看Nginx进程状态\"><a href=\"#查看Nginx进程状态\" class=\"headerlink\" title=\"查看Nginx进程状态\"></a>查看Nginx进程状态</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux |grep nginx</div></pre></td></tr></table></figure>\n<p>结果形如<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">root     24367  0.0  0.0  20472   604 ?        Ss   22:52   0:00 nginx: master process /usr/local/nginx/sbin/nginx</div><div class=\"line\">nobody   24368  0.0  0.0  20900  1320 ?        S    22:52   0:00 nginx: worker process</div><div class=\"line\">root     24370  0.0  0.0 112664   976 pts/0    S+   22:52   0:00 grep --color=auto nginx</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>master proccess为主进程 守护进程<br>worker proccess为工作进程, 用于响应请求</p>\n</blockquote>\n<h3 id=\"设置开机自动启动\"><a href=\"#设置开机自动启动\" class=\"headerlink\" title=\"设置开机自动启动\"></a>设置开机自动启动</h3><p>编辑文件 /etc/rc.d/rc.local<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;/usr/local/nginx/sbin/nginx&quot; &gt;&gt; /etc/rc.d/rc.local</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>启动nginx，在浏览器通过IP地址访问服务器。查看是否有响应。</p>\n<p>~over</p>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20160925/nginx_log.png\" alt=\"nginx\"></p>","more":"<h2 id=\"准备\"><a href=\"#准备\" class=\"headerlink\" title=\"准备\"></a>准备</h2><p>OS：CentOS 7.2 64</p>\n<p>Nginx：<a href=\"http://n.sinaimg.cn/games/3ece443e/20160925/nginx-1.11.4.tar.gz\">nginx-1.11.4</a></p>\n<h2 id=\"编译环境准备\"><a href=\"#编译环境准备\" class=\"headerlink\" title=\"编译环境准备\"></a>编译环境准备</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">yum -y install gcc pcre pcre-devel zlib zlib-devel openssl openssl-devel</div></pre></td></tr></table></figure>\n<blockquote>\n<p>依赖工具说明:<br>gcc 编译器<br>pcre 正则表达式工具<br>zlib 传输内容压缩<br>openssl Https支持</p>\n</blockquote>\n<h2 id=\"编译安装\"><a href=\"#编译安装\" class=\"headerlink\" title=\"编译安装\"></a>编译安装</h2><p>解压源码包<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">tar -zxvf nginx-1.11.4.tar.gz</div></pre></td></tr></table></figure></p>\n<p>进入源码包目录<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">cd nginx-1.11.4</div></pre></td></tr></table></figure></p>\n<p>执行配置命令<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div></pre></td><td class=\"code\"><pre><div class=\"line\">./configure --prefix=/usr/local</div><div class=\"line\">Configuration summary</div><div class=\"line\">  + using PCRE library: /usr/local/pcre</div><div class=\"line\">  + OpenSSL library is not used</div><div class=\"line\">  + using system zlib library</div><div class=\"line\"></div><div class=\"line\">  nginx path prefix: &quot;/usr/local/nginx&quot;</div><div class=\"line\">  nginx binary file: &quot;/usr/local/nginx/sbin/nginx&quot;</div><div class=\"line\">  nginx modules path: &quot;/usr/local/nginx/modules&quot;</div><div class=\"line\">  nginx configuration prefix: &quot;/usr/local/nginx/conf&quot;</div><div class=\"line\">  nginx configuration file: &quot;/usr/local/nginx/conf/nginx.conf&quot;</div><div class=\"line\">  nginx pid file: &quot;/usr/local/nginx/logs/nginx.pid&quot;</div><div class=\"line\">  nginx error log file: &quot;/usr/local/nginx/logs/error.log&quot;</div><div class=\"line\">  nginx http access log file: &quot;/usr/local/nginx/logs/access.log&quot;</div><div class=\"line\">  nginx http client request body temporary files: &quot;client_body_temp&quot;</div><div class=\"line\">  nginx http proxy temporary files: &quot;proxy_temp&quot;</div><div class=\"line\">  nginx http fastcgi temporary files: &quot;fastcgi_temp&quot;</div><div class=\"line\">  nginx http uwsgi temporary files: &quot;uwsgi_temp&quot;</div><div class=\"line\">  nginx http scgi temporary files: &quot;scgi_temp&quot;</div></pre></td></tr></table></figure></p>\n<p>执行编译安装<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">make &amp;&amp; make install</div></pre></td></tr></table></figure></p>\n<h2 id=\"管理\"><a href=\"#管理\" class=\"headerlink\" title=\"管理\"></a>管理</h2><h3 id=\"启动\"><a href=\"#启动\" class=\"headerlink\" title=\"启动\"></a>启动</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx</div></pre></td></tr></table></figure>\n<h3 id=\"停止\"><a href=\"#停止\" class=\"headerlink\" title=\"停止\"></a>停止</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -s stop</div></pre></td></tr></table></figure>\n<h3 id=\"重启\"><a href=\"#重启\" class=\"headerlink\" title=\"重启\"></a>重启</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">/usr/local/nginx/sbin/nginx -s reload</div></pre></td></tr></table></figure>\n<h3 id=\"查看Nginx进程状态\"><a href=\"#查看Nginx进程状态\" class=\"headerlink\" title=\"查看Nginx进程状态\"></a>查看Nginx进程状态</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">ps aux |grep nginx</div></pre></td></tr></table></figure>\n<p>结果形如<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div></pre></td><td class=\"code\"><pre><div class=\"line\">root     24367  0.0  0.0  20472   604 ?        Ss   22:52   0:00 nginx: master process /usr/local/nginx/sbin/nginx</div><div class=\"line\">nobody   24368  0.0  0.0  20900  1320 ?        S    22:52   0:00 nginx: worker process</div><div class=\"line\">root     24370  0.0  0.0 112664   976 pts/0    S+   22:52   0:00 grep --color=auto nginx</div></pre></td></tr></table></figure></p>\n<blockquote>\n<p>master proccess为主进程 守护进程<br>worker proccess为工作进程, 用于响应请求</p>\n</blockquote>\n<h3 id=\"设置开机自动启动\"><a href=\"#设置开机自动启动\" class=\"headerlink\" title=\"设置开机自动启动\"></a>设置开机自动启动</h3><p>编辑文件 /etc/rc.d/rc.local<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">echo &quot;/usr/local/nginx/sbin/nginx&quot; &gt;&gt; /etc/rc.d/rc.local</div></pre></td></tr></table></figure></p>\n<h2 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h2><p>启动nginx，在浏览器通过IP地址访问服务器。查看是否有响应。</p>\n<p>~over</p>"},{"title":"事务的ACID概念","date":"2016-09-16T16:00:00.000Z","_content":"\n数据库中的事务就是一组原子行的SQL查询，或者说一个独立的工作但愿。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。\n\nACID表示原子性（atomicity）、一致性（consistency）、隔离行（isolation）和持久性（durability）。一个运行良好的事务处理系统，必须具备这些特征。\n> 一个实现了ACID的数据库，相比于没有实现ACID的数据库，通常需要更强的CPU，更大的内存，更多的存储空间。所以对于一些不需要事务支持的查询类型应用，选择一个非事务型的存储引擎，是可以获得更高的性能的。\n\n<!-- more -->\n\n## 事务ACID的概念\n- A,automicity 原子性\n> 即，一个不可分割的最小单元。\n\n- C,consistency 一致性\n> 总是从一种状态到另一种状态，没有第三种状态。\n\n- I,isolation 隔离性\n> 一个事务再提交之前，对其他事务是不可见的。即不同的事务之间相互之间不影响。\n\n- D,durability 持久性\n> 事务一旦提交，就会永久生效。\n\n## 隔离级别\n隔离级别，规定一个事务中所做的修改，哪些是在事务内和事务间是可见的，哪些是不可见的。\n一般，较低隔离级别的隔离可以支持更高的并发，系统的开销会更低。\n\n### 隔离要解决的问题\n\n- 脏读，Dirty read\n> 即其他事务可以读取到当前事务未提交的数据。\n\n- 不可重复读，nonrepeatable read\n> 即两次执行同样的查询，得到的结果可能是不一样的。\n\n- 幻读，Phantom read\n> 某一个事务在取一范围记录时，另一事务又在该范围插入了新纪录，当之前事务再读取该范围是，就会产生幻读。\n\n\n### 不同的隔离划分\n\n\n隔离级别| 脏读 | 不可重复读可能性 | 幻读 | 加锁读\n------|------|---------------|------|-----\nread uncommitted  | Y | Y | Y | Y\nread committed    | N | Y | Y | N\nrepeatable read   | N | N | Y | N\nserializable      | N | N | N | Y\n\n- Read uncommitted（未提交读）\n> 在这个级别下，事务中的修改，即使在没有提交的情况下，其他的事务也是可见的。\n>所以，除非有非常必要的理由，在实际应用中一般很少使用。\n\n- Read committed（提交读）\n> read committed隔离级别满足前面提到的隔离性的定义。即一个事务开始时，只能看见已经提交的事务所做的修改。换句话说，一个事务从开始到提交之前，所做的任何修改对其他的事务都是不可见的。\n> **大多数的数据库系统的默认隔离级别都是这个级别**\n> 但这个级别有时候会出现不可重复读的现象，即执行两次同样的查询可能会得到两个不同的结果。\n\n- repeatable read（可重复读）\n> 该级别解决了脏读的问题，而且保证了在同一个事务中多次读取同一条记录的结果是一致的。\n> **该级别是MySQL的默认事务级别**\n> 但是理论上，该级别下会出现另一个幻读的问题。\n> MySQL的InnoDB通过多版本并发控制（MVCC）来解决了该级别下出现幻读的可能性问题。\n\n- serializable（可串行化）\n> 该级别为最高的隔离级别。他通过强制事务串行执行，避免了前面 repeatable read 级别下可能会出现幻读的情况。简单说，就是serializable会在读取的每行数据上都加锁。所以会导致大量的超时和锁争用的情况。故实际应用中该级别也很少用到。\n","source":"_posts/事务的ACID概念.md","raw":"---\ntitle: 事务的ACID概念\ndate: 2016-09-17 00:00:00\ntags:\n- 事务\n- ACID\ncategories:\n- MySQL\n---\n\n数据库中的事务就是一组原子行的SQL查询，或者说一个独立的工作但愿。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。\n\nACID表示原子性（atomicity）、一致性（consistency）、隔离行（isolation）和持久性（durability）。一个运行良好的事务处理系统，必须具备这些特征。\n> 一个实现了ACID的数据库，相比于没有实现ACID的数据库，通常需要更强的CPU，更大的内存，更多的存储空间。所以对于一些不需要事务支持的查询类型应用，选择一个非事务型的存储引擎，是可以获得更高的性能的。\n\n<!-- more -->\n\n## 事务ACID的概念\n- A,automicity 原子性\n> 即，一个不可分割的最小单元。\n\n- C,consistency 一致性\n> 总是从一种状态到另一种状态，没有第三种状态。\n\n- I,isolation 隔离性\n> 一个事务再提交之前，对其他事务是不可见的。即不同的事务之间相互之间不影响。\n\n- D,durability 持久性\n> 事务一旦提交，就会永久生效。\n\n## 隔离级别\n隔离级别，规定一个事务中所做的修改，哪些是在事务内和事务间是可见的，哪些是不可见的。\n一般，较低隔离级别的隔离可以支持更高的并发，系统的开销会更低。\n\n### 隔离要解决的问题\n\n- 脏读，Dirty read\n> 即其他事务可以读取到当前事务未提交的数据。\n\n- 不可重复读，nonrepeatable read\n> 即两次执行同样的查询，得到的结果可能是不一样的。\n\n- 幻读，Phantom read\n> 某一个事务在取一范围记录时，另一事务又在该范围插入了新纪录，当之前事务再读取该范围是，就会产生幻读。\n\n\n### 不同的隔离划分\n\n\n隔离级别| 脏读 | 不可重复读可能性 | 幻读 | 加锁读\n------|------|---------------|------|-----\nread uncommitted  | Y | Y | Y | Y\nread committed    | N | Y | Y | N\nrepeatable read   | N | N | Y | N\nserializable      | N | N | N | Y\n\n- Read uncommitted（未提交读）\n> 在这个级别下，事务中的修改，即使在没有提交的情况下，其他的事务也是可见的。\n>所以，除非有非常必要的理由，在实际应用中一般很少使用。\n\n- Read committed（提交读）\n> read committed隔离级别满足前面提到的隔离性的定义。即一个事务开始时，只能看见已经提交的事务所做的修改。换句话说，一个事务从开始到提交之前，所做的任何修改对其他的事务都是不可见的。\n> **大多数的数据库系统的默认隔离级别都是这个级别**\n> 但这个级别有时候会出现不可重复读的现象，即执行两次同样的查询可能会得到两个不同的结果。\n\n- repeatable read（可重复读）\n> 该级别解决了脏读的问题，而且保证了在同一个事务中多次读取同一条记录的结果是一致的。\n> **该级别是MySQL的默认事务级别**\n> 但是理论上，该级别下会出现另一个幻读的问题。\n> MySQL的InnoDB通过多版本并发控制（MVCC）来解决了该级别下出现幻读的可能性问题。\n\n- serializable（可串行化）\n> 该级别为最高的隔离级别。他通过强制事务串行执行，避免了前面 repeatable read 级别下可能会出现幻读的情况。简单说，就是serializable会在读取的每行数据上都加锁。所以会导致大量的超时和锁争用的情况。故实际应用中该级别也很少用到。\n","slug":"事务的ACID概念","published":1,"updated":"2016-09-16T17:54:35.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwxp004e699f7wh3wwzb","content":"<p>数据库中的事务就是一组原子行的SQL查询，或者说一个独立的工作但愿。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。</p>\n<p>ACID表示原子性（atomicity）、一致性（consistency）、隔离行（isolation）和持久性（durability）。一个运行良好的事务处理系统，必须具备这些特征。</p>\n<blockquote>\n<p>一个实现了ACID的数据库，相比于没有实现ACID的数据库，通常需要更强的CPU，更大的内存，更多的存储空间。所以对于一些不需要事务支持的查询类型应用，选择一个非事务型的存储引擎，是可以获得更高的性能的。</p>\n</blockquote>\n<a id=\"more\"></a>\n<h2 id=\"事务ACID的概念\"><a href=\"#事务ACID的概念\" class=\"headerlink\" title=\"事务ACID的概念\"></a>事务ACID的概念</h2><ul>\n<li><p>A,automicity 原子性</p>\n<blockquote>\n<p>即，一个不可分割的最小单元。</p>\n</blockquote>\n</li>\n<li><p>C,consistency 一致性</p>\n<blockquote>\n<p>总是从一种状态到另一种状态，没有第三种状态。</p>\n</blockquote>\n</li>\n<li><p>I,isolation 隔离性</p>\n<blockquote>\n<p>一个事务再提交之前，对其他事务是不可见的。即不同的事务之间相互之间不影响。</p>\n</blockquote>\n</li>\n<li><p>D,durability 持久性</p>\n<blockquote>\n<p>事务一旦提交，就会永久生效。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"隔离级别\"><a href=\"#隔离级别\" class=\"headerlink\" title=\"隔离级别\"></a>隔离级别</h2><p>隔离级别，规定一个事务中所做的修改，哪些是在事务内和事务间是可见的，哪些是不可见的。<br>一般，较低隔离级别的隔离可以支持更高的并发，系统的开销会更低。</p>\n<h3 id=\"隔离要解决的问题\"><a href=\"#隔离要解决的问题\" class=\"headerlink\" title=\"隔离要解决的问题\"></a>隔离要解决的问题</h3><ul>\n<li><p>脏读，Dirty read</p>\n<blockquote>\n<p>即其他事务可以读取到当前事务未提交的数据。</p>\n</blockquote>\n</li>\n<li><p>不可重复读，nonrepeatable read</p>\n<blockquote>\n<p>即两次执行同样的查询，得到的结果可能是不一样的。</p>\n</blockquote>\n</li>\n<li><p>幻读，Phantom read</p>\n<blockquote>\n<p>某一个事务在取一范围记录时，另一事务又在该范围插入了新纪录，当之前事务再读取该范围是，就会产生幻读。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"不同的隔离划分\"><a href=\"#不同的隔离划分\" class=\"headerlink\" title=\"不同的隔离划分\"></a>不同的隔离划分</h3><table>\n<thead>\n<tr>\n<th>隔离级别</th>\n<th>脏读</th>\n<th>不可重复读可能性</th>\n<th>幻读</th>\n<th>加锁读</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>read uncommitted</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>read committed</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>repeatable read</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>serializable</td>\n<td>N</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><p>Read uncommitted（未提交读）</p>\n<blockquote>\n<p>在这个级别下，事务中的修改，即使在没有提交的情况下，其他的事务也是可见的。<br>所以，除非有非常必要的理由，在实际应用中一般很少使用。</p>\n</blockquote>\n</li>\n<li><p>Read committed（提交读）</p>\n<blockquote>\n<p>read committed隔离级别满足前面提到的隔离性的定义。即一个事务开始时，只能看见已经提交的事务所做的修改。换句话说，一个事务从开始到提交之前，所做的任何修改对其他的事务都是不可见的。<br><strong>大多数的数据库系统的默认隔离级别都是这个级别</strong><br>但这个级别有时候会出现不可重复读的现象，即执行两次同样的查询可能会得到两个不同的结果。</p>\n</blockquote>\n</li>\n<li><p>repeatable read（可重复读）</p>\n<blockquote>\n<p>该级别解决了脏读的问题，而且保证了在同一个事务中多次读取同一条记录的结果是一致的。<br><strong>该级别是MySQL的默认事务级别</strong><br>但是理论上，该级别下会出现另一个幻读的问题。<br>MySQL的InnoDB通过多版本并发控制（MVCC）来解决了该级别下出现幻读的可能性问题。</p>\n</blockquote>\n</li>\n<li><p>serializable（可串行化）</p>\n<blockquote>\n<p>该级别为最高的隔离级别。他通过强制事务串行执行，避免了前面 repeatable read 级别下可能会出现幻读的情况。简单说，就是serializable会在读取的每行数据上都加锁。所以会导致大量的超时和锁争用的情况。故实际应用中该级别也很少用到。</p>\n</blockquote>\n</li>\n</ul>\n","excerpt":"<p>数据库中的事务就是一组原子行的SQL查询，或者说一个独立的工作但愿。也就是说，事务内的语句，要么全部执行成功，要么全部执行失败。</p>\n<p>ACID表示原子性（atomicity）、一致性（consistency）、隔离行（isolation）和持久性（durability）。一个运行良好的事务处理系统，必须具备这些特征。</p>\n<blockquote>\n<p>一个实现了ACID的数据库，相比于没有实现ACID的数据库，通常需要更强的CPU，更大的内存，更多的存储空间。所以对于一些不需要事务支持的查询类型应用，选择一个非事务型的存储引擎，是可以获得更高的性能的。</p>\n</blockquote>","more":"<h2 id=\"事务ACID的概念\"><a href=\"#事务ACID的概念\" class=\"headerlink\" title=\"事务ACID的概念\"></a>事务ACID的概念</h2><ul>\n<li><p>A,automicity 原子性</p>\n<blockquote>\n<p>即，一个不可分割的最小单元。</p>\n</blockquote>\n</li>\n<li><p>C,consistency 一致性</p>\n<blockquote>\n<p>总是从一种状态到另一种状态，没有第三种状态。</p>\n</blockquote>\n</li>\n<li><p>I,isolation 隔离性</p>\n<blockquote>\n<p>一个事务再提交之前，对其他事务是不可见的。即不同的事务之间相互之间不影响。</p>\n</blockquote>\n</li>\n<li><p>D,durability 持久性</p>\n<blockquote>\n<p>事务一旦提交，就会永久生效。</p>\n</blockquote>\n</li>\n</ul>\n<h2 id=\"隔离级别\"><a href=\"#隔离级别\" class=\"headerlink\" title=\"隔离级别\"></a>隔离级别</h2><p>隔离级别，规定一个事务中所做的修改，哪些是在事务内和事务间是可见的，哪些是不可见的。<br>一般，较低隔离级别的隔离可以支持更高的并发，系统的开销会更低。</p>\n<h3 id=\"隔离要解决的问题\"><a href=\"#隔离要解决的问题\" class=\"headerlink\" title=\"隔离要解决的问题\"></a>隔离要解决的问题</h3><ul>\n<li><p>脏读，Dirty read</p>\n<blockquote>\n<p>即其他事务可以读取到当前事务未提交的数据。</p>\n</blockquote>\n</li>\n<li><p>不可重复读，nonrepeatable read</p>\n<blockquote>\n<p>即两次执行同样的查询，得到的结果可能是不一样的。</p>\n</blockquote>\n</li>\n<li><p>幻读，Phantom read</p>\n<blockquote>\n<p>某一个事务在取一范围记录时，另一事务又在该范围插入了新纪录，当之前事务再读取该范围是，就会产生幻读。</p>\n</blockquote>\n</li>\n</ul>\n<h3 id=\"不同的隔离划分\"><a href=\"#不同的隔离划分\" class=\"headerlink\" title=\"不同的隔离划分\"></a>不同的隔离划分</h3><table>\n<thead>\n<tr>\n<th>隔离级别</th>\n<th>脏读</th>\n<th>不可重复读可能性</th>\n<th>幻读</th>\n<th>加锁读</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>read uncommitted</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n<td>Y</td>\n</tr>\n<tr>\n<td>read committed</td>\n<td>N</td>\n<td>Y</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>repeatable read</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n<td>N</td>\n</tr>\n<tr>\n<td>serializable</td>\n<td>N</td>\n<td>N</td>\n<td>N</td>\n<td>Y</td>\n</tr>\n</tbody>\n</table>\n<ul>\n<li><p>Read uncommitted（未提交读）</p>\n<blockquote>\n<p>在这个级别下，事务中的修改，即使在没有提交的情况下，其他的事务也是可见的。<br>所以，除非有非常必要的理由，在实际应用中一般很少使用。</p>\n</blockquote>\n</li>\n<li><p>Read committed（提交读）</p>\n<blockquote>\n<p>read committed隔离级别满足前面提到的隔离性的定义。即一个事务开始时，只能看见已经提交的事务所做的修改。换句话说，一个事务从开始到提交之前，所做的任何修改对其他的事务都是不可见的。<br><strong>大多数的数据库系统的默认隔离级别都是这个级别</strong><br>但这个级别有时候会出现不可重复读的现象，即执行两次同样的查询可能会得到两个不同的结果。</p>\n</blockquote>\n</li>\n<li><p>repeatable read（可重复读）</p>\n<blockquote>\n<p>该级别解决了脏读的问题，而且保证了在同一个事务中多次读取同一条记录的结果是一致的。<br><strong>该级别是MySQL的默认事务级别</strong><br>但是理论上，该级别下会出现另一个幻读的问题。<br>MySQL的InnoDB通过多版本并发控制（MVCC）来解决了该级别下出现幻读的可能性问题。</p>\n</blockquote>\n</li>\n<li><p>serializable（可串行化）</p>\n<blockquote>\n<p>该级别为最高的隔离级别。他通过强制事务串行执行，避免了前面 repeatable read 级别下可能会出现幻读的情况。简单说，就是serializable会在读取的每行数据上都加锁。所以会导致大量的超时和锁争用的情况。故实际应用中该级别也很少用到。</p>\n</blockquote>\n</li>\n</ul>"},{"title":"大型网站技术架构剖析","date":"2016-10-13T02:30:00.000Z","_content":"\n![大型网站技术架构剖析](http://n.sinaimg.cn/games/3ece443e/20161013/DaXingWangZhanJiShuJiaGouPouXi.jpg)\n\n\n\n## 大型网站系统特点\n- 高并发，大流量\n- 高可用\n- 海量数据\n- 用户分布广泛，网络情况复杂\n- 安全环境恶略\n- 需求快速变更，发布频繁\n- 渐进式发展\n\n<!-- more -->\n\n## 大型网站发展演化过程\n\n### 一台服务器\n\n特点：没人\n\n应用程序、数据库、文件都在一个服务器。\n\n### 应用服务器和数据服务器分离\n应用服务器\n- 处理大量业务\n- 需要更快更强的CPU\n\n数据服务器\n- 需要快速磁盘检索和数据缓存\n- 需要更快的磁盘和更大的内存\n\n文件服务器\n- 需要更大的硬盘\n\n### 使用缓存改善网站性能\n- 本地缓存\n- 远程缓存（分布式缓存）\n\n### 使用应用服务器集群改善并发处理能力\n- 负载均衡服务器\n- 用户服务器集群\n\n### 数据库读写分离\n利用数据库的主从热备份，来实现数据库的读写分离。从而改善数据库的负载压力。\n\n### 使用反向代理和CDN加速网站响应\n> 基本原理都是缓存（都可以缓存一些静态资源）\n\n反向代理服务器\n- 缓存用户请求资源\n\nCDN服务器\n- 目的：尽早返回数据给用户\n\n### 使用分布式文件系统和分布式数据库系统\n分布式数据库是网站数据库拆分的最后手段。不到万不得已的时网站更常用的拆分手段是业务拆分。\n\n### 使用NoSQL和搜索引擎\n应对更复杂的存储和检索需求\n\n### 业务拆分\n> 应对日益复杂的业务场景\n\n拆分方法\n- 根据产品线拆分成不同的应用\n\n应用产品之间的关系\n- 超链接\n- 消息队列进行数据分发\n- 访问同一个数据存储系统\n\n\n### 分布式服务\n通过分布式服务调用公用业务服务完成具体业务需要\n\n## 大型网站架构模式\n\n### 分层\n- 应用层\n- 服务层\n- 数据层\n\n\n### 分割\n对不同的层继续进行垂直的分割\n\n### 分布式\n> 分层、分割的主要目的就是为了便于分布式部署。\n>\n> 分布式就是为了用更多的计算机来完成同样的功能\n\n- 分布式应用和服务\n- 分布式静态资源\n- 分布式数据和存储\n- 分布式计算\n- 分布式配置\n- 分布式文件系统\n\n### 集群\n> 多台服务器部署相同应用构成一个集群。通过负载均衡设备对外提供服务\n\n有点：\n- 提高系统并发访问量\n- 提高系统可用性（冗余）\n\n### 缓存\n> 改善性能的第一手段\n\n- 内容分发网络CDN\n- 反向代理\n- 本地缓存\n- 分布式缓存\n\n\n### 异步\n- 共享内存队列（单服务器）\n- 分布式消息队列(分布式系统)\n\n### 冗余\n访问和负载很小的服务器也至少要部署两台构成集群。目的就是实现服务的高可用。\n\n### 自动化\n- 自动化报警\n- 自动化失效转移\n- 自动化失效恢复\n- 自动化降级\n- 自动化分配资源\n\n### 安全\n- 身份认证\n- 加密\n- 验证码识别\n- 对于XSS，SQL注入，进行编码转换等\n- 敏感信息过滤\n- 风险控制\n\n## 网站性能测试优化\n\n### 性能测试指标\n- 响应时间\n- 并发数\n- 吞吐量\n- 性能计数器\n\n\n### 性能测试方法\n- 性能测试\n- 负载测试\n- 压力测试\n- 稳定性测试\n\n\n### 常见优化手段\n\n用户视角\n- 优化页面HTML样式\n- 利用浏览器的并发和异步\n- 调整浏览器缓存策略\n- CDN和反向代理\n\n开发人员\n- 使用缓存加速数据读取速度\n- 使用集群提高系统吞吐能力\n- 使用异步消息加速响应及实现消峰\n- 优化代码改善程序性能\n\n运维人员\n- 优化骨干网\n- 使用高性价比定制服务器\n- 使用虚拟化技术优化资源利用\n\n### 网站性能优化\n\nweb性能优化\n- 减少HTTP请求（合并css、javascript、图片）\n- 使用浏览器缓存（使用Cache-Control和Expire属性）\n- 启用压缩（减少网络数据传输量）\n- 减少页面阻塞（CSS文件尽量放在最上面，javascript放在最下面）\n- 减少Cookie传输\n- CDN加速\n- 反向代理\n  - 安全\n  - 加速web请求（可以缓存一些静态资源）\n  - 负载均衡\n\n\n应用服务器优化\n- 分布式缓存\n- 异步操作（消息队列）\n> 原则：任何可以晚点在做的事都可以晚点再做\n\n- 使用集群\n> 使用负载均衡技术来构建\n\n存储服务器优化\n- 访问频繁的页面不应该访问数据库（如首页，最好是静态的）\n- 谨慎使用锁操作\n- 对缓存的管理提高到和其他服务器一样的级别\n- 大文件小文件分别对待\n\n\n## 大型网站架构设计误区\n\n- 一味追求大公司的解决方案\n- 为了技术而技术\n- 企图用技术解决所有问题\n","source":"_posts/大型网站技术架构剖析.md","raw":"---\ntitle: 大型网站技术架构剖析\ndate: 2016-10-13 10:30:00\ncategories:\n- 架构\n---\n\n![大型网站技术架构剖析](http://n.sinaimg.cn/games/3ece443e/20161013/DaXingWangZhanJiShuJiaGouPouXi.jpg)\n\n\n\n## 大型网站系统特点\n- 高并发，大流量\n- 高可用\n- 海量数据\n- 用户分布广泛，网络情况复杂\n- 安全环境恶略\n- 需求快速变更，发布频繁\n- 渐进式发展\n\n<!-- more -->\n\n## 大型网站发展演化过程\n\n### 一台服务器\n\n特点：没人\n\n应用程序、数据库、文件都在一个服务器。\n\n### 应用服务器和数据服务器分离\n应用服务器\n- 处理大量业务\n- 需要更快更强的CPU\n\n数据服务器\n- 需要快速磁盘检索和数据缓存\n- 需要更快的磁盘和更大的内存\n\n文件服务器\n- 需要更大的硬盘\n\n### 使用缓存改善网站性能\n- 本地缓存\n- 远程缓存（分布式缓存）\n\n### 使用应用服务器集群改善并发处理能力\n- 负载均衡服务器\n- 用户服务器集群\n\n### 数据库读写分离\n利用数据库的主从热备份，来实现数据库的读写分离。从而改善数据库的负载压力。\n\n### 使用反向代理和CDN加速网站响应\n> 基本原理都是缓存（都可以缓存一些静态资源）\n\n反向代理服务器\n- 缓存用户请求资源\n\nCDN服务器\n- 目的：尽早返回数据给用户\n\n### 使用分布式文件系统和分布式数据库系统\n分布式数据库是网站数据库拆分的最后手段。不到万不得已的时网站更常用的拆分手段是业务拆分。\n\n### 使用NoSQL和搜索引擎\n应对更复杂的存储和检索需求\n\n### 业务拆分\n> 应对日益复杂的业务场景\n\n拆分方法\n- 根据产品线拆分成不同的应用\n\n应用产品之间的关系\n- 超链接\n- 消息队列进行数据分发\n- 访问同一个数据存储系统\n\n\n### 分布式服务\n通过分布式服务调用公用业务服务完成具体业务需要\n\n## 大型网站架构模式\n\n### 分层\n- 应用层\n- 服务层\n- 数据层\n\n\n### 分割\n对不同的层继续进行垂直的分割\n\n### 分布式\n> 分层、分割的主要目的就是为了便于分布式部署。\n>\n> 分布式就是为了用更多的计算机来完成同样的功能\n\n- 分布式应用和服务\n- 分布式静态资源\n- 分布式数据和存储\n- 分布式计算\n- 分布式配置\n- 分布式文件系统\n\n### 集群\n> 多台服务器部署相同应用构成一个集群。通过负载均衡设备对外提供服务\n\n有点：\n- 提高系统并发访问量\n- 提高系统可用性（冗余）\n\n### 缓存\n> 改善性能的第一手段\n\n- 内容分发网络CDN\n- 反向代理\n- 本地缓存\n- 分布式缓存\n\n\n### 异步\n- 共享内存队列（单服务器）\n- 分布式消息队列(分布式系统)\n\n### 冗余\n访问和负载很小的服务器也至少要部署两台构成集群。目的就是实现服务的高可用。\n\n### 自动化\n- 自动化报警\n- 自动化失效转移\n- 自动化失效恢复\n- 自动化降级\n- 自动化分配资源\n\n### 安全\n- 身份认证\n- 加密\n- 验证码识别\n- 对于XSS，SQL注入，进行编码转换等\n- 敏感信息过滤\n- 风险控制\n\n## 网站性能测试优化\n\n### 性能测试指标\n- 响应时间\n- 并发数\n- 吞吐量\n- 性能计数器\n\n\n### 性能测试方法\n- 性能测试\n- 负载测试\n- 压力测试\n- 稳定性测试\n\n\n### 常见优化手段\n\n用户视角\n- 优化页面HTML样式\n- 利用浏览器的并发和异步\n- 调整浏览器缓存策略\n- CDN和反向代理\n\n开发人员\n- 使用缓存加速数据读取速度\n- 使用集群提高系统吞吐能力\n- 使用异步消息加速响应及实现消峰\n- 优化代码改善程序性能\n\n运维人员\n- 优化骨干网\n- 使用高性价比定制服务器\n- 使用虚拟化技术优化资源利用\n\n### 网站性能优化\n\nweb性能优化\n- 减少HTTP请求（合并css、javascript、图片）\n- 使用浏览器缓存（使用Cache-Control和Expire属性）\n- 启用压缩（减少网络数据传输量）\n- 减少页面阻塞（CSS文件尽量放在最上面，javascript放在最下面）\n- 减少Cookie传输\n- CDN加速\n- 反向代理\n  - 安全\n  - 加速web请求（可以缓存一些静态资源）\n  - 负载均衡\n\n\n应用服务器优化\n- 分布式缓存\n- 异步操作（消息队列）\n> 原则：任何可以晚点在做的事都可以晚点再做\n\n- 使用集群\n> 使用负载均衡技术来构建\n\n存储服务器优化\n- 访问频繁的页面不应该访问数据库（如首页，最好是静态的）\n- 谨慎使用锁操作\n- 对缓存的管理提高到和其他服务器一样的级别\n- 大文件小文件分别对待\n\n\n## 大型网站架构设计误区\n\n- 一味追求大公司的解决方案\n- 为了技术而技术\n- 企图用技术解决所有问题\n","slug":"大型网站技术架构剖析","published":1,"updated":"2016-10-13T03:02:10.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwy0004h699fialbf76r","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161013/DaXingWangZhanJiShuJiaGouPouXi.jpg\" alt=\"大型网站技术架构剖析\"></p>\n<h2 id=\"大型网站系统特点\"><a href=\"#大型网站系统特点\" class=\"headerlink\" title=\"大型网站系统特点\"></a>大型网站系统特点</h2><ul>\n<li>高并发，大流量</li>\n<li>高可用</li>\n<li>海量数据</li>\n<li>用户分布广泛，网络情况复杂</li>\n<li>安全环境恶略</li>\n<li>需求快速变更，发布频繁</li>\n<li>渐进式发展</li>\n</ul>\n<a id=\"more\"></a>\n<h2 id=\"大型网站发展演化过程\"><a href=\"#大型网站发展演化过程\" class=\"headerlink\" title=\"大型网站发展演化过程\"></a>大型网站发展演化过程</h2><h3 id=\"一台服务器\"><a href=\"#一台服务器\" class=\"headerlink\" title=\"一台服务器\"></a>一台服务器</h3><p>特点：没人</p>\n<p>应用程序、数据库、文件都在一个服务器。</p>\n<h3 id=\"应用服务器和数据服务器分离\"><a href=\"#应用服务器和数据服务器分离\" class=\"headerlink\" title=\"应用服务器和数据服务器分离\"></a>应用服务器和数据服务器分离</h3><p>应用服务器</p>\n<ul>\n<li>处理大量业务</li>\n<li>需要更快更强的CPU</li>\n</ul>\n<p>数据服务器</p>\n<ul>\n<li>需要快速磁盘检索和数据缓存</li>\n<li>需要更快的磁盘和更大的内存</li>\n</ul>\n<p>文件服务器</p>\n<ul>\n<li>需要更大的硬盘</li>\n</ul>\n<h3 id=\"使用缓存改善网站性能\"><a href=\"#使用缓存改善网站性能\" class=\"headerlink\" title=\"使用缓存改善网站性能\"></a>使用缓存改善网站性能</h3><ul>\n<li>本地缓存</li>\n<li>远程缓存（分布式缓存）</li>\n</ul>\n<h3 id=\"使用应用服务器集群改善并发处理能力\"><a href=\"#使用应用服务器集群改善并发处理能力\" class=\"headerlink\" title=\"使用应用服务器集群改善并发处理能力\"></a>使用应用服务器集群改善并发处理能力</h3><ul>\n<li>负载均衡服务器</li>\n<li>用户服务器集群</li>\n</ul>\n<h3 id=\"数据库读写分离\"><a href=\"#数据库读写分离\" class=\"headerlink\" title=\"数据库读写分离\"></a>数据库读写分离</h3><p>利用数据库的主从热备份，来实现数据库的读写分离。从而改善数据库的负载压力。</p>\n<h3 id=\"使用反向代理和CDN加速网站响应\"><a href=\"#使用反向代理和CDN加速网站响应\" class=\"headerlink\" title=\"使用反向代理和CDN加速网站响应\"></a>使用反向代理和CDN加速网站响应</h3><blockquote>\n<p>基本原理都是缓存（都可以缓存一些静态资源）</p>\n</blockquote>\n<p>反向代理服务器</p>\n<ul>\n<li>缓存用户请求资源</li>\n</ul>\n<p>CDN服务器</p>\n<ul>\n<li>目的：尽早返回数据给用户</li>\n</ul>\n<h3 id=\"使用分布式文件系统和分布式数据库系统\"><a href=\"#使用分布式文件系统和分布式数据库系统\" class=\"headerlink\" title=\"使用分布式文件系统和分布式数据库系统\"></a>使用分布式文件系统和分布式数据库系统</h3><p>分布式数据库是网站数据库拆分的最后手段。不到万不得已的时网站更常用的拆分手段是业务拆分。</p>\n<h3 id=\"使用NoSQL和搜索引擎\"><a href=\"#使用NoSQL和搜索引擎\" class=\"headerlink\" title=\"使用NoSQL和搜索引擎\"></a>使用NoSQL和搜索引擎</h3><p>应对更复杂的存储和检索需求</p>\n<h3 id=\"业务拆分\"><a href=\"#业务拆分\" class=\"headerlink\" title=\"业务拆分\"></a>业务拆分</h3><blockquote>\n<p>应对日益复杂的业务场景</p>\n</blockquote>\n<p>拆分方法</p>\n<ul>\n<li>根据产品线拆分成不同的应用</li>\n</ul>\n<p>应用产品之间的关系</p>\n<ul>\n<li>超链接</li>\n<li>消息队列进行数据分发</li>\n<li>访问同一个数据存储系统</li>\n</ul>\n<h3 id=\"分布式服务\"><a href=\"#分布式服务\" class=\"headerlink\" title=\"分布式服务\"></a>分布式服务</h3><p>通过分布式服务调用公用业务服务完成具体业务需要</p>\n<h2 id=\"大型网站架构模式\"><a href=\"#大型网站架构模式\" class=\"headerlink\" title=\"大型网站架构模式\"></a>大型网站架构模式</h2><h3 id=\"分层\"><a href=\"#分层\" class=\"headerlink\" title=\"分层\"></a>分层</h3><ul>\n<li>应用层</li>\n<li>服务层</li>\n<li>数据层</li>\n</ul>\n<h3 id=\"分割\"><a href=\"#分割\" class=\"headerlink\" title=\"分割\"></a>分割</h3><p>对不同的层继续进行垂直的分割</p>\n<h3 id=\"分布式\"><a href=\"#分布式\" class=\"headerlink\" title=\"分布式\"></a>分布式</h3><blockquote>\n<p>分层、分割的主要目的就是为了便于分布式部署。</p>\n<p>分布式就是为了用更多的计算机来完成同样的功能</p>\n</blockquote>\n<ul>\n<li>分布式应用和服务</li>\n<li>分布式静态资源</li>\n<li>分布式数据和存储</li>\n<li>分布式计算</li>\n<li>分布式配置</li>\n<li>分布式文件系统</li>\n</ul>\n<h3 id=\"集群\"><a href=\"#集群\" class=\"headerlink\" title=\"集群\"></a>集群</h3><blockquote>\n<p>多台服务器部署相同应用构成一个集群。通过负载均衡设备对外提供服务</p>\n</blockquote>\n<p>有点：</p>\n<ul>\n<li>提高系统并发访问量</li>\n<li>提高系统可用性（冗余）</li>\n</ul>\n<h3 id=\"缓存\"><a href=\"#缓存\" class=\"headerlink\" title=\"缓存\"></a>缓存</h3><blockquote>\n<p>改善性能的第一手段</p>\n</blockquote>\n<ul>\n<li>内容分发网络CDN</li>\n<li>反向代理</li>\n<li>本地缓存</li>\n<li>分布式缓存</li>\n</ul>\n<h3 id=\"异步\"><a href=\"#异步\" class=\"headerlink\" title=\"异步\"></a>异步</h3><ul>\n<li>共享内存队列（单服务器）</li>\n<li>分布式消息队列(分布式系统)</li>\n</ul>\n<h3 id=\"冗余\"><a href=\"#冗余\" class=\"headerlink\" title=\"冗余\"></a>冗余</h3><p>访问和负载很小的服务器也至少要部署两台构成集群。目的就是实现服务的高可用。</p>\n<h3 id=\"自动化\"><a href=\"#自动化\" class=\"headerlink\" title=\"自动化\"></a>自动化</h3><ul>\n<li>自动化报警</li>\n<li>自动化失效转移</li>\n<li>自动化失效恢复</li>\n<li>自动化降级</li>\n<li>自动化分配资源</li>\n</ul>\n<h3 id=\"安全\"><a href=\"#安全\" class=\"headerlink\" title=\"安全\"></a>安全</h3><ul>\n<li>身份认证</li>\n<li>加密</li>\n<li>验证码识别</li>\n<li>对于XSS，SQL注入，进行编码转换等</li>\n<li>敏感信息过滤</li>\n<li>风险控制</li>\n</ul>\n<h2 id=\"网站性能测试优化\"><a href=\"#网站性能测试优化\" class=\"headerlink\" title=\"网站性能测试优化\"></a>网站性能测试优化</h2><h3 id=\"性能测试指标\"><a href=\"#性能测试指标\" class=\"headerlink\" title=\"性能测试指标\"></a>性能测试指标</h3><ul>\n<li>响应时间</li>\n<li>并发数</li>\n<li>吞吐量</li>\n<li>性能计数器</li>\n</ul>\n<h3 id=\"性能测试方法\"><a href=\"#性能测试方法\" class=\"headerlink\" title=\"性能测试方法\"></a>性能测试方法</h3><ul>\n<li>性能测试</li>\n<li>负载测试</li>\n<li>压力测试</li>\n<li>稳定性测试</li>\n</ul>\n<h3 id=\"常见优化手段\"><a href=\"#常见优化手段\" class=\"headerlink\" title=\"常见优化手段\"></a>常见优化手段</h3><p>用户视角</p>\n<ul>\n<li>优化页面HTML样式</li>\n<li>利用浏览器的并发和异步</li>\n<li>调整浏览器缓存策略</li>\n<li>CDN和反向代理</li>\n</ul>\n<p>开发人员</p>\n<ul>\n<li>使用缓存加速数据读取速度</li>\n<li>使用集群提高系统吞吐能力</li>\n<li>使用异步消息加速响应及实现消峰</li>\n<li>优化代码改善程序性能</li>\n</ul>\n<p>运维人员</p>\n<ul>\n<li>优化骨干网</li>\n<li>使用高性价比定制服务器</li>\n<li>使用虚拟化技术优化资源利用</li>\n</ul>\n<h3 id=\"网站性能优化\"><a href=\"#网站性能优化\" class=\"headerlink\" title=\"网站性能优化\"></a>网站性能优化</h3><p>web性能优化</p>\n<ul>\n<li>减少HTTP请求（合并css、javascript、图片）</li>\n<li>使用浏览器缓存（使用Cache-Control和Expire属性）</li>\n<li>启用压缩（减少网络数据传输量）</li>\n<li>减少页面阻塞（CSS文件尽量放在最上面，javascript放在最下面）</li>\n<li>减少Cookie传输</li>\n<li>CDN加速</li>\n<li>反向代理<ul>\n<li>安全</li>\n<li>加速web请求（可以缓存一些静态资源）</li>\n<li>负载均衡</li>\n</ul>\n</li>\n</ul>\n<p>应用服务器优化</p>\n<ul>\n<li>分布式缓存</li>\n<li><p>异步操作（消息队列）</p>\n<blockquote>\n<p>原则：任何可以晚点在做的事都可以晚点再做</p>\n</blockquote>\n</li>\n<li><p>使用集群</p>\n<blockquote>\n<p>使用负载均衡技术来构建</p>\n</blockquote>\n</li>\n</ul>\n<p>存储服务器优化</p>\n<ul>\n<li>访问频繁的页面不应该访问数据库（如首页，最好是静态的）</li>\n<li>谨慎使用锁操作</li>\n<li>对缓存的管理提高到和其他服务器一样的级别</li>\n<li>大文件小文件分别对待</li>\n</ul>\n<h2 id=\"大型网站架构设计误区\"><a href=\"#大型网站架构设计误区\" class=\"headerlink\" title=\"大型网站架构设计误区\"></a>大型网站架构设计误区</h2><ul>\n<li>一味追求大公司的解决方案</li>\n<li>为了技术而技术</li>\n<li>企图用技术解决所有问题</li>\n</ul>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161013/DaXingWangZhanJiShuJiaGouPouXi.jpg\" alt=\"大型网站技术架构剖析\"></p>\n<h2 id=\"大型网站系统特点\"><a href=\"#大型网站系统特点\" class=\"headerlink\" title=\"大型网站系统特点\"></a>大型网站系统特点</h2><ul>\n<li>高并发，大流量</li>\n<li>高可用</li>\n<li>海量数据</li>\n<li>用户分布广泛，网络情况复杂</li>\n<li>安全环境恶略</li>\n<li>需求快速变更，发布频繁</li>\n<li>渐进式发展</li>\n</ul>","more":"<h2 id=\"大型网站发展演化过程\"><a href=\"#大型网站发展演化过程\" class=\"headerlink\" title=\"大型网站发展演化过程\"></a>大型网站发展演化过程</h2><h3 id=\"一台服务器\"><a href=\"#一台服务器\" class=\"headerlink\" title=\"一台服务器\"></a>一台服务器</h3><p>特点：没人</p>\n<p>应用程序、数据库、文件都在一个服务器。</p>\n<h3 id=\"应用服务器和数据服务器分离\"><a href=\"#应用服务器和数据服务器分离\" class=\"headerlink\" title=\"应用服务器和数据服务器分离\"></a>应用服务器和数据服务器分离</h3><p>应用服务器</p>\n<ul>\n<li>处理大量业务</li>\n<li>需要更快更强的CPU</li>\n</ul>\n<p>数据服务器</p>\n<ul>\n<li>需要快速磁盘检索和数据缓存</li>\n<li>需要更快的磁盘和更大的内存</li>\n</ul>\n<p>文件服务器</p>\n<ul>\n<li>需要更大的硬盘</li>\n</ul>\n<h3 id=\"使用缓存改善网站性能\"><a href=\"#使用缓存改善网站性能\" class=\"headerlink\" title=\"使用缓存改善网站性能\"></a>使用缓存改善网站性能</h3><ul>\n<li>本地缓存</li>\n<li>远程缓存（分布式缓存）</li>\n</ul>\n<h3 id=\"使用应用服务器集群改善并发处理能力\"><a href=\"#使用应用服务器集群改善并发处理能力\" class=\"headerlink\" title=\"使用应用服务器集群改善并发处理能力\"></a>使用应用服务器集群改善并发处理能力</h3><ul>\n<li>负载均衡服务器</li>\n<li>用户服务器集群</li>\n</ul>\n<h3 id=\"数据库读写分离\"><a href=\"#数据库读写分离\" class=\"headerlink\" title=\"数据库读写分离\"></a>数据库读写分离</h3><p>利用数据库的主从热备份，来实现数据库的读写分离。从而改善数据库的负载压力。</p>\n<h3 id=\"使用反向代理和CDN加速网站响应\"><a href=\"#使用反向代理和CDN加速网站响应\" class=\"headerlink\" title=\"使用反向代理和CDN加速网站响应\"></a>使用反向代理和CDN加速网站响应</h3><blockquote>\n<p>基本原理都是缓存（都可以缓存一些静态资源）</p>\n</blockquote>\n<p>反向代理服务器</p>\n<ul>\n<li>缓存用户请求资源</li>\n</ul>\n<p>CDN服务器</p>\n<ul>\n<li>目的：尽早返回数据给用户</li>\n</ul>\n<h3 id=\"使用分布式文件系统和分布式数据库系统\"><a href=\"#使用分布式文件系统和分布式数据库系统\" class=\"headerlink\" title=\"使用分布式文件系统和分布式数据库系统\"></a>使用分布式文件系统和分布式数据库系统</h3><p>分布式数据库是网站数据库拆分的最后手段。不到万不得已的时网站更常用的拆分手段是业务拆分。</p>\n<h3 id=\"使用NoSQL和搜索引擎\"><a href=\"#使用NoSQL和搜索引擎\" class=\"headerlink\" title=\"使用NoSQL和搜索引擎\"></a>使用NoSQL和搜索引擎</h3><p>应对更复杂的存储和检索需求</p>\n<h3 id=\"业务拆分\"><a href=\"#业务拆分\" class=\"headerlink\" title=\"业务拆分\"></a>业务拆分</h3><blockquote>\n<p>应对日益复杂的业务场景</p>\n</blockquote>\n<p>拆分方法</p>\n<ul>\n<li>根据产品线拆分成不同的应用</li>\n</ul>\n<p>应用产品之间的关系</p>\n<ul>\n<li>超链接</li>\n<li>消息队列进行数据分发</li>\n<li>访问同一个数据存储系统</li>\n</ul>\n<h3 id=\"分布式服务\"><a href=\"#分布式服务\" class=\"headerlink\" title=\"分布式服务\"></a>分布式服务</h3><p>通过分布式服务调用公用业务服务完成具体业务需要</p>\n<h2 id=\"大型网站架构模式\"><a href=\"#大型网站架构模式\" class=\"headerlink\" title=\"大型网站架构模式\"></a>大型网站架构模式</h2><h3 id=\"分层\"><a href=\"#分层\" class=\"headerlink\" title=\"分层\"></a>分层</h3><ul>\n<li>应用层</li>\n<li>服务层</li>\n<li>数据层</li>\n</ul>\n<h3 id=\"分割\"><a href=\"#分割\" class=\"headerlink\" title=\"分割\"></a>分割</h3><p>对不同的层继续进行垂直的分割</p>\n<h3 id=\"分布式\"><a href=\"#分布式\" class=\"headerlink\" title=\"分布式\"></a>分布式</h3><blockquote>\n<p>分层、分割的主要目的就是为了便于分布式部署。</p>\n<p>分布式就是为了用更多的计算机来完成同样的功能</p>\n</blockquote>\n<ul>\n<li>分布式应用和服务</li>\n<li>分布式静态资源</li>\n<li>分布式数据和存储</li>\n<li>分布式计算</li>\n<li>分布式配置</li>\n<li>分布式文件系统</li>\n</ul>\n<h3 id=\"集群\"><a href=\"#集群\" class=\"headerlink\" title=\"集群\"></a>集群</h3><blockquote>\n<p>多台服务器部署相同应用构成一个集群。通过负载均衡设备对外提供服务</p>\n</blockquote>\n<p>有点：</p>\n<ul>\n<li>提高系统并发访问量</li>\n<li>提高系统可用性（冗余）</li>\n</ul>\n<h3 id=\"缓存\"><a href=\"#缓存\" class=\"headerlink\" title=\"缓存\"></a>缓存</h3><blockquote>\n<p>改善性能的第一手段</p>\n</blockquote>\n<ul>\n<li>内容分发网络CDN</li>\n<li>反向代理</li>\n<li>本地缓存</li>\n<li>分布式缓存</li>\n</ul>\n<h3 id=\"异步\"><a href=\"#异步\" class=\"headerlink\" title=\"异步\"></a>异步</h3><ul>\n<li>共享内存队列（单服务器）</li>\n<li>分布式消息队列(分布式系统)</li>\n</ul>\n<h3 id=\"冗余\"><a href=\"#冗余\" class=\"headerlink\" title=\"冗余\"></a>冗余</h3><p>访问和负载很小的服务器也至少要部署两台构成集群。目的就是实现服务的高可用。</p>\n<h3 id=\"自动化\"><a href=\"#自动化\" class=\"headerlink\" title=\"自动化\"></a>自动化</h3><ul>\n<li>自动化报警</li>\n<li>自动化失效转移</li>\n<li>自动化失效恢复</li>\n<li>自动化降级</li>\n<li>自动化分配资源</li>\n</ul>\n<h3 id=\"安全\"><a href=\"#安全\" class=\"headerlink\" title=\"安全\"></a>安全</h3><ul>\n<li>身份认证</li>\n<li>加密</li>\n<li>验证码识别</li>\n<li>对于XSS，SQL注入，进行编码转换等</li>\n<li>敏感信息过滤</li>\n<li>风险控制</li>\n</ul>\n<h2 id=\"网站性能测试优化\"><a href=\"#网站性能测试优化\" class=\"headerlink\" title=\"网站性能测试优化\"></a>网站性能测试优化</h2><h3 id=\"性能测试指标\"><a href=\"#性能测试指标\" class=\"headerlink\" title=\"性能测试指标\"></a>性能测试指标</h3><ul>\n<li>响应时间</li>\n<li>并发数</li>\n<li>吞吐量</li>\n<li>性能计数器</li>\n</ul>\n<h3 id=\"性能测试方法\"><a href=\"#性能测试方法\" class=\"headerlink\" title=\"性能测试方法\"></a>性能测试方法</h3><ul>\n<li>性能测试</li>\n<li>负载测试</li>\n<li>压力测试</li>\n<li>稳定性测试</li>\n</ul>\n<h3 id=\"常见优化手段\"><a href=\"#常见优化手段\" class=\"headerlink\" title=\"常见优化手段\"></a>常见优化手段</h3><p>用户视角</p>\n<ul>\n<li>优化页面HTML样式</li>\n<li>利用浏览器的并发和异步</li>\n<li>调整浏览器缓存策略</li>\n<li>CDN和反向代理</li>\n</ul>\n<p>开发人员</p>\n<ul>\n<li>使用缓存加速数据读取速度</li>\n<li>使用集群提高系统吞吐能力</li>\n<li>使用异步消息加速响应及实现消峰</li>\n<li>优化代码改善程序性能</li>\n</ul>\n<p>运维人员</p>\n<ul>\n<li>优化骨干网</li>\n<li>使用高性价比定制服务器</li>\n<li>使用虚拟化技术优化资源利用</li>\n</ul>\n<h3 id=\"网站性能优化\"><a href=\"#网站性能优化\" class=\"headerlink\" title=\"网站性能优化\"></a>网站性能优化</h3><p>web性能优化</p>\n<ul>\n<li>减少HTTP请求（合并css、javascript、图片）</li>\n<li>使用浏览器缓存（使用Cache-Control和Expire属性）</li>\n<li>启用压缩（减少网络数据传输量）</li>\n<li>减少页面阻塞（CSS文件尽量放在最上面，javascript放在最下面）</li>\n<li>减少Cookie传输</li>\n<li>CDN加速</li>\n<li>反向代理<ul>\n<li>安全</li>\n<li>加速web请求（可以缓存一些静态资源）</li>\n<li>负载均衡</li>\n</ul>\n</li>\n</ul>\n<p>应用服务器优化</p>\n<ul>\n<li>分布式缓存</li>\n<li><p>异步操作（消息队列）</p>\n<blockquote>\n<p>原则：任何可以晚点在做的事都可以晚点再做</p>\n</blockquote>\n</li>\n<li><p>使用集群</p>\n<blockquote>\n<p>使用负载均衡技术来构建</p>\n</blockquote>\n</li>\n</ul>\n<p>存储服务器优化</p>\n<ul>\n<li>访问频繁的页面不应该访问数据库（如首页，最好是静态的）</li>\n<li>谨慎使用锁操作</li>\n<li>对缓存的管理提高到和其他服务器一样的级别</li>\n<li>大文件小文件分别对待</li>\n</ul>\n<h2 id=\"大型网站架构设计误区\"><a href=\"#大型网站架构设计误区\" class=\"headerlink\" title=\"大型网站架构设计误区\"></a>大型网站架构设计误区</h2><ul>\n<li>一味追求大公司的解决方案</li>\n<li>为了技术而技术</li>\n<li>企图用技术解决所有问题</li>\n</ul>"},{"title":"大话MySQL性能优化","date":"2016-10-13T10:30:00.000Z","_content":"\n![MYSQL性能优化](http://n.sinaimg.cn/games/3ece443e/20161013/MySQLXingNenDiaoYou.jpg)\n\n性能是MySQL一直引以为豪的一点。在性能和功能两个方面，MySQL第一考虑的还是性能。\n\n<!-- more -->\n\n## 影响MySQL性能的相关因素\n\n### 商业需求对性能的影响\n对于某一些功能在整个系统中是画蛇添足的，那么这些需求就可能会影响系统性能。比如，一个论坛要求对在线人数进行实时统计。\n\n### 系统架构及实现对性能的影响\n服务器调优\n\n应用程序调优\n- 不可是存储到数据库的数据\n  - 二进制多媒体数据\n  - 流水队列数据\n  - 超大文本数据\n- 合理的利用应用层Cache（适合Cache的数据有：）\n  - 系统的各种配置和规则数据\n  - 活跃用户的基本信息数据\n  - 活跃用户的个性化定制信息数据\n  - 准实时的统计信息\n  - 其他一些访问频繁但变更很少的数据\n- 数据层实现精简\n- 过度依赖数据库SQL语句功能\n- 常见的架构设计不当带来的性能问题和资源浪费\n  - Cache系统设计不合理，导致Cache命中率低下\n  - 过度依赖面向对象\n  - 对可扩展性的过度追求（促使系统设计的时候对象拆分的过于分散，造成系统中出现大量的join语句）\n  - 对数据库的过于依赖（将不适合存储在数据库中的数据存储在数据库中）\n  - 过度理想化系统的用户体验（使大量非核心业务消耗大量系统资源）\n\n### Query语句对性能的影响\n\n#### 分析手段\n- explain\n> 分析选项：\n> - 索引（key），query语句中是用到的索引\n> - row中的rows，查找的记录数\n\n- profiling\n> 先打开profiling；set profiling=1；\n>\n> 查看profiling信息：show profiling \\\\G;\n>\n> show profile CPU,BLOCK IO FOR query 1(2);\n>\n> 分析选项\n> - CPU IO消耗\n\n#### MySQL的锁机制\n> **锁机制的目的：** 保证数据的一致完整性\n>\n> **锁机制的影响：** 直接影响一个数据库系统的并发处理能力和性能\n\n- 行级锁（row-level）\n> **优点：** 锁定对象的粒度最小，发生锁定资源争用的概率就最小，能给予最大可能的并发处理能力。\n>\n> **缺点：** 由于粒度最小，所以每次获得锁和释放锁需要做的工作也最多。带来的消耗也就最大。另外，容易发生死锁。\n\n- 表级锁（table-level）\n> **优点：** 最大粒度的锁定机制。所以逻辑简单，实现也较为容易。获得锁和释放锁的速度也很快。而且能很好的避免死锁问题。\n>\n> **缺点：** 出现锁定资源争用的概率会提高，导致并发处理能力大打折扣。\n\n- 页级锁（page-level）\n> 介于row-level和table-level二者之间。\n\n#### 合理的应用锁机制\n\nMyISAM表锁优化\n> 关键：提高并发度\n\n- 缩短锁定时间，即query的执行时间要尽可能的短\n  - 尽量减少大的、复杂的query，将复杂的query拆分\n  - 尽可能的建立高效索引，使数据的检索更加迅速\n  - 尽量让MySQL的表只存放必要的信息，控制字段类型\n- 分离能并行的操作\n  - 关键：Concurrent insert（并发插入特性）\n  - 打开 Concurrent_insert功能，选项有0，1和2。具体说明如下：\n  - concurrent_insert=2,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都允许在尾部进行concurrent insert操作。\n  - concurrent_insert=1,当MyISAM表数据文件中间部分不存在因删除而留下的空闲空间，可以在尾部进行concurrent insert操作。\n  - concurrent_insert=0,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都不允许在尾部进行concurrent insert操作。\n  - 建议：如果数据删除的肯呢个性很小，则建议将concurrent_insert设置成1，如不在乎浪费少量空间设置成2也可以。但当有少量删除时，设置成1更合适。\n- 读写优先级设置\n  - 默认，写的优先级大于读的优先级\n  - 参数选项，low_priority_updates=1(将写的优先级调低)\n\nInnoDB行锁优化\n- 尽可能让所有的数据检索都通过索引来完成，避免InnoDB因为无法通过索引键加锁升级成为表级锁定\n- 合理设计索引，让InnoDB加锁是尽可能准确，尽可能缩小锁定范围\n- 尽可能的减少基于范围的数据检索过滤条件\n- 尽量控制事务的大小，尽量减少锁定的资源量和锁定的时间长度\n- 尽量使用级别低的事务隔离级别，减少MySQL因为事务隔离带来的附加成本\n- 尽可能减少死锁产生的概率\n  - 类似业务模块中，尽可能用相同的访问顺序来访问，防止产生死锁\n  - 同一事务中，尽可能一次锁定所有需要的资源\n  - 对于非常容易产生死锁的业务部分，可以尝试升级锁定粒度，通过表级锁定减少死锁产生的概率\n- 系统锁定争用情况的查询\n  - 标记锁定争用状态变量\n  ```\n  mysql> show status like 'table%'\n  variable_name value\n  table_lock_immediate 100  //产生标记锁定次数\n  table_lock_waited 0       //出现标记锁定争用出现的等待的次数\n  ```\n  - 行级锁定争用状态变量\n  ```\n  mysql> show status like 'innodb_row_lock%'\n  innodb_row_lock_current_waits 0   //当前正在等待锁定的数量\n  innodb_row_lock_time 3999999      //从系统启动到现在锁定的总时间长度\n  innodb_row_lock_time_avg 36666    //每次等待所花费平均时间\n  innodb_row_lock_time_max 122222   //从启动到现在等待最长一次所花时间长度\n  innodb_row_lock_waits 20          //从启动到现在共等待的次数\n  ```\n\n## 垂直和水平联合切分的使用\n优点：\n- 充分利用垂直切分和水平切分各自的优势，而避免各自的缺陷\n- 让系统扩展性得到最大提升\n\n缺点：\n- 数据库系统架构比较复杂，使维护难度更大\n- 应用程序架构也相对更复杂\n\n## 合理的设计并利用索引\n### MySQL常用的四种索引类型\n- B-tree索引\n- Hash索引\n- Fulltext索引\n- Rtree索引\n\n### 索引的弊端\n- 增加了更新所带来的IO量，和调整索引导致的计算量\n- 占用存储空间，并会跟数据量的增加而增加\n\n### 如何判断是否需要索引\n- 较频繁作为查询条件的字段应该创建索引\n- 唯一性太差的字段不适合做单独的索引，即使它频繁作为查询条件\n- 更新非常频繁的字段不适合做索引\n- 不会出现在where子句中的字段不适合做索引\n\n### MySQL索引的限制\n- MyISAM存储引擎索引键长度总和长度不能超过1000字节\n- Text和Blob类型的字段只能创建前缀索引\n- 使用不等于（!= 或 <> ）的时候MySQL无法使用索引\n- 过滤字段使用了函数运算后（如，abs（culumn）），MySQL无法使用索引\n- join语句中join条件字段类型不一致不能使用索引\n- 使用LIKE操作的时候，如果条件以通配符开始（如，'%abc'）MySQL无法使用索引\n- 使用非等值查询时，MySQL无法使用索引\n\n## Query的优化\n### 优化更需要优化的query\n高并发低消耗的query（相对）对整个系统的影响远比低并发高消耗的query要大。\n\n### 定位优化对象的性能瓶颈（profiling）\n- IO，数据访问方面\n- CPU，数据运算（如分组、排序）\n\n### 明确优化手段\n优化更偏向与对系统功能比较重要的query\n\n### 从explain入手\n获取一个query在当前状态的数据库中的执行计划\n\n### 多用profile\n\n### 永远用小结果集驱动大结果集\n\n### 尽可能在索引中完成排序\n\n### 只需取出自己需要的column\n\n### 仅适用最有效的过滤条件\nwhere字句中的条件并非越多越好\n\n### 尽可能的避免复杂的join查询和子查询\nquery语句涉及的表越多，需要锁定的资源就越多，所阻塞的其他线程也就越多。\n\n### 其他优化\n\n#### join的实现与优化\njoin是一种算法，即大名鼎鼎的Nested Loop Join。它是通过驱动表的结果集作为循环基础数据，然后一条一条的通过该结果集中的数据作为过滤条件到下一个表中查询数据，然后合并结果。\n\n- 尽可能的Join语句中的Nested Loop的循环次数\n> 最有效的方法只有一个：让驱动表的结果集尽可能的小。即『永远用小结果集驱动大结果集』\n\n- 优先优化Nested Loop的内层循环\n- 保证Join语句中被驱动表上的join字段已经被索引\n- 当无法保证被驱动表join字段被索引且内存充足的前提下，不要太吝啬joinBuffer的设置\n\n#### order by的优化\n- 加大max_length_for_sort_data参数的设置\n- 去掉不必要的返回字段\n- 增大sort_buffer_size参数设置\n\n#### Schema设计优化\n- 范式理论\n- 十度冗余，尽量减少join\n\n#### 大字段垂直拆分\n\n什么样的字段适合\n- 大字段（比如，文章内容、帖子内容、产品的介绍、小说内容等）\n- 表中和其他字段比较，访问明显要少的字段\n\n优点\n- 数据库拆分简单明了，拆分规则明确\n- 应用程序模块清晰明了，整合容易\n- 数据维护方便易行，容易定位\n\n缺点\n- 部分表关联无法在数据库级别完成，需要在程序中完成\n- 对于访问极其频繁且数据量超大的表任然存在性能瓶颈，不一定满足要求\n- 事务处理相对更为复杂\n- 切分达到一定程度后，扩展性会收到限制\n- 过度切分可能会带来系统过度复杂而难以维护\n\n#### 大表水平拆分\n基于类型的分拆优化\n\n优点\n- 表关联基本能在数据库端完成\n- 不会存在某些超大型数据量和高负载的表遇到的瓶颈问题\n- 应用程序端整体架构改动相对较少\n- 事务处理相对简单\n- 只要切分规则能够定义好，基本上较难遇到扩展性限制\n\n缺点\n- 切分规则相对更为复杂，很难抽象出一个能够满足整个数据库的切分规则\n- 后期数据的维护难度有所增加，人为手工定位数据更困难\n- 应用系统各模块耦合度较高，可能会对后面数据的迁移、拆分造成一定困难\n\n\n## MySQL的备份与恢复\n\n备份使用场景\n- 数据丢失应用场景\n  - 人为操作事务造成的某些数据丢失\n  - 如那件Bug造成的数据部分丢失或者全部丢失\n  - 硬件故障造成的数据部分或者全部丢失\n  - 安全漏洞被入侵数据被恶意破坏\n- 非数据丢失应用场景\n  - 特殊应用场景下基于时间点恢复\n  - 开发测试环境数据库搭建\n  - 相同数据库的新环境搭建\n  - 数据库或者数据迁移\n","source":"_posts/大话MySQL性能优化.md","raw":"---\ntitle: 大话MySQL性能优化\ndate: 2016-10-13 18:30:00\ntags:\n- 性能优化\ncategories:\n- MySQL\n---\n\n![MYSQL性能优化](http://n.sinaimg.cn/games/3ece443e/20161013/MySQLXingNenDiaoYou.jpg)\n\n性能是MySQL一直引以为豪的一点。在性能和功能两个方面，MySQL第一考虑的还是性能。\n\n<!-- more -->\n\n## 影响MySQL性能的相关因素\n\n### 商业需求对性能的影响\n对于某一些功能在整个系统中是画蛇添足的，那么这些需求就可能会影响系统性能。比如，一个论坛要求对在线人数进行实时统计。\n\n### 系统架构及实现对性能的影响\n服务器调优\n\n应用程序调优\n- 不可是存储到数据库的数据\n  - 二进制多媒体数据\n  - 流水队列数据\n  - 超大文本数据\n- 合理的利用应用层Cache（适合Cache的数据有：）\n  - 系统的各种配置和规则数据\n  - 活跃用户的基本信息数据\n  - 活跃用户的个性化定制信息数据\n  - 准实时的统计信息\n  - 其他一些访问频繁但变更很少的数据\n- 数据层实现精简\n- 过度依赖数据库SQL语句功能\n- 常见的架构设计不当带来的性能问题和资源浪费\n  - Cache系统设计不合理，导致Cache命中率低下\n  - 过度依赖面向对象\n  - 对可扩展性的过度追求（促使系统设计的时候对象拆分的过于分散，造成系统中出现大量的join语句）\n  - 对数据库的过于依赖（将不适合存储在数据库中的数据存储在数据库中）\n  - 过度理想化系统的用户体验（使大量非核心业务消耗大量系统资源）\n\n### Query语句对性能的影响\n\n#### 分析手段\n- explain\n> 分析选项：\n> - 索引（key），query语句中是用到的索引\n> - row中的rows，查找的记录数\n\n- profiling\n> 先打开profiling；set profiling=1；\n>\n> 查看profiling信息：show profiling \\\\G;\n>\n> show profile CPU,BLOCK IO FOR query 1(2);\n>\n> 分析选项\n> - CPU IO消耗\n\n#### MySQL的锁机制\n> **锁机制的目的：** 保证数据的一致完整性\n>\n> **锁机制的影响：** 直接影响一个数据库系统的并发处理能力和性能\n\n- 行级锁（row-level）\n> **优点：** 锁定对象的粒度最小，发生锁定资源争用的概率就最小，能给予最大可能的并发处理能力。\n>\n> **缺点：** 由于粒度最小，所以每次获得锁和释放锁需要做的工作也最多。带来的消耗也就最大。另外，容易发生死锁。\n\n- 表级锁（table-level）\n> **优点：** 最大粒度的锁定机制。所以逻辑简单，实现也较为容易。获得锁和释放锁的速度也很快。而且能很好的避免死锁问题。\n>\n> **缺点：** 出现锁定资源争用的概率会提高，导致并发处理能力大打折扣。\n\n- 页级锁（page-level）\n> 介于row-level和table-level二者之间。\n\n#### 合理的应用锁机制\n\nMyISAM表锁优化\n> 关键：提高并发度\n\n- 缩短锁定时间，即query的执行时间要尽可能的短\n  - 尽量减少大的、复杂的query，将复杂的query拆分\n  - 尽可能的建立高效索引，使数据的检索更加迅速\n  - 尽量让MySQL的表只存放必要的信息，控制字段类型\n- 分离能并行的操作\n  - 关键：Concurrent insert（并发插入特性）\n  - 打开 Concurrent_insert功能，选项有0，1和2。具体说明如下：\n  - concurrent_insert=2,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都允许在尾部进行concurrent insert操作。\n  - concurrent_insert=1,当MyISAM表数据文件中间部分不存在因删除而留下的空闲空间，可以在尾部进行concurrent insert操作。\n  - concurrent_insert=0,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都不允许在尾部进行concurrent insert操作。\n  - 建议：如果数据删除的肯呢个性很小，则建议将concurrent_insert设置成1，如不在乎浪费少量空间设置成2也可以。但当有少量删除时，设置成1更合适。\n- 读写优先级设置\n  - 默认，写的优先级大于读的优先级\n  - 参数选项，low_priority_updates=1(将写的优先级调低)\n\nInnoDB行锁优化\n- 尽可能让所有的数据检索都通过索引来完成，避免InnoDB因为无法通过索引键加锁升级成为表级锁定\n- 合理设计索引，让InnoDB加锁是尽可能准确，尽可能缩小锁定范围\n- 尽可能的减少基于范围的数据检索过滤条件\n- 尽量控制事务的大小，尽量减少锁定的资源量和锁定的时间长度\n- 尽量使用级别低的事务隔离级别，减少MySQL因为事务隔离带来的附加成本\n- 尽可能减少死锁产生的概率\n  - 类似业务模块中，尽可能用相同的访问顺序来访问，防止产生死锁\n  - 同一事务中，尽可能一次锁定所有需要的资源\n  - 对于非常容易产生死锁的业务部分，可以尝试升级锁定粒度，通过表级锁定减少死锁产生的概率\n- 系统锁定争用情况的查询\n  - 标记锁定争用状态变量\n  ```\n  mysql> show status like 'table%'\n  variable_name value\n  table_lock_immediate 100  //产生标记锁定次数\n  table_lock_waited 0       //出现标记锁定争用出现的等待的次数\n  ```\n  - 行级锁定争用状态变量\n  ```\n  mysql> show status like 'innodb_row_lock%'\n  innodb_row_lock_current_waits 0   //当前正在等待锁定的数量\n  innodb_row_lock_time 3999999      //从系统启动到现在锁定的总时间长度\n  innodb_row_lock_time_avg 36666    //每次等待所花费平均时间\n  innodb_row_lock_time_max 122222   //从启动到现在等待最长一次所花时间长度\n  innodb_row_lock_waits 20          //从启动到现在共等待的次数\n  ```\n\n## 垂直和水平联合切分的使用\n优点：\n- 充分利用垂直切分和水平切分各自的优势，而避免各自的缺陷\n- 让系统扩展性得到最大提升\n\n缺点：\n- 数据库系统架构比较复杂，使维护难度更大\n- 应用程序架构也相对更复杂\n\n## 合理的设计并利用索引\n### MySQL常用的四种索引类型\n- B-tree索引\n- Hash索引\n- Fulltext索引\n- Rtree索引\n\n### 索引的弊端\n- 增加了更新所带来的IO量，和调整索引导致的计算量\n- 占用存储空间，并会跟数据量的增加而增加\n\n### 如何判断是否需要索引\n- 较频繁作为查询条件的字段应该创建索引\n- 唯一性太差的字段不适合做单独的索引，即使它频繁作为查询条件\n- 更新非常频繁的字段不适合做索引\n- 不会出现在where子句中的字段不适合做索引\n\n### MySQL索引的限制\n- MyISAM存储引擎索引键长度总和长度不能超过1000字节\n- Text和Blob类型的字段只能创建前缀索引\n- 使用不等于（!= 或 <> ）的时候MySQL无法使用索引\n- 过滤字段使用了函数运算后（如，abs（culumn）），MySQL无法使用索引\n- join语句中join条件字段类型不一致不能使用索引\n- 使用LIKE操作的时候，如果条件以通配符开始（如，'%abc'）MySQL无法使用索引\n- 使用非等值查询时，MySQL无法使用索引\n\n## Query的优化\n### 优化更需要优化的query\n高并发低消耗的query（相对）对整个系统的影响远比低并发高消耗的query要大。\n\n### 定位优化对象的性能瓶颈（profiling）\n- IO，数据访问方面\n- CPU，数据运算（如分组、排序）\n\n### 明确优化手段\n优化更偏向与对系统功能比较重要的query\n\n### 从explain入手\n获取一个query在当前状态的数据库中的执行计划\n\n### 多用profile\n\n### 永远用小结果集驱动大结果集\n\n### 尽可能在索引中完成排序\n\n### 只需取出自己需要的column\n\n### 仅适用最有效的过滤条件\nwhere字句中的条件并非越多越好\n\n### 尽可能的避免复杂的join查询和子查询\nquery语句涉及的表越多，需要锁定的资源就越多，所阻塞的其他线程也就越多。\n\n### 其他优化\n\n#### join的实现与优化\njoin是一种算法，即大名鼎鼎的Nested Loop Join。它是通过驱动表的结果集作为循环基础数据，然后一条一条的通过该结果集中的数据作为过滤条件到下一个表中查询数据，然后合并结果。\n\n- 尽可能的Join语句中的Nested Loop的循环次数\n> 最有效的方法只有一个：让驱动表的结果集尽可能的小。即『永远用小结果集驱动大结果集』\n\n- 优先优化Nested Loop的内层循环\n- 保证Join语句中被驱动表上的join字段已经被索引\n- 当无法保证被驱动表join字段被索引且内存充足的前提下，不要太吝啬joinBuffer的设置\n\n#### order by的优化\n- 加大max_length_for_sort_data参数的设置\n- 去掉不必要的返回字段\n- 增大sort_buffer_size参数设置\n\n#### Schema设计优化\n- 范式理论\n- 十度冗余，尽量减少join\n\n#### 大字段垂直拆分\n\n什么样的字段适合\n- 大字段（比如，文章内容、帖子内容、产品的介绍、小说内容等）\n- 表中和其他字段比较，访问明显要少的字段\n\n优点\n- 数据库拆分简单明了，拆分规则明确\n- 应用程序模块清晰明了，整合容易\n- 数据维护方便易行，容易定位\n\n缺点\n- 部分表关联无法在数据库级别完成，需要在程序中完成\n- 对于访问极其频繁且数据量超大的表任然存在性能瓶颈，不一定满足要求\n- 事务处理相对更为复杂\n- 切分达到一定程度后，扩展性会收到限制\n- 过度切分可能会带来系统过度复杂而难以维护\n\n#### 大表水平拆分\n基于类型的分拆优化\n\n优点\n- 表关联基本能在数据库端完成\n- 不会存在某些超大型数据量和高负载的表遇到的瓶颈问题\n- 应用程序端整体架构改动相对较少\n- 事务处理相对简单\n- 只要切分规则能够定义好，基本上较难遇到扩展性限制\n\n缺点\n- 切分规则相对更为复杂，很难抽象出一个能够满足整个数据库的切分规则\n- 后期数据的维护难度有所增加，人为手工定位数据更困难\n- 应用系统各模块耦合度较高，可能会对后面数据的迁移、拆分造成一定困难\n\n\n## MySQL的备份与恢复\n\n备份使用场景\n- 数据丢失应用场景\n  - 人为操作事务造成的某些数据丢失\n  - 如那件Bug造成的数据部分丢失或者全部丢失\n  - 硬件故障造成的数据部分或者全部丢失\n  - 安全漏洞被入侵数据被恶意破坏\n- 非数据丢失应用场景\n  - 特殊应用场景下基于时间点恢复\n  - 开发测试环境数据库搭建\n  - 相同数据库的新环境搭建\n  - 数据库或者数据迁移\n","slug":"大话MySQL性能优化","published":1,"updated":"2016-10-13T09:25:46.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwy2004k699fpc1v8dae","content":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161013/MySQLXingNenDiaoYou.jpg\" alt=\"MYSQL性能优化\"></p>\n<p>性能是MySQL一直引以为豪的一点。在性能和功能两个方面，MySQL第一考虑的还是性能。</p>\n<a id=\"more\"></a>\n<h2 id=\"影响MySQL性能的相关因素\"><a href=\"#影响MySQL性能的相关因素\" class=\"headerlink\" title=\"影响MySQL性能的相关因素\"></a>影响MySQL性能的相关因素</h2><h3 id=\"商业需求对性能的影响\"><a href=\"#商业需求对性能的影响\" class=\"headerlink\" title=\"商业需求对性能的影响\"></a>商业需求对性能的影响</h3><p>对于某一些功能在整个系统中是画蛇添足的，那么这些需求就可能会影响系统性能。比如，一个论坛要求对在线人数进行实时统计。</p>\n<h3 id=\"系统架构及实现对性能的影响\"><a href=\"#系统架构及实现对性能的影响\" class=\"headerlink\" title=\"系统架构及实现对性能的影响\"></a>系统架构及实现对性能的影响</h3><p>服务器调优</p>\n<p>应用程序调优</p>\n<ul>\n<li>不可是存储到数据库的数据<ul>\n<li>二进制多媒体数据</li>\n<li>流水队列数据</li>\n<li>超大文本数据</li>\n</ul>\n</li>\n<li>合理的利用应用层Cache（适合Cache的数据有：）<ul>\n<li>系统的各种配置和规则数据</li>\n<li>活跃用户的基本信息数据</li>\n<li>活跃用户的个性化定制信息数据</li>\n<li>准实时的统计信息</li>\n<li>其他一些访问频繁但变更很少的数据</li>\n</ul>\n</li>\n<li>数据层实现精简</li>\n<li>过度依赖数据库SQL语句功能</li>\n<li>常见的架构设计不当带来的性能问题和资源浪费<ul>\n<li>Cache系统设计不合理，导致Cache命中率低下</li>\n<li>过度依赖面向对象</li>\n<li>对可扩展性的过度追求（促使系统设计的时候对象拆分的过于分散，造成系统中出现大量的join语句）</li>\n<li>对数据库的过于依赖（将不适合存储在数据库中的数据存储在数据库中）</li>\n<li>过度理想化系统的用户体验（使大量非核心业务消耗大量系统资源）</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Query语句对性能的影响\"><a href=\"#Query语句对性能的影响\" class=\"headerlink\" title=\"Query语句对性能的影响\"></a>Query语句对性能的影响</h3><h4 id=\"分析手段\"><a href=\"#分析手段\" class=\"headerlink\" title=\"分析手段\"></a>分析手段</h4><ul>\n<li><p>explain</p>\n<blockquote>\n<p>分析选项：</p>\n<ul>\n<li>索引（key），query语句中是用到的索引</li>\n<li>row中的rows，查找的记录数</li>\n</ul>\n</blockquote>\n</li>\n<li><p>profiling</p>\n<blockquote>\n<p>先打开profiling；set profiling=1；</p>\n<p>查看profiling信息：show profiling \\G;</p>\n<p>show profile CPU,BLOCK IO FOR query 1(2);</p>\n<p>分析选项</p>\n<ul>\n<li>CPU IO消耗</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"MySQL的锁机制\"><a href=\"#MySQL的锁机制\" class=\"headerlink\" title=\"MySQL的锁机制\"></a>MySQL的锁机制</h4><blockquote>\n<p><strong>锁机制的目的：</strong> 保证数据的一致完整性</p>\n<p><strong>锁机制的影响：</strong> 直接影响一个数据库系统的并发处理能力和性能</p>\n</blockquote>\n<ul>\n<li><p>行级锁（row-level）</p>\n<blockquote>\n<p><strong>优点：</strong> 锁定对象的粒度最小，发生锁定资源争用的概率就最小，能给予最大可能的并发处理能力。</p>\n<p><strong>缺点：</strong> 由于粒度最小，所以每次获得锁和释放锁需要做的工作也最多。带来的消耗也就最大。另外，容易发生死锁。</p>\n</blockquote>\n</li>\n<li><p>表级锁（table-level）</p>\n<blockquote>\n<p><strong>优点：</strong> 最大粒度的锁定机制。所以逻辑简单，实现也较为容易。获得锁和释放锁的速度也很快。而且能很好的避免死锁问题。</p>\n<p><strong>缺点：</strong> 出现锁定资源争用的概率会提高，导致并发处理能力大打折扣。</p>\n</blockquote>\n</li>\n<li><p>页级锁（page-level）</p>\n<blockquote>\n<p>介于row-level和table-level二者之间。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"合理的应用锁机制\"><a href=\"#合理的应用锁机制\" class=\"headerlink\" title=\"合理的应用锁机制\"></a>合理的应用锁机制</h4><p>MyISAM表锁优化</p>\n<blockquote>\n<p>关键：提高并发度</p>\n</blockquote>\n<ul>\n<li>缩短锁定时间，即query的执行时间要尽可能的短<ul>\n<li>尽量减少大的、复杂的query，将复杂的query拆分</li>\n<li>尽可能的建立高效索引，使数据的检索更加迅速</li>\n<li>尽量让MySQL的表只存放必要的信息，控制字段类型</li>\n</ul>\n</li>\n<li>分离能并行的操作<ul>\n<li>关键：Concurrent insert（并发插入特性）</li>\n<li>打开 Concurrent_insert功能，选项有0，1和2。具体说明如下：</li>\n<li>concurrent_insert=2,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都允许在尾部进行concurrent insert操作。</li>\n<li>concurrent_insert=1,当MyISAM表数据文件中间部分不存在因删除而留下的空闲空间，可以在尾部进行concurrent insert操作。</li>\n<li>concurrent_insert=0,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都不允许在尾部进行concurrent insert操作。</li>\n<li>建议：如果数据删除的肯呢个性很小，则建议将concurrent_insert设置成1，如不在乎浪费少量空间设置成2也可以。但当有少量删除时，设置成1更合适。</li>\n</ul>\n</li>\n<li>读写优先级设置<ul>\n<li>默认，写的优先级大于读的优先级</li>\n<li>参数选项，low_priority_updates=1(将写的优先级调低)</li>\n</ul>\n</li>\n</ul>\n<p>InnoDB行锁优化</p>\n<ul>\n<li>尽可能让所有的数据检索都通过索引来完成，避免InnoDB因为无法通过索引键加锁升级成为表级锁定</li>\n<li>合理设计索引，让InnoDB加锁是尽可能准确，尽可能缩小锁定范围</li>\n<li>尽可能的减少基于范围的数据检索过滤条件</li>\n<li>尽量控制事务的大小，尽量减少锁定的资源量和锁定的时间长度</li>\n<li>尽量使用级别低的事务隔离级别，减少MySQL因为事务隔离带来的附加成本</li>\n<li>尽可能减少死锁产生的概率<ul>\n<li>类似业务模块中，尽可能用相同的访问顺序来访问，防止产生死锁</li>\n<li>同一事务中，尽可能一次锁定所有需要的资源</li>\n<li>对于非常容易产生死锁的业务部分，可以尝试升级锁定粒度，通过表级锁定减少死锁产生的概率</li>\n</ul>\n</li>\n<li><p>系统锁定争用情况的查询</p>\n<ul>\n<li><p>标记锁定争用状态变量</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt; show status like &apos;table%&apos;</div><div class=\"line\">variable_name value</div><div class=\"line\">table_lock_immediate 100  //产生标记锁定次数</div><div class=\"line\">table_lock_waited 0       //出现标记锁定争用出现的等待的次数</div></pre></td></tr></table></figure>\n</li>\n<li><p>行级锁定争用状态变量</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt; show status like &apos;innodb_row_lock%&apos;</div><div class=\"line\">innodb_row_lock_current_waits 0   //当前正在等待锁定的数量</div><div class=\"line\">innodb_row_lock_time 3999999      //从系统启动到现在锁定的总时间长度</div><div class=\"line\">innodb_row_lock_time_avg 36666    //每次等待所花费平均时间</div><div class=\"line\">innodb_row_lock_time_max 122222   //从启动到现在等待最长一次所花时间长度</div><div class=\"line\">innodb_row_lock_waits 20          //从启动到现在共等待的次数</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"垂直和水平联合切分的使用\"><a href=\"#垂直和水平联合切分的使用\" class=\"headerlink\" title=\"垂直和水平联合切分的使用\"></a>垂直和水平联合切分的使用</h2><p>优点：</p>\n<ul>\n<li>充分利用垂直切分和水平切分各自的优势，而避免各自的缺陷</li>\n<li>让系统扩展性得到最大提升</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>数据库系统架构比较复杂，使维护难度更大</li>\n<li>应用程序架构也相对更复杂</li>\n</ul>\n<h2 id=\"合理的设计并利用索引\"><a href=\"#合理的设计并利用索引\" class=\"headerlink\" title=\"合理的设计并利用索引\"></a>合理的设计并利用索引</h2><h3 id=\"MySQL常用的四种索引类型\"><a href=\"#MySQL常用的四种索引类型\" class=\"headerlink\" title=\"MySQL常用的四种索引类型\"></a>MySQL常用的四种索引类型</h3><ul>\n<li>B-tree索引</li>\n<li>Hash索引</li>\n<li>Fulltext索引</li>\n<li>Rtree索引</li>\n</ul>\n<h3 id=\"索引的弊端\"><a href=\"#索引的弊端\" class=\"headerlink\" title=\"索引的弊端\"></a>索引的弊端</h3><ul>\n<li>增加了更新所带来的IO量，和调整索引导致的计算量</li>\n<li>占用存储空间，并会跟数据量的增加而增加</li>\n</ul>\n<h3 id=\"如何判断是否需要索引\"><a href=\"#如何判断是否需要索引\" class=\"headerlink\" title=\"如何判断是否需要索引\"></a>如何判断是否需要索引</h3><ul>\n<li>较频繁作为查询条件的字段应该创建索引</li>\n<li>唯一性太差的字段不适合做单独的索引，即使它频繁作为查询条件</li>\n<li>更新非常频繁的字段不适合做索引</li>\n<li>不会出现在where子句中的字段不适合做索引</li>\n</ul>\n<h3 id=\"MySQL索引的限制\"><a href=\"#MySQL索引的限制\" class=\"headerlink\" title=\"MySQL索引的限制\"></a>MySQL索引的限制</h3><ul>\n<li>MyISAM存储引擎索引键长度总和长度不能超过1000字节</li>\n<li>Text和Blob类型的字段只能创建前缀索引</li>\n<li>使用不等于（!= 或 &lt;&gt; ）的时候MySQL无法使用索引</li>\n<li>过滤字段使用了函数运算后（如，abs（culumn）），MySQL无法使用索引</li>\n<li>join语句中join条件字段类型不一致不能使用索引</li>\n<li>使用LIKE操作的时候，如果条件以通配符开始（如，’%abc’）MySQL无法使用索引</li>\n<li>使用非等值查询时，MySQL无法使用索引</li>\n</ul>\n<h2 id=\"Query的优化\"><a href=\"#Query的优化\" class=\"headerlink\" title=\"Query的优化\"></a>Query的优化</h2><h3 id=\"优化更需要优化的query\"><a href=\"#优化更需要优化的query\" class=\"headerlink\" title=\"优化更需要优化的query\"></a>优化更需要优化的query</h3><p>高并发低消耗的query（相对）对整个系统的影响远比低并发高消耗的query要大。</p>\n<h3 id=\"定位优化对象的性能瓶颈（profiling）\"><a href=\"#定位优化对象的性能瓶颈（profiling）\" class=\"headerlink\" title=\"定位优化对象的性能瓶颈（profiling）\"></a>定位优化对象的性能瓶颈（profiling）</h3><ul>\n<li>IO，数据访问方面</li>\n<li>CPU，数据运算（如分组、排序）</li>\n</ul>\n<h3 id=\"明确优化手段\"><a href=\"#明确优化手段\" class=\"headerlink\" title=\"明确优化手段\"></a>明确优化手段</h3><p>优化更偏向与对系统功能比较重要的query</p>\n<h3 id=\"从explain入手\"><a href=\"#从explain入手\" class=\"headerlink\" title=\"从explain入手\"></a>从explain入手</h3><p>获取一个query在当前状态的数据库中的执行计划</p>\n<h3 id=\"多用profile\"><a href=\"#多用profile\" class=\"headerlink\" title=\"多用profile\"></a>多用profile</h3><h3 id=\"永远用小结果集驱动大结果集\"><a href=\"#永远用小结果集驱动大结果集\" class=\"headerlink\" title=\"永远用小结果集驱动大结果集\"></a>永远用小结果集驱动大结果集</h3><h3 id=\"尽可能在索引中完成排序\"><a href=\"#尽可能在索引中完成排序\" class=\"headerlink\" title=\"尽可能在索引中完成排序\"></a>尽可能在索引中完成排序</h3><h3 id=\"只需取出自己需要的column\"><a href=\"#只需取出自己需要的column\" class=\"headerlink\" title=\"只需取出自己需要的column\"></a>只需取出自己需要的column</h3><h3 id=\"仅适用最有效的过滤条件\"><a href=\"#仅适用最有效的过滤条件\" class=\"headerlink\" title=\"仅适用最有效的过滤条件\"></a>仅适用最有效的过滤条件</h3><p>where字句中的条件并非越多越好</p>\n<h3 id=\"尽可能的避免复杂的join查询和子查询\"><a href=\"#尽可能的避免复杂的join查询和子查询\" class=\"headerlink\" title=\"尽可能的避免复杂的join查询和子查询\"></a>尽可能的避免复杂的join查询和子查询</h3><p>query语句涉及的表越多，需要锁定的资源就越多，所阻塞的其他线程也就越多。</p>\n<h3 id=\"其他优化\"><a href=\"#其他优化\" class=\"headerlink\" title=\"其他优化\"></a>其他优化</h3><h4 id=\"join的实现与优化\"><a href=\"#join的实现与优化\" class=\"headerlink\" title=\"join的实现与优化\"></a>join的实现与优化</h4><p>join是一种算法，即大名鼎鼎的Nested Loop Join。它是通过驱动表的结果集作为循环基础数据，然后一条一条的通过该结果集中的数据作为过滤条件到下一个表中查询数据，然后合并结果。</p>\n<ul>\n<li><p>尽可能的Join语句中的Nested Loop的循环次数</p>\n<blockquote>\n<p>最有效的方法只有一个：让驱动表的结果集尽可能的小。即『永远用小结果集驱动大结果集』</p>\n</blockquote>\n</li>\n<li><p>优先优化Nested Loop的内层循环</p>\n</li>\n<li>保证Join语句中被驱动表上的join字段已经被索引</li>\n<li>当无法保证被驱动表join字段被索引且内存充足的前提下，不要太吝啬joinBuffer的设置</li>\n</ul>\n<h4 id=\"order-by的优化\"><a href=\"#order-by的优化\" class=\"headerlink\" title=\"order by的优化\"></a>order by的优化</h4><ul>\n<li>加大max_length_for_sort_data参数的设置</li>\n<li>去掉不必要的返回字段</li>\n<li>增大sort_buffer_size参数设置</li>\n</ul>\n<h4 id=\"Schema设计优化\"><a href=\"#Schema设计优化\" class=\"headerlink\" title=\"Schema设计优化\"></a>Schema设计优化</h4><ul>\n<li>范式理论</li>\n<li>十度冗余，尽量减少join</li>\n</ul>\n<h4 id=\"大字段垂直拆分\"><a href=\"#大字段垂直拆分\" class=\"headerlink\" title=\"大字段垂直拆分\"></a>大字段垂直拆分</h4><p>什么样的字段适合</p>\n<ul>\n<li>大字段（比如，文章内容、帖子内容、产品的介绍、小说内容等）</li>\n<li>表中和其他字段比较，访问明显要少的字段</li>\n</ul>\n<p>优点</p>\n<ul>\n<li>数据库拆分简单明了，拆分规则明确</li>\n<li>应用程序模块清晰明了，整合容易</li>\n<li>数据维护方便易行，容易定位</li>\n</ul>\n<p>缺点</p>\n<ul>\n<li>部分表关联无法在数据库级别完成，需要在程序中完成</li>\n<li>对于访问极其频繁且数据量超大的表任然存在性能瓶颈，不一定满足要求</li>\n<li>事务处理相对更为复杂</li>\n<li>切分达到一定程度后，扩展性会收到限制</li>\n<li>过度切分可能会带来系统过度复杂而难以维护</li>\n</ul>\n<h4 id=\"大表水平拆分\"><a href=\"#大表水平拆分\" class=\"headerlink\" title=\"大表水平拆分\"></a>大表水平拆分</h4><p>基于类型的分拆优化</p>\n<p>优点</p>\n<ul>\n<li>表关联基本能在数据库端完成</li>\n<li>不会存在某些超大型数据量和高负载的表遇到的瓶颈问题</li>\n<li>应用程序端整体架构改动相对较少</li>\n<li>事务处理相对简单</li>\n<li>只要切分规则能够定义好，基本上较难遇到扩展性限制</li>\n</ul>\n<p>缺点</p>\n<ul>\n<li>切分规则相对更为复杂，很难抽象出一个能够满足整个数据库的切分规则</li>\n<li>后期数据的维护难度有所增加，人为手工定位数据更困难</li>\n<li>应用系统各模块耦合度较高，可能会对后面数据的迁移、拆分造成一定困难</li>\n</ul>\n<h2 id=\"MySQL的备份与恢复\"><a href=\"#MySQL的备份与恢复\" class=\"headerlink\" title=\"MySQL的备份与恢复\"></a>MySQL的备份与恢复</h2><p>备份使用场景</p>\n<ul>\n<li>数据丢失应用场景<ul>\n<li>人为操作事务造成的某些数据丢失</li>\n<li>如那件Bug造成的数据部分丢失或者全部丢失</li>\n<li>硬件故障造成的数据部分或者全部丢失</li>\n<li>安全漏洞被入侵数据被恶意破坏</li>\n</ul>\n</li>\n<li>非数据丢失应用场景<ul>\n<li>特殊应用场景下基于时间点恢复</li>\n<li>开发测试环境数据库搭建</li>\n<li>相同数据库的新环境搭建</li>\n<li>数据库或者数据迁移</li>\n</ul>\n</li>\n</ul>\n","excerpt":"<p><img src=\"http://n.sinaimg.cn/games/3ece443e/20161013/MySQLXingNenDiaoYou.jpg\" alt=\"MYSQL性能优化\"></p>\n<p>性能是MySQL一直引以为豪的一点。在性能和功能两个方面，MySQL第一考虑的还是性能。</p>","more":"<h2 id=\"影响MySQL性能的相关因素\"><a href=\"#影响MySQL性能的相关因素\" class=\"headerlink\" title=\"影响MySQL性能的相关因素\"></a>影响MySQL性能的相关因素</h2><h3 id=\"商业需求对性能的影响\"><a href=\"#商业需求对性能的影响\" class=\"headerlink\" title=\"商业需求对性能的影响\"></a>商业需求对性能的影响</h3><p>对于某一些功能在整个系统中是画蛇添足的，那么这些需求就可能会影响系统性能。比如，一个论坛要求对在线人数进行实时统计。</p>\n<h3 id=\"系统架构及实现对性能的影响\"><a href=\"#系统架构及实现对性能的影响\" class=\"headerlink\" title=\"系统架构及实现对性能的影响\"></a>系统架构及实现对性能的影响</h3><p>服务器调优</p>\n<p>应用程序调优</p>\n<ul>\n<li>不可是存储到数据库的数据<ul>\n<li>二进制多媒体数据</li>\n<li>流水队列数据</li>\n<li>超大文本数据</li>\n</ul>\n</li>\n<li>合理的利用应用层Cache（适合Cache的数据有：）<ul>\n<li>系统的各种配置和规则数据</li>\n<li>活跃用户的基本信息数据</li>\n<li>活跃用户的个性化定制信息数据</li>\n<li>准实时的统计信息</li>\n<li>其他一些访问频繁但变更很少的数据</li>\n</ul>\n</li>\n<li>数据层实现精简</li>\n<li>过度依赖数据库SQL语句功能</li>\n<li>常见的架构设计不当带来的性能问题和资源浪费<ul>\n<li>Cache系统设计不合理，导致Cache命中率低下</li>\n<li>过度依赖面向对象</li>\n<li>对可扩展性的过度追求（促使系统设计的时候对象拆分的过于分散，造成系统中出现大量的join语句）</li>\n<li>对数据库的过于依赖（将不适合存储在数据库中的数据存储在数据库中）</li>\n<li>过度理想化系统的用户体验（使大量非核心业务消耗大量系统资源）</li>\n</ul>\n</li>\n</ul>\n<h3 id=\"Query语句对性能的影响\"><a href=\"#Query语句对性能的影响\" class=\"headerlink\" title=\"Query语句对性能的影响\"></a>Query语句对性能的影响</h3><h4 id=\"分析手段\"><a href=\"#分析手段\" class=\"headerlink\" title=\"分析手段\"></a>分析手段</h4><ul>\n<li><p>explain</p>\n<blockquote>\n<p>分析选项：</p>\n<ul>\n<li>索引（key），query语句中是用到的索引</li>\n<li>row中的rows，查找的记录数</li>\n</ul>\n</blockquote>\n</li>\n<li><p>profiling</p>\n<blockquote>\n<p>先打开profiling；set profiling=1；</p>\n<p>查看profiling信息：show profiling \\G;</p>\n<p>show profile CPU,BLOCK IO FOR query 1(2);</p>\n<p>分析选项</p>\n<ul>\n<li>CPU IO消耗</li>\n</ul>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"MySQL的锁机制\"><a href=\"#MySQL的锁机制\" class=\"headerlink\" title=\"MySQL的锁机制\"></a>MySQL的锁机制</h4><blockquote>\n<p><strong>锁机制的目的：</strong> 保证数据的一致完整性</p>\n<p><strong>锁机制的影响：</strong> 直接影响一个数据库系统的并发处理能力和性能</p>\n</blockquote>\n<ul>\n<li><p>行级锁（row-level）</p>\n<blockquote>\n<p><strong>优点：</strong> 锁定对象的粒度最小，发生锁定资源争用的概率就最小，能给予最大可能的并发处理能力。</p>\n<p><strong>缺点：</strong> 由于粒度最小，所以每次获得锁和释放锁需要做的工作也最多。带来的消耗也就最大。另外，容易发生死锁。</p>\n</blockquote>\n</li>\n<li><p>表级锁（table-level）</p>\n<blockquote>\n<p><strong>优点：</strong> 最大粒度的锁定机制。所以逻辑简单，实现也较为容易。获得锁和释放锁的速度也很快。而且能很好的避免死锁问题。</p>\n<p><strong>缺点：</strong> 出现锁定资源争用的概率会提高，导致并发处理能力大打折扣。</p>\n</blockquote>\n</li>\n<li><p>页级锁（page-level）</p>\n<blockquote>\n<p>介于row-level和table-level二者之间。</p>\n</blockquote>\n</li>\n</ul>\n<h4 id=\"合理的应用锁机制\"><a href=\"#合理的应用锁机制\" class=\"headerlink\" title=\"合理的应用锁机制\"></a>合理的应用锁机制</h4><p>MyISAM表锁优化</p>\n<blockquote>\n<p>关键：提高并发度</p>\n</blockquote>\n<ul>\n<li>缩短锁定时间，即query的执行时间要尽可能的短<ul>\n<li>尽量减少大的、复杂的query，将复杂的query拆分</li>\n<li>尽可能的建立高效索引，使数据的检索更加迅速</li>\n<li>尽量让MySQL的表只存放必要的信息，控制字段类型</li>\n</ul>\n</li>\n<li>分离能并行的操作<ul>\n<li>关键：Concurrent insert（并发插入特性）</li>\n<li>打开 Concurrent_insert功能，选项有0，1和2。具体说明如下：</li>\n<li>concurrent_insert=2,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都允许在尾部进行concurrent insert操作。</li>\n<li>concurrent_insert=1,当MyISAM表数据文件中间部分不存在因删除而留下的空闲空间，可以在尾部进行concurrent insert操作。</li>\n<li>concurrent_insert=0,无论MyISAM表数据文件中间部分是否存在因删除而留下的空闲空间，都不允许在尾部进行concurrent insert操作。</li>\n<li>建议：如果数据删除的肯呢个性很小，则建议将concurrent_insert设置成1，如不在乎浪费少量空间设置成2也可以。但当有少量删除时，设置成1更合适。</li>\n</ul>\n</li>\n<li>读写优先级设置<ul>\n<li>默认，写的优先级大于读的优先级</li>\n<li>参数选项，low_priority_updates=1(将写的优先级调低)</li>\n</ul>\n</li>\n</ul>\n<p>InnoDB行锁优化</p>\n<ul>\n<li>尽可能让所有的数据检索都通过索引来完成，避免InnoDB因为无法通过索引键加锁升级成为表级锁定</li>\n<li>合理设计索引，让InnoDB加锁是尽可能准确，尽可能缩小锁定范围</li>\n<li>尽可能的减少基于范围的数据检索过滤条件</li>\n<li>尽量控制事务的大小，尽量减少锁定的资源量和锁定的时间长度</li>\n<li>尽量使用级别低的事务隔离级别，减少MySQL因为事务隔离带来的附加成本</li>\n<li>尽可能减少死锁产生的概率<ul>\n<li>类似业务模块中，尽可能用相同的访问顺序来访问，防止产生死锁</li>\n<li>同一事务中，尽可能一次锁定所有需要的资源</li>\n<li>对于非常容易产生死锁的业务部分，可以尝试升级锁定粒度，通过表级锁定减少死锁产生的概率</li>\n</ul>\n</li>\n<li><p>系统锁定争用情况的查询</p>\n<ul>\n<li><p>标记锁定争用状态变量</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt; show status like &apos;table%&apos;</div><div class=\"line\">variable_name value</div><div class=\"line\">table_lock_immediate 100  //产生标记锁定次数</div><div class=\"line\">table_lock_waited 0       //出现标记锁定争用出现的等待的次数</div></pre></td></tr></table></figure>\n</li>\n<li><p>行级锁定争用状态变量</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div></pre></td><td class=\"code\"><pre><div class=\"line\">mysql&gt; show status like &apos;innodb_row_lock%&apos;</div><div class=\"line\">innodb_row_lock_current_waits 0   //当前正在等待锁定的数量</div><div class=\"line\">innodb_row_lock_time 3999999      //从系统启动到现在锁定的总时间长度</div><div class=\"line\">innodb_row_lock_time_avg 36666    //每次等待所花费平均时间</div><div class=\"line\">innodb_row_lock_time_max 122222   //从启动到现在等待最长一次所花时间长度</div><div class=\"line\">innodb_row_lock_waits 20          //从启动到现在共等待的次数</div></pre></td></tr></table></figure>\n</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"垂直和水平联合切分的使用\"><a href=\"#垂直和水平联合切分的使用\" class=\"headerlink\" title=\"垂直和水平联合切分的使用\"></a>垂直和水平联合切分的使用</h2><p>优点：</p>\n<ul>\n<li>充分利用垂直切分和水平切分各自的优势，而避免各自的缺陷</li>\n<li>让系统扩展性得到最大提升</li>\n</ul>\n<p>缺点：</p>\n<ul>\n<li>数据库系统架构比较复杂，使维护难度更大</li>\n<li>应用程序架构也相对更复杂</li>\n</ul>\n<h2 id=\"合理的设计并利用索引\"><a href=\"#合理的设计并利用索引\" class=\"headerlink\" title=\"合理的设计并利用索引\"></a>合理的设计并利用索引</h2><h3 id=\"MySQL常用的四种索引类型\"><a href=\"#MySQL常用的四种索引类型\" class=\"headerlink\" title=\"MySQL常用的四种索引类型\"></a>MySQL常用的四种索引类型</h3><ul>\n<li>B-tree索引</li>\n<li>Hash索引</li>\n<li>Fulltext索引</li>\n<li>Rtree索引</li>\n</ul>\n<h3 id=\"索引的弊端\"><a href=\"#索引的弊端\" class=\"headerlink\" title=\"索引的弊端\"></a>索引的弊端</h3><ul>\n<li>增加了更新所带来的IO量，和调整索引导致的计算量</li>\n<li>占用存储空间，并会跟数据量的增加而增加</li>\n</ul>\n<h3 id=\"如何判断是否需要索引\"><a href=\"#如何判断是否需要索引\" class=\"headerlink\" title=\"如何判断是否需要索引\"></a>如何判断是否需要索引</h3><ul>\n<li>较频繁作为查询条件的字段应该创建索引</li>\n<li>唯一性太差的字段不适合做单独的索引，即使它频繁作为查询条件</li>\n<li>更新非常频繁的字段不适合做索引</li>\n<li>不会出现在where子句中的字段不适合做索引</li>\n</ul>\n<h3 id=\"MySQL索引的限制\"><a href=\"#MySQL索引的限制\" class=\"headerlink\" title=\"MySQL索引的限制\"></a>MySQL索引的限制</h3><ul>\n<li>MyISAM存储引擎索引键长度总和长度不能超过1000字节</li>\n<li>Text和Blob类型的字段只能创建前缀索引</li>\n<li>使用不等于（!= 或 &lt;&gt; ）的时候MySQL无法使用索引</li>\n<li>过滤字段使用了函数运算后（如，abs（culumn）），MySQL无法使用索引</li>\n<li>join语句中join条件字段类型不一致不能使用索引</li>\n<li>使用LIKE操作的时候，如果条件以通配符开始（如，’%abc’）MySQL无法使用索引</li>\n<li>使用非等值查询时，MySQL无法使用索引</li>\n</ul>\n<h2 id=\"Query的优化\"><a href=\"#Query的优化\" class=\"headerlink\" title=\"Query的优化\"></a>Query的优化</h2><h3 id=\"优化更需要优化的query\"><a href=\"#优化更需要优化的query\" class=\"headerlink\" title=\"优化更需要优化的query\"></a>优化更需要优化的query</h3><p>高并发低消耗的query（相对）对整个系统的影响远比低并发高消耗的query要大。</p>\n<h3 id=\"定位优化对象的性能瓶颈（profiling）\"><a href=\"#定位优化对象的性能瓶颈（profiling）\" class=\"headerlink\" title=\"定位优化对象的性能瓶颈（profiling）\"></a>定位优化对象的性能瓶颈（profiling）</h3><ul>\n<li>IO，数据访问方面</li>\n<li>CPU，数据运算（如分组、排序）</li>\n</ul>\n<h3 id=\"明确优化手段\"><a href=\"#明确优化手段\" class=\"headerlink\" title=\"明确优化手段\"></a>明确优化手段</h3><p>优化更偏向与对系统功能比较重要的query</p>\n<h3 id=\"从explain入手\"><a href=\"#从explain入手\" class=\"headerlink\" title=\"从explain入手\"></a>从explain入手</h3><p>获取一个query在当前状态的数据库中的执行计划</p>\n<h3 id=\"多用profile\"><a href=\"#多用profile\" class=\"headerlink\" title=\"多用profile\"></a>多用profile</h3><h3 id=\"永远用小结果集驱动大结果集\"><a href=\"#永远用小结果集驱动大结果集\" class=\"headerlink\" title=\"永远用小结果集驱动大结果集\"></a>永远用小结果集驱动大结果集</h3><h3 id=\"尽可能在索引中完成排序\"><a href=\"#尽可能在索引中完成排序\" class=\"headerlink\" title=\"尽可能在索引中完成排序\"></a>尽可能在索引中完成排序</h3><h3 id=\"只需取出自己需要的column\"><a href=\"#只需取出自己需要的column\" class=\"headerlink\" title=\"只需取出自己需要的column\"></a>只需取出自己需要的column</h3><h3 id=\"仅适用最有效的过滤条件\"><a href=\"#仅适用最有效的过滤条件\" class=\"headerlink\" title=\"仅适用最有效的过滤条件\"></a>仅适用最有效的过滤条件</h3><p>where字句中的条件并非越多越好</p>\n<h3 id=\"尽可能的避免复杂的join查询和子查询\"><a href=\"#尽可能的避免复杂的join查询和子查询\" class=\"headerlink\" title=\"尽可能的避免复杂的join查询和子查询\"></a>尽可能的避免复杂的join查询和子查询</h3><p>query语句涉及的表越多，需要锁定的资源就越多，所阻塞的其他线程也就越多。</p>\n<h3 id=\"其他优化\"><a href=\"#其他优化\" class=\"headerlink\" title=\"其他优化\"></a>其他优化</h3><h4 id=\"join的实现与优化\"><a href=\"#join的实现与优化\" class=\"headerlink\" title=\"join的实现与优化\"></a>join的实现与优化</h4><p>join是一种算法，即大名鼎鼎的Nested Loop Join。它是通过驱动表的结果集作为循环基础数据，然后一条一条的通过该结果集中的数据作为过滤条件到下一个表中查询数据，然后合并结果。</p>\n<ul>\n<li><p>尽可能的Join语句中的Nested Loop的循环次数</p>\n<blockquote>\n<p>最有效的方法只有一个：让驱动表的结果集尽可能的小。即『永远用小结果集驱动大结果集』</p>\n</blockquote>\n</li>\n<li><p>优先优化Nested Loop的内层循环</p>\n</li>\n<li>保证Join语句中被驱动表上的join字段已经被索引</li>\n<li>当无法保证被驱动表join字段被索引且内存充足的前提下，不要太吝啬joinBuffer的设置</li>\n</ul>\n<h4 id=\"order-by的优化\"><a href=\"#order-by的优化\" class=\"headerlink\" title=\"order by的优化\"></a>order by的优化</h4><ul>\n<li>加大max_length_for_sort_data参数的设置</li>\n<li>去掉不必要的返回字段</li>\n<li>增大sort_buffer_size参数设置</li>\n</ul>\n<h4 id=\"Schema设计优化\"><a href=\"#Schema设计优化\" class=\"headerlink\" title=\"Schema设计优化\"></a>Schema设计优化</h4><ul>\n<li>范式理论</li>\n<li>十度冗余，尽量减少join</li>\n</ul>\n<h4 id=\"大字段垂直拆分\"><a href=\"#大字段垂直拆分\" class=\"headerlink\" title=\"大字段垂直拆分\"></a>大字段垂直拆分</h4><p>什么样的字段适合</p>\n<ul>\n<li>大字段（比如，文章内容、帖子内容、产品的介绍、小说内容等）</li>\n<li>表中和其他字段比较，访问明显要少的字段</li>\n</ul>\n<p>优点</p>\n<ul>\n<li>数据库拆分简单明了，拆分规则明确</li>\n<li>应用程序模块清晰明了，整合容易</li>\n<li>数据维护方便易行，容易定位</li>\n</ul>\n<p>缺点</p>\n<ul>\n<li>部分表关联无法在数据库级别完成，需要在程序中完成</li>\n<li>对于访问极其频繁且数据量超大的表任然存在性能瓶颈，不一定满足要求</li>\n<li>事务处理相对更为复杂</li>\n<li>切分达到一定程度后，扩展性会收到限制</li>\n<li>过度切分可能会带来系统过度复杂而难以维护</li>\n</ul>\n<h4 id=\"大表水平拆分\"><a href=\"#大表水平拆分\" class=\"headerlink\" title=\"大表水平拆分\"></a>大表水平拆分</h4><p>基于类型的分拆优化</p>\n<p>优点</p>\n<ul>\n<li>表关联基本能在数据库端完成</li>\n<li>不会存在某些超大型数据量和高负载的表遇到的瓶颈问题</li>\n<li>应用程序端整体架构改动相对较少</li>\n<li>事务处理相对简单</li>\n<li>只要切分规则能够定义好，基本上较难遇到扩展性限制</li>\n</ul>\n<p>缺点</p>\n<ul>\n<li>切分规则相对更为复杂，很难抽象出一个能够满足整个数据库的切分规则</li>\n<li>后期数据的维护难度有所增加，人为手工定位数据更困难</li>\n<li>应用系统各模块耦合度较高，可能会对后面数据的迁移、拆分造成一定困难</li>\n</ul>\n<h2 id=\"MySQL的备份与恢复\"><a href=\"#MySQL的备份与恢复\" class=\"headerlink\" title=\"MySQL的备份与恢复\"></a>MySQL的备份与恢复</h2><p>备份使用场景</p>\n<ul>\n<li>数据丢失应用场景<ul>\n<li>人为操作事务造成的某些数据丢失</li>\n<li>如那件Bug造成的数据部分丢失或者全部丢失</li>\n<li>硬件故障造成的数据部分或者全部丢失</li>\n<li>安全漏洞被入侵数据被恶意破坏</li>\n</ul>\n</li>\n<li>非数据丢失应用场景<ul>\n<li>特殊应用场景下基于时间点恢复</li>\n<li>开发测试环境数据库搭建</li>\n<li>相同数据库的新环境搭建</li>\n<li>数据库或者数据迁移</li>\n</ul>\n</li>\n</ul>"},{"title":"面向对象三大特性五大基本原则","date":"2016-08-22T13:30:00.000Z","_content":"\n透切理解面向对象三大基本特性是理解面向对象五大基本原则的基础.\n\n<!-- more -->\n\n## 三大特性\n\n### 封装\n所谓封装，也就是把客观事物封装成抽象的类，并且类可以把自己的数据和方法只让可信的类或者对象操作，对不可信的进行信息隐藏。\n\n封装是面向对象的特征之一，是对象和类概念的主要特性。\n\n简单的说，一个类就是一个封装了数据以及操作这些数据的代码的逻辑实体。在一个对象内部，某些代码或某些数据可以是私有的，不能被外界访问。\n\n通过这种方式，对象对内部数据提供了不同级别的保护，以防止程序中无关的部分意外的改变或错误的使用了对象的私有部分。\n\n### 继承\n\n所谓继承是指可以让某个类型的对象获得另一个类型的对象的属性的方法。它支持按级分类的概念。\n\n继承是指这样一种能力：它可以使用现有类的所有功能，并在无需重新编写原来的类的情况下对这些功能进行扩展。\n\n通过继承创建的新类称为“子类”或“派生类”，被继承的类称为“基类”、“父类”或“超类”。\n\n继承的过程，就是从一般到特殊的过程。\n\n要实现继承，可以通过“继承”（Inheritance）和“组合”（Composition）来实现。\n\n继承概念的实现方式有二类：实现继承与接口继承。\n- 实现继承是指直接使用基类的属性和方法而无需额外编码的能力；\n- 接口继承是指仅使用属性和方法的名称、但是子类必须提供实现的能力；\n\n\n### 多态\n所谓多态就是指一个类实例的相同方法在不同情形有不同表现形式。\n多态机制使具有不同内部结构的对象可以共享相同的外部接口。\n\n这意味着，虽然针对不同对象的具体操作不同，但通过一个公共的类，它们（那些操作）可以通过相同的方式予以调用。\n\n\n## 五大基本原则\n\n### 单一职责原则SRP(Single Responsibility Principle)\n是指一个类的功能要单一，不能包罗万象。如同一个人一样，分配的工作不能太多，否则一天到晚虽然忙忙碌碌的，但效率却高不起来。\n\n### 开放封闭原则OCP(Open－Close Principle)\n一个模块在扩展性方面应该是开放的而在更改性方面应该是封闭的。\n\n比如：一个网络模块，原来只服务端功能，而现在要加入客户端功能，\n那么应当在不用修改服务端功能代码的前提下，就能够增加客户端功能的实现代码，这要求在设计之初，就应当将服务端和客户端分开，公共部分抽象出来。\n\n### 替换原则(the Liskov Substitution Principle LSP)\n子类应当可以替换父类并出现在父类能够出现的任何地方。\n\n比如：公司搞年度晚会，所有员工可以参加抽奖，那么不管是老员工还是新员工，\n也不管是总部员工还是外派员工，都应当可以参加抽奖，否则这公司就不和谐了。\n\n### 依赖原则(the Dependency Inversion Principle DIP)\n具体依赖抽象，上层依赖下层。假设B是较A低的模块，但B需要使用到A的功能，\n\n这个时候，B不应当直接使用A中的具体类： 而应当由B定义一抽象接口，并由A来实现这个抽象接口，B只使用这个抽象接口：这样就达到\n了依赖倒置的目的，B也解除了对A的依赖，反过来是A依赖于B定义的抽象接口。\n\n通过上层模块难以避免依赖下层模块，假如B也直接依赖A的实现，那么就可能造成循环依赖。\n\n一个常见的问题就是编译A模块时需要直接包含到B模块的cpp文件，而编译B时同样要直接包含到A的cpp文件。\n\n### 接口分离原则(the Interface Segregation Principle ISP)\n模块间要通过抽象接口隔离开，而不是通过具体的类强耦合起来\n\n\n转自：http://www.cnblogs.com/hnrainll/\n","source":"_posts/面向对象三大特性五大基本原则.md","raw":"---\ntitle: 面向对象三大特性五大基本原则\ndate: 2016-08-22 21:30:00\ncategories:\n- PHP\n---\n\n透切理解面向对象三大基本特性是理解面向对象五大基本原则的基础.\n\n<!-- more -->\n\n## 三大特性\n\n### 封装\n所谓封装，也就是把客观事物封装成抽象的类，并且类可以把自己的数据和方法只让可信的类或者对象操作，对不可信的进行信息隐藏。\n\n封装是面向对象的特征之一，是对象和类概念的主要特性。\n\n简单的说，一个类就是一个封装了数据以及操作这些数据的代码的逻辑实体。在一个对象内部，某些代码或某些数据可以是私有的，不能被外界访问。\n\n通过这种方式，对象对内部数据提供了不同级别的保护，以防止程序中无关的部分意外的改变或错误的使用了对象的私有部分。\n\n### 继承\n\n所谓继承是指可以让某个类型的对象获得另一个类型的对象的属性的方法。它支持按级分类的概念。\n\n继承是指这样一种能力：它可以使用现有类的所有功能，并在无需重新编写原来的类的情况下对这些功能进行扩展。\n\n通过继承创建的新类称为“子类”或“派生类”，被继承的类称为“基类”、“父类”或“超类”。\n\n继承的过程，就是从一般到特殊的过程。\n\n要实现继承，可以通过“继承”（Inheritance）和“组合”（Composition）来实现。\n\n继承概念的实现方式有二类：实现继承与接口继承。\n- 实现继承是指直接使用基类的属性和方法而无需额外编码的能力；\n- 接口继承是指仅使用属性和方法的名称、但是子类必须提供实现的能力；\n\n\n### 多态\n所谓多态就是指一个类实例的相同方法在不同情形有不同表现形式。\n多态机制使具有不同内部结构的对象可以共享相同的外部接口。\n\n这意味着，虽然针对不同对象的具体操作不同，但通过一个公共的类，它们（那些操作）可以通过相同的方式予以调用。\n\n\n## 五大基本原则\n\n### 单一职责原则SRP(Single Responsibility Principle)\n是指一个类的功能要单一，不能包罗万象。如同一个人一样，分配的工作不能太多，否则一天到晚虽然忙忙碌碌的，但效率却高不起来。\n\n### 开放封闭原则OCP(Open－Close Principle)\n一个模块在扩展性方面应该是开放的而在更改性方面应该是封闭的。\n\n比如：一个网络模块，原来只服务端功能，而现在要加入客户端功能，\n那么应当在不用修改服务端功能代码的前提下，就能够增加客户端功能的实现代码，这要求在设计之初，就应当将服务端和客户端分开，公共部分抽象出来。\n\n### 替换原则(the Liskov Substitution Principle LSP)\n子类应当可以替换父类并出现在父类能够出现的任何地方。\n\n比如：公司搞年度晚会，所有员工可以参加抽奖，那么不管是老员工还是新员工，\n也不管是总部员工还是外派员工，都应当可以参加抽奖，否则这公司就不和谐了。\n\n### 依赖原则(the Dependency Inversion Principle DIP)\n具体依赖抽象，上层依赖下层。假设B是较A低的模块，但B需要使用到A的功能，\n\n这个时候，B不应当直接使用A中的具体类： 而应当由B定义一抽象接口，并由A来实现这个抽象接口，B只使用这个抽象接口：这样就达到\n了依赖倒置的目的，B也解除了对A的依赖，反过来是A依赖于B定义的抽象接口。\n\n通过上层模块难以避免依赖下层模块，假如B也直接依赖A的实现，那么就可能造成循环依赖。\n\n一个常见的问题就是编译A模块时需要直接包含到B模块的cpp文件，而编译B时同样要直接包含到A的cpp文件。\n\n### 接口分离原则(the Interface Segregation Principle ISP)\n模块间要通过抽象接口隔离开，而不是通过具体的类强耦合起来\n\n\n转自：http://www.cnblogs.com/hnrainll/\n","slug":"面向对象三大特性五大基本原则","published":1,"updated":"2016-10-08T15:29:06.000Z","comments":1,"layout":"post","photos":[],"link":"","_id":"ciu9lbwy5004o699fylt84sy6","content":"<p>透切理解面向对象三大基本特性是理解面向对象五大基本原则的基础.</p>\n<a id=\"more\"></a>\n<h2 id=\"三大特性\"><a href=\"#三大特性\" class=\"headerlink\" title=\"三大特性\"></a>三大特性</h2><h3 id=\"封装\"><a href=\"#封装\" class=\"headerlink\" title=\"封装\"></a>封装</h3><p>所谓封装，也就是把客观事物封装成抽象的类，并且类可以把自己的数据和方法只让可信的类或者对象操作，对不可信的进行信息隐藏。</p>\n<p>封装是面向对象的特征之一，是对象和类概念的主要特性。</p>\n<p>简单的说，一个类就是一个封装了数据以及操作这些数据的代码的逻辑实体。在一个对象内部，某些代码或某些数据可以是私有的，不能被外界访问。</p>\n<p>通过这种方式，对象对内部数据提供了不同级别的保护，以防止程序中无关的部分意外的改变或错误的使用了对象的私有部分。</p>\n<h3 id=\"继承\"><a href=\"#继承\" class=\"headerlink\" title=\"继承\"></a>继承</h3><p>所谓继承是指可以让某个类型的对象获得另一个类型的对象的属性的方法。它支持按级分类的概念。</p>\n<p>继承是指这样一种能力：它可以使用现有类的所有功能，并在无需重新编写原来的类的情况下对这些功能进行扩展。</p>\n<p>通过继承创建的新类称为“子类”或“派生类”，被继承的类称为“基类”、“父类”或“超类”。</p>\n<p>继承的过程，就是从一般到特殊的过程。</p>\n<p>要实现继承，可以通过“继承”（Inheritance）和“组合”（Composition）来实现。</p>\n<p>继承概念的实现方式有二类：实现继承与接口继承。</p>\n<ul>\n<li>实现继承是指直接使用基类的属性和方法而无需额外编码的能力；</li>\n<li>接口继承是指仅使用属性和方法的名称、但是子类必须提供实现的能力；</li>\n</ul>\n<h3 id=\"多态\"><a href=\"#多态\" class=\"headerlink\" title=\"多态\"></a>多态</h3><p>所谓多态就是指一个类实例的相同方法在不同情形有不同表现形式。<br>多态机制使具有不同内部结构的对象可以共享相同的外部接口。</p>\n<p>这意味着，虽然针对不同对象的具体操作不同，但通过一个公共的类，它们（那些操作）可以通过相同的方式予以调用。</p>\n<h2 id=\"五大基本原则\"><a href=\"#五大基本原则\" class=\"headerlink\" title=\"五大基本原则\"></a>五大基本原则</h2><h3 id=\"单一职责原则SRP-Single-Responsibility-Principle\"><a href=\"#单一职责原则SRP-Single-Responsibility-Principle\" class=\"headerlink\" title=\"单一职责原则SRP(Single Responsibility Principle)\"></a>单一职责原则SRP(Single Responsibility Principle)</h3><p>是指一个类的功能要单一，不能包罗万象。如同一个人一样，分配的工作不能太多，否则一天到晚虽然忙忙碌碌的，但效率却高不起来。</p>\n<h3 id=\"开放封闭原则OCP-Open－Close-Principle\"><a href=\"#开放封闭原则OCP-Open－Close-Principle\" class=\"headerlink\" title=\"开放封闭原则OCP(Open－Close Principle)\"></a>开放封闭原则OCP(Open－Close Principle)</h3><p>一个模块在扩展性方面应该是开放的而在更改性方面应该是封闭的。</p>\n<p>比如：一个网络模块，原来只服务端功能，而现在要加入客户端功能，<br>那么应当在不用修改服务端功能代码的前提下，就能够增加客户端功能的实现代码，这要求在设计之初，就应当将服务端和客户端分开，公共部分抽象出来。</p>\n<h3 id=\"替换原则-the-Liskov-Substitution-Principle-LSP\"><a href=\"#替换原则-the-Liskov-Substitution-Principle-LSP\" class=\"headerlink\" title=\"替换原则(the Liskov Substitution Principle LSP)\"></a>替换原则(the Liskov Substitution Principle LSP)</h3><p>子类应当可以替换父类并出现在父类能够出现的任何地方。</p>\n<p>比如：公司搞年度晚会，所有员工可以参加抽奖，那么不管是老员工还是新员工，<br>也不管是总部员工还是外派员工，都应当可以参加抽奖，否则这公司就不和谐了。</p>\n<h3 id=\"依赖原则-the-Dependency-Inversion-Principle-DIP\"><a href=\"#依赖原则-the-Dependency-Inversion-Principle-DIP\" class=\"headerlink\" title=\"依赖原则(the Dependency Inversion Principle DIP)\"></a>依赖原则(the Dependency Inversion Principle DIP)</h3><p>具体依赖抽象，上层依赖下层。假设B是较A低的模块，但B需要使用到A的功能，</p>\n<p>这个时候，B不应当直接使用A中的具体类： 而应当由B定义一抽象接口，并由A来实现这个抽象接口，B只使用这个抽象接口：这样就达到<br>了依赖倒置的目的，B也解除了对A的依赖，反过来是A依赖于B定义的抽象接口。</p>\n<p>通过上层模块难以避免依赖下层模块，假如B也直接依赖A的实现，那么就可能造成循环依赖。</p>\n<p>一个常见的问题就是编译A模块时需要直接包含到B模块的cpp文件，而编译B时同样要直接包含到A的cpp文件。</p>\n<h3 id=\"接口分离原则-the-Interface-Segregation-Principle-ISP\"><a href=\"#接口分离原则-the-Interface-Segregation-Principle-ISP\" class=\"headerlink\" title=\"接口分离原则(the Interface Segregation Principle ISP)\"></a>接口分离原则(the Interface Segregation Principle ISP)</h3><p>模块间要通过抽象接口隔离开，而不是通过具体的类强耦合起来</p>\n<p>转自：<a href=\"http://www.cnblogs.com/hnrainll/\" target=\"_blank\" rel=\"external\">http://www.cnblogs.com/hnrainll/</a></p>\n","excerpt":"<p>透切理解面向对象三大基本特性是理解面向对象五大基本原则的基础.</p>","more":"<h2 id=\"三大特性\"><a href=\"#三大特性\" class=\"headerlink\" title=\"三大特性\"></a>三大特性</h2><h3 id=\"封装\"><a href=\"#封装\" class=\"headerlink\" title=\"封装\"></a>封装</h3><p>所谓封装，也就是把客观事物封装成抽象的类，并且类可以把自己的数据和方法只让可信的类或者对象操作，对不可信的进行信息隐藏。</p>\n<p>封装是面向对象的特征之一，是对象和类概念的主要特性。</p>\n<p>简单的说，一个类就是一个封装了数据以及操作这些数据的代码的逻辑实体。在一个对象内部，某些代码或某些数据可以是私有的，不能被外界访问。</p>\n<p>通过这种方式，对象对内部数据提供了不同级别的保护，以防止程序中无关的部分意外的改变或错误的使用了对象的私有部分。</p>\n<h3 id=\"继承\"><a href=\"#继承\" class=\"headerlink\" title=\"继承\"></a>继承</h3><p>所谓继承是指可以让某个类型的对象获得另一个类型的对象的属性的方法。它支持按级分类的概念。</p>\n<p>继承是指这样一种能力：它可以使用现有类的所有功能，并在无需重新编写原来的类的情况下对这些功能进行扩展。</p>\n<p>通过继承创建的新类称为“子类”或“派生类”，被继承的类称为“基类”、“父类”或“超类”。</p>\n<p>继承的过程，就是从一般到特殊的过程。</p>\n<p>要实现继承，可以通过“继承”（Inheritance）和“组合”（Composition）来实现。</p>\n<p>继承概念的实现方式有二类：实现继承与接口继承。</p>\n<ul>\n<li>实现继承是指直接使用基类的属性和方法而无需额外编码的能力；</li>\n<li>接口继承是指仅使用属性和方法的名称、但是子类必须提供实现的能力；</li>\n</ul>\n<h3 id=\"多态\"><a href=\"#多态\" class=\"headerlink\" title=\"多态\"></a>多态</h3><p>所谓多态就是指一个类实例的相同方法在不同情形有不同表现形式。<br>多态机制使具有不同内部结构的对象可以共享相同的外部接口。</p>\n<p>这意味着，虽然针对不同对象的具体操作不同，但通过一个公共的类，它们（那些操作）可以通过相同的方式予以调用。</p>\n<h2 id=\"五大基本原则\"><a href=\"#五大基本原则\" class=\"headerlink\" title=\"五大基本原则\"></a>五大基本原则</h2><h3 id=\"单一职责原则SRP-Single-Responsibility-Principle\"><a href=\"#单一职责原则SRP-Single-Responsibility-Principle\" class=\"headerlink\" title=\"单一职责原则SRP(Single Responsibility Principle)\"></a>单一职责原则SRP(Single Responsibility Principle)</h3><p>是指一个类的功能要单一，不能包罗万象。如同一个人一样，分配的工作不能太多，否则一天到晚虽然忙忙碌碌的，但效率却高不起来。</p>\n<h3 id=\"开放封闭原则OCP-Open－Close-Principle\"><a href=\"#开放封闭原则OCP-Open－Close-Principle\" class=\"headerlink\" title=\"开放封闭原则OCP(Open－Close Principle)\"></a>开放封闭原则OCP(Open－Close Principle)</h3><p>一个模块在扩展性方面应该是开放的而在更改性方面应该是封闭的。</p>\n<p>比如：一个网络模块，原来只服务端功能，而现在要加入客户端功能，<br>那么应当在不用修改服务端功能代码的前提下，就能够增加客户端功能的实现代码，这要求在设计之初，就应当将服务端和客户端分开，公共部分抽象出来。</p>\n<h3 id=\"替换原则-the-Liskov-Substitution-Principle-LSP\"><a href=\"#替换原则-the-Liskov-Substitution-Principle-LSP\" class=\"headerlink\" title=\"替换原则(the Liskov Substitution Principle LSP)\"></a>替换原则(the Liskov Substitution Principle LSP)</h3><p>子类应当可以替换父类并出现在父类能够出现的任何地方。</p>\n<p>比如：公司搞年度晚会，所有员工可以参加抽奖，那么不管是老员工还是新员工，<br>也不管是总部员工还是外派员工，都应当可以参加抽奖，否则这公司就不和谐了。</p>\n<h3 id=\"依赖原则-the-Dependency-Inversion-Principle-DIP\"><a href=\"#依赖原则-the-Dependency-Inversion-Principle-DIP\" class=\"headerlink\" title=\"依赖原则(the Dependency Inversion Principle DIP)\"></a>依赖原则(the Dependency Inversion Principle DIP)</h3><p>具体依赖抽象，上层依赖下层。假设B是较A低的模块，但B需要使用到A的功能，</p>\n<p>这个时候，B不应当直接使用A中的具体类： 而应当由B定义一抽象接口，并由A来实现这个抽象接口，B只使用这个抽象接口：这样就达到<br>了依赖倒置的目的，B也解除了对A的依赖，反过来是A依赖于B定义的抽象接口。</p>\n<p>通过上层模块难以避免依赖下层模块，假如B也直接依赖A的实现，那么就可能造成循环依赖。</p>\n<p>一个常见的问题就是编译A模块时需要直接包含到B模块的cpp文件，而编译B时同样要直接包含到A的cpp文件。</p>\n<h3 id=\"接口分离原则-the-Interface-Segregation-Principle-ISP\"><a href=\"#接口分离原则-the-Interface-Segregation-Principle-ISP\" class=\"headerlink\" title=\"接口分离原则(the Interface Segregation Principle ISP)\"></a>接口分离原则(the Interface Segregation Principle ISP)</h3><p>模块间要通过抽象接口隔离开，而不是通过具体的类强耦合起来</p>\n<p>转自：<a href=\"http://www.cnblogs.com/hnrainll/\">http://www.cnblogs.com/hnrainll/</a></p>"}],"PostAsset":[],"PostCategory":[{"post_id":"ciu9lbwul0006699fassakhuk","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwut000c699fg6kov9mn"},{"post_id":"ciu9lbwu60001699frqkvimzp","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwuw000g699fdugy7i5t"},{"post_id":"ciu9lbwuo0008699f0dyn8iyo","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwuy000i699fqohe3t7i"},{"post_id":"ciu9lbwuc0002699f62nsjmgy","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwv0000m699frln786bp"},{"post_id":"ciu9lbwuu000d699f2k3oojyp","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwv2000o699fsj32x1we"},{"post_id":"ciu9lbwui0005699fjpgjvswx","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwv7000s699fcfd72an5"},{"post_id":"ciu9lbwv0000n699fmd67fyzj","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwva000v699f0ls8pfu2"},{"post_id":"ciu9lbwus000b699fwk4t9sq4","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvc000z699fl0dtochi"},{"post_id":"ciu9lbwv4000p699fdcxry85j","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvf0013699f1hufgvql"},{"post_id":"ciu9lbwv7000t699fkpy9e8pu","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvh0015699fhv6ab8rj"},{"post_id":"ciu9lbwuw000h699flflv9svx","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwvi0018699ft55hqsag"},{"post_id":"ciu9lbwva000w699ffct49gfz","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvk001b699f5c1d9o9h"},{"post_id":"ciu9lbwvd0011699fvt60wh5s","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvm001g699fb2wm99bf"},{"post_id":"ciu9lbwuy000j699fd8e5pbva","category_id":"ciu9lbwvb000y699fcl1mbyv2","_id":"ciu9lbwvp001j699fe65r1ti5"},{"post_id":"ciu9lbwvg0014699fe92ra0mb","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvt001m699fh9d7sbkj"},{"post_id":"ciu9lbwvh0016699f6rtelue3","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvx001p699fsuv9w95u"},{"post_id":"ciu9lbwvl001d699fgre2tn6e","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwvy001r699fdilxzeij"},{"post_id":"ciu9lbwvo001h699fipq3m50e","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbww1001v699fkb9al194"},{"post_id":"ciu9lbwvj001a699fslwbh1ic","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbww4001y699frbdle0ym"},{"post_id":"ciu9lbwvt001n699f71bcaqf2","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbww60021699f1yagffry"},{"post_id":"ciu9lbwvx001q699figec8pkq","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbww90024699f4kzbhnst"},{"post_id":"ciu9lbwvz001t699fws52jihw","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwwc0028699faoi0alpm"},{"post_id":"ciu9lbwvq001k699fmv3xluce","category_id":"ciu9lbwvw001o699f51tmox5y","_id":"ciu9lbwwd002b699f5wypz014"},{"post_id":"ciu9lbww1001w699fdp6sr4e3","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbwwf002e699fxxamkwsu"},{"post_id":"ciu9lbww4001z699fi2s17xrp","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbwwg002i699fl0mo9nak"},{"post_id":"ciu9lbww90025699fbc1yc3yl","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbwwk002k699fvmfhblfk"},{"post_id":"ciu9lbwwe002c699fx5osx7dz","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwwm002n699fbyovlb7m"},{"post_id":"ciu9lbww60023699f4dr2lpov","category_id":"ciu9lbwwc0027699fq8s8yem7","_id":"ciu9lbwwn002p699f2q8n16y9"},{"post_id":"ciu9lbwwf002f699feqybhswy","category_id":"ciu9lbwwc0027699fq8s8yem7","_id":"ciu9lbwwp002s699fnb6pkdhn"},{"post_id":"ciu9lbwwg002j699fx9xav86r","category_id":"ciu9lbwwc0027699fq8s8yem7","_id":"ciu9lbwwq002v699feil37ogg"},{"post_id":"ciu9lbwwc0029699f65feno6a","category_id":"ciu9lbwwc0027699fq8s8yem7","_id":"ciu9lbwwr002z699fyu1ldbhw"},{"post_id":"ciu9lbwwk002m699f9rwfw7hv","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwwt0032699fyibb82tv"},{"post_id":"ciu9lbwwm002o699f8j3ashue","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwwv0035699f0y1rp5lj"},{"post_id":"ciu9lbwwn002q699f7ksyelrm","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwwx0037699flc4yy3kq"},{"post_id":"ciu9lbwwp002u699f42f3wevw","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwwy0039699f4wlig9i8"},{"post_id":"ciu9lbwwq002x699fudwdv3mw","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwwz003d699fw0r14pio"},{"post_id":"ciu9lbwws0030699ff39hmkdu","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwx1003g699f44mx9ax4"},{"post_id":"ciu9lbwwt0033699fzycfwwkk","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwx3003j699f6nzih7k1"},{"post_id":"ciu9lbwww0036699fj7tz5kbz","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwx5003l699f0cy0qvyj"},{"post_id":"ciu9lbwwx0038699f3bd2wnjo","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwx9003o699fex012gx7"},{"post_id":"ciu9lbwwy003b699fcfnt3ao3","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwxb003r699f5csot87v"},{"post_id":"ciu9lbwx0003e699fjl1hpahs","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwxd003v699fgzh1w6dj"},{"post_id":"ciu9lbwx1003h699fz28bsfce","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwxg003y699f63zmy4qb"},{"post_id":"ciu9lbwx3003k699f39e6ojfp","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwxh0040699f7ahr8mqf"},{"post_id":"ciu9lbwx5003m699fogqq4bc0","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwxj0044699fpr9wguut"},{"post_id":"ciu9lbwxa003p699fi169ysg2","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbwxl0047699f16xhzfny"},{"post_id":"ciu9lbwxd003w699f5tga7smm","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwxo004a699fq7plcuvp"},{"post_id":"ciu9lbwxi0042699fvufi6jq2","category_id":"ciu9lbwui0004699f2035xwad","_id":"ciu9lbwxp004d699fvbnfarfb"},{"post_id":"ciu9lbwxc003s699frlydvl6r","category_id":"ciu9lbwxg003x699fd3b67zce","_id":"ciu9lbwxs004g699fay0mf6zj"},{"post_id":"ciu9lbwxj0045699f3rdw9s9c","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwy2004j699feexykndj"},{"post_id":"ciu9lbwxl0048699fzwfhl4zu","category_id":"ciu9lbwv0000k699fq63oa3bc","_id":"ciu9lbwy4004n699f7dhahb20"},{"post_id":"ciu9lbwxo004c699f5xwiskfj","category_id":"ciu9lbwwc0027699fq8s8yem7","_id":"ciu9lbwy5004q699f097nys3a"},{"post_id":"ciu9lbwxp004e699f7wh3wwzb","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbwy6004r699f2h3p191g"},{"post_id":"ciu9lbwy2004k699fpc1v8dae","category_id":"ciu9lbwvm001f699f4hb9zdg8","_id":"ciu9lbwy6004u699fdug0olu0"},{"post_id":"ciu9lbwy5004o699fylt84sy6","category_id":"ciu9lbwv5000q699fn0ytdkbl","_id":"ciu9lbwy6004v699f2ytwq32s"},{"post_id":"ciu9lbwy0004h699fialbf76r","category_id":"ciu9lbwy4004m699fvlgbtsrh","_id":"ciu9lbwy6004x699fn5vqc1po"}],"PostTag":[{"post_id":"ciu9lbwu60001699frqkvimzp","tag_id":"ciu9lbwuf0003699fecld4u1i","_id":"ciu9lbwur000a699fc1p3zpaa"},{"post_id":"ciu9lbwuc0002699f62nsjmgy","tag_id":"ciu9lbwuo0007699ft9wknrqe","_id":"ciu9lbwv9000u699flbs2bdmk"},{"post_id":"ciu9lbwuc0002699f62nsjmgy","tag_id":"ciu9lbwuv000f699f9zzg4kjd","_id":"ciu9lbwvb000x699fwid3wypk"},{"post_id":"ciu9lbwuc0002699f62nsjmgy","tag_id":"ciu9lbwv0000l699fbloma1sf","_id":"ciu9lbwvf0012699f6mjt25ep"},{"post_id":"ciu9lbwui0005699fjpgjvswx","tag_id":"ciu9lbwv6000r699fqjph6xwt","_id":"ciu9lbwvi0019699fu4mp0dc9"},{"post_id":"ciu9lbwui0005699fjpgjvswx","tag_id":"ciu9lbwvd0010699ft6oyz732","_id":"ciu9lbwvk001c699fh68x2h8s"},{"post_id":"ciu9lbwul0006699fassakhuk","tag_id":"ciu9lbwvi0017699fjtv30tsr","_id":"ciu9lbwvp001i699f2qba3ja7"},{"post_id":"ciu9lbwuo0008699f0dyn8iyo","tag_id":"ciu9lbwvm001e699fnjaxpfms","_id":"ciu9lbww1001u699f1v4dl5q1"},{"post_id":"ciu9lbwuo0008699f0dyn8iyo","tag_id":"ciu9lbwvs001l699fl2mo2v3w","_id":"ciu9lbww2001x699f7vfual7n"},{"post_id":"ciu9lbwus000b699fwk4t9sq4","tag_id":"ciu9lbwvy001s699fnzqpkpvd","_id":"ciu9lbww60022699fg607aczb"},{"post_id":"ciu9lbwuu000d699f2k3oojyp","tag_id":"ciu9lbww50020699f476llzno","_id":"ciu9lbwwd002a699f0594h23c"},{"post_id":"ciu9lbwuw000h699flflv9svx","tag_id":"ciu9lbwwb0026699fdq9b900o","_id":"ciu9lbwwg002h699fdqjtvpr2"},{"post_id":"ciu9lbwuy000j699fd8e5pbva","tag_id":"ciu9lbwwe002d699fqilkqcki","_id":"ciu9lbwwp002t699fkmkg77h4"},{"post_id":"ciu9lbwuy000j699fd8e5pbva","tag_id":"ciu9lbwwk002l699fh235so1f","_id":"ciu9lbwwq002w699fx9xeu987"},{"post_id":"ciu9lbwva000w699ffct49gfz","tag_id":"ciu9lbwwo002r699fvsbqdxer","_id":"ciu9lbwwt0031699fn51q0zl6"},{"post_id":"ciu9lbwvg0014699fe92ra0mb","tag_id":"ciu9lbwwr002y699fox4hhtms","_id":"ciu9lbwwz003c699f5hjhhvqz"},{"post_id":"ciu9lbwvg0014699fe92ra0mb","tag_id":"ciu9lbwwv0034699fd4xdqd52","_id":"ciu9lbwx1003f699fgs27vrbh"},{"post_id":"ciu9lbwvj001a699fslwbh1ic","tag_id":"ciu9lbwwy003a699f9ybgwuma","_id":"ciu9lbwxb003q699fz3kl941w"},{"post_id":"ciu9lbwvj001a699fslwbh1ic","tag_id":"ciu9lbwx2003i699fupdqhfol","_id":"ciu9lbwxd003t699fpkqs6ks8"},{"post_id":"ciu9lbwvq001k699fmv3xluce","tag_id":"ciu9lbwx8003n699fr2i68vq1","_id":"ciu9lbwxj0043699fxwkr1vqd"},{"post_id":"ciu9lbwvq001k699fmv3xluce","tag_id":"ciu9lbwxd003u699f1fqd2agg","_id":"ciu9lbwxl0046699fcaru4nuy"},{"post_id":"ciu9lbwvx001q699figec8pkq","tag_id":"ciu9lbwxh0041699f5kljssrk","_id":"ciu9lbwxo004b699fgdxk27ja"},{"post_id":"ciu9lbwvz001t699fws52jihw","tag_id":"ciu9lbwxn0049699fdx2b52fc","_id":"ciu9lbwy1004i699faynhitcq"},{"post_id":"ciu9lbww4001z699fi2s17xrp","tag_id":"ciu9lbwxr004f699fievonegj","_id":"ciu9lbwy5004p699f3fpvmk6z"},{"post_id":"ciu9lbww60023699f4dr2lpov","tag_id":"ciu9lbwy4004l699f3i0edvqg","_id":"ciu9lbwy6004t699ftq1n9bbt"},{"post_id":"ciu9lbww90025699fbc1yc3yl","tag_id":"ciu9lbwy6004s699fpykf9u5h","_id":"ciu9lbwy6004y699fztszdtd7"},{"post_id":"ciu9lbwwc0029699f65feno6a","tag_id":"ciu9lbwy6004w699f55mjxnns","_id":"ciu9lbwy70050699f1l7j82vh"},{"post_id":"ciu9lbwwe002c699fx5osx7dz","tag_id":"ciu9lbwy7004z699fa1poxeq0","_id":"ciu9lbwy80053699fsxv98gg7"},{"post_id":"ciu9lbwwe002c699fx5osx7dz","tag_id":"ciu9lbwy80051699f7mteqz8i","_id":"ciu9lbwy80054699fyj7hgv00"},{"post_id":"ciu9lbwwf002f699feqybhswy","tag_id":"ciu9lbwy80051699f7mteqz8i","_id":"ciu9lbwy90056699f01asvqrr"},{"post_id":"ciu9lbwwk002m699f9rwfw7hv","tag_id":"ciu9lbwy80055699fzfrxq4fc","_id":"ciu9lbwy90059699fkawdhx8i"},{"post_id":"ciu9lbwwk002m699f9rwfw7hv","tag_id":"ciu9lbwy90057699fsf3qgnm1","_id":"ciu9lbwy9005a699fdnnsb2d9"},{"post_id":"ciu9lbwwm002o699f8j3ashue","tag_id":"ciu9lbwy80055699fzfrxq4fc","_id":"ciu9lbwya005d699fmq9yj3mw"},{"post_id":"ciu9lbwwm002o699f8j3ashue","tag_id":"ciu9lbwy9005b699f3ia7b1k4","_id":"ciu9lbwya005e699f5mkm04vp"},{"post_id":"ciu9lbwwn002q699f7ksyelrm","tag_id":"ciu9lbwy7004z699fa1poxeq0","_id":"ciu9lbwya005g699f0twcb5f3"},{"post_id":"ciu9lbwwq002x699fudwdv3mw","tag_id":"ciu9lbwy80055699fzfrxq4fc","_id":"ciu9lbwyb005j699fcnjz5h7b"},{"post_id":"ciu9lbwwq002x699fudwdv3mw","tag_id":"ciu9lbwya005h699fcbw74uwr","_id":"ciu9lbwyb005k699fn0t3doq0"},{"post_id":"ciu9lbwws0030699ff39hmkdu","tag_id":"ciu9lbwyb005i699f7n65cddk","_id":"ciu9lbwyc005m699f91xz459x"},{"post_id":"ciu9lbwwt0033699fzycfwwkk","tag_id":"ciu9lbwyb005l699flj8cthr5","_id":"ciu9lbwyc005p699ftmc3at98"},{"post_id":"ciu9lbwwt0033699fzycfwwkk","tag_id":"ciu9lbwyc005n699flztnyguu","_id":"ciu9lbwyc005q699fs23zqju9"},{"post_id":"ciu9lbwww0036699fj7tz5kbz","tag_id":"ciu9lbwyc005o699fnmkne1o2","_id":"ciu9lbwyd005t699fgqswcd75"},{"post_id":"ciu9lbwww0036699fj7tz5kbz","tag_id":"ciu9lbwyc005r699fyh4udxiu","_id":"ciu9lbwyd005u699fsl5lfozv"},{"post_id":"ciu9lbwwx0038699f3bd2wnjo","tag_id":"ciu9lbwyd005s699fqhthl0mp","_id":"ciu9lbwyd005w699fg416e9s4"},{"post_id":"ciu9lbwwy003b699fcfnt3ao3","tag_id":"ciu9lbwyd005v699fd2vj21c6","_id":"ciu9lbwye005z699f2lz4wcvz"},{"post_id":"ciu9lbwwy003b699fcfnt3ao3","tag_id":"ciu9lbwyd005x699fypi5m4cb","_id":"ciu9lbwye0060699ffnougr1u"},{"post_id":"ciu9lbwx3003k699f39e6ojfp","tag_id":"ciu9lbwyd005y699f8kwl77ck","_id":"ciu9lbwye0062699fale59v63"},{"post_id":"ciu9lbwx5003m699fogqq4bc0","tag_id":"ciu9lbwyd005y699f8kwl77ck","_id":"ciu9lbwye0064699f5ark2a03"},{"post_id":"ciu9lbwxa003p699fi169ysg2","tag_id":"ciu9lbwye0063699fmlvpblao","_id":"ciu9lbwyf0066699fni6uxyje"},{"post_id":"ciu9lbwxc003s699frlydvl6r","tag_id":"ciu9lbwye0065699fbrbbnkze","_id":"ciu9lbwyg0069699f14xloq3w"},{"post_id":"ciu9lbwxc003s699frlydvl6r","tag_id":"ciu9lbwyf0067699fai0td9hu","_id":"ciu9lbwyg006a699f0phae4f8"},{"post_id":"ciu9lbwxd003w699f5tga7smm","tag_id":"ciu9lbwyd005y699f8kwl77ck","_id":"ciu9lbwyg006c699f8yym7l6k"},{"post_id":"ciu9lbwxg003z699f56ch67gz","tag_id":"ciu9lbwyg006b699f64vm3ire","_id":"ciu9lbwyh006e699fbz5y7obi"},{"post_id":"ciu9lbwxi0042699fvufi6jq2","tag_id":"ciu9lbwvs001l699fl2mo2v3w","_id":"ciu9lbwyi006g699f510pip0y"},{"post_id":"ciu9lbwxi0042699fvufi6jq2","tag_id":"ciu9lbwyg006d699f0msy8xpq","_id":"ciu9lbwyi006h699fcweq1rcf"},{"post_id":"ciu9lbwxj0045699f3rdw9s9c","tag_id":"ciu9lbwyh006f699frv16sctg","_id":"ciu9lbwyi006j699ffcea0mwk"},{"post_id":"ciu9lbwxl0048699fzwfhl4zu","tag_id":"ciu9lbwyi006i699fzv598duo","_id":"ciu9lbwyk006n699fpa02zmp2"},{"post_id":"ciu9lbwxl0048699fzwfhl4zu","tag_id":"ciu9lbwyi006k699f9v14brkf","_id":"ciu9lbwyk006o699foxqpwsxe"},{"post_id":"ciu9lbwxl0048699fzwfhl4zu","tag_id":"ciu9lbwyj006l699fu4ajr9si","_id":"ciu9lbwyk006q699fwplxo0uf"},{"post_id":"ciu9lbwxo004c699f5xwiskfj","tag_id":"ciu9lbwyj006m699fk0gz80gq","_id":"ciu9lbwyk006r699fdrt8fahx"},{"post_id":"ciu9lbwxp004e699f7wh3wwzb","tag_id":"ciu9lbwyk006p699fsb8hmehb","_id":"ciu9lbwyl006u699f0p9nf81k"},{"post_id":"ciu9lbwxp004e699f7wh3wwzb","tag_id":"ciu9lbwyk006s699fgrscqkp4","_id":"ciu9lbwyl006v699fa19ufxxx"},{"post_id":"ciu9lbwy2004k699fpc1v8dae","tag_id":"ciu9lbwyf0067699fai0td9hu","_id":"ciu9lbwyl006w699f0tzsvtui"}],"Tag":[{"name":"Apache虚拟主机","_id":"ciu9lbwuf0003699fecld4u1i"},{"name":"FastCGI","_id":"ciu9lbwuo0007699ft9wknrqe"},{"name":"CGI","_id":"ciu9lbwuv000f699f9zzg4kjd"},{"name":"Apache&PHP","_id":"ciu9lbwv0000l699fbloma1sf"},{"name":"Apache分层","_id":"ciu9lbwv6000r699fqjph6xwt"},{"name":"Apache模块","_id":"ciu9lbwvd0010699ft6oyz732"},{"name":"Apache Apache性能优化","_id":"ciu9lbwvi0017699fjtv30tsr"},{"name":"Web服务器","_id":"ciu9lbwvm001e699fnjaxpfms"},{"name":"Apache","_id":"ciu9lbwvs001l699fl2mo2v3w"},{"name":"ElasticSearch","_id":"ciu9lbwvy001s699fnzqpkpvd"},{"name":"Apache 监控","_id":"ciu9lbww50020699f476llzno"},{"name":"LNMP","_id":"ciu9lbwwb0026699fdq9b900o"},{"name":"git","_id":"ciu9lbwwe002d699fqilkqcki"},{"name":"版本控制","_id":"ciu9lbwwk002l699fh235so1f"},{"name":"rsync","_id":"ciu9lbwwo002r699fvsbqdxer"},{"name":"进程管理","_id":"ciu9lbwwr002y699fox4hhtms"},{"name":"服务管理","_id":"ciu9lbwwv0034699fd4xdqd52"},{"name":"MVCC","_id":"ciu9lbwwy003a699f9ybgwuma"},{"name":"多版本并发控制","_id":"ciu9lbwx2003i699fupdqhfol"},{"name":"Mac","_id":"ciu9lbwx8003n699fr2i68vq1"},{"name":"homebrew","_id":"ciu9lbwxd003u699f1fqd2agg"},{"name":"存储引擎","_id":"ciu9lbwxh0041699f5kljssrk"},{"name":"分布式部署算法","_id":"ciu9lbwxn0049699fdx2b52fc"},{"name":"并发控制","_id":"ciu9lbwxr004f699fievonegj"},{"name":"https","_id":"ciu9lbwy4004l699f3i0edvqg"},{"name":"MySQL逻辑架构","_id":"ciu9lbwy6004s699fpykf9u5h"},{"name":"虚拟主机","_id":"ciu9lbwy6004w699f55mjxnns"},{"name":"PHP-FPM","_id":"ciu9lbwy7004z699fa1poxeq0"},{"name":"监控","_id":"ciu9lbwy80051699f7mteqz8i"},{"name":"设计模式","_id":"ciu9lbwy80055699fzfrxq4fc"},{"name":"单例模式","_id":"ciu9lbwy90057699fsf3qgnm1"},{"name":"工厂模式","_id":"ciu9lbwy9005b699f3ia7b1k4"},{"name":"注册表模式","_id":"ciu9lbwya005h699fcbw74uwr"},{"name":"PEAR","_id":"ciu9lbwyb005i699f7n65cddk"},{"name":"异常处理","_id":"ciu9lbwyb005l699flj8cthr5"},{"name":"错误处理","_id":"ciu9lbwyc005n699flztnyguu"},{"name":"PHP扩展","_id":"ciu9lbwyc005o699fnmkne1o2"},{"name":"phpize","_id":"ciu9lbwyc005r699fyh4udxiu"},{"name":"MVC","_id":"ciu9lbwyd005s699fqhthl0mp"},{"name":"权限控制","_id":"ciu9lbwyd005v699fd2vj21c6"},{"name":"RBAC","_id":"ciu9lbwyd005x699fypi5m4cb"},{"name":"Redis","_id":"ciu9lbwyd005y699f8kwl77ck"},{"name":"数据类型","_id":"ciu9lbwye0063699fmlvpblao"},{"name":"Web","_id":"ciu9lbwye0065699fbrbbnkze"},{"name":"性能优化","_id":"ciu9lbwyf0067699fai0td9hu"},{"name":"hexo","_id":"ciu9lbwyg006b699f64vm3ire"},{"name":".htaccess","_id":"ciu9lbwyg006d699f0msy8xpq"},{"name":"负载均衡","_id":"ciu9lbwyh006f699frv16sctg"},{"name":"缓存","_id":"ciu9lbwyi006i699fzv598duo"},{"name":"memcache","_id":"ciu9lbwyi006k699f9v14brkf"},{"name":"memcached","_id":"ciu9lbwyj006l699fu4ajr9si"},{"name":"Nginx安装","_id":"ciu9lbwyj006m699fk0gz80gq"},{"name":"事务","_id":"ciu9lbwyk006p699fsb8hmehb"},{"name":"ACID","_id":"ciu9lbwyk006s699fgrscqkp4"}]}}